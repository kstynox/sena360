<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SENA 360 – Panel Integral de Seguimiento a la FPI</title>

 <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
   /* ============================
   NUEVO DISEÑO TIPO TARJETAS
   ============================ */

/* Paleta base */
:root {
  --verde-sena: #28a745;
  --verde-sena-oscuro: #1e8a37;
  --verde-sena-claro: #e9f7ef;
  --gris-fondo: #f5f7fb;
  --gris-borde: #e5e7eb;
  --texto-principal: #111827;
  --texto-secundario: #6b7280;
}

/* Fondo general */
body {
  margin: 0;
  font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background-color: var(--gris-fondo);
  color: var(--texto-principal);
}
/* ================= LOGIN INICIAL (COORDINADOR) ================= */
#loginOverlay {
  position: fixed;
  inset: 0;
background: radial-gradient(circle at top,
                            rgba(40,167,69,1),
                            rgba(15,23,42,1));
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

/* Overlay para confirmar Gerente de Proyecto */
#gerenteOverlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at top, rgba(16,185,129,0.15), rgba(15,23,42,0.9));
  display: none;               /* Oculto por defecto, se muestra con JS */
  align-items: center;
  justify-content: center;
  z-index: 1000;               /* Encima de todo lo demás */
}
/* Overlay para seleccionar Aprendiz Vocero (mismo estilo que gerente) */
#voceroOverlay {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at top, rgba(16,185,129,0.15), rgba(15,23,42,0.9));
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}


/* Botón rojo para la opción NO */
.btn-negativo {
  background: linear-gradient(to right, #dc2626, #b91c1c);
  box-shadow: 0 12px 30px rgba(220, 38, 38, 0.5);
}

.btn-negativo:hover {
  background: linear-gradient(to right, #b91c1c, #7f1d1d);
  box-shadow: 0 16px 36px rgba(239, 68, 68, 0.6);
}

@keyframes loginZoomIn {
  0% {
    transform: scale(0.85);
    opacity: 0;
  }
  60% {
    transform: scale(1.02);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}


.login-card {
  background-color: #ffffff;
  border-radius: 18px;
  padding: 32px 40px;
  box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
  position: relative;
  max-width: 520px;
  width: 90%;
  text-align: center;
  border: 1px solid rgba(148, 163, 184, 0.4);

  /* Animación de entrada */
  transform-origin: center;
  animation: loginZoomIn 0.4s ease-out;
}
/* Estado de salida del login (al hacer clic en Ingresar) */
.login-card.login-exit {
  animation: loginZoomOut 0.3s ease-in forwards;
}


@keyframes loginZoomIn {
  0% {
    transform: scale(0.85);
    opacity: 0;
  }
  60% {
    transform: scale(1.02);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes loginZoomOut {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0.85);
    opacity: 0;
  }
}

.login-logo img {
  width: 80px;
  height: auto;
  margin-bottom: 12px;
}

.login-title {
  margin: 0 0 8px 0;
  font-size: 22px;
  font-weight: 700;
  color: var(--verde-sena-oscuro);
}

.login-subtitle {
  margin: 0 0 20px 0;
  font-size: 13px;
  color: var(--texto-secundario);
}

.login-field {
  text-align: left;
  margin-bottom: 20px;
}

.login-field label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--texto-principal);
}

.login-field select {
  width: 100%;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--gris-borde);
  font-size: 14px;
}

.login-button {
  width: 100%;
  justify-content: center;
  margin-top: 4px;
}

.login-error {
  margin-top: 10px;
  padding: 8px 12px;
  border-radius: 10px;
  background-color: #fee2e2;
  border: 1px solid #fecaca;
  color: #b91c1c;
  font-size: 13px;
}
.login-toggle-roles {
  position: absolute;
  top: 6px;
  right: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: transparent;
  border: none;
  cursor: pointer;
  opacity: 0.55;
}
.login-toggle-roles input[type="checkbox"] {
  accent-color: #ffffff;
  width: 14px;
  height: 14px;
  margin: 0;
}

/* ================= HEADER ================= */

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
  padding: 18px 40px;
  background-color: #ffffff;
  box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
  border-bottom: 4px solid var(--verde-sena);
}

header img {
  height: 64px;
  margin-right: 12px;
}

header > h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: var(--texto-principal);
}

/* Bloque derecho del encabezado */
.header-center {
  margin-left: auto;
  text-align: right;
}

.header-center h2 {
  margin: 0;
  font-size: 13px;
  font-weight: 500;
  color: var(--texto-secundario);
}

.header-center h1 {
  margin: 4px 0 0 0;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: 0.03em;
  color: var(--verde-sena-oscuro);
}


.header-center hr {
  display: none;
}

/* ================= TARJETAS PRINCIPALES (ARCHIVOS Y REPORTES) ================= */

.contenedor {
  max-width: 1300px;
  margin: 24px auto;
  padding: 22px 28px;
  background-color: #fdfefe;
  border-radius: 16px;
  border: 1px solid #e0e7ef;
  box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
}

/* Acordeón de Cargue de Archivos */
.acordeon-header {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 10px 14px;
  border-radius: 999px;
  border: 1px solid var(--gris-borde);
  background-color: #f9fafb;
  font-size: 14px;
  font-weight: 600;
  color: var(--texto-principal);
  cursor: pointer;
}

.acordeon-header:hover {
  background-color: var(--verde-sena-claro);
}

.acordeon-icon {
  font-size: 16px;
}

.acordeon-body {
  margin-top: 16px;
}

/* Separación entre los pasos dentro del acordeón */
#accordionCargueBody > div + div {
  margin-top: 18px;
  padding-top: 12px;
  border-top: 1px dashed var(--gris-borde);
}


.contenedor h2 {
  margin: 0 0 16px 0;
  font-size: 18px;
  font-weight: 700;
  color: var(--texto-principal);
}

/* Layout de los bloques de carga de archivo */
#sectionFile1,
#sectionFile2,
#sectionFile3 {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 16px 24px;
}

/* Ocultar <br> para no romper la fila */
#sectionFile1 br,
#sectionFile2 br,
#sectionFile3 br {
  display: none;
}

/* Título a lo ancho */
#sectionFile1 h2,
#sectionFile2 h2,
#sectionFile3 h2 {
  flex: 1 1 100%;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Números 1, 2 y 3 en círculo verde */
#sectionFile1 h2::before,
#sectionFile2 h2::before,
#sectionFile3 h2::before {
  /* número del paso por defecto */
  content: "1";
}
#sectionFile2 h2::before { content: "2"; }
#sectionFile3 h2::before { content: "3"; }

/* Estilo visual del círculo */
#sectionFile1 h2::before,
#sectionFile2 h2::before,
#sectionFile3 h2::before {
  width: 28px;
  height: 28px;
  border-radius: 999px;
  background-color: var(--verde-sena);
  color: #ffffff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  font-weight: 700;
}

/* Input y botón en fila */
#sectionFile1 input[type="file"],
#sectionFile2 input[type="file"],
#sectionFile3 input[type="file"] {
  flex: 1 1 60%;
  max-width: 650px;
}

#btnProcesar1,
#btnProcesar2,
#btnCargarDiseno {
  flex: 0 0 auto;
}

/* Mensaje ocupa toda la fila inferior */
#mensajeArchivo1,
#mensajeArchivo2,
#mensajeArchivo3 {
  flex: 1 1 100%;
}

/* ================= INPUT FILE ESTILO ================= */

input[type="file"] {
  font-family: inherit;
  font-size: 14px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid var(--gris-borde);
  background-color: #f9fafb;
  color: var(--texto-secundario);
}

/* Chrome / Edge */
input[type="file"]::-webkit-file-upload-button {
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  padding: 8px 14px;
  margin-right: 10px;
  border-radius: 999px;
  border: none;
  background-color: var(--verde-sena-claro);
  color: var(--verde-sena-oscuro);
  cursor: pointer;
}

/* Firefox */
input[type="file"]::file-selector-button {
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  padding: 8px 14px;
  margin-right: 10px;
  border-radius: 999px;
  border: none;
  background-color: var(--verde-sena-claro);
  color: var(--verde-sena-oscuro);
  cursor: pointer;
}

/* ================= BOTONES ================= */

.btnEstilo,
#btnImprimir,
.btnExportarPDF,
.btnExportarExcel,
.btnExportarWord,
.btn-menu-reporte {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 22px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  background-color: var(--verde-sena);
  color: #ffffff;
  box-shadow: 0 10px 24px rgba(40, 167, 69, 0.45);
  transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
}

.btnEstilo:hover,
#btnImprimir:hover,
.btnExportarPDF:hover,
.btnExportarExcel:hover,
.btnExportarWord:hover,
.btn-menu-reporte:hover {
  background-color: var(--verde-sena-oscuro);
  transform: translateY(-1px);
  box-shadow: 0 14px 30px rgba(40, 167, 69, 0.5);
}

/* ================= MENSAJE DE ARCHIVO CARGADO ================= */

.mensaje-archivo {
  margin-top: 8px;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #bbf7d0;
  background-color: #ecfdf3;
  color: #166534;
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mensaje-archivo::before {
  content: "✔";
  font-size: 14px;
}

.nota-archivo {
  margin: 6px 0 4px;
  font-size: 12px;
  color: var(--texto-secundario);
}

/* ================= TABS ================= */

.tabs {
  list-style: none;
  padding: 0;
  margin: 0 0 24px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

/* cada tarjeta ocupa 1/4 aprox. y se acomoda en responsive */
.tabs li {
  flex: 1 1 260px;
}

/* Tarjeta del menú de reportes */
.tabs li a {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 14px 14px;   /* menos padding vertical */
  min-height: 100px;    /* menos alto */
  text-align: center;
  text-decoration: none;
  border-radius: 18px;
  border: 1px solid var(--gris-borde);
  background-color: #ffffff;
  box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
  cursor: pointer;
  transition:
    background-color 0.18s ease,
    border-color 0.18s ease,
    box-shadow 0.18s ease,
    transform 0.12s ease;
}

/* Ícono */
.tab-icon {
  font-size: 28px;
  color: #d1d5db;
  transition: color 0.18s ease, transform 0.12s ease;
}

/* Texto “REPORTE X” */
.tab-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: #9ca3af;
}

/* Título del reporte */
.tab-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--texto-principal);
}

/* Estado inactivo + hover */
.tabs li a:hover {
  border-color: var(--verde-sena);
  background-color: #f9fafb;
  box-shadow: 0 10px 22px rgba(40, 167, 69, 0.25);
  transform: translateY(-1px);
}

.tabs li a:hover .tab-icon,
.tabs li a:hover .tab-title {
  color: var(--verde-sena-oscuro);
}

/* Estado ACTIVO (tarjeta verde) */
.tabs li a.active {
  background: linear-gradient(to bottom, var(--verde-sena), var(--verde-sena-oscuro));
  border-color: var(--verde-sena-oscuro);
  box-shadow: 0 14px 28px rgba(40, 167, 69, 0.5);
  transform: translateY(-1px);
}

.tabs li a.active .tab-icon,
.tabs li a.active .tab-label,
.tabs li a.active .tab-title {
  color: #ffffff;
}

/* Flechita verde hacia abajo cuando está activo */
.tab-arrow {
  position: absolute;
  bottom: -9px;
  left: 50%;
  transform: translateX(-50%) rotate(45deg);
  width: 18px;
  height: 18px;
  background: var(--verde-sena);
  border-radius: 4px;
  box-shadow: 0 6px 10px rgba(40, 167, 69, 0.35);
  display: none;
}

.tabs li a.active .tab-arrow {
  display: block;
}

/* En móviles las tarjetas pasan a una por fila (esto ya lo tienes al final, lo dejamos igual) */
@media (max-width: 900px) {
  .tabs li {
    flex: 1 1 100%;
  }
}

/* Contenido de pestañas como tarjeta */
.tab-content {
  display: none;
  max-width: 1200px;
  margin: 0 auto 24px auto;
  padding: 20px 24px;
  background-color: #ffffff;
  border-radius: 16px;
  border: 1px solid var(--gris-borde);
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
}

.tab-content.active {
  display: block;
}

/* Descripción corta al inicio de cada reporte */
.descripcion-reporte {
  margin: 4px 0 14px 0;
  font-size: 0.9rem;
  color: var(--texto-secundario);
  line-height: 1.45;
}

/* ================= TABLAS ================= */

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background-color: #ffffff;
}

th,
td {
  padding: 8px 10px;
  font-size: 13px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

thead th {
  background-color: var(--verde-sena);
  color: #ffffff;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

tbody tr:nth-child(even) {
  background-color: #f9fafb;
}

tbody tr:nth-child(odd) {
  background-color: #ffffff;
}

/* Estilo específico para la lista de aprendices con solo práctica pendiente */
.texto-resumen-practica {
  margin-top: 10px;
  font-size: 13px;
  color: var(--texto-secundario);
}

.tabla-resumen-practica {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
  background-color: #ffffff;
}

.tabla-resumen-practica thead th {
  background-color: #f9fafb;
  color: var(--texto-secundario);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--gris-borde);
}

.tabla-resumen-practica tbody tr {
  border-bottom: 1px solid var(--gris-borde);
  transition: background-color 0.12s ease;
}

.tabla-resumen-practica tbody tr:hover {
  background-color: #f3f4f6;
}

.tabla-resumen-practica .col-checkbox {
  width: 40px;
  text-align: center;
}

.tabla-resumen-practica .col-nombre {
  padding-left: 4px;
  font-size: 13px;
  color: var(--texto-principal);
}

.tabla-resumen-practica input[type="checkbox"] {
  accent-color: var(--verde-sena);
}






/* Contenedor externo del Gantt (título + tabla) */
#contenedorGanttCompetencias {
  margin-top: 8px;             /* separación respecto a la tarjeta de la gráfica */
}

/* ================= CONTENEDORES PARA GRÁFICAS ================= */

/* Tarjeta genérica de la gráfica (CanvasJS) SOLO en reporte 2 */
#reporte2 .chart-container {
  width: 100%;
  max-width: 100%;
  margin: 24px 0 80px 0;     /* 80px de espacio debajo de la gráfica */
  padding: 20px 20px 30px;
  border-radius: 16px;
  border: 1px solid var(--gris-borde);
  background-color: #ffffff;
  box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
  box-sizing: border-box;
}

/* Contenedor que agrupa el título y la tabla del Gantt */
#contenedorGanttCompetencias {
  margin-top: 0;
  clear: both;               /* obliga a quedar por debajo de la gráfica */
}

/* Tarjeta del Gantt (tabla) */
#ganttContainer,
#ganttContainerPendientes {
  border-radius: 16px;
  border: 1px solid var(--gris-borde);
  background-color: #ffffff;
  padding: 16px 18px;
  margin: 16px 0 24px 0;     /* espacio arriba y abajo del Gantt */
  box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
  display: block;

  /* Que ocupe todo el ancho del contenedor padre (contenedorGanttCompetencias) */
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;

  /* Mantener el scroll horizontal si la tabla interna es más ancha */
  overflow-x: auto;
  overflow-y: hidden;

  float: none;
  clear: both;
}

/* Contenedor específico del gráfico de competencias */
#chartCompetenciasHorasContainer {
  width: 100%;
  height: auto;          /* Permite que crezca según el contenido */
  min-height: 300px;     /* Altura mínima de seguridad */
  display: block;        /* Asegura comportamiento de bloque */
}




/* Gráfico de instructores (otra pestaña) */
#chartInstructoresHorasContainer {
  width: 90% !important;
  height: 400px;
}


/* Contenedor específico del gráfico de competencias */
#chartCompetenciasHorasContainer {
  width: 100%;
  height: 100%;          /* la altura la controla JS */
}

#chartInstructoresHorasContainer {
  width: 90% !important;
  height: 400px;
}


/* Márgenes de títulos dentro del reporte 2 */
#reporte2 h3 {
  margin-top: 16px;
  margin-bottom: 10px;
}


/* ================= RESPONSIVE ================= */

@media (max-width: 900px) {
  header {
    flex-direction: column;
    align-items: flex-start;
    padding: 16px 20px;
  }

  .header-center {
    margin-left: 0;
    text-align: left;
  }

  #sectionFile1,
  #sectionFile2,
  #sectionFile3 {
    flex-direction: column;
    align-items: stretch;
  }

  #btnProcesar1,
  #btnProcesar2,
  #btnCargarDiseno {
    width: 100%;
    justify-content: center;
  }

  .tabs li {
    flex: 1 1 100%;
  }
}

/* =========================
   Filtros Reporte 1 (Instructores y Competencias)
   ========================= */

.filtros-reporte1 {
  margin: 14px 0 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Buscador tipo pastilla */
.filtro-busqueda-reporte1 {
  position: relative;
  max-width: 420px;
}

.filtro-busqueda-reporte1 input {
  width: 100%;
  padding: 9px 12px 9px 36px;
  border-radius: 999px;
  border: 1px solid var(--gris-borde);
  background-color: #f9fafb;
  font-size: 13px;
  outline: none;
  color: var(--texto-principal);
  transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
}

.filtro-busqueda-reporte1 input::placeholder {
  color: var(--texto-secundario);
}

.filtro-busqueda-reporte1 input:focus {
  border-color: var(--verde-sena);
  background-color: #ffffff;
  box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.18);
}

.filtro-busqueda-icono {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  color: var(--texto-secundario);
}

/* Chips de categorías */
.filtros-categorias-reporte1 {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.chip-reporte1 {
  position: relative;
  display: inline-block;
}

/* ocultamos el checkbox nativo, el label actúa como botón */
.chip-reporte1 input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.chip-reporte1-inner {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 6px 18px;
  border-radius: 999px;
  border: 1px solid var(--verde-sena-oscuro);
  background-color: #ffffff;
  color: var(--verde-sena-oscuro);
  font-size: 13px;
  font-weight: 500;
  min-width: 120px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
  transition:
    background-color 0.15s ease,
    color 0.15s ease,
    box-shadow 0.15s ease,
    transform 0.15s ease,
    border-color 0.15s ease;
}

.chip-reporte1-inner:hover {
  border-color: var(--verde-sena);
  box-shadow: 0 6px 14px rgba(40, 167, 69, 0.25);
}

/* Icono de check dentro del chip */
.chip-check {
  font-size: 12px;
  opacity: 0;
}

/* Estado ACTIVO (checkbox marcado) */
.chip-reporte1 input:checked + .chip-reporte1-inner {
  background-color: var(--verde-sena-oscuro);
  color: #ffffff;
  border-color: var(--verde-sena-oscuro);
  box-shadow: 0 10px 22px rgba(40, 167, 69, 0.45);
  transform: translateY(-1px);
}

.chip-reporte1 input:checked + .chip-reporte1-inner .chip-check {
  opacity: 1;
}

/* Responsive: en pantallas pequeñas, que se acomoden uno bajo otro si hace falta */
@media (max-width: 768px) {
  .filtros-reporte1 {
    align-items: stretch;
  }

  .filtros-categorias-reporte1 {
    justify-content: flex-start;
  }
}

/* ================================
   Encabezado / Información de la Ficha
   ================================ */

#headerInfo {
 max-width: 1300px; 
  margin: 24px auto;
  padding: 22px 28px;                  /* sin padding, lo controlamos dentro */
  border-radius: 16px;
  background-color: #ffffff;
  border: 1px solid #e5e7eb;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  overflow: hidden;
}

/* Barra superior con título e icono "i" */
#headerInfo > h2 {
  margin: 0;
  padding: 10px 18px;
  background-color: #eef4ff;
  border-bottom: 1px solid #d0e2ff;
  font-size: 16px;
  font-weight: 600;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 8px;
}

#headerInfo > h2::before {
  content: "i";
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background-color: #ffffff;
  border: 1px solid #d0e2ff;
  color: #2563eb;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
}


/* ============================
   Estilo Específico de Tarjeta Info (Nuevo Diseño)
   ============================ */

/* Estilo general de la tarjeta de información */
/* ============================
   Estilo Específico de Tarjeta Info (Nuevo Diseño)
   ============================ */

/* Estilo general de la tarjeta de información */
.card-info {
    background-color: white;
    border: 1px solid var(--gris-borde);
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    margin: 15px 18px 25px 18px;
}

/* Encabezado de la tarjeta de información */
.card-info .card-header {
    background-color: var(--verde-sena-claro); 
    border-bottom: 1px solid var(--gris-borde);
    padding: 15px 20px;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}

.card-info .card-header h3 {
    margin-top: 0;
    margin-bottom: 5px;
    color: var(--verde-sena-oscuro); 
    font-size: 1.25em;
    font-weight: 700;
}

.card-info .card-header p#nombrePrograma {
    margin: 0;
    font-size: 1.1em;
    font-weight: 500;
    color: var(--texto-principal);
}

/* CUERPO: Define dos columnas */
.card-info .card-body {
    padding: 15px 20px;
    display: grid;
    /* Divide el cuerpo en dos columnas con un tamaño mínimo de 300px */
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px 30px; 
}

/* Estilo para cada grupo de información (como Código Programa) */
.card-info .info-group p {
    margin-top: 0;
    margin-bottom: 10px; /* Separación entre el grupo de info y el siguiente */
    color: var(--texto-principal);
    font-size: 0.95em;
}

.card-info .info-group strong {
    color: var(--texto-secundario);
    font-weight: 500;
}

.card-info .info-group span {
    font-weight: 700;
}

/* GRUPO DE FECHAS: Agrupamos las 4 fechas en el segundo bloque */
.card-info .fechas-group {
    display: flex; /* Usamos flexbox para alinear las fechas internamente */
    flex-direction: column; /* Las fechas una debajo de la otra */
    gap: 5px; /* Pequeña separación vertical entre cada fecha */
}

.card-info .fechas-group p {
    margin: 0;
    color: var(--texto-principal);
    font-size: 0.95em;
}

.card-info .fechas-group strong {
    color: var(--texto-secundario);
    font-weight: 500;
    min-width: 150px; /* Asegura que la etiqueta tenga un ancho mínimo para alinearse */
    display: inline-block;
}

.card-info .fechas-group span {
    font-weight: 700;
}

/* ====== Estado de Aprendices + Gráfico lado a lado ====== */

/* Contenedor general de la parte inferior (tabla + gráfico) usando floats */


/* === Destacar Nombre del Programa y Código de Ficha === */

#headerInfo > table:first-of-type td {
  font-size: 13px;           /* un poco más pequeño en general */
}

/* Nombre del programa destacado */
#nombrePrograma {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 999px;
  background-color: #d1fae5; /* verde muy claro */
  color: #065f46;            /* verde oscuro */
  font-size: 15px;           /* ligeramente mayor que el resto */
  font-weight: 700;
}

/* Código de ficha destacado */
#codigoFicha {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 999px;
  background-color: #e0f2fe; /* azul claro */
  color: #1d4ed8;            /* azul más intenso */
  font-weight: 700;
}

/* Primera columna (Estado) en negrita */
#tablaEstado tbody td:first-child {
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
}



/* Cabecera de la tabla de estado */
#tablaEstado thead th {
  background-color: #f9fafb;
  color: #6b7280;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

#tablaEstado tbody tr:nth-child(odd) {
  background-color: #ffffff;
}

#tablaEstado tbody tr:nth-child(even) {
  background-color: #f9fafb;
}


/* ============= SECCIÓN DE EXPORTACIÓN (CENTRO DE REPORTES) ============= */

.export-section {
  margin-top: 24px;
}

.export-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 18px;
}

.export-header-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background-color: #e0edff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
}

.export-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
}

.export-header p {
  margin: 2px 0 0 0;
  font-size: 13px;
  color: var(--texto-secundario);
}

.export-body {
  display: flex;
  gap: 24px;
}

.export-left {
  flex: 1 1 65%;
  min-width: 0;
}

.export-right {
  flex: 0 0 320px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Cabecera izquierda (título + buscador) */

.export-left-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
}

.export-left-header h3 {
  margin: 0 0 4px 0;
  font-size: 16px;
}

.export-left-header p {
  margin: 0;
  font-size: 13px;
  color: var(--texto-secundario);
}

/* Buscador */

.export-search {
  position: relative;
  width: 260px;
  max-width: 100%;
}

.export-search input {
  width: 100%;
  padding: 8px 10px 8px 28px;
  border-radius: 999px;
  border: 1px solid var(--gris-borde);
  font-size: 13px;
  outline: none;
  background-color: #f9fafb;
}

.export-search-icon {
  position: absolute;
  left: 9px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  color: var(--texto-secundario);
}

/* Barra de selección y contador */

.export-left-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 13px;
}

.select-all {
  display: flex;
  align-items: center;
  gap: 6px;
}

#contadorSeleccionados {
  color: #2563eb;
  font-weight: 500;
}

/* Lista de reportes */

.lista-reportes {
  border-radius: 12px;
  border: 1px solid var(--gris-borde);
  background-color: #f9fafb;
  padding: 12px 14px;
  max-height: 260px;
  overflow-y: auto;
}

.lista-reportes label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  padding: 6px 4px;
  border-radius: 8px;
  cursor: pointer;
}

.lista-reportes label:hover {
  background-color: #e5f3ff;
}

.lista-reportes input[type="checkbox"] {
  accent-color: var(--verde-sena);
}

/* Tarjetas de exportación (derecha) */

.export-right h3 {
  margin: 0 0 8px 0;
  font-size: 15px;
}

.export-card {
  width: 100%;
  justify-content: flex-start;
  padding: 12px 14px;
  border-radius: 12px;
  background-color: #f9fafb;
  color: var(--texto-principal);
  box-shadow: none;
}

.export-card-icon {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-right: 10px;
}

.export-card-icon.pdf { background-color: #ffe4e6; }
.export-card-icon.excel { background-color: #dcfce7; }
.export-card-icon.word { background-color: #e0f2fe; }

.export-card-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
  font-size: 13px;
}

.export-card-text strong {
  font-size: 14px;
}

.export-card-text span {
  color: var(--texto-secundario);
}

.export-card-arrow {
  margin-left: auto;
  font-size: 18px;
  color: #9ca3af;
}

/* Responsive */

@media (max-width: 900px) {
  .export-body {
    flex-direction: column;
  }
  .export-right {
    flex: 1 1 auto;
  }
}
/* ================= FOOTER DISEÑO Y DESARROLLO ================= */

.footer-disenador {
  max-width: 1200px;
  margin: 16px auto 32px;
  text-align: center;
}

.footer-disenador-title {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.16em;
  text-transform: uppercase;
  color: #9ca3af;
  margin-bottom: 8px;
}

.footer-disenador-card {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 6px 14px;
  border-radius: 999px;
  background-color: #ffffff;
  box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
}

.footer-disenador-avatar {
  width: 32px;
  height: 32px;
  border-radius: 999px;
  background-color: #fb923c; /* naranja */
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ffffff;
  font-size: 18px;
}

.footer-disenador-info {
  text-align: left;
}

.footer-disenador-label {
  display: block;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #9ca3af;
}

.footer-disenador-name {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: var(--texto-principal);
}

.footer-disenador-settings {
  margin-left: 8px;
  width: 26px;
  height: 26px;
  border-radius: 999px;
  background-color: #e0f2fe;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #2563eb;
  font-size: 14px;
}
/* ============================
   Layout tipo tarjetas ficha
   ============================ */

.ficha-layout {
  padding: 16px 18px 20px;
}

/* Fila superior: 4 tarjetas */
.ficha-grid-top {
  display: grid;
  grid-template-columns: minmax(140px, 180px) minmax(280px, 1.4fr) minmax(140px, 180px) minmax(140px, 180px);
  gap: 12px;
  margin-bottom: 14px;
}

/* Fila inferior: 2 tarjetas */
.ficha-grid-bottom {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

/* Tarjeta base */
.ficha-card {
  background-color: #ffffff;
  border-radius: 14px;
  border: 1px solid #e4e9f2;
  padding: 14px 18px;
  box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
}

/* Etiqueta pequeña arriba de cada tarjeta */
.ficha-card-label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--texto-secundario);
  margin-bottom: 6px;
}

/* Tarjetas pequeñas izquierda / derecha */
.ficha-card-small .ficha-card-value {
  font-size: 22px;
  font-weight: 700;
  color: var(--texto-principal);
}

/* Tarjeta central del programa */
.ficha-card-programa {
  background-color: var(--verde-sena-claro);
  border-color: #bbf7d0;
}

.ficha-card-programa .ficha-card-label {
  color: var(--verde-sena-oscuro);
}

.ficha-card-programa-value {
  display: block;
  margin-top: 2px;
  font-size: 20px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--texto-principal);
}

/* Tarjetas de fechas (etapas) */
.ficha-card-fechas {
  position: relative;
  padding-top: 24px; /* espacio para el badge */
}

/* Badge de etapa lectiva / productiva */
.ficha-badge {
  position: absolute;
  top: -10px;
  left: 18px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border: 1px solid transparent;
}

.ficha-badge-lectiva {
  background-color: #ecfdf3;
  border-color: #22c55e;
  color: #15803d;
}

.ficha-badge-productiva {
  background-color: #fffbeb;
  border-color: #f97316;
  color: #c2410c;
}

/* Contenedor interno de las dos fechas */
.ficha-fechas-row {
  display: flex;
  gap: 18px;
  align-items: flex-start;
}

.ficha-fecha {
  flex: 1;
}

/* Línea vertical separadora */
.ficha-fecha-divider {
  width: 1px;
  background-color: #e5e7eb;
}

/* Etiqueta de la fecha */
.ficha-fecha-label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--texto-secundario);
  margin-bottom: 4px;
}

/* Valor de la fecha con icono */
.ficha-fecha-value {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  font-weight: 500;
  color: var(--texto-principal);
}

.ficha-fecha-icon {
  font-size: 15px;
}

.ficha-tiempo-restante {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--texto-secundario);
}

.ficha-tiempo-label {
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.ficha-tiempo-value {
  font-weight: 700;
  color: var(--texto-principal);
  font-size: 13px;
}

/* ========= Overrides para #nombrePrograma y #codigoFicha
   (evitar el estilo de "pastilla" anterior) ========= */

#headerInfo .ficha-card-programa #nombrePrograma {
  display: block;
  margin: 2px 0 0 0;
  padding: 0;
  border-radius: 0;
  background: transparent;
  font-size: 20px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--texto-principal);
}

#headerInfo .ficha-card-small #codigoFicha,
#headerInfo .ficha-card-small #codigoPrograma {
  display: block;
  margin-top: 4px;
  padding: 0;
  border-radius: 0;
  background: transparent;
  color: var(--texto-principal);
  font-size: 22px;
  font-weight: 700;
}


/* ============================
   Resumen numérico de la ficha
   (tarjetas KPI + análisis de rendimiento)
   ============================ */

.ficha-summary-row {
  width: calc(100% - 36px);
  margin: 16px 18px 10px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* -------- Fila superior: tarjetas KPI -------- */

.ficha-summary-top {
  display: grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap: 12px;
}

.ficha-kpi-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 16px;
  border-radius: 16px;
  border: 1px solid var(--gris-borde);
  background-color: #ffffff;
  box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
  transition: background-color 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease;
}

.ficha-kpi-card:hover {
  border-color: var(--verde-sena);
  background-color: #f9fafb;
  box-shadow: 0 10px 22px rgba(40, 167, 69, 0.25);
  transform: translateY(-1px);
}

.ficha-kpi-competencias {
  background: #ffffff;
}
.ficha-kpi-resultados {
  background: #ffffff;
}


.ficha-kpi-icon {
  flex: 0 0 42px;
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background-color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
}

.ficha-kpi-info {
  display: flex;
  flex-direction: column;
}

.ficha-kpi-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--texto-secundario);
}

.ficha-kpi-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--texto-principal);
}

/* -------- Fila media: Instructor y Coordinador -------- */

.ficha-summary-middle {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));  /* <- AQUÍ EL CAMBIO */
  gap: 12px;
}

.ficha-secondary-card {
  padding: 14px 16px;
  border-radius: 16px;
  border: 1px solid var(--gris-borde);
  background-color: #ffffff;
  box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
}

.ficha-secondary-instructor {
  background-color: #fefce8;
  border-color: #fde68a;
}

.ficha-secondary-coordinador {
  background-color: #ecfdf5;
  border-color: #6ee7b7;
}

.ficha-secondary-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--texto-secundario);
  margin-bottom: 6px;
}

.ficha-secondary-icon {
  font-size: 16px;
}

.ficha-secondary-value {
  font-size: 16px;
  font-weight: 600;
  color: var(--texto-principal);
}

/* -------- Bloque inferior: Análisis de rendimiento -------- */

.ficha-analisis-card {
  margin-top: 2px;
  padding: 16px 18px 14px;
  border-radius: 16px;
  border: 1px solid var(--gris-borde);
  background-color: #ffffff;
  box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
}

.ficha-analisis-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--texto-secundario);
  margin-bottom: 10px;
}

.ficha-analisis-icon {
  font-size: 16px;
}

.ficha-analisis-main {
  display: grid;
  grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
  gap: 16px;
  align-items: center;
}

/* Avance promedio + barra verde */

.ficha-analisis-avance-label {
  font-size: 13px;
  color: var(--texto-secundario);
  margin-bottom: 4px;
}

.ficha-analisis-avance-valor {
  font-size: 28px;
  font-weight: 700;
  color: var(--verde-sena-oscuro);
}

.ficha-analisis-barra {
  margin-top: 6px;
  width: 100%;
  height: 8px;
  border-radius: 999px;
  background-color: #e5e7eb;
  overflow: hidden;
}

.ficha-analisis-barra-fill {
  width: 0;
  height: 100%;
  border-radius: inherit;
  background: linear-gradient(90deg, var(--verde-sena), #22c55e);
  transition: width 0.4s ease-out;
}

.ficha-analisis-avance-nota {
  margin-top: 6px;
  font-size: 11px;
  color: var(--texto-secundario);
}

/* Métricas de competencias y aprendices en riesgo */

.ficha-analisis-metricas {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ficha-analisis-metrica {
  padding: 10px 12px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.ficha-analisis-metrica-ok {
  background-color: #ecfdf3;
  border: 1px solid #bbf7d0;
}

.ficha-analisis-metrica-alerta {
  background-color: #fef2f2;
  border: 1px solid #fecaca;
}

.ficha-analisis-metrica-header {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--texto-secundario);
}

.ficha-analisis-metrica-badge {
  width: 20px;
  height: 20px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}

.ficha-analisis-metrica-ok .ficha-analisis-metrica-badge {
  background-color: #22c55e;
  color: #ffffff;
}

.ficha-analisis-metrica-alerta .ficha-analisis-metrica-badge {
  background-color: #f97316;
  color: #ffffff;
}

.ficha-analisis-metrica-valor {
  font-size: 22px;
  font-weight: 700;
  color: var(--texto-principal);
}

/* Responsive */

@media (max-width: 900px) {
  .ficha-summary-top {
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }

  .ficha-summary-middle {
    grid-template-columns: 1fr;
  }

  .ficha-analisis-main {
    grid-template-columns: 1fr;
  }
}

/* ====== Estado de Aprendices + Gráfico lado a lado ====== */

/* Tarjeta contenedora de la tabla */
.detalle-aprendices-card {
  width: calc(100% - 36px);   /* 100% dentro de #headerInfo, respetando márgenes laterales */
  margin: 16px 18px 12px;     /* margen arriba/abajo y laterales */
  float: none;                /* sin floats, va arriba de la gráfica */
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  background-color: #ffffff;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
  overflow: hidden;
}


/* Encabezado de la tarjeta: icono + título + total */
.detalle-aprendices-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  border-bottom: 1px solid #e5e7eb;
  background-color: #f9fafb;
}

.detalle-aprendices-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #111827;
}

.detalle-aprendices-icon {
  width: 24px;
  height: 24px;
  border-radius: 999px;
  background-color: #ecfdf3;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #16a34a;
}

.detalle-aprendices-total {
  padding: 4px 10px;
  border-radius: 999px;
  background-color: #dcfce7;
  color: #166534;
  font-size: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

/* Tabla interna */
#tablaEstado {
  width: 100%;
  margin: 0;
  border-collapse: collapse;
  background-color: #ffffff;
}

/* Cabecera de la tabla */
#tablaEstado thead th {
  background-color: #f9fafb;
  color: #6b7280;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  padding: 8px 10px;
  border-bottom: 1px solid #e5e7eb;
}

/* Celdas cuerpo */
#tablaEstado tbody td {
  font-size: 13px;
  padding: 10px 10px;
  border-bottom: 1px solid #e5e7eb;
}

/* Primera columna: contenedor de la pastilla */
#tablaEstado tbody td:first-child {
  width: 140px;
}

/* Pastilla de estado */
#tablaEstado .badge-estado {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  border: 1px solid transparent;
}

/* Columnas numéricas */
#tablaEstado td.col-cantidad,
#tablaEstado td.col-porcentaje {
  text-align: center;
  font-weight: 700;
}

/* Fila por defecto */
#tablaEstado tbody tr {
  background-color: #ffffff;
}
/* Tarjeta para la gráfica de estados de aprendices */
.estado-chart-card {
  width: calc(100% - 36px);
  margin: 0 18px 18px;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  background-color: #ffffff;
  box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
  padding: 16px 24px 20px;
}

/* Título de la tarjeta de la gráfica */
.estado-chart-title {
  margin: 0 0 12px 0;
  font-size: 16px;
  font-weight: 700;
  color: #111827;
  text-align: left;
}

/* Contenedor del canvas de la gráfica */
.estado-chart-wrapper {
  position: relative;
  width: 100%;
  min-height: 260px;
  display: flex;              /* nuevo */
  justify-content: center;    /* nuevo: centra horizontalmente el contenido */
}

/* El área real de la gráfica (CanvasJS) */
#estadoChartContainer {
  width: 100%;
  max-width: 900px;   /* ajusta este valor si quieres la gráfica más grande o más pequeña */
  margin: 0 auto;
}



/* Responsive: tabla y gráfica ocupando 100% en móviles */
@media (max-width: 900px) {
  .detalle-aprendices-card,
  .estado-chart-card {
    width: calc(100% - 36px);
    margin: 8px 18px;
  }
}


/* Colores de la pastilla según estado */
#tablaEstado tbody tr.estado-en-formacion .badge-estado {
  background-color: #16a34a;
  border-color: #15803d;
  color: #ffffff;
}

#tablaEstado tbody tr.estado-condicionado .badge-estado {
  background-color: #facc15;
  border-color: #eab308;
  color: #92400e;
}

#tablaEstado tbody tr.estado-cancelado .badge-estado {
  background-color: #e5e7eb;
  border-color: #9ca3af;
  color: #374151;
}

#tablaEstado tbody tr.estado-retiro .badge-estado {
  background-color: #f97373;
  border-color: #b91c1c;
  color: #ffffff;
}

#tablaEstado tbody tr.estado-otro .badge-estado {
  background-color: #eff6ff;
  border-color: #3b82f6;
  color: #1d4ed8;
}



/* ========= Responsive ========= */
@media (max-width: 900px) {
  .ficha-grid-top {
    grid-template-columns: 1fr;
  }

  .ficha-grid-bottom {
    grid-template-columns: 1fr;
  }

  #tablaEstado,
  #headerInfo > div:last-of-type {
    float: none;
    width: calc(100% - 36px);
    margin: 8px 18px;
  }
}

.fila-instructor-diferente {
    background-color: #fff7b0 !important; /* amarillo suave */
}
.textoRojo {
    background-color: #fee2e2 !important; /* rojo claro para avance < 75% */
}
/* Competencias no programadas o programadas a 1/2 en el Reporte 4 */
tr.no-programada td {
  background-color: #fee2e2 !important; /* rojo claro */
}

/* Linea de tiempo para fechas de la ficha */
.timeline-card {
  margin: 14px auto 18px;
  padding: 12px 16px;
  background: #ffffff;
  border: 1px solid var(--gris-borde);
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
}

.timeline-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 8px;
}

.timeline-title {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  font-weight: 700;
  color: var(--texto-principal);
}

.timeline-title .icon {
  font-size: 15px;
}

.timeline-status {
  padding: 4px 10px;
  border-radius: 999px;
  background: #ecfdf3;
  color: #15803d;
  border: 1px solid #86efac;
  font-size: 12px;
  font-weight: 600;
}

.timeline-track {
  position: relative;
  height: 90px;
  margin-top: 8px;
}

.timeline-track::before {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  height: 6px;
  transform: translateY(-50%);
  background: #e5e7eb;
  border-radius: 999px;
}

.timeline-fill {
  position: absolute;
  left: 0;
  top: 50%;
  height: 6px;
  transform: translateY(-50%);
  background: linear-gradient(90deg, var(--verde-sena), #22c55e);
  border-radius: 999px;
  width: 0%;
}

.timeline-point {
  position: absolute;
  top: 50%;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 3px solid #ffffff;
  background: #d1d5db;
  transform: translate(-50%, -50%);
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.15);
}

.timeline-point.past {
  background: #22c55e;
}

.timeline-point.future {
  background: #d1d5db;
}

.timeline-point.today {
  background: #ef4444;
  box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
}

.timeline-point-label {
  position: absolute;
  top: 24px;
  left: 50%;
  transform: translate(-50%, 0);
  text-align: center;
  font-size: 11px;
  line-height: 1.3;
  color: var(--texto-principal);
  white-space: nowrap;
}

.timeline-point.alt .timeline-point-label {
  top: auto;
  bottom: 26px;
}

.timeline-track.compact {
  height: 72px;
}

.timeline-compact .timeline-header {
  margin-bottom: 6px;
}

.timeline-compact .timeline-point {
  width: 14px;
  height: 14px;
}

.timeline-compact .timeline-point-label {
  font-size: 10px;
}


  </style>
</head>
<body>
  <header>
    <img src='https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png' alt='Logo SENA'>
    <h1>Servicio Nacional de Aprendizaje - SENA Regional Tolima</h1>
    <div class="header-center">
      <h2>Centro de Comercio y Servicios</h2>
            <h1>SENA 360 – Panel Integral de Seguimiento a la FPI</h1>

      <hr>
    </div>
    </header>

  <!-- PANTALLA INICIAL / LOGIN COORDINADOR -->
  <div id="loginOverlay">
    <div class="login-card">
      <div class="login-logo">
        <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png" alt="Logo SENA">
      </div>
      <h1 class="login-title">SENA 360 – Panel Integral de Seguimiento a la FPI</h1>
      <p class="login-subtitle">Seleccione el Coordinador Académico para ingresar</p>

      <div class="login-field">
        <label for="coordinadorSelect">Coordinador Académico</label>
        <select id="coordinadorSelect">
          <option value="">Seleccione un coordinador...</option>
          <option value="EDNA PAOLA OSORIO MUÑOZ">EDNA PAOLA OSORIO MUÑOZ</option>
          <option value="JORGE ARMANDO VARELA RENDÓN">JORGE ARMANDO VARELA RENDÓN</option>
          <option value="YOLANDA CÁRDENAS VILLAMARIN">YOLANDA CÁRDENAS VILLAMARIN</option>
        </select>
      </div>

      <div class="login-toggle-roles">
        <input type="checkbox" id="chkValidarRoles" checked aria-label="Validar roles" title="Validar roles" />
      </div>

      <button id="btnIngresar" class="btnEstilo login-button">Ingresar</button>
      <div id="loginMensajeError" class="login-error" style="display:none;">
        Por favor seleccione un coordinador para continuar.
      </div>
    </div>
  </div>
<!-- Overlay para confirmar Gerente de Proyecto -->
<div id="gerenteOverlay">
  <div class="login-card">
    <div class="login-header">
      <div class="login-header-main">
        <span class="login-icon">📋</span>
        <div>
          <div class="login-title">Confirmar Gerente de Proyecto</div>
          <div class="login-subtitle">
            ¿El siguiente instructor es el Gerente de Proyecto?
          </div>
        </div>
      </div>
    </div>

    <div class="login-fields">
      <div class="login-field">
        <label>Instructor</label>
        <div id="gerenteInstructorNombre"
             class="login-subtitle"
             style="font-weight:600;"></div>
      </div>
    </div>

    <div class="login-actions">
      <button id="btnGerenteSi" class="btnEstilo">
        <span class="login-button-icon">✔</span>
        <span>Sí</span>
      </button>

      <button id="btnGerenteNo" class="btnEstilo btn-negativo">
        <span class="login-button-icon">✖</span>
        <span>No</span>
      </button>
    </div>

    <!-- Se muestra solo si el usuario responde NO -->
    <div id="contenedorSelectorGerente" style="display:none; margin-top:18px;">
      <div class="login-field">
        <label>Seleccione el Gerente de Proyecto</label>
        <select id="selectGerenteProyecto">
          <option value="">Seleccione un instructor…</option>
        </select>
      </div>

      <div class="login-actions" style="margin-top:10px; justify-content:flex-end;">
        <button id="btnAceptarGerente" class="btnEstilo">
          <span class="login-button-icon">✔</span>
          <span>Aceptar</span>
        </button>
      </div>

      <div id="gerenteMensajeError" class="login-error" style="display:none;">
        Por favor seleccione un instructor.
      </div>
    </div>
  </div>
</div>
<!-- Overlay para seleccionar Aprendiz Vocero -->
<div id="voceroOverlay" style="display:none;">
  <div class="login-card">
    <div class="login-header">
      <div class="login-header-main">
        <span class="login-icon">🗣️</span>
        <div>
          <div class="login-title">Seleccionar Aprendiz Vocero</div>
          <div class="login-subtitle">
            Seleccione el aprendiz vocero del grupo (solo estado EN FORMACIÓN).
          </div>
        </div>
      </div>
    </div>

    <div class="login-fields">
      <div class="login-field">
        <label for="selectAprendizVocero">Aprendiz Vocero</label>
        <select id="selectAprendizVocero">
          <option value="">Seleccione un aprendiz…</option>
        </select>
      </div>
    </div>

    <div class="login-actions" style="margin-top:10px; justify-content:flex-end;">
      <button id="btnAceptarVocero" class="btnEstilo">
        <span class="login-button-icon">✔</span>
        <span>Aceptar</span>
      </button>
    </div>

    <div id="voceroMensajeError" class="login-error" style="display:none;">
      Por favor seleccione un aprendiz.
    </div>
  </div>
</div>

 <!-- ACORDEÓN: Cargue de Archivos -->
<div id="accordionCargue" class="contenedor">
  <button type="button" id="accordionCargueToggle" class="acordeon-header">
    <span>📂 Cargue de Archivos</span>
    <span id="accordionCargueIcon" class="acordeon-icon">▾</span>
  </button>

  <div id="accordionCargueBody" class="acordeon-body">
    <!-- ARCHIVO 1 -->
    <div id="sectionFile1">
      <h2>Cargar Archivo de Instructores (XLS/XLSX)</h2>
      <p class="nota-archivo"><em>Obtener en Sofia Plus: Rol (Gestion de Desarrollo Curricular) › Gestion de Ambientes › Instructores › Reporte de Instructores por Ficha.</em></p>
      <input type="file" id="excelFile1" accept=".xls,.xlsx" />
      <br /><br />
      <button id="btnProcesar1" class="btnEstilo">Procesar Archivo 1</button>
      <div id="mensajeArchivo1" class="mensaje-archivo"></div>
    </div>

    <!-- ARCHIVO 2 -->
    <div id="sectionFile2" style="display: none;">
      <h2>Cargar Archivo de Juicios Evaluativos (XLS/XLSX)</h2>
      <p class="nota-archivo"><em>Obtener en Sofia Plus: Rol (Gestion de Desarrollo Curricular o Instructor) › Ejecucion de la formacion › Reportes › Reportes de Juicio de Evaluacion.</em></p>
      <input type="file" id="excelFile2" accept=".xls,.xlsx" />
      <br /><br />
      <button id="btnProcesar2" class="btnEstilo">Procesar Archivo 2</button>
      <div id="mensajeArchivo2" class="mensaje-archivo"></div>
    </div>

    <!-- ARCHIVO 3 -->
    <div id="sectionFile3" style="display: none;">
      <h2>Cargar Archivo de Horas Diseño (XLS/XLSX)</h2>
      <input type="file" id="archivoDiseno" accept=".xls,.xlsx" />
      <br /><br />
      <button id="btnCargarDiseno" class="btnEstilo">Procesar Archivo 3</button>
      <p class="nota-archivo"><em>Descargar desde: <a href="https://acortar.link/p1cWdD" target="_blank" rel="noopener noreferrer">https://acortar.link/p1cWdD</a></em></p>
      <div id="mensajeArchivo3" class="mensaje-archivo"></div>
    </div>
  </div>
</div>

  <!-- ENCABEZADO DE LA FICHA (Se muestra después de File1) -->
<div class="contenedor" id="headerInfo" style="display:none;">
  
<!-- Cabecera del acordeón -->
  <button type="button" id="accordionInfoToggle" class="acordeon-header">
    <span>ℹ️ Información General de la Ficha</span>
    <span id="accordionInfoIcon" class="acordeon-icon">▾</span>
  </button>
<!-- Cuerpo del acordeón: INICIA ABIERTO -->
  <div id="accordionInfoBody" class="acordeon-body">

  <!-- Tarjetas superiores: código ficha, nombre programa, código programa -->
  <div class="ficha-layout">
    <div class="ficha-grid-top">
      <!-- Código Ficha -->
      <div class="ficha-card ficha-card-small">
        <span class="ficha-card-label">CÓDIGO FICHA</span>
        <span class="ficha-card-value" id="codigoFicha"></span>
      </div>

      <!-- Nombre del programa -->
      <div class="ficha-card ficha-card-programa">
        <span class="ficha-card-label">NOMBRE DEL PROGRAMA</span>
        <span class="ficha-card-programa-value" id="nombrePrograma"></span>
      </div>

      <!-- Código del programa -->
      <div class="ficha-card ficha-card-small">
        <span class="ficha-card-label">CÓDIGO DEL PROGRAMA</span>
        <span class="ficha-card-value" id="codigoPrograma"></span>
      </div>

      <!-- Modalidad de Formación -->
      <div class="ficha-card ficha-card-small">
        <span class="ficha-card-label">MODALIDAD DE FORMACIÓN</span>
        <span class="ficha-card-value" id="modalidadFormacion"></span>
      </div>
    </div>

    <!-- Tarjetas inferiores: etapa lectiva / productiva -->
    <div class="ficha-grid-bottom">
      <!-- Etapa lectiva -->
      <div class="ficha-card ficha-card-fechas">
        <span class="ficha-badge ficha-badge-lectiva">ETAPA LECTIVA</span>

        <div class="ficha-fechas-row">
          <div class="ficha-fecha">
            <span class="ficha-fecha-label">FECHA INICIO</span>
            <span class="ficha-fecha-value">
              <span class="ficha-fecha-icon" aria-hidden="true">📅</span>
              <span id="fechaInicioLectiva"></span>
            </span>
          </div>

          <div class="ficha-fecha-divider"></div>

          <div class="ficha-fecha">
            <span class="ficha-fecha-label">FECHA FIN</span>
            <span class="ficha-fecha-value">
              <span class="ficha-fecha-icon" aria-hidden="true">📅</span>
              <span id="fechaFinLectiva"></span>
            </span>
          </div>
        </div>

        <div class="ficha-tiempo-restante">
          <span class="ficha-tiempo-label">Tiempo restante</span>
          <span class="ficha-tiempo-value" id="tiempoRestanteLectiva">-</span>
        </div>
      </div>

      <!-- Etapa productiva -->
      <div class="ficha-card ficha-card-fechas">
        <span class="ficha-badge ficha-badge-productiva">ETAPA PRODUCTIVA</span>

        <div class="ficha-fechas-row">
          <div class="ficha-fecha">
            <span class="ficha-fecha-label">FECHA INICIO</span>
            <span class="ficha-fecha-value">
              <span class="ficha-fecha-icon" aria-hidden="true">👥</span>
              <span id="fechaInicioProductiva"></span>
            </span>
          </div>

          <div class="ficha-fecha-divider"></div>

          <div class="ficha-fecha">
            <span class="ficha-fecha-label">FECHA FIN</span>
            <span class="ficha-fecha-value">
              <span class="ficha-fecha-icon" aria-hidden="true">🚩</span>
              <span id="fechaFinProductiva"></span>
            </span>
          </div>
        </div>

        <div class="ficha-tiempo-restante">
          <span class="ficha-tiempo-label">Tiempo restante</span>
          <span class="ficha-tiempo-value" id="tiempoRestanteProductiva">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Línea de tiempo compacta (debajo de fechas) -->
  <div class="timeline-card timeline-compact">
    <div class="timeline-header">
      <div class="timeline-title"><span class="icon">🕒</span>Cronograma de Formación</div>
      <div class="timeline-status" id="estadoEtapaMini">-</div>
    </div>
    <div class="timeline-track compact" id="timelineTrackMini">
      <div class="timeline-fill" id="timelineFillMini"></div>
      <div class="timeline-point" id="pMiniInicioLectiva"><span class="timeline-point-label">Inicio Lectiva<br><small id="dMiniInicioLectiva"></small></span></div>
      <div class="timeline-point alt" id="pMiniFinLectiva"><span class="timeline-point-label">Fin Lectiva<br><small id="dMiniFinLectiva"></small></span></div>
      <div class="timeline-point" id="pMiniInicioProd"><span class="timeline-point-label">Inicia Productiva<br><small id="dMiniInicioProd"></small></span></div>
      <div class="timeline-point alt" id="pMiniFinProd"><span class="timeline-point-label">Fin Programa<br><small id="dMiniFinProd"></small></span></div>
      <div class="timeline-point today" id="pMiniHoy"><span class="timeline-point-label">HOY<br><small id="dMiniHoy"></small></span></div>
    </div>
  </div>

    <!-- Resumen numérico de la ficha -->
<!-- Resumen numérico de la ficha -->
<div class="ficha-summary-row">

  <!-- Fila 1: KPIs principales -->
  <div class="ficha-summary-top">
    <div class="ficha-kpi-card ficha-kpi-aprendices">
      <div class="ficha-kpi-icon">📋</div>
      <div class="ficha-kpi-info">
        <span class="ficha-kpi-label">APRENDICES MATRICULADOS</span>
        <span class="ficha-kpi-value" id="numMatriculadosHeader">0</span>
        
      </div>
    </div>

    <div class="ficha-kpi-card ficha-kpi-aprendices">
      <div class="ficha-kpi-icon">🎓</div>
      <div class="ficha-kpi-info">
        <span class="ficha-kpi-label">APRENDICES EN FORMACION</span>
        <span class="ficha-kpi-value" id="numAprendicesHeader">0</span>
              </div>
    </div>

    <div class="ficha-kpi-card ficha-kpi-instructores">
      <div class="ficha-kpi-icon">📡</div>
      <div class="ficha-kpi-info">
        <span class="ficha-kpi-label">INSTRUCTORES</span>
        <span class="ficha-kpi-value" id="numInstructoresHeader">0</span>
      </div>
    </div>

   <div class="ficha-kpi-card ficha-kpi-competencias">
    <div class="ficha-kpi-icon">🧩</div>
    <div class="ficha-kpi-info">
      <span class="ficha-kpi-label">COMPETENCIAS</span>
      <span class="ficha-kpi-value" id="numCompetenciasHeader">0</span>
    </div>
  </div>

  <!-- NUEVA TARJETA: Resultados de Aprendizaje -->
  <div class="ficha-kpi-card ficha-kpi-resultados">
    <div class="ficha-kpi-icon">📚</div>
    <div class="ficha-kpi-info">
      <span class="ficha-kpi-label">RESULTADOS DE APRENDIZAJE</span>
      <span class="ficha-kpi-value" id="numResultadosHeader">0</span>
    </div>
  </div>
</div>

  <!-- Fila 2: Instructor y Coordinador -->
  <div class="ficha-summary-middle">

  <!-- NUEVO: Aprendiz Vocero -->
  <div class="ficha-secondary-card ficha-secondary-vocero">
    <div class="ficha-secondary-title">
      <span class="ficha-secondary-icon">🗣️</span>
      <span>Aprendiz Vocero</span>
    </div>
    <div class="ficha-secondary-value" id="aprendizVoceroHeader">-</div>
  </div>

  <!-- EXISTENTE: Instructor Gerente de Proyecto -->
  <div class="ficha-secondary-card ficha-secondary-instructor">
    <div class="ficha-secondary-title">
      <span class="ficha-secondary-icon">👨‍🏫</span>
      <span>Instructor Gerente de Proyecto</span>
    </div>
    <div class="ficha-secondary-value" id="instructorMasHorasHeader">-</div>
  </div>

  <!-- EXISTENTE: Coordinador Académico -->
  <div class="ficha-secondary-card ficha-secondary-coordinador">
    <div class="ficha-secondary-title">
      <span class="ficha-secondary-icon">📋</span>
      <span>Coordinador Académico</span>
    </div>
    <div class="ficha-secondary-value" id="coordinadorAcademicoHeader">-</div>
  </div>

</div>

  <!-- Fila 3: Análisis de rendimiento -->
  <div class="ficha-analisis-card">
    <div class="ficha-analisis-header">
      <span class="ficha-analisis-icon">📊</span>
      <span>ANÁLISIS DE RENDIMIENTO</span>
    </div>

    <div class="ficha-analisis-main">
      <!-- Bloque de avance promedio -->
      <div class="ficha-analisis-avance">
        <div class="ficha-analisis-avance-label">
          Avance promedio del grupo
        </div>
        <div class="ficha-analisis-avance-valor" id="avancePromedioGrupoHeader">0 %</div>

        <div class="ficha-analisis-barra">
          <div class="ficha-analisis-barra-fill" id="avancePromedioGrupoBar"></div>
        </div>

        <div class="ficha-analisis-avance-nota">
          Calculado sobre el total de competencias
        </div>
      </div>

      <!-- Métricas de riesgo -->
      <div class="ficha-analisis-metricas">
        <div class="ficha-analisis-metrica ficha-analisis-metrica-ok">
          <div class="ficha-analisis-metrica-header">
            <span class="ficha-analisis-metrica-badge">✓</span>
            <span class="ficha-analisis-metrica-titulo">Competencias sobrecargadas</span>
          </div>
          <div class="ficha-analisis-metrica-valor" id="numCompetenciasSobrecargadasHeader">0</div>
        </div>

        <div class="ficha-analisis-metrica ficha-analisis-metrica-alerta">
          <div class="ficha-analisis-metrica-header">
            <span class="ficha-analisis-metrica-badge">!</span>
            <span class="ficha-analisis-metrica-titulo">Aprendices con avance &lt; 75%</span>
          </div>
          <div class="ficha-analisis-metrica-valor" id="numAprendicesRiesgoHeader">0</div>
        </div>
      </div>
    </div>
  </div>
</div>



  <!-- Tabla de Estado -->
    <!-- Tarjeta Detalle de Aprendices -->
  <div class="detalle-aprendices-card">
    <div class="detalle-aprendices-card-header">
      <div class="detalle-aprendices-title">
        <span class="detalle-aprendices-icon">👥</span>
        <span>Detalle de Aprendices</span>
      </div>
      <div class="detalle-aprendices-total">
        <span>Total Aprendices Matriculados:</span>
        <span id="totalAprendicesEstado">0</span>
      </div>
    </div>

    <table id="tablaEstado">
      <thead>
        <tr>
          <th>Estado</th>
          <th>Aprendices (Nombres)</th>
          <th>Cant.</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody id="tbodyEstado"></tbody>
    </table>
  </div>

        <!-- Gráfica Circular de Estados de Aprendices -->
<div class="estado-chart-card">
  <h3 class="estado-chart-title">Distribución de Estados de Aprendices</h3>
  <div class="estado-chart-wrapper">
    <!-- Contenedor para CanvasJS -->
    <div id="estadoChartContainer" style="height: 370px; width: 100%;"></div>
  </div>
</div>


  </div>



  <div id="mensajeError" class="error"></div>


 
</div>

<!-- REPORTES EN PESTAÑAS -->
  <div id="reportes" class="contenedor" style="display: none;">
  <!-- Cabecera del acordeón -->
  <button type="button" id="accordionReportesToggle" class="acordeon-header">
    <span>📊 Reportes de la formacion</span>
<span id="accordionReportesIcon" class="acordeon-icon">▾</span>
     </button>

    <!-- Cuerpo del acordeón: aquí van las pestañas y todo su contenido -->
    <div id="accordionReportesBody" class="acordeon-body">

   <ul class="tabs">
  <!-- REPORTE 1 – tab1 -->
  <li>
    <a href="#tab1" class="active">
      <span class="tab-icon">👥</span>
      <span class="tab-label">REPORTE 1</span>
      <span class="tab-title">Instructores y Competencias</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 2 – tab2 -->
  <li>
    <a href="#tab2">
      <span class="tab-icon">📊</span>
      <span class="tab-label">REPORTE 2</span>
      <span class="tab-title">% Competencias</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 3 – tab4 -->
  <li>
    <a href="#tab4">
      <span class="tab-icon">📅</span>
      <span class="tab-label">REPORTE 3</span>
      <span class="tab-title">Competencias programadas</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 4 – tab5 -->
  <li>
    <a href="#tab5">
      <span class="tab-icon">❗</span>
      <span class="tab-label">REPORTE 4</span>
      <span class="tab-title">Raps por evaluar</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 5 – tab6 -->
  <li>
    <a href="#tab6">
      <span class="tab-icon">✅</span>
      <span class="tab-label">REPORTE 5</span>
      <span class="tab-title">Raps Aprobado / Por evaluar / No aprobado</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 6 – tab7 -->
  <li>
    <a href="#tab7">
      <span class="tab-icon">📈</span>
      <span class="tab-label">REPORTE 6</span>
      <span class="tab-title">% Avance Aprendiz</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 7 – tab8 -->
  <li>
    <a href="#tab8">
      <span class="tab-icon">👤</span>
      <span class="tab-label">REPORTE 7</span>
      <span class="tab-title">Aprendices pendientes por evaluar</span>
      <span class="tab-arrow"></span>
    </a>
  </li>

  <!-- REPORTE 8 – tab3 -->
  <li>
    <a href="#tab3">
      <span class="tab-icon">📡</span>
      <span class="tab-label">REPORTE 8</span>
      <span class="tab-title">Instructores</span>
      <span class="tab-arrow"></span>
    </a>
  </li>
</ul>

  <!-- TAB 1 -->
    <div id="tab1" class="tab-content active">
  <div id="reporte1">
    <h2>Instructores y Competencias</h2>
    <p class="descripcion-reporte">
      Presenta el detalle de cada competencia programada con su instructor y las horas asignadas. 
      Permite identificar qué instructores atienden cada competencia y validar la distribución de la carga académica. 
      Cuenta con barra de búsqueda y filtros por estado del instructor, tipo de competencia transversal, Tecnicas, Ingles para ubicar rápidamente la información.
    </p>

       <!-- Filtros para Reporte 1 -->
    <div class="filtros-reporte1">
      <!-- 1. Caja de texto para buscar -->
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaReporte1"
          placeholder="Buscar instructor, competencia o ficha..."
        />
      </div>

      <!-- 2. Chips / checkboxes de categorías -->
      <div class="filtros-categorias-reporte1">
        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte1"
            data-cat="Transversales"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Transversales</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte1"
            data-cat="Técnicas"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Técnicas</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte1"
            data-cat="Inglés"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Inglés</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte1"
            data-cat="Práctica"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Práctica</span>
          </span>
        </label>
      </div>
    </div>


    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre Instructor</th>
          <th>Apellido Instructor</th>
          <th>Estado Instructor</th>
          <th>Competencia</th>
          <th>Horas Programadas</th>
        </tr>
      </thead>
      <tbody id="tbodyReporte1"></tbody>
    </table>
  </div>
</div>

 <!-- TAB 2 -->
    <div id="tab2" class="tab-content">
  <div id="reporte2">
    <h2>% Competencias con Horas</h2>
    <p class="descripcion-reporte">
      Muestra, por competencia, las horas programadas frente a las horas de diseño curricular y el porcentaje de ejecución. 
      Resalta las competencias que superan el diseño e incluye un cronograma Gantt con los meses de programación. 
      Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar rápidamente la información.
    </p>

    <!-- Nota sobre competencias que superan el diseño -->
    <p id="notaCompetenciasHoras"
       style="display:none; font-size:0.9rem; color:#7f1d1d; margin:4px 0 8px 0;">
      Las competencias resaltadas en rojo es porque superaron la cantidad de horas
      establecidas en el diseño curricular, favor no programar más.
    </p>

    <!-- Filtros para Reporte 2 (mismo diseño que Reporte 1) -->
    <div class="filtros-reporte1 filtros-reporte2">
      <!-- Caja de texto para buscar -->
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaReporte2"
          placeholder="Buscar competencia..."
        />
      </div>

      <!-- Chips / checkboxes de categorías -->
      <div class="filtros-categorias-reporte1">
        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte2"
            data-cat="Transversales"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Transversales</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte2"
            data-cat="Técnicas"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Técnicas</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte2"
            data-cat="Inglés"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Inglés</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte2"
            data-cat="Práctica"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Práctica</span>
          </span>
        </label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Competencia</th>
          <th>Total de Horas</th>
          <th>Horas Diseño</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody id="tbodyReporte2"></tbody>
      <tfoot id="tfootReporte2"></tfoot>
    </table>

    <!-- Gráfica -->
    <h3>% Competencias con Horas (Total vs Diseño)</h3>

    <div class="chart-container">
      <div id="chartCompetenciasHorasContainer" style="width: 100%;"></div>
    </div>

    <!-- Gantt en contenedor independiente -->
    <div id="contenedorGanttCompetencias">
  <h3 id="tituloGanttCompetencias">Cronograma Gantt de Competencias</h3>

  <!-- Filtros para el Gantt de Competencias -->
  <div class="filtros-reporte1 filtros-gantt-competencias">
    <!-- Caja de texto para buscar -->
    <div class="filtro-busqueda-reporte1">
      <span class="filtro-busqueda-icono">🔍</span>
      <input
        type="text"
        id="busquedaGanttCompetencias"
        placeholder="Buscar competencia, instructor o ficha."
      />
    </div>

    <!-- Chips / checkboxes de categorías -->
    <div class="filtros-categorias-reporte1">
      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-gantt"
          data-cat="Transversales"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Transversales</span>
        </span>
      </label>

      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-gantt"
          data-cat="Técnicas"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Técnicas</span>
        </span>
      </label>

      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-gantt"
          data-cat="Inglés"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Inglés</span>
        </span>
      </label>

      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-gantt"
          data-cat="Práctica"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Práctica</span>
        </span>
      </label>
    </div>
  </div>

  <div id="ganttContainer"></div>
</div>


  </div>
</div>

 <!-- TAB 3 -->
<div id="tab3" class="tab-content">
  <div id="reporte3">
    <h2>Listado de Instructores (Total de Horas Programadas)</h2>
    <p class="descripcion-reporte">
      Lista todos los instructores del programa con el total de horas programadas y un gráfico de barras que resume la distribución de la carga. 
      Permite detectar sobrecargas o brechas de asignación. 
      Cuenta con barra de búsqueda y filtros por instructor, ficha y tipo de competencia.
    </p>
    <!-- Barra de búsqueda para el listado de instructores -->
    <div class="filtros-reporte1">
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaInstructoresHoras"
          placeholder="Buscar instructor..."
        />
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre Instructor</th>
          <th>Apellido Instructor</th>
          <th>Total Horas</th>
        </tr>
      </thead>
      <tbody id="tbodyReporte3"></tbody>
      <tfoot id="tfootReporte3"></tfoot>
    </table>

  <!-- Contenedor del gráfico, ocupando el 100% del TAB -->
<div class="chart-container">
  <h3 style="margin: 0 0 12px 0;">
    Total de Horas Programadas por Instructor
  </h3>
    <div id="chartInstructoresHorasContainer" style="width: 100%;"></div>
</div>
</div>



        <!-- Listado de Instructores con aprendices pendientes por emitir Juicio -->
    <h3 id="tituloListadoPendientesR8" style="margin-top: 8px;">
      Listado de Instructores Aprendices pendientes por emitir Juicio
    </h3>

    <!-- Barra de búsqueda para pendientes por emitir juicio -->
    <div class="filtros-reporte1">
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaPendientesJuicio"
          placeholder="Buscar instructor, competencia o aprendiz..."
        />
      </div>
    </div>

    <table id="tablaPendientesInstructorReporte8">
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre instructor o instructores programados</th>
          <th>Competencia</th>
          <th>Nombre aprendices</th>
          <th>Cantidad de Aprendices</th>
        </tr>
      </thead>
      <tbody id="tbodyPendientesInstructorReporte8"></tbody>
    </table>
</div>
<!-- TAB 4 -->
    <div id="tab4" class="tab-content">
  <div id="reporte4">
    <h2>Competencias del Programa (Programada: Sí/No)</h2>
    <p class="descripcion-reporte">
      Muestra todas las competencias del programa indicando si están programadas o no (Sí/No), integrando la lógica de programación, diseño y asignación a instructores. 
      Permite visualizar en conjunto la cobertura del plan de estudios y su programación en el tiempo mediante el cronograma Gantt. 
      Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar rápidamente la información.

En caso que la competencia APLICAR PRÁCTICAS  DE PROTECCIÓN AMBIENTAL, SEGURIDAD Y SALUD EN EL TRABAJO DE ACUERDO CON LAS POLÍTICAS ORGANIZACIONALES  Y LA NORMATIVIDAD VIGENTE. se evidencia con 24 horas o menos aparecera con 1/2 lo cual significa que falta programar la competencia de  DE PROTECCIÓN AMBIENTAL o SEGURIDAD Y SALUD EN EL TRABAJO 
    </p> 
    <!-- Filtros para Reporte 4 (mismo diseño verde) -->
    <div class="filtros-reporte1 filtros-reporte4">
      <!-- Caja de texto para buscar -->
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaReporte4"
          placeholder="Buscar competencia..."
        />
      </div>

      <!-- Chips / checkboxes de categorías -->
      <div class="filtros-categorias-reporte1">
        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte4"
            data-cat="Transversales"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Transversales</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte4"
            data-cat="Técnicas"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Técnicas</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte4"
            data-cat="Inglés"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Inglés</span>
          </span>
        </label>

        <label class="chip-reporte1">
          <input
            type="checkbox"
            class="chk-cat-reporte4"
            data-cat="Práctica"
            checked
          />
          <span class="chip-reporte1-inner">
            <span class="chip-check">✔</span>
            <span class="chip-text">Práctica</span>
          </span>
        </label>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Competencia</th>
          <th>Programada</th>
        </tr>
      </thead>
      <tbody id="tbodyReporte4"></tbody>
    </table>

    <h3>Cronograma Gantt de Competencias (Pendientes)</h3>
    <div id="ganttContainerPendientes"></div>
  </div>
</div>


<!-- TAB 5 -->
    <div id="tab5" class="tab-content">
      <div id="reporte5">
        <h2>
          Raps por evaluar
          <span class="help-icon" data-tooltip="Programadas / Pendientes por competencia">?</span>
        </h2>
        <p class="descripcion-reporte">
          Presenta los resultados de aprendizaje (RAPs) pendientes de evaluación, diferenciando entre competencias ya programadas y competencias aún no vistas. 
          Permite identificar rápidamente qué RAPs, competencias y aprendices requieren registro de juicios evaluativos. 
          Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar rápidamente la información.
        </p>
        <h3>Competencias ya programadas</h3>

<!-- Filtros para Competencias ya programadas (mismo diseño verde) -->
<div class="filtros-reporte1 filtros-reporte5-programadas">
  <!-- Caja de texto para buscar -->
  <div class="filtro-busqueda-reporte1">
    <span class="filtro-busqueda-icono">🔍</span>
    <input
      type="text"
      id="busquedaProgramadas"
      placeholder="Buscar competencia, RAP o aprendiz."
    />
  </div>

  <!-- Chips / checkboxes de categorías -->
  <div class="filtros-categorias-reporte1">
    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-programadas"
        data-cat="Transversales"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Transversales</span>
      </span>
    </label>

    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-programadas"
        data-cat="Técnicas"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Técnicas</span>
      </span>
    </label>

    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-programadas"
        data-cat="Inglés"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Inglés</span>
      </span>
    </label>

    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-programadas"
        data-cat="Práctica"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Práctica</span>
      </span>
    </label>
  </div>
</div>

<table id="tablaProgramadas">
  <thead>
    <tr>
      <th>#</th>
      <th>Competencia</th>
      <th>RAP</th>
      <th>Aprendices</th>
      <th>Cantidad de Aprendices</th>
    </tr>
  </thead>
  <tbody id="tbodyProgramadas"></tbody>
</table>

        <h3>Competencias Pendientes Por programar (Aún no vistas)</h3>

<!-- Filtros para Competencias Pendientes (mismo diseño verde) -->
<div class="filtros-reporte1 filtros-reporte5-pendientes">
  <!-- Caja de texto para buscar -->
  <div class="filtro-busqueda-reporte1">
    <span class="filtro-busqueda-icono">🔍</span>
    <input
      type="text"
      id="busquedaPendientes"
      placeholder="Buscar competencia, RAP o aprendiz."
    />
  </div>

  <!-- Chips / checkboxes de categorías -->
  <div class="filtros-categorias-reporte1">
    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-pendientes"
        data-cat="Transversales"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Transversales</span>
      </span>
    </label>

    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-pendientes"
        data-cat="Técnicas"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Técnicas</span>
      </span>
    </label>

    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-pendientes"
        data-cat="Inglés"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Inglés</span>
      </span>
    </label>

    <label class="chip-reporte1">
      <input
        type="checkbox"
        class="chk-cat-pendientes"
        data-cat="Práctica"
        checked
      />
      <span class="chip-reporte1-inner">
        <span class="chip-check">✔</span>
        <span class="chip-text">Práctica</span>
      </span>
    </label>
  </div>
</div>

<table id="tablaPendientes">
  <thead>
    <tr>
      <th>#</th>
      <th>Competencia</th>
      <th>RAP</th>
      <th>Aprendices</th>
      <th>Cantidad de Aprendices</th>
    </tr>
  </thead>
  <tbody id="tbodyPendientes"></tbody>
</table>

      </div>
    </div>
<!-- TAB 6 -->
    <div id="tab6" class="tab-content">
      <div id="reporte6">
 <h2>Raps Aprobados - Por evaluar y  No aprobados</h2>
  <p class="descripcion-reporte">
    Resume el estado de los RAPs por competencia (Aprobado, Por evaluar, No aprobado) e incluye el nombre del funcionario o instructor que registró la evaluación. 

En caso de que la fila se resalte de amarillo es debido a que la evaluo un instructor que no esta asociado a la competencia y requiere seguimiento del coordinador

    Facilita el seguimiento del avance de evaluación por competencia y la trazabilidad de quién evaluó. 
    Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar rápidamente la información.
  </p>

  <!-- Filtros para Reporte 6 (mismo diseño que Reporte 1) -->
  <div class="filtros-reporte1 filtros-reporte6">
    <!-- Caja de texto para buscar -->
    <div class="filtro-busqueda-reporte1">
      <span class="filtro-busqueda-icono">🔍</span>
      <input
        type="text"
        id="busquedaReporte6"
        placeholder="Buscar competencia, RAP o funcionario..."
      />
    </div>

    <!-- Chips / checkboxes de categorías -->
    <div class="filtros-categorias-reporte1">
      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-reporte6"
          data-cat="Transversales"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Transversales</span>
        </span>
      </label>

      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-reporte6"
          data-cat="Técnicas"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Técnicas</span>
        </span>
      </label>

      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-reporte6"
          data-cat="Inglés"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Inglés</span>
        </span>
      </label>

      <label class="chip-reporte1">
        <input
          type="checkbox"
          class="chk-cat-reporte6"
          data-cat="Práctica"
          checked
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Práctica</span>
        </span>
      </label>
      <label class="chip-reporte1">
        <input
          type="checkbox"
          id="chkSoloRapsOtro"
        />
        <span class="chip-reporte1-inner">
          <span class="chip-check">✔</span>
          <span class="chip-text">Raps Aprobados por otro Instructor</span>
        </span>
      </label>

    </div>
  </div>

  <p id="notaCompetenciasHoras"
     style="display:none; font-size:0.9rem; color:#7f1d1d; margin:4px 0 8px 0;">
    Las filas resaltadas en amarillo son instructores que evaluaron la competencia al aprendiz sin estar programado en la misma.
  </p>

  <table id="tablaReporte6">
    <thead>
      <tr>
        <th>#</th>
        <th>Competencia</th>
        <th>RAP</th>
        <th>Funcionario que evaluó</th>
        <th>APROBADO</th>
        <th>POR EVALUAR</th>
        <th>NO APROBADO</th>
      </tr>
    </thead>
    <tbody id="tbodyReporte6"></tbody>
  </table>
</div>

    </div>
<!-- TAB 7 -->
<div id="tab7" class="tab-content">
  <div id="reporte7">
    <h2>% Avance por Aprendiz</h2>
    <p class="descripcion-reporte">
      Muestra, por aprendiz, el porcentaje de avance global en las competencias e integra el consolidado de inasistencias cuando se carga el archivo de fallas. 
      Permite identificar riesgos académicos combinando avance y fallas. 
      Cuenta con barra de búsqueda y filtros por aprendiz, ficha, rangos de avance y condiciones de riesgo.
    </p>

    <!-- Carga del consolidado de inasistencias -->
    <div id="sectionFallas" style="margin: 10px 0 15px 0;">
      <label for="excelFallas" style="font-weight: 500; display:block; margin-bottom:6px;">
        Cargar consolidado de inasistencias (XLS/XLSX)
      </label>
      <p class="nota-archivo"><em>Obtener en Sofia Plus: Rol (Gestion de Desarrollo Curricular) › Gestion de Tiempos › Consultar consolidado de tiempos › Consolidado Inasistencias por Ficha</em></p>
      <input type="file" id="excelFallas" accept=".xls,xlsx" />
      <button id="btnProcesarFallas" class="btnEstilo" style="margin-left:10px;">
        Cargar reporte de fallas
      </button>
      <div id="mensajeFallas" class="mensaje-archivo" style="display:none; margin-top:10px;"></div>
    </div>

    <!-- Barra de búsqueda para % Avance por Aprendiz -->
    <div class="filtros-reporte1">
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaAvanceAprendiz"
          placeholder="Buscar por documento, nombre o estado."
        />
      </div>
    </div>

    <table>
      <thead>
        <tr style="background-color: #f3f4f6;">
          <th>#</th>
          <th>Documento</th>
          <th>Nombre del Aprendiz</th>
          <th>Fallas</th>
          <th>Detalles</th>
          <th>Aprobado</th>
          <th>Por Evaluar</th>
          <th>% Avance</th>
        </tr>
      </thead>

      <tbody id="pivotAvanceContainer"></tbody>
    </table>

    <!-- Gráfica de fallas para el reporte 7 (se llena al cargar fallas) -->
    <div id="graficoFallasReporte7Container" class="tabla-acta-wrap" style="display:none; text-align:center; margin-top:12px; height:320px;"></div>
  </div>
</div>
<!-- TAB 8 -->
    <div id="tab8" class="tab-content">
      <div id="reporte8">
     <h2>
          Competencias Pendientes por Aprendiz e Instructor
          <span class="help-icon" data-tooltip="Pendientes por aprendiz para etapa práctica, solo competencias programadas">?</span>
        </h2>
        <p class="descripcion-reporte">
          Lista los aprendices que tienen competencias pendientes por evaluar, especialmente la competencia 
          “RESULTADOS DE APRENDIZAJE ETAPA PRÁCTICA”. 
          Desde este reporte se puede generar y descargar el Paz y Salvo académico para quienes ya finalizaron todas las competencias lectivas 
          y solo tienen pendiente la competencia de etapa práctica, como soporte para iniciar la etapa productiva. 
          Agrupa por aprendiz las competencias pendientes y los instructores involucrados, y cuenta con barra de búsqueda y filtros por aprendiz, competencia, estado y elegibilidad para Paz y Salvo.
        </p>

   

      <!-- Barra de búsqueda para Competencias Pendientes por Aprendiz e Instructor -->
    <div class="filtros-reporte1">
      <div class="filtro-busqueda-reporte1">
        <span class="filtro-busqueda-icono">🔍</span>
        <input
          type="text"
          id="busquedaPendientesAprendiz"
          placeholder="Buscar documento, aprendiz, competencia o instructor."
        />
      </div>
    </div>
<!-- Contenedor de las tablas visibles (una por aprendiz) -->
    <div id="contenedorTablasReporte8"></div>

          </div>
    <!-- Tabla RESUMEN (visible) la llenamos por JS dentro de este contenedor -->
    <div id="contenedorResumenPracticaReporte8"></div>


        <!-- Tabla OCULTA solo para exportar a Excel -->
        <table id="tablaReporte8Export" style="display:none; font-size:10px; border-collapse:collapse;">
  <thead>
    <tr>
      <th>#</th>
      <th>Documento</th>
      <th>Nombre del Aprendiz</th>
      <th>Competencias Pendientes por Evaluar</th>
      <th>Instructor que impartió la competencia</th>
    </tr>
  </thead>
  <tbody id="tbodyReporte8"></tbody>
</table>

    <!-- Tabla RESUMEN (visible) la llenamos por JS dentro de este contenedor -->
    <div id="contenedorResumenPracticaReporte8"></div>


        



           
    </div>


  </div>


</div>


<div id="export-section" class="contenedor export-section" style="display: none;">
  <!-- Cabecera del acordeón Centro de Reportes -->
  <button type="button" id="accordionCentroToggle" class="acordeon-header">
    <span>📊 Centro de Reportes</span>
    <span id="accordionCentroIcon" class="acordeon-icon">▾</span>
  </button>

  <!-- Cuerpo del acordeón Centro de Reportes -->
  <div id="accordionCentroBody" class="acordeon-body">
    <!-- Encabezado del centro de reportes -->
    <div class="export-header">
      <div class="export-header-icon">📊</div>
      <div>
        <h2>Centro de Reportes</h2>
        <p>Gestión Académica e Instructores</p>
      </div>
    </div>

    <div class="export-body">
      <!-- Columna izquierda: selección de reportes -->
      <div class="export-left">
        <div class="export-left-header">
          <div>
            <h3>Selecciona reportes para exportar</h3>
            <p>Elige los datos que necesitas descargar hoy.</p>
          </div>
        </div>

        <div id="seleccionReportes" class="lista-reportes">
          <label><input type="checkbox" class="reporte-checkbox" value="reporte1" checked> Reporte 1: Instructores y Competencias</label>
          <label><input type="checkbox" class="reporte-checkbox" value="reporte2" checked> Reporte 2: Resumen de Competencias con Horas</label>
          
          <label><input type="checkbox" class="reporte-checkbox" value="reporte4" checked> Reporte 3: Competencias Programadas</label>
          <label><input type="checkbox" class="reporte-checkbox" value="reporte5" checked> Reporte 4: Raps por evaluar de Competencias programadas y no</label>
          <label><input type="checkbox" class="reporte-checkbox" value="reporte6" checked> Reporte 5: Raps Aprobados - Por evaluar y No aprobados</label>
          <label><input type="checkbox" class="reporte-checkbox" value="reporte7" checked> Reporte 6: Avance por Aprendiz y fallas</label>
          <label><input type="checkbox" class="reporte-checkbox" value="reporte8" checked> Reporte 7: Competencias Pendientes por Aprendiz e Instructor</label>
          <label><input type="checkbox" class="reporte-checkbox" value="reporte3" checked> Reporte 8: Instructores por Horas</label>
        </div>
      </div>

      <!-- Columna derecha: acciones de exportación -->
      <div class="export-right">
        <h3>Acciones de Exportación</h3>

        <button id="btnExportarPDF" class="btnExportarPDF export-card">
          <div class="export-card-icon pdf">📄</div>
          <div class="export-card-text">
            <strong>Exportar a PDF</strong>
            <span>Formato listo para imprimir</span>
          </div>
          <span class="export-card-arrow">›</span>
        </button>

        <button id="btnExportarExcel" class="btnExportarExcel export-card">
          <div class="export-card-icon excel">📊</div>
          <div class="export-card-text">
            <strong>Exportar a Excel</strong>
            <span>Datos listos para análisis</span>
          </div>
          <span class="export-card-arrow">›</span>
        </button>

        <button id="btnExportarWord" class="btnExportarWord export-card">
          <div class="export-card-icon word">📝</div>
          <div class="export-card-text">
            <strong>Exportar a Word</strong>
            <span>Formato editable para informes</span>
          </div>
          <span class="export-card-arrow">›</span>
        </button>
<!-- NUEVO botón: Acta Comité -->
  <button id="btnActaComite" class="btnExportarWord export-card">
    <div class="export-card-icon word">📑</div>
    <div class="export-card-text">
      <strong>Acta Comité</strong>
      <span>Plantilla en Word del comité</span>
    </div>
    <span class="export-card-arrow">›</span>
  </button>
      </div>
    </div>
  </div>
</div>


  <footer class="footer-disenador">
  <div class="footer-disenador-title">
    DISEÑO Y DESARROLLO
  </div>

  <div class="footer-disenador-card">
    <div class="footer-disenador-avatar">✕</div>

    <div class="footer-disenador-info">
      <span class="footer-disenador-label">Instructor Diseñador</span>
      <span class="footer-disenador-name">Yeison Castellanos Gordillo</span>
    </div>

    <div class="footer-disenador-settings">⚙</div>
  </div>
</footer>


  <!-- Incluir script AL FINAL -->
  <script>
    // Variable global para guardar el coordinador seleccionado
    let coordinadorAcademicoSeleccionado = "";
    let validarRolesActivos = true;
// =========================
    // Funciones de Utilidad y Normalización
    // =========================
    function normalizeCompetencia(competencia) {
      if (!competencia) return "";
      let comp = competencia.toString().trim();

      // Quitar código numérico inicial tipo "12345 - "
      comp = comp.replace(/^[0-9]+\s*-\s*/, "");

      // Quitar tildes y normalizar espacios
      comp = comp
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // sin tildes
        .toUpperCase()
        .replace(/\s+/g, " "); // un solo espacio entre palabras

      return comp;
    }

    // Captura un gráfico CanvasJS (varios canvas) como imagen base64
    function capturarGraficoComoImg(selector) {
      const wrapper = document.querySelector(selector);
      if (!wrapper) return null;

      const canvases = wrapper.querySelectorAll("canvas");
      if (!canvases.length) return null;

      const output = document.createElement("canvas");
      output.width = canvases[0].width;
      output.height = canvases[0].height;
      const ctx = output.getContext("2d");

      canvases.forEach((canvas) => {
        try {
          ctx.drawImage(canvas, 0, 0, output.width, output.height);
        } catch (err) {
          console.warn("No se pudo capturar el canvas del grafico", err);
        }
      });

      return output.toDataURL("image/png");
    }

    // Genera el bloque HTML de un gráfico con tamaño estándar para el acta (12x10 cm y centrado)
    function construirGraficoActaHTML(dataURL, alt, fallbackMsg) {
      if (!dataURL) return fallbackMsg || "<em>(No se pudo capturar el grafico al momento de generar el acta.)</em>";
      const altText = alt || "Gráfico";
      return `<div class="tabla-acta-wrap" style="text-align:center; margin:8px auto 10px;">
        <img src="${dataURL}" alt="${altText}" style="width:12cm; height:15cm; display:block; margin:0 auto; border:1px solid #d1d5db; padding:4px; box-sizing:border-box; object-fit:contain;">
      </div>`;
    }

    // Genera un gráfico de barras horizontal con aprendices que tengan fallas (>0)
    function generarGraficoFallasAprendices(datos) {
      if (!Array.isArray(datos) || !datos.length) return null;

      const width = 1000;
      const filas = datos.map((d) => {
        const nombre = (d.nombre || "").trim() || "Aprendiz";
        const doc = (d.doc || "").trim();
        const etiqueta = doc ? `${nombre} (${doc})` : nombre;
        return { ...d, etiqueta };
      });

      const canvas = document.createElement("canvas");
      canvas.width = width;
      const ctx = canvas.getContext("2d");

      ctx.font = "13px Arial";
      const maxEtiqueta = Math.max(...filas.map(f => ctx.measureText(f.etiqueta).width), 0);
      const marginLeft = Math.min(620, Math.max(260, Math.ceil(maxEtiqueta + 40)));
      const margin = { top: 36, right: 80, bottom: 40, left: marginLeft };

      const height = Math.max(260, filas.length * 60 + margin.top + margin.bottom);
      canvas.height = height;

      // Fondo blanco
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, width, height);

      const chartWidth = width - margin.left - margin.right;
      const barHeight = 28;
      const gap = 20;
      const maxFallas = Math.max(...filas.map(d => d.fallas), 1);

      // Título
      ctx.fillStyle = "#111827";
      ctx.font = "bold 20px Arial";
      ctx.textAlign = "left";
      ctx.fillText("Aprendices con fallas", margin.left, 24);

      ctx.font = "13px Arial";
      ctx.fillStyle = "#374151";
      ctx.fillText("Fallas registradas (solo se muestran aprendices con al menos 1 falla)", margin.left, 44);

      filas.forEach((item, idx) => {
        const y = margin.top + idx * (barHeight + gap);
        const x = margin.left;
        const barW = (item.fallas / maxFallas) * chartWidth;

        // Banda de fondo
        ctx.fillStyle = "#e5e7eb";
        ctx.fillRect(x, y, chartWidth, barHeight);

        // Barra principal
        ctx.fillStyle = "#16a34a";
        ctx.fillRect(x, y, barW, barHeight);

        // Etiqueta de nombre (izquierda)
        ctx.fillStyle = "#111827";
        ctx.font = "13px Arial";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        ctx.fillText(item.etiqueta, x - 12, y + barHeight / 2);

        // Valor de fallas al final de la barra
        ctx.textAlign = "left";
        ctx.fillStyle = "#0f172a";
        ctx.font = "bold 13px Arial";
        ctx.fillText(`${item.fallas}`, x + barW + 8, y + barHeight / 2);
      });

    return canvas.toDataURL("image/png");
  }

    // Renderiza gráfico de fallas (CanvasJS) en el contenedor del reporte 7
    function renderGraficoFallasReporte7(data) {
      const cont = document.getElementById("graficoFallasReporte7Container");
      if (!cont) return;

      if (!Array.isArray(data) || data.length === 0) {
        cont.style.display = "none";
        cont.innerHTML = "";
        chartFallasReporte7 = null;
        return;
      }

      // Ajustar dimensiones del contenedor para un embudo pequeño y centrado
      cont.style.display = "block";
      cont.style.maxWidth = "400px";
      cont.style.margin = "12px auto";
      cont.style.height = "260px";

      const datosOrdenados = data
        .slice()
        .sort((a, b) => (b.fallas || 0) - (a.fallas || 0))
        .map((item) => ({
          label: item.label,
          y: item.fallas
        }));

      chartFallasReporte7 = new CanvasJS.Chart("graficoFallasReporte7Container", {
        theme: "light2",
        animationEnabled: true,
        exportEnabled: true,
        height: 260,
        title: {
          text: "Aprendices con fallas",
          fontSize: 14,
          fontWeight: "bold",
          horizontalAlign: "left"
        },
        data: [{
          type: "funnel",
          indexLabel: "{label}: {y}",
          indexLabelPlacement: "inside",
          indexLabelFontColor: "#ffffff",
          indexLabelFontSize: 11,
          toolTipContent: "<b>{label}</b>: {y} fallas",
          dataPoints: datosOrdenados
        }]
      });

      chartFallasReporte7.render();
    }

   // Clasificación de competencias por categoría

const competenciasPracticaRaw = [
  "RESULTADOS DE APRENDIZAJE ETAPA PRACTICA"
];

const competenciasInglesRaw = [
  "INTERACTUAR EN LENGUA INGLESA DE FORMA ORAL Y ESCRITA DENTRO DE CONTEXTOS SOCIALES Y LABORALES SEGÚN LOS CRITERIOS ESTABLECIDOS POR EL MARCO COMÚN EUROPEO DE REFERENCIA PARA LAS LENGUAS.",
  "COMPRENDER TEXTOS EN INGLÉS EN FORMA ESCRITA Y AUDITIVA",
  "PRODUCIR TEXTOS EN INGLÉS EN FORMA ESCRITA Y ORAL"
];

const competenciasTransversalesRaw = [
  "APLICACIÓN DE CONOCIMIENTOS DE LAS CIENCIAS NATURALES DE ACUERDO CON SITUACIONES DEL CONTEXTO PRODUCTIVO Y SOCIAL.",
  "APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL, SEGURIDAD Y SALUD EN EL TRABAJO DE ACUERDO CON LAS POLÍTICAS ORGANIZACIONALES Y LA NORMATIVIDAD VIGENTE.",
  "DESARROLLAR PROCESOS DE COMUNICACIÓN EFICACES Y EFECTIVOS, TENIENDO EN CUENTA SITUACIONES DE ORDEN SOCIAL, PERSONAL Y PRODUCTIVO.",
  "Ejercer derechos fundamentales del trabajo en el marco de la constitución política y los convenios internacionales.",
  "Enrique Low Murtra-Interactuar en el contexto productivo y social de acuerdo con principios éticos para la construcción de una cultura de paz.",
  "Fomentar cultura emprendedora según habilidades y competencias personales",
  "GENERAR HÁBITOS SALUDABLES DE VIDA MEDIANTE LA APLICACIÓN DE PROGRAMAS DE ACTIVIDAD FÍSICA EN LOS CONTEXTOS PRODUCTIVOS Y SOCIALES.",
  "Gestionar procesos propios de la cultura emprendedora y empresarial de acuerdo con el perfil personal y los requerimientos de los contextos productivo y social.",
  "Orientar investigación formativa según referentes técnicos",
  "Razonar cuantitativamente frente a situaciones susceptibles de ser abordadas de manera matemática en contextos laborales, sociales y personales.",
  "Resultado de Aprendizaje de la Inducción.",
  "Utilizar herramientas informáticas de acuerdo con las necesidades de manejo de información",
  "PROMOVER LA INTERACCIÓN IDÓNEA CONSIGO MISMO, CON LOS DEMÁS Y CON LA NATURALEZA EN LOS CONTEXTOS LABORAL Y SOCIAL"
];

// Arreglos normalizados para usar en getCategoria
const categoriaPractica       = competenciasPracticaRaw.map(normalizeCompetencia);
const categoriaIngles         = competenciasInglesRaw.map(normalizeCompetencia);
const keywordsTransversales   = competenciasTransversalesRaw.map(normalizeCompetencia);


    function getCategoria(competencia) {
      if(!competencia) return "Técnicas";
      const comp = normalizeCompetencia(competencia);
      if(categoriaPractica.some(k => comp.includes(k))) return "Práctica";
      if(categoriaIngles.some(k => comp.includes(k))) return "Inglés";
      if(keywordsTransversales.some(keyword => comp.includes(keyword))) return "Transversales";
      return "Técnicas";
    }

// ----------------------------------------------
// Competencias para el reporte de Paz y Salvo
// (solo Transversales, Inglés y Técnicas)
// ----------------------------------------------
function obtenerCompetenciasPazYSalvo() {
  const resultado = {
    transversales: [],
    ingles: [],
    tecnicas: []
  };

  const vistos = {
    transversales: new Set(),
    ingles: new Set(),
    tecnicas: new Set()
  };

  // Usamos los registros de juicios (tercer archivo)
  if (!Array.isArray(registrosJuicios) || !registrosJuicios.length) {
    return resultado;
  }

  registrosJuicios.forEach(reg => {
    const competencia = (reg.competencia || "").toString().trim();
    if (!competencia) return;

    // Solo competencias que hacen parte del programa
    if (typeof esCompetenciaProgramada === "function") {
      try {
        if (!esCompetenciaProgramada(competencia)) return;
      } catch (e) {
        // si falla, la dejamos pasar igual
      }
    }

    let categoria = "";
    if (typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competencia);
      } catch (e) {
        categoria = "";
      }
    }

    // No queremos la competencia de etapa práctica como columna
    if (categoria === "Práctica" || !categoria) return;

   const clave = normalizeCompetencia(competencia);


    if (categoria === "Transversales") {
      if (!vistos.transversales.has(clave)) {
        vistos.transversales.add(clave);
        resultado.transversales.push(competencia);
      }
    } else if (categoria === "Inglés") {
      if (!vistos.ingles.has(clave)) {
        vistos.ingles.add(clave);
        resultado.ingles.push(competencia);
      }
    } else if (categoria === "Técnicas") {
      if (!vistos.tecnicas.has(clave)) {
        vistos.tecnicas.add(clave);
        resultado.tecnicas.push(competencia);
      }
    }
  });

  return resultado;
}

// ----------------------------------------------
// Genera la ventana/imprimible del Paz y Salvo
// ----------------------------------------------
function generarPazYSalvoPDF(aprendicesSeleccionados) {
  if (!Array.isArray(aprendicesSeleccionados) || !aprendicesSeleccionados.length) {
    alert("No hay aprendices seleccionados para generar el paz y salvo.");
    return;
  }

  const competencias = obtenerCompetenciasPazYSalvo();
  const trans = competencias.transversales || [];
  const ingl  = competencias.ingles || [];
  const tec   = competencias.tecnicas || [];

  // Datos de encabezado tomados del DOM
  const getText = (id) => {
    const el = document.getElementById(id);
    return el ? (el.textContent || "").trim() : "";
  };

  const codigoFicha      = getText("codigoFicha");
  const nombrePrograma   = getText("nombrePrograma");
  const centroFormacion  = getText("nombreCentro") || "Centro de Comercio y Servicios";
  const fechaIniLectiva  = getText("fechaInicioLectiva");
  const fechaFinLectiva  = getText("fechaFinLectiva");
  const fechaIniProduct  = getText("fechaInicioProductiva");
  const fechaFinProduct  = getText("fechaFinProductiva");
  const gerenteProyecto  = getText("nombreGerentePrincipal");
  const rendimientoAcad  = getText("rendimientoAcademicoResumen");

  const etapaLectivaTexto   = `${fechaIniLectiva} – ${fechaFinLectiva}`;
  const etapaProductivaTexto = `${fechaIniProduct} – ${fechaFinProduct}`;

  const logoUrl = "https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png";

  const win = window.open("", "_blank");

  const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Paz y salvo ficha ${codigoFicha || ""}</title>
<style>
  @page {
    size: landscape;
    margin: 20mm;
  }
  body {
    font-family: Calibri, sans-serif;
    font-size: 8pt;
    margin: 0;
  }
  .encabezado {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .encabezado-izq {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .encabezado-izq img {
    width: 40px;
    height: auto;
  }
  .encabezado-texto {
    font-size: 11pt;
    font-weight: bold;
  }
  .encabezado-der {
    text-align: right;
    font-size: 10pt;
  }
  .sub-encabezado {
    margin-bottom: 6px;
    font-size: 10pt;
  }
  h2 {
    text-align: center;
    margin: 6px 0 8px 0;
    font-size: 11pt;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
  }
  th, td {
    border: 1px solid #000;
    padding: 12px 4px;
    text-align: center;
    vertical-align: middle;
  }
  th.col-firma,
  td.col-firma {
    width: 250px; /* ajusta este valor a lo que necesites */
  }

  th {
    background-color: #f0f0f0;
  }
  /* Ancho de las columnas de competencias */
  .col-competencia {
    width: 10px;   /* ajusta este valor según lo que necesites */
    writing-mode: vertical-rl; /* texto vertical */
    text-orientation: mixed;
    white-space: nowrap;
    padding: 6px 2px;
  }

  .grupo-trans {
    background-color: #ddebf7;
    min-width: 30px
  }
  .grupo-ingles {
    background-color: #e2efda;
    min-width: 30px
  }
  .grupo-tec {
    background-color: #fce4d6;
    min-width: 30px
  }
  .col-nombre {
    text-align: left;
    font-size: 9pt;
    min-width: 200px;
  }
  .col-documento {
    font-size: 9pt;
    min-width: 110px;
  }
  .firmas {
    margin-top: 30px;
    width: 100%;
    text-align: center;
    font-size: 10pt;
  }
  .firmas td {
    border: none;
    padding-top: 25px;
  }
  .firma-linea {
    border-top: 1px solid #000;
    margin-bottom: 4px;
  }
  .nota-oficial {
    margin-top: 8px;
    text-align: center;
    font-size: 9pt;
  }
</style>
</head>
<body>
  <div class="encabezado">
    <div class="encabezado-izq">
      <img src="${logoUrl}" alt="Logo SENA" />
      <div class="encabezado-texto">
        <div>SENA – SERVICIO NACIONAL DE APRENDIZAJE</div>
        <div>${centroFormacion}</div>
      </div>
    </div>
    <div class="encabezado-der">
      <div><strong>FICHA No.:</strong> ${codigoFicha}</div>
      <div><strong>PROGRAMA DE FORMACIÓN:</strong> ${nombrePrograma}</div>
    </div>
  </div>

  <div class="sub-encabezado">
    <strong>PERÍODOS:</strong>
    Etapa Lectiva: ${etapaLectivaTexto}
    &nbsp;&nbsp;
    Etapa Productiva: ${etapaProductivaTexto}
  </div>

  <div class="sub-encabezado">
    <strong>INSTRUCTOR/GERENTE:</strong> ${gerenteProyectoSeleccionado}
    &nbsp;&nbsp;
    <strong>Coordinador Academico:</strong> ${coordinadorAcademicoSeleccionado}
     ${rendimientoAcad}
  </div>

  <div class="nota-oficial">
    Documento oficial de seguimiento y evaluación del aprendiz.
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">#</th>
        <th rowspan="2" class="col-nombre">Nombre Completo del Aprendiz</th>
        <th rowspan="2" class="col-documento">Documento</th>
        ${trans.length ? `<th class="grupo-trans" colspan="${trans.length}">Transversales</th>` : ""}
        ${ingl.length ? `<th class="grupo-ingles" colspan="${ingl.length}">Inglés</th>` : ""}
        ${tec.length ? `<th class="grupo-tec" colspan="${tec.length}">Técnicas</th>` : ""}
                <th rowspan="2" class="col-firma">Firma</th>

      </tr>
            <tr>
        ${trans.map(c => `<th class="grupo-trans col-competencia">${c.length > 30 ? c.substring(0, 20) + "…" : c}</th>`).join("")}
        ${ingl.map(c  => `<th class="grupo-ingles col-competencia">${c.length > 30 ? c.substring(0, 20) + "…" : c}</th>`).join("")}
        ${tec.map(c   => `<th class="grupo-tec col-competencia">${c.length > 30 ? c.substring(0, 20) + "…" : c}</th>`).join("")}
      </tr>

    </thead>
    <tbody>
      ${aprendicesSeleccionados.map((a, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td class="col-nombre">${a.nombreCompleto || ""}</td>
          <td>${a.numDoc || ""}</td>
          ${trans.map(() => "<td>A</td>").join("")}
          ${ingl.map(()  => "<td>A</td>").join("")}
          ${tec.map(()   => "<td>A</td>").join("")}
          <td class="col-firma"></td>
        </tr>
      `).join("")}
    </tbody>
  </table>

  <table class="firmas">
    <tr>
      <td>
        <div class="firma-linea"></div>
        ${gerenteProyectoSeleccionado}<br/>
        Instructor Gerente de Proyecto
      </td>
      <td>
        <div class="firma-linea"></div>
        ${coordinadorAcademicoSeleccionado}<br/>
        Coordinador Académico
      </td>
    </tr>
  </table>

  <div class="nota-oficial">
    Documento generado para fines de control y seguimiento académico.
  </div>
</body>
</html>
`;

  win.document.open();
  win.document.write(html);
  win.document.close();
  win.focus();
  win.print(); // desde aquí el usuario puede guardar como PDF
}

    function parseFecha(fechaString) {
      const partes = fechaString.split('/');
      const dia = parseInt(partes[0], 10);
      const mes = parseInt(partes[1], 10) - 1;
      const anio = parseInt(partes[2], 10);
      return new Date(anio, mes, dia);
    }

    function formatearFechaLarga(fecha) {
      const dia = fecha.getDate();
      const anio = fecha.getFullYear();
      const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio",
                     "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
      const mes = meses[fecha.getMonth()];
      return `${dia} de ${mes} de ${anio}`;
    }

    // Fin etapa lectiva = fin programa - 6 meses - 1 día
    function calcularFechaFinLectiva(fechaFinLectivaStr) {
      let fechaFinPrograma = parseFecha(fechaFinLectivaStr);
      fechaFinPrograma.setMonth(fechaFinPrograma.getMonth() - 6);
      fechaFinPrograma.setDate(fechaFinPrograma.getDate() - 1);
      return fechaFinPrograma;
    }

    // Inicio etapa productiva = fin programa - 6 meses
    function calcularFechaInicioProductiva(fechaFinLectivaStr) {
      let fechaFinPrograma = parseFecha(fechaFinLectivaStr);
      fechaFinPrograma.setMonth(fechaFinPrograma.getMonth() - 6);
      return fechaFinPrograma;
    }

    // Fin etapa productiva = fin programa (la fecha original)
    function calcularFechaFinProductiva(fechaFinLectivaStr) {
      return parseFecha(fechaFinLectivaStr);
    }

    function formatearFechaCorta(fecha) {
      if (!(fecha instanceof Date) || isNaN(fecha)) return "";
      return fecha
        .toLocaleDateString("es-CO", { day: "2-digit", month: "short", year: "numeric" })
        .replace(".", "");
    }

    function formatearTiempoRestante(desde, hasta) {
      const hoyBase = (desde instanceof Date && !isNaN(desde)) ? desde : new Date();
      if (!(hasta instanceof Date) || isNaN(hasta)) return "-";

      const inicio = new Date(hoyBase.getFullYear(), hoyBase.getMonth(), hoyBase.getDate());
      const fin = new Date(hasta.getFullYear(), hasta.getMonth(), hasta.getDate());

      if (inicio > fin) return "0 días";

      let years = fin.getFullYear() - inicio.getFullYear();
      let months = fin.getMonth() - inicio.getMonth();
      let days = fin.getDate() - inicio.getDate();

      if (days < 0) {
        months -= 1;
        const prevMonthDays = new Date(fin.getFullYear(), fin.getMonth(), 0).getDate();
        days += prevMonthDays;
      }
      if (months < 0) {
        years -= 1;
        months += 12;
      }

      const partes = [];
      if (years > 0) partes.push(`${years} año${years !== 1 ? "s" : ""}`);
      if (months > 0) partes.push(`${months} mes${months !== 1 ? "es" : ""}`);
      partes.push(`${days} día${days !== 1 ? "s" : ""}`);

      return partes.join(" ");
    }

    function renderLineaTiempoFicha() {
      const timelines = [];

      const mini = {
        track: document.getElementById("timelineTrackMini"),
        fill: document.getElementById("timelineFillMini"),
        puntos: {
          inicioLectiva: document.getElementById("pMiniInicioLectiva"),
          finLectiva: document.getElementById("pMiniFinLectiva"),
          inicioProd: document.getElementById("pMiniInicioProd"),
          finProd: document.getElementById("pMiniFinProd"),
          hoy: document.getElementById("pMiniHoy"),
        },
        labels: {
          inicioLectiva: document.getElementById("dMiniInicioLectiva"),
          finLectiva: document.getElementById("dMiniFinLectiva"),
          inicioProd: document.getElementById("dMiniInicioProd"),
          finProd: document.getElementById("dMiniFinProd"),
          hoy: document.getElementById("dMiniHoy"),
        },
        estado: document.getElementById("estadoEtapaMini"),
      };

      if (mini.track) timelines.push(mini);
      if (!timelines.length) return;

      const fechas = {
        inicioLectiva: fechaInicioLectivaGlobal,
        finLectiva: fechaFinLectivaGlobal,
        inicioProd: fechaInicioProductivaGlobal,
        finProd: fechaFinProductivaGlobal,
      };

      const faltaFecha =
        !fechas.inicioLectiva || !fechas.finLectiva || !fechas.inicioProd || !fechas.finProd;

      const hoy = new Date();
      const hoyPlano = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
      const tiempoLectivaEl = document.getElementById("tiempoRestanteLectiva");
      const tiempoProductivaEl = document.getElementById("tiempoRestanteProductiva");

      const inicioRango =
        fechas.inicioLectiva instanceof Date && !isNaN(fechas.inicioLectiva)
          ? fechas.inicioLectiva.getTime()
          : NaN;
      const finRango =
        fechas.finProd instanceof Date && !isNaN(fechas.finProd)
          ? fechas.finProd.getTime()
          : NaN;

      if (isNaN(inicioRango) || isNaN(finRango) || finRango <= inicioRango || faltaFecha) {
        timelines.forEach((t) => {
          if (t.estado) t.estado.textContent = "-";
        });
        if (tiempoLectivaEl) tiempoLectivaEl.textContent = "-";
        if (tiempoProductivaEl) tiempoProductivaEl.textContent = "-";
        return;
      }

      const rango = finRango - inicioRango;
      const clamp = (val) => Math.min(100, Math.max(0, val));
      const posicion = (fecha) => clamp(((fecha.getTime() - inicioRango) / rango) * 100);

      const estadoTexto = (() => {
        const hoyMs = hoyPlano.getTime();
        if (hoyMs < inicioRango) return "Sin iniciar";
        if (fechas.finLectiva && hoyMs <= fechas.finLectiva.getTime()) return "Etapa lectiva en progreso";
        if (fechas.inicioProd && hoyMs < fechas.inicioProd.getTime()) return "Transicion";
        if (fechas.finProd && hoyMs <= fechas.finProd.getTime()) return "Etapa productiva en progreso";
        return "Programa finalizado";
      })();

      const setTiempoRestante = (el, fechaObjetivo) => {
        if (!el) return;
        el.textContent = formatearTiempoRestante(hoyPlano, fechaObjetivo);
      };

      setTiempoRestante(tiempoLectivaEl, fechas.finLectiva);
      setTiempoRestante(tiempoProductivaEl, fechas.finProd);

      timelines.forEach((t) => {
        if (t.estado) t.estado.textContent = estadoTexto;

        const aplicarPunto = (clave, fecha) => {
          const punto = t.puntos[clave];
          const label = t.labels[clave];
          if (!punto || !(fecha instanceof Date) || isNaN(fecha)) return;

          const pos = posicion(fecha);
          punto.style.left = `${pos}%`;
          punto.classList.remove("past", "future", "today");

          if (clave === "hoy") {
            punto.classList.add("today");
          } else if (fecha.getTime() <= hoyPlano.getTime()) {
            punto.classList.add("past");
          } else {
            punto.classList.add("future");
          }

          if (label) label.textContent = formatearFechaCorta(fecha);
        };

        aplicarPunto("inicioLectiva", fechas.inicioLectiva);
        aplicarPunto("finLectiva", fechas.finLectiva);
        aplicarPunto("inicioProd", fechas.inicioProd);
        aplicarPunto("finProd", fechas.finProd);
        aplicarPunto("hoy", hoyPlano);

        const posHoy = posicion(hoyPlano);
        if (t.puntos.hoy) {
          t.puntos.hoy.style.left = `${posHoy}%`;
        }
        if (t.fill) {
          t.fill.style.width = `${posHoy}%`;
        }
      });
    }


    // Normaliza un documento/identificación dejando solo dígitos
    function normalizarDocumento(valor) {
      if (valor === undefined || valor === null) return "";
      return String(valor).replace(/\D/g, "");
    }

// Color por estado (para tabla y gráfica)
function getColorEstado(estado) {
  const e = (estado || "").toUpperCase().trim();

  if (e === "EN FORMACION" || e === "EN FORMACIÓN") {
    return "#166534"; // verde oscuro
  }
  if (e === "CONDICIONADO") {
    return "#eab308"; // amarillo
  }
  if (e === "CANCELADO" || e === "CANCELADOS") {
    return "#6b7280"; // gris
  }
  if (e === "RETIRO VOLUNTARIO") {
    return "#b91c1c"; // rojo oscuro
  }
  // Otros estados: azul
  return "#2563eb";
}

  
        // =========================
    // Variables globales
    // =========================
    let codigoFichaPrimero = "";
    // NUEVO: Variable para guardar el nivel de formación
    let nivelFormacionGlobal = "";
    let codigoProgramaGlobal = "";
    let totalCompetenciasPrograma = 0; // total de competencias del programa (archivo 3)
    let modalidadFormacionGlobal = "";   // NUEVO: Modalidad de Formación desde C10
    let competenciasMap = {};
    let competenciasSet = new Set();
    let competenciasSetNormalizado = new Set();

   
let registrosGlobal = [];
let registrosJuicios = [];
let gruposProgramadas = {};
let gruposPendientes = {};
let chartHorasInstructores = null;   // Gráfico de horas por instructor
let chartCompetenciasHoras = null;   // Gráfico 100% Total vs Diseño
let chartFallasReporte7 = null;      // Gráfico de fallas por aprendiz (reporte 7)
let estadoChart = null;              // Gráfico Distribución de Estados


// Gerente de Proyecto / Instructor con más horas
// Variables para Gerente de Proyecto / Instructor con más horas cargadas
let gerenteProyectoSeleccionado = "";
let instructorMasHorasGlobal    = "";
let listaInstructoresGlobal     = [];
// Aprendiz vocero del grupo
let aprendizVoceroSeleccionado = "";

// Datos usados para el resumen de la ficha
let datosGeneralFicha = [];   // Información general de aprendices (estado)
let datosHorario      = [];   // Programación de instructores (horas, competencias)



    // Mapa: documento del aprendiz (solo dígitos) -> número de fallas (inasistencias)
    let mapaFallasPorDocumento = {};

    // Variables globales para fechas
    let fechaInicioLectivaGlobal = null;
    let fechaFinLectivaGlobal = null;
    let fechaInicioProductivaGlobal = null;
    let fechaFinProductivaGlobal = null;


    // =========================
    // Procesar Primer Archivo (Instructores)
    // =========================
   document.getElementById('btnProcesar1').addEventListener('click', function() {
  const file = document.getElementById('excelFile1').files[0];
  const mensaje1 = document.getElementById('mensajeArchivo1');

  if (!file) {
    alert("Por favor, selecciona un Archivo de Instructores.");
    return;
  }

  const reader = new FileReader();

  // Inicio: 0 %
  if (mensaje1) {
    mensaje1.textContent = "Cargando archivo 1... 0%";
  }

  // Progreso de lectura
  reader.onprogress = function (e) {
    if (!mensaje1) return;

    if (e.lengthComputable) {
      const porcentaje = Math.round((e.loaded / e.total) * 100);
      mensaje1.textContent = `Cargando archivo 1... ${porcentaje}%`;
    } else {
      // Si el navegador no reporta tamaño total
      mensaje1.textContent = "Cargando archivo 1...";
    }
  };

  // Lectura finalizada
  reader.onload = function(event) {
    const data = new Uint8Array(event.target.result);

    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[sheetName];
    const cantidad1 = procesarPrimerArchivo(ws);

    if (mensaje1) {
      mensaje1.textContent = `Archivo 1: ${cantidad1} registros cargados (100%)`;
    }

    // Mostrar SOLO el paso 2 (como flex para respetar el layout)
    document.getElementById("sectionFile2").style.display = "flex";
    // NO mostramos aún headerInfo ni reportes
  };

  reader.readAsArrayBuffer(file);
});


    // =========================
    // Procesar Segundo Archivo (Juicios Evaluativos)
    // =========================
   document.getElementById('btnProcesar2').addEventListener('click', function() {
  const file = document.getElementById('excelFile2').files[0];
  const mensaje2 = document.getElementById('mensajeArchivo2');

  if (!file) {
    alert("Por favor, selecciona un Archivo de Juicios Evaluativos.");
    return;
  }

  const reader = new FileReader();

  // Inicio: 0 %
  if (mensaje2) {
    mensaje2.textContent = "Cargando archivo 2... 0%";
  }

  // Progreso de lectura
  reader.onprogress = function (e) {
    if (!mensaje2) return;

    if (e.lengthComputable) {
      const porcentaje = Math.round((e.loaded / e.total) * 100);
      mensaje2.textContent = `Cargando archivo 2... ${porcentaje}%`;
    } else {
      mensaje2.textContent = "Cargando archivo 2...";
    }
  };

  // Lectura finalizada
  reader.onload = function(event) {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[sheetName];
    const cantidad2 = procesarSegundoArchivo(ws);

actualizarResumenFicha();


    if (typeof cantidad2 === "number") {
      if (mensaje2) {
        mensaje2.textContent = `Archivo 2: ${cantidad2} registros cargados (100%)`;
      }
      // Mostrar paso 3 (como flex)
      document.getElementById("sectionFile3").style.display = "flex";
    }
    // Si procesarSegundoArchivo devuelve error (no número),
    // tu lógica actual de error puede seguir igual (alert, etc.)
  };

  reader.readAsArrayBuffer(file);
});

   // =========================
// Procesar Tercer Archivo (Horas Diseño)
// =========================
document.getElementById('btnCargarDiseno').addEventListener('click', function() {
  const file = document.getElementById('archivoDiseno').files[0];
  const mensaje3 = document.getElementById('mensajeArchivo3');

  if (!file) {
    alert("Por favor, selecciona un archivo de diseño con horas.");
    return;
  }

  const reader = new FileReader();

  // Inicio: 0 %
  if (mensaje3) {
    mensaje3.textContent = "Cargando archivo 3... 0%";
  }

  // Progreso de lectura
  reader.onprogress = function (e) {
    if (!mensaje3) return;

    if (e.lengthComputable) {
      const porcentaje = Math.round((e.loaded / e.total) * 100);
      mensaje3.textContent = `Cargando archivo 3... ${porcentaje}%`;
    } else {
      mensaje3.textContent = "Cargando archivo 3...";
    }
  };

  reader.onload = function (event) {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const ws = workbook.Sheets[sheetName];

    // 1. Procesar el diseño (Archivo 3)
      const cantidad3 = procesarTercerArchivo(ws);
  actualizarResumenFicha();
  if (validarRolesActivos) {
    mostrarModalGerenteProyecto();
  } else {
    actualizarGerenteEnHeader("-");
    actualizarAprendizVoceroHeader("-");
  }



    // 2. Mostrar Información General y reportes
    const headerInfo    = document.getElementById("headerInfo");
    const reportes      = document.getElementById("reportes");
    const exportSection = document.getElementById("export-section");

    if (headerInfo)    headerInfo.style.display    = "block";
    if (reportes)      reportes.style.display      = "block";
    if (exportSection) exportSection.style.display = "block";

    // Actualizar Coordinador Académico en el encabezado (si se seleccionó)
    const coordHeader = document.getElementById("coordinadorAcademicoHeader");
    if (coordHeader && coordinadorAcademicoSeleccionado) {
      coordHeader.textContent = coordinadorAcademicoSeleccionado;
    }


    // 3. Mensaje de confirmación del Archivo 3
    if (mensaje3) {
      mensaje3.textContent = `Archivo 3: ${cantidad3} registros cargados (100%)`;
    }

    // 4. Redibujar la gráfica de Estados ya con el contenedor visible
    if (estadoChart) {
      setTimeout(function () {
        estadoChart.render();
      }, 100);
    }
  };
// 5. Contraer el acordeón de "Cargue de Archivos" al finalizar el último archivo
    const accordionBody = document.getElementById("accordionCargueBody");
    const accordionIcon = document.getElementById("accordionCargueIcon");
    if (accordionBody) {
      accordionBody.style.display = "none";
    }
    if (accordionIcon) {
      accordionIcon.textContent = "▸";
    }
  reader.readAsArrayBuffer(file);
});
// Permite explotar/contraer una porción del pie al hacer clic en la leyenda
function explodePieEstado(e) {
  const dp = e.dataSeries.dataPoints[e.dataPointIndex];

  if (typeof dp.exploded === "undefined" || !dp.exploded) {
    dp.exploded = true;
  } else {
    dp.exploded = false;
  }

  e.chart.render();
}
    

// =========================
// Procesar archivo de inasistencias (Fallas)
// A2:B2 -> FICHA (combinado)
// C2    -> INSTRUCTOR
// D2    -> IDENTIFICACIÓN APRENDIZ
// E2    -> APRENDIZ
// F2    -> FECHA INICIO
// G2    -> FECHA FIN
// H2    -> CANT. HORAS
// I2    -> JUSTIFICACION


// =========================
// Datos desde fila 3
// =========================
function procesarArchivoFallas(ws) {
  // mapa de documento -> número de fallas
  mapaFallasPorDocumento = {};
  // mapa de documento -> arreglo de fechas de inasistencia
  mapaFechasFallasPorDocumento = {};
  if (!ws) return 0;

  // Ficha del archivo 1 (solo dígitos)
  const fichaGlobal = normalizarDocumento(codigoFichaPrimero);

  let fila = 3;
  let totalRegistrosFicha = 0;
  let fichaActual = "";

  while (true) {
    // FICHA está en A:B combinadas; el valor real queda en A (y, por seguridad, miramos también B)
    const celdaFichaA = ws["A" + fila];
    const celdaFichaB = ws["B" + fila];

    // Identificación del aprendiz está en D
    const celdaIdent  = ws["D" + fila];
    // Fecha de la falla está en F
    const celdaFecha  = ws["F" + fila];

    // Si no hay ficha (ni en A ni en B) NI identificación, asumimos fin de datos
    if (!celdaFichaA && !celdaFichaB && !celdaIdent) {
      break;
    }

    // Texto completo de la ficha, por ejemplo: "2824796 - GESTION CONTABLE."
    let valorFichaBruto = "";
    if (celdaFichaA && celdaFichaA.v !== undefined && celdaFichaA.v !== null && celdaFichaA.v !== "") {
      valorFichaBruto = celdaFichaA.v;
    } else if (celdaFichaB && celdaFichaB.v !== undefined && celdaFichaB.v !== null && celdaFichaB.v !== "") {
      valorFichaBruto = celdaFichaB.v;
    }

    // Extraer solo el número de ficha (antes del guion)
    if (valorFichaBruto !== "") {
      const textoFicha = String(valorFichaBruto);
      const partes     = textoFicha.split("-");    // "2824796 " | " GESTION CONTABLE."
      const soloFicha  = partes[0];                // "2824796 "
      fichaActual      = normalizarDocumento(soloFicha);  // "2824796"
    }

    // Si tenemos ficha del archivo 1, filtramos solo esas filas
    if (fichaGlobal && fichaActual && fichaActual !== fichaGlobal) {
      fila++;
      continue;
    }

    // Identificación del aprendiz, ej: "CC - 1110586616"
    const valorIdent     = celdaIdent ? celdaIdent.v : "";
    const docNormalizado = normalizarDocumento(valorIdent); // "1110586616"

    // Fecha de la falla (columna F)
    let textoFecha = "";
    if (celdaFecha) {
      const valorCrudo = celdaFecha.w || celdaFecha.v;
      if (valorCrudo !== undefined && valorCrudo !== null && valorCrudo !== "") {
        textoFecha = String(valorCrudo).trim();
      }
    }

    if (docNormalizado) {
      if (!mapaFallasPorDocumento[docNormalizado]) {
        mapaFallasPorDocumento[docNormalizado] = 0;
        mapaFechasFallasPorDocumento[docNormalizado] = [];
      }
      // Suma una falla
      mapaFallasPorDocumento[docNormalizado]++;

      // Guarda la fecha en el arreglo de detalles (si viene algo)
      if (textoFecha) {
        mapaFechasFallasPorDocumento[docNormalizado].push(textoFecha);
      }

      totalRegistrosFicha++;
    }

    fila++;
  }

  return totalRegistrosFicha;
}


    // =========================
    // Procesar Archivo de Fallas (Consolidado de Inasistencias)
    // =========================
    const btnProcesarFallas = document.getElementById('btnProcesarFallas');
    if (btnProcesarFallas) {
      btnProcesarFallas.addEventListener('click', function () {
        const file = document.getElementById('excelFallas').files[0];
        if (!file) {
          alert("Por favor, selecciona el archivo de consolidado de inasistencias.");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (event) {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[sheetName];

          const totalFallas = procesarArchivoFallas(ws);

          const mensajeFallas = document.getElementById("mensajeFallas");
          if (mensajeFallas) {
            mensajeFallas.style.display = "flex";
            mensajeFallas.textContent = `Archivo de inasistencias cargado. Registros de fallas para la ficha: ${totalFallas}`;
          }

          // Regenerar el reporte de % Avance por Aprendiz ya con la columna Fallas
          generarPivotTableAvancePorAprendiz();
        };
        reader.readAsArrayBuffer(file);
      });
    }

    // =========================
    // Procesar Primer Archivo (Instructores)
    // =========================
    function procesarPrimerArchivo(ws) {
      const nombrePrograma = (ws["B3"] && ws["B3"].v) || "";
      const codigoFicha = (ws["B2"] && ws["B2"].v) || "";
      const fechaInicioLectivaStr = (ws["D2"] && ws["D2"].v) || "";
      const fechaFinLectivaStr = (ws["F2"] && ws["F2"].v) || "";

  // >>> NUEVO: guardar la ficha del archivo 1
  codigoFichaPrimero = codigoFicha;

      document.getElementById("nombrePrograma").textContent = nombrePrograma;
      document.getElementById("codigoFicha").textContent = codigoFicha;

      if(fechaInicioLectivaStr){
        const fInicio = parseFecha(fechaInicioLectivaStr);
        document.getElementById("fechaInicioLectiva").textContent = formatearFechaLarga(fInicio);
        fechaInicioLectivaGlobal = fInicio;
      } else {
        document.getElementById("fechaInicioLectiva").textContent = "";
        fechaInicioLectivaGlobal = null;
      }

      if (fechaFinLectivaStr) {
        // Fin lectiva calculado a partir de la fecha fin global del programa
        const fFinLectiva = calcularFechaFinLectiva(fechaFinLectivaStr);
        document.getElementById("fechaFinLectiva").textContent = formatearFechaLarga(fFinLectiva);
        fechaFinLectivaGlobal = fFinLectiva;
      } else {
        document.getElementById("fechaFinLectiva").textContent = "";
        fechaFinLectivaGlobal = null;
      }

      codigoFichaPrimero = codigoFicha;

      if (fechaFinLectivaStr) {
        const fechaInicioProd = calcularFechaInicioProductiva(fechaFinLectivaStr);
        const fechaFinProd = calcularFechaFinProductiva(fechaFinLectivaStr);
        document.getElementById("fechaInicioProductiva").textContent = formatearFechaLarga(fechaInicioProd);
        document.getElementById("fechaFinProductiva").textContent = formatearFechaLarga(fechaFinProd);
        // Guardar globalmente
        fechaInicioProductivaGlobal = fechaInicioProd;
        fechaFinProductivaGlobal = fechaFinProd;
      } else {
        document.getElementById("fechaInicioProductiva").textContent = "";
        document.getElementById("fechaFinProductiva").textContent = "";
        fechaInicioProductivaGlobal = null;
        fechaFinProductivaGlobal = null;
      }

      renderLineaTiempoFicha();

      let fila = 12;
      const registros = [];
      while(true) {
        let celdaA = ws["A" + fila];
        if(!celdaA) break;
        let nombreInstructor = celdaA.v || "";
        let apellidoInstructor = (ws["B" + fila] && ws["B" + fila].v) || "";
        let estadoInstructor = (ws["C" + fila] && ws["C" + fila].v) || "";
        let competencia = ((ws["D" + fila] && ws["D" + fila].v) || "").trim();
        let fechaInicioProg = (ws["E" + fila] && ws["E" + fila].v) || "";
        let fechaFinProg = (ws["F" + fila] && ws["F" + fila].v) || "";
        let horasProg = parseFloat((ws["G" + fila] && ws["G" + fila].v) || 0);

        registros.push({
          nombreInstructor,
          apellidoInstructor,
          estadoInstructor,
          competencia,
          horasProg,
          fechaInicioProg,
          fechaFinProg
        });
        fila++;
      }
        // <<< AÑADIR ESTO >>>
datosHorario = registros.map(r => ({
  "Nombre Instructor": ((r.nombreInstructor || "") + " " + (r.apellidoInstructor || "")).trim(),
  "Horas Programadas": r.horasProg,
  "Nombre Competencia": r.competencia
}));


 registrosGlobal = registros;

      // Inicializar Reporte 1 aplicando filtros actuales
      aplicarFiltrosYGenerarReporte1();

      competenciasMap = {};
      registros.forEach(r => {
        if (!competenciasMap[r.competencia]) {
          competenciasMap[r.competencia] = 0;
        }
        competenciasMap[r.competencia] += r.horasProg;
      });


           let arrComp = Object.entries(competenciasMap);

      const tbody2 = document.getElementById("tbodyReporte2");
      tbody2.innerHTML = "";
      let cont2 = 1;
      competenciasSet.clear();
      competenciasSetNormalizado.clear();

      // Agrupamos las competencias por categoría
      const categoriasRep2 = {
        "Práctica": [],
        "Transversales": [],
        "Inglés": [],
        "Técnicas": []
      };

      arrComp.forEach(([comp, total]) => {
        const cat = getCategoria(comp);
        if (!categoriasRep2[cat]) {
          categoriasRep2[cat] = [];
        }
        categoriasRep2[cat].push([comp, total]);
      });

      const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];

      ordenCategorias.forEach(cat => {
        const lista = categoriasRep2[cat];
        if (!lista || lista.length === 0) return;

        // Fila cabecera por categoría
        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `<td colspan="5" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
        tbody2.appendChild(headerRow);

        // Orden alfabético dentro de cada categoría
        lista.sort((a, b) => a[0].localeCompare(b[0]));

        lista.forEach(([comp, total]) => {
          // Guardamos en los sets para otros reportes
          competenciasSet.add(comp);
          competenciasSetNormalizado.add(normalizeCompetencia(comp));

          const tr = document.createElement("tr");
          const compNormalized = comp.trim().replace(/\s+/g, ' ').toUpperCase();
          const totalHoras = typeof total === "number" ? total : parseFloat(total);

          // Regla especial de validación
          if (
            compNormalized.startsWith("APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL") &&
            (totalHoras < 40 || Math.abs(totalHoras - 23.93) < 0.0001)
          ) {
            tr.classList.add("rojo");
          }

          tr.innerHTML = `
            <td>${cont2++}</td>
            <td>${comp}</td>
            <td>${totalHoras.toFixed(2)}</td>
            <td></td> <!-- Horas Diseño, se llenan luego -->
            <td></td> <!-- % -->
          `;
          tbody2.appendChild(tr);
        });
      });

      // El tfoot2 que ya tienes se mantiene como está
            const tfoot2 = document.getElementById("tfootReporte2");
      tfoot2.innerHTML = `<tr>
          <td colspan="2" style="text-align:right; font-weight:bold;">Total Horas Programadas:</td>
          <td>${arrComp.reduce((acc, [, total]) => acc + total, 0).toFixed(2)}</td>
          <td></td>
          <td></td>
        </tr>`;

      generarGanttChart();
      generarReporte3Instructores();
// NUEVO: devolver cantidad de registros cargados
  return registros.length;
    }

    // =========================
    // Generar Reporte 1: Listado de Instructores y Competencias agrupado por categoría
    // =========================
    function generarReporte1(registros) {
      const tbody1 = document.getElementById("tbodyReporte1");
      tbody1.innerHTML = "";
      const categorias = {
        "Práctica": [],
        "Transversales": [],
        "Inglés": [],
        "Técnicas": []
      };
      registros.forEach((r) => {
        const cat = getCategoria(r.competencia);
        categorias[cat].push(r);
      });
      let contador = 1;
      const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];
      ordenCategorias.forEach(cat => {
        if(categorias[cat].length > 0) {
          const headerRow = document.createElement("tr");
          headerRow.innerHTML = `<td colspan="6" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
          tbody1.appendChild(headerRow);

          categorias[cat].forEach(r => {
            const tr = document.createElement("tr");
            if(r.estadoInstructor.toLowerCase() === "inactivo") {
              tr.classList.add("inactivo");
            }
            tr.innerHTML = `
              <td>${contador++}</td>
              <td>${r.nombreInstructor}</td>
              <td>${r.apellidoInstructor}</td>
              <td>${r.estadoInstructor}</td>
              <td>${r.competencia}</td>
              <td>${r.horasProg.toFixed(2)}</td>
            `;
            tbody1.appendChild(tr);
          });
        }
      });
    }

    // =========================
    // Generar Cronograma Gantt del Reporte 2 (existente)
    // =========================
    function generarGanttChart() {
      const categoriasGantt = {
        "Práctica": {},
        "Transversales": {},
        "Inglés": {},
        "Técnicas": {}
      };
      registrosGlobal.forEach(r => {
        if(r.fechaInicioProg && r.fechaFinProg) {
          const cat = getCategoria(r.competencia);
          if(!categoriasGantt[cat][r.competencia]) {
            categoriasGantt[cat][r.competencia] = [];
          }
          categoriasGantt[cat][r.competencia].push({ 
            start: parseFecha(r.fechaInicioProg), 
            end: parseFecha(r.fechaFinProg) 
          });
        }
      });

      let overallStart = null, overallEnd = null;
      Object.values(categoriasGantt).forEach(group => {
        Object.values(group).forEach(intervals => {
          intervals.forEach(intervalo => {
            if(!overallStart || intervalo.start < overallStart) overallStart = intervalo.start;
            if(!overallEnd || intervalo.end > overallEnd) overallEnd = intervalo.end;
          });
        });
      });
      if(!overallStart) return;

      // Obtener rango de meses
      let monthLabels = [];
      let current = new Date(overallStart.getFullYear(), overallStart.getMonth(), 1);
      let endMonth = new Date(overallEnd.getFullYear(), overallEnd.getMonth(), 1);
      while(current <= endMonth) {
        monthLabels.push(new Date(current));
        current.setMonth(current.getMonth() + 1);
      }

      let html = "<table style='width:100%; border-collapse: collapse;'>";
      html += "<thead><tr><th style='border: 1px solid #ccc;'>#</th><th style='border: 1px solid #ccc;'>Competencia</th>";
      const mesesAbrev = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];

      monthLabels.forEach(m => {
        let label = mesesAbrev[m.getMonth()] + "-" + m.getFullYear();
        html += "<th style='border: 1px solid #ccc;'>" + label + "</th>";
      });
      html += "</tr></thead><tbody>";

      let count = 1;
      const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];
      ordenCategorias.forEach(cat => {
        html += "<tr><td colspan='" + (2 + monthLabels.length) + 
                "' style='background-color:#ccc; font-weight:bold;'>" + cat + "</td></tr>";
        const competencias = categoriasGantt[cat];
        for(let comp in competencias) {
          html += "<tr>";
          html += "<td style='border: 1px solid #ccc; text-align: center;'>" + (count++) + "</td>";
          html += "<td style='border: 1px solid #ccc;'>" + comp + "</td>";

          monthLabels.forEach(m => {
            let cellStyle = "border: 1px solid #ccc; text-align: center;";
            let cellContent = "&nbsp;";
            let mYear = m.getFullYear(), mMonth = m.getMonth();
            let inRange = competencias[comp].some(intervalo => {
              let sYear = intervalo.start.getFullYear(), sMonth = intervalo.start.getMonth();
              let eYear = intervalo.end.getFullYear(), eMonth = intervalo.end.getMonth();
              return ((mYear > sYear || (mYear === sYear && mMonth >= sMonth)) &&
                      (mYear < eYear || (mYear === eYear && mMonth <= eMonth)));
            });
            if(inRange) {
              cellStyle += " background-color: #0F172A; color: white; font-weight: bold;";
              cellContent = "X";
            }
            html += "<td style='" + cellStyle + "'>" + cellContent + "</td>";
          });

          html += "</tr>";
        }
      });
      html += "</tbody></table>";

      document.getElementById("ganttContainer").innerHTML = html;
    }

 // Gráfico % Competencias con Horas (Total vs Diseño)
// Gráfico % Competencias con Horas (Total vs Diseño)
// Gráfico % Competencias con Horas (Total vs Diseño)
function dibujarGraficoCompetenciasHoras() {
  const contenedor = document.getElementById("chartCompetenciasHorasContainer");
  if (!contenedor) return;

  // Tomamos los datos desde la tabla #tbodyReporte2
  const filas = document.querySelectorAll("#tbodyReporte2 tr");
  if (!filas || filas.length === 0) {
    contenedor.innerHTML = "";
    chartCompetenciasHoras = null;
    return;
  }

  const dataTotal    = []; // % cubierto (Total / Diseño)
  const dataRestante = []; // % restante hasta el 100 %

  filas.forEach(fila => {
    const celdas = fila.getElementsByTagName("td");
    if (celdas.length < 4) return;

    const competenciaTexto = celdas[1].textContent.trim();
    const totalHoras       = parseFloat(celdas[2].textContent) || 0;
    const horasDiseno      = parseFloat(celdas[3].textContent) || 0;

    // Si ambas son cero, no tiene sentido mostrarla
    if (totalHoras === 0 && horasDiseno === 0) return;

    // 1) Nombre corto para el gráfico (máx. 40 caracteres)
    const competenciaCorta =
      competenciaTexto.length > 40
        ? competenciaTexto.substring(0, 40) + "…"
        : competenciaTexto;

    // 2) Categoría de la competencia (Práctica / Transversales / Inglés / Técnicas)
    const categoria = getCategoria(competenciaTexto);

    // 3) % de cumplimiento: Total / Diseño
    let porcentajeReal = 0;
    let porcentaje     = 0;

    if (horasDiseno > 0) {
      porcentajeReal = (totalHoras / horasDiseno) * 100;
      porcentaje     = porcentajeReal > 100 ? 100 : porcentajeReal; // se muestra hasta 100 %
    }

    const colorPrincipal = getColorCategoriaGrafico(categoria);

    // Si supera el 100 %, la barra se pinta de rojo
    const colorBarra = (porcentajeReal > 100) ? "#ef4444" : colorPrincipal;

    // Parte cubierta (Total vs Diseño)
    dataTotal.push({
      label:          competenciaCorta,   // nombre truncado para el eje
      fullLabel:      competenciaTexto,   // nombre completo para tooltip
      categoria:      categoria,
      y:              porcentaje,
      porcentajeReal: porcentajeReal,
      color:          colorBarra,         // color por tipo o rojo si >100 %
      horasTotal:     totalHoras,
      horasDiseno:    horasDiseno
    });

    // Parte restante hasta llegar al 100 %
    dataRestante.push({
      label:       competenciaCorta,
      fullLabel:   competenciaTexto,
      categoria:   categoria,
      y:           100 - porcentaje,
      color:       "#d1d5db",             // gris neutro
      horasTotal:  totalHoras,
      horasDiseno: horasDiseno
    });
  });

  if (dataTotal.length === 0) {
    contenedor.innerHTML = "";
    chartCompetenciasHoras = null;
    return;
  }

  // ===== Altura dinámica para que salgan todas las competencias =====
  const alturaMinima   = 260;
  const alturaPorBarra = 32;   // px por competencia (barras más delgadas, pero bien separadas)

  let alturaGrafico = alturaPorBarra * dataTotal.length + 40;
  if (alturaGrafico < alturaMinima) alturaGrafico = alturaMinima;

  // Forzamos al contenedor DIV a tener la altura calculada
  contenedor.style.height = alturaGrafico + "px";

  chartCompetenciasHoras = new CanvasJS.Chart("chartCompetenciasHorasContainer", {
    animationEnabled: true,
    exportEnabled:    true,
    height:           alturaGrafico,

    marginTop:    10,
    marginBottom: 30,
    marginLeft:   10,
    marginRight:  20,

    // EJE DE CATEGORÍAS (nombres de competencias)
    axisX: {
      labelFontSize: 10,
      labelMaxWidth: 320,
      labelWrap:     true,
      gridThickness: 0,
      tickLength:    0,
      margin:        5,
      interval:      1
    },

    // EJE DE VALORES (0–100 %)
    axisY: {
      minimum:       0,
      maximum:       100,
      suffix:        "%",
      interval:      10,
      gridThickness: 1
    },

    legend: {
      verticalAlign:      "top",
      horizontalAlign:    "left",  // leyenda alineada a la izquierda
      dockInsidePlotArea: true,
      fontSize:           12
    },

    toolTip: {
      shared: true,
      content: function (e) {
        const dp  = e.entries[0].dataPoint; // serie del % cubierto
        const nom = dp.fullLabel || dp.label;
        const cat = dp.categoria || getCategoria(nom);

        const valorReal = (typeof dp.porcentajeReal === "number" && !isNaN(dp.porcentajeReal))
          ? dp.porcentajeReal
          : dp.y;

        return "<strong>" + nom + "</strong><br/>" +
               "Categoría: "     + cat + "<br/>" +
               "Total Horas: "   + dp.horasTotal.toFixed(2)  + "<br/>" +
               "Horas Diseño: "  + dp.horasDiseno.toFixed(2) + "<br/>" +
               "Cumplimiento: "  + valorReal.toFixed(1) + "%";
      }
    },

    data: [
      {
        type:               "stackedBar100",
        dataPointWidth:     10,          // barras más delgadas
        showInLegend:       true,
        name:               "Total de Horas vs Diseño",
        yValueFormatString: "##0.0\"%\"",

        // % sobre las barras: más pequeño, blanco, en negrita
        indexLabel:            "{y}%",
        indexLabelPlacement:   "inside",
        indexLabelFontColor:   "#ffffff",
        indexLabelFontSize:    12,
        indexLabelFontWeight:  "bold",

        dataPoints:         dataTotal
      },
      {
        type:               "stackedBar100",
        showInLegend:       true,
        name:               "Horas restantes hasta el 100 %",
        yValueFormatString: "##0.0\"%\"",
        dataPoints:         dataRestante
      }
    ]
  });

  chartCompetenciasHoras.render();
}

// =========================
// Generar Reporte 3: Instructores con total de horas (mayor a menor)
// + Gráfico de barras CanvasJS
// =========================
function generarReporte3Instructores() {
  const mapHorasPorInstructor = {};

  // 1) Agrupar horas por instructor (nombre+apellido)
  registrosGlobal.forEach(r => {
    const clave = (r.nombreInstructor.trim() + "|" + r.apellidoInstructor.trim()).toLowerCase();
    if (!mapHorasPorInstructor[clave]) {
      mapHorasPorInstructor[clave] = {
        nombre: r.nombreInstructor.trim(),
        apellido: r.apellidoInstructor.trim(),
        horas: 0
      };
    }
    mapHorasPorInstructor[clave].horas += r.horasProg;
  });

  // 2) Pasar a arreglo y ordenar de mayor a menor horas
  let arrInstructores = Object.values(mapHorasPorInstructor);
  arrInstructores.sort((a, b) => b.horas - a.horas);

  // 3) Llenar la tabla del reporte 3
  const tbody3 = document.getElementById("tbodyReporte3");
  if (!tbody3) return;

  tbody3.innerHTML = "";
  arrInstructores.forEach((inst, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${inst.nombre}</td>
      <td>${inst.apellido}</td>
      <td>${inst.horas.toFixed(2)}</td>
    `;
    tbody3.appendChild(tr);
  });

  const tfoot3 = document.getElementById("tfootReporte3");
  if (tfoot3) {
    tfoot3.innerHTML = `<tr>
      <td colspan="3" style="text-align:right; font-weight:bold;">Total Horas Programadas:</td>
      <td>${arrInstructores.reduce((acc, inst) => acc + inst.horas, 0).toFixed(2)}</td>
    </tr>`;
  }

  // 4) Construir gráfico de barras de horas por instructor (CanvasJS)
  const contGrafico = document.getElementById("chartInstructoresHorasContainer");
  if (!contGrafico) return; // por seguridad

  // Limpiar contenedor por si se vuelve a generar
  contGrafico.innerHTML = "";

  // Paleta de tonos verdes para las barras
  const coloresVerdes = ["#22c55e", "#16a34a", "#15803d", "#4ade80", "#86efac"];

  const dataPointsHoras = arrInstructores.map((inst, index) => ({
    y: parseFloat(inst.horas.toFixed(2)),
    label: `${inst.nombre} ${inst.apellido}`,
    color: coloresVerdes[index % coloresVerdes.length]
  }));

  if (dataPointsHoras.length === 0) return;

  // Altura dinámica: 35 px por instructor + 120 px para títulos y márgenes
  const alturaPorBarra = 35;
  const margenExtra = 120;
  const alturaGrafico = margenExtra + alturaPorBarra * dataPointsHoras.length;

  // Ajustar el alto del contenedor del gráfico
  contGrafico.style.height = alturaGrafico + "px";

  // Crear el gráfico y guardarlo en la variable global
  chartHorasInstructores = new CanvasJS.Chart("chartInstructoresHorasContainer", {
    animationEnabled: true,
    exportEnabled: true,
    height: alturaGrafico,
  
    axisX: {
      interval: 1,
      labelFontSize: 10
    },
    axisY2: {
      interlacedColor: "rgba(1,77,101,0.2)",
      gridColor: "rgba(1,77,101,0.1)",
      labelFontSize: 10
    },
    data: [{
      type: "bar",
      axisYType: "secondary",
      dataPoints: dataPointsHoras
    }]
  });

  // Primer render
  chartHorasInstructores.render();
}


    // =========================
    // Procesar Segundo Archivo (Juicios Evaluativos)
    // =========================
    function procesarSegundoArchivo(ws) {
      document.getElementById("mensajeError").textContent = "";
      const c3Value = (ws["C3"] && ws["C3"].v) || "";
      const codigoPrograma = (ws["C4"] && ws["C4"].v) || "";
      codigoProgramaGlobal = codigoPrograma;
      document.getElementById("codigoPrograma").textContent = codigoPrograma;

      // Capturar Modalidad de Formación desde C10
      const modalidadFormacion = (ws["C10"] && ws["C10"].v) || "";
      modalidadFormacionGlobal = modalidadFormacion;
      document.getElementById("modalidadFormacion").textContent = modalidadFormacion || "N/A";

      if(c3Value !== codigoFichaPrimero) {
        document.getElementById("mensajeError").textContent = 
          `❌ Error: La ficha en C3 (${c3Value}) no coincide con la del primer archivo (${codigoFichaPrimero}).`;
        return;
      }
      let fila = 14;
      registrosJuicios = [];
      while(true) {
        let celdaA = ws["A" + fila];
        if(!celdaA) break;
        let tipoDoc = celdaA.v || "";
        let numDoc = (ws["B" + fila] && ws["B" + fila].v) || "";
        let nombre = (ws["C" + fila] && ws["C" + fila].v) || "";
        let apellidos = (ws["D" + fila] && ws["D" + fila].v) || "";
        let estado = (ws["E" + fila] && ws["E" + fila].v) || "";
        let compOrig = (ws["F" + fila] && ws["F" + fila].v) || "";
        let competencia = compOrig ? compOrig.trim().replace(/^[0-9]+\s*-\s*/, '').trim() : "";
        let resAprendizaje = (ws["G" + fila] && ws["G" + fila].v) || "";
        let juicioEval = (ws["H" + fila] && ws["H" + fila].v) || "";
        let fechaHora = (ws["I" + fila] && ws["I" + fila].v) || "";
        let funcionario = (ws["K" + fila] && ws["K" + fila].v) || "";

       

     
      registrosJuicios.push({
        tipoDoc,
        numDoc,
        nombre,
        apellidos,
        estado,
        competencia,
        resAprendizaje,
        juicioEval,
        fechaHora,
        funcionario
      });
      fila++;
    }
// <<< AÑADIR ESTO >>>
datosGeneralFicha = registrosJuicios.map(r => ({
  "Estado Aprendiz": r.estado,
  "Nombre Aprendiz": (r.nombre + " " + r.apellidos).trim(),
  "Documento": r.numDoc
}));
    // En este punto ya tenemos los registros de aprendices.
    // IMPORTANTE: NO mostramos headerInfo aquí.
    // Se mostrará solo después de cargar el Archivo 3.

    // Generar tabla de estados
    const estadosMap = {};


const totalAprendicesSet = new Set();

registrosJuicios.forEach(r => {
  let estado = (r.estado || "").trim();
  let nombreCompleto = (r.nombre + " " + r.apellidos).trim();

  totalAprendicesSet.add(nombreCompleto);

  if (!estadosMap[estado]) {
    estadosMap[estado] = new Set();
  }
  estadosMap[estado].add(nombreCompleto);
});

const totalAprendices = totalAprendicesSet.size;
const tbodyEstado = document.getElementById("tbodyEstado");
tbodyEstado.innerHTML = "";

// Mostrar total en el encabezado de la tarjeta
const totalSpan = document.getElementById("totalAprendicesEstado");
if (totalSpan) {
  totalSpan.textContent = totalAprendices;
}
const totalMatricHeader = document.getElementById("numMatriculadosHeader");
if (totalMatricHeader) {
  totalMatricHeader.textContent = totalAprendices;
}
const totalInlineSpan = document.getElementById("numAprendicesTotalInline");
if (totalInlineSpan) {
  totalInlineSpan.textContent = `/ ${totalAprendices}`;
}

// ORDEN DESEADO DE LOS ESTADOS
const ordenPreferido = [
  "EN FORMACION",
  "EN FORMACIÓN",
  "CONDICIONADO",
  "CANCELADO",
  "CANCELADOS",
  "RETIRO VOLUNTARIO"
];

// Construir arreglo de estados en el orden deseado
const estadosOrdenados = [];

// Primero los estados en el orden definido
ordenPreferido.forEach(estadoRef => {
  Object.keys(estadosMap).forEach(estadoClave => {
    const normClave = estadoClave.toUpperCase().trim();
    if (normClave === estadoRef && !estadosOrdenados.includes(estadoClave)) {
      estadosOrdenados.push(estadoClave);
    }
  });
});

// Luego cualquier otro estado que exista
Object.keys(estadosMap).forEach(estadoClave => {
  if (!estadosOrdenados.includes(estadoClave)) {
    estadosOrdenados.push(estadoClave);
  }
});

// Pintar filas de la tabla en el orden calculado
estadosOrdenados.forEach(estado => {
  let nombresArray = Array.from(estadosMap[estado]).sort();
  let cantidad = nombresArray.length;
  const tr = document.createElement("tr");

  // Normalizar estado para asignar clase de color
  const estadoNorm = (estado || "").toUpperCase().trim();
  let claseEstado = "estado-otro";

  if (estadoNorm === "EN FORMACION" || estadoNorm === "EN FORMACIÓN") {
    claseEstado = "estado-en-formacion";
  } else if (estadoNorm === "CONDICIONADO") {
    claseEstado = "estado-condicionado";
  } else if (estadoNorm === "CANCELADO" || estadoNorm === "CANCELADOS") {
    claseEstado = "estado-cancelado";
  } else if (estadoNorm === "RETIRO VOLUNTARIO") {
    claseEstado = "estado-retiro";
  }

  tr.classList.add("fila-estado", claseEstado);

  tr.innerHTML = `
    <td><span class="badge-estado">${estado}</span></td>
    <td>${nombresArray.join(", ")}</td>
    <td class="col-cantidad">${cantidad}</td>
    <td class="col-porcentaje">${
      totalAprendices ? ((cantidad / totalAprendices) * 100).toFixed(2) : "0.00"
    }%</td>
  `;
  tbodyEstado.appendChild(tr);
});


// === Datos para la gráfica (mismo orden que la tabla) ===
const estados   = estadosOrdenados;
const cantidades = estados.map(estado => estadosMap[estado].size);
const porcentajes = cantidades.map(cantidad =>
  totalAprendices ? Number(((cantidad / totalAprendices) * 100).toFixed(2)) : 0
);

// Construir dataPoints para CanvasJS
// Colores SOLO para la gráfica (no afecta la tabla)
const coloresGraficoEstados = {
  "EN FORMACION": "#16A34A",        // azul
  "EN FORMACIÓN": "#16A34A",        // con tilde
  "CONDICIONADO": "#FACC15",        // amarillo/naranja
  "CANCELADO": "#ADB3BF",           // gris
  "CANCELADOS": "#ADB3BF",
  "RETIRO VOLUNTARIO": "#F97373"    // rojo
};

const dataPointsEstados = estados.map((estado, index) => {
  const clave = (estado || "").toUpperCase().trim();
  return {
    y: porcentajes[index],
    name: estado,
    color: coloresGraficoEstados[clave] || "#22c55e", // color de respaldo
    exploded: index === 0
  };
});


// Limpiar el contenedor antes de redibujar


const chartContainer = document.getElementById("estadoChartContainer");
if (chartContainer) {
  chartContainer.innerHTML = "";
}

estadoChart = new CanvasJS.Chart("estadoChartContainer", {
  animationEnabled: true,
  exportEnabled: true,
  legend: {
    cursor: "pointer",
    itemclick: explodePieEstado
  },
  data: [{
    type: "pie",
    showInLegend: true,
    toolTipContent: "{name}: <strong>{y}%</strong>",
    indexLabel: "{name} - {y}%",
    yValueFormatString: "#,##0.00",
    dataPoints: dataPointsEstados
  }]
});

estadoChart.render();

            // Generar tabla del Reporte 4
const tbody4 = document.getElementById("tbodyReporte4");
tbody4.innerHTML = "";

// 1) Construir arrComp2 (misma lógica que antes)
const comp2Set = new Set();
registrosJuicios.forEach(r => {
  comp2Set.add(r.competencia);
});



// Nesteamos arrComp2 para que se sepa si están programadas o no
// y manejamos el caso especial de la competencia ambiental con 1/2
let arrComp2 = Array.from(comp2Set).map(comp => {
  const compNorm = normalizeCompetencia(comp);

  // Por defecto, según el set normalizado (solo entra si tiene horas > 0)
  let programada = competenciasSetNormalizado.has(compNorm) ? "Sí" : "No";
  let tooltip = "";

  // Regla especial: APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL...
  if (compNorm.includes("APLICAR PRACTICAS DE PROTECCION AMBIENTAL")) {
    let horas = 0;

    // Tomamos las horas totales tal como se usan en % Competencias con Horas
    for (const [compRaw, total] of Object.entries(competenciasMap || {})) {
      if (normalizeCompetencia(compRaw) === compNorm) {
        horas = typeof total === "number" ? total : parseFloat(total) || 0;
        break;
      }
    }

    // Clasificación:
    //  - 0 horas      -> "No"
    //  - 0 < horas <= 24 -> "1/2"  (falta programar la 1/2)
    //  - horas  > 24  -> "Sí"
    if (horas <= 0.0001) {
      programada = "No";
    } else if (horas <= 24) {
      programada = "1/2";
      tooltip = "Falta programar la 1/2 mitad de la competencia";
    } else {
      programada = "Sí";
    }
  }

  return { comp, programada, tooltip };
});
	

// === NUEVO: actualizar Reporte 2 con TODAS las competencias del programa ===
(function actualizarReporte2ConTodasLasCompetencias() {
  const tbody2 = document.getElementById("tbodyReporte2");
  if (!tbody2) return;

  // Mapa: competencia normalizada -> horas totales programadas (archivo 1)
  const horasPorCompNorm = {};
  Object.entries(competenciasMap || {}).forEach(([compTexto, horas]) => {
    const compNorm = normalizeCompetencia(compTexto);
    if (!compNorm) return;

    const valorHoras = typeof horas === "number" ? horas : parseFloat(horas) || 0;
    if (!horasPorCompNorm[compNorm]) {
      horasPorCompNorm[compNorm] = 0;
    }
    horasPorCompNorm[compNorm] += valorHoras;
  });

  // Arreglo para Reporte 2 usando TODAS las competencias del programa (arrComp2)
  const arrCompRep2 = arrComp2.map(obj => {
    const compTexto = obj.comp || "";
    const compNorm = normalizeCompetencia(compTexto);
    const horasProg = compNorm && horasPorCompNorm[compNorm]
      ? horasPorCompNorm[compNorm]
      : 0; // si no está programada, 0 horas
    return [compTexto, horasProg];
  });

  // Reconstruir completamente la tabla del Reporte 2
  tbody2.innerHTML = "";
  competenciasSet.clear();
  competenciasSetNormalizado.clear();

  const categoriasRep2 = {
    "Práctica": [],
    "Transversales": [],
    "Inglés": [],
    "Técnicas": []
  };

  arrCompRep2.forEach(([comp, horas]) => {
    const cat = getCategoria(comp);
    if (!categoriasRep2[cat]) {
      categoriasRep2[cat] = [];
    }
    categoriasRep2[cat].push([comp, horas]);
  });

  const ordenCategorias2 = ["Práctica", "Transversales", "Inglés", "Técnicas"];
  let cont2 = 1;

  ordenCategorias2.forEach(cat => {
    const lista = categoriasRep2[cat];
    if (!lista || lista.length === 0) return;

    // Cabecera de categoría
    const headerRow = document.createElement("tr");
    headerRow.innerHTML = `<td colspan="5" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
    tbody2.appendChild(headerRow);

    // Orden alfabético dentro de la categoría
    lista.sort((a, b) => a[0].localeCompare(b[0]));

    lista.forEach(([comp, total]) => {
      const tr = document.createElement("tr");
      const compNormalized = comp.trim().replace(/\s+/g, " ").toUpperCase();
      const totalHoras = typeof total === "number" ? total : parseFloat(total) || 0;

      // Solo se consideran "programadas" (para otros reportes) las que tienen horas > 0
      if (totalHoras > 0) {
        competenciasSet.add(comp);
        competenciasSetNormalizado.add(normalizeCompetencia(comp));
      }
      // Resaltar en rojo claro las competencias con 0 horas programadas
      if (totalHoras === 0) {
        tr.classList.add("no-programada");
      }


      // Misma regla especial de validación para protección ambiental
      if (
        compNormalized.startsWith("APLICAR PRACTICAS DE PROTECCION AMBIENTAL") ||
        compNormalized.startsWith("APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL")
      ) {
        if (totalHoras < 40 && Math.abs(totalHoras - 23.93) > 0.0001) {
          tr.classList.add("rojo");
        }
      }

      tr.innerHTML = `
        <td>${cont2++}</td>
        <td>${comp}</td>
        <td>${totalHoras.toFixed(2)}</td>
        <td></td>  <!-- Horas Diseño, se llenan con el archivo 3 -->
        <td></td>  <!-- % vs Diseño -->
      `;
      tbody2.appendChild(tr);
    });
  });

  // Actualizar pie de tabla (Total Horas Programadas)
  const tfoot2 = document.getElementById("tfootReporte2");
  if (tfoot2) {
    const totalHorasProg = arrCompRep2.reduce((acc, [, horas]) => {
      const valor = typeof horas === "number" ? horas : parseFloat(horas) || 0;
      return acc + valor;
    }, 0);

    tfoot2.innerHTML = `
      <tr>
        <td colspan="2" style="text-align:right; font-weight:bold;">Total Horas Programadas:</td>
        <td>${totalHorasProg.toFixed(2)}</td>
        <td></td>
        <td></td>
      </tr>
    `;
  }
})();


// 2) Agrupar por categoría usando getCategoria (Reporte 4, igual que antes)
const categoriasRep4 = {
  "Práctica": [],
  "Transversales": [],
  "Inglés": [],
  "Técnicas": []
};


      arrComp2.forEach(obj => {
        const cat = getCategoria(obj.comp);
        if (!categoriasRep4[cat]) {
          categoriasRep4[cat] = [];
        }
        categoriasRep4[cat].push(obj);
      });

     

// 3) Pintar tabla ordenada por categoría
let cont4 = 1;
const ordenCategorias4 = ["Práctica", "Transversales", "Inglés", "Técnicas"];

ordenCategorias4.forEach(cat => {
  const lista = categoriasRep4[cat];
  if (!lista || lista.length === 0) return;

  // Cabecera de categoría
  const headerRow = document.createElement("tr");
  headerRow.innerHTML = `<td colspan="3" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
  tbody4.appendChild(headerRow);

  // Dentro de la categoría: primero "No", luego "1/2", luego "Sí", orden alfabético
  lista.sort((a, b) => {
    const rank = estado => (estado === "No" ? 0 : (estado === "1/2" ? 1 : 2));
    const ra = rank(a.programada);
    const rb = rank(b.programada);
    if (ra !== rb) return ra - rb;
    return a.comp.localeCompare(b.comp);
  });

  // Filas de competencias
  lista.forEach(obj => {
    const tr = document.createElement("tr");

    if (obj.alertaInstructorDiferente) {
      tr.classList.add("fila-instructor-diferente");
    }

    // Resaltar en rojo claro las que estén "No" o "1/2"
    if (obj.programada === "No" || obj.programada === "1/2") {
      tr.classList.add("no-programada");
    }

    // Tooltip solo para el caso 1/2 de la competencia ambiental
    const tooltipAttr = obj.tooltip ? ` title="${obj.tooltip}"` : "";

    tr.innerHTML = `
      <td>${cont4++}</td>
      <td>${obj.comp}</td>
      <td${tooltipAttr}>${obj.programada}</td>
    `;
    tbody4.appendChild(tr);
  });
});

      // 4) Gantt pendientes con el mismo arreglo
      generarGanttPendientes(arrComp2);

      gruposProgramadas = {};
      gruposPendientes = {};

      registrosJuicios.forEach(r => {
        const estadoU = (r.estado || "").toUpperCase();
        if ((estadoU === "EN FORMACION" || estadoU === "CONDICIONADO") &&
            (r.juicioEval || "").toUpperCase() === "POR EVALUAR") {

          const key = r.competencia + '|' + r.resAprendizaje;
          const compNorm = normalizeCompetencia(r.competencia);

          if (competenciasSetNormalizado.has(compNorm)) {
            if (!gruposProgramadas[key]) {
              gruposProgramadas[key] = { competencia: r.competencia, rap: r.resAprendizaje, nombres: new Set() };
            }
            gruposProgramadas[key].nombres.add((r.nombre + " " + r.apellidos).trim());
          } else {
            if (!gruposPendientes[key]) {
              gruposPendientes[key] = { competencia: r.competencia, rap: r.resAprendizaje, nombres: new Set() };
            }
            gruposPendientes[key].nombres.add((r.nombre + " " + r.apellidos).trim());
          }
        }
      });

      generarReporte5();

      generarPivotTableAvancePorAprendiz();
      generarPivotTableReporte6();
      generarReporte8PendientesPorAprendizInstructor();
// NUEVO: devolver cantidad de registros de juicios
  return registrosJuicios.length;
    }

   // =========================
// Procesar Tercer Archivo (Horas Diseño)
// =========================



function procesarTercerArchivo(ws) {
  const horasDisenoMap = {};
  nivelFormacionGlobal = ""; // Limpiar valor previo
  let fila = 2;
  let filasCargadas = 0;

  while (true) {
    const celdaCodigoPrograma = ws["A" + fila];
    const celdaComp          = ws["B" + fila];
    const celdaHoras         = ws["C" + fila];
    const celdaNivelFormacion = ws["E" + fila]; // Columna E para Nivel de Formación

    if (!celdaCodigoPrograma && !celdaComp && !celdaHoras) break;

    if (!celdaCodigoPrograma || !celdaComp || !celdaHoras) {
      fila++;
      continue;
    }

    const codProg = celdaCodigoPrograma.v.toString().trim();
    const comp    = celdaComp.v.toString().trim().toUpperCase();
    const horas   = parseFloat(celdaHoras.v) || 0;
    const nivelFormacion = (celdaNivelFormacion && celdaNivelFormacion.v) ? celdaNivelFormacion.v.toString().trim() : "";

    if (codProg === codigoProgramaGlobal.trim()) {
      horasDisenoMap[comp] = horas;
      filasCargadas++;

      // Guardar el primer nivel de formación que encontremos para este programa
      if (nivelFormacion && !nivelFormacionGlobal) {
        nivelFormacionGlobal = nivelFormacion;
      }
    }

    fila++;
  }

  // Guardar total de competencias del programa (archivo 3)
  totalCompetenciasPrograma = Object.keys(horasDisenoMap).length;

  // Actualizar tabla en Reporte 2
  const tbody = document.getElementById("tbodyReporte2");
  const filas = tbody ? tbody.getElementsByTagName("tr") : [];

  // Acumuladores
  let totalHorasProgramadas           = 0;
  let totalHorasDisenoDesdeArchivo    = 0;

  // Sumar horas programadas (columna Total de Horas)
  const filasReporte2 = document.querySelectorAll("#tbodyReporte2 tr");
  filasReporte2.forEach(filaHtml => {
    const horasProg = parseFloat(filaHtml.cells[2]?.textContent) || 0;
    totalHorasProgramadas += horasProg;
  });

  // Sumar horas de diseño desde el archivo
  for (const horas of Object.values(horasDisenoMap)) {
    totalHorasDisenoDesdeArchivo += horas;
  }

  // Mostrar totales en el pie de tabla
  const tfoot = document.getElementById("tfootReporte2");
  if (tfoot) {
    tfoot.innerHTML = `
      <tr>
        <td colspan="2" style="text-align:right; font-weight:bold;">Totales:</td>
        <td style="font-weight:bold;">${totalHorasProgramadas.toFixed(2)}</td>
        <td style="font-weight:bold;">${totalHorasDisenoDesdeArchivo.toFixed(2)}</td>
        <td style="font-weight:bold;">${
          totalHorasDisenoDesdeArchivo > 0
            ? ((totalHorasProgramadas / totalHorasDisenoDesdeArchivo) * 100).toFixed(2) + '%'
            : '0.00%'
        }</td>
      </tr>
    `;
  }

  // Actualizar Horas Diseño y % fila a fila
  const dataPointsProgramadas = [];
  const dataPointsDiseno      = [];

  let haySuperadas = false;
  let numeroCompetenciasSobrecargadas = 0;  // NUEVO
  for (let i = 0; i < filas.length; i++) {
    const filaHtml = filas[i];
    const celdas   = filaHtml.getElementsByTagName("td");

    if (celdas.length >= 3) {
      const comp             = celdas[1].textContent.trim().toUpperCase();
      const horasProgramadas = parseFloat(celdas[2].textContent) || 0;
      const horasDiseno      = horasDisenoMap[comp] || 0;

      let porcentajeNumero = 0;
      let porcentajeTexto  = "—";

      if (horasDiseno > 0) {
        porcentajeNumero = (horasProgramadas / horasDiseno) * 100;
        porcentajeTexto  = porcentajeNumero.toFixed(2) + "%";
      }

      celdas[3].textContent = horasDiseno.toFixed(2);
      celdas[4].textContent = porcentajeTexto;

      // Resaltar en rojo claro las filas que superen el 100 %
           if (porcentajeNumero > 100) {
        filaHtml.classList.add("textoRojo");
        haySuperadas = true;
        numeroCompetenciasSobrecargadas++;   // NUEVO
      } else {
        filaHtml.classList.remove("textoRojo");
      }

    }
  }
  // Actualizar Nº competencias sobrecargadas en el encabezado
  const spanCompSobrecargadas = document.getElementById("numCompetenciasSobrecargadasHeader");
  if (spanCompSobrecargadas) {
    spanCompSobrecargadas.textContent = numeroCompetenciasSobrecargadas.toString();
  }

  // Mostrar / ocultar la nota debajo del título del gráfico
  const nota = document.getElementById("notaCompetenciasHoras");
  if (nota) {
    if (haySuperadas) {
      nota.style.display = "block";
      nota.textContent   =
        "Las competencias resaltadas en rojo es porque superaron la cantidad " +
        "de horas establecidas en el diseño curricular, favor no programar más.";
    } else {
      nota.style.display = "none";
      nota.textContent   = "";
    }
  }

  // Actualizar el nombre del programa para incluir el nivel de formación
  const nombreProgramaEl = document.getElementById("nombrePrograma");
  if (nombreProgramaEl && nivelFormacionGlobal) {
    const nombreActual = nombreProgramaEl.textContent;
    nombreProgramaEl.textContent = `${nivelFormacionGlobal} - ${nombreActual}`;
  }


  // Dibujar gráfico % Competencias con Horas (Total vs Diseño)
  dibujarGraficoCompetenciasHoras();

  return filasCargadas;
}


    // =========================
    // Función para generar el Cronograma Gantt de Competencias Pendientes en Reporte 4
    // =========================
    function generarGanttPendientes(arrComp2) {
      let pendientesOrden = arrComp2.filter(obj => obj.programada === "No");
      // Calcular la última fecha de fin programada de registrosGlobal
      let ultimaFechaProg = null;
      registrosGlobal.forEach(r => {
        if(r.fechaFinProg) {
          let f = parseFecha(r.fechaFinProg);
          if(!ultimaFechaProg || f > ultimaFechaProg) {
            ultimaFechaProg = f;
          }
        }
      });
      // Iniciar pendientes en el mes siguiente
      let inicioPendientes = new Date(ultimaFechaProg.getFullYear(), ultimaFechaProg.getMonth(), 1);
      inicioPendientes.setMonth(inicioPendientes.getMonth() + 1);

      // Límite: mes de inicio de la etapa productiva
      const limitePendientes = new Date(
        fechaInicioProductivaGlobal.getFullYear(), 
        fechaInicioProductivaGlobal.getMonth(), 
        1
      );

      let pendientesTransversales = [];
      let pendientesTecnicas = [];
      let pendientePractica = null;

      pendientesOrden.forEach(obj => {
        if(obj.comp.toUpperCase().includes("ETAPA PRACTICA")) {
          pendientePractica = { nombre: "RESULTADOS DE APRENDIZAJE ETAPA PRACTICA" };
        } else {
          let cat = getCategoria(obj.comp);
          if(cat === "Transversales") {
            pendientesTransversales.push({ nombre: obj.comp });
          } else {
            pendientesTecnicas.push({ nombre: obj.comp });
          }
        }
      });

      // Asignar intervalos a transversales (1 mes cada uno hasta 3 por mes)
      let pointerTransversal = new Date(inicioPendientes);
      let countInMonthTransversal = 0;
      pendientesTransversales.forEach(entry => {
        if(pointerTransversal > limitePendientes) {
          entry.inicio = new Date(limitePendientes);
          entry.fin = new Date(limitePendientes);
        } else {
          entry.inicio = new Date(pointerTransversal);
          entry.fin = new Date(pointerTransversal);
          countInMonthTransversal++;
          if(countInMonthTransversal === 3) {
            pointerTransversal.setMonth(pointerTransversal.getMonth() + 1);
            countInMonthTransversal = 0;
          }
          if(pointerTransversal > limitePendientes) {
            pointerTransversal = new Date(limitePendientes);
          }
        }
      });

      // Asignar intervalos a técnicas (bloque de 3 meses)
      let pointerTecnica = new Date(inicioPendientes);
      pendientesTecnicas.forEach(entry => {
        const mesesDisponibles = 
          (limitePendientes.getFullYear() - pointerTecnica.getFullYear()) * 12 +
          (limitePendientes.getMonth() - pointerTecnica.getMonth()) + 1;
        let duracion = 3;
        if(mesesDisponibles < 3) {
          duracion = mesesDisponibles;
        }
        if(pointerTecnica > limitePendientes) {
          entry.inicio = new Date(limitePendientes);
          entry.fin = new Date(limitePendientes);
        } else {
          entry.inicio = new Date(pointerTecnica);
          entry.fin = new Date(
            pointerTecnica.getFullYear(), 
            pointerTecnica.getMonth() + (duracion - 1), 
            1
          );
          pointerTecnica.setMonth(pointerTecnica.getMonth() + duracion);
          if(pointerTecnica > limitePendientes) {
            pointerTecnica = new Date(limitePendientes);
          }
        }
      });

      // Etapa práctica: 7 meses desde el inicio productiva
      if(pendientePractica) {
        pendientePractica.inicio = fechaInicioProductivaGlobal;
        pendientePractica.fin = new Date(
          fechaInicioProductivaGlobal.getFullYear(),
          fechaInicioProductivaGlobal.getMonth() + 7 - 1,
          1
        );
      }

      let programacionPendientes = [].concat(pendientesTransversales, pendientesTecnicas);
      if(pendientePractica) {
        programacionPendientes.push(pendientePractica);
      }

      // Generar rango de meses
      let etiquetasMeses = [];
      let cursor = new Date(inicioPendientes.getFullYear(), inicioPendientes.getMonth(), 1);
      let finMes = new Date(limitePendientes.getFullYear(), limitePendientes.getMonth(), 1);
      while(cursor <= finMes) {
        etiquetasMeses.push(new Date(cursor));
        cursor.setMonth(cursor.getMonth() + 1);
      }
      const mesesAbrev = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
      let html = "<table style='width:100%; border-collapse: collapse;'>";
      html += "<thead><tr>";
      html += "<th style='border: 1px solid #ccc;'>#</th>";
      html += "<th style='border: 1px solid #ccc;'>Competencia</th>";

      etiquetasMeses.forEach(m => {
        let label = mesesAbrev[m.getMonth()] + "-" + m.getFullYear();
        html += "<th style='border: 1px solid #ccc;'>" + label + "</th>";
      });
      html += "</tr></thead><tbody>";

      let index = 1;
      programacionPendientes.forEach(entry => {
        html += "<tr>";
        html += `<td style='border: 1px solid #ccc; text-align:center;'>${index++}</td>`;
        html += `<td style='border: 1px solid #ccc;'>${entry.nombre}</td>`;
        etiquetasMeses.forEach(m => {
          let cellStyle = "border: 1px solid #ccc; text-align: center;";
          let cellContent = "&nbsp;";
          let year = m.getFullYear(), month = m.getMonth();

          let startYear = entry.inicio.getFullYear(), startMonth = entry.inicio.getMonth();
          let endYear = entry.fin.getFullYear(), endMonth = entry.fin.getMonth();
          if ((year > startYear || (year === startYear && month >= startMonth)) &&
              (year < endYear || (year === endYear && month <= endMonth))) {
            cellStyle += " background-color: red;";
            cellContent = "X";
          }
          html += `<td style='${cellStyle}'>${cellContent}</td>`;
        });
        html += "</tr>";
      });
      html += "</tbody></table>";

      document.getElementById("ganttContainerPendientes").innerHTML = html;
    }

    // =========================
    // Generar Reporte 5: Competencias Pendientes por Evaluar agrupado por categoría
    // =========================
    function generarReporte5() {
      const categoriasProg = { "Práctica": [], "Transversales": [], "Inglés": [], "Técnicas": [] };
      Object.values(gruposProgramadas).forEach(grupo => {
        const cat = getCategoria(grupo.competencia);
        categoriasProg[cat].push(grupo);
      });

      const tbodyProg = document.getElementById("tbodyProgramadas");
      tbodyProg.innerHTML = "";
      let contProg = 1;
      const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];
      ordenCategorias.forEach(cat => {
        if(categoriasProg[cat].length > 0) {
          let headerRow = document.createElement("tr");
          headerRow.innerHTML = `<td colspan="5" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
          tbodyProg.appendChild(headerRow);

          categoriasProg[cat].forEach(grupo => {
            let nombresArray = Array.from(grupo.nombres).sort();
            let cantidad = nombresArray.length;
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${contProg++}</td>
              <td>${grupo.competencia}</td>
              <td>${grupo.rap}</td>
              <td>${nombresArray.join(", ")}</td>
              <td>${cantidad}</td>
            `;
            tbodyProg.appendChild(tr);
          });
        }
      });

      const categoriasPend = { "Práctica": [], "Transversales": [], "Inglés": [], "Técnicas": [] };
      Object.values(gruposPendientes).forEach(grupo => {
        const cat = getCategoria(grupo.competencia);
        categoriasPend[cat].push(grupo);
      });

      const tbodyPend = document.getElementById("tbodyPendientes");
      tbodyPend.innerHTML = "";
      let contPend = 1;
      ordenCategorias.forEach(cat => {
        if(categoriasPend[cat].length > 0) {
          let headerRow = document.createElement("tr");
          headerRow.innerHTML = `<td colspan="5" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
          tbodyPend.appendChild(headerRow);

          categoriasPend[cat].forEach(grupo => {
            let nombresArray = Array.from(grupo.nombres).sort();
            let cantidad = nombresArray.length;
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${contPend++}</td>
              <td>${grupo.competencia}</td>
              <td>${grupo.rap}</td>
              <td>${nombresArray.join(", ")}</td>
              <td>${cantidad}</td>
            `;
            tbodyPend.appendChild(tr);
          });
        }
      });
    }

    // =========================
    // Reporte 8: resumen + una tabla por aprendiz
    // =========================
    function generarReporte8PendientesPorAprendizInstructor() {
      // Normaliza texto: mayúsculas, sin tildes, sin espacios extra
      const normalizarTexto = (texto) => {
        return (texto || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase()
          .trim()
          .replace(/\s+/g, " ");
      };
      // Obtiene TODOS los nombres de funcionario(s) que evaluaron (sin cédula ni prefijos)
const obtenerNombresDesdeFuncionario = (funcionario) => {
    if (!funcionario) return [];
    const texto = funcionario.toString();
    const nombres = [];

    // Separa por coma cada funcionario
    texto.split(",").forEach(fragmento => {
        // De cada fragmento toma lo que va después del último "-"
        const nombreParte = fragmento.split("-").pop();
        const nombreNormalizado = normalizarTexto(nombreParte);
        if (nombreNormalizado) {
            nombres.push(nombreNormalizado);
        }
    });

    return nombres;
};


      // Competencia objetivo del resumen
      const claveResultadosPractica = normalizeCompetencia("RESULTADOS DE APRENDIZAJE ETAPA PRACTICA");

      // Determina si una competencia está programada (misma lógica que Reporte 4)
      const esCompetenciaProgramada = (compTexto) => {
        if (!compTexto) return false;

        const compNorm = normalizeCompetencia(compTexto);
        let programada = competenciasSetNormalizado.has(compNorm) ? "Sí" : "No";

        // Regla especial de protección ambiental
        if (compNorm.includes("APLICAR PRACTICAS DE PROTECCION AMBIENTAL")) {
          let horas = 0;
          for (const [compRaw, total] of Object.entries(competenciasMap)) {
            if (normalizeCompetencia(compRaw) === compNorm) {
              horas = total;
              break;
            }
          }
          if (horas < 40) {
            programada = "No";
          }
        }
        return programada === "Sí";
      };

      // 1) Filtrar juicios: solo EN FORMACION o CONDICIONADO y POR EVALUAR
      const filtrados = registrosJuicios.filter(r => {
        const estadoN = normalizarTexto(r.estado);
        const juicioN = normalizarTexto(r.juicioEval);

        return (
          (estadoN === "EN FORMACION" || estadoN === "CONDICIONADO") &&
          juicioN === "POR EVALUAR"
        );
      });

      // 1A) Para el RESUMEN: mapa de TODAS las competencias pendientes por aprendiz
      // (SIN filtrar por programadas)
      const mapaPendientesResumen = {}; // claveAprendiz -> { nombreCompleto, comps: Set(normalizadas) }

      filtrados.forEach(r => {
        const numDoc = r.numDoc || "";
        const nombreCompleto = ((r.nombre || "") + " " + (r.apellidos || "")).trim();
        const claveAprendiz = numDoc + "|" + nombreCompleto;

        const compTexto = (r.competencia || "").trim();
        if (!compTexto) return;
        const compNorm = normalizeCompetencia(compTexto);
        if (!compNorm) return;

        if (!mapaPendientesResumen[claveAprendiz]) {
          mapaPendientesResumen[claveAprendiz] = {
            nombreCompleto,
            comps: new Set()
          };
        }
        mapaPendientesResumen[claveAprendiz].comps.add(compNorm);
      });

      // Aprendices que SOLO tienen pendiente RESULTADOS DE APRENDIZAJE ETAPA PRACTICA
      const nombresSoloPractica = [];
      Object.values(mapaPendientesResumen).forEach(item => {
        if (item.comps.size === 1 && item.comps.has(claveResultadosPractica)) {
          nombresSoloPractica.push(item.nombreCompleto);
        }
      });

      // Ordenar nombres para que se vea más organizado
      nombresSoloPractica.sort((a, b) =>
        a.toUpperCase().localeCompare(b.toUpperCase())
      );

      // 2) Mapa Competencia -> Instructores (desde el primer archivo)
      const mapaInstructoresPorComp = {};
      (registrosGlobal || []).forEach(reg => {
        const compKey = normalizeCompetencia(reg.competencia || "");
        if (!compKey) return;

        if (!mapaInstructoresPorComp[compKey]) {
          mapaInstructoresPorComp[compKey] = new Set();
        }

        const nombreInst = (
          (reg.nombreInstructor || "") + " " + (reg.apellidoInstructor || "")
        ).trim();

        if (nombreInst) {
          mapaInstructoresPorComp[compKey].add(nombreInst);
        }
      });

      // 2A) Mapa Competencia -> Funcionarios que han evaluado (desde el archivo de juicios)
     // 2A) Mapa Competencia -> Funcionarios que han evaluado (desde el archivo de juicios)
const mapaFuncionariosPorComp = {};
(registrosJuicios || []).forEach(reg => {
    const compKeyJ = normalizeCompetencia(reg.competencia || "");
    if (!compKeyJ) return;

    // Ahora puede haber varios funcionarios en la misma celda
    const nombresNorm = obtenerNombresDesdeFuncionario(reg.funcionario || "");
    if (nombresNorm.length === 0) return;

    if (!mapaFuncionariosPorComp[compKeyJ]) {
        mapaFuncionariosPorComp[compKeyJ] = new Set();
    }

    nombresNorm.forEach(nombre => {
        mapaFuncionariosPorComp[compKeyJ].add(nombre);
    });
});


      // 2B) Competencias donde existe al menos un funcionario
      //     diferente a los instructores programados
      const mapaCompConFuncionarioNoProgramado = {};
      Object.keys(mapaFuncionariosPorComp).forEach(compKeyJ => {
        const funcionariosSet = mapaFuncionariosPorComp[compKeyJ];
        const progSet = mapaInstructoresPorComp[compKeyJ] || new Set();

        // Normalizamos nombres de instructores programados
        const progNormSet = new Set();
        progSet.forEach(nombreInst => {
          progNormSet.add(normalizarTexto(nombreInst));
        });

        for (const funcNorm of funcionariosSet) {
          // Si el funcionario que evaluó NO está entre los programados,
          // marcamos esta competencia como "alerta"
          if (!progNormSet.has(funcNorm)) {
            mapaCompConFuncionarioNoProgramado[compKeyJ] = true;
            break;
          }
        }
      });

      // 3) Pivot por aprendiz, guardando SOLO competencias PROGRAMADAS
      const pivot = {};

      filtrados.forEach(r => {
        const numDoc = r.numDoc || "";
        const nombreCompleto = ((r.nombre || "") + " " + (r.apellidos || "")).trim();
        const claveAprendiz = numDoc + "|" + nombreCompleto;

        const compTexto = (r.competencia || "").trim();
        if (!compTexto) return;

        // Solo competencias programadas para el detalle
        if (!esCompetenciaProgramada(compTexto)) return;

        const compKey = normalizeCompetencia(compTexto);
        if (!compKey) return;

        if (!pivot[claveAprendiz]) {
          pivot[claveAprendiz] = {
            numDoc,
            nombreCompleto,
            competencias: {} // compKey -> { texto }
          };
        }

        // Guardar competencia solo una vez por aprendiz en el detalle
        if (!pivot[claveAprendiz].competencias[compKey]) {
          pivot[claveAprendiz].competencias[compKey] = {
            texto: compTexto
          };
        }
      });

      // 4) Ordenar aprendices por nombre para el detalle
      const filasAprendices = Object.values(pivot).sort((a, b) =>
        a.nombreCompleto.toUpperCase().localeCompare(b.nombreCompleto.toUpperCase())
      );

     // Referencias DOM
const contVisible = document.getElementById("contenedorTablasReporte8");
const contResumen = document.getElementById("contenedorResumenPracticaReporte8");
const tbodyExport = document.getElementById("tbodyReporte8");

// NUEVO: tabla resumen por instructor / competencia
const tbodyPendInstr = document.getElementById("tbodyPendientesInstructorReporte8");
const tablaPendInstr = document.getElementById("tablaPendientesInstructorReporte8");
const tituloPendInstr = document.getElementById("tituloListadoPendientesR8");

if (!contVisible || !contResumen || !tbodyExport) return;

contVisible.innerHTML = "";
contResumen.innerHTML = "";
tbodyExport.innerHTML = "";

if (tbodyPendInstr) tbodyPendInstr.innerHTML = "";
if (tablaPendInstr) tablaPendInstr.style.display = "none";
if (tituloPendInstr) tituloPendInstr.style.display = "none";


      let contador = 1;

           // ========================
      // 4A. Tabla RESUMEN (solo quienes tienen
      // RESULTADOS DE APRENDIZAJE ETAPA PRACTICA pendiente)
      // ========================
     

      // nombresSoloPractica ya viene calculado arriba en procesarReporte8
      if (nombresSoloPractica.length > 0) {
        const cantidadSoloPractica = nombresSoloPractica.length;

        // Tomamos de filasAprendices la info de documento + nombre
        const aprendicesSoloPractica = filasAprendices.filter(a =>
          nombresSoloPractica.includes(a.nombreCompleto)
        );

        // Texto de resumen
        const textoResumen = document.createElement("p");
        textoResumen.className = "texto-resumen-practica";
        textoResumen.textContent =
          `Los siguientes ${cantidadSoloPractica} aprendices son los que finalizaron todas las competencias ` +
          `y solo tienen pendiente la Competencia: RESULTADOS DE APRENDIZAJE ETAPA PRACTICA`;
        contResumen.appendChild(textoResumen);

        // Tabla tipo lista con checkboxes
        const tablaResumen = document.createElement("table");
        tablaResumen.className = "tabla-resumen-practica";

        const thead = document.createElement("thead");
        const trHead = document.createElement("tr");

        const thChk = document.createElement("th");
        const chkTodos = document.createElement("input");
        chkTodos.type = "checkbox";
        chkTodos.id = "chkResumenPracticaTodos";
        thChk.appendChild(chkTodos);

        const thNombre = document.createElement("th");
        thNombre.textContent = "Nombre del Aprendiz";

        trHead.appendChild(thChk);
        trHead.appendChild(thNombre);
        thead.appendChild(trHead);
        tablaResumen.appendChild(thead);

        const tbody = document.createElement("tbody");

        aprendicesSoloPractica.forEach((ap, idx) => {
          const tr = document.createElement("tr");
          tr.className = "fila-resumen-practica";
          tr.dataset.index = String(idx);

          const tdChk = document.createElement("td");
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.className = "chk-resumen-practica";
          chk.checked = true;
          tdChk.appendChild(chk);

          const tdNombre = document.createElement("td");
          tdNombre.textContent = ap.nombreCompleto;
          tdNombre.className = "col-nombre-resumen";

          tr.appendChild(tdChk);
          tr.appendChild(tdNombre);
          tbody.appendChild(tr);
        });

        tablaResumen.appendChild(tbody);
        contResumen.appendChild(tablaResumen);

        // Seleccionar / deseleccionar todos
        chkTodos.addEventListener("change", () => {
          const checks = tablaResumen.querySelectorAll(".chk-resumen-practica");
          checks.forEach(chk => {
            chk.checked = chkTodos.checked;
          });
        });

        // Contenedor del botón
        const contBoton = document.createElement("div");
        contBoton.style.marginTop = "12px";
        contBoton.style.textAlign = "right";

        const btnPaz = document.createElement("button");
        btnPaz.id = "btnDescargarPazYSalvo";
        btnPaz.textContent = "Descargar paz y salvo";
        btnPaz.className = "btnEstilo"; // reutiliza el estilo de botones que ya tienes

        contBoton.appendChild(btnPaz);
        contResumen.appendChild(contBoton);

        // Click en "Descargar paz y salvo"
        btnPaz.addEventListener("click", () => {
          const seleccionados = [];
          const filasTabla = tablaResumen.querySelectorAll("tbody tr.fila-resumen-practica");

          filasTabla.forEach(fila => {
            const chk = fila.querySelector(".chk-resumen-practica");
            const indexStr = fila.dataset.index;
            const index = indexStr ? parseInt(indexStr, 10) : NaN;

            if (chk && chk.checked && !Number.isNaN(index) && aprendicesSoloPractica[index]) {
              seleccionados.push({
                nombreCompleto: aprendicesSoloPractica[index].nombreCompleto,
                numDoc: aprendicesSoloPractica[index].numDoc
              });
            }
          });

          // Si no se marcó ninguno, se usan todos los de la lista
          const listaFinal = seleccionados.length > 0
            ? seleccionados
            : aprendicesSoloPractica.map(ap => ({
                nombreCompleto: ap.nombreCompleto,
                numDoc: ap.numDoc
              }));

          if (!listaFinal.length) {
            alert("No hay aprendices seleccionados para generar el paz y salvo.");
            return;
          }

          generarPazYSalvoPDF(listaFinal);
        });

      } else {
        const textoSinDatos = document.createElement("p");
        textoSinDatos.className = "texto-resumen-practica";
        textoSinDatos.textContent =
          "No hay aprendices que tengan únicamente la competencia de etapa práctica pendiente.";
        contResumen.appendChild(textoSinDatos);
      }

      // ========================
      // 4B. Tabla ÚNICA (visible) + detalle para exportar
      //      - Una sola tabla
      //      - Sin encabezados repetidos
      //      - Nombre y documento NO combinados (se repiten por fila)
      // ========================

      // Crear una sola tabla visible
      const tablaUnica = document.createElement("table");
      tablaUnica.className = "tabla-aprendiz-reporte8";

      const theadUnico = document.createElement("thead");
      theadUnico.innerHTML = `
        <tr>
          <th>#</th>
          <th>Documento</th>
          <th>Nombre del Aprendiz</th>
          <th>Competencias Pendientes por Evaluar</th>
          <th>Instructor que impartió la competencia</th>
        </tr>
      `;
      tablaUnica.appendChild(theadUnico);

      const tbodyUnico = document.createElement("tbody");

      // Recorremos todos los aprendices y TODAS sus competencias pendientes
      filasAprendices.forEach(aprendiz => {
        const competenciasArray = Object.entries(aprendiz.competencias); // [ [compKey, {texto}], ... ]
        if (competenciasArray.length === 0) return;

        competenciasArray.forEach(([compKey, compObj]) => {
          const instSet = mapaInstructoresPorComp[compKey];
          const instructoresStr = instSet ? Array.from(instSet).join(", ") : "";

          // --------- Fila VISIBLE en la tabla única ---------
          const tr = document.createElement("tr");

          const tdNum = document.createElement("td");
          tdNum.textContent = contador;

          const tdDoc = document.createElement("td");
          tdDoc.textContent = aprendiz.numDoc;

          const tdNom = document.createElement("td");
          tdNom.textContent = aprendiz.nombreCompleto;

          const tdComp = document.createElement("td");
          tdComp.textContent = compObj.texto;

          const tdInst = document.createElement("td");
          tdInst.textContent = instructoresStr;

          tr.appendChild(tdNum);
          tr.appendChild(tdDoc);
          tr.appendChild(tdNom);
          tr.appendChild(tdComp);
          tr.appendChild(tdInst);

          tbodyUnico.appendChild(tr);

          // --------- Fila OCULTA para EXPORTAR (misma estructura, sin celdas vacías) ---------
          const trExp = document.createElement("tr");
          trExp.innerHTML = `
            <td>${contador}</td>
            <td>${aprendiz.numDoc}</td>
            <td>${aprendiz.nombreCompleto}</td>
            <td>${compObj.texto}</td>
            <td>${instructoresStr}</td>
          `;
          tbodyExport.appendChild(trExp);

          // El consecutivo ahora es por fila, no por aprendiz
          contador++;
        });
      });

      tablaUnica.appendChild(tbodyUnico);
      contVisible.appendChild(tablaUnica);


      // ========================
      // 4C. Resumen por Instructor / Competencia (agrupado y por categorías)
      // ========================
      if (tbodyPendInstr && filasAprendices.length > 0) {
        // Mapa: (instructor(es) normalizado, competenciaKey) -> conjunto de aprendices
        const mapaPorInstructor = {};
        // key: "INSTRUCTOR_NORMALIZADO||compKey"

        filasAprendices.forEach(aprendiz => {
          const nombreAprendiz = aprendiz.nombreCompleto || "";

          Object.entries(aprendiz.competencias).forEach(([compKey, compObj]) => {
            const instSet = mapaInstructoresPorComp[compKey];
            const instructoresStr = instSet && instSet.size > 0
              ? Array.from(instSet).join(", ")
              : "Sin instructor asignado";

            const competenciaTexto = compObj.texto || "";

            // Clave de agrupación normalizada para evitar duplicados visualmente iguales
            const claveGrupo = `${normalizarTexto(instructoresStr)}||${compKey}`;

            if (!mapaPorInstructor[claveGrupo]) {
              mapaPorInstructor[claveGrupo] = {
                instructores: instructoresStr,
                competencia: competenciaTexto,
                competenciaKey: compKey,
                aprendices: new Set()
              };
            } else {
              // Si no teníamos texto "bonito" de competencia, lo actualizamos
              if (!mapaPorInstructor[claveGrupo].competencia && competenciaTexto) {
                mapaPorInstructor[claveGrupo].competencia = competenciaTexto;
              }
            }

            if (nombreAprendiz) {
              mapaPorInstructor[claveGrupo].aprendices.add(nombreAprendiz);
            }
          });
        });

        const filasResumenInstructor = Object.values(mapaPorInstructor);
        if (filasResumenInstructor.length === 0) {
          if (tablaPendInstr) tablaPendInstr.style.display = "none";
          if (tituloPendInstr) tituloPendInstr.style.display = "none";
          return;
        }

        // Agrupamos ahora por categoría (Práctica, Transversales, Inglés, Técnicas)
        const categorias = {
          "Práctica": [],
          "Transversales": [],
          "Inglés": [],
          "Técnicas": []
        };

                filasResumenInstructor.forEach(item => {
          const textoComp = item.competencia || item.competenciaKey || "";

          // Obtenemos la clave de competencia que se usa en los mapas
          const compKeyItem = item.competenciaKey || normalizeCompetencia(textoComp);

          // Marcamos si para esta competencia hay evaluaciones hechas por
          // un funcionario NO programado como instructor
          item.alertaInstructorDiferente = !!mapaCompConFuncionarioNoProgramado[compKeyItem];

          const categoria = getCategoria(textoComp);
          if (!categorias[categoria]) {
            categorias[categoria] = [];
          }
          categorias[categoria].push(item);
        });


        // Limpiamos tbody por si acaso y construimos por secciones
        tbodyPendInstr.innerHTML = "";
        let contadorInstr = 1;
        const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];

        ordenCategorias.forEach(cat => {
          const lista = categorias[cat];
          if (!lista || lista.length === 0) return;

          // Fila de encabezado de categoría
          const headerRow = document.createElement("tr");
          headerRow.innerHTML = `<td colspan="5" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
          tbodyPendInstr.appendChild(headerRow);

          // Ordenamos dentro de la categoría por instructor y competencia
          lista.sort((a, b) => {
            const instA = (a.instructores || "").toUpperCase();
            const instB = (b.instructores || "").toUpperCase();
            if (instA < instB) return -1;
            if (instA > instB) return 1;
            const compA = (a.competencia || "").toUpperCase();
            const compB = (b.competencia || "").toUpperCase();
            return compA.localeCompare(compB);
          });

                    lista.forEach(item => {
            const listaAprendices = Array.from(item.aprendices)


              .sort((a, b) => a.toUpperCase().localeCompare(b.toUpperCase()))
              .join(" - ");

            const tr = document.createElement("tr");

            // Si hubo evaluación de un instructor no programado, resaltar fila
         
            tr.innerHTML = `
              <td>${contadorInstr}</td>
              <td>${item.instructores}</td>
              <td>${item.competencia}</td>
              <td>${listaAprendices}</td>
              <td>${item.aprendices.size}</td>
            `;
            tbodyPendInstr.appendChild(tr);
            contadorInstr++;
          });

    
        });

        const tieneDatos = contadorInstr > 1;
        if (tablaPendInstr) {
          tablaPendInstr.style.display = tieneDatos ? "table" : "none";
        }
        if (tituloPendInstr) {
          tituloPendInstr.style.display = tieneDatos ? "block" : "none";
        }
      } // cierra if (tbodyPendInstr && filasAprendices.length > 0)

    } // cierra function generarReporte8PendientesPorAprendizInstructor

    // =========================
    // Generar Pivot Table para Reporte 6: Análisis de Competencias y Raps
    // =========================
    function generarPivotTableReporte6() {

  // Normaliza texto: mayúsculas, sin tildes, sin espacios extra
  const normalizarTexto = (texto) => {
    return (texto || "")
      .toString()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .trim()
      .replace(/\s+/g, " ");
  };

  // Obtiene TODOS los nombres de funcionario(s) que evaluaron (sin cédula ni prefijos)
  // Ejemplo:
  // "CC 55166952 - NAZLHY SIERRA LEAL, CC 1110481907 - YEISON CASTELLANOS GORDILLO, -"
  //  -> ["NAZLHY SIERRA LEAL", "YEISON CASTELLANOS GORDILLO"]
  const obtenerNombresDesdeFuncionario = (funcionario) => {
    if (!funcionario) return [];
    const texto = funcionario.toString();
    const nombres = [];

    texto.split(",").forEach(fragmento => {
      const nombreParte = fragmento.split("-").pop();
      const nombreNorm = normalizarTexto(nombreParte);
      if (nombreNorm) {
        nombres.push(nombreNorm);
      }
    });

    return nombres;
  };

  // Mapa: competencia normalizada -> set de nombres normalizados de instructores programados
  const mapaProgNormPorComp = {};
  (registrosGlobal || []).forEach(reg => {
    const compKey = normalizeCompetencia(reg.competencia || "");
    if (!compKey) return;

    if (!mapaProgNormPorComp[compKey]) {
      mapaProgNormPorComp[compKey] = new Set();
    }

    const nombreInst = (
      (reg.nombreInstructor || "") + " " + (reg.apellidoInstructor || "")
    ).trim();

    if (nombreInst) {
      mapaProgNormPorComp[compKey].add(normalizarTexto(nombreInst));
    }
  });

  // Filtramos juicios: solo EN FORMACIÓN o CONDICIONADO
  const filtrados = registrosJuicios.filter(r => {
    const estadoU = (r.estado || "").toUpperCase();
    return (estadoU === "EN FORMACION" || estadoU === "CONDICIONADO");
  });

  const grupos = {};
  filtrados.forEach(r => {
    const key = r.competencia + "|" + r.resAprendizaje;
    if (!grupos[key]) {
      grupos[key] = {
        competencia: r.competencia,
        rap: r.resAprendizaje,
        funcionarios: new Set(),        // textos originales (con CC, etc.)
        funcionariosNombres: new Set(), // nombres normalizados
        aprobado: 0,
        porEvaluar: 0,
        noAprobado: 0
      };
    }

    const juicio = (r.juicioEval || "").toUpperCase();
    if (juicio === "APROBADO") {
      grupos[key].aprobado++;
    } else if (juicio === "POR EVALUAR") {
      grupos[key].porEvaluar++;
    } else if (juicio === "NO APROBADO") {
      grupos[key].noAprobado++;
    }

    const nombreFunc = String(r.funcionario || "").trim();
    if (nombreFunc !== "") {
      // Guardamos el texto tal cual para mostrarlo en la tabla
      grupos[key].funcionarios.add(nombreFunc);

      // Y extraemos todos los nombres que hay en ese texto
      const nombresNorm = obtenerNombresDesdeFuncionario(nombreFunc);
      nombresNorm.forEach(n => grupos[key].funcionariosNombres.add(n));
    }
  });

  const arrGrupos = Object.values(grupos);
// NUEVO: actualizar KPI de "Resultados de aprendizaje" con el total general
const totalRaps = arrGrupos.length;
const numResultadosHeaderEl = document.getElementById("numResultadosHeader");
if (numResultadosHeaderEl) {
  numResultadosHeaderEl.textContent = totalRaps;
}
  const categoriasPivot = { "Práctica": [], "Transversales": [], "Inglés": [], "Técnicas": [] };
  arrGrupos.forEach(grupo => {
    const cat = getCategoria(grupo.competencia);
    categoriasPivot[cat].push(grupo);
  });

  const tbody6 = document.getElementById("tbodyReporte6");
  tbody6.innerHTML = "";
  let contador = 1;
  const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];

  ordenCategorias.forEach(cat => {
    if (categoriasPivot[cat].length > 0) {
      let headerRow = document.createElement("tr");
      headerRow.innerHTML = `<td colspan="7" style="background-color:#ccc; font-weight:bold;">${cat}</td>`;
      tbody6.appendChild(headerRow);

      categoriasPivot[cat].forEach(grupo => {
        const total = grupo.aprobado + grupo.porEvaluar + grupo.noAprobado;
        const funcionariosUnicos = Array.from(grupo.funcionarios).join(", ");

        // 1) Clave de competencia para cruzar con los instructores programados
        const compKey = normalizeCompetencia(grupo.competencia || "");
        const progNormSet = mapaProgNormPorComp[compKey] || new Set();

        // 2) Revisar si hay AL MENOS un funcionario no programado
        let alertaInstructorDiferente = false;
        grupo.funcionariosNombres.forEach(funcNorm => {
          if (!progNormSet.has(funcNorm)) {
            alertaInstructorDiferente = true;
          }
        });

        const tr = document.createElement("tr");

        // Amarillo si hay instructor que evaluó y NO estaba programado
        if (alertaInstructorDiferente) {
          tr.classList.add("fila-instructor-diferente");
        }

        // (Opcional) rojo si todos los juicios están POR EVALUAR
        if (grupo.porEvaluar === total) {
          tr.classList.add("rojo");
        }

        tr.innerHTML = `
          <td>${contador++}</td>
          <td>${grupo.competencia}</td>
          <td>${grupo.rap}</td>
          <td>${funcionariosUnicos}</td>
          <td>${grupo.aprobado}</td>
          <td>${grupo.porEvaluar}</td>
          <td>${grupo.noAprobado}</td>
        `;
        tbody6.appendChild(tr);
      });
    }
  });
}


// =========================
// Generar Pivot Table para Reporte 7: % Avance por Aprendiz
// =========================
function generarPivotTableAvancePorAprendiz() {
  // Filtramos juicios solo de aprendices EN FORMACION o CONDICIONADO
  const filtrados = registrosJuicios.filter(r => {
    const estadoU = (r.estado || "").toUpperCase();
    return (estadoU === "EN FORMACION" || estadoU === "CONDICIONADO");
  });

  // Pivot por aprendiz
  const pivot = {};
  filtrados.forEach(r => {
    const key = r.numDoc + "|" + (r.nombre + " " + r.apellidos);
    if (!pivot[key]) {
      pivot[key] = {
        numDoc: r.numDoc,
        nombreCompleto: r.nombre + " " + r.apellidos,
        aprobado: 0,
        porEvaluar: 0
      };
    }

    const juicioEval = (r.juicioEval || "").toLowerCase();
    if (juicioEval === "aprobado") {
      pivot[key].aprobado++;
    } else if (juicioEval === "por evaluar") {
      pivot[key].porEvaluar++;
    }
  });

  let pivotRows = Object.values(pivot);
  pivotRows.sort((a, b) => a.nombreCompleto.localeCompare(b.nombreCompleto));

  const tbody7 = document.getElementById("pivotAvanceContainer");
  if (!tbody7) return;

  tbody7.innerHTML = "";
  let cont7 = 1;

  // Acumuladores para el resumen de la ficha
  let sumaAvance = 0;
  let cantidadConAvance = 0;
  let aprendicesRiesgo = 0;
  const datosFallasUI = [];

  pivotRows.forEach(row => {
    const total = row.aprobado + row.porEvaluar;
    const avanceNum = total > 0 ? (row.aprobado / total) * 100 : 0;
    const avanceTexto = avanceNum.toFixed(2);

    // Fallas tomadas del archivo de inasistencias
    const docNormalizado = normalizarDocumento(row.numDoc);
    const fallas = mapaFallasPorDocumento[docNormalizado] || 0;

    // Fechas de fallas para la columna "Detalles" (ordenadas)
    let detallesFallas = "";
    if (typeof mapaFechasFallasPorDocumento !== "undefined" &&
        Array.isArray(mapaFechasFallasPorDocumento[docNormalizado]) &&
        mapaFechasFallasPorDocumento[docNormalizado].length > 0) {

      const fechasOrdenadas = mapaFechasFallasPorDocumento[docNormalizado]
        .slice()
        .sort((a, b) => {
          const da = parseFecha(a);
          const db = parseFecha(b);
          return da - db; // más antigua primero
        });

      detallesFallas = fechasOrdenadas.join(", ");
    }

    let clase = "";
    if (total > 0 && avanceNum < 75) {
      clase = "textoRojo";
    }
    if (row.porEvaluar === total) {
      clase = "rojo";
    }

    // === Cálculos para el resumen ===
    if (total > 0) {
      sumaAvance += avanceNum;
      cantidadConAvance++;
    }

    // Criterio de riesgo:
    // - Avance < 75%  OR
    // - Muchas fallas (aquí uso >= 3, ajústalo si lo necesitas)
    const esRiesgoPorAvance = (total > 0 && avanceNum < 75);
    const esRiesgoPorFallas = (fallas >= 3);
    if (esRiesgoPorAvance || esRiesgoPorFallas) {
      aprendicesRiesgo++;
    }
    // ===============================

    const tr = document.createElement("tr");
    tr.className = clase;
    tr.innerHTML = `
      <td>${cont7++}</td>
      <td>${row.numDoc}</td>
      <td>${row.nombreCompleto}</td>
      <td>${fallas}</td>
      <td>${detallesFallas}</td>
      <td>${row.aprobado}</td>
      <td>${row.porEvaluar}</td>
      <td>${avanceTexto}%</td>
    `;
    tbody7.appendChild(tr);
  });

  
// Actualizar % avance promedio del grupo + barra
const spanAvancePromedio = document.getElementById("avancePromedioGrupoHeader");
const barraAvance = document.getElementById("avancePromedioGrupoBar");

if (spanAvancePromedio) {
  const promedio = (cantidadConAvance > 0) ? (sumaAvance / cantidadConAvance) : 0;
  const texto = promedio.toFixed(1) + " %";
  spanAvancePromedio.textContent = texto;

  // Rellenar barra en función del porcentaje (0–100)
  if (barraAvance) {
    const valorBarra = Math.max(0, Math.min(100, promedio));
    barraAvance.style.width = valorBarra.toFixed(1) + "%";
  }
}

// Actualizar Nº aprendices con riesgo
const spanAprendicesRiesgo = document.getElementById("numAprendicesRiesgoHeader");
if (spanAprendicesRiesgo) {
  spanAprendicesRiesgo.textContent = aprendicesRiesgo.toString();
}

// Renderizar gráfica de fallas en el reporte (CanvasJS, solo si hay fallas)
const contGraficoFallas = document.getElementById("graficoFallasReporte7Container");
const datosGraf = pivotRows
  .map(r => {
    const doc = (r.numDoc || "").toString();
    const fallas = mapaFallasPorDocumento[normalizarDocumento(doc)] || 0;
    return {
      label: (r.nombreCompleto || "").trim(),
      fallas
    };
  })
  .filter(r => r.fallas > 0);
renderGraficoFallasReporte7(datosGraf);

}



    document.addEventListener("DOMContentLoaded", function () {
      const botonPDF = document.getElementById("btnExportarPDF");
      if (botonPDF) {
        botonPDF.addEventListener("click", function () {
          const checkboxes = document.querySelectorAll(".reporte-checkbox:checked");
          const secciones = Array.from(checkboxes).map(cb => document.getElementById(cb.value));

          const ventana = window.open("", "_blank");
          ventana.document.write("<html><head><title>Reporte SENA</title>");
// Copiar todos los <style> y <link rel="stylesheet"> de la página original
const estilosOriginales = Array
  .from(document.querySelectorAll("style, link[rel='stylesheet']"))
  .map(el => el.outerHTML)
  .join("");

// Inyectar estilos completos en la ventana del PDF
ventana.document.write(estilosOriginales);

// Forzar que el navegador imprima los colores de fondo
ventana.document.write(
  "<style>@media print{body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}}</style>"
);

                    ventana.document.write("</head><body>");

const bloqueEncabezado = construirBloqueEncabezadoExport();
ventana.document.write(bloqueEncabezado);

secciones.forEach(seccion => {
  if (seccion) ventana.document.write(seccion.innerHTML + "<hr/>");
});



          ventana.document.write("</body></html>");
          ventana.document.close();

          setTimeout(() => ventana.print(), 500); // permite que cargue el contenido antes de imprimir
        });
      } else {
        console.warn("❗ No se encontró el botón con id 'btnExportarPDF'");
      }
    });
// Bloque reutilizable para el encabezado de exportación (PDF y Word)
// Bloque reutilizable para el encabezado de exportación (PDF y Word)


function construirBloqueEncabezadoExport() {
  const getText = (id) =>
    (document.getElementById(id)?.textContent || "").trim();

  // Información general de la ficha
  const codigoFicha          = getText("codigoFicha");
  const nombrePrograma       = getText("nombrePrograma");
  const codigoPrograma       = getText("codigoPrograma");

  const fechaInicioLectiva   = getText("fechaInicioLectiva");
  const fechaFinLectiva      = getText("fechaFinLectiva");
  const fechaInicioProd      = getText("fechaInicioProductiva");
  const fechaFinProd         = getText("fechaFinProductiva");

  const numAprendices        = getText("numAprendicesHeader");
  const numInstructores      = getText("numInstructoresHeader");
  const numCompetencias      = getText("numCompetenciasHeader");
const numResultados        = getText("numResultadosHeader"); // NUEVO

  const instructorGerente    = getText("instructorMasHorasHeader");
  const coordinadorAcademico = getText("coordinadorAcademicoHeader");

  // Análisis de rendimiento
  const avancePromedio    = getText("avancePromedioGrupoHeader");
  const compSobrecargadas = getText("numCompetenciasSobrecargadasHeader");
  const aprendicesRiesgo  = getText("numAprendicesRiesgoHeader");

  // Detalle de aprendices
  const totalAprendicesEstado = getText("totalAprendicesEstado");
  const tablaEstadoHTML =
    document.getElementById("tablaEstado")?.outerHTML || "";

  return `
    <!-- Encabezado institucional -->
    <div style="display:flex; align-items:center; margin-bottom:8px;">
      <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png"
           style="max-width:60px; margin-right:10px;">
      <div>
        <div style="font-weight:bold; font-size:12pt;">
          Servicio Nacional de Aprendizaje - SENA Regional Tolima
        </div>
        <div style="font-size:10pt;">
          Centro de Comercio y Servicios
        </div>
        <div style="font-size:9pt; margin-top:2px;">
          SENA 360 – Panel Integral de Seguimiento a la FPI
        </div>
      </div>
    </div>

    <!-- Información general de la ficha -->
    <div style="margin-bottom:8px;">
      <table style="width:100%; border-collapse:collapse;">
        <tr>
          <td><strong>CÓDIGO FICHA:</strong> ${codigoFicha}</td>
          <td><strong>NOMBRE DEL PROGRAMA:</strong> ${nombrePrograma}</td>
        </tr>
        <tr>
          <td colspan="2"><strong>CÓDIGO DEL PROGRAMA:</strong> ${codigoPrograma}</td>
        </tr>
        <tr>
          <td colspan="2" style="padding-top:4px;"><strong>PERÍODOS</strong></td>
        </tr>
        <tr>
          <td><strong>Etapa Lectiva:</strong> ${fechaInicioLectiva} - ${fechaFinLectiva}</td>
          <td><strong>Etapa Productiva:</strong> ${fechaInicioProd} - ${fechaFinProd}</td>
        </tr>
        <tr>
          <td><strong>Cantidad de APRENDICES:</strong> ${numAprendices}</td>
          <td><strong>Cantidad de INSTRUCTORES:</strong> ${numInstructores}</td>
        </tr>
        <tr>
         <td><strong>Cantidad de COMPETENCIAS:</strong> ${numCompetencias}</td>
  <td><strong>Cantidad de RESULTADOS DE APRENDIZAJE:</strong> ${numResultados}</td>
          <td></td>
        </tr>
        <tr>
          <td><strong>Aprendiz Vocero:</strong> ${aprendizVoceroSeleccionado}</td>
<td><strong>Instructor Gerente de Proyecto:</strong> ${instructorGerente}</td>
          <td><strong>Coordinador Académico:</strong> ${coordinadorAcademico}</td>
        </tr>
      </table>
    </div>

    <!-- Análisis de rendimiento -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>ANÁLISIS DE RENDIMIENTO</strong>
      <ul style="margin:4px 0 0 16px; padding:0;">
        <li>Avance promedio del grupo: ${avancePromedio}</li>
        <li>Competencias sobrecargadas: ${compSobrecargadas}</li>
        <li>Aprendices con avance &lt; 75%: ${aprendicesRiesgo}</li>
      </ul>
    </div>

    <!-- Detalle de aprendices -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>DETALLE DE APRENDICES</strong>
      <div style="margin-top:2px; font-size:12pt;">Total Aprendices Matriculados: ${totalAprendicesEstado}</div>
      ${tablaEstadoHTML}
    </div>

    <hr style="margin:10px 0;">
  `;
}

// Versión del encabezado para Word (sin logo)
function construirBloqueEncabezadoExportWord() {
  const getText = (id) =>
    (document.getElementById(id)?.textContent || "").trim();

  // Información general de la ficha
  const codigoFicha          = getText("codigoFicha");
  const nombrePrograma       = getText("nombrePrograma");
  const codigoPrograma       = getText("codigoPrograma");

  const fechaInicioLectiva   = getText("fechaInicioLectiva");
  const fechaFinLectiva      = getText("fechaFinLectiva");
  const fechaInicioProd      = getText("fechaInicioProductiva");
  const fechaFinProd         = getText("fechaFinProductiva");

  const numAprendices        = getText("numAprendicesHeader");
  const numInstructores      = getText("numInstructoresHeader");
  const numCompetencias      = getText("numCompetenciasHeader");
const numResultados        = getText("numResultadosHeader"); // NUEVO


  const instructorGerente    = getText("instructorMasHorasHeader");
  const coordinadorAcademico = getText("coordinadorAcademicoHeader");

  // Análisis de rendimiento
  const avancePromedio       = getText("avancePromedioGrupoHeader");
  const compSobrecargadas    = getText("numCompetenciasSobrecargadasHeader");
  const aprendicesRiesgo     = getText("numAprendicesRiesgoHeader");

  // Detalle de aprendices
  const totalAprendicesEstado = getText("totalAprendicesEstado");
  const tablaEstadoHTML =
    document.getElementById("tablaEstado")?.outerHTML || "";

  return `
    <!-- Encabezado institucional (sin logo para Word) -->
    <div style="margin-bottom:8px;">
      <div style="font-weight:bold; font-size:12pt;">
        Servicio Nacional de Aprendizaje - SENA Regional Tolima
      </div>
      <div style="font-size:10pt;">
        Centro de Comercio y Servicios
      </div>
      <div style="font-size:9pt; margin-top:2px;">
        SENA 360 – Panel Integral de Seguimiento a la FPI
      </div>
    </div>

    <!-- Información general de la ficha -->
    <div style="margin-bottom:8px;">
      <table style="width:100%; border-collapse:collapse;">
        <tr>
          <td><strong>CÓDIGO FICHA:</strong> ${codigoFicha}</td>
          <td><strong>NOMBRE DEL PROGRAMA:</strong> ${nombrePrograma}</td>
        </tr>
        <tr>
          <td colspan="2"><strong>CÓDIGO DEL PROGRAMA:</strong> ${codigoPrograma}</td>
        </tr>
        <tr>
          <td colspan="2" style="padding-top:4px;"><strong>PERÍODOS</strong></td>
        </tr>
        <tr>
          <td><strong>Etapa Lectiva:</strong> ${fechaInicioLectiva} - ${fechaFinLectiva}</td>
          <td><strong>Etapa Productiva:</strong> ${fechaInicioProd} - ${fechaFinProd}</td>
        </tr>
     <tr>
  <td><strong>Cantidad de APRENDICES:</strong> ${numAprendices}</td>
  <td><strong>Cantidad de INSTRUCTORES:</strong> ${numInstructores}</td>
</tr>
<tr>
  <td><strong>Cantidad de COMPETENCIAS:</strong> ${numCompetencias}</td>
  <td><strong>Cantidad de RESULTADOS DE APRENDIZAJE:</strong> ${numResultados}</td>
</tr>

        <tr>
<td><strong>Aprendiz Vocero:</strong> ${aprendizVoceroSeleccionado}</td>
          <td><strong>Instructor Gerente de Proyecto:</strong> ${instructorGerente}</td>
          <td><strong>Coordinador Académico:</strong> ${coordinadorAcademico}</td>
        </tr>
      </table>
    </div>

    <!-- Análisis de rendimiento -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>ANÁLISIS DE RENDIMIENTO</strong>
      <ul style="margin:4px 0 0 16px; padding:0;">
        <li>Avance promedio del grupo: ${avancePromedio}</li>
        <li>Competencias sobrecargadas: ${compSobrecargadas}</li>
        <li>Aprendices con avance &lt; 75%: ${aprendicesRiesgo}</li>
      </ul>
    </div>

    <!-- Detalle de aprendices -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>DETALLE DE APRENDICES</strong>
      <div style="margin-top:2px;">Total Aprendices que iniciaron: ${totalAprendicesEstado}</div>
      ${tablaEstadoHTML}
    </div>

    <hr style="margin:10px 0;">
  `;
}


// =========================
// Exportar Acta de Comité a Word
// =========================
function exportarActaComiteWord() {
  const getText = (id) =>
    (document.getElementById(id)?.textContent || "").trim();

  // Datos existentes de la ficha
  const nombrePrograma    = getText("nombrePrograma") || "____________________";
  const codigoFicha       = getText("codigoFicha") || "__________";
  const instructorGerente = getText("instructorMasHorasHeader") || "____________________";
const coordinadorAcademico = getText("coordinadorAcademicoHeader") || "Nombre Coordinador Académico";
const aprendizVocero       = getText("aprendizVoceroHeader")       || "Nombre Aprendiz Vocero";
const nivelFormacionActa = nivelFormacionGlobal ? `${nivelFormacionGlobal} - ` : "";
const avancePromedioGrupo = getText("avancePromedioGrupoHeader") || "0 %";
const numCompetencias     = getText("numCompetenciasHeader")     || "0";
const numResultados        = getText("numResultadosHeader")       || "0";
    // 3. Datos de aprendices para el acta
  const totalAprendicesEstado = getText("totalAprendicesEstado") || "0";
  const datosFallasAprendices = [];

  // Gráfico circular de estados (CanvasJS) para incrustar en el acta
  if (estadoChart && typeof estadoChart.render === "function") {
    try {
      estadoChart.render();
    } catch (err) {
      console.warn("No se pudo renderizar el grafico de estados antes de exportar el acta", err);
    }
  }
  const graficoEstadosDataURL = capturarGraficoComoImg(".estado-chart-wrapper");
  const graficoEstadoActaHTML = construirGraficoActaHTML(
    graficoEstadosDataURL,
    "Distribución de estados de aprendices",
    "<em>(No se pudo capturar el grafico de estados al momento de generar el acta.)</em>"
  );

  // Gráfico de competencias vs diseño (CanvasJS) para la sección 2.4.1
  if (chartCompetenciasHoras && typeof chartCompetenciasHoras.render === "function") {
    try {
      chartCompetenciasHoras.render();
    } catch (err) {
      console.warn("No se pudo renderizar el grafico de competencias antes de exportar el acta", err);
    }
  }
  const graficoCompetenciasDataURL = capturarGraficoComoImg("#chartCompetenciasHorasContainer");
  const graficoCompetenciasActaHTML = construirGraficoActaHTML(
    graficoCompetenciasDataURL,
    "Avance por competencia (horas vs diseño)",
    "<em>(No se pudo capturar el grafico de competencias al momento de generar el acta.)</em>"
  );

  // Gráfico de Total de Horas Programadas por Instructor (CanvasJS) para el acta
  if (chartHorasInstructores && typeof chartHorasInstructores.render === "function") {
    try {
      chartHorasInstructores.render();
    } catch (err) {
      console.warn("No se pudo renderizar el grafico de horas por instructor antes de exportar el acta", err);
    }
  }
  const graficoHorasInstructoresDataURL = capturarGraficoComoImg("#chartInstructoresHorasContainer");
  const graficoHorasInstructoresActaHTML = construirGraficoActaHTML(
    graficoHorasInstructoresDataURL,
    "Total de horas programadas por instructor",
    "<em>(No se pudo capturar el grafico de horas por instructor al momento de generar el acta.)</em>"
  );

  // 3.1 – Detalle de Aprendices (tabla de estados)
  let tablaDetalleAprendicesHTML = "";
  const tablaEstadoElem = document.getElementById("tablaEstado");
  if (tablaEstadoElem) {
    const cloneEstado = tablaEstadoElem.cloneNode(true);

    // Evitar ids duplicados
    cloneEstado.removeAttribute("id");
    const tbodyEstado = cloneEstado.querySelector("#tbodyEstado");
    if (tbodyEstado) tbodyEstado.removeAttribute("id");

    // Misma lógica de distribución que las tablas de instructores
    cloneEstado.classList.add("tabla-estado-aprendices");
    cloneEstado.style.width = "85%";
    cloneEstado.style.borderCollapse = "collapse";
    cloneEstado.style.tableLayout = "fixed";
    cloneEstado.style.marginTop = "4px";
    cloneEstado.style.marginLeft = "auto";
    cloneEstado.style.marginRight = "auto";

    // Definir anchos de columnas: Estado / Nombres / Cant / %
    const oldCg = cloneEstado.querySelector("colgroup");
    if (oldCg) oldCg.remove();

    const colgroup = document.createElement("colgroup");
    ["18%", "57%", "10%", "15%"].forEach((w) => {
      const col = document.createElement("col");
      col.style.width = w;
      colgroup.appendChild(col);
    });
    cloneEstado.insertBefore(colgroup, cloneEstado.firstElementChild);

    tablaDetalleAprendicesHTML = cloneEstado.outerHTML;
  }

  // 3.2 – % Avance por Aprendiz y Fallas
  let tablaAvanceAprendicesHTML = "";
  const pivotBody = document.getElementById("pivotAvanceContainer");
  if (pivotBody && typeof pivotBody.closest === "function") {
    const tablaAvanceElem = pivotBody.closest("table");

    // Recolectar datos de fallas para la gráfica (solo aprendices con fallas > 0)
    const datosFallasParaGrafico = [];
    pivotBody.querySelectorAll("tr").forEach((tr) => {
      const celdas = tr.querySelectorAll("td");
      if (celdas.length >= 4) {
        const fallas = parseFloat((celdas[3].textContent || "").replace(",", ".") || "0");
        if (fallas > 0) {
          datosFallasParaGrafico.push({
            label: (celdas[2].textContent || "").trim(),
            fallas
          });
          datosFallasAprendices.push({
            doc: (celdas[1].textContent || "").trim(),
            nombre: (celdas[2].textContent || "").trim(),
            fallas: fallas
          });
        }
      }
    });
    if (tablaAvanceElem) {
      const cloneAvance = tablaAvanceElem.cloneNode(true);

      // Evitar ids duplicados
      cloneAvance.removeAttribute("id");
      const tbodyAvance = cloneAvance.querySelector("#pivotAvanceContainer");
      if (tbodyAvance) tbodyAvance.removeAttribute("id");

      // Misma lógica visual que las otras tablas
      cloneAvance.classList.add("tabla-avance-aprendices");
      cloneAvance.style.width = "85%";
      cloneAvance.style.borderCollapse = "collapse";
      cloneAvance.style.tableLayout = "fixed";
      cloneAvance.style.marginTop = "4px";
      cloneAvance.style.marginLeft = "auto";
      cloneAvance.style.marginRight = "auto";

      // Definir anchos de columnas:
      // # / Doc / Nombre / Fallas / Detalles / Aprobado / Por Evaluar / % Avance
      const oldCg2 = cloneAvance.querySelector("colgroup");
      if (oldCg2) oldCg2.remove();

      const colgroup2 = document.createElement("colgroup");
      const widths2 = ["5%", "17%", "30%", "8%", "16%", "7%", "7%", "10%"];
      widths2.forEach((w) => {
        const col = document.createElement("col");
        col.style.width = w;
        colgroup2.appendChild(col);
      });
      cloneAvance.insertBefore(colgroup2, cloneAvance.firstElementChild);

      tablaAvanceAprendicesHTML = cloneAvance.outerHTML;
    }

    // Renderizar gráfica de fallas en el reporte (CanvasJS)
    renderGraficoFallasReporte7(datosFallasParaGrafico);
  }

  const graficoFallasAprendicesHTML = (() => {
    // Capturar el CanvasJS del reporte (si existe) para el acta
    if (chartFallasReporte7 && typeof chartFallasReporte7.render === "function") {
      try { chartFallasReporte7.render(); } catch (err) {}
    }
    const dataURL = capturarGraficoComoImg("#graficoFallasReporte7Container");
    if (!dataURL) return "";
    return `<div style="width:100%; text-align:center; margin:8px auto 10px;">
      <img src="${dataURL}" alt="Aprendices con fallas" style="width:8cm; height:4cm; display:block; margin:0 auto; border:1px solid #d1d5db; padding:2px; box-sizing:border-box; object-fit:contain;">
    </div>`;
  })();

  // 3.3 – Competencias pendientes por evaluar por cada aprendiz
  // 3.4 – Aprendices listos para ir a etapa productiva
  let tablaPendientesAprendizHTML = "";
  let tablaListosProductivaHTML   = "";

  const contTablasReporte8  = document.getElementById("contenedorTablasReporte8");
  const contResumenReporte8 = document.getElementById("contenedorResumenPracticaReporte8");

  if (contTablasReporte8) {
    // Tabla ÚNICA visible del reporte 8
    const tablaPendientesElem = contTablasReporte8.querySelector("table.tabla-aprendiz-reporte8");

    if (tablaPendientesElem) {
      // ===== 3.3 – Competencias pendientes por evaluar por cada aprendiz =====
      const clonePendientes = tablaPendientesElem.cloneNode(true);

      // Evitar ids duplicados en el DOM del Word
      clonePendientes.removeAttribute("id");

      // Quitar la primera columna (#) para que queden solo:
      // Documento | Nombre | Competencias Pendientes | Instructor
      const filas = clonePendientes.querySelectorAll("tr");
      filas.forEach((tr) => {
        if (tr.firstElementChild) {
          tr.removeChild(tr.firstElementChild);
        }
      });

      // Ajuste de estilo como las demás tablas del acta
      clonePendientes.classList.add("tabla-avance-aprendices");
      clonePendientes.style.width = "85%";
      clonePendientes.style.borderCollapse = "collapse";
      clonePendientes.style.tableLayout = "fixed";
      clonePendientes.style.marginTop = "4px";
      clonePendientes.style.marginLeft = "auto";
      clonePendientes.style.marginRight = "auto";

      // Encabezado con fondo gris y bordes (para que Word lo respete)
      const encabezados = clonePendientes.querySelectorAll("thead tr th, thead tr td");
      encabezados.forEach((th) => {
        th.style.backgroundColor = "#e5e7eb";
        th.style.fontWeight = "bold";
        th.style.textAlign = "center";
        th.style.border = "1px solid #000000";
        th.style.padding = "4px 6px";
        th.style.fontSize = "8.5pt";
      });

      // Cuerpo de la tabla (bordes y tamaño de fuente)
      const celdasCuerpo = clonePendientes.querySelectorAll("tbody tr td");
      celdasCuerpo.forEach((td) => {
        td.style.border = "1px solid #000000";
        td.style.padding = "4px 6px";
        td.style.fontSize = "8.5pt";
        td.style.verticalAlign = "top";
      });

      // Anchos de columnas: Documento / Nombre / Competencias / Instructor
      const oldCg3 = clonePendientes.querySelector("colgroup");
      if (oldCg3) oldCg3.remove();

      const colgroup3 = document.createElement("colgroup");
      ["18%", "32%", "30%", "20%"].forEach((w) => {
        const col = document.createElement("col");
        col.style.width = w;
        colgroup3.appendChild(col);
      });
      clonePendientes.insertBefore(colgroup3, clonePendientes.firstElementChild);

      tablaPendientesAprendizHTML = clonePendientes.outerHTML;

      // ===== 3.4 – Aprendices listos para ir a etapa productiva =====
      // Solo aplica si existe el resumen de etapa práctica del reporte 8
      if (contResumenReporte8) {
        const tablaResumen = contResumenReporte8.querySelector("table.tabla-resumen-practica");

        // Normaliza texto como en el reporte 8
        const normalizarClave = (texto) =>
          (texto || "")
            .toString()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase()
            .trim()
            .replace(/\s+/g, " ");

        if (tablaResumen) {
          // 1) Nombres de aprendices que solo tienen pendiente la etapa práctica
          const nombresSoloPractica = new Set();
          const filasResumen = tablaResumen.querySelectorAll("tbody tr");

          filasResumen.forEach((tr) => {
            const celdas = tr.querySelectorAll("td");
            if (celdas.length >= 2) {
              const nombre = celdas[1].textContent || "";
              const clave  = normalizarClave(nombre);
              if (clave) nombresSoloPractica.add(clave);
            }
          });

          if (nombresSoloPractica.size > 0) {
            // 2) Buscar documento + nombre en la tabla de pendientes
            const mapaAprendices = {};
            const filasPend = tablaPendientesElem.querySelectorAll("tbody tr");

            filasPend.forEach((tr) => {
              const celdas = tr.querySelectorAll("td");
              if (celdas.length >= 3) {
                const doc  = (celdas[1].textContent || "").trim();
                const nom  = (celdas[2].textContent || "").trim();
                const clave = normalizarClave(nom);

                if (nombresSoloPractica.has(clave) && !mapaAprendices[clave]) {
                  mapaAprendices[clave] = {
                    documento: doc,
                    nombre: nom,
                  };
                }
              }
            });

            const listaAprendices = Object.values(mapaAprendices).sort((a, b) =>
              a.nombre.toUpperCase().localeCompare(b.nombre.toUpperCase())
            );

            if (listaAprendices.length > 0) {
              const tablaListos = document.createElement("table");
              tablaListos.classList.add("tabla-avance-aprendices");
              tablaListos.style.width = "85%";
              tablaListos.style.borderCollapse = "collapse";
              tablaListos.style.tableLayout = "fixed";
              tablaListos.style.marginTop = "4px";
              tablaListos.style.marginLeft = "auto";
              tablaListos.style.marginRight = "auto";

              // Columnas: # / Documento / Nombre
              const colgroupL = document.createElement("colgroup");
              ["12%", "28%", "60%"].forEach((w) => {
                const col = document.createElement("col");
                col.style.width = w;
                colgroupL.appendChild(col);
              });
              tablaListos.appendChild(colgroupL);

              const theadL = document.createElement("thead");
              const trHeadL = document.createElement("tr");
              ["#", "Documento", "Nombre del Aprendiz"].forEach((texto) => {
                const th = document.createElement("th");
                th.textContent = texto;
                th.style.backgroundColor = "#e5e7eb";
                th.style.fontWeight = "bold";
                th.style.textAlign = "center";
                th.style.border = "1px solid #000000";
                th.style.padding = "4px 6px";
                th.style.fontSize = "8.5pt";
                trHeadL.appendChild(th);
              });
              theadL.appendChild(trHeadL);
              tablaListos.appendChild(theadL);

              const tbodyL = document.createElement("tbody");
              listaAprendices.forEach((ap, index) => {
                const trL = document.createElement("tr");

                const tdNum = document.createElement("td");
                tdNum.textContent = index + 1;

                const tdDoc = document.createElement("td");
                tdDoc.textContent = ap.documento || "";

                const tdNom = document.createElement("td");
                tdNom.textContent = ap.nombre || "";

                [tdNum, tdDoc, tdNom].forEach((td) => {
                  td.style.border = "1px solid #000000";
                  td.style.padding = "4px 6px";
                  td.style.fontSize = "8.5pt";
                  td.style.verticalAlign = "top";
                });

                trL.appendChild(tdNum);
                trL.appendChild(tdDoc);
                trL.appendChild(tdNom);
                tbodyL.appendChild(trL);
              });

              tablaListos.appendChild(tbodyL);
              tablaListosProductivaHTML = tablaListos.outerHTML;
            }
          }
        }
      }
    }
  }
  // 3.X – Listado de Instructores con aprendices pendientes por emitir Juicio
  let tablaPendientesJuicioHTML = "";
  const tablaPendInstrJuicio = document.getElementById("tablaPendientesInstructorReporte8");

  if (tablaPendInstrJuicio) {
    const clonePendJuicio = tablaPendInstrJuicio.cloneNode(true);

    // Evitar ids duplicados
    clonePendJuicio.removeAttribute("id");
    const tbodyPendJuicio = clonePendJuicio.querySelector("#tbodyPendientesInstructorReporte8");
    if (tbodyPendJuicio) tbodyPendJuicio.removeAttribute("id");

    // Mismo estilo que las demás tablas del acta
    clonePendJuicio.classList.add("tabla-pendientes-juicio");
    clonePendJuicio.style.width = "85%";
    clonePendJuicio.style.borderCollapse = "collapse";
    clonePendJuicio.style.tableLayout = "fixed";
    clonePendJuicio.style.marginTop = "4px";
    clonePendJuicio.style.marginLeft = "auto";
    clonePendJuicio.style.marginRight = "auto";

    // Anchos de columnas: # / Instructor / Competencia / Aprendices / Cantidad
    const oldCgPend = clonePendJuicio.querySelector("colgroup");
    if (oldCgPend) oldCgPend.remove();

    const colgroupPend = document.createElement("colgroup");
    ["6%", "28%", "26%", "25%", "15%"].forEach((w) => {
      const col = document.createElement("col");
      col.style.width = w;
      colgroupPend.appendChild(col);
    });
    clonePendJuicio.insertBefore(colgroupPend, clonePendJuicio.firstElementChild);

    tablaPendientesJuicioHTML = clonePendJuicio.outerHTML;
  }

  const ciudad = "Ibagué";

  const ahora = new Date();
  const opcionesFecha = { year: "numeric", month: "2-digit", day: "2-digit" };
  const opcionesHora  = { hour: "2-digit", minute: "2-digit", hour12: false };

  const fechaHoy   = ahora.toLocaleDateString("es-CO", opcionesFecha);
  const horaInicio = ahora.toLocaleTimeString("es-CO", opcionesHora);

  // =========================
  // 2.2 Instructores: tablas desde registrosGlobal
  // =========================
  let tablaInstructoresHorasHTML = "";
  let tablaInstructoresCompetenciasHTML = "";
  let tablaCompetenciasHorasHTML = "";
  let tablaCompetenciasSobreEjecutadasHTML = "";
  let tablaCompetenciasProgramadasPendientesHTML = "";   // NUEVO: reporte 4 en el acta
  let tablaRapsOtroInstructorHTML = "";   // NUEVO: RAPs evaluados por instructor no programado
  let tablaCronogramaGanttHTML = "";   // NUEVO: Cronograma Gantt de Competencias


  if (Array.isArray(registrosGlobal) && registrosGlobal.length > 0) {
    // --- 2.2.1 Listado de Instructores (Total de Horas Programadas) ---
    const mapHorasPorInstructor = {};

    registrosGlobal.forEach(r => {
      const nombre   = (r.nombreInstructor || "").trim();
      const apellido = (r.apellidoInstructor || "").trim();
      const key      = nombre + "|" + apellido;

      if (!mapHorasPorInstructor[key]) {
        mapHorasPorInstructor[key] = {
          nombre,
          apellido,
          horas: 0
        };
      }
      mapHorasPorInstructor[key].horas += Number(r.horasProg) || 0;
    });

    const arrInstructores = Object.values(mapHorasPorInstructor);
    arrInstructores.sort((a, b) => b.horas - a.horas);

    const filasHoras = arrInstructores.map((inst, index) => `
          <tr>
            <td style="border:1px solid #000; padding:3px; text-align:center; font-size:9pt;">${index + 1}</td>
            <td style="border:1px solid #000; padding:3px; font-size:9pt; overflow:hidden;">${inst.nombre}</td>
            <td style="border:1px solid #000; padding:3px; font-size:9pt; overflow:hidden;">${inst.apellido}</td>
            <td style="border:1px solid #000; padding:3px; text-align:center; font-size:9pt;">${inst.horas.toFixed(2)}</td>
          </tr>
    `).join("");

    tablaInstructoresHorasHTML = `
  <div style="width:100%; overflow:hidden;">
  <table class="tabla-instructores-horas" style="width:85%; table-layout:fixed; border-collapse:collapse; margin:4px auto; mso-table-lspace:0pt; mso-table-rspace:0pt;">
    <colgroup>
      <col style="width:8%;">   <!-- # -->
      <col style="width:34%;">  <!-- Nombre Instructor -->
      <col style="width:34%;">  <!-- Apellido Instructor -->
      <col style="width:24%;">  <!-- Total Horas -->
    </colgroup>
    <thead>
      <tr>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">#</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">Nombre Instructor</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">Apellido Instructor</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">Total Horas</th>
      </tr>
    </thead>
    <tbody>
      ${filasHoras}
    </tbody>
  </table>
  </div>
`;

  // 2.4 – Competencias y % de avance (Reporte % Competencias con Horas)
  tablaCompetenciasHorasHTML = "";
  tablaCompetenciasSobreEjecutadasHTML = "";

  const tbodyReporte2 = document.getElementById("tbodyReporte2");

  if (tbodyReporte2 && typeof tbodyReporte2.closest === "function") {
    const tablaCompHoras = tbodyReporte2.closest("table");
    if (tablaCompHoras) {
      // ===== 2.4.1 – Tabla completa % Competencias con Horas =====
      const cloneCompHoras = tablaCompHoras.cloneNode(true);

      // Evitar ids duplicados dentro del documento Word
      cloneCompHoras.removeAttribute("id");
      const tbodyClone = cloneCompHoras.querySelector("#tbodyReporte2");
      if (tbodyClone) tbodyClone.removeAttribute("id");
      const tfootClone = cloneCompHoras.querySelector("#tfootReporte2");
      if (tfootClone) tfootClone.removeAttribute("id");

      // Ajuste visual igual a las demás tablas
      cloneCompHoras.classList.add("tabla-competencias-horas");
      cloneCompHoras.style.width = "85%";
      cloneCompHoras.style.borderCollapse = "collapse";
      cloneCompHoras.style.tableLayout = "fixed";
      cloneCompHoras.style.marginTop = "4px";
      cloneCompHoras.style.marginLeft = "auto";
      cloneCompHoras.style.marginRight = "auto";

      // Definir anchos de columnas: # / Competencia / Total Horas / Horas Diseño / %
      let oldCgCH = cloneCompHoras.querySelector("colgroup");
      if (oldCgCH) oldCgCH.remove();

      let colgroupCH = document.createElement("colgroup");
      const widthsCH = ["6%", "46%", "16%", "16%", "16%"];
      widthsCH.forEach((w) => {
        const col = document.createElement("col");
        col.style.width = w;
        colgroupCH.appendChild(col);
      });
      cloneCompHoras.insertBefore(colgroupCH, cloneCompHoras.firstElementChild);

      tablaCompetenciasHorasHTML = cloneCompHoras.outerHTML;

  // ===== Cronograma Gantt de Competencias para el acta =====
  tablaCronogramaGanttHTML = "";
  const ganttContainer = document.getElementById("ganttContainer");

  if (ganttContainer) {
    const tablaGantt = ganttContainer.querySelector("table");
    if (tablaGantt) {
      const cloneGantt = tablaGantt.cloneNode(true);

      // Agregar clase para estilos del acta
      cloneGantt.classList.add("tabla-cronograma-gantt");

      // Contar número de columnas de meses para calcular anchos
      const headerRow = cloneGantt.querySelector("thead tr");
      const numColumnas = headerRow ? headerRow.querySelectorAll("th").length : 0;
      const numMeses = numColumnas - 2; // Restar # y Competencia

      // Truncar nombres de competencias a 12 caracteres para dar más espacio a meses
      const filasGantt = cloneGantt.querySelectorAll("tbody tr");
      filasGantt.forEach(tr => {
        const celdas = tr.getElementsByTagName("td");
        if (celdas.length >= 2) {
          const esCabecera = celdas[0]?.hasAttribute("colspan");
          if (!esCabecera && celdas[1]) {
            const textoCompleto = celdas[1].textContent || "";
            if (textoCompleto.length > 12) {
              celdas[1].textContent = textoCompleto.substring(0, 12) + "...";
              celdas[1].title = textoCompleto;
            }
          }
        }
      });

      // Ajustar estilos para que quepa en la ventana
      cloneGantt.style.width = "85%";
      cloneGantt.style.tableLayout = "fixed";
      cloneGantt.style.borderCollapse = "collapse";
      cloneGantt.style.fontSize = "6pt";
      cloneGantt.style.margin = "4px auto";

      // Crear colgroup con anchos fijos
      const oldColgroup = cloneGantt.querySelector("colgroup");
      if (oldColgroup) oldColgroup.remove();

      const colgroup = document.createElement("colgroup");
      // # columna fija
      const col1 = document.createElement("col");
      col1.style.width = "15px";
      colgroup.appendChild(col1);
      // Competencia columna fija
      const col2 = document.createElement("col");
      col2.style.width = "80px";
      colgroup.appendChild(col2);
      // Columnas de meses - ancho restante dividido equitativamente
      for (let i = 0; i < numMeses; i++) {
        const colMes = document.createElement("col");
        colMes.style.width = "25px";
        colgroup.appendChild(colMes);
      }
      cloneGantt.insertBefore(colgroup, cloneGantt.firstElementChild);

      // Ajustar encabezados con estilos uniformes
      const ths = cloneGantt.querySelectorAll("th");
      ths.forEach((th, i) => {
        th.style.backgroundColor = "#e5e7eb";
        th.style.fontWeight = "bold";
        th.style.textAlign = "center";
        th.style.border = "1px solid #000";
        th.style.fontSize = "5pt";
        th.style.padding = "1px";
        th.style.wordWrap = "break-word";
        th.style.overflow = "hidden";
      });

      // Ajustar celdas
      const tds = cloneGantt.querySelectorAll("td");
      tds.forEach(td => {
        td.style.border = "1px solid #000";
        td.style.fontSize = "5pt";
        td.style.padding = "1px";
        td.style.textAlign = "center";
        td.style.wordWrap = "break-word";
        td.style.overflow = "hidden";
      });

      // Envolver en div para controlar overflow
      tablaCronogramaGanttHTML = `<div style="width:100%; overflow:hidden;">${cloneGantt.outerHTML}</div>`;
    }
  }

        // 2.4.3 – Competencias programadas y pendientes (Reporte 4: Programada Sí/No)
  tablaCompetenciasProgramadasPendientesHTML = "";
  const tbodyReporte4 = document.getElementById("tbodyReporte4");

  if (tbodyReporte4 && typeof tbodyReporte4.closest === "function") {
    const tablaRep4 = tbodyReporte4.closest("table");
    if (tablaRep4) {
      const cloneRep4 = tablaRep4.cloneNode(true);

      // Limpiar ids para que no se dupliquen en el documento Word
      cloneRep4.removeAttribute("id");
      const tbodyClone4 = cloneRep4.querySelector("#tbodyReporte4");
      if (tbodyClone4) {
        tbodyClone4.removeAttribute("id");

        // Filtrar: solo mostrar No y 1/2, eliminar las que tienen "Sí"
        const filas4 = Array.from(tbodyClone4.querySelectorAll("tr"));
        filas4.forEach(tr => {
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;

          // Detectar si es fila de cabecera de categoría (tiene colspan)
          const esFilaCabecera = celdas[0]?.hasAttribute("colspan");
          if (esFilaCabecera) return; // No procesar cabeceras aún

          // Columna 3 = "Programada"
          const valorProg = (celdas[2]?.textContent || "").trim().toUpperCase();
          if (valorProg === "SÍ" || valorProg === "SI") {
            tr.remove();  // Eliminar filas con "Sí"
          } else if (valorProg === "NO" || valorProg === "1/2") {
            tr.classList.add("textoRojo");   // Resaltar en rojo las No y 1/2
          }
        });

        // Eliminar cabeceras de categoría que quedaron sin competencias
        const filasRestantes = Array.from(tbodyClone4.querySelectorAll("tr"));
        filasRestantes.forEach((tr, index) => {
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;

          const esFilaCabecera = celdas[0]?.hasAttribute("colspan");
          if (esFilaCabecera) {
            // Verificar si la siguiente fila es otra cabecera o no existe (categoría vacía)
            const siguienteFila = filasRestantes[index + 1];
            if (!siguienteFila) {
              tr.remove(); // No hay más filas, eliminar cabecera
            } else {
              const celdasSig = siguienteFila.getElementsByTagName("td");
              const sigEsCabecera = celdasSig[0]?.hasAttribute("colspan");
              if (sigEsCabecera) {
                tr.remove(); // La siguiente también es cabecera, esta categoría está vacía
              }
            }
          }
        });

      }

      // Estilo de tabla igual a las demás del acta
      cloneRep4.classList.add("tabla-competencias-pendientes");  // reutiliza la clase de tablas del acta
      cloneRep4.style.width = "85%";
      cloneRep4.style.borderCollapse = "collapse";
      cloneRep4.style.tableLayout = "fixed";
      cloneRep4.style.marginTop = "4px";
      cloneRep4.style.marginLeft = "auto";
      cloneRep4.style.marginRight = "auto";

      // Columnas: # / Competencia / Programada
      const oldCg4 = cloneRep4.querySelector("colgroup");
      if (oldCg4) oldCg4.remove();

      const colgroup4 = document.createElement("colgroup");
      ["8%", "72%", "20%"].forEach(w => {
        const col = document.createElement("col");
        col.style.width = w;
        colgroup4.appendChild(col);
      });
      cloneRep4.insertBefore(colgroup4, cloneRep4.firstElementChild);

      tablaCompetenciasProgramadasPendientesHTML = cloneRep4.outerHTML;
    }
  }

  // ===== 2.4.4 – RAPs evaluados por instructor no programado (Reporte 6 filas amarillas) =====
  tablaRapsOtroInstructorHTML = "";
  const tbodyReporte6 = document.getElementById("tbodyReporte6");

  if (tbodyReporte6 && typeof tbodyReporte6.closest === "function") {
    const tablaRep6 = tbodyReporte6.closest("table");
    if (tablaRep6) {
      const cloneRep6 = tablaRep6.cloneNode(true);

      cloneRep6.removeAttribute("id");
      const tbodyClone6 = cloneRep6.querySelector("#tbodyReporte6");
      if (tbodyClone6) {
        tbodyClone6.removeAttribute("id");

        // Filtrar: solo mostrar filas amarillas (instructor diferente)
        const filas6 = Array.from(tbodyClone6.querySelectorAll("tr"));
        let hayFilasAmarillas = false;

        filas6.forEach(tr => {
          if (!tr.classList.contains("fila-instructor-diferente")) {
            tr.remove();
          } else {
            hayFilasAmarillas = true;
          }
        });

        if (hayFilasAmarillas) {
          // Renumerar las filas restantes
          let contador = 1;
          Array.from(tbodyClone6.querySelectorAll("tr")).forEach(tr => {
            const celdas = tr.getElementsByTagName("td");
            if (celdas.length > 0) {
              celdas[0].textContent = contador++;
            }
          });

          // Estilo de tabla igual a las demás del acta
          cloneRep6.classList.add("tabla-raps-otro-instructor");
          cloneRep6.style.width = "85%";
          cloneRep6.style.borderCollapse = "collapse";
          cloneRep6.style.tableLayout = "fixed";
          cloneRep6.style.marginTop = "4px";
          cloneRep6.style.marginLeft = "auto";
          cloneRep6.style.marginRight = "auto";
          cloneRep6.style.fontSize = "9pt";

          // Columnas con anchos fijos: # / Competencia / RAP / Funcionario / APROBADO / POR EVALUAR / NO APROBADO
          const oldCg6 = cloneRep6.querySelector("colgroup");
          if (oldCg6) oldCg6.remove();

          const colgroup6 = document.createElement("colgroup");
          const col1 = document.createElement("col"); col1.style.width = "20px"; colgroup6.appendChild(col1);  // #
          const col2 = document.createElement("col"); col2.style.width = "120px"; colgroup6.appendChild(col2); // Competencia
          const col3 = document.createElement("col"); col3.style.width = "120px"; colgroup6.appendChild(col3); // RAP
          const col4 = document.createElement("col"); col4.style.width = "80px"; colgroup6.appendChild(col4);  // Funcionario
          const col5 = document.createElement("col"); col5.style.width = "45px"; colgroup6.appendChild(col5);  // APROBADO
          const col6 = document.createElement("col"); col6.style.width = "45px"; colgroup6.appendChild(col6);  // POR EVALUAR
          const col7 = document.createElement("col"); col7.style.width = "45px"; colgroup6.appendChild(col7);  // NO APROBADO
          cloneRep6.insertBefore(colgroup6, cloneRep6.firstElementChild);

          // Aplicar estilos a encabezados
          const thsRep6 = cloneRep6.querySelectorAll("th");
          thsRep6.forEach(th => {
            th.style.backgroundColor = "#e5e7eb";
            th.style.fontWeight = "bold";
            th.style.textAlign = "center";
            th.style.border = "1px solid #000";
            th.style.padding = "3px";
            th.style.fontSize = "9pt";
            th.style.wordWrap = "break-word";
            th.style.overflow = "hidden";
          });

          // Aplicar estilos a celdas
          const tdsRep6 = cloneRep6.querySelectorAll("td");
          tdsRep6.forEach(td => {
            td.style.border = "1px solid #000";
            td.style.padding = "3px";
            td.style.fontSize = "9pt";
            td.style.wordWrap = "break-word";
            td.style.overflow = "hidden";
          });

          // Envolver en div para controlar overflow
          tablaRapsOtroInstructorHTML = `<div style="width:100%; overflow:hidden;">${cloneRep6.outerHTML}</div>`;
        }
      }
    }
  }

// ===== 2.4.2 – Solo competencias sobre ejecutadas (> 100 %) =====
      const cloneSobre = tablaCompHoras.cloneNode(true);
      cloneSobre.removeAttribute("id");

      const tbodySobre = cloneSobre.querySelector("#tbodyReporte2");
      if (tbodySobre) tbodySobre.removeAttribute("id");

      const tfootSobre = cloneSobre.querySelector("#tfootReporte2");
      if (tfootSobre) tfootSobre.remove(); // en este listado no necesitamos totales

      const filasSobre = Array.from(tbodySobre.querySelectorAll("tr"));
      let hayFilasSobre = false;

      filasSobre.forEach((tr) => {
        const esCabeceraCategoria = tr.querySelector("td[colspan]") !== null;
        const esRoja = tr.classList.contains("textoRojo");

        // Solo dejamos filas de datos que estén en rojo
        if (!esRoja || esCabeceraCategoria) {
          tr.remove();
        } else {
          hayFilasSobre = true;
        }
      });

      if (hayFilasSobre) {
        // Ajuste visual de la tabla filtrada
        cloneSobre.classList.add("tabla-competencias-sobre-ejecutadas");
        cloneSobre.style.width = "85%";
        cloneSobre.style.borderCollapse = "collapse";
        cloneSobre.style.tableLayout = "fixed";
        cloneSobre.style.marginTop = "4px";
        cloneSobre.style.marginLeft = "auto";
        cloneSobre.style.marginRight = "auto";

        // Mismos anchos de columnas
        const oldCgSobre = cloneSobre.querySelector("colgroup");
        if (oldCgSobre) oldCgSobre.remove();

        const colgroupSobre = document.createElement("colgroup");
        widthsCH.forEach((w) => {
          const col = document.createElement("col");
          col.style.width = w;
          colgroupSobre.appendChild(col);
        });
        cloneSobre.insertBefore(colgroupSobre, cloneSobre.firstElementChild);

        tablaCompetenciasSobreEjecutadasHTML = cloneSobre.outerHTML;
      }
    }
  }

     // --- 2.2.2 Instructores y Competencias ---
    const registrosOrdenados = [...registrosGlobal].sort((a, b) => {

      const nomA = ((a.nombreInstructor || "") + " " + (a.apellidoInstructor || "")).toUpperCase();
      const nomB = ((b.nombreInstructor || "") + " " + (b.apellidoInstructor || "")).toUpperCase();
      if (nomA < nomB) return -1;
      if (nomA > nomB) return 1;
      const compA = (a.competencia || "").toUpperCase();
      const compB = (b.competencia || "").toUpperCase();
      if (compA < compB) return -1;
      if (compA > compB) return 1;
      return 0;
    });


    const filasComp = registrosOrdenados.map((r, index) => `
          <tr>
            <td style="border:1px solid #000; padding:2px; text-align:center; font-size:8pt; word-wrap:break-word;">${index + 1}</td>
            <td style="border:1px solid #000; padding:2px; font-size:8pt; word-wrap:break-word;">${(r.nombreInstructor || "").trim()}</td>
            <td style="border:1px solid #000; padding:2px; font-size:8pt; word-wrap:break-word;">${(r.apellidoInstructor || "").trim()}</td>
            <td style="border:1px solid #000; padding:2px; font-size:8pt; word-wrap:break-word;">${r.competencia || ""}</td>
            <td style="border:1px solid #000; padding:2px; text-align:center; font-size:8pt; word-wrap:break-word;">${(Number(r.horasProg) || 0).toFixed(2)}</td>
          </tr>
    `).join("");

tablaInstructoresCompetenciasHTML = `
  <div style="width:100%; overflow:hidden;">
  <table class="tabla-instructores-competencias" style="width:85%; table-layout:fixed; border-collapse:collapse; margin:4px auto; mso-table-lspace:0pt; mso-table-rspace:0pt;">
    <colgroup>
      <col style="width:20px;">   <!-- # fijo -->
      <col style="width:70px;">  <!-- Nombre Instructor fijo -->
      <col style="width:80px;">  <!-- Apellido Instructor fijo -->
      <col>  <!-- Competencia flexible -->
      <col style="width:50px;">  <!-- Horas Programadas fijo -->
    </colgroup>
    <thead>
      <tr>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">#</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Nombre</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Apellido</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Competencia</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Horas</th>
      </tr>
    </thead>
    <tbody>
      ${filasComp}
    </tbody>
  </table>
  </div>
`;

  }

 

  // =========================
  // HTML del documento Word
  // =========================
  let contenidoHTML = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
  <head>
    <meta charset="utf-8">
    <title>Acta Comité</title>
    <style>
      /* Sección de página para que Word asigne el pie de página */
      @page Section1 {
        margin-top: 20mm;
        margin-right: 15mm;
        margin-bottom: 20mm;
        margin-left: 15mm;
        mso-footer:f1;          /* id del pie de página */
        mso-footer-margin:10mm; /* margen del pie de página */
      }
      div.Section1 { page:Section1; }

      body {
        font-family: Arial, sans-serif;
        font-size: 10pt;
      }
      /* TABLA CON TODOS LOS BORDES */
      table.acta-encabezado {
        width: 100%;
        border-collapse: collapse;
      }
      table.acta-encabezado,
      table.acta-encabezado td {
        border: 1px solid #000000;
      }
      table.acta-encabezado td {
        padding: 6px 8px;
        font-size: 9pt;
        vertical-align: top;
      }

      /* Centrado global de tablas del acta (incluyendo las que van dentro de listas) */
      .Section1 table {
        margin-left: auto;
        margin-right: auto;
      }
      .Section1 ol table,
      .Section1 ul table,
      .Section1 ol div table,
      .Section1 ul div table {
        margin-left: auto !important;
        margin-right: auto !important;
        display: table;
        width: 90%;
        max-width: 100%;
      }
      .tabla-acta-wrap {
        margin: 6px auto;
        text-align: center;
      }
      .tabla-acta-wrap table {
        margin-left: auto;
        margin-right: auto;
        display: table;
        width: 90%;
        max-width: 100%;
      }
      /* Estilos de listas tipo Word */
      .lista-acta {
        margin: 0;
        list-style-position: outside;
        padding-left: 18px;
      }
      .lista-acta.nivel-1 { padding-left: 20px; }
      .lista-acta.nivel-2 { padding-left: 18px; }
      .lista-acta.nivel-3 { padding-left: 16px; }
      .lista-acta.nivel-4 { padding-left: 14px; }

      .titulo-1 {
        display: block;
        font-weight: bold;
        font-size: 12pt;
        margin: 8px 0 4px;
      }
      .titulo-2 {
        display: block;
        font-weight: bold;
        font-size: 11pt;
        margin: 7px 0 4px;
        
      }
      .titulo-3 {
        display: block;
        font-weight: bold;
        font-size: 10pt;
        font-style: italic;
        margin: 7px 0 4px;
        
      }
      .titulo-4 {
        display: block;
        font-weight: bold;
        font-size: 9pt;
        font-style: italic;
        
      }
      .contenido-item {
        font-size: 10pt;
        font-weight: normal;
        font-style: normal;
        margin: 4px 0 8px;
        padding-left: 12pt;
      }
      .acta-titulo {
        text-align: center;
        font-weight: bold;
      }
      /* Estilo del texto del pie de página */
      p.MsoFooter {
        text-align: center;
        font-size: 8pt;
        margin: 0;
      }
     
    
                  .tabla-instructores-horas,
      .tabla-instructores-competencias,
      .tabla-estado-aprendices,
      .tabla-avance-aprendices,
      .tabla-competencias-pendientes,
      .tabla-listos-productiva,
      .tabla-pendientes-juicio,
      .tabla-alternativa-productiva,
      .tabla-competencias-horas,
      .tabla-competencias-sobre-ejecutadas,
      .tabla-raps-otro-instructor,
      .tabla-cronograma-gantt,
      .tabla-cursos-preparatorios,
      .tabla-cursos-habilidades,
      .tabla-cursos-emprendimiento,
      .tabla-alternativas-productiva {

        width: 100%;
        border-collapse: collapse;
        margin-top: 4px;
        margin-left: auto;
        margin-right: auto;
        table-layout: fixed;
        mso-table-lspace:0pt;
        mso-table-rspace:0pt;
      }

      .tabla-instructores-horas th,
      .tabla-instructores-horas td,
      .tabla-instructores-competencias th,
      .tabla-instructores-competencias td,
      .tabla-estado-aprendices th,
      .tabla-estado-aprendices td,
      .tabla-avance-aprendices th,
      .tabla-avance-aprendices td,
      .tabla-competencias-pendientes th,
      .tabla-competencias-pendientes td,
      .tabla-listos-productiva th,
      .tabla-listos-productiva td,
      .tabla-pendientes-juicio th,
      .tabla-pendientes-juicio td,
           .tabla-alternativa-productiva th,
      .tabla-alternativa-productiva td,
      .tabla-competencias-horas th,
      .tabla-competencias-horas td,
      .tabla-competencias-sobre-ejecutadas th,
      .tabla-competencias-sobre-ejecutadas td,
      .tabla-raps-otro-instructor th,
      .tabla-raps-otro-instructor td,
      .tabla-cronograma-gantt th,
      .tabla-cronograma-gantt td,
      .tabla-cursos-preparatorios th,
      .tabla-cursos-preparatorios td,
      .tabla-cursos-habilidades th,
      .tabla-cursos-habilidades td,
      .tabla-cursos-emprendimiento th,
      .tabla-cursos-emprendimiento td,
      .tabla-alternativas-productiva th,
      .tabla-alternativas-productiva td {

        border: 1px solid #000000;
        padding: 4px 6px;
        font-size: 8.5pt;
      }

      .tabla-instructores-horas th,
      .tabla-instructores-competencias th,
      .tabla-estado-aprendices th,
      .tabla-avance-aprendices th,
      .tabla-competencias-pendientes th,
      .tabla-listos-productiva th,
      .tabla-pendientes-juicio th,
            .tabla-alternativa-productiva th,
      .tabla-competencias-horas th,
      .tabla-competencias-sobre-ejecutadas th,
      .tabla-raps-otro-instructor th,
      .tabla-cronograma-gantt th,
      .tabla-cursos-preparatorios th,
      .tabla-cursos-habilidades th,
      .tabla-cursos-emprendimiento th,
      .tabla-alternativas-productiva th {
        background-color: #e5e7eb;
        font-weight: bold;
        text-align: center;
      }

      /* Utilidades de tablas (sin estilos inline) */
      .tabla-alternativa-productiva {
        width: 70% !important;
        max-width: 700px;
        margin: 6px auto;
        table-layout: fixed;
      }

      .tabla-alternativa-productiva th,
      .tabla-alternativa-productiva td {
        word-break: break-word;
        padding: 6px;
      }

      .tabla-alternativa-productiva .col-cantidad {
        text-align: center;
      }

      /* Distribuciones específicas por tamaño */
      .tabla-alternativa-productiva.tabla-ancha {
        width: 70% !important;
        max-width: 700px;
      }

      .tabla-alternativa-productiva.tabla-ancha .col-alternativa {
        width: 60% !important;
      }

      .tabla-alternativa-productiva.tabla-ancha .col-cantidad {
        width: 15% !important;
      }

      .tabla-alternativa-productiva.tabla-ancha .col-nombres {
        width: 25% !important;
      }

      /* Refuerzo de anchos por columna para Word */
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(1),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(1) {
        width: 60% !important;
      }
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(2),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(2) {
        width: 15% !important;
        text-align: center;
      }
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(3),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(3) {
        width: 25% !important;
      }

      .tabla-alternativa-productiva.tabla-media {
        width: 55%;
        max-width: 420px;
      }

      .tabla-alternativa-productiva.tabla-media .col-nombres {
        width: 70%;
      }

      .tabla-alternativa-productiva.tabla-media .col-cantidad {
        width: 30%;
      }

      .contenedor-tabla {
        width: 100%;
        overflow-x: hidden;
        text-align: center;
      }

      .seccion-acta {
        width: 85%;
        margin: 8px auto;
        font-size: 9pt;
      }

      .seccion-acta p {
        margin: 6px 0;
      }

      .seccion-acta .titulo-seccion {
        margin: 10px 0 2px 0;
        font-weight: 700;
      }

      .seccion-acta .subtitulo-seccion {
        margin: 0 0 4px 0;
      }

      .seccion-acta .nota {
        margin-left: 12px;
        color: #374151;
      }

      .seccion-acta .nota-secundaria {
        margin-left: 18px;
        color: #374151;
      }

      .seccion-acta .espaciado-superior {
        margin-top: 10px;
      }


      .tabla-instructores-horas th,
      .tabla-instructores-horas td,
      .tabla-instructores-competencias th,
      .tabla-instructores-competencias td {
        border: 1px solid #000000;
        padding: 4px 6px;
        font-size: 8.5pt;
      }
      .tabla-instructores-horas th,
      .tabla-instructores-competencias th {
        background-color: #e5e7eb;
        font-weight: bold;
        text-align: center;
      }
      .textoRojo {
        background-color: #fee2e2;
      }

    </style>
  </head>
  <body>
    <!-- Word usará esta Section1 para aplicar el pie de página -->
    <div class="Section1">

      <!-- ÚNICA TABLA, 4 COLUMNAS, 4 FILAS -->
      <table class="acta-encabezado">
        <!-- Fila 1: ACTA No. -->
        <tr>
          <td class="acta-titulo" colspan="4">ACTA No.</td>
        </tr>

        <!-- Fila 2: Nombre del comité -->
        <tr>
          <td colspan="4">
            <strong>NOMBRE DEL COMITÉ O DE LA REUNIÓN:</strong>
            Comité de evaluación y seguimiento para el Programa de Formación:
            <span style="font-weight:bold; color:#c00000;">${nombrePrograma}</span>, FICHA:
            <span style="font-weight:bold; color:#c00000;">${codigoFicha}</span>,
            Modalidad de Formación:
            <span style="font-weight:bold; color:#c00000;">${modalidadFormacionGlobal || "N/A"}</span>;
            a cargo del instructor
            <strong>Gerente de Proyecto</strong>
            <span style="font-weight:bold; color:#c00000;">${instructorGerente}</span>
          </td>
        </tr>

        <!-- Fila 3: CIUDAD Y FECHA / HORA INICIO / HORA FIN -->
        <tr>
          <td><strong>CIUDAD Y FECHA:</strong></td>
          <td>
            ${ciudad},
            <span style="font-weight:bold; color:#c00000;">${fechaHoy}</span>
          </td>
          <td><strong>HORA INICIO:</strong></td>
          <td>
            <span style="font-weight:bold; color:#c00000;">${horaInicio}</span>
          </td>
        </tr>

        <!-- Fila 4: LUGAR Y/O ENLACE -->
        <tr>
          <td><strong>LUGAR Y/O ENLACE:</strong></td>
          <td></td>
          <td>
            <strong>REGIONAL TOLIMA</strong><br>
            <strong>CENTRO: COMERCIO Y SERVICIOS</strong>
          </td>
          <td></td>
        </tr>
      <!-- Fila 5: AGENDA O PUNTOS PARA DESARROLLAR -->
      <tr>
        <td colspan="4">
                    <strong>AGENDA O PUNTOS PARA DESARROLLAR:</strong>
          <ol style="margin:0; padding-left:20px; list-style-position:outside;">
            <li>Verificación del quorum</li>
            <li>Compromisos del acta anterior (opcional)</li>
            <li>Análisis de Grupo (cuantitativa: reportes de aprendices, concepto general del grupo)
              <ol type="a" style="padding-left:18px;">
                <li>Detalle de aprendices
                  <ol type="i" style="padding-left:16px;">
                    <li>Porcentaje de avance de aprendices y fallas</li>
                    <li>Competencias pendientes por evaluar por cada aprendiz.</li>
                    <li>Alternativa de etapa productiva.</li>
                    <li>Aprendices listos para ir a etapa productiva.</li>
                    <li>Cursos Complementarios
                      <ol type="1" style="padding-left:14px;">
                        <li>Cursos Preparatorios para pruebas saber TYT</li>
                        <li>Cursos Habilidades Digitales</li>
                        <li>Cursos Emprendimiento y Derechos Fundamentales</li>
                      </ol>
                    </li>
                    <li>Calificación cualitativa
                      <ol type="1" style="padding-left:14px;">
                        <li>Aspectos comportamentales.</li>
                        <li>Aspectos académicos.</li>
                      </ol>
                    </li>
                  </ol>
                </li>
                <li>Instructores
                  <ol type="i" style="padding-left:16px;">
                    <li>Listado de instructores con aprendices pendientes por emitir juicio.</li>
                  </ol>
                </li>
                <li>Análisis de competencias y resultados de aprendizaje
                  <ol type="i" style="padding-left:16px;">
                    <li>Competencias y % de avance vs diseño.</li>
                    <li>Cronograma de programación de competencias (Gantt).</li>
                    <li>Competencias sobre ejecutadas.</li>
                    <li>Competencias pendientes</li>
                    <li>Competencias y RAPs evaluados por instructor no programado.</li>
                  </ol>
                </li>
              </ol>
            </li>
            <li>Análisis de casos especiales</li>
            <li>Recomendaciones del comité</li>
            <li>Conclusiones</li>
            <li>Compromisos</li>
            <li>Anexos</li>
          </ol>
        </td>
      </tr>

      <!-- Fila 6: OBJETIVO(S) DE LA REUNIÓN -->
      <tr>
        <td colspan="4">
          <strong>OBJETIVO(S) DE LA REUNIÓN:</strong><br>
          Comité de evaluación y seguimiento para el Programa de Formación
          <span style="font-weight:bold; color:#c00000;">${codigoFicha}</span>
          <span style="font-weight:bold; color:#c00000;">${nombrePrograma}</span>
        </td>
      </tr>
            <!-- Fila 7: Título DESARROLLO DE LA REUNIÓN -->
      <tr>
        <td colspan="4" style="text-align:center; font-weight:bold;">
          DESARROLLO DE LA REUNIÓN
        </td>
      </tr>

      <!-- Fila 8: Desarrollo de la reunión -->
      <tr>
        <td colspan="4">
          <ol class="lista-acta nivel-1">
            <li class="titulo-1">
              Verificación del quorum
              <div class="contenido-item">
                Coordinador Académico:
                <span style="font-weight:bold; color:#c00000;">${coordinadorAcademico}</span><br>
                Instructor Gerente de Proyecto:
                <span style="font-weight:bold; color:#c00000;">${instructorGerente}</span><br>
                Aprendiz Vocero:
                <span style="font-weight:bold; color:#c00000;">${aprendizVocero}</span><br>
                Psicóloga de Bienestar:
              </div>
            </li>
            <li class="titulo-1">Compromisos del acta anterior (opcional)</li>
            <li class="titulo-1">
              Análisis de Grupo (cuantitativa: reportes de aprendices, concepto general del grupo)
              <ol class="lista-acta nivel-2" type="a">
                <li class="titulo-2">
                  Detalle de aprendices
                  <div class="contenido-item">
                    Avance promedio del grupo:
                    <span style="font-weight:bold; color:#c00000;">${avancePromedioGrupo}</span>
                    <span style="font-size:9pt;">
                      Este porcentaje se calcula sobre el total de competencias del programa,
                      que son
                      <span style="font-weight:bold; color:#c00000;">${numCompetencias}</span>,
                      y sobre el total de Resultados de aprendizaje del Diseño Curricular,
                      que son
                      <span style="font-weight:bold; color:#c00000;">${numResultados}</span>.
                    </span><br><br>
                    <span style="font-size:9pt;">
                      Se presenta el consolidado de aprendices por estado académico de la ficha.
                      Total aprendices Matriculados:
                      <span style="font-weight:bold; color:#c00000;">${totalAprendicesEstado}</span>.
                    </span>
                    ${graficoEstadoActaHTML}
                    <div class="tabla-acta-wrap" style="margin-top:4px;">
                      ${
                        tablaDetalleAprendicesHTML
                          ? tablaDetalleAprendicesHTML
                          : "<em>(No se encontró información del detalle de aprendices al momento de generar el acta.)</em>"
                      }
                    </div>
                  </div>
                  <ol class="lista-acta nivel-3" type="i">
                    <li class="titulo-3">
                      Porcentaje de avance de aprendices y fallas
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          Se relaciona el porcentaje de avance por aprendiz, las fallas registradas,
                          los resultados de aprendizaje aprobados y los que están por evaluar.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaAvanceAprendicesHTML
                              ? tablaAvanceAprendicesHTML
                              : "<em>(No se encontró información de avance por aprendiz en el panel al momento de generar el acta.)</em>"
                          }
                        </div>
                        <div class="titulo-1">
                        ${
                          graficoFallasAprendicesHTML
                            ? `<div class="tabla-acta-wrap" style="margin:6px auto; text-align:center; width:100%;">
                                 <div style="width:10cm; margin:0 auto;">${graficoFallasAprendicesHTML}</div>
                               </div>`
                            : ""
                        }
                      </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Competencias pendientes por evaluar por cada aprendiz.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          De acuerdo con el reporte "Competencias Pendientes por Aprendiz e Instructor", se relacionan las competencias que los aprendices tienen pendientes por evaluar y el instructor que impartió la competencia.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaPendientesAprendizHTML
                              ? tablaPendientesAprendizHTML
                              : "<em>(De acuerdo con el reporte &quot;Competencias Pendientes por Aprendiz e Instructor&quot;, a la fecha no se registran competencias pendientes por evaluar para los aprendices de la ficha.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Alternativa de etapa productiva.
                      <div class="contenido-item">
                        <p class="subtitulo-seccion">
                          Relación de alternativas definidas para el desarrollo de la etapa productiva,
                          indicando la cantidad de aprendices y sus nombres por cada alternativa.
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          <table class="tabla-alternativas-productiva">
                            <thead>
                              <tr>
                                <th>Alternativa</th>
                                <th>Cantidad</th>
                                <th>Nombres</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td>CONTRATO DE APRENDIZAJE</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>CONTRATO DE VINCULO FORMATIVO</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>CONTRATO VINCULO LABORAL</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>PROYECTO PRODUCTIVO</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>MONITORIA</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>PRACTICAS EN LA ECONOMIA POPULAR Y/O CAMPESINA</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>NO_REGISTRA</td>
                                <td></td>
                                <td></td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Aprendices listos para ir a etapa productiva.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          Se listan los aprendices que, de acuerdo con el mismo reporte, ya finalizaron todas las competencias lectivas
                          y solo tienen pendiente la competencia &quot;RESULTADOS DE APRENDIZAJE ETAPA PRACTICA&quot;.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaListosProductivaHTML
                              ? tablaListosProductivaHTML
                              : "<em>Por el momento no hay ningún aprendiz.</em>"
                          }
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Cursos Complementarios
                      <ol class="lista-acta nivel-4" type="1">
                        <li class="titulo-4">
                          Cursos Preparatorios para pruebas saber TYT
                          <div class="contenido-item" style="padding-left:0;">
                            <div class="tabla-acta-wrap" style="margin-top:4px;">
                              <table class="tabla-cursos-preparatorios">
                                <thead>
                                  <tr>
                                    <th>Curso</th>
                                    <th>Cantidad</th>
                                    <th>Nombres</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Lectura Critica</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Competencias Ciudadanas</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>
                                     * Razonamiento Cuantitativo<br>
                                    </td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>

                            </div>
                            
                          </div>
                           
                        </li>
                
                        <li class="titulo-4">
                          Cursos Habilidades Digitales
                          <div class="contenido-item" style="padding-left:0;">
                            <div class="tabla-acta-wrap" style="margin-top:4px;">
                              <table class="tabla-cursos-habilidades">
                                <thead>
                                  <tr>
                                    <th>Curso</th>
                                    <th>Cantidad</th>
                                    <th>Nombres</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Experiencias Seguras en Línea</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Comunicacion y Colaboracion</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Contenido Digital</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Gestion del Conocimiento</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </li>
                        <li class="titulo-4">
                          Cursos Emprendimiento y Derechos Fundamentales
                          <div class="contenido-item" style="padding-left:0;">
                            <div class="tabla-acta-wrap" style="margin-top:4px;">
                              <table class="tabla-cursos-emprendimiento">
                                <thead>
                                  <tr>
                                    <th>Curso</th>
                                    <th>Cantidad</th>
                                    <th>Nombres</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Comportamiento Emprendedor</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Emprendimiento Digital</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>
                                      * Derechos Fundamentales para el Trabajo<br>
                                    </td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>
                                                                    

                            </div>
                          </div>
                        </li>
                      </ol>
                    </li>
                   <p> <span style="font-size:9pt;">Razonamiento Cuantitativo y Derechos Fundamentales para el Trabajo [*Solo aplica para los tecnologos antiguos que no lo tengan en el Diseño Curricular]</span>
                   </p>
                   <li class="titulo-3">
                      Calificación cualitativa
                      <ol class="lista-acta nivel-4" type="1">
                        <li class="titulo-4">Aspectos comportamentales.</li>
                        <li class="titulo-4">Aspectos académicos.</li>
                      </ol>
                    </li>
                  </ol>
                </li>
                <li class="titulo-2">
                  Instructores
                  <div class="contenido-item" style="padding-left:0;">
                    <span style="font-size:9pt;">
                      A continuación se presenta el listado de instructores con el total de horas programadas para la ficha:
                    </span>
                    <div class="titulo-1">
                    ${graficoHorasInstructoresActaHTML}
                    </div>
                    <div class="tabla-acta-wrap" style="margin-top:4px;">${tablaInstructoresHorasHTML}</div>
                    <span style="font-size:9pt;">Así mismo, se relacionan los instructores con las competencias que tienen asignadas y las horas programadas:</span>
                    <div class="tabla-acta-wrap" style="margin-top:4px;">${tablaInstructoresCompetenciasHTML}</div>
                  </div>
                  <ol class="lista-acta nivel-3" type="i">
                    <li class="titulo-3">
                      Listado de instructores con aprendices pendientes por emitir juicio.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          Se listan los instructores que tienen aprendices con juicios evaluativos pendientes,
                          indicando la competencia, los aprendices asociados y la cantidad de aprendices por competencia.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaPendientesJuicioHTML
                              ? tablaPendientesJuicioHTML
                              : "<em>(No se encontraron instructores con aprendices pendientes por emitir juicio en los reportes cargados.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                  </ol>
                </li>
                <li class="titulo-2">
                  Análisis de competencias y resultados de aprendizaje
                  <ol class="lista-acta nivel-3" type="i">
                    <li class="titulo-3">
                      Competencias y % de avance vs diseño.
                      <div class="contenido-item">
                        <p style="margin:0 0 2px 0;">
                          
                        </p>
                      <!--   <p style="margin:0 0 4px 0; font-size:9pt;">
                          Se presenta el porcentaje de avance por competencia, comparando el total de horas
                          programadas frente a las horas definidas en el diseño curricular.
                        </p> -->

                        ${graficoCompetenciasActaHTML}

                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaCompetenciasHorasHTML
                              ? tablaCompetenciasHorasHTML
                              : "<em>(No se encontró información del reporte % Competencias con Horas al momento de generar el acta.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Cronograma de programación de competencias (Gantt).
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          Se presenta el cronograma de programación de competencias con los meses en que cada competencia ha sido programada.
                        </p>

                        <div class="tabla-acta-wrap" style="margin-top:4px; overflow-x:auto;">
                          ${
                            tablaCronogramaGanttHTML
                              ? tablaCronogramaGanttHTML
                              : "<em>(No se encontró información del cronograma Gantt al momento de generar el acta.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Competencias sobre ejecutadas.
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          Se listan únicamente las competencias cuyo porcentaje de ejecución supera el
                          <strong>100&nbsp;%</strong> frente a las horas definidas en el diseño curricular
                          (filas resaltadas en rojo en el reporte % Competencias con Horas).
                        </p>

                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaCompetenciasSobreEjecutadasHTML
                              ? tablaCompetenciasSobreEjecutadasHTML
                              : "<em>(No se encontraron competencias que superen el 100% en el reporte % Competencias con Horas.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Competencias pendientes
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          De acuerdo con el reporte &quot;Competencias del Programa (Programada: Sí/No)&quot;,
                          se relacionan las competencias sin programación (<strong>No</strong>) o parcialmente programadas (<strong>1/2</strong>).
                          Las competencias se resaltan en rojo.
                        </p>

                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaCompetenciasProgramadasPendientesHTML
                              ? tablaCompetenciasProgramadasPendientesHTML
                              : "<em>(No se encontró información del reporte &quot;Competencias del Programa (Programada: Sí/No)&quot; al momento de generar el acta.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                    <li class="titulo-3">
                      Competencias y RAPs evaluados por instructor no programado.
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          De acuerdo con el reporte &quot;RAPs Aprobados - Por evaluar y No aprobados&quot;,
                          se relacionan los resultados de aprendizaje que fueron evaluados por un instructor
                          diferente al programado para esa competencia.
                        </p>

                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${
                            tablaRapsOtroInstructorHTML
                              ? tablaRapsOtroInstructorHTML
                              : "<em>(No se encontraron RAPs evaluados por instructores diferentes al programado.)</em>"
                          }
                        </div>
                      </div>
                    </li>
                  </ol>
                </li>
              </ol>
            </li>
            <li class="titulo-1">Análisis de casos especiales</li>
            <li class="titulo-1">Recomendaciones del comité</li>
          </ol>
        </td>
      </tr>

<!-- Continuación dentro de la misma tabla acta-encabezado: CONCLUSIONES -->
      <tr>
        <td colspan="4" class="acta-titulo" style="text-align:center; font-weight:700; padding:8px; border:1px solid #000;">
          CONCLUSIONES
        </td>
      </tr>

      <tr>
        <td colspan="4" style="height:120px; vertical-align:top; padding:8px; border:1px solid #000;"></td>
      </tr>

      <tr>
        <td colspan="4" style="text-align:center; font-weight:700; padding:6px; border:1px solid #000; background:#f3f4f6;">
          ESTABLECIMIENTO Y ACEPTACIÓN DE COMPROMISOS
        </td>
      </tr>
      <tr>
        <td style="width:38%; padding:6px; border:1px solid #000; font-weight:700; text-align:center;">ACTIVIDAD / DECISIÓN</td>
        <td style="width:15%; padding:6px; border:1px solid #000; font-weight:700; text-align:center;">FECHA</td>
        <td style="width:22%; padding:6px; border:1px solid #000; font-weight:700; text-align:center;">RESPONSABLE</td>
        <td style="width:25%; padding:6px; border:1px solid #000; font-weight:700; text-align:center;">FIRMA O PARTICIPACIÓN VIRTUAL</td>
      </tr>
      <tr><td style="height:28px; border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td></tr>
      <tr><td style="height:28px; border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td></tr>
      <tr><td style="height:28px; border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td></tr>
      <tr><td style="height:28px; border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td><td style="border:1px solid #000;"></td></tr>

      </table>

      <table class="acta-encabezado" style="width:100%; border-collapse:collapse; margin-top:-1px;">
      <tr>
        <td colspan="5" style="text-align:center; font-weight:700; padding:6px; border:1px solid #000; background:#f3f4f6;">
          DE: ASISTENTES Y APROBACIÓN DECISIONES
        </td>
      </tr>
      <tr>
        <td style="padding:6px; border:1px solid #000; width:24%; font-weight:700; text-align:center;">NOMBRE</td>
        <td style="padding:6px; border:1px solid #000; width:22%; font-weight:700; text-align:center;">DEPENDENCIA/ EMPRESA</td>
        <td style="padding:6px; border:1px solid #000; width:12%; font-weight:700; text-align:center;">APRUEBA (SI/NO)</td>
        <td style="padding:6px; border:1px solid #000; width:24%; font-weight:700; text-align:center;">OBSERVACIÓN</td>
        <td style="padding:6px; border:1px solid #000; width:18%; font-weight:700; text-align:center;">FIRMA O PARTICIPACIÓN VIRTUAL</td>
      </tr>
      <tr>
        <td style="padding:8px; border:1px solid #000; color:#c00000; font-weight:700;">${coordinadorAcademico}</td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
      </tr>
      <tr>
        <td style="padding:8px; border:1px solid #000; color:#c00000; font-weight:700;">${instructorGerente}</td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
      </tr>
      <tr>
        <td style="padding:8px; border:1px solid #000; color:#c00000; font-weight:700;">${aprendizVocero}</td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
      </tr>
      <tr>
        <td style="padding:8px; border:1px solid #000;">Psicologa de Bienestar:</td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
      </tr>
      <tr>
        <td style="height:28px; border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
        <td style="border:1px solid #000;"></td>
      </tr>

      <tr>
        <td colspan="5" style="border:1px solid #000; padding:8px; text-align:justify;">
          De acuerdo con La Ley 1581 de 2012, Protección de Datos Personales, el Servicio Nacional de
          Aprendizaje SENA, se compromete a garantizar la seguridad y protección de los datos personales
          que se encuentran almacenados en este documento, y les dará el tratamiento correspondiente en
          cumplimiento de lo establecido legalmente.
        </td>
      </tr>
      <tr>
        <td colspan="5" style="border:1px solid #000; padding:8px; text-align:center; font-weight:bold; height:80px;">
          ANEXOS
        </td>
      </tr>
      </table>

      
    </div>
  </body>
</html>
`;

  // Crear y descargar el archivo .doc
  const blob = new Blob(['\ufeff', contenidoHTML], { type: "application/msword" });
  const url  = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `Acta_Comite_Ficha_${codigoFicha || "SENA"}.doc`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// =========================
// Función para exportar los reportes seleccionados a Word
// =========================
function exportarReportesSeleccionadosAWord() {
  const checkboxes = document.querySelectorAll(".reporte-checkbox:checked");
  const secciones = Array.from(checkboxes).map(cb => document.getElementById(cb.value));

  if (secciones.length === 0) {
    alert("⚠️ Debes seleccionar al menos un reporte para exportar.");
    return;
  }

  // Copiar todos los estilos de la página (para conservar colores, fondos, etc.)
  const estilosOriginales = Array
    .from(document.querySelectorAll("style, link[rel='stylesheet']"))
    .map(el => el.outerHTML)
    .join("");


// Cabecera y estilos específicos para Word
let contenidoHTML = `
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Reporte SENA</title>
    ${estilosOriginales}
    <style>  
  @page Section1 {
        margin-top: 20mm;
        margin-right: 15mm;
        margin-bottom: 20mm;
        margin-left: 5mm;  /* margen izquierdo más estrecho */
      }
      div.Section1 {
        page: Section1;
      }

    /* Fuente general del documento Word */
      body {
        font-family: Arial, sans-serif;
        font-size: 10pt;
      }
      /* Títulos (h1, h2, h3) en tamaño 11 */
      h1, h2, h3 {
        font-size: 11pt;
      }
      /* Tablas: fuente a 8pt en todo el contenido de celdas */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        font-size: 8pt !important;
      }
      /* Ajuste de tablas pequeñas (alternativas y cursos) para Word */
      .tabla-alternativa-productiva {
        width: 70% !important;
        max-width: 700px;
        margin: 8px auto;
        table-layout: fixed;
      }
      .tabla-alternativa-productiva th,
      .tabla-alternativa-productiva td {
        word-break: break-word;
        padding: 6px;
      }
      .tabla-alternativa-productiva .col-cantidad {
        width: 15% !important;
        text-align: center;
      }
      .tabla-alternativa-productiva .col-alternativa {
        width: 60% !important;
      }
      .tabla-alternativa-productiva .col-nombres {
        width: 25% !important;
      }
      .tabla-alternativa-productiva.tabla-media {
        width: 55% !important;
        max-width: 420px;
      }
      .tabla-alternativa-productiva.tabla-media .col-nombres {
        width: 70% !important;
      }
      .tabla-alternativa-productiva.tabla-media .col-cantidad {
        width: 30% !important;
      }

      /* Refuerzo de anchos por columna para Word (reportes seleccionados) */
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(1),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(1) {
        width: 60% !important;
      }
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(2),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(2) {
        width: 15% !important;
        text-align: center;
      }
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(3),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(3) {
        width: 25% !important;
      }

      /* Encabezado del Gantt en Word: fondo verde y texto blanco */
      #ganttContainer table thead th,
      #ganttContainerPendientes table thead th {
        background-color: #16a34a !important;  /* verde SENA */
        color: #ffffff !important;
      }

      /* Ajustes específicos para el Gantt EN EL WORD */
      #ganttContainer,
      #ganttContainerPendientes {
        width: 100% !important;
        max-width: 100% !important;
        overflow: visible !important;   /* en Word no queremos scroll interno */
        box-sizing: border-box;
      }

      #ganttContainer table,
      #ganttContainerPendientes table {
        width: 100% !important;
        table-layout: fixed;            /* fuerza a repartir el ancho en la página */
      }

      #ganttContainer th,
      #ganttContainer td,
      #ganttContainerPendientes th,
      #ganttContainerPendientes td {
        font-size: 7pt !important;      /* más pequeño que el resto */
        padding: 2px 1px !important;    /* menos padding para que ocupen menos ancho */
        word-wrap: break-word;          /* permite que los textos largos se partan */
      }

#tituloGanttCompetencias {
  margin-top: 8px;
  margin-bottom: 12px;
  font-weight: 700;
}


    </style>
  </head>
  <body>
    `;

  // Encabezado institucional + información general + análisis + detalle (sin logo)
  contenidoHTML += construirBloqueEncabezadoExportWord();



// Añadir el contenido de los reportes seleccionados
secciones.forEach(seccion => {
  if (seccion) {
    contenidoHTML += seccion.innerHTML + "<hr/>";
  }
});


  contenidoHTML += "</body></html>";

  // Crear y descargar el archivo .doc
  const blob = new Blob(['\ufeff', contenidoHTML], { type: "application/msword" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `Reporte_SENA.doc`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
    // Aplica color al encabezado de la tabla (fila de títulos) en la hoja de Excel
function aplicarEstilosCabeceraTabla(ws) {
  if (!ws["!ref"]) return;

  const range = XLSX.utils.decode_range(ws["!ref"]);
  const headerRow = range.s.r; // primera fila de la tabla (donde está el thead)

  for (let C = range.s.c; C <= range.e.c; ++C) {
    const addr = XLSX.utils.encode_cell({ r: headerRow, c: C });
    const cell = ws[addr];
    if (!cell) continue;

    cell.s = cell.s || {};
    // Verde SENA de tu diseño
    cell.s.fill = {
      patternType: "solid",
      fgColor: { rgb: "FF28A745" }   // #28a745 con alfa FF
    };
    cell.s.font = {
      color: { rgb: "FFFFFFFF" },    // blanco
      bold: true
    };
  }
}

// Colorea filas en Excel según las clases HTML de la fila <tr>
function aplicarColoresFilaSegunClases(tabla, ws) {
  if (!ws["!ref"]) return;

  const range = XLSX.utils.decode_range(ws["!ref"]);
  const headerRow = range.s.r;
  const firstBodyRow = headerRow + 1; // primera fila de datos (después del encabezado)

  const filas = tabla.querySelectorAll("tbody tr");

  filas.forEach((tr, idx) => {
    let bg = null;

    // Misma lógica visual que en HTML/CSS:
    if (tr.classList.contains("fila-instructor-diferente")) {
      // Amarillo suave (#fff7b0)
      bg = "FFFFF7B0";
    } else if (tr.classList.contains("textoRojo")) {
      // Rojo claro (#fee2e2) para % Avance < 75%
      bg = "FFFEE2E2";
    }

    if (bg) {
      const excelRow = firstBodyRow + idx;

      for (let C = range.s.c; C <= range.e.c; ++C) {
        const addr = XLSX.utils.encode_cell({ r: excelRow, c: C });
        const cell = ws[addr];
        if (!cell) continue;

        cell.s = cell.s || {};
        cell.s.fill = {
          patternType: "solid",
          fgColor: { rgb: bg }
        };
      }
    }
  });
}

function exportarTodosLosReportesAExcel() {
  const wb = XLSX.utils.book_new();
  const checkboxes = document.querySelectorAll(".reporte-checkbox:checked");
  const seleccionados = Array.from(checkboxes).map(cb => cb.value);

  const agregarHoja = (tablaSelector, nombreHoja) => {
    const tabla = document.querySelector(tablaSelector)?.closest("table");
    if (!tabla) return;

    // 1) Pasar la tabla a hoja, empezando en A4 para dejar espacio al encabezado institucional
    const ws = XLSX.utils.table_to_sheet(tabla, { origin: "A4" });

    // 2) Aplicar colores al encabezado de la tabla y a filas especiales (.fila-instructor-diferente, .textoRojo)
    aplicarEstilosCabeceraTabla(ws);
    aplicarColoresFilaSegunClases(tabla, ws);

    // 3) Agregar encabezado institucional arriba (filas 1–3)
    XLSX.utils.sheet_add_aoa(
      ws,
      [
        ["SENA - Regional Tolima - Centro de Comercio y Servicios"],
        ["Reporte: " + nombreHoja],
        []
      ],
      { origin: "A1" }
    );

    XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
  };

  // Mantienes la misma lógica de selección de reportes
  if (seleccionados.includes("reporte1")) agregarHoja("#tbodyReporte1", "Reporte 1");
  if (seleccionados.includes("reporte2")) agregarHoja("#tbodyReporte2", "Reporte 2");
  if (seleccionados.includes("reporte3")) agregarHoja("#tbodyReporte3", "Reporte 3");
  if (seleccionados.includes("reporte4")) agregarHoja("#tbodyReporte4", "Reporte 4");

  if (seleccionados.includes("reporte5")) {
    agregarHoja("#tablaProgramadas", "Reporte 5A");
    agregarHoja("#tablaPendientes", "Reporte 5B");
  }

  if (seleccionados.includes("reporte6")) agregarHoja("#tablaReporte6", "Reporte 6");
  if (seleccionados.includes("reporte7")) agregarHoja("#pivotAvanceContainer", "Reporte 7");
  if (seleccionados.includes("reporte8")) agregarHoja("#tbodyReporte8", "Reporte 8");

  // Validar si el workbook tiene al menos una hoja
  if (wb.SheetNames.length === 0) {
    alert("⚠️ Debes seleccionar al menos un reporte para exportar.");
    return;
  }

  XLSX.writeFile(wb, `Reportes_Ficha_${codigoFichaPrimero || "SENA"}.xlsx`);
}

    document.addEventListener("DOMContentLoaded", function () {
      const botonWord = document.getElementById("btnExportarWord");
      if (botonWord) {
        botonWord.addEventListener("click", exportarReportesSeleccionadosAWord);
      } else {
        console.warn("❗ No se encontró el botón con id 'btnExportarWord'");
      }

      const botonExcel = document.getElementById("btnExportarExcel");
      if (botonExcel) {
        botonExcel.addEventListener("click", exportarTodosLosReportesAExcel);
      } else {
        console.warn("❗ No se encontró el botón con id 'btnExportarExcel'");
      }
  // NUEVO: botón Acta Comité
  const botonActaComite = document.getElementById("btnActaComite");
  if (botonActaComite) {
    botonActaComite.addEventListener("click", exportarActaComiteWord);
  } else {
    console.warn("❗ No se encontró el botón con id 'btnActaComite'");
  }

      // Lógica para pestañas (tabs)
      const tabs = document.querySelectorAll('.tabs a');
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.querySelector(targetId).classList.add('active');
          tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
    });

// --- Forzar que el gráfico de horas se ajuste cuando se abre el tab 3 ---
document.addEventListener("DOMContentLoaded", function () {
  const tabHorasLink = document.querySelector('.tabs a[data-tab="tab3"]');

  if (tabHorasLink) {
    tabHorasLink.addEventListener("click", function () {
      // damos un pequeño tiempo para que el tab se muestre y el contenedor tenga ancho
      setTimeout(function () {
        if (window.chartHoras) {
          chartHoras.render();
        }
      }, 150);
    });
  }
});
document.addEventListener("DOMContentLoaded", function () {
    const tab3Link = document.querySelector('.tabs a[href="#tab3"]');
    if (tab3Link) {
        tab3Link.addEventListener("click", function () {
            if (chartHorasInstructores) {
                // Esperamos un instante a que el tab ya esté visible
                setTimeout(function () {
                    chartHorasInstructores.render();
                }, 50);
            }
        });
    }
});
document.addEventListener("DOMContentLoaded", function () {
  const tab2Link = document.querySelector('.tabs a[href="#tab2"]');
  if (tab2Link) {
    tab2Link.addEventListener("click", function () {
      // pequeña espera para que el tab ya esté visible y tenga ancho
      setTimeout(function () {
        if (chartCompetenciasHoras) {
          chartCompetenciasHoras.render();      // solo reajusta tamaños
        } else {
          // por si el usuario abre tab2 después de cargar los datos
          dibujarGraficoCompetenciasHoras();
        }
      }, 50);
    });
  }
});

// Colores específicos por categoría para el gráfico de % competencias
function getColorCategoriaGrafico(categoria) {
  switch (categoria) {
    case "Transversales":
      return "#166534"; // verde oscuro
    case "Inglés":
      return "#0f766e"; // verde azulado
    case "Práctica":
      return "#022c22"; // verde muy oscuro (casi negro)
    case "Técnicas":
    default:
      return "#16a34a"; // verde actual
  }
}
// Actualiza el resumen numérico de la ficha
// (Nº aprendices, Nº instructores, Nº competencias e instructor con más horas)
function actualizarResumenFicha() {
    const spanAprendices    = document.getElementById("numAprendicesHeader");
    const spanInstructores  = document.getElementById("numInstructoresHeader");
    const spanCompetencias  = document.getElementById("numCompetenciasHeader");
    const spanInstructorTop = document.getElementById("instructorMasHorasHeader");

    if (!spanAprendices && !spanInstructores && !spanCompetencias && !spanInstructorTop) {
        return;
    }

    const normalizarEstadoResumen = (texto) => {
        return (texto || "")
            .toString()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase()
            .trim()
            .replace(/\s+/g, " ");
    };

    // 1) Nº aprendices: desde la tabla de estados
    let totalAprendices = 0;
    const tbodyEstado = document.getElementById("tbodyEstado");

    if (tbodyEstado) {
        const filas = tbodyEstado.querySelectorAll("tr");

        filas.forEach(tr => {
            const badgeEstado   = tr.querySelector(".badge-estado");
            const celdaCantidad = tr.querySelector(".col-cantidad");
            if (!badgeEstado || !celdaCantidad) return;

            const estadoNorm = normalizarEstadoResumen(badgeEstado.textContent);

            if (estadoNorm === "EN FORMACION" || estadoNorm === "CONDICIONADO") {
                const cant = parseInt(celdaCantidad.textContent, 10) || 0;
                totalAprendices += cant;
            }
        });
    }

    if (spanAprendices) {
        spanAprendices.textContent = totalAprendices;
    }
// 2) Nº instructores + instructor con más horas
let totalInstructores   = 0;
let instructorTopNombre = "";
let instructorTopHoras  = 0;

if (Array.isArray(datosHorario)) {
  const horasPorInstructor = {};

  datosHorario.forEach(fila => {
    const nombreInstructor = (fila["Nombre Instructor"] || "").toString().trim();
    const horas = Number(fila["Horas Programadas"]) || 0;

    if (!nombreInstructor) return;

    if (!horasPorInstructor[nombreInstructor]) {
      horasPorInstructor[nombreInstructor] = 0;
    }
    horasPorInstructor[nombreInstructor] += horas;
  });

  totalInstructores = Object.keys(horasPorInstructor).length;

  Object.entries(horasPorInstructor).forEach(([nombre, horas]) => {
    if (horas > instructorTopHoras) {
      instructorTopHoras  = horas;
      instructorTopNombre = nombre;
    }
  });

  // <<< AÑADIR ESTO >>>
  listaInstructoresGlobal = Object.keys(horasPorInstructor);
  instructorMasHorasGlobal = instructorTopNombre;
}

if (spanInstructores) {
 spanInstructores.textContent = totalInstructores;
}
if (spanInstructorTop) {
 spanInstructorTop.textContent = instructorTopNombre || "Sin información";
}

// 3) Nº competencias
let totalCompetencias = 0;

// Preferir el total de competencias del programa (archivo 3)
if (typeof totalCompetenciasPrograma === "number" && totalCompetenciasPrograma > 0) {
  totalCompetencias = totalCompetenciasPrograma;
} else if (typeof arrComp2 !== "undefined" && Array.isArray(arrComp2) && arrComp2.length) {
  totalCompetencias = arrComp2.length;
} else if (Array.isArray(datosHorario)) {
  // Fallback: contar únicas en el horario
  const competenciasSet = new Set();
  datosHorario.forEach(fila => {
    const comp = (fila["Nombre Competencia"] || "").toString().trim();
    if (comp) {
      competenciasSet.add(comp);
    }
  });
  totalCompetencias = competenciasSet.size;
}

if (spanCompetencias) {
  spanCompetencias.textContent = totalCompetencias;
}
}
// Actualiza el nombre mostrado en "Instructor con más horas cargadas"
// y guarda el Gerente de Proyecto seleccionado
function actualizarGerenteEnHeader(nombre) {
  gerenteProyectoSeleccionado = nombre || "";

  const spanInstructorTop = document.getElementById("instructorMasHorasHeader");
  if (spanInstructorTop) {
    spanInstructorTop.textContent = nombre || "Sin información";
  }
}

// Muestra el cuadro para confirmar Gerente de Proyecto
function mostrarModalGerenteProyecto() {
  const overlay       = document.getElementById("gerenteOverlay");
  const nombreSpan    = document.getElementById("gerenteInstructorNombre");
  const selectGerente = document.getElementById("selectGerenteProyecto");

  if (!overlay) return;

  const nombreTop = instructorMasHorasGlobal || "";

  if (nombreSpan) {
    nombreSpan.textContent = nombreTop || "No se pudo identificar el instructor con más horas programadas.";
  }

  // Rellenar el combo con todos los instructores
  if (selectGerente) {
    selectGerente.innerHTML = '<option value="">Seleccione un instructor…</option>';

    if (Array.isArray(listaInstructoresGlobal) && listaInstructoresGlobal.length > 0) {
      // Ordenar alfabéticamente de A a Z (insensible a mayúsculas/acentos)
      const listaOrdenada = [...listaInstructoresGlobal].sort((a, b) =>
        a.localeCompare(b, "es", { sensitivity: "base" })
      );

      listaOrdenada.forEach(nombre => {
        const opt = document.createElement("option");
        opt.value = nombre;
        opt.textContent = nombre;
        selectGerente.appendChild(opt);
      });
    }


    // Por defecto, dejar seleccionado el instructor con más horas (si existe)
    if (nombreTop) {
      selectGerente.value = nombreTop;
    }
  }

  overlay.style.display = "flex";
}


// =========================
// Filtros para Reporte 1
// =========================

// Estado actual de los filtros
let filtrosReporte1 = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  }
};

// Aplica filtros sobre registrosGlobal y vuelve a dibujar el reporte 1
function aplicarFiltrosYGenerarReporte1() {
  const tbody1 = document.getElementById("tbodyReporte1");
  if (!tbody1) return;
  if (!Array.isArray(registrosGlobal)) {
    tbody1.innerHTML = "";
    return;
  }

  const texto = (filtrosReporte1.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosReporte1.categorias;

  const registrosFiltrados = registrosGlobal.filter(r => {
    const cat = getCategoria(r.competencia);
    if (!categoriasActivas[cat]) return false; // filtra por categoría

    if (!texto) return true; // sin texto, solo aplica categorías

    const cadenaBusqueda = (
      (r.nombreInstructor || "") + " " +
      (r.apellidoInstructor || "") + " " +
      (r.estadoInstructor || "") + " " +
      (r.competencia || "")
    ).toLowerCase();

    // filtra por texto en nombre, apellido, estado o competencia
    return cadenaBusqueda.includes(texto);
  });

  generarReporte1(registrosFiltrados);
}

// =========================
// Filtros para Gantt de Competencias
// =========================

let filtrosGanttCompetencias = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  }
};

function aplicarFiltrosGanttCompetencias() {
  if (!Array.isArray(registrosGlobal) || !registrosGlobal.length) {
    generarGanttChart([]);
    return;
  }

  const texto = (filtrosGanttCompetencias.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosGanttCompetencias.categorias;

  const registrosFiltrados = registrosGlobal.filter(r => {
    const competencia = (r.competencia || "").toString().trim();
    let categoria = "";

    if (typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competencia);
      } catch (e) {
        categoria = "";
      }
    }

    // Filtro por categoría (chips)
    if (
      categoria &&
      Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
      !categoriasActivas[categoria]
    ) {
      return false;
    }

    // Filtro por texto (competencia, instructor, ficha, estado)
    if (texto) {
      const cadenaBusqueda = (
        (r.competencia || "") + " " +
        (r.nombreInstructor || "") + " " +
        (r.apellidoInstructor || "") + " " +
        (r.estadoInstructor || "") + " " +
        (r.codigoFicha || "")
      ).toLowerCase();

      if (!cadenaBusqueda.includes(texto)) {
        return false;
      }
    }

    return true;
  });

  generarGanttChart(registrosFiltrados);
}
// =========================
// Filtros para Reporte 4 (Competencias del Programa)
// =========================
let filtrosReporte4 = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  }
};

function aplicarFiltrosReporte4() {
  const tbody4 = document.getElementById("tbodyReporte4");
  if (!tbody4) return;

  const texto = (filtrosReporte4.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosReporte4.categorias;

  const filas = tbody4.querySelectorAll("tr");
  if (!filas.length) return;

  let contadorVisible = 1;

  filas.forEach(tr => {
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return; // por si hay filas especiales

    const competenciaTexto = (celdas[1]?.textContent || "").trim();

    let categoria = "";
    if (typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competenciaTexto);
      } catch (e) {
        categoria = "";
      }
    }

    // Filtro por categoría
    if (
      categoria &&
      Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
      !categoriasActivas[categoria]
    ) {
      tr.style.display = "none";
      return;
    }

    // Filtro por texto
    if (texto) {
      const textoFila = Array.from(celdas)
        .map(td => (td.textContent || "").toLowerCase())
        .join(" ");

      if (!textoFila.includes(texto)) {
        tr.style.display = "none";
        return;
      }
    }

    // Si pasa los filtros, se muestra y se renumera
    tr.style.display = "";
    celdas[0].textContent = contadorVisible++;
  });
}

// =========================
// Filtros para Reporte 6
// =========================

// Estado actual de los filtros para reporte 6
let filtrosReporte6 = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  },
  // NUEVO: si es true, solo muestra filas amarillas (fila-instructor-diferente)
  soloRapsOtro: false
};


// Aplica filtros sobre las filas ya pintadas en tbodyReporte6
function aplicarFiltrosReporte6() {
  const tbody6 = document.getElementById("tbodyReporte6");
  if (!tbody6) return;

  const texto = (filtrosReporte6.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosReporte6.categorias;

  const filas = tbody6.querySelectorAll("tr");
  if (!filas.length) return;

  let contadorVisible = 1;

  filas.forEach(tr => {
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    const competenciaTexto = (celdas[1]?.textContent || "").trim();

    let categoria = "";
    if (typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competenciaTexto);
      } catch (e) {
        categoria = "";
      }
    }

    // Filtro por categoría
    if (
      categoria &&
      Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
      !categoriasActivas[categoria]
    ) {
      tr.style.display = "none";
      return;
    }

    // Filtro por texto (busca en todas las columnas)
    if (texto) {
      const textoFila = Array.from(celdas)
        .map(td => (td.textContent || "").toLowerCase())
        .join(" ");

      if (!textoFila.includes(texto)) {
        tr.style.display = "none";
        return;
      }
    }
    // Filtro adicional: solo filas amarillas (Raps aprobados por otro instructor)
    if (filtrosReporte6.soloRapsOtro) {
      if (!tr.classList.contains("fila-instructor-diferente")) {
        tr.style.display = "none";
        return;
      }
    }

    // Si pasa los filtros se muestra y se renumera la fila
    tr.style.display = "";
    celdas[0].textContent = contadorVisible++;
  });
}


// =========================
// Filtros para Reporte 2
// =========================

let filtrosReporte2 = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  }
};

// Aplica filtros sobre las filas de tbodyReporte2
function aplicarFiltrosReporte2() {
  const tbody2 = document.getElementById("tbodyReporte2");
  if (!tbody2) return;

  const texto = (filtrosReporte2.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosReporte2.categorias;

  const filas = Array.from(tbody2.querySelectorAll("tr"));
  if (!filas.length) return;

  const visiblePorCategoria = {};
  const filasDatos = [];
  const filasCabecera = [];

  let categoriaContexto = "";

  // Primer pase: decidir visibilidad de filas de datos
  filas.forEach(tr => {
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    // Fila cabecera de categoría (colspan >= 5)
    if (celdas.length === 1 && celdas[0].colSpan >= 5) {
      const textoCabecera = (celdas[0].textContent || "").trim();
      categoriaContexto = textoCabecera;
      filasCabecera.push({ tr, categoria: textoCabecera });
      return;
    }

    // Fila de datos
    const competenciaTexto = (celdas[1]?.textContent || "").trim();
    let categoria = "";

    if (typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competenciaTexto);
      } catch (e) {
        categoria = "";
      }
    }

    if (!categoria) {
      categoria = categoriaContexto;
    }

    let visible = true;

    // Filtro por categoría
    if (
      categoria &&
      Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
      !categoriasActivas[categoria]
    ) {
      visible = false;
    }

    // Filtro por texto
    if (visible && texto) {
      const textoFila = Array.from(celdas)
        .map(td => (td.textContent || "").toLowerCase())
        .join(" ");

      if (!textoFila.includes(texto)) {
        visible = false;
      }
    }

    if (visible) {
      visiblePorCategoria[categoria] = true;
    }

    filasDatos.push({ tr, categoria, visible });
  });

  // Segundo pase: aplicar visibilidad a filas de datos
  filasDatos.forEach(item => {
    item.tr.style.display = item.visible ? "" : "none";
  });

  // Tercer pase: mostrar/ocultar cabeceras de categoría
  filasCabecera.forEach(item => {
    const cat = item.categoria;
    const activa =
      !Object.prototype.hasOwnProperty.call(categoriasActivas, cat) ||
      categoriasActivas[cat];

    if (activa && visiblePorCategoria[cat]) {
      item.tr.style.display = "";
    } else {
      item.tr.style.display = "none";
    }
  });
}
// =========================
// Filtros para Reporte 5 - Competencias ya programadas
// =========================

let filtrosReporte5Programadas = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  }
};

function aplicarFiltrosReporte5Programadas() {
  const tbodyProg = document.getElementById("tbodyProgramadas");
  if (!tbodyProg) return;

  const texto = (filtrosReporte5Programadas.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosReporte5Programadas.categorias;

  const filas = Array.from(tbodyProg.querySelectorAll("tr"));
  if (!filas.length) return;

  const visiblePorCategoria = {};
  const filasDatos = [];
  const filasCabecera = [];

  let categoriaContexto = "";

  filas.forEach(tr => {
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    // Fila cabecera de categoría (colspan >= 5)
    if (celdas.length === 1 && celdas[0].colSpan >= 5) {
      const textoCabecera = (celdas[0].textContent || "").trim();
      categoriaContexto = textoCabecera;
      filasCabecera.push({ tr, categoria: textoCabecera });
      return;
    }

    // Fila de datos
    const competenciaTexto = (celdas[1]?.textContent || "").trim();
    let categoria = categoriaContexto;

    // Si prefieres basarte en getCategoria, descomenta este bloque:
    /*
    if (typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competenciaTexto) || categoriaContexto;
      } catch (e) {
        categoria = categoriaContexto;
      }
    }
    */

    let visible = true;

    // Filtro por categoría
    if (
      categoria &&
      Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
      !categoriasActivas[categoria]
    ) {
      visible = false;
    }

    // Filtro por texto (busca en todas las columnas)
    if (visible && texto) {
      const textoFila = Array.from(celdas)
        .map(td => (td.textContent || "").toLowerCase())
        .join(" ");

      if (!textoFila.includes(texto)) {
        visible = false;
      }
    }

    if (visible && categoria) {
      visiblePorCategoria[categoria] = true;
    }

    filasDatos.push({ tr, categoria, visible });
  });

  // Aplicar visibilidad a filas de datos
  filasDatos.forEach(item => {
    item.tr.style.display = item.visible ? "" : "none";
  });

  // Mostrar u ocultar cabeceras de categoría según haya filas visibles
  filasCabecera.forEach(item => {
    const cat = item.categoria;
    const activa =
      !Object.prototype.hasOwnProperty.call(categoriasActivas, cat) ||
      categoriasActivas[cat];

    if (activa && visiblePorCategoria[cat]) {
      item.tr.style.display = "";
    } else {
      item.tr.style.display = "none";
    }
  });

  // Renumerar solo las filas visibles de datos
  let contadorVisible = 1;
  filas.forEach(tr => {
    if (tr.style.display === "none") return;
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    // Saltar filas cabecera de categoría
    if (celdas.length === 1 && celdas[0].colSpan >= 5) return;

    celdas[0].textContent = contadorVisible++;
  });
}

// =========================
// Listeners para filtros
// =========================

document.addEventListener("DOMContentLoaded", function () {
  // --- Reporte 1 ---
  const inputBusqueda1 = document.getElementById("busquedaReporte1");
  if (inputBusqueda1) {
    inputBusqueda1.addEventListener("input", function () {
      filtrosReporte1.texto = this.value || "";
      aplicarFiltrosYGenerarReporte1();
    });
  }

  const checkboxesCat1 = document.querySelectorAll(".chk-cat-reporte1");
  checkboxesCat1.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte1.categorias[cat] = this.checked;
      aplicarFiltrosYGenerarReporte1();
    });
  });

  // --- Reporte 2 ---
  const inputBusqueda2 = document.getElementById("busquedaReporte2");
  if (inputBusqueda2) {
    inputBusqueda2.addEventListener("input", function () {
      filtrosReporte2.texto = this.value || "";
      aplicarFiltrosReporte2();
    });
  }

  const checkboxesCat2 = document.querySelectorAll(".chk-cat-reporte2");
  checkboxesCat2.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte2.categorias[cat] = this.checked;
      aplicarFiltrosReporte2();
    });
  });
  // --- Gantt de Competencias ---
  const inputBusquedaGantt = document.getElementById("busquedaGanttCompetencias");
  if (inputBusquedaGantt) {
    inputBusquedaGantt.addEventListener("input", function () {
      filtrosGanttCompetencias.texto = this.value || "";
      aplicarFiltrosGanttCompetencias();
    });
  }

  const checkboxesCatGantt = document.querySelectorAll(".chk-cat-gantt");
  checkboxesCatGantt.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosGanttCompetencias.categorias[cat] = this.checked;
      aplicarFiltrosGanttCompetencias();
    });
  });

  // --- Reporte 6 ---
  const inputBusqueda6 = document.getElementById("busquedaReporte6");
  if (inputBusqueda6) {
    inputBusqueda6.addEventListener("input", function () {
      filtrosReporte6.texto = this.value || "";
      aplicarFiltrosReporte6();
    });
  }

  const checkboxesCat6 = document.querySelectorAll(".chk-cat-reporte6");
  checkboxesCat6.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte6.categorias[cat] = this.checked;
      aplicarFiltrosReporte6();
    });
  });
});



// Listeners para cajas de búsqueda y checkboxes
document.addEventListener("DOMContentLoaded", function () {
  // --- Reporte 1 ---
  const inputBusqueda1 = document.getElementById("busquedaReporte1");
  if (inputBusqueda1) {
    inputBusqueda1.addEventListener("input", function () {
      filtrosReporte1.texto = this.value || "";
      aplicarFiltrosYGenerarReporte1();
    });
  }

  const checkboxesCat1 = document.querySelectorAll(".chk-cat-reporte1");
  checkboxesCat1.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte1.categorias[cat] = this.checked;
      aplicarFiltrosYGenerarReporte1();
    });
  });

  // --- Reporte 6 ---
  const inputBusqueda6 = document.getElementById("busquedaReporte6");
  if (inputBusqueda6) {
    inputBusqueda6.addEventListener("input", function () {
      filtrosReporte6.texto = this.value || "";
      aplicarFiltrosReporte6();
    });
  }

  const checkboxesCat6 = document.querySelectorAll(".chk-cat-reporte6");
  checkboxesCat6.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte6.categorias[cat] = this.checked;
      aplicarFiltrosReporte6();
    });
  });
});

  // NUEVO: botón "Raps Aprobados por otro Instructor" (solo filas amarillas)
  const chkSoloRapsOtro = document.getElementById("chkSoloRapsOtro");
  if (chkSoloRapsOtro) {
    chkSoloRapsOtro.addEventListener("change", function () {
      filtrosReporte6.soloRapsOtro = this.checked;
      aplicarFiltrosReporte6();
    });
  }

function generarGanttChart(registrosBase) {
  const contenedor = document.getElementById("ganttContainer");
  if (!contenedor) return;

  const registros = Array.isArray(registrosBase) && registrosBase.length
    ? registrosBase
    : (Array.isArray(registrosGlobal) ? registrosGlobal : []);

  const categoriasGantt = {
    "Práctica": {},
    "Transversales": {},
    "Inglés": {},
    "Técnicas": {}
  };

  // Construir estructura por categoría / competencia / intervalos
  registros.forEach(reg => {
    const competencia = (reg.competencia || "").toString().trim();
    if (!competencia) return;

    const fechaIni = parseFecha(reg.fechaInicioProg);
    const fechaFin = parseFecha(reg.fechaFinProg);

    if (!(fechaIni instanceof Date) || isNaN(fechaIni) ||
        !(fechaFin instanceof Date) || isNaN(fechaFin)) {
      return;
    }

    const categoria = typeof getCategoria === "function"
      ? getCategoria(competencia)
      : "";

    if (!categoria || !categoriasGantt[categoria]) return;

    if (!categoriasGantt[categoria][competencia]) {
      categoriasGantt[categoria][competencia] = [];
    }

    categoriasGantt[categoria][competencia].push({
      start: fechaIni,
      end: fechaFin
    });
  });

  // Calcular rango global de fechas
  let overallStart = null;
  let overallEnd = null;

  Object.values(categoriasGantt).forEach(competencias => {
    Object.values(competencias).forEach(intervalos => {
      intervalos.forEach(({ start, end }) => {
        if (!overallStart || start < overallStart) overallStart = start;
        if (!overallEnd || end > overallEnd) overallEnd = end;
      });
    });
  });

  if (!overallStart || !overallEnd) {
    contenedor.innerHTML =
      "<p style='margin:8px 0; font-size:0.9rem; color:#6b7280;'>No hay datos para mostrar en el Gantt con los filtros actuales.</p>";
    return;
  }

  // Meses entre el inicio y el fin
  const monthLabels = [];
  const startMonth = new Date(overallStart.getFullYear(), overallStart.getMonth(), 1);
  const endMonth = new Date(overallEnd.getFullYear(), overallEnd.getMonth(), 1);

  for (let d = new Date(startMonth); d <= endMonth; d.setMonth(d.getMonth() + 1)) {
    monthLabels.push(new Date(d.getFullYear(), d.getMonth(), 1));
  }

  const mesesAbrev = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

  let html = "<table style='width:100%; border-collapse:collapse; font-size:12px;'>";
  html += "<thead><tr>";
  html += "<th style='border-bottom:1px solid #e5e7eb; padding:6px 4px; text-align:center;'>#</th>";
  html += "<th style='border-bottom:1px solid #e5e7eb; padding:6px 4px; text-align:left;'>Competencia</th>";

    monthLabels.forEach(m => {
    const mes   = mesesAbrev[m.getMonth()];
    const anio  = m.getFullYear();
    const label = mes + "<br>" + anio;   // ENE (salto de línea) 2024

    html += "<th style='border-bottom:1px solid #e5e7eb; padding:4px 2px; text-align:center;'>" + label + "</th>";
  });


  html += "</tr></thead><tbody>";

  let contador = 1;
  const ordenCategorias = ["Práctica","Transversales","Inglés","Técnicas"];

  ordenCategorias.forEach(cat => {
    const competencias = categoriasGantt[cat];
    if (!competencias || !Object.keys(competencias).length) {
      return;
    }

    // Fila de cabecera de categoría
    html += "<tr><td colspan='" + (2 + monthLabels.length) +
      "' style='background:#ecfdf5; color:#15803d; font-weight:600; padding:6px 8px; text-align:left;'>" +
      cat + "</td></tr>";

    Object.keys(competencias).sort().forEach(competencia => {
      const intervalos = competencias[competencia];

      html += "<tr>";
      html += "<td style='border-bottom:1px solid #f3f4f6; padding:4px 4px; text-align:center;'>" +
        (contador++) + "</td>";
      html += "<td style='border-bottom:1px solid #f3f4f6; padding:4px 6px;'>" +
        competencia + "</td>";

      monthLabels.forEach(m => {
        const mYear = m.getFullYear();
        const mMonth = m.getMonth();
        let enRango = false;

        for (const intervalo of intervalos) {
          const s = intervalo.start;
          const e = intervalo.end;
          const sYear = s.getFullYear();
          const sMonth = s.getMonth();
          const eYear = e.getFullYear();
          const eMonth = e.getMonth();

          if (
            (mYear > sYear || (mYear === sYear && mMonth >= sMonth)) &&
            (mYear < eYear || (mYear === eYear && mMonth <= eMonth))
          ) {
            enRango = true;
            break;
          }
        }

        let style = "border-bottom:1px solid #f3f4f6; padding:3px 2px; text-align:center;";
        let content = "&nbsp;";

        if (enRango) {
          style += " background:#22c55e; color:#ffffff; font-weight:600; border-radius:4px;";
          content = "●";
        }

        html += "<td style='" + style + "'>" + content + "</td>";
      });

      html += "</tr>";
    });
  });

  html += "</tbody></table>";
  contenedor.innerHTML = html;
}
  // --- Reporte 4: Competencias del Programa (Programada: Sí/No) ---
  const inputBusqueda4 = document.getElementById("busquedaReporte4");
  if (inputBusqueda4) {
    inputBusqueda4.addEventListener("input", function () {
      filtrosReporte4.texto = this.value || "";
      aplicarFiltrosReporte4();
    });
  }

  const checkboxesCat4 = document.querySelectorAll(".chk-cat-reporte4");
  checkboxesCat4.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte4.categorias[cat] = this.checked;
      aplicarFiltrosReporte4();
    });
  });
// Listeners para cajas de búsqueda y checkboxes
document.addEventListener("DOMContentLoaded", function () {
  // --- Reporte 1 ---
  const inputBusqueda1 = document.getElementById("busquedaReporte1");
  if (inputBusqueda1) {
    inputBusqueda1.addEventListener("input", function () {
      filtrosReporte1.texto = this.value || "";
      aplicarFiltrosYGenerarReporte1();
    });
  }

  const checkboxesCat1 = document.querySelectorAll(".chk-cat-reporte1");
  checkboxesCat1.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte1.categorias[cat] = this.checked;
      aplicarFiltrosYGenerarReporte1();
    });
  });

  // --- Reporte 6 ---
  const inputBusqueda6 = document.getElementById("busquedaReporte6");
  if (inputBusqueda6) {
    inputBusqueda6.addEventListener("input", function () {
      filtrosReporte6.texto = this.value || "";
      aplicarFiltrosReporte6();
    });
  }

  const checkboxesCat6 = document.querySelectorAll(".chk-cat-reporte6");
  checkboxesCat6.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte6.categorias[cat] = this.checked;
      aplicarFiltrosReporte6();
    });
  });

  // --- Reporte 5 - Competencias ya programadas ---
  const inputBusquedaProgramadas = document.getElementById("busquedaProgramadas");
  if (inputBusquedaProgramadas) {
    inputBusquedaProgramadas.addEventListener("input", function () {
      filtrosReporte5Programadas.texto = this.value || "";
      aplicarFiltrosReporte5Programadas();
    });
  }

  const checkboxesCatProgramadas = document.querySelectorAll(".chk-cat-programadas");
  checkboxesCatProgramadas.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
      filtrosReporte5Programadas.categorias[cat] = this.checked;
      aplicarFiltrosReporte5Programadas();
    });
  });
  // --- Reporte 3 - Listado de Instructores (Total de Horas Programadas) ---
  const inputInstructoresHoras = document.getElementById("busquedaInstructoresHoras");
  if (inputInstructoresHoras) {
    inputInstructoresHoras.addEventListener("input", function () {
      filtrarTablaSimplePorTexto("tbodyReporte3", this.value);
    });
  }

  // --- Reporte 6 - % Avance por Aprendiz ---
  const inputAvanceAprendiz = document.getElementById("busquedaAvanceAprendiz");
  if (inputAvanceAprendiz) {
    inputAvanceAprendiz.addEventListener("input", function () {
      // Filtra las filas del tbody usado por el reporte 7
      filtrarTablaSimplePorTexto("pivotAvanceContainer", this.value);
    });
  }
  // --- Reporte 7 - Competencias Pendientes por Aprendiz e Instructor ---
  const inputPendientesAprendiz = document.getElementById("busquedaPendientesAprendiz");
  if (inputPendientesAprendiz) {
    inputPendientesAprendiz.addEventListener("input", function () {
      filtrarTablasReporte8PorTexto(this.value);
    });
  }
  // --- Reporte 8 - Listado de Instructores con aprendices pendientes por emitir Juicio ---
  const inputPendientesJuicio = document.getElementById("busquedaPendientesJuicio");
  if (inputPendientesJuicio) {
    inputPendientesJuicio.addEventListener("input", function () {
      filtrarTablaSimplePorTexto("tbodyPendientesInstructorReporte8", this.value);
    });
  }
});


// Estado de filtros para Competencias Pendientes
let filtrosReporte5Pendientes = {
  texto: "",
  categorias: {
    "Práctica": true,
    "Transversales": true,
    "Inglés": true,
    "Técnicas": true
  }
};

function aplicarFiltrosReporte5Pendientes() {
  const tbodyPend = document.getElementById("tbodyPendientes");
  if (!tbodyPend) return;

  const texto = (filtrosReporte5Pendientes.texto || "").trim().toLowerCase();
  const categoriasActivas = filtrosReporte5Pendientes.categorias;

  const filas = Array.from(tbodyPend.querySelectorAll("tr"));
  if (!filas.length) return;

  const visiblePorCategoria = {};
  const filasDatos = [];
  const filasCabecera = [];

  let categoriaContexto = "";

  filas.forEach(tr => {
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    // Fila cabecera de categoría (colspan >= 5)
    if (celdas.length === 1 && celdas[0].colSpan >= 5) {
      const textoCabecera = (celdas[0].textContent || "").trim();
      categoriaContexto = textoCabecera;
      filasCabecera.push({ tr, categoria: textoCabecera });
      return;
    }

    // Fila de datos
    const competenciaTexto = (celdas[1]?.textContent || "").trim();
    let categoria = categoriaContexto;

    // Fallback: usar getCategoria si no tenemos categoría de cabecera
    if (!categoria && typeof getCategoria === "function") {
      try {
        categoria = getCategoria(competenciaTexto) || "";
      } catch (e) {
        categoria = "";
      }
    }

    let visible = true;

    // Filtro por categoría (chips)
    if (
      categoria &&
      Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
      !categoriasActivas[categoria]
    ) {
      visible = false;
    }

    // Filtro por texto (busca en todas las columnas)
    if (visible && texto) {
      const textoFila = Array.from(celdas)
        .map(td => (td.textContent || "").toLowerCase())
        .join(" ");

      if (!textoFila.includes(texto)) {
        visible = false;
      }
    }

    if (visible && categoria) {
      visiblePorCategoria[categoria] = true;
    }

    filasDatos.push({ tr, categoria, visible });
  });

  // Aplicar visibilidad a filas de datos
  filasDatos.forEach(item => {
    item.tr.style.display = item.visible ? "" : "none";
  });

  // Mostrar / ocultar cabeceras de categoría
  filasCabecera.forEach(item => {
    const cat = item.categoria;
    const activa =
      !Object.prototype.hasOwnProperty.call(categoriasActivas, cat) ||
      categoriasActivas[cat];

    if (activa && visiblePorCategoria[cat]) {
      item.tr.style.display = "";
    } else {
      item.tr.style.display = "none";
    }
  });

  // Renumerar solo las filas de datos visibles
  let contadorVisible = 1;
  filas.forEach(tr => {
    if (tr.style.display === "none") return;
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    // Saltar cabeceras de categoría
    if (celdas.length === 1 && celdas[0].colSpan >= 5) return;

    celdas[0].textContent = contadorVisible++;
  });
}
// =========================
// Filtro simple por texto para tablas sin categorías
// =========================
function filtrarTablaSimplePorTexto(idTbody, textoBusqueda) {
  const tbody = document.getElementById(idTbody);
  if (!tbody) return;

  const texto = (textoBusqueda || "").trim().toLowerCase();
  const filas = Array.from(tbody.querySelectorAll("tr"));
  if (!filas.length) return;

  let contadorVisible = 1;

  filas.forEach(tr => {
    const celdas = tr.getElementsByTagName("td");
    if (!celdas.length) return;

    // Si no hay texto, mostrar todo y renumerar
    if (!texto) {
      tr.style.display = "";
      celdas[0].textContent = contadorVisible++;
      return;
    }

    const textoFila = Array.from(celdas)
      .map(td => (td.textContent || "").toLowerCase())
      .join(" ");

    if (textoFila.includes(texto)) {
      tr.style.display = "";
      celdas[0].textContent = contadorVisible++;
    } else {
      tr.style.display = "none";
    }
  });
}

// =========================
// Filtro por texto para las tablas del reporte
// "Competencias Pendientes por Aprendiz e Instructor"
// (tablas dentro de contenedorTablasReporte8)
// =========================
function filtrarTablasReporte8PorTexto(textoBusqueda) {
  const contenedor = document.getElementById("contenedorTablasReporte8");
  if (!contenedor) return;

  const texto = (textoBusqueda || "").trim().toLowerCase();
  const tablas = Array.from(contenedor.querySelectorAll("table"));
  if (!tablas.length) return;

  let contadorVisible = 1;

  tablas.forEach(tabla => {
    const filas = Array.from(tabla.querySelectorAll("tbody tr"));
    let hayFilasVisibles = false;

    filas.forEach(tr => {
      const celdas = tr.getElementsByTagName("td");
      if (!celdas.length) return;

      // Sin texto: mostrar todo y renumerar
      if (!texto) {
        tr.style.display = "";
        celdas[0].textContent = contadorVisible++;
        hayFilasVisibles = true;
        return;
      }

      const textoFila = Array.from(celdas)
        .map(td => (td.textContent || "").toLowerCase())
        .join(" ");

      if (textoFila.includes(texto)) {
        tr.style.display = "";
        celdas[0].textContent = contadorVisible++;
        hayFilasVisibles = true;
      } else {
        tr.style.display = "none";
      }
    });

    // Mostrar u ocultar cada tabla según tenga filas visibles
    tabla.style.display = hayFilasVisibles ? "" : "none";
  });
}


  // --- Reporte 5 - Competencias pendientes por programar ---
  const inputBusquedaPendientes = document.getElementById("busquedaPendientes");
  if (inputBusquedaPendientes) {
    inputBusquedaPendientes.addEventListener("input", function () {
      filtrosReporte5Pendientes.texto = this.value || "";
      aplicarFiltrosReporte5Pendientes();
    });
  }

  const checkboxesCatPendientes = document.querySelectorAll(".chk-cat-pendientes");
  checkboxesCatPendientes.forEach(chk => {
    chk.addEventListener("change", function () {
      const cat = this.getAttribute("data-cat");
      if (!cat) return;
          filtrosReporte5Pendientes.categorias[cat] = this.checked;
    aplicarFiltrosReporte5Pendientes();
  });
});

// =========================
// Acordeón "Cargue de Archivos"
// =========================
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("accordionCargueToggle");
  const body   = document.getElementById("accordionCargueBody");
  const icon   = document.getElementById("accordionCargueIcon");

  if (toggle && body) {
    toggle.addEventListener("click", function () {
      const visible = body.style.display !== "none";

      if (visible) {
        body.style.display = "none";
        if (icon) icon.textContent = "▸";
      } else {
        body.style.display = "block";
        if (icon) icon.textContent = "▾";
      }
    });
  }
});

// =========================
// Acordeón "Información General de la Ficha"
// =========================
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("accordionInfoToggle");
  const body   = document.getElementById("accordionInfoBody");
  const icon   = document.getElementById("accordionInfoIcon");

  if (!toggle || !body) return;

  // El acordeón inicia ABIERTO porque no forzamos display:none en el body
  toggle.addEventListener("click", function () {
    const visible = body.style.display !== "none"; // "" o "block" = visible

    if (visible) {
      body.style.display = "none";
      if (icon) icon.textContent = "▸";
    } else {
      body.style.display = "block";
      if (icon) icon.textContent = "▾";
    }
  });
});
// -------------------------------------------------------------
// Obtiene la lista de aprendices EN FORMACION desde la tabla
// de estados (#tbodyEstado)
// -------------------------------------------------------------
function obtenerAprendicesEnFormacionDesdeTabla() {
  const lista = [];
  const tbodyEstado = document.getElementById("tbodyEstado");
  if (!tbodyEstado) return lista;

  const filas = tbodyEstado.querySelectorAll("tr");
  filas.forEach(tr => {
    const celdas = tr.querySelectorAll("td");
    if (celdas.length < 2) return;

    // Primera celda: estado
    const estadoTexto = (celdas[0].innerText || celdas[0].textContent || "")
      .toUpperCase()
      .trim();

    // Normalizar variantes EN FORMACION / EN FORMACIÓN
    if (estadoTexto === "EN FORMACION" || estadoTexto === "EN FORMACIÓN") {
      // Segunda celda: nombres (separados por saltos de línea o comas)
      const nombresRaw = celdas[1].innerText || celdas[1].textContent || "";
      nombresRaw
        .split(/\n|,/)           // separa por salto de línea o coma
        .map(n => n.trim())
        .filter(n => n.length > 0)
        .forEach(nombre => {
          lista.push(nombre);
        });
    }
  });

  // Devolver nombres únicos ordenados A-Z
  const unicos = Array.from(new Set(lista));
  unicos.sort((a, b) => a.localeCompare(b, "es"));
  return unicos;
}

// Actualiza el encabezado "Aprendiz Vocero" en Información General
function actualizarAprendizVoceroHeader(nombre) {
  const spanVocero = document.getElementById("aprendizVoceroHeader");
  if (spanVocero) {
    spanVocero.textContent = nombre && nombre.trim() ? nombre : "-";
  }
}

// Muestra el modal para seleccionar Aprendiz Vocero
function mostrarModalVocero() {
  const overlayVocero  = document.getElementById("voceroOverlay");
  const selectVocero   = document.getElementById("selectAprendizVocero");
  const msgErrorVocero = document.getElementById("voceroMensajeError");

  if (!overlayVocero || !selectVocero) return;

  // Limpiar estado previo
  if (msgErrorVocero) msgErrorVocero.style.display = "none";
  selectVocero.innerHTML = '<option value="">Seleccione un aprendiz…</option>';

  // Cargar lista de aprendices EN FORMACION desde la tabla de estados
  const lista = obtenerAprendicesEnFormacionDesdeTabla();
  lista.forEach(nombre => {
    const opt = document.createElement("option");
    opt.value = nombre;
    opt.textContent = nombre;
    selectVocero.appendChild(opt);
  });

  overlayVocero.style.display = "flex";
}

// =========================
// Acordeón "Reportes"
// =========================
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("accordionReportesToggle");
  const body   = document.getElementById("accordionReportesBody");
  const icon   = document.getElementById("accordionReportesIcon");

  if (!toggle || !body) return;

  // El acordeón inicia ABIERTO porque no forzamos display:none en el body
  toggle.addEventListener("click", function () {
    const visible = body.style.display !== "none"; // "" o "block" = visible

    if (visible) {
      body.style.display = "none";
      if (icon) icon.textContent = "▸";
    } else {
      body.style.display = "block";
      if (icon) icon.textContent = "▾";
    }
  });
});
// =========================
// Acordeón "Centro de Reportes"
// =========================
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("accordionCentroToggle");
  const body   = document.getElementById("accordionCentroBody");
  const icon   = document.getElementById("accordionCentroIcon");

  if (!toggle || !body) return;

  // El acordeón inicia ABIERTO porque no forzamos display:none en el body
  toggle.addEventListener("click", function () {
    const visible = body.style.display !== "none"; // "" o "block" = visible

    if (visible) {
      body.style.display = "none";
      if (icon) icon.textContent = "▸";
    } else {
      body.style.display = "block";
      if (icon) icon.textContent = "▾";
    }
  });
});

// =========================
// Pantalla inicial / Login Coordinador Acad?mico
// =========================
document.addEventListener("DOMContentLoaded", function () {
  // -------- Login Coordinador --------
  const loginOverlay = document.getElementById("loginOverlay");
  const selectCoord  = document.getElementById("coordinadorSelect");
  const btnIngresar  = document.getElementById("btnIngresar");
  const msgError     = document.getElementById("loginMensajeError");
  const loginCard    = loginOverlay ? loginOverlay.querySelector(".login-card") : null;
  const chkRoles     = document.getElementById("chkValidarRoles");

  if (chkRoles) {
    validarRolesActivos = chkRoles.checked;
    chkRoles.addEventListener("change", function () {
      validarRolesActivos = this.checked;
      if (!validarRolesActivos && msgError) {
        msgError.style.display = "none";
      }
    });
  }
 
  if (btnIngresar && selectCoord && loginOverlay) {
    btnIngresar.addEventListener("click", function () {
      const debeValidar = validarRolesActivos !== false;
      const valor = (selectCoord.value || "").trim();
      if (debeValidar && !valor) {
        if (msgError) msgError.style.display = "block";
        return;
      }

      coordinadorAcademicoSeleccionado = debeValidar ? valor : "";

      if (msgError) msgError.style.display = "none";

      // Actualizar el encabezado con el Coordinador seleccionado
      const coordHeader = document.getElementById("coordinadorAcademicoHeader");
      if (coordHeader) {
        coordHeader.textContent = debeValidar
          ? (coordinadorAcademicoSeleccionado || "-")
          : "-";
      }

      // Animaci?n de salida del login
      if (loginCard) {
        loginCard.classList.add("login-exit");

        const onAnimationEnd = function () {
          loginCard.removeEventListener("animationend", onAnimationEnd);
          loginOverlay.style.display = "none";
        };

        loginCard.addEventListener("animationend", onAnimationEnd);
      } else {
        // Fallback por si no se encuentra la tarjeta
        loginOverlay.style.display = "none";
      }
    });
  }

// -------- Modal Gerente de Proyecto --------
  const gerenteOverlay      = document.getElementById("gerenteOverlay");
  const btnGerenteSi        = document.getElementById("btnGerenteSi");
  const btnGerenteNo        = document.getElementById("btnGerenteNo");
  const btnAceptarGerente   = document.getElementById("btnAceptarGerente");
  const contSelectorGerente = document.getElementById("contenedorSelectorGerente");
  const selectGerente       = document.getElementById("selectGerenteProyecto");
  const msgGerenteError     = document.getElementById("gerenteMensajeError");

   // Botón SÍ: el instructor con más horas ES el Gerente de Proyecto
  if (btnGerenteSi) {
    btnGerenteSi.addEventListener("click", function () {
      const nombreTop = instructorMasHorasGlobal || "";
      actualizarGerenteEnHeader(nombreTop);

      if (gerenteOverlay) gerenteOverlay.style.display = "none";

      // Después de confirmar el Gerente, abrir selección de Aprendiz Vocero
      mostrarModalVocero();
    });
  }


  // Botón NO: mostrar lista desplegable con todos los instructores
  if (btnGerenteNo) {
    btnGerenteNo.addEventListener("click", function () {
      if (contSelectorGerente) {
        contSelectorGerente.style.display = "block";
      }
    });
  }

    // Botón Aceptar en la lista de instructores
  if (btnAceptarGerente) {
    btnAceptarGerente.addEventListener("click", function () {
      const nombreSeleccionado = (selectGerente && selectGerente.value || "").trim();

      if (!nombreSeleccionado) {
        if (msgGerenteError) msgGerenteError.style.display = "block";
        return;
      }

      if (msgGerenteError) msgGerenteError.style.display = "none";

      actualizarGerenteEnHeader(nombreSeleccionado);

      if (gerenteOverlay) {
        gerenteOverlay.style.display = "none";
      }

      // Después de seleccionar manualmente el Gerente, abrir selección de Aprendiz Vocero
      mostrarModalVocero();
    });
  }

  // -------- Modal Aprendiz Vocero --------
  const btnAceptarVocero = document.getElementById("btnAceptarVocero");

  if (btnAceptarVocero) {
    btnAceptarVocero.addEventListener("click", function () {
      const selectVocero   = document.getElementById("selectAprendizVocero");
      const msgErrorVocero = document.getElementById("voceroMensajeError");
      const overlayVocero  = document.getElementById("voceroOverlay");

      if (!selectVocero || !overlayVocero) return;

      const nombre = (selectVocero.value || "").trim();
      if (!nombre) {
        if (msgErrorVocero) msgErrorVocero.style.display = "block";
        return;
      }

      if (msgErrorVocero) msgErrorVocero.style.display = "none";

      // Guardar en variable global y mostrar en el header
      aprendizVoceroSeleccionado = nombre;
      actualizarAprendizVoceroHeader(nombre);

      overlayVocero.style.display = "none";
    });
  }

});
  </script>
</body>
</html>
