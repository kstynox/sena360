<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>SENA 360 – Panel Integral de Seguimiento a la FPI</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<style>
    /* ============================
   NUEVO DISEÑO TIPO TARJETAS
   ============================ */

    /* Paleta base */
    :root {
    --verde-sena: #28a745;
    --verde-sena-oscuro: #1e8a37;
    --verde-sena-claro: #e9f7ef;
    --gris-fondo: #f5f7fb;
    --gris-borde: #e5e7eb;
    --texto-principal: #111827;
    --texto-secundario: #6b7280;
    --chip-success: #1e8a37;
    --chip-success-dark: #0f4f2c;
    --chip-warning: #f9be00;
    --chip-warning-dark: #d97706;
    --chip-danger: #b91c1c;
    }

    /* Fondo general */
    body {
      margin: 0;
      font-family: 'Roboto', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--gris-fondo);
      color: var(--texto-principal);
    }

    .mes-selector-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 16px 0;
    }

    .mes-selector-panel {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 10px 18px;
      border-radius: 20px;
      background: linear-gradient(135deg, #d1fae5, #6ee7b7);
      box-shadow: 0 12px 24px rgba(16, 185, 129, 0.2);
      border: 1px solid #34d399;
      font-weight: 600;
      color: #065f46;
    }

    .mes-selector-panel select {
      border: none;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 0.95rem;
      outline: none;
      color: #065f46;
      min-width: 220px;
      box-shadow: inset 0 0 0 1px rgba(6, 95, 70, 0.2);
    }

    .mes-selector-panel select:focus {
      box-shadow: inset 0 0 0 2px rgba(6, 95, 70, 0.4);
    }

    .reportes-main table tbody tr:nth-child(odd) {
      background-color: rgba(15, 23, 42, 0.025);
    }

    .reportes-main table tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.4);
    }

    .reportes-main table tbody tr:hover {
      background-color: rgba(15, 23, 42, 0.08);
      transition: background 0.2s ease;
    }

    td.col-dias[data-color="amarillo"] .dias-color {
      background: rgba(249, 190, 0, 0.12);
      border-radius: 4px;
      padding: 0 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    td.col-dias[data-color="amarillo"] {
      background: rgba(249, 190, 0, 0.08);
    }

    .mes-selector-icon {
      font-size: 1.2rem;
    }

    /* ================= LOGIN INICIAL (COORDINADOR) ================= */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top,
          rgba(40, 167, 69, 1),
          rgba(15, 23, 42, 1));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    /* Overlay para confirmar Gerente de Proyecto */
    #gerenteOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(16, 185, 129, 0.15), rgba(15, 23, 42, 0.9));
      display: none;
      /* Oculto por defecto, se muestra con JS */
      align-items: center;
      justify-content: center;
      z-index: 1000;
      /* Encima de todo lo demás */
    }

    /* Overlay para seleccionar Aprendiz Vocero (mismo estilo que gerente) */
    #voceroOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(16, 185, 129, 0.15), rgba(15, 23, 42, 0.9));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }


    /* Botón rojo para la opción NO */
    .btn-negativo {
      background: linear-gradient(to right, #dc2626, #b91c1c);
      box-shadow: 0 12px 30px rgba(220, 38, 38, 0.5);
    }

    .btn-negativo:hover {
      background: linear-gradient(to right, #b91c1c, #7f1d1d);
      box-shadow: 0 16px 36px rgba(239, 68, 68, 0.6);
    }

    @keyframes loginZoomIn {
      0% {
        transform: scale(0.85);
        opacity: 0;
      }

      60% {
        transform: scale(1.02);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }


    .login-card {
      background-color: #ffffff;
      border-radius: 18px;
      padding: 32px 40px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      position: relative;
      max-width: 520px;
      width: 90%;
      text-align: center;
      border: 1px solid rgba(148, 163, 184, 0.4);

      /* Animación de entrada */
      transform-origin: center;
      animation: loginZoomIn 0.4s ease-out;
    }

    /* Estado de salida del login (al hacer clic en Ingresar) */
    .login-card.login-exit {
      animation: loginZoomOut 0.3s ease-in forwards;
    }


    @keyframes loginZoomIn {
      0% {
        transform: scale(0.85);
        opacity: 0;
      }

      60% {
        transform: scale(1.02);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes loginZoomOut {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      100% {
        transform: scale(0.85);
        opacity: 0;
      }
    }

    .login-logo img {
      width: 80px;
      height: auto;
      margin-bottom: 12px;
    }

    .login-title {
      margin: 0 0 8px 0;
      font-size: 22px;
      font-weight: 700;
      color: var(--verde-sena-oscuro);
    }

    .login-subtitle {
      margin: 0 0 20px 0;
      font-size: 13px;
      color: var(--texto-secundario);
    }

    .login-field {
      text-align: left;
      margin-bottom: 20px;
    }

    .login-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--texto-principal);
    }

    .login-field select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--gris-borde);
      font-size: 14px;
    }

    .login-button {
      width: 100%;
      justify-content: center;
      margin-top: 4px;
    }

    .login-error {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      color: #b91c1c;
      font-size: 13px;
    }

    .login-toggle-roles {
      position: absolute;
      top: 6px;
      right: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: transparent;
      border: none;
      cursor: pointer;
      opacity: 0.55;
    }

    .login-toggle-roles input[type="checkbox"] {
      accent-color: #ffffff;
      width: 14px;
      height: 14px;
      margin: 0;
    }

    /* ================= HEADER ================= */

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 18px 40px;
      background-color: #ffffff;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      border-bottom: 4px solid var(--verde-sena);
    }

    header img {
      height: 64px;
      margin-right: 12px;
    }

    header>h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    /* Bloque derecho del encabezado */
    .header-center {
      margin-left: auto;
      text-align: right;
    }

    .header-center h2 {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      color: var(--texto-secundario);
    }

    .header-center h1 {
      margin: 4px 0 0 0;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: var(--verde-sena-oscuro);
    }


    .header-center hr {
      display: none;
    }

    /* ================= TARJETAS PRINCIPALES (ARCHIVOS Y REPORTES) ================= */

    .contenedor {
      max-width: 1300px;
      margin: 24px auto;
      padding: 22px 28px;
      background-color: #fdfefe;
      border-radius: 16px;
      border: 1px solid #e0e7ef;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
    }

    /* Acordeón de Cargue de Archivos */
    .acordeon-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      background-color: #f9fafb;
      font-size: 14px;
      font-weight: 600;
      color: var(--texto-principal);
      cursor: pointer;
    }

    .acordeon-header:hover {
      background-color: var(--verde-sena-claro);
    }

    .acordeon-icon {
      font-size: 16px;
    }

    .acordeon-body {
      margin-top: 16px;
    }

    /* Separación entre los pasos dentro del acordeón */
    #accordionCargueBody>div+div {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px dashed var(--gris-borde);
    }


    .contenedor h2 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    /* Layout de los bloques de carga de archivo */
    #sectionFile1,
    #sectionFile2,
    #sectionFile3 {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 16px 24px;
    }

    /* Ocultar <br> para no romper la fila */
    #sectionFile1 br,
    #sectionFile2 br,
    #sectionFile3 br {
      display: none;
    }

    /* Título a lo ancho */
    #sectionFile1 h2,
    #sectionFile2 h2,
    #sectionFile3 h2 {
      flex: 1 1 100%;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Números 1, 2 y 3 en círculo verde */
    #sectionFile1 h2::before,
    #sectionFile2 h2::before,
    #sectionFile3 h2::before {
      /* número del paso por defecto */
      content: "1";
    }

    #sectionFile2 h2::before {
      content: "2";
    }

    #sectionFile3 h2::before {
      content: "3";
    }

    /* Estilo visual del círculo */
    #sectionFile1 h2::before,
    #sectionFile2 h2::before,
    #sectionFile3 h2::before {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background-color: var(--verde-sena);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
    }

    /* Input y botón en fila */
    #sectionFile1 input[type="file"],
    #sectionFile2 input[type="file"],
    #sectionFile3 input[type="file"] {
      flex: 1 1 60%;
      max-width: 650px;
    }

    #btnProcesar1,
    #btnProcesar2,
    #btnCargarDiseno {
      flex: 0 0 auto;
    }

    /* Mensaje ocupa toda la fila inferior */
    #mensajeArchivo1,
    #mensajeArchivo2,
    #mensajeArchivo3 {
      flex: 1 1 100%;
    }

    /* ================= INPUT FILE ESTILO ================= */

    input[type="file"] {
      font-family: inherit;
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      background-color: #f9fafb;
      color: var(--texto-secundario);
    }

    /* Chrome / Edge */
    input[type="file"]::-webkit-file-upload-button {
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 14px;
      margin-right: 10px;
      border-radius: 999px;
      border: none;
      background-color: var(--verde-sena-claro);
      color: var(--verde-sena-oscuro);
      cursor: pointer;
    }

    /* Firefox */
    input[type="file"]::file-selector-button {
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 14px;
      margin-right: 10px;
      border-radius: 999px;
      border: none;
      background-color: var(--verde-sena-claro);
      color: var(--verde-sena-oscuro);
      cursor: pointer;
    }

    /* ================= BOTONES ================= */

    .btnEstilo,
    #btnImprimir,
    .btnExportarPDF,
    .btnExportarExcel,
    .btn-menu-reporte {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background-color: var(--verde-sena);
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(40, 167, 69, 0.45);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
    }

    .btnEstilo:hover,
    #btnImprimir:hover,
    .btnExportarPDF:hover,
    .btnExportarExcel:hover,
    .btn-menu-reporte:hover {
      background-color: var(--verde-sena-oscuro);
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(40, 167, 69, 0.5);
    }

    .filtros-colores-dias {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 10px;
      margin: 10px 0 0 0;
    }

    .filtros-raps-botones {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      margin-left: 8px;
    }

    .chip-reporte1.chip-raps-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 18px;
      border-radius: 999px;
      border: 1px solid var(--verde-sena-oscuro);
      min-width: 160px;
      font-size: 13px;
      font-weight: 500;
      transition:
        background-color 0.15s ease,
        color 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.15s ease;
      cursor: pointer;
      background-color: #ffffff;
      color: var(--verde-sena-oscuro);
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
      width: auto;
    }

    .chip-reporte1.chip-raps-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.15);
    }

    .chip-reporte1.chip-raps-btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
    }

    .chip-reporte1.chip-raps-btn.chip-amarillo {
      border-color: #f59e0b;
      color: #92400e;
    }

    .chip-reporte1.chip-raps-btn.chip-naranja {
      border-color: #ea580c;
      color: #7c2d12;
    }

    .chip-reporte1.chip-raps-btn .chip-text {
      color: inherit;
    }

    .btn-filtro-dias {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 18px;
      min-width: 120px;
      border-radius: 999px;
      border: 1px solid var(--verde-sena-oscuro);
      background-color: #ffffff;
      color: var(--verde-sena-oscuro);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
      transition:
        background-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.15s ease,
        border-color 0.15s ease;
      width: auto;
      flex: 0 0 auto;
      align-self: flex-start;
    }

    .btn-filtro-dias.btn-verde {
      border-color: var(--verde-sena-oscuro);
      color: var(--verde-sena-oscuro);
    }

    .btn-filtro-dias.btn-rojo {
      border-color: #b91c1c;
      color: #b91c1c;
    }

    .btn-filtro-dias.btn-morado {
      border-color: #7c3aed;
      color: #7c3aed;
    }

    .btn-filtro-dias:hover {
      border-color: var(--verde-sena);
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.15);
    }

    .btn-filtro-dias.active {
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.35);
      transform: translateY(-1px);
    }

    .btn-filtro-dias.btn-verde.active {
      background: linear-gradient(to right, #28a745, #1e8a37);
      border-color: #1e8a37;
    }

    .btn-filtro-dias.btn-rojo.active {
      background: linear-gradient(to right, #dc2626, #b91c1c);
      border-color: #b91c1c;
    }

    .btn-filtro-dias.btn-morado.active {
      background: linear-gradient(to right, #a855f7, #7c3aed);
      border-color: #7c3aed;
    }

    .btn-filtro-dias.btn-negro {
      border-color: #0f172a;
      color: #0f172a;
    }

    .btn-filtro-dias.btn-negro.active {
      background: linear-gradient(to right, #111827, #0f172a);
      border-color: #0f172a;
      color: #ffffff;
    }



    /* ================= MENSAJE DE ARCHIVO CARGADO ================= */

    .mensaje-archivo {
      margin-top: 8px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #bbf7d0;
      background-color: #ecfdf3;
      color: #166534;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mensaje-archivo::before {
      content: "✔";
      font-size: 14px;
    }

    .error {
      display: none;
      margin-top: 8px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      background-color: #fee2e2;
      color: #b91c1c;
      font-size: 14px;
      font-weight: 500;
    }

    .nota-archivo {
      margin: 6px 0 4px;
      font-size: 12px;
      color: var(--texto-secundario);
    }

    /* ================= TABS ================= */

    .tabs {
      list-style: none;
      padding: 0;
      margin: 0 0 24px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    /* cada tarjeta ocupa 1/4 aprox. y se acomoda en responsive */
    .tabs li {
      flex: 1 1 260px;
    }

    /* Tarjeta del menú de reportes */
    .tabs li a {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 14px 14px;
      /* menos padding vertical */
      min-height: 100px;
      /* menos alto */
      text-align: center;
      text-decoration: none;
      border-radius: 18px;
      border: 1px solid var(--gris-borde);
      background-color: #ffffff;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      cursor: pointer;
      transition:
        background-color 0.18s ease,
        border-color 0.18s ease,
        box-shadow 0.18s ease,
        transform 0.12s ease;
    }

    /* Ícono */
    .tab-icon {
      font-size: 28px;
      color: #d1d5db;
      transition: color 0.18s ease, transform 0.12s ease;
    }

    /* Texto “REPORTE X” */
    .tab-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
    }

    /* Título del reporte */
    .tab-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--texto-principal);
    }

    /* Estado inactivo + hover */
    .tabs li a:hover {
      border-color: var(--verde-sena);
      background-color: #f9fafb;
      box-shadow: 0 10px 22px rgba(40, 167, 69, 0.25);
      transform: translateY(-1px);
    }

    .tabs li a:hover .tab-icon,
    .tabs li a:hover .tab-title {
      color: var(--verde-sena-oscuro);
    }

    /* Estado ACTIVO (tarjeta verde) */
    .tabs li a.active {
      background: linear-gradient(to bottom, var(--verde-sena), var(--verde-sena-oscuro));
      border-color: var(--verde-sena-oscuro);
      box-shadow: 0 14px 28px rgba(40, 167, 69, 0.5);
      transform: translateY(-1px);
    }

    .tabs li a.active .tab-icon,
    .tabs li a.active .tab-label,
    .tabs li a.active .tab-title {
      color: #ffffff;
    }

    /* Flechita verde hacia abajo cuando está activo */
    .tab-arrow {
      position: absolute;
      bottom: -9px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 18px;
      height: 18px;
      background: var(--verde-sena);
      border-radius: 4px;
      box-shadow: 0 6px 10px rgba(40, 167, 69, 0.35);
      display: none;
    }

    .tabs li a.active .tab-arrow {
      display: block;
    }

    /* En móviles las tarjetas pasan a una por fila (esto ya lo tienes al final, lo dejamos igual) */
    @media (max-width: 900px) {
      .tabs li {
        flex: 1 1 100%;
      }
    }

    /* Contenido de pestañas como tarjeta */
    .tab-content {
      display: none;
      max-width: 1200px;
      margin: 0 auto 24px auto;
      padding: 20px 24px;
      background-color: #ffffff;
      border-radius: 16px;
      border: 1px solid var(--gris-borde);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    .tab-content.active {
      display: block;
    }

    /* Descripción corta al inicio de cada reporte */
    .descripcion-reporte {
      margin: 4px 0 14px 0;
      font-size: 0.9rem;
      color: var(--texto-secundario);
      line-height: 1.45;
    }

    /* ================= TABLAS ================= */

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: #ffffff;
    }

    th,
    td {
      padding: 8px 10px;
      font-size: 13px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    thead th {
      background-color: var(--verde-sena);
      color: #ffffff;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }

    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    /* ================= ORDENAMIENTO DE TABLAS ================= */

    th.th-sortable {
      cursor: pointer;
      user-select: none;
    }

    th.th-sortable .th-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    th.th-sortable .sort-icons {
      display: inline-flex;
      flex-direction: column;
      line-height: 10px;
      font-size: 10px;
    }

    th.th-sortable .sort-icon {
      opacity: 0.75;
      transition: opacity 0.12s ease, color 0.12s ease;
    }

    th.th-sortable .sort-icon.up {
      color: #bbf7d0;
    }

    th.th-sortable .sort-icon.down {
      color: #fecaca;
    }

    th.th-sortable[data-sort-dir="asc"] .sort-icon.up {
      opacity: 1;
    }

    th.th-sortable[data-sort-dir="desc"] .sort-icon.down {
      opacity: 1;
    }

    th.th-sortable[data-sort-dir="asc"] .sort-icon.down,
    th.th-sortable[data-sort-dir="desc"] .sort-icon.up {
      opacity: 0.35;
    }

    /* Estilo específico para la lista de aprendices con solo práctica pendiente */
    .texto-resumen-practica {
      margin-top: 10px;
      font-size: 13px;
      color: var(--texto-secundario);
    }

    .tabla-resumen-practica {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      background-color: #ffffff;
    }

    .tabla-resumen-practica thead th {
      background-color: #f9fafb;
      color: var(--texto-secundario);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--gris-borde);
    }

    .tabla-resumen-practica tbody tr {
      border-bottom: 1px solid var(--gris-borde);
      transition: background-color 0.12s ease;
    }

    .tabla-resumen-practica tbody tr:hover {
      background-color: #f3f4f6;
    }

    .tabla-resumen-practica .col-checkbox {
      width: 40px;
      text-align: center;
    }

    .tabla-resumen-practica .col-nombre {
      padding-left: 4px;
      font-size: 13px;
      color: var(--texto-principal);
    }

    .tabla-resumen-practica input[type="checkbox"] {
      accent-color: var(--verde-sena);
    }






    /* Contenedor externo del Gantt (título + tabla) */
    #contenedorGanttCompetencias {
      margin-top: 8px;
      /* separación respecto a la tarjeta de la gráfica */
    }

    /* ================= CONTENEDORES PARA GRÁFICAS ================= */

    /* Tarjeta genérica de la gráfica (CanvasJS) SOLO en reporte 2 */
    #reporte2 .chart-container {
      width: 100%;
      max-width: 100%;
      margin: 24px 0 80px 0;
      /* 80px de espacio debajo de la gráfica */
      padding: 20px 20px 30px;
      border-radius: 16px;
      border: 1px solid var(--gris-borde);
      background-color: #ffffff;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
      box-sizing: border-box;
    }

    /* Contenedor que agrupa el título y la tabla del Gantt */
    #contenedorGanttCompetencias {
      margin-top: 0;
      clear: both;
    }

    /* ================= NUEVO GANTT STYLE ================= */
    .detalle-gantt-card {
      margin-top: 18px;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid var(--gris-borde);
      background: #ffffff;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.05);
    }

    .detalle-gantt-container {
      width: 100%;
      overflow-x: auto;
      margin-top: 16px;
    }

    .detalle-gantt-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .detalle-gantt-search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f3f4f6;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
    }

    .detalle-gantt-search .icono-buscar {
      font-size: 14px;
      color: #6b7280;
    }

    .detalle-gantt-search input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 14px;
      color: #374151;
      width: 220px;
    }

    .detalle-gantt-filtros {
      display: flex;
      gap: 8px;
    }

    .gantt-filter-button {
      padding: 6px 14px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gantt-filter-button:hover {
      background: #f9fafb;
    }

    .gantt-filter-button.active {
      background: var(--verde-sena);
      color: #ffffff;
      border-color: var(--verde-sena-oscuro);
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.25);
    }

    .tabla-gantt-detalle {
      width: 100%;
      border-collapse: collapse;
      min-width: 0;
      table-layout: auto;
    }

    .tabla-gantt-detalle th {
      background: #f9fafb;
      padding: 10px;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      text-align: center;
      border-bottom: 2px solid #e5e7eb;
    }

    .tabla-gantt-detalle td {
      padding: 8px 10px;
      font-size: 13px;
      color: #4b5563;
      border-bottom: 1px solid #f3f4f6;
      word-break: break-word;
    }

    .gantt-month-cell {
      background-color: #fdfdfd;
      color: transparent;
    }

    .gantt-month-bar {
      background-color: #28a745;
      border-radius: 4px;
      color: transparent;
    }

      /* Tarjeta del Gantt (tabla) */
      #ganttContainer,
      #ganttContainerPendientes {
        border-radius: 16px;
        border: 1px solid var(--gris-borde);
      background-color: #ffffff;
      padding: 16px 18px;
      margin: 16px 0 24px 0;
      /* espacio arriba y abajo del Gantt */
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
      display: block;

      /* Que ocupe todo el ancho del contenedor padre (contenedorGanttCompetencias) */
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;

      /* Mantener el scroll horizontal si la tabla interna es más ancha */
        overflow-x: auto;
        overflow-y: hidden;

        float: none;
        clear: both;
      }

      #reporte4 #ganttContainerPendientes {
        border: none;
        border-radius: 0;
        background: none;
        padding: 0;
        box-shadow: none;
        margin: 0;
      }

    /* Contenedor específico del gráfico de competencias */
    #chartCompetenciasHorasContainer {
      width: 100%;
      height: auto;
      /* Permite que crezca según el contenido */
      min-height: 300px;
      /* Altura mínima de seguridad */
      display: block;
      /* Asegura comportamiento de bloque */
    }




    /* Gráfico de instructores (otra pestaña) */
    #chartInstructoresHorasContainer {
      width: 90% !important;
      height: 400px;
    }


    /* Contenedor específico del gráfico de competencias */
    #chartCompetenciasHorasContainer {
      width: 100%;
      height: 100%;
      /* la altura la controla JS */
    }

    #chartInstructoresHorasContainer {
      width: 90% !important;
      height: 400px;
    }


    /* Márgenes de títulos dentro del reporte 2 */
    #reporte2 h3 {
      margin-top: 16px;
      margin-bottom: 10px;
    }


    /* ================= RESPONSIVE ================= */

    @media (max-width: 900px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 16px 20px;
      }

      .header-center {
        margin-left: 0;
        text-align: left;
      }

      #sectionFile1,
      #sectionFile2,
      #sectionFile3 {
        flex-direction: column;
        align-items: stretch;
      }

      #btnProcesar1,
      #btnProcesar2,
      #btnCargarDiseno {
        width: 100%;
        justify-content: center;
      }

      .tabs li {
        flex: 1 1 100%;
      }
    }

    /* =========================
   Filtros Reporte 1 (Instructores y Competencias)
   ========================= */

    .filtros-reporte1 {
      margin: 14px 0 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Buscador tipo pastilla */
    .filtro-busqueda-reporte1 {
      position: relative;
      max-width: 420px;
    }

    .filtro-busqueda-reporte1 input {
      width: 100%;
      padding: 9px 12px 9px 36px;
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      background-color: #f9fafb;
      font-size: 13px;
      outline: none;
      color: var(--texto-principal);
      /*transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;*/
    }

    .filtro-busqueda-reporte1 input::placeholder {
      color: var(--texto-secundario);
    }

    .filtro-busqueda-reporte1 input:focus {
      border-color: var(--verde-sena);
      background-color: #ffffff;
      box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.18);
    }

    .filtro-busqueda-icono {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--texto-secundario);
    }

    /* Chips de categorías */
    .filtros-categorias-reporte1 {
      display: flex;
      flex-wrap: wrap;
      gap: 100px;
      align-items: center;
      justify-content: flex-start;
    }

    .chip-reporte1 {
      position: relative;
      display: inline-flex;
      flex: 0 0 auto;
      width: auto;
    }

    /* ocultamos el checkbox nativo, el label actúa como botón */
    .chip-reporte1 input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .chip-reporte1-inner {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 8px 26px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--chip-success), var(--chip-success-dark));
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      min-width: 150px;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.25);
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .chip-reporte1-inner:hover {
      border-color: var(--chip-success-dark);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
    }

    .chip-reporte1.chip-amarillo .chip-reporte1-inner {
      background: var(--chip-warning);
      color: #1f2937;
      box-shadow: 0 10px 22px rgba(249, 190, 0, 0.4);
    }

    .chip-reporte1.chip-naranja .chip-reporte1-inner {
      background: var(--chip-warning-dark);
      color: #1f1f1f;
      box-shadow: 0 10px 22px rgba(217, 119, 6, 0.35);
    }

    /* Icono de check dentro del chip */
    .chip-check {
      font-size: 12px;
      opacity: 0;
    }

    /* Estado ACTIVO (checkbox marcado) */
    .chip-reporte1 input:checked+.chip-reporte1-inner {
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
      transform: translateY(-1px);
      background: linear-gradient(135deg, var(--chip-success-dark), #0f3d2f);
    }

    .chip-reporte1 input:checked+.chip-reporte1-inner .chip-check {
      opacity: 1;
    }

    /* Responsive: en pantallas pequeñas, que se acomoden uno bajo otro si hace falta */
    @media (max-width: 768px) {
      .filtros-reporte1 {
        align-items: stretch;
      }

      .filtros-categorias-reporte1 {
        justify-content: flex-start;
      }
    }

    /* ================================
   Encabezado / Información de la Ficha
   ================================ */

    #headerInfo {
      max-width: 1300px;
      margin: 24px auto;
      padding: 22px 28px;
      /* sin padding, lo controlamos dentro */
      border-radius: 16px;
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      overflow: hidden;
    }

    /* Barra superior con título e icono "i" */
    #headerInfo>h2 {
      margin: 0;
      padding: 10px 18px;
      background-color: #eef4ff;
      border-bottom: 1px solid #d0e2ff;
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #headerInfo>h2::before {
      content: "i";
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background-color: #ffffff;
      border: 1px solid #d0e2ff;
      color: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
    }


    /* ============================
   Estilo Específico de Tarjeta Info (Nuevo Diseño)
   ============================ */

    /* Estilo general de la tarjeta de información */
    /* ============================
   Estilo Específico de Tarjeta Info (Nuevo Diseño)
   ============================ */

    /* Estilo general de la tarjeta de información */
    .card-info {
      background-color: white;
      border: 1px solid var(--gris-borde);
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      margin: 15px 18px 25px 18px;
    }

    /* Encabezado de la tarjeta de información */
    .card-info .card-header {
      background-color: var(--verde-sena-claro);
      border-bottom: 1px solid var(--gris-borde);
      padding: 15px 20px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }

    .card-info .card-header h3 {
      margin-top: 0;
      margin-bottom: 5px;
      color: var(--verde-sena-oscuro);
      font-size: 1.25em;
      font-weight: 700;
    }

    .card-info .card-header p#nombrePrograma {
      margin: 0;
      font-size: 1.1em;
      font-weight: 500;
      color: var(--texto-principal);
    }

    /* CUERPO: Define dos columnas */
    .card-info .card-body {
      padding: 15px 20px;
      display: grid;
      /* Divide el cuerpo en dos columnas con un tamaño mínimo de 300px */
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px 30px;
    }

    /* Estilo para cada grupo de información (como Código Programa) */
    .card-info .info-group p {
      margin-top: 0;
      margin-bottom: 10px;
      /* Separación entre el grupo de info y el siguiente */
      color: var(--texto-principal);
      font-size: 0.95em;
    }

    .card-info .info-group strong {
      color: var(--texto-secundario);
      font-weight: 500;
    }

    .card-info .info-group span {
      font-weight: 700;
    }

    /* GRUPO DE FECHAS: Agrupamos las 4 fechas en el segundo bloque */
    .card-info .fechas-group {
      display: flex;
      /* Usamos flexbox para alinear las fechas internamente */
      flex-direction: column;
      /* Las fechas una debajo de la otra */
      gap: 5px;
      /* Pequeña separación vertical entre cada fecha */
    }

    .card-info .fechas-group p {
      margin: 0;
      color: var(--texto-principal);
      font-size: 0.95em;
    }

    .card-info .fechas-group strong {
      color: var(--texto-secundario);
      font-weight: 500;
      min-width: 150px;
      /* Asegura que la etiqueta tenga un ancho mínimo para alinearse */
      display: inline-block;
    }

    .card-info .fechas-group span {
      font-weight: 700;
    }

    /* ====== Estado de Aprendices + Gráfico lado a lado ====== */

    /* Contenedor general de la parte inferior (tabla + gráfico) usando floats */


    /* === Destacar Nombre del Programa y Código de Ficha === */

    #headerInfo>table:first-of-type td {
      font-size: 13px;
      /* un poco más pequeño en general */
    }

    /* Nombre del programa destacado */
    #nombrePrograma {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      
      /* verde muy claro */
      color: #ffffff;
      /* verde oscuro */
      font-size: 25px;
      /* ligeramente mayor que el resto */
      font-weight: 700;
    }

    /* Código de ficha destacado */
    #codigoFicha {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      
      /* azul claro */
      color: #ffffff;
      /* azul más intenso */
      font-weight: 700;
    }

    /* Primera columna (Estado) en negrita */
    #tablaEstado tbody td:first-child {
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
    }

    /* Colores para filas especiales en reporte 6 */
    .fila-instructor-diferente {
      background-color: #fff7b0 !important;
      /* amarillo suave */
    }

    .fila-rap-no-programado {
      background-color: #ffedd5 !important;
      /* naranja suave */
    }

    /* Chip para Raps no programados (color naranja) */
    .chip-raps-no-programado .chip-reporte1-inner {
      border-color: #fb923c;
      background-color: #fff7ed;
      color: #7c2d12;
    }

    .chip-raps-no-programado input:checked+.chip-reporte1-inner {
      border-color: #f97316;
      background-color: #ffe8d0;
      color: #7c2d12;
    }



    /* Cabecera de la tabla de estado */
    #tablaEstado thead th {
      background-color: #f9fafb;
      color: #6b7280;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    /* Gantt Detallado Estilos */
    .gantt-month-bar {
      display: inline-block;
      width: 80%;
      height: 8px;
      border-radius: 9999px;
      vertical-align: middle;
    }

    .gantt-month-cell {
      text-align: center;
      vertical-align: middle;
    }

    #tablaEstado tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    #tablaEstado tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }


    /* ============= SECCIÓN DE EXPORTACIÓN (CENTRO DE REPORTES) ============= */

    .export-section {
      margin-top: 24px;
    }

    .export-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    .export-header-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background-color: #e0edff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .export-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .export-header p {
      margin: 2px 0 0 0;
      font-size: 13px;
      color: var(--texto-secundario);
    }

    .export-body {
      display: flex;
      gap: 24px;
    }

    .export-left {
      flex: 1 1 65%;
      min-width: 0;
    }

    .export-right {
      flex: 0 0 320px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Cabecera izquierda (título + buscador) */

    .export-left-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .export-left-header h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
    }

    .export-left-header p {
      margin: 0;
      font-size: 13px;
      color: var(--texto-secundario);
    }

    /* Buscador */

    .export-search {
      position: relative;
      width: 260px;
      max-width: 100%;
    }

    .export-search input {
      width: 100%;
      padding: 8px 10px 8px 28px;
      border-radius: 999px;
      border: 1px solid var(--gris-borde);
      font-size: 13px;
      outline: none;
      background-color: #f9fafb;
    }

    .export-search-icon {
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--texto-secundario);
    }

    /* Barra de selección y contador */

    .export-left-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .select-all {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #contadorSeleccionados {
      color: #2563eb;
      font-weight: 500;
    }

    /* Lista de reportes */

    .lista-reportes {
      border-radius: 12px;
      border: 1px solid var(--gris-borde);
      background-color: #f9fafb;
      padding: 12px 14px;
      max-height: 260px;
      overflow-y: auto;
    }

    .lista-reportes label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 6px 4px;
      border-radius: 8px;
      cursor: pointer;
    }

    .lista-reportes label:hover {
      background-color: #e5f3ff;
    }

    .lista-reportes input[type="checkbox"] {
      accent-color: var(--verde-sena);
    }

    /* Tarjetas de exportación (derecha) */

    .export-right h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
    }

    .export-card {
      width: 100%;
      justify-content: flex-start;
      padding: 12px 14px;
      border-radius: 12px;
      background-color: #f9fafb;
      color: var(--texto-principal);
      box-shadow: none;
      border: 1px solid transparent;
      transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .export-card:hover {
      transform: translateY(-2px);
    }

    .btnExportarPDF {
      background-color: #ffe9e7;
      border-color: #f8c2c1;
    }

    .btnExportarExcel {
      background-color: #e6f8e6;
      border-color: #c8eac6;
    }

    .btnActaComite {
      background-color: #f3f3ff;
      border-color: #d9d9f5;
    }

    .export-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 10px;
    }

    .export-card-icon.pdf {
      background-color: #fdcdd5;
      color: #a5071e;
    }

    .export-card-icon.excel {
      background-color: #cceaeb;
      color: #0b6a3a;
    }

    .export-card-icon.word {
      background-color: #cde2ff;
      color: #0c4aac;
    }

    .export-card-icon.acta {
      background-color: #e0e2ff;
      color: #2d2ac1;
    }

    .export-card-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
    }

    .export-card-text strong {
      font-size: 14px;
    }

    .export-card-text span {
      color: var(--texto-secundario);
    }

    .export-card-arrow {
      margin-left: auto;
      font-size: 18px;
      color: #9ca3af;
    }

    .reportes-main {
      background-color: #ffffff;
      border-radius: 28px;
      border: 1px solid #e6ebf1;
      padding: 26px;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .reportes-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .reportes-header p {
      margin: 6px 0 0;
      color: var(--texto-secundario);
      font-size: 14px;
    }

    .reportes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .report-card {
      border-radius: 18px;
      padding: 16px;
      background-color: #f5f6fb;
      border: 1px solid transparent;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    .report-card header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      justify-content: space-between;
    }

    .report-card-icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f5ff;
      font-size: 20px;
    }

    .report-card h3 {
      margin: 0;
      font-size: 16px;
    }

    .report-card-todos {
      display: inline-block;
      margin-top: 4px;
      font-size: 12px;
      font-weight: 600;
      color: #0e4bf1;
      letter-spacing: 0.6px;
    }

    .report-card-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .report-card-list label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      cursor: pointer;
    }

    .report-card-list label {
      justify-content: flex-start;
    }

    .report-card-list input[type="checkbox"] {
      accent-color: #2563eb;
    }

    .report-card-todos {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #0e4bf1;
    }

    .report-card-todos input {
      width: 16px;
      height: 16px;
    }

    .report-card.card-aprendices .report-card-icon {
      background-color: #dcedf7;
    }

    .report-card.card-instructores .report-card-icon {
      background-color: #dde9ff;
    }

    .report-card.card-competencias .report-card-icon {
      background-color: #f4e5ff;
    }

    .reportes-actions {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .reportes-actions-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .reportes-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    /* Responsive */

    @media (max-width: 900px) {
      .export-body {
        flex-direction: column;
      }

      .export-right {
        flex: 1 1 auto;
      }
    }

    /* ================= FOOTER DISEÑO Y DESARROLLO ================= */

    .footer-disenador {
      max-width: 1200px;
      margin: 16px auto 32px;
      text-align: center;
    }

    .footer-disenador-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .footer-disenador-card {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      background-color: #ffffff;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }

    .footer-disenador-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background-color: #fb923c;
      /* naranja */
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 18px;
    }

    .footer-disenador-info {
      text-align: left;
    }

    .footer-disenador-label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .footer-disenador-name {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    .footer-disenador-settings {
      margin-left: 8px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background-color: #e0f2fe;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2563eb;
      font-size: 14px;
    }

    /* ============================
   Layout tipo tarjetas ficha
   ============================ */

    .ficha-layout {
      padding: 16px 18px 20px;
    }

    /* Fila superior: 4 tarjetas */
    .ficha-grid-top {
      display: grid;
      grid-template-columns: minmax(140px, 180px) minmax(260px, 1.3fr) repeat(2, minmax(140px, 180px));
      gap: 12px;
      margin-bottom: 14px;
    }

    /* Fila inferior: 2 tarjetas */
    .ficha-grid-bottom {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Tarjeta base */
    .ficha-card {
      background-color: #ffffff;
      border-radius: 14px;
      border: 1px solid #e4e9f2;
      padding: 14px 18px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
    }

    /* Etiqueta pequeña arriba de cada tarjeta */
    .ficha-card-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--texto-secundario);
      margin-bottom: 6px;
    }

    /* Tarjetas pequeñas izquierda / derecha */
    .ficha-card-small .ficha-card-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    /* Tarjeta central del programa */
    .ficha-card-programa {
      background-color: var(--verde-sena-claro);
      border-color: #bbf7d0;
    }

    .ficha-card-programa .ficha-card-label {
      color: var(--verde-sena-oscuro);
    }

    .ficha-card-programa-value {
      display: block;
      margin-top: 2px;
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--texto-principal);
    }

    /* Tarjetas de fechas (etapas) */
    .ficha-card-fechas {
      position: relative;
      padding-top: 24px;
      /* espacio para el badge */
    }

    /* Badge de etapa lectiva / productiva */
    .ficha-badge {
      position: absolute;
      top: -10px;
      left: 18px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .ficha-badge-lectiva {
      background-color: #ecfdf3;
      border-color: #22c55e;
      color: #15803d;
    }

    .ficha-badge-productiva {
      background-color: #fffbeb;
      border-color: #f97316;
      color: #c2410c;
    }

    /* Contenedor interno de las dos fechas */
    .ficha-fechas-row {
      display: flex;
      gap: 18px;
      align-items: flex-start;
    }

    .ficha-fecha {
      flex: 1;
    }

    /* Línea vertical separadora */
    .ficha-fecha-divider {
      width: 1px;
      background-color: #e5e7eb;
    }

    /* Etiqueta de la fecha */
    .ficha-fecha-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--texto-secundario);
      margin-bottom: 4px;
    }

    /* Valor de la fecha con icono */
    .ficha-fecha-value {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--texto-principal);
    }

    .ficha-fecha-icon {
      font-size: 15px;
    }

    .ficha-tiempo-restante {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--texto-secundario);
    }

    .ficha-tiempo-label {
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .ficha-tiempo-value {
      font-weight: 700;
      color: var(--texto-principal);
      font-size: 13px;
    }

    /* ========= Overrides para #nombrePrograma y #codigoFicha
   (evitar el estilo de "pastilla" anterior) ========= */

    #headerInfo .ficha-card-programa #nombrePrograma {
      display: block;
      margin: 2px 0 0 0;
      padding: 0;
      border-radius: 0;
      background: transparent;
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--texto-principal);
    }

    #headerInfo .ficha-card-small #codigoFicha,
    #headerInfo .ficha-card-small #codigoPrograma {
      display: block;
      margin-top: 4px;
      padding: 0;
      border-radius: 0;
      background: transparent;
      color: var(--texto-principal);
      font-size: 22px;
      font-weight: 700;
    }


    /* ============================
   Resumen numérico de la ficha
   (tarjetas KPI + análisis de rendimiento)
   ============================ */

    .ficha-summary-row {
      width: calc(100% - 36px);
      margin: 16px 18px 10px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* -------- Fila superior: tarjetas KPI -------- */

    .ficha-summary-top {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
    }

    .ficha-kpi-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid var(--gris-borde);
      background-color: #ffffff;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
      transition: background-color 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease, transform 0.12s ease;
    }

    .ficha-kpi-card:hover {
      border-color: var(--verde-sena);
      background-color: #f9fafb;
      box-shadow: 0 10px 22px rgba(40, 167, 69, 0.25);
      transform: translateY(-1px);
    }

    .ficha-kpi-competencias {
      background: #ffffff;
    }

    .ficha-kpi-resultados {
      background: #ffffff;
    }


    .ficha-kpi-icon {
      flex: 0 0 42px;
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background-color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .ficha-kpi-info {
      display: flex;
      flex-direction: column;
    }

    .ficha-kpi-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--texto-secundario);
    }

    .ficha-kpi-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    /* -------- Fila media: Instructor y Coordinador -------- */

    .ficha-summary-middle {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      /* <- AQUÍ EL CAMBIO */
      gap: 12px;
    }

    .ficha-secondary-card {
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid var(--gris-borde);
      background-color: #ffffff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
    }

    .ficha-secondary-instructor {
      background-color: #fefce8;
      border-color: #fde68a;
    }

    .ficha-secondary-coordinador {
      background-color: #ecfdf5;
      border-color: #6ee7b7;
    }

    .ficha-secondary-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--texto-secundario);
      margin-bottom: 6px;
    }

    .ficha-secondary-icon {
      font-size: 16px;
    }

    .ficha-secondary-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--texto-principal);
    }

    /* -------- Bloque inferior: Análisis de rendimiento -------- */

    .ficha-analisis-card {
      margin-top: 2px;
      padding: 16px 18px 14px;
      border-radius: 16px;
      border: 1px solid var(--gris-borde);
      background-color: #ffffff;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
    }

    .ficha-analisis-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--texto-secundario);
      margin-bottom: 10px;
    }

    .ficha-analisis-icon {
      font-size: 16px;
    }

    .ficha-analisis-main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.9fr);
      gap: 16px;
      align-items: center;
    }

    /* Avance promedio + barra verde */

    .ficha-analisis-avance-label {
      font-size: 13px;
      color: var(--texto-secundario);
      margin-bottom: 4px;
    }

    .ficha-analisis-avance-valor {
      font-size: 28px;
      font-weight: 700;
      color: var(--verde-sena-oscuro);
    }

    .ficha-analisis-barra {
      margin-top: 6px;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background-color: #e5e7eb;
      overflow: hidden;
    }

    .ficha-analisis-barra-fill {
      width: 0;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--verde-sena), #22c55e);
      transition: width 0.4s ease-out;
    }

    .ficha-analisis-avance-nota {
      margin-top: 6px;
      font-size: 11px;
      color: var(--texto-secundario);
    }

    .ficha-analisis-main {
      display: flex;
      gap: 16px;
      align-items: stretch;
    }

    .ficha-analisis-circular-wrap {
      flex: 0 0 240px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ficha-analisis-circular {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: conic-gradient(var(--verde-sena) calc(var(--avance, 0) * 1%), #e5e7eb 0);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      color: var(--texto-principal);
    }

    .ficha-analisis-circular::after {
      content: "";
      position: absolute;
      width: 170px;
      height: 170px;
      border-radius: 50%;
      background-color: #ffffff;
    }

    .ficha-analisis-circular-inner {
      position: relative;
      text-align: center;
      z-index: 1;
    }

    .ficha-analisis-circular-title {
      font-size: 14px;
      color: var(--texto-secundario);
      display: block;
      margin-bottom: 6px;
    }

    .ficha-analisis-circular-value {
      font-size: 32px;
      font-weight: 700;
    }

    .ficha-analisis-circular-sub {
      font-size: 12px;
      color: var(--texto-secundario);
      display: block;
      margin-top: 4px;
    }

    .ficha-analisis-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .ficha-analisis-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .ficha-analisis-summary-card {
      border-radius: 16px;
      padding: 16px;
      background: #ffffff;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
    }

    .ficha-analisis-summary-card strong,
    .ficha-analisis-summary-card .summary-value {
      font-size: 32px;
      font-weight: 700;
      display: block;
      margin-top: 4px;
    }

    .ficha-analisis-summary-card .summary-note {
      font-size: 12px;
      color: var(--texto-secundario);
      margin-top: 6px;
    }

    .ficha-analisis-summary-card.card-verde {
      border: 1px solid #22c55e;
    }

    .ficha-analisis-summary-card.card-rojo {
      border: 1px solid #dc2626;
    }

    .ficha-analisis-metricas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      justify-items: center;
      align-items: center;
      text-align: center;
    }

    .ficha-analisis-metricas-grid .ficha-analisis-metrica,
    .ficha-analisis-metrica {
      padding: 12px 14px;
      border-radius: 12px;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.05);
      border: 1px solid #dc2626;
      min-height: 120px;
      min-width: 70px;
      justify-content: center;
      align-items: center;
    }

    .ficha-analisis-metrica-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--texto-secundario);
    }

    .ficha-analisis-metrica-valor {
      font-size: 28px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    .ficha-analisis-metrica-note {
      font-size: 11px;
      color: var(--texto-secundario);
    }


    .ficha-analisis-metrica-ok {
      background-color: #ecfdf3;
      border: 1px solid #bbf7d0;
    }

    .ficha-analisis-metrica-alerta {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
    }

    .ficha-analisis-metrica-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--texto-secundario);
    }

    .ficha-analisis-metrica-badge {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .ficha-analisis-metrica-ok .ficha-analisis-metrica-badge {
      background-color: #22c55e;
      color: #ffffff;
    }

    .ficha-analisis-metrica-alerta .ficha-analisis-metrica-badge {
      background-color: #f97316;
      color: #ffffff;
    }

    .ficha-analisis-metrica-valor {
      font-size: 22px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    /* Responsive */

    @media (max-width: 900px) {
      .ficha-summary-top {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      .ficha-summary-middle {
        grid-template-columns: 1fr;
      }

      .ficha-analisis-main {
        grid-template-columns: 1fr;
      }
    }

    /* ====== Estado de Aprendices + Gráfico lado a lado ====== */

    /* Tarjeta contenedora de la tabla */
    .detalle-aprendices-card {
      width: calc(100% - 36px);
      /* 100% dentro de #headerInfo, respetando márgenes laterales */
      margin: 16px 18px 12px;
      /* margen arriba/abajo y laterales */
      float: none;
      /* sin floats, va arriba de la gráfica */
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background-color: #ffffff;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      overflow: hidden;
    }


    /* Encabezado de la tarjeta: icono + título + total */
    .detalle-aprendices-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f9fafb;
    }

    .detalle-aprendices-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .detalle-aprendices-icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background-color: #ecfdf3;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #16a34a;
    }

    .detalle-aprendices-total {
      padding: 4px 10px;
      border-radius: 999px;
      background-color: #dcfce7;
      color: #166534;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Estilos para Chips de Reporte 2 (Verde) */
    .chip-reporte2.chip-tipo {
      border-radius: 999px;
      padding: 9px 12px 9px 36px;
      border: 1px solid #16a34a;
      background-color: var(--verde-sena-oscuro);
      color: #ffffff;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .chip-reporte2.chip-tipo .chip-check {
      font-weight: 700;
    }

    /* Estado inactivo para Reporte 2 */
    .chip-reporte2.chip-tipo.chip-inactivo {
      border-color: #9ca3af;
      background-color: #f3f4f6;
      color: #6b7280;
      opacity: 0.8;
    }

    /* === FIX: REPORTE 2 — igualar estilo de chips a Reporte 1 (color + tipografía + tamaño) === */
    .filtros-reporte2 .chip-reporte2.chip-tipo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 8px 26px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #10b981, #059669);
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      min-width: 150px;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, opacity 0.15s ease;
    }

    .filtros-reporte2 .chip-reporte2.chip-tipo:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
    }

    /* Check visible cuando está activo (sin .chip-inactivo) */
    .filtros-reporte2 .chip-reporte2.chip-tipo .chip-check {
      font-size: 12px;
      font-weight: 700;
      opacity: 1;
    }

    /* Inactivo: se mantiene el color base, pero atenuado (similar a reporte 1 cuando no está seleccionado) */
    .filtros-reporte2 .chip-reporte2.chip-tipo.chip-inactivo {
      opacity: 0.55;
      transform: none;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
    }

    .filtros-reporte2 .chip-reporte2.chip-tipo.chip-inactivo .chip-check {
      opacity: 0;
    }

    /* Estilos para Chips de Reporte 6 (Compatibilidad misma apariencia que Rep 2 si tienen clase chip-tipo) */
    .chip-reporte6.chip-tipo {
      border-radius: 9999px;
      padding: 4px 10px;
      border: 1px solid #16a34a;
      background-color: #dcfce7;
      color: #14532d;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .chip-reporte6.chip-tipo.chip-inactivo {
      border-color: #9ca3af;
      background-color: #f3f4f6;
      color: #6b7280;
      opacity: 0.8;
    }

    /* Ajuste para Chips de RAPs en Reporte 6 (ancho reducido) */
    #chkSoloRapsOtro+.chip-reporte1-inner,
    #chkSoloRapsNoProgramados+.chip-reporte1-inner {
      padding: 2px 6px;
      font-size: 14px;
      max-width: 180px;
      white-space: normal;
    }

    /* Tabla interna */
    #tablaEstado {
      width: 100%;
      margin: 0;
      border-collapse: collapse;
      background-color: #ffffff;
    }

    /* Cabecera de la tabla */
    #tablaEstado thead th {
      background-color: #f9fafb;
      color: #6b7280;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Celdas cuerpo */
    #tablaEstado tbody td {
      font-size: 13px;
      padding: 10px 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Primera columna: contenedor de la pastilla */
    #tablaEstado tbody td:first-child {
      width: 140px;
    }

    /* Pastilla de estado */
    #tablaEstado .badge-estado {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid transparent;
    }

    /* Columnas numéricas */
    #tablaEstado td.col-cantidad,
    #tablaEstado td.col-porcentaje {
      text-align: center;
      font-weight: 700;
    }

    /* Fila por defecto */
    #tablaEstado tbody tr {
      background-color: #ffffff;
    }

    /* Tarjeta para la gráfica de estados de aprendices */
    .estado-chart-card {
      width: calc(100% - 36px);
      margin: 0 18px 18px;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      background-color: #ffffff;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      padding: 16px 24px 20px;
    }

    /* Título de la tarjeta de la gráfica */
    .estado-chart-title {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 700;
      color: #111827;
      text-align: left;
    }

    /* Contenedor del canvas de la gráfica */
    .estado-chart-wrapper {
      position: relative;
      width: 100%;
      min-height: 260px;
      display: flex;
      /* nuevo */
      justify-content: center;
      /* nuevo: centra horizontalmente el contenido */
    }

    /* El área real de la gráfica (CanvasJS) */
    #estadoChartContainer {
      width: 100%;
      max-width: 900px;
      /* ajusta este valor si quieres la gráfica más grande o más pequeña */
      margin: 0 auto;
    }



    /* Responsive: tabla y gráfica ocupando 100% en móviles */
    @media (max-width: 900px) {

      .detalle-aprendices-card,
      .estado-chart-card {
        width: calc(100% - 36px);
        margin: 8px 18px;
      }
    }


    /* Colores de la pastilla según estado */
    #tablaEstado tbody tr.estado-en-formacion .badge-estado {
      background-color: #16a34a;
      border-color: #15803d;
      color: #ffffff;
    }

    #tablaEstado tbody tr.estado-condicionado .badge-estado {
      background-color: #facc15;
      border-color: #eab308;
      color: #92400e;
    }

    #tablaEstado tbody tr.estado-cancelado .badge-estado {
      background-color: #e5e7eb;
      border-color: #9ca3af;
      color: #374151;
    }

    #tablaEstado tbody tr.estado-retiro .badge-estado {
      background-color: #f97373;
      border-color: #b91c1c;
      color: #ffffff;
    }

    #tablaEstado tbody tr.estado-otro .badge-estado {
      background-color: #eff6ff;
      border-color: #3b82f6;
      color: #1d4ed8;
    }



    /* ========= Responsive ========= */
    @media (max-width: 900px) {
      .ficha-grid-top {
        grid-template-columns: 1fr;
      }

      .ficha-grid-bottom {
        grid-template-columns: 1fr;
      }

      #tablaEstado,
      #headerInfo>div:last-of-type {
        float: none;
        width: calc(100% - 36px);
        margin: 8px 18px;
      }
    }

    .fila-instructor-diferente {
      background-color: #fff7b0 !important;
      /* amarillo suave */
    }

    .textoRojo {
      background-color: #fee2e2 !important;
      /* rojo claro para avance < 75% */
    }

    /* Competencias no programadas o programadas a 1/2 en el Reporte 4 */
    tr.no-programada td {
      background-color: #fee2e2 !important;
      /* rojo claro */
    }

    /* Linea de tiempo para fechas de la ficha */
    .timeline-card {
      margin: 14px auto 18px;
      padding: 12px 16px;
      background: #ffffff;
      border: 1px solid var(--gris-borde);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    .timeline-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .timeline-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 700;
      color: var(--texto-principal);
    }

    .timeline-title .icon {
      font-size: 15px;
    }

    .timeline-status {
      padding: 4px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #15803d;
      border: 1px solid #86efac;
      font-size: 12px;
      font-weight: 600;
    }

    .timeline-track {
      position: relative;
      height: 90px;
      margin-top: 8px;
    }

    .timeline-track::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 6px;
      transform: translateY(-50%);
      background: #e5e7eb;
      border-radius: 999px;
    }

    .timeline-fill {
      position: absolute;
      left: 0;
      top: 50%;
      height: 6px;
      transform: translateY(-50%);
      background: linear-gradient(90deg, var(--verde-sena), #22c55e);
      border-radius: 999px;
      width: 0%;
    }

    .timeline-point {
      position: absolute;
      top: 50%;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid #ffffff;
      background: #d1d5db;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.15);
    }

    .timeline-point.past {
      background: #22c55e;
    }

    .timeline-point.future {
      background: #d1d5db;
    }

    .timeline-point.today {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
    }

    .timeline-point-label {
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translate(-50%, 0);
      text-align: center;
      font-size: 11px;
      line-height: 1.3;
      color: var(--texto-principal);
      white-space: nowrap;
    }

    .timeline-point.alt .timeline-point-label {
      top: auto;
      bottom: 26px;
    }

    .timeline-track.compact {
      height: 72px;
    }

    .timeline-compact .timeline-header {
      margin-bottom: 6px;
    }

    .timeline-compact .timeline-point {
      width: 14px;
      height: 14px;
    }

    .timeline-compact .timeline-point-label {
      font-size: 10px;
    }

    /* === FIX: mantener colores y check en filtros REPORTE 2 === */
.filtros-reporte2 .chip-reporte2.chip-tipo{
  background-color: var(--verde-sena-oscuro);
  color: #ffffff;
  border: 1px solid #16a34a;
}

/* El check en reporte2 NO depende de checkbox, debe verse */
.filtros-reporte2 .chip-reporte2.chip-tipo .chip-check{
  opacity: 1;
}

/* Inactivo (cuando JS agrega .chip-inactivo) */
.filtros-reporte2 .chip-reporte2.chip-tipo.chip-inactivo{
  background-color: #f3f4f6;
  color: #6b7280;
  border-color: #9ca3af;
}

/* Check oculto en inactivo */
.filtros-reporte2 .chip-reporte2.chip-tipo.chip-inactivo .chip-check{
  opacity: 0;
}

    #tablaReporte1 {
      border-collapse: collapse;
      border: 1px solid #d1d5db;
    }

    #tablaReporte1 th,
    #tablaReporte1 td {
      border: 1px solid #e5e7eb;
    }

    .tabla-total {
      display: flex;
      flex-wrap: wrap;
      gap: 0.85rem;
      margin: 1rem 0;
      justify-content: flex-start;
    }

    .tabla-total-card {
      flex: 1 1 160px;
      min-width: 150px;
      border-radius: 14px;
      padding: 0.9rem 1.1rem;
      background: #ffffff;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border-left: 4px solid var(--tabla-total-accent, #16a34a);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tabla-total-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.18);
    }

    .tabla-total-card::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      opacity: 0.4;
    }

    .tabla-total-label {
      font-size: 0.85rem;
      color: #6b7280;
      text-transform: capitalize;
    }

    .tabla-total-value {
      font-size: 1.85rem;
      font-weight: 700;
      color: #0f172a;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .tabla-total-value.valor-animado {
      animation: pulseTotal 0.35s ease;
    }

    @keyframes pulseTotal {
      0% {
        transform: translateY(6px);
        opacity: 0.4;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @media (max-width: 720px) {
      .tabla-total {
        flex-direction: column;
      }
      .tabla-total-card {
        width: 100%;
      }
    }

  

/* ====== FICHA LAYOUT (UI tipo referencia) ====== */
.ficha-layout-sena{
  --green:#16a34a;
  --green-2:#10b981;
  --green-dark:#065f46;
  --orange:#f97316;
  --orange-dark:#c2410c;
  --ink:#000000;
  --ink-2:#0c3d1e;
  --muted:#6b7280;
  --line:#e5e7eb;
  --card:#ffffff;
  --bg-soft:#f5f7fb;
  margin: 14px 0 18px;
}

.ficha-layout-sena .ficha-panel{
  border-radius: 22px;
  overflow: hidden;
  background: var(--card);
  border: 1px solid rgba(229,231,235,.95);
  box-shadow: 0 18px 40px rgba(15,23,42,.10);
}

.ficha-layout-sena .ficha-hero{
  padding: 26px 28px 22px;
  color: #fff;
  background:
    radial-gradient(circle at 18% 10%, rgba(34,197,94,.22), transparent 55%),
    radial-gradient(circle at 85% 22%, rgba(16,185,129,.16), transparent 60%),
    linear-gradient(135deg, var(--ink-2), var(--ink));
}

.ficha-layout-sena .ficha-hero-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin-bottom:10px;
}

.ficha-layout-sena .ficha-hero-kicker{
  display:inline-flex;
  align-items:center;
  gap:10px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color: rgba(255,255,255,.75);
  font-weight:700;
}

.ficha-layout-sena .ficha-hero-title{
  margin: 0;
  font-size: 30px;
  line-height: 1.15;
  font-weight: 900;
  letter-spacing: .01em;
  text-transform: uppercase;
}

.ficha-layout-sena .ficha-mode-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 9px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.92);
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .04em;
  white-space: nowrap;
}

.ficha-layout-sena .ficha-hero-divider{
  height:1px;
  margin: 18px 0;
  background: rgba(255,255,255,.12);
}

.ficha-layout-sena .ficha-hero-codes{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

.ficha-layout-sena .ficha-code-card{
  display:flex;
  align-items:center;
  gap:12px;
  padding: 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
}

.ficha-layout-sena .ficha-code-icon{
  width:42px; height:42px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 18px;
  background: rgba(34,197,94,.22);
  flex:0 0 auto;
}

.ficha-layout-sena .ficha-code-icon.alt{
  background: rgba(139,92,246,.20);
}

.ficha-layout-sena .ficha-code-label{
  font-size: 11px;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: rgba(255,255,255,.68);
  font-weight: 800;
}

.ficha-layout-sena .ficha-code-value{
  margin-top: 2px;
  font-size: 20px;
  font-weight: 900;
  color: #fff;
}

.ficha-layout-sena .ficha-panel-body{
  background: var(--bg-soft);
  padding: 18px 18px 20px;
}

.ficha-layout-sena .ficha-stages{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: stretch;
  gap: 16px;
}

.ficha-layout-sena .stage-arrow{
  width:42px; height:42px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  align-self:center;
  background:#fff;
  border: 1px solid rgba(229,231,235,.95);
  box-shadow: 0 10px 24px rgba(15,23,42,.08);
  color: rgba(100,116,139,.8);
  font-size: 18px;
}

.ficha-layout-sena .stage-card{
  border-radius: 18px;
  background:#fff;
  border: 1px solid rgba(229,231,235,.95);
  box-shadow: 0 10px 26px rgba(15,23,42,.06);
  padding: 14px 16px 16px;
  overflow: hidden;
}

.ficha-layout-sena .stage-card.lectiva{ border-left: 5px solid var(--green); }
.ficha-layout-sena .stage-card.productiva{ border-left: 5px solid var(--orange); }

.ficha-layout-sena .stage-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom: 12px;
}

.ficha-layout-sena .stage-badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 900;
  letter-spacing: .06em;
  text-transform: uppercase;
  border: 1px solid transparent;
}

.ficha-layout-sena .stage-badge.lectiva{
  background: rgba(22,163,74,.14);
  border-color: rgba(22,163,74,.28);
  color: var(--green-dark);
}

.ficha-layout-sena .stage-badge.productiva{
  background: rgba(249,115,22,.14);
  border-color: rgba(249,115,22,.30);
  color: var(--orange-dark);
}

.ficha-layout-sena .stage-status{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding: 6px 10px;
  border-radius: 10px;
  background: #f3f4f6;
  border: 1px solid rgba(229,231,235,.95);
  font-size: 12px;
  font-weight: 800;
  color: var(--muted);
  white-space: nowrap;
}

.ficha-layout-sena .stage-status.on{
  background: rgba(22,163,74,.12);
  border-color: rgba(22,163,74,.26);
  color: #166534;
}

.ficha-layout-sena .stage-dates{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 14px;
}

.ficha-layout-sena .stage-date-box{
  border-radius: 14px;
  background: #f9fafb;
  border: 1px solid rgba(229,231,235,.90);
  padding: 12px;
}

.ficha-layout-sena .stage-date-label{
  display:block;
  font-size: 12px;
  color: var(--muted);
  font-weight: 800;
  margin-bottom: 6px;
}

.ficha-layout-sena .stage-date-value{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size: 14px;
  font-weight: 900;
  color: #111827;
}

.ficha-layout-sena .stage-progress-meta{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap: 10px;
  margin-bottom: 10px;
}

.ficha-layout-sena .stage-progress-label{
  font-size: 11px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color: #9ca3af;
  font-weight: 900;
}

.ficha-layout-sena .stage-progress-value{
  font-size: 16px;
  font-weight: 900;
  text-align: right;
}

.ficha-layout-sena .stage-progress-value.green{ color: var(--green-dark); }
.ficha-layout-sena .stage-progress-value.orange{ color: var(--orange-dark); }

.ficha-layout-sena .stage-progress-bar{
  width:100%;
  height:10px;
  border-radius:999px;
  background: rgba(229,231,235,.90);
  overflow:hidden;
}

.ficha-layout-sena .stage-progress-fill{
  height:100%;
  width: var(--progress, 0%);
  border-radius:999px;
}

.ficha-layout-sena .lectiva .stage-progress-fill{
  background: linear-gradient(to right, var(--green), var(--green-2));
}

.ficha-layout-sena .productiva .stage-progress-fill{
  background: linear-gradient(to right, var(--orange), #fb923c);
}

@media (max-width: 900px){
  .ficha-layout-sena .ficha-hero-title{ font-size: 22px; }
  .ficha-layout-sena .ficha-hero-codes{ grid-template-columns: 1fr; }
  .ficha-layout-sena .ficha-stages{ grid-template-columns: 1fr; }
  .ficha-layout-sena .stage-arrow{ display:none; }
}
</style>
</head>
<body>
<header>
<img alt="Logo SENA" src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png"/>
<h1>Servicio Nacional de Aprendizaje - SENA Regional Tolima</h1>
<div class="header-center">
<h2>Centro de Comercio y Servicios</h2>
<h1>SENA 360 – Panel Integral de Seguimiento a la FPI</h1>
<hr/>
</div>
</header>
<!-- PANTALLA INICIAL / LOGIN COORDINADOR -->
<div id="loginOverlay">
<div class="login-card">
<div class="login-logo">
<img alt="Logo SENA" src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png"/>
</div>
<h1 class="login-title">SENA 360 – Panel Integral de Seguimiento a la FPI</h1>
<p class="login-subtitle">Seleccione el Coordinador Académico para ingresar</p>
<div class="login-field">
<label for="coordinadorSelect">Coordinador Académico</label>
<select id="coordinadorSelect">
<option value="">Seleccione un coordinador...</option>
<option value="EDNA PAOLA OSORIO MUÑOZ">EDNA PAOLA OSORIO MUÑOZ</option>
<option value="JORGE ARMANDO VARELA RENDÓN">JORGE ARMANDO VARELA RENDÓN</option>
<option value="YOLANDA CÁRDENAS VILLAMARIN">YOLANDA CÁRDENAS VILLAMARIN</option>
</select>
</div>
<div class="login-toggle-roles">
<input aria-label="Validar roles" checked="" id="chkValidarRoles" title="Validar roles" type="checkbox"/>
</div>
<button class="btnEstilo login-button" id="btnIngresar">Ingresar</button>
<div class="login-error" id="loginMensajeError" style="display:none;">
        Por favor seleccione un coordinador para continuar.
      </div>
</div>
</div>
<!-- Overlay para confirmar Gerente de Proyecto -->
<div id="gerenteOverlay">
<div class="login-card">
<div class="login-header">
<div class="login-header-main">
<span class="login-icon">📋</span>
<div>
<div class="login-title">Confirmar Gerente de Proyecto</div>
<div class="login-subtitle">
              ¿El siguiente instructor es el Gerente de Proyecto?
            </div>
</div>
</div>
</div>
<div class="login-fields">
<div class="login-field">
<label>Instructor</label>
<div class="login-subtitle" id="gerenteInstructorNombre" style="font-weight:600;"></div>
</div>
</div>
<div class="login-actions">
<button class="btnEstilo" id="btnGerenteSi">
<span class="login-button-icon">✔</span>
<span>Sí</span>
</button>
<button class="btnEstilo btn-negativo" id="btnGerenteNo">
<span class="login-button-icon">✖</span>
<span>No</span>
</button>
</div>
<!-- Se muestra solo si el usuario responde NO -->
<div id="contenedorSelectorGerente" style="display:none; margin-top:18px;">
<div class="login-field">
<label>Seleccione el Gerente de Proyecto</label>
<select id="selectGerenteProyecto">
<option value="">Seleccione un instructor…</option>
</select>
</div>
<div class="login-actions" style="margin-top:10px; justify-content:flex-end;">
<button class="btnEstilo" id="btnAceptarGerente">
<span class="login-button-icon">✔</span>
<span>Aceptar</span>
</button>
</div>
<div class="login-error" id="gerenteMensajeError" style="display:none;">
          Por favor seleccione un instructor.
        </div>
</div>
</div>
</div>
<!-- Overlay para seleccionar Aprendiz Vocero -->
<div id="voceroOverlay" style="display:none;">
<div class="login-card">
<div class="login-header">
<div class="login-header-main">
<span class="login-icon">🗣️</span>
<div>
<div class="login-title">Seleccionar Aprendiz Vocero</div>
<div class="login-subtitle">
              Seleccione el aprendiz vocero del grupo (solo estado EN FORMACIÓN).
            </div>
</div>
</div>
</div>
<div class="login-fields">
<div class="login-field">
<label for="selectAprendizVocero">Aprendiz Vocero</label>
<select id="selectAprendizVocero">
<option value="">Seleccione un aprendiz…</option>
</select>
</div>
</div>
<div class="login-actions" style="margin-top:10px; justify-content:flex-end;">
<button class="btnEstilo" id="btnAceptarVocero">
<span class="login-button-icon">✔</span>
<span>Aceptar</span>
</button>
</div>
<div class="login-error" id="voceroMensajeError" style="display:none;">
        Por favor seleccione un aprendiz.
      </div>
</div>
</div>
<!-- ACORDEÓN: Cargue de Archivos -->
<div class="contenedor" id="accordionCargue">
<button class="acordeon-header" id="accordionCargueToggle" type="button">
<span>📂 Cargue de Archivos</span>
<span class="acordeon-icon" id="accordionCargueIcon">▾</span>
</button>
<div class="acordeon-body" id="accordionCargueBody">
<!-- ARCHIVO 1 -->
<div id="sectionFile1">
<h2>Cargar Archivo de Instructores (XLS/XLSX)</h2>
<p class="nota-archivo"><em>Obtener en Sofia Plus: Rol (Gestion de Desarrollo Curricular) › Gestion de Ambientes
            › Instructores › Reporte de Instructores por Ficha.</em></p>
<input accept=".xls,.xlsx" id="excelFile1" type="file"/>
<br/><br/>
<button class="btnEstilo" id="btnProcesar1">Procesar Archivo 1</button>
<div class="mensaje-archivo" id="mensajeArchivo1"></div>
</div>
<!-- ARCHIVO 2 -->
<div id="sectionFile2" style="display: none;">
<h2>Cargar Archivo de Juicios Evaluativos (XLS/XLSX)</h2>
<p class="nota-archivo"><em>Obtener en Sofia Plus: Rol (Gestion de Desarrollo Curricular o Instructor) ›
            Ejecucion de la formacion › Reportes › Reportes de Juicio de Evaluacion.</em></p>
<input accept=".xls,.xlsx" id="excelFile2" type="file"/>
<br/><br/>
<button class="btnEstilo" disabled="" id="btnProcesar2">Procesar Archivo 2</button>
<div class="mensaje-archivo" id="mensajeArchivo2"></div>
<div class="error" id="mensajeError"></div>
</div>
<!-- ARCHIVO 3 -->
<div id="sectionFile3" style="display: none;">
<h2>Cargar Archivo de Horas Diseño (XLS/XLSX)</h2>
<input accept=".xls,.xlsx" id="archivoDiseno" type="file"/>
<br/><br/>
<button class="btnEstilo" id="btnCargarDiseno">Procesar Archivo 3</button>
<p class="nota-archivo"><em>Descargar desde: <a href="https://acortar.link/p1cWdD" rel="noopener noreferrer" target="_blank">https://acortar.link/p1cWdD</a></em></p>
<div class="mensaje-archivo" id="mensajeArchivo3"></div>
</div>
</div>
</div>
<!-- ENCABEZADO DE LA FICHA (Se muestra después de File1) -->
<div class="contenedor" id="headerInfo" style="display:none;">
<!-- Cabecera del acordeón -->
<button class="acordeon-header" id="accordionInfoToggle" type="button">
<span>ℹ️ Información General de la Ficha</span>
<span class="acordeon-icon" id="accordionInfoIcon">▾</span>
</button>
<!-- Cuerpo del acordeón: INICIA ABIERTO -->
<div class="acordeon-body" id="accordionInfoBody">
<!-- Tarjetas superiores: código ficha, nombre programa, código programa -->
<div class="ficha-layout ficha-layout-sena">
<section aria-label="Información General de la Ficha" class="ficha-panel">
<div class="ficha-hero">
<div class="ficha-hero-top">
<div class="ficha-hero-kicker">
<span class="icon" role="img" aria-label="Programa">🎓</span>
<span>PROGRAMA DE FORMACIÓN</span>
</div>
<div class="ficha-mode-pill" title="Modalidad de formación">
<span class="icon" role="img" aria-label="Modalidad">👥</span>
<span id="modalidadFormacion">PRESENCIAL</span>
</div>
</div>
<h3 class="ficha-hero-title" id="nombrePrograma"></h3>
<div class="ficha-hero-divider" role="presentation"></div>
<div class="ficha-hero-codes">
<div class="ficha-code-card">
<div class="ficha-code-icon" role="img" aria-label="Código ficha">📋</div>
<div class="ficha-code-text">
<div class="ficha-code-label">CÓDIGO FICHA</div>
<div class="ficha-code-value" id="codigoFicha"></div>
</div>
</div>
<div class="ficha-code-card">
<div class="ficha-code-icon alt" role="img" aria-label="Código del programa">🔢</div>
<div class="ficha-code-text">
<div class="ficha-code-label">CÓDIGO DEL PROGRAMA</div>
<div class="ficha-code-value" id="codigoPrograma"></div>
</div>
</div>
</div>
</div>
<div class="ficha-panel-body">
<div class="ficha-stages">
<!-- ETAPA LECTIVA -->
<article class="stage-card lectiva" style="--progress: 70%;">
<header class="stage-header">
<span class="stage-badge lectiva">
<span class="icon" role="img" aria-label="Etapa lectiva">📚</span>
              ETAPA LECTIVA
            </span>
<span class="stage-status on">En Curso</span>
</header>
<div class="stage-dates">
<div class="stage-date-box">
<span class="stage-date-label">Fecha Inicio</span>
<span class="stage-date-value">
<span class="icon" role="img" aria-label="Fecha">📅</span>
<span id="fechaInicioLectiva"></span>
</span>
</div>
<div class="stage-date-box">
<span class="stage-date-label">Fecha Fin</span>
<span class="stage-date-value">
<span class="icon" role="img" aria-label="Fecha">📅</span>
<span id="fechaFinLectiva"></span>
</span>
</div>
</div>
<div class="stage-progress">
<div class="stage-progress-meta">
<span class="stage-progress-label">TIEMPO RESTANTE</span>
<span class="stage-progress-value green" id="tiempoRestanteLectiva">-</span>
</div>
<div class="stage-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
<div class="stage-progress-fill"></div>
</div>
</div>
</article>
<div class="stage-arrow" role="img" aria-label="Siguiente etapa">➜</div>
<!-- ETAPA PRODUCTIVA -->
<article class="stage-card productiva" style="--progress: 0%;">
<header class="stage-header">
<span class="stage-badge productiva">
<span class="icon" role="img" aria-label="Etapa productiva">🧰</span>
              ETAPA PRODUCTIVA
            </span>
<span class="stage-status">Pendiente</span>
</header>
<div class="stage-dates">
<div class="stage-date-box">
<span class="stage-date-label">Fecha Inicio</span>
<span class="stage-date-value">
<span class="icon" role="img" aria-label="Fecha">📅</span>
<span id="fechaInicioProductiva"></span>
</span>
</div>
<div class="stage-date-box">
<span class="stage-date-label">Fecha Fin</span>
<span class="stage-date-value">
<span class="icon" role="img" aria-label="Fecha">📅</span>
<span id="fechaFinProductiva"></span>
</span>
</div>
</div>
<div class="stage-progress">
<div class="stage-progress-meta">
<span class="stage-progress-label">TIEMPO RESTANTE</span>
<span class="stage-progress-value orange" id="tiempoRestanteProductiva">-</span>
</div>
<div class="stage-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
<div class="stage-progress-fill"></div>
</div>
</div>
</article>
</div>
</div>
</section>
</div>
<!-- Línea de tiempo compacta (debajo de fechas) -->
<div class="timeline-card timeline-compact">
<div class="timeline-header">
<div class="timeline-title"><span class="icon">🕒</span>Cronograma de Formación</div>
<div class="timeline-status" id="estadoEtapaMini">-</div>
</div>
<div class="timeline-track compact" id="timelineTrackMini">
<div class="timeline-fill" id="timelineFillMini"></div>
<div class="timeline-point" id="pMiniInicioLectiva"><span class="timeline-point-label">Inicio
              Lectiva<br/><small id="dMiniInicioLectiva"></small></span></div>
<div class="timeline-point alt" id="pMiniFinLectiva"><span class="timeline-point-label">Fin Lectiva<br/><small id="dMiniFinLectiva"></small></span></div>
<div class="timeline-point" id="pMiniInicioProd"><span class="timeline-point-label">Inicia
              Productiva<br/><small id="dMiniInicioProd"></small></span></div>
<div class="timeline-point alt" id="pMiniFinProd"><span class="timeline-point-label">Fin Programa<br/><small id="dMiniFinProd"></small></span></div>
<div class="timeline-point today" id="pMiniHoy"><span class="timeline-point-label">HOY<br/><small id="dMiniHoy"></small></span></div>
</div>
</div>
<!-- Resumen numérico de la ficha -->
<!-- Resumen numérico de la ficha -->
<div class="ficha-summary-row">
<!-- Fila 1: KPIs principales -->
<div class="ficha-summary-top">
<div class="ficha-kpi-card ficha-kpi-aprendices">
<div class="ficha-kpi-icon">📋</div>
<div class="ficha-kpi-info">
<span class="ficha-kpi-label">APRENDICES MATRICULADOS</span>
<span class="ficha-kpi-value" id="numMatriculadosHeader">0</span>
</div>
</div>
<div class="ficha-kpi-card ficha-kpi-aprendices">
<div class="ficha-kpi-icon">🎓</div>
<div class="ficha-kpi-info">
<span class="ficha-kpi-label">APRENDICES EN FORMACION</span>
<span class="ficha-kpi-value" id="numAprendicesHeader">0</span>
</div>
</div>
<div class="ficha-kpi-card ficha-kpi-instructores">
<div class="ficha-kpi-icon">📡</div>
<div class="ficha-kpi-info">
<span class="ficha-kpi-label">INSTRUCTORES</span>
<span class="ficha-kpi-value" id="numInstructoresHeader">0</span>
</div>
</div>
<div class="ficha-kpi-card ficha-kpi-competencias">
<div class="ficha-kpi-icon">🧩</div>
<div class="ficha-kpi-info">
<span class="ficha-kpi-label">COMPETENCIAS</span>
<span class="ficha-kpi-value" id="numCompetenciasHeader">0</span>
</div>
</div>
<!-- NUEVA TARJETA: Resultados de Aprendizaje -->
<div class="ficha-kpi-card ficha-kpi-resultados">
<div class="ficha-kpi-icon">📚</div>
<div class="ficha-kpi-info">
<span class="ficha-kpi-label">RESULTADOS DE APRENDIZAJE</span>
<span class="ficha-kpi-value" id="numResultadosHeader">0</span>
</div>
</div>
</div>
<!-- Fila 2: Instructor y Coordinador -->
<div class="ficha-summary-middle">
<!-- NUEVO: Aprendiz Vocero -->
<div class="ficha-secondary-card ficha-secondary-vocero">
<div class="ficha-secondary-title">
<span class="ficha-secondary-icon">🗣️</span>
<span>Aprendiz Vocero</span>
</div>
<div class="ficha-secondary-value" id="aprendizVoceroHeader">-</div>
</div>
<!-- EXISTENTE: Instructor Gerente de Proyecto -->
<div class="ficha-secondary-card ficha-secondary-instructor">
<div class="ficha-secondary-title">
<span class="ficha-secondary-icon">👨‍🏫</span>
<span>Instructor Gerente de Proyecto</span>
</div>
<div class="ficha-secondary-value" id="instructorMasHorasHeader">-</div>
</div>
<!-- EXISTENTE: Coordinador Académico -->
<div class="ficha-secondary-card ficha-secondary-coordinador">
<div class="ficha-secondary-title">
<span class="ficha-secondary-icon">📋</span>
<span>Coordinador Académico</span>
</div>
<div class="ficha-secondary-value" id="coordinadorAcademicoHeader">-</div>
</div>
</div>
<!-- Fila 3: Análisis de rendimiento -->
<div class="ficha-analisis-card">
<div class="ficha-analisis-header">
<span class="ficha-analisis-icon">📊</span>
<span>ANÁLISIS DE RENDIMIENTO</span>
</div>
<div class="ficha-analisis-main">
<div class="ficha-analisis-circular-wrap">
<div class="ficha-analisis-circular" id="avancePromedioCircular">
<div class="ficha-analisis-circular-inner">
<span class="ficha-analisis-circular-title">Avance Promedio del Grupo</span>
<span class="ficha-analisis-circular-value" id="avancePromedioGrupoHeader">0 %</span>
<span class="ficha-analisis-circular-sub">Total competencias</span>
</div>
</div>
</div>
<div class="ficha-analisis-right">
<div class="ficha-analisis-summary-grid">
<div class="ficha-analisis-summary-card card-verde">
<span class="summary-title">Listos etapa productiva</span>
<span class="summary-value" id="numAprendicesListosProductivaHeader">0</span>
<span class="summary-note">Aprobados</span>
</div>
<div class="ficha-analisis-summary-card card-rojo">
<span class="summary-title">No listos etapa productiva</span>
<span class="summary-value" id="numAprendicesNoListosProductivaHeader">0</span>
<span class="summary-note">Requieren atención</span>
</div>
</div>
<div class="ficha-analisis-metricas-grid">
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">🧠</span>
<span>Competencias sobrecargadas</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numCompetenciasSobrecargadasHeader">0</div>
<div class="ficha-analisis-metrica-note">Competencias</div>
</div>
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">🚫</span>
<span>Competencias NO aprobados</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numCompetenciasNoAprobadasHeader">0</div>
<div class="ficha-analisis-metrica-note">Competencias</div>
</div>
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">📉</span>
<span>Raps NO aprobados</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numResultadosNoAprobadosHeader">0</div>
<div class="ficha-analisis-metrica-note">RAPs</div>
</div>
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">⚠️</span>
<span>Total RAPs pendientes por evaluar(visto)</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numRapsPendientesVistoHeader">0</div>
<div class="ficha-analisis-metrica-note">RAPs</div>
</div>
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">👩‍🎓🚫</span>
<span>Aprendices con competencias NO aprobadas</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numAprendicesConCompetenciasNoAprobadasHeader">0</div>
<div class="ficha-analisis-metrica-note">Aprendices</div>
</div>
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">🧾</span>
<span>Aprendices con competencias por evaluar</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numAprendicesConCompetenciasPorEvaluarHeader">0</div>
<div class="ficha-analisis-metrica-note">Aprendices</div>
</div>
<div class="ficha-analisis-metrica">
<div class="ficha-analisis-metrica-header">
<span class="ficha-analisis-metrica-badge">🚩</span>
<span>Aprendices con avance &lt; 75%</span>
</div>
<div class="ficha-analisis-metrica-valor" id="numAprendicesRiesgoHeader">0</div>
<div class="ficha-analisis-metrica-note">Aprendices</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Tabla de Estado -->
<!-- Tarjeta Detalle de Aprendices -->
<div class="detalle-aprendices-card">
<div class="detalle-aprendices-card-header">
<div class="detalle-aprendices-title">
<span class="detalle-aprendices-icon">👥</span>
<span>Detalle de Aprendices</span>
</div>
<div class="detalle-aprendices-total">
<span>Total Aprendices Matriculados:</span>
<span id="totalAprendicesEstado">0</span>
</div>
</div>
<table id="tablaEstado">
<thead>
<tr>
<th>Estado</th>
<th>Aprendices (Nombres)</th>
<th>Cant.</th>
<th>%</th>
</tr>
</thead>
<tbody id="tbodyEstado"></tbody>
</table>
</div>
<!-- Gráfica Circular de Estados de Aprendices -->
<div class="estado-chart-card">
<h3 class="estado-chart-title">Distribución de Estados de Aprendices</h3>
<div class="estado-chart-wrapper">
<!-- Contenedor para CanvasJS -->
<div id="estadoChartContainer" style="height: 370px; width: 100%;"></div>
</div>
</div>
</div>
</div>
<!-- REPORTES EN PESTAÑAS -->
<div class="contenedor" id="reportes" style="display: none;">
<!-- Cabecera del acordeón -->
<button class="acordeon-header" id="accordionReportesToggle" type="button">
<span>📊 Reportes de la formacion</span>
<span class="acordeon-icon" id="accordionReportesIcon">▾</span>
</button>
<!-- Cuerpo del acordeón: aquí van las pestañas y todo su contenido -->
<div class="acordeon-body" id="accordionReportesBody">
<ul class="tabs">
<!-- REPORTE 1 – tab1 -->
<li>
<a class="active" href="#tab1">
<span class="tab-icon">👥</span>
<span class="tab-label">REPORTE 1</span>
<span class="tab-title">Instructores y Competencias</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 2 – tab2 -->
<li>
<a href="#tab2">
<span class="tab-icon">📊</span>
<span class="tab-label">REPORTE 2</span>
<span class="tab-title">% Competencias</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 3 – tab4 -->
<li>
<a href="#tab4">
<span class="tab-icon">📅</span>
<span class="tab-label">REPORTE 3</span>
<span class="tab-title">Competencias programadas</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 4 – tab5 -->
<li>
<a href="#tab5">
<span class="tab-icon">❗</span>
<span class="tab-label">REPORTE 4</span>
<span class="tab-title">Raps por evaluar</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 5 – tab6 -->
<li>
<a href="#tab6">
<span class="tab-icon">✅</span>
<span class="tab-label">REPORTE 5</span>
<span class="tab-title">Raps Aprobado / Por evaluar / No aprobado</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 6 – tab7 -->
<li>
<a href="#tab7">
<span class="tab-icon">📈</span>
<span class="tab-label">REPORTE 6</span>
<span class="tab-title">% Avance Aprendiz</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 7 – tab8 -->
<li>
<a href="#tab8">
<span class="tab-icon">👤</span>
<span class="tab-label">REPORTE 7</span>
<span class="tab-title">Aprendices pendientes por evaluar</span>
<span class="tab-arrow"></span>
</a>
</li>
<!-- REPORTE 8 – tab3 -->
<li>
<a href="#tab3">
<span class="tab-icon">📡</span>
<span class="tab-label">REPORTE 8</span>
<span class="tab-title">Instructores</span>
<span class="tab-arrow"></span>
</a>
</li>
</ul>
<!-- TAB 1 -->
<div class="tab-content active" id="tab1">
<div id="reporte1">
<h2>Instructores y Competencias</h2>
<p class="descripcion-reporte">
              Presenta el detalle de cada competencia programada con su instructor y las horas asignadas.
              Permite identificar qué instructores atienden cada competencia y validar la distribución de la carga
              académica.
              Cuenta con barra de búsqueda y filtros por estado del instructor, tipo de competencia transversal,
              Tecnicas, Ingles para ubicar rápidamente la información.
            </p>
<!-- Filtros para Reporte 1 -->
<div class="filtros-reporte1">
<!-- 1. Caja de texto para buscar -->
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaReporte1" placeholder="Buscar instructor, competencia o ficha..." type="text"/>
</div>
<!-- 2. Chips / checkboxes de categorías -->
<div class="filtros-categorias-reporte1">
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte1" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte1" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte1" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte1" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
<div class="filtros-colores-dias" data-table="tablaReporte1">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#14b8a6;">
<span class="tabla-total-label">Total Horas programada</span>
<strong class="tabla-total-value" id="totalHorasProgramadasReporte1">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosReporte1">0</strong>
</div>
</div>
</div>
<table id="tablaReporte1">
<thead>
<tr>
<th>#</th>
<th>Nombre Instructor</th>
<th>Apellido Instructor</th>
<th>Fecha de inicio</th>
<th>Fecha fin</th>
<th>Diferencia de Días</th>
<th>Competencia</th>
<th>Tipo</th>
<th>Horas Programadas</th>
</tr>
</thead>
<tbody id="tbodyReporte1"></tbody>
</table>
</div>
</div>
<!-- TAB 2 -->
<div class="tab-content" id="tab2">
<div id="reporte2">
<h2>% Competencias con Horas</h2>
<p class="descripcion-reporte">
              Muestra, por competencia, las horas programadas frente a las horas de diseño curricular y el porcentaje de
              ejecución.
              Resalta las competencias que superan el diseño e incluye un cronograma Gantt con los meses de
              programación.
              Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar
              rápidamente la información.
            </p>
<!-- Nota sobre competencias que superan el diseño -->
<p id="notaCompetenciasHoras" style="display:none; font-size:0.9rem; color:#7f1d1d; margin:4px 0 8px 0;">
              Las competencias resaltadas en rojo es porque superaron la cantidad de horas
              establecidas en el diseño curricular, favor no programar más.
            </p>
<!-- Filtros para Reporte 2 (mismo diseño que Reporte 1) -->
<div class="filtros-reporte1 filtros-reporte2">
<!-- Caja de texto para buscar -->
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaReporte2" placeholder="Buscar competencia..." type="text"/>
</div>
<!-- Chips / checkboxes de categorías -->
<div class="filtros-categorias-reporte1">
<label class="chip-reporte2 chip-tipo" data-tipo="Transversales">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</label>
<label class="chip-reporte2 chip-tipo" data-tipo="Técnicas">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</label>
<label class="chip-reporte2 chip-tipo" data-tipo="Inglés">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</label>
<label class="chip-reporte2 chip-tipo" data-tipo="Práctica">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</label>
</div>
</div>
<div class="filtros-colores-dias" data-table="tablaReporte2">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
<button class="btn-filtro-dias btn-morado" data-color="pendiente" type="button">Pendiente</button>
</div>
<div class="mes-selector-wrap">
<div class="mes-selector-panel">
<span class="mes-selector-icon">Mes</span>
<span>Filtrar por mes de formación</span>
<select id="mesSelectReporte2">
<option value="ALL">Periodo completo</option>
</select>
</div>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#22c55e;">
<span class="tabla-total-label">Total Horas</span>
<strong class="tabla-total-value" id="totalHorasReporte2">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#f97316;">
<span class="tabla-total-label">Total Horas diseño</span>
<strong class="tabla-total-value" id="totalHorasDisenoReporte2">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#2563eb;">
<span class="tabla-total-label">Total %</span>
<strong class="tabla-total-value" id="totalPorcentajeReporte2">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#6366f1;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosReporte2">0</strong>
</div>
</div>
<table id="tablaReporte2">
<thead>
<tr>
<th>#</th>
<th>Competencia</th>
<th>Tipo</th>
<th>Fecha de inicio</th>
<th>Fecha fin</th>
<th>Diferencia de Días</th>
<th>Total de Horas</th>
<th>Horas Diseño</th>
<th>%</th>
</tr>
</thead>
<tbody id="tbodyReporte2"></tbody>
<tfoot id="tfootReporte2"></tfoot>
</table>
<!-- Gráfica -->
<h3>% Competencias con Horas (Total vs Diseño)</h3>
<div class="chart-container">
<div id="chartCompetenciasHorasContainer" style="width: 100%;"></div>
</div>
<!-- Gantt en contenedor independiente -->
<div class="detalle-gantt-card">
<h3>Cronograma Gantt Detallado</h3>
<div class="detalle-gantt-controls">
<div class="detalle-gantt-search">
<span class="icono-buscar">🔎</span>
<input id="ganttSearchInput" placeholder="Buscar competencia o instructor..." type="text"/>
</div>
<div class="detalle-gantt-filtros">
<button class="gantt-filter-button active" data-cat="transversales" data-target="detalle" type="button">
                      Transversales
                    </button>
<button class="gantt-filter-button active" data-cat="tecnicas" data-target="detalle" type="button">
                      Técnicas
                    </button>
<button class="gantt-filter-button active" data-cat="ingles" data-target="detalle" type="button">
                      Inglés
                    </button>
<button class="gantt-filter-button active" data-cat="practica" data-target="detalle" type="button">
                      Práctica
                    </button>
</div>
</div>
<div class="detalle-gantt-container" id="anychartGanttContainer"></div>
</div>
</div>
</div>
<!-- TAB 3 -->
<div class="tab-content" id="tab3">
<div id="reporte3">
<h2>Listado de Instructores (Total de Horas Programadas)</h2>
<p class="descripcion-reporte">
              Lista todos los instructores del programa con el total de horas programadas y un gráfico de barras que
              resume la distribución de la carga.
              Permite detectar sobrecargas o brechas de asignación.
              Cuenta con barra de búsqueda y filtros por instructor, ficha y tipo de competencia.
            </p>
<!-- Barra de búsqueda para el listado de instructores -->
<div class="filtros-reporte1">
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaInstructoresHoras" placeholder="Buscar instructor..." type="text"/>
</div>
<div class="filtros-categorias-reporte1">
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte3" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte3" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte3" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte3" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
</div>
<div class="filtros-colores-dias" data-table="tablaInstructoresHoras">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
</div>
<div class="mes-selector-wrap">
<div class="mes-selector-panel">
<span class="mes-selector-icon">Mes</span>
<span>Filtrar por mes de formación</span>
<select id="mesSelectReporte3">
<option value="ALL">Periodo completo</option>
</select>
</div>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#0ea5e9;">
<span class="tabla-total-label">Total Horas programadas</span>
<strong class="tabla-total-value" id="totalHorasReporte3">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosReporte3">0</strong>
</div>
</div>
<table id="tablaInstructoresHoras">
<thead>
<tr>
<th>#</th>
<th>Nombre Instructor</th>
<th>Apellido Instructor</th>
<th>Tipo</th>
<th>Fecha de inicio</th>
<th>Fecha fin</th>
<th>Diferencia de Días</th>
<th>Horas Programadas</th>
</tr>
</thead>
<tbody id="tbodyReporte3"></tbody>
<tfoot id="tfootReporte3"></tfoot>
</table>
<!-- Contenedor del gráfico, ocupando el 100% del TAB -->
<div class="chart-container">
<h3 style="margin: 0 0 12px 0;">
                Total de Horas Programadas por Instructor
              </h3>
<div id="chartInstructoresHorasContainer" style="width: 100%;"></div>
</div>
</div>
<!-- Listado de Instructores con aprendices pendientes por emitir Juicio -->
<div class="reporte-exportable" id="listado-instructores-pendientes-juicio">
<h3 id="tituloListadoPendientesR8" style="margin-top: 8px;">
            Listado de Instructores Aprendices pendientes por emitir Juicio
          </h3>
<!-- Barra de búsqueda para pendientes por emitir juicio -->
<div class="filtros-reporte1">
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaPendientesJuicio" placeholder="Buscar instructor, competencia o aprendiz..." type="text"/>
</div>
<div class="filtros-categorias-reporte1">
<label class="chip-reporte1">
<input checked="" class="chk-cat-pendientes-juicio" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-pendientes-juicio" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-pendientes-juicio" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-pendientes-juicio" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
</div>
<div class="filtros-colores-dias" data-table="tablaPendientesInstructorReporte8">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#14b8a6;">
<span class="tabla-total-label">Total cantidad de aprendices</span>
<strong class="tabla-total-value" id="totalAprendicesPendientesReporte8">0</strong>
</div>
</div>
<table id="tablaPendientesInstructorReporte8">
<thead>
<tr>
<th>#</th>
<th>Nombre instructor o instructores programados</th>
<th>Competencia</th>
<th>Tipo</th>
<th>Fecha de inicio</th>
<th>Fecha Terminación</th>
<th>Dias</th>
<th>Nombre aprendices</th>
<th>Cantidad de Aprendices</th>
</tr>
</thead>
<tbody id="tbodyPendientesInstructorReporte8"></tbody>
</table>
</div>
</div>
<!-- TAB 4 -->
<div class="tab-content" id="tab4">
<div id="reporte4">
<h2>Competencias del Programa (Programada: Sí/No)</h2>
<p class="descripcion-reporte">
              Muestra todas las competencias del programa indicando si están programadas o no (Sí/No), integrando la
              lógica de programación, diseño y asignación a instructores.
              Permite visualizar en conjunto la cobertura del plan de estudios y su programación en el tiempo mediante
              el cronograma Gantt.
              Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar
              rápidamente la información.

              En caso que la competencia APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL, SEGURIDAD Y SALUD EN EL TRABAJO DE
              ACUERDO CON LAS POLÍTICAS ORGANIZACIONALES Y LA NORMATIVIDAD VIGENTE. se evidencia con 24 horas o menos
              aparecera con 1/2 lo cual significa que falta programar la competencia de DE PROTECCIÓN AMBIENTAL o
              SEGURIDAD Y SALUD EN EL TRABAJO
            </p>
<!-- Filtros para Reporte 4 (mismo diseño verde) -->
<div class="filtros-reporte1 filtros-reporte4">
<!-- Caja de texto para buscar -->
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaReporte4" placeholder="Buscar competencia..." type="text"/>
</div>
<!-- Chips / checkboxes de categorías -->
<div class="filtros-categorias-reporte1">
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte4" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte4" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte4" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte4" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
<div class="filtros-colores-dias" data-table="tablaReporte4">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
<button class="btn-filtro-dias btn-morado" data-color="pendiente" type="button">Pendiente</button>
</div>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosReporte4">0</strong>
</div>
</div>
<table id="tablaReporte4">
<thead>
<tr>
<th>#</th>
<th>Competencia</th>
<th>Tipo</th>
<th>Fecha de inicio</th>
<th>Fecha fin</th>
<th>Diferencia de Días</th>
<th>Programada</th>
</tr>
</thead>
<tbody id="tbodyReporte4"></tbody>
</table>
<div class="detalle-gantt-card">
<h3>Cronograma Gantt de Competencias (Pendientes)</h3>
<div class="detalle-gantt-controls">
<div class="detalle-gantt-search">
<span class="icono-buscar">🔍</span>
<input id="ganttPendientesSearchInput" placeholder="Buscar competencia pendiente..." type="text"/>
</div>
<div class="detalle-gantt-filtros">
<button class="gantt-filter-button active" data-cat="transversales" data-target="pendientes" type="button">
                      Transversales
                    </button>
<button class="gantt-filter-button active" data-cat="tecnicas" data-target="pendientes" type="button">
                      Técnicas
                    </button>
<button class="gantt-filter-button active" data-cat="ingles" data-target="pendientes" type="button">
                      Inglés
                    </button>
<button class="gantt-filter-button active" data-cat="practica" data-target="pendientes" type="button">
                      Práctica
                    </button>
</div>
</div>
<div class="detalle-gantt-container" id="ganttContainerPendientes"></div>
</div>
</div>
</div>
<!-- TAB 5 -->
<div class="tab-content" id="tab5">
<div id="reporte5">
<h2>
              Raps por evaluar
               </h2>
<p class="descripcion-reporte">
              Presenta los resultados de aprendizaje (RAPs) pendientes de evaluación, diferenciando entre competencias
              ya programadas y competencias aún no vistas.
              Permite identificar rápidamente qué RAPs, competencias y aprendices requieren registro de juicios
              evaluativos.
              Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar
              rápidamente la información.
            </p>
<!-- Filtros para Competencias ya programadas (mismo diseño verde) -->
<div class="filtros-reporte1 filtros-reporte5-programadas">
<!-- Caja de texto para buscar -->
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaProgramadas" placeholder="Buscar competencia, RAP o aprendiz." type="text"/>
</div>
<!-- Chips / checkboxes de categorías -->
<div class="filtros-categorias-reporte1">
<label class="chip-reporte1">
<input checked="" class="chk-cat-programadas" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-programadas" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-programadas" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-programadas" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
</div>
<div class="filtros-colores-dias" data-table="tablaProgramadas">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
<button class="btn-filtro-dias btn-morado" data-color="pendiente" type="button">Pendiente</button>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#a855f7;">
<span class="tabla-total-label">Total Cantidad de aprendices</span>
<strong class="tabla-total-value" id="totalCantAprendicesProgramadas">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosProgramadas">0</strong>
</div>
</div>
<table id="tablaProgramadas">
<thead>
<tr>
<th>#</th>
<th>Competencia</th>
<th>Tipo</th>
<th>Fecha de inicio</th>
<th>Fecha Terminación</th>
<th>Dias</th>
<th>RAP</th>
<th>Aprendices</th>
<th>Cantidad de Aprendices</th>
</tr>
</thead>
<tbody id="tbodyProgramadas"></tbody>
</table>
</div>
</div>
<!-- TAB 6 -->
<div class="tab-content" id="tab6">
<div id="reporte6">
<h2>Raps Aprobados - Por evaluar y No aprobados</h2>
<p class="descripcion-reporte">
              Resume el estado de los RAPs por competencia (Aprobado, Por evaluar, No aprobado) e incluye el nombre del
              funcionario o instructor que registró la evaluación.

              En caso de que la fila se resalte de amarillo es debido a que la evaluo un instructor que no esta asociado
              a la competencia y requiere seguimiento del coordinador

              Facilita el seguimiento del avance de evaluación por competencia y la trazabilidad de quién evaluó.
              Cuenta con barra de búsqueda y filtros por tipo de competencia transversal, Tecnicas, Ingles para ubicar
              rápidamente la información.
            </p>
<!-- Filtros para Reporte 6 (mismo diseño que Reporte 1) -->
<div class="filtros-reporte1 filtros-reporte6">
<!-- Caja de texto para buscar -->
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaReporte6" placeholder="Buscar competencia, RAP o funcionario..." type="text"/>
</div>
<!-- Chips / checkboxes de categorías -->
<div class="filtros-categorias-reporte1">
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte6" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte6" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte6" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte6" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
</div>
<div class="filtros-colores-dias" data-table="tablaReporte6">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
<button class="btn-filtro-dias btn-morado" data-color="pendiente" type="button">Pendiente</button>
<button class="btn-filtro-dias btn-negro" data-color="no-aprobado" type="button">No aprobado</button>
<div class="filtros-raps-botones">
<label class="chip-reporte1 chip-raps-btn chip-amarillo">
<input id="chkSoloRapsOtro" type="checkbox"/>
<span class="chip-text">Raps Aprobados por otro Instructor</span>
</label>
<label class="chip-reporte1 chip-raps-btn chip-naranja">
<input id="chkSoloRapsNoProgramados" type="checkbox"/>
<span class="chip-text">Raps Aprobados y no programados</span>
</label>
</div>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#22c55e;">
<span class="tabla-total-label">Total Aprobado</span>
<strong class="tabla-total-value" id="totalAprobadoReporte6">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#f97316;">
<span class="tabla-total-label">Total Por evaluar</span>
<strong class="tabla-total-value" id="totalPorEvaluarReporte6">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#ef4444;">
<span class="tabla-total-label">Total No aprobado</span>
<strong class="tabla-total-value" id="totalNoAprobadoReporte6">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosReporte6">0</strong>
</div>
</div>
<p id="notaCompetenciasHoras" style="display:none; font-size:0.9rem; color:#7f1d1d; margin:4px 0 8px 0;">
              Las filas resaltadas en amarillo son instructores que evaluaron la competencia al aprendiz sin estar
              programado en la misma.
            </p>
<table id="tablaReporte6">
<thead>
<tr>
<th>#</th>
<th>Competencia</th>
<th>Tipo</th>
<th>Fecha de inicio</th>
<th>Fecha fin</th>
<th>Diferencia de Días</th>
<th>RAP</th>
<th>Funcionario que evaluó</th>
<th>APROBADO</th>
<th>POR EVALUAR</th>
<th>NO APROBADO</th>
</tr>
</thead>
<tbody id="tbodyReporte6"></tbody>
</table>
</div>
</div>
<!-- TAB 7 -->
<div class="tab-content" id="tab7">
<div id="reporte7">
<h2>% Avance por Aprendiz</h2>
<p class="descripcion-reporte">
              Muestra, por aprendiz, el porcentaje de avance global en las competencias e integra el consolidado de
              inasistencias cuando se carga el archivo de fallas.
              Permite identificar riesgos académicos combinando avance y fallas.
              Cuenta con barra de búsqueda y filtros por aprendiz, ficha, rangos de avance y condiciones de riesgo.
            </p>
<!-- Carga del consolidado de inasistencias -->
<div id="sectionFallas" style="margin: 10px 0 15px 0;">
<label for="excelFallas" style="font-weight: 500; display:block; margin-bottom:6px;">
                Cargar consolidado de inasistencias (XLS/XLSX)
              </label>
<p class="nota-archivo"><em>Obtener en Sofia Plus: Rol (Gestion de Desarrollo Curricular) › Gestion de
                  Tiempos › Consultar consolidado de tiempos › Consolidado Inasistencias por Ficha</em></p>
<input accept=".xls,xlsx" id="excelFallas" type="file"/>
<button class="btnEstilo" id="btnProcesarFallas" style="margin-left:10px;">
                Cargar reporte de fallas
              </button>
<div class="mensaje-archivo" id="mensajeFallas" style="display:none; margin-top:10px;"></div>
</div>
<!-- Barra de búsqueda para % Avance por Aprendiz -->
<div class="filtros-reporte1">
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaAvanceAprendiz" placeholder="Buscar por documento, nombre o estado." type="text"/>
</div>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#22c55e;">
<span class="tabla-total-label">Total Aprobado</span>
<strong class="tabla-total-value" id="totalAprobadoAvanceAprendiz">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#f97316;">
<span class="tabla-total-label">Total Por evaluar</span>
<strong class="tabla-total-value" id="totalPorEvaluarAvanceAprendiz">0</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#2563eb;">
<span class="tabla-total-label">Promedio % Avance</span>
<strong class="tabla-total-value" id="promedioPorcentajeAvanceAprendiz">0%</strong>
</div>
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosAvanceAprendiz">0</strong>
</div>
</div>
<table>
<thead>
<tr style="background-color: #f3f4f6;">
<th>#</th>
<th>Documento</th>
<th>Nombre del Aprendiz</th>
<th>Fallas</th>
<th>Detalles</th>
<th>Aprobado</th>
<th>Por Evaluar</th>
<th>% Avance</th>
</tr>
</thead>
<tbody id="pivotAvanceContainer"></tbody>
</table>
<!-- Gráfica de fallas para el reporte 7 (se llena al cargar fallas) -->
<div class="tabla-acta-wrap" id="graficoFallasReporte7Container" style="display:none; text-align:center; margin-top:12px; height:320px;"></div>
</div>
</div>
<!-- TAB 8 -->
<div class="tab-content" id="tab8">
<div id="reporte8">
<h2>
              Competencias Pendientes por Aprendiz e Instructor
             </h2>
<p class="descripcion-reporte">
              Lista los aprendices que tienen competencias pendientes por evaluar, especialmente la competencia
              “RESULTADOS DE APRENDIZAJE ETAPA PRÁCTICA”.
              Desde este reporte se puede generar y descargar el Paz y Salvo académico para quienes ya finalizaron todas
              las competencias lectivas
              y solo tienen pendiente la competencia de etapa práctica, como soporte para iniciar la etapa productiva.
              Agrupa por aprendiz las competencias pendientes y los instructores involucrados, y cuenta con barra de
              búsqueda y filtros por aprendiz, competencia, estado y elegibilidad para Paz y Salvo.
            </p>
<!-- Barra de búsqueda para Competencias Pendientes por Aprendiz e Instructor -->
<div class="filtros-reporte1">
<div class="filtro-busqueda-reporte1">
<span class="filtro-busqueda-icono">🔍</span>
<input id="busquedaPendientesAprendiz" placeholder="Buscar documento, aprendiz, competencia o instructor." type="text"/>
</div>
</div>
<div class="filtros-categorias-reporte1 filtros-categorias-reporte8">
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte8" data-cat="Transversales" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Transversales</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte8" data-cat="Técnicas" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Técnicas</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte8" data-cat="Inglés" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Inglés</span>
</span>
</label>
<label class="chip-reporte1">
<input checked="" class="chk-cat-reporte8" data-cat="Práctica" type="checkbox"/>
<span class="chip-reporte1-inner">
<span class="chip-check">✔</span>
<span class="chip-text">Práctica</span>
</span>
</label>
</div>
<div class="filtros-colores-dias" data-table="tablaReporte8Visible">
<button class="btn-filtro-dias btn-verde" data-color="verde" type="button">En formacion</button>
<button class="btn-filtro-dias btn-rojo" data-color="rojo" type="button">Visto</button>
</div>
<div class="tabla-total">
<div class="tabla-total-card" style="--tabla-total-accent:#0f172a;">
<span class="tabla-total-label">Cantidad registros</span>
<strong class="tabla-total-value" id="totalRegistrosReporte8">0</strong>
</div>
</div>
<!-- Contenedor de las tablas visibles (una por aprendiz) -->
<div id="contenedorTablasReporte8"></div>
</div>
<!-- Tabla RESUMEN (visible) la llenamos por JS dentro de este contenedor -->
<div id="contenedorResumenPracticaReporte8"></div>
<!-- Tabla OCULTA solo para exportar a Excel -->
<table id="tablaReporte8Export" style="display:none; font-size:10px; border-collapse:collapse;">
<thead>
<tr>
<th>#</th>
<th>Documento</th>
<th>Nombre del Aprendiz</th>
<th>Tipo</th>
<th>Competencias Pendientes por Evaluar</th>
<th>Fecha Terminación</th>
<th>Dias</th>
<th>Instructor que impartió la competencia</th>
</tr>
</thead>
<tbody id="tbodyReporte8"></tbody>
</table>
<!-- Tabla RESUMEN (visible) la llenamos por JS dentro de este contenedor -->
<div id="contenedorResumenPracticaReporte8"></div>
</div>
</div>
</div>
<div class="contenedor export-section" id="export-section" style="display: none;">
<!-- Cabecera del acordeón Centro de Reportes -->
<button class="acordeon-header" id="accordionCentroToggle" type="button">
<span>📊 Centro de Reportes</span>
<span class="acordeon-icon" id="accordionCentroIcon">▾</span>
</button>
<!-- Cuerpo del acordeón Centro de Reportes -->
<div class="acordeon-body" id="accordionCentroBody">
<div class="reportes-main">
<div class="reportes-header">
<div>
<h2>Generación de Reportes</h2>
<p>Seleccione los datos que desea incluir y el formato de exportación.</p>
</div>
</div>
<div class="reportes-grid">
<section class="report-card card-aprendices">
<header>
<span class="report-card-icon">🎓</span>
<div>
<h3>Detalle de Aprendices</h3>
</div>
<label class="report-card-todos">
<span>TODOS</span>
<input class="report-card-toggle" data-group="aprendices" type="checkbox"/>
</label>
</header>
<div class="report-card-list">
<label><input class="reporte-checkbox" data-report-group="aprendices" data-reporte-key="avance-fallas" type="checkbox" value="avance-fallas"/> Porcentaje de avance de aprendices y fallas</label>
<label><input class="reporte-checkbox" data-report-group="aprendices" data-reporte-key="competencias-pendientes-aprendiz" type="checkbox" value="competencias-pendientes-aprendiz"/> Competencias pendientes por evaluar por cada aprendiz</label>
<label><input class="reporte-checkbox" data-report-group="aprendices" data-reporte-key="aprendices-listos-productiva" type="checkbox" value="aprendices-listos-productiva"/> Aprendices listos para ir a etapa productiva</label>
<label><input class="reporte-checkbox" data-report-group="aprendices" data-reporte-key="alternativa-etapa-productiva" type="checkbox" value="alternativa-etapa-productiva"/> Alternativa de etapa productiva</label>
<label><input class="reporte-checkbox" data-report-group="aprendices" data-reporte-key="cursos-complementarios" type="checkbox" value="cursos-complementarios"/> Cursos Complementarios</label>
</div>
</section>
<section class="report-card card-instructores">
<header>
<span class="report-card-icon">👩‍🏫</span>
<div>
<h3>Instructores</h3>
</div>
</header>
<div class="report-card-list">
<label><input class="reporte-checkbox" data-report-group="instructores" data-reporte-key="listado-instructores-pendientes-juicio" type="checkbox" value="listado-instructores-pendientes-juicio"/> Instructores con aprendices pendientes por emitir juicio</label>
</div>
</section>
<section class="report-card card-competencias">
<header>
<span class="report-card-icon">📊</span>
<div>
<h3>Análisis y Competencias</h3>
</div>
<label class="report-card-todos">
<span>TODOS</span>
<input class="report-card-toggle" data-group="competencias" type="checkbox"/>
</label>
</header>
<div class="report-card-list">
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="competencias-avance-diseno" type="checkbox" value="competencias-avance-diseno"/> Competencias y % de avance vs diseño</label>
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="cronograma-gantt" type="checkbox" value="cronograma-gantt"/> Cronograma de programación de competencias (Gantt)</label>
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="competencias-sobre-ejecutadas" type="checkbox" value="competencias-sobre-ejecutadas"/> Competencias sobre ejecutadas</label>
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="competencias-pendientes" type="checkbox" value="competencias-pendientes"/> Competencias pendientes</label>
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="competencias-evaluadas-sin-programar" type="checkbox" value="competencias-evaluadas-sin-programar"/> Competencias Evaluadas sin estar programadas</label>
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="competencias-raps-instructor-no-programado" type="checkbox" value="competencias-raps-instructor-no-programado"/> Competencias y RAPs evaluados por instructor no programado</label>
<label><input class="reporte-checkbox" data-report-group="competencias" data-reporte-key="raps-por-evaluar" type="checkbox" value="raps-por-evaluar"/> Raps por evaluar</label>
</div>
</section>
</div>
<div class="reportes-actions">
<div class="reportes-actions-header">
<h3>Acciones de Exportación</h3>
</div>
<div class="reportes-actions-grid">
<button class="btnExportarPDF export-card" id="btnExportarPDF">
<div class="export-card-icon pdf">PDF</div>
<div class="export-card-text">
<strong>Exportar a PDF</strong>
<span>Formato listo para imprimir</span>
</div>
<span class="export-card-arrow">&gt;</span>
</button>
<button class="btnExportarExcel export-card" id="btnExportarExcel">
<div class="export-card-icon excel">XLS</div>
<div class="export-card-text">
<strong>Exportar a Excel</strong>
<span>Datos listos para análisis</span>
</div>
<span class="export-card-arrow">&gt;</span>
</button>
<button class="btnActaComite export-card" id="btnActaComite">
<div class="export-card-icon acta">ACT</div>
<div class="export-card-text">
<strong>Acta Comité</strong>
<span>Plantilla en Word del comité</span>
</div>
</button>
</div>
</div>
</div>
</div>
</div>
<footer class="footer-disenador">
<div class="footer-disenador-title">
        DISEÑO Y DESARROLLO
      </div>
<div class="footer-disenador-card">
<div class="footer-disenador-avatar">✕</div>
<div class="footer-disenador-info">
<span class="footer-disenador-label">Instructor Diseñador</span>
<span class="footer-disenador-name">Yeison Castellanos Gordillo</span>
</div>
<div class="footer-disenador-settings">⚙</div>
</div>
</footer>
<!-- Incluir script AL FINAL -->
<script>
      // Variable global para guardar el coordinador seleccionado
      let coordinadorAcademicoSeleccionado = "";
      let validarRolesActivos = true;
      let municipioFicha = "";
      const botonArchivo2 = document.getElementById("btnProcesar2");
      if (botonArchivo2) {
        botonArchivo2.disabled = true;
      }
      const sectionArchivo2 = document.getElementById("sectionFile2");
      const mensajeErrorFicha = document.getElementById("mensajeError");
      const botonArchivo3 = document.getElementById("btnCargarDiseno");
      if (botonArchivo3) {
        botonArchivo3.disabled = true;
      }
      const sectionArchivo3 = document.getElementById("sectionFile3");
      // =========================
      // Funciones de Utilidad y Normalización
      // =========================
      function normalizeCompetencia(competencia) {
        if (!competencia) return "";
        let comp = competencia.toString().trim();

        // Quitar código numérico inicial tipo "12345 - "
        comp = comp.replace(/^[0-9]+\s*-\s*/, "");

        // Quitar tildes y normalizar espacios
        comp = comp
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // sin tildes
          .toUpperCase()
          .replace(/\s+/g, " "); // un solo espacio entre palabras

        return comp;
      }

      // Captura un gráfico CanvasJS (varios canvas) como imagen base64
      function capturarGraficoComoImg(selector) {
        const wrapper = document.querySelector(selector);
        if (!wrapper) return null;

        const canvases = wrapper.querySelectorAll("canvas");
        if (!canvases.length) return null;

        const output = document.createElement("canvas");
        output.width = canvases[0].width;
        output.height = canvases[0].height;
        const ctx = output.getContext("2d");

        canvases.forEach((canvas) => {
          try {
            ctx.drawImage(canvas, 0, 0, output.width, output.height);
          } catch (err) {
            console.warn("No se pudo capturar el canvas del grafico", err);
          }
        });

        return output.toDataURL("image/png");
      }

      function quitarIconosOrdenTabla(elemento) {
        if (!elemento) return;
        elemento.querySelectorAll(".sort-icons").forEach(icon => icon.remove());
      }

      // Genera el bloque HTML de un gráfico con tamaño estándar para el acta (12x10 cm y centrado)
      function construirGraficoActaHTML(dataURL, alt, fallbackMsg) {
        if (!dataURL) return fallbackMsg || "<em>(No se pudo capturar el grafico al momento de generar el acta.)</em>";
        const altText = alt || "Gráfico";
        return `<div class="tabla-acta-wrap" style="text-align:center; margin:8px auto 10px;">
        <img src="${dataURL}" alt="${altText}" style="width:12cm; height:15cm; display:block; margin:0 auto; border:1px solid #d1d5db; padding:4px; box-sizing:border-box; object-fit:contain;">
      </div>`;
      }

      // Genera un gráfico de barras horizontal con aprendices que tengan fallas (>0)
      function generarGraficoFallasAprendices(datos) {
        if (!Array.isArray(datos) || !datos.length) return null;

        const width = 1000;
        const filas = datos.map((d) => {
          const nombre = (d.nombre || "").trim() || "Aprendiz";
          const doc = (d.doc || "").trim();
          const etiqueta = doc ? `${nombre} (${doc})` : nombre;
          return { ...d, etiqueta };
        });

        const canvas = document.createElement("canvas");
        canvas.width = width;
        const ctx = canvas.getContext("2d");

        ctx.font = "13px Arial";
        const maxEtiqueta = Math.max(...filas.map(f => ctx.measureText(f.etiqueta).width), 0);
        const marginLeft = Math.min(620, Math.max(260, Math.ceil(maxEtiqueta + 40)));
        const margin = { top: 36, right: 80, bottom: 40, left: marginLeft };

        const height = Math.max(260, filas.length * 60 + margin.top + margin.bottom);
        canvas.height = height;

        // Fondo blanco
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, width, height);

        const chartWidth = width - margin.left - margin.right;
        const barHeight = 28;
        const gap = 20;
        const maxFallas = Math.max(...filas.map(d => d.fallas), 1);

        // Título
        ctx.fillStyle = "#111827";
        ctx.font = "bold 20px Arial";
        ctx.textAlign = "left";
        ctx.fillText("Aprendices con fallas", margin.left, 24);

        ctx.font = "13px Arial";
        ctx.fillStyle = "#374151";
        ctx.fillText("Fallas registradas (solo se muestran aprendices con al menos 1 falla)", margin.left, 44);

        filas.forEach((item, idx) => {
          const y = margin.top + idx * (barHeight + gap);
          const x = margin.left;
          const barW = (item.fallas / maxFallas) * chartWidth;

          // Banda de fondo
          ctx.fillStyle = "#e5e7eb";
          ctx.fillRect(x, y, chartWidth, barHeight);

          // Barra principal
          ctx.fillStyle = "#16a34a";
          ctx.fillRect(x, y, barW, barHeight);

          // Etiqueta de nombre (izquierda)
          ctx.fillStyle = "#111827";
          ctx.font = "13px Arial";
          ctx.textAlign = "right";
          ctx.textBaseline = "middle";
          ctx.fillText(item.etiqueta, x - 12, y + barHeight / 2);

          // Valor de fallas al final de la barra
          ctx.textAlign = "left";
          ctx.fillStyle = "#0f172a";
          ctx.font = "bold 13px Arial";
          ctx.fillText(`${item.fallas}`, x + barW + 8, y + barHeight / 2);
        });

        return canvas.toDataURL("image/png");
      }

      function estilizarTablaActa(tabla, colWidths = []) {
        if (!tabla) return;
        tabla.classList.add("tabla-acta-general");
        tabla.style.width = "85%";
        tabla.style.borderCollapse = "collapse";
        tabla.style.tableLayout = "fixed";
        tabla.style.marginTop = "4px";
        tabla.style.marginLeft = "auto";
        tabla.style.marginRight = "auto";
        tabla.style.border = "1px solid #000";
        tabla.querySelectorAll("th, td").forEach(cell => {
          cell.style.border = "1px solid #000";
        });
        const oldColgroup = tabla.querySelector("colgroup");
        if (oldColgroup) oldColgroup.remove();
        if (colWidths && colWidths.length) {
          const colgroup = document.createElement("colgroup");
          colWidths.forEach(w => {
            const col = document.createElement("col");
            col.style.width = w;
            colgroup.appendChild(col);
          });
          tabla.insertBefore(colgroup, tabla.firstElementChild);
        }
      }

      // Renderiza gráfico de fallas (CanvasJS) en el contenedor del reporte 7
      function renderGraficoFallasReporte7(data) {
        const cont = document.getElementById("graficoFallasReporte7Container");
        if (!cont) return;

        if (!Array.isArray(data) || data.length === 0) {
          cont.style.display = "none";
          cont.innerHTML = "";
          chartFallasReporte7 = null;
          return;
        }

        // Ajustar dimensiones del contenedor para un embudo pequeño y centrado
        cont.style.display = "block";
        cont.style.maxWidth = "400px";
        cont.style.margin = "12px auto";
        cont.style.height = "260px";

        const datosOrdenados = data
          .slice()
          .sort((a, b) => (b.fallas || 0) - (a.fallas || 0))
          .map((item) => ({
            label: item.label,
            y: item.fallas
          }));

        chartFallasReporte7 = new CanvasJS.Chart("graficoFallasReporte7Container", {
          theme: "light2",
          animationEnabled: true,
          exportEnabled: true,
          height: 260,
          title: {
            text: "Aprendices con fallas",
            fontSize: 14,
            fontWeight: "bold",
            horizontalAlign: "left"
          },
          data: [{
            type: "funnel",
            indexLabel: "{label}: {y}",
            indexLabelPlacement: "inside",
            indexLabelFontColor: "#ffffff",
            indexLabelFontSize: 11,
            toolTipContent: "<b>{label}</b>: {y} fallas",
            dataPoints: datosOrdenados
          }]
        });

        chartFallasReporte7.render();
      }

      // Clasificación de competencias por categoría

      const competenciasPracticaRaw = [
        "RESULTADOS DE APRENDIZAJE ETAPA PRACTICA"
      ];

      const competenciasInglesRaw = [
        "INTERACTUAR EN LENGUA INGLESA DE FORMA ORAL Y ESCRITA DENTRO DE CONTEXTOS SOCIALES Y LABORALES SEGÚN LOS CRITERIOS ESTABLECIDOS POR EL MARCO COMÚN EUROPEO DE REFERENCIA PARA LAS LENGUAS.",
        "COMPRENDER TEXTOS EN INGLÉS EN FORMA ESCRITA Y AUDITIVA",
        "PRODUCIR TEXTOS EN INGLÉS EN FORMA ESCRITA Y ORAL"
      ];

      const competenciasTransversalesRaw = [
        "APLICACIÓN DE CONOCIMIENTOS DE LAS CIENCIAS NATURALES DE ACUERDO CON SITUACIONES DEL CONTEXTO PRODUCTIVO Y SOCIAL.",
        "APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL, SEGURIDAD Y SALUD EN EL TRABAJO DE ACUERDO CON LAS POLÍTICAS ORGANIZACIONALES Y LA NORMATIVIDAD VIGENTE.",
        "DESARROLLAR PROCESOS DE COMUNICACIÓN EFICACES Y EFECTIVOS, TENIENDO EN CUENTA SITUACIONES DE ORDEN SOCIAL, PERSONAL Y PRODUCTIVO.",
        "Ejercer derechos fundamentales del trabajo en el marco de la constitución política y los convenios internacionales.",
        "Enrique Low Murtra-Interactuar en el contexto productivo y social de acuerdo con principios éticos para la construcción de una cultura de paz.",
        "Fomentar cultura emprendedora según habilidades y competencias personales",
        "GENERAR HÁBITOS SALUDABLES DE VIDA MEDIANTE LA APLICACIÓN DE PROGRAMAS DE ACTIVIDAD FÍSICA EN LOS CONTEXTOS PRODUCTIVOS Y SOCIALES.",
        "Gestionar procesos propios de la cultura emprendedora y empresarial de acuerdo con el perfil personal y los requerimientos de los contextos productivo y social.",
        "Orientar investigación formativa según referentes técnicos",
        "Razonar cuantitativamente frente a situaciones susceptibles de ser abordadas de manera matemática en contextos laborales, sociales y personales.",
        "Resultado de Aprendizaje de la Inducción.",
        "Utilizar herramientas informáticas de acuerdo con las necesidades de manejo de información",
        "PROMOVER LA INTERACCIÓN IDÓNEA CONSIGO MISMO, CON LOS DEMÁS Y CON LA NATURALEZA EN LOS CONTEXTOS LABORAL Y SOCIAL"
      ];

      // Arreglos normalizados para usar en getCategoria
      const categoriaPractica = competenciasPracticaRaw.map(normalizeCompetencia);
      const categoriaIngles = competenciasInglesRaw.map(normalizeCompetencia);
      const keywordsTransversales = competenciasTransversalesRaw.map(normalizeCompetencia);


      function getCategoria(competencia) {
        if (!competencia) return "Técnicas";
        const comp = normalizeCompetencia(competencia);
        if (categoriaPractica.some(k => comp.includes(k))) return "Práctica";
        if (categoriaIngles.some(k => comp.includes(k))) return "Inglés";
        if (keywordsTransversales.some(keyword => comp.includes(keyword))) return "Transversales";
        return "Técnicas";
      }

      function obtenerEtiquetaTipoCompetencia(competencia) {
        const cat = getCategoria(competencia);
        if (cat === "Transversales") return "Transversal";
        if (cat === "Técnicas") return "Técnica";
        return cat;
      }

      // ----------------------------------------------
      // Competencias para el reporte de Paz y Salvo
      // (solo Transversales, Inglés y Técnicas)
      // ----------------------------------------------
      function obtenerCompetenciasPazYSalvo() {
        const resultado = {
          transversales: [],
          ingles: [],
          tecnicas: []
        };

        const vistos = {
          transversales: new Set(),
          ingles: new Set(),
          tecnicas: new Set()
        };

        // Usamos los registros de juicios (tercer archivo)
        if (!Array.isArray(registrosJuicios) || !registrosJuicios.length) {
          return resultado;
        }

        registrosJuicios.forEach(reg => {
          const competencia = (reg.competencia || "").toString().trim();
          if (!competencia) return;

          // Solo competencias que hacen parte del programa
          if (typeof esCompetenciaProgramada === "function") {
            try {
              if (!esCompetenciaProgramada(competencia)) return;
            } catch (e) {
              // si falla, la dejamos pasar igual
            }
          }

          let categoria = "";
          if (typeof getCategoria === "function") {
            try {
              categoria = getCategoria(competencia);
            } catch (e) {
              categoria = "";
            }
          }

          // No queremos la competencia de etapa práctica como columna
          if (categoria === "Práctica" || !categoria) return;

          const clave = normalizeCompetencia(competencia);


          if (categoria === "Transversales") {
            if (!vistos.transversales.has(clave)) {
              vistos.transversales.add(clave);
              resultado.transversales.push(competencia);
            }
          } else if (categoria === "Inglés") {
            if (!vistos.ingles.has(clave)) {
              vistos.ingles.add(clave);
              resultado.ingles.push(competencia);
            }
          } else if (categoria === "Técnicas") {
            if (!vistos.tecnicas.has(clave)) {
              vistos.tecnicas.add(clave);
              resultado.tecnicas.push(competencia);
            }
          }
        });

        return resultado;
      }

      // ----------------------------------------------
      // Genera la ventana/imprimible del Paz y Salvo
      // ----------------------------------------------
      function generarPazYSalvoPDF(aprendicesSeleccionados) {
        if (!Array.isArray(aprendicesSeleccionados) || !aprendicesSeleccionados.length) {
          alert("No hay aprendices seleccionados para generar el paz y salvo.");
          return;
        }

        const competencias = obtenerCompetenciasPazYSalvo();
        const trans = competencias.transversales || [];
        const ingl = competencias.ingles || [];
        const tec = competencias.tecnicas || [];

        // Datos de encabezado tomados del DOM
        const getText = (id) => {
          const el = document.getElementById(id);
          return el ? (el.textContent || "").trim() : "";
        };

        const codigoFicha = getText("codigoFicha");
        const nombrePrograma = getText("nombrePrograma");
        const centroFormacion = getText("nombreCentro") || "Centro de Comercio y Servicios";
        const fechaIniLectiva = getText("fechaInicioLectiva");
        const fechaFinLectiva = getText("fechaFinLectiva");
        const fechaIniProduct = getText("fechaInicioProductiva");
        const fechaFinProduct = getText("fechaFinProductiva");
        const gerenteProyecto = getText("nombreGerentePrincipal");
        const rendimientoAcad = getText("rendimientoAcademicoResumen");

        const etapaLectivaTexto = `${fechaIniLectiva} – ${fechaFinLectiva}`;
        const etapaProductivaTexto = `${fechaIniProduct} – ${fechaFinProduct}`;

        const logoUrl = "https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png";

        const win = window.open("", "_blank");

        const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Paz y salvo ficha ${codigoFicha || ""}</title>
<style>
  @page {
    size: landscape;
    margin: 20mm;
  }
  body {
    font-family: Calibri, sans-serif;
    font-size: 8pt;
    margin: 0;
  }
  .encabezado {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .encabezado-izq {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .encabezado-izq img {
    width: 40px;
    height: auto;
  }
  .encabezado-texto {
    font-size: 11pt;
    font-weight: bold;
  }
  .encabezado-der {
    text-align: right;
    font-size: 10pt;
  }
  .sub-encabezado {
    margin-bottom: 6px;
    font-size: 10pt;
  }
  h2 {
    text-align: center;
    margin: 6px 0 8px 0;
    font-size: 11pt;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
  }
  th, td {
    border: 1px solid #000;
    padding: 12px 4px;
    text-align: center;
    vertical-align: middle;
  }
  th.col-firma,
  td.col-firma {
    width: 250px; /* ajusta este valor a lo que necesites */
  }

  th {
    background-color: #f0f0f0;
  }
  /* Ancho de las columnas de competencias */
  .col-competencia {
    width: 10px;   /* ajusta este valor según lo que necesites */
    writing-mode: vertical-rl; /* texto vertical */
    text-orientation: mixed;
    white-space: nowrap;
    padding: 6px 2px;
  }

  .grupo-trans {
    background-color: #ddebf7;
    min-width: 30px
  }
  .grupo-ingles {
    background-color: #e2efda;
    min-width: 30px
  }
  .grupo-tec {
    background-color: #fce4d6;
    min-width: 30px
  }
  .col-nombre {
    text-align: left;
    font-size: 9pt;
    min-width: 200px;
  }
  .col-documento {
    font-size: 9pt;
    min-width: 110px;
  }
  .firmas {
    margin-top: 30px;
    width: 100%;
    text-align: center;
    font-size: 10pt;
  }
  .firmas td {
    border: none;
    padding-top: 25px;
  }
  .firma-linea {
    border-top: 1px solid #000;
    margin-bottom: 4px;
  }
  .nota-oficial {
    margin-top: 8px;
    text-align: center;
    font-size: 9pt;
  }
</style>
</head>
<body>
  <div class="encabezado">
    <div class="encabezado-izq">
      <img src="${logoUrl}" alt="Logo SENA" />
      <div class="encabezado-texto">
        <div>SENA – SERVICIO NACIONAL DE APRENDIZAJE</div>
        <div>${centroFormacion}</div>
      </div>
    </div>
    <div class="encabezado-der">
      <div><strong>FICHA No.:</strong> ${codigoFicha}</div>
      <div><strong>PROGRAMA DE FORMACIÓN:</strong> ${nombrePrograma}</div>
    </div>
  </div>

  <div class="sub-encabezado">
    <strong>PERÍODOS:</strong>
    Etapa Lectiva: ${etapaLectivaTexto}
    &nbsp;&nbsp;
    Etapa Productiva: ${etapaProductivaTexto}
  </div>

  <div class="sub-encabezado">
    <strong>INSTRUCTOR/GERENTE:</strong> ${gerenteProyectoSeleccionado}
    &nbsp;&nbsp;
    <strong>Coordinador Academico:</strong> ${coordinadorAcademicoSeleccionado}
     ${rendimientoAcad}
  </div>

  <div class="nota-oficial">
    Documento oficial de seguimiento y evaluación del aprendiz.
  </div>

  <table>
    <thead>
      <tr>
        <th rowspan="2">#</th>
        <th rowspan="2" class="col-nombre">Nombre Completo del Aprendiz</th>
        <th rowspan="2" class="col-documento">Documento</th>
        ${trans.length ? `<th class="grupo-trans" colspan="${trans.length}">Transversales</th>` : ""}
        ${ingl.length ? `<th class="grupo-ingles" colspan="${ingl.length}">Inglés</th>` : ""}
        ${tec.length ? `<th class="grupo-tec" colspan="${tec.length}">Técnicas</th>` : ""}
                <th rowspan="2" class="col-firma">Firma</th>

      </tr>
            <tr>
        ${trans.map(c => `<th class="grupo-trans col-competencia">${c.length > 30 ? c.substring(0, 20) + "…" : c}</th>`).join("")}
        ${ingl.map(c => `<th class="grupo-ingles col-competencia">${c.length > 30 ? c.substring(0, 20) + "…" : c}</th>`).join("")}
        ${tec.map(c => `<th class="grupo-tec col-competencia">${c.length > 30 ? c.substring(0, 20) + "…" : c}</th>`).join("")}
      </tr>

    </thead>
    <tbody>
      ${aprendicesSeleccionados.map((a, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td class="col-nombre">${a.nombreCompleto || ""}</td>
          <td>${a.numDoc || ""}</td>
          ${trans.map(() => "<td>A</td>").join("")}
          ${ingl.map(() => "<td>A</td>").join("")}
          ${tec.map(() => "<td>A</td>").join("")}
          <td class="col-firma"></td>
        </tr>
      `).join("")}
    </tbody>
  </table>

  <table class="firmas">
    <tr>
      <td>
        <div class="firma-linea"></div>
        ${gerenteProyectoSeleccionado}<br/>
        Instructor Gerente de Proyecto
      </td>
      <td>
        <div class="firma-linea"></div>
        ${coordinadorAcademicoSeleccionado}<br/>
        Coordinador Académico
      </td>
    </tr>
  </table>

  <div class="nota-oficial">
    Documento generado para fines de control y seguimiento académico.
  </div>
</body>
</html>
`;

        win.document.open();
        win.document.write(html);
        win.document.close();
        win.focus();
        win.print(); // desde aquí el usuario puede guardar como PDF
      }

      function parseFecha(fechaString) {
        const partes = fechaString.split('/');
        const dia = parseInt(partes[0], 10);
        const mes = parseInt(partes[1], 10) - 1;
        const anio = parseInt(partes[2], 10);
        return new Date(anio, mes, dia);
      }

      function formatearFechaLarga(fecha) {
        const dia = fecha.getDate();
        const anio = fecha.getFullYear();
        const meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio",
          "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const mes = meses[fecha.getMonth()];
        return `${dia} de ${mes} de ${anio}`;
      }

      // Fin etapa lectiva = fin programa - 6 meses - 1 día
      function calcularFechaFinLectiva(fechaFinLectivaStr) {
        let fechaFinPrograma = parseFecha(fechaFinLectivaStr);
        fechaFinPrograma.setMonth(fechaFinPrograma.getMonth() - 6);
        fechaFinPrograma.setDate(fechaFinPrograma.getDate() - 1);
        return fechaFinPrograma;
      }

      // Inicio etapa productiva = fin programa - 6 meses
      function calcularFechaInicioProductiva(fechaFinLectivaStr) {
        let fechaFinPrograma = parseFecha(fechaFinLectivaStr);
        fechaFinPrograma.setMonth(fechaFinPrograma.getMonth() - 6);
        return fechaFinPrograma;
      }

      // Fin etapa productiva = fin programa (la fecha original)
      function calcularFechaFinProductiva(fechaFinLectivaStr) {
        return parseFecha(fechaFinLectivaStr);
      }

      function formatearFechaCorta(fecha) {
        if (!(fecha instanceof Date) || isNaN(fecha)) return "";
        return fecha
          .toLocaleDateString("es-CO", { day: "2-digit", month: "short", year: "numeric" })
          .replace(".", "");
      }

      function formatearFechaActa(fecha) {
        if (!(fecha instanceof Date) || isNaN(fecha)) return "";
        const dia = String(fecha.getDate()).padStart(2, "0");
        const mes = String(fecha.getMonth() + 1).padStart(2, "0");
        const anio = fecha.getFullYear();
        return `${dia}/${mes}/${anio}`;
      }

      function obtenerFechaActaDesdeCelda(td) {
        if (!td) return "";
        const sortValue = td.getAttribute("data-sort-value");
        if (sortValue) {
          const timestamp = Number(sortValue);
          if (!Number.isNaN(timestamp)) {
            return formatearFechaActa(new Date(timestamp));
          }
        }
        const texto = (td.textContent || "").trim();
        const fecha = parseFecha(texto);
        if (fecha && !isNaN(fecha.getTime())) {
          return formatearFechaActa(fecha);
        }
        return texto;
      }

      function formatearFechasTablaActa(tabla, columnas = []) {
        if (!tabla || !Array.isArray(columnas) || columnas.length === 0) return;
        const filas = Array.from(tabla.querySelectorAll("tbody tr"));
        filas.forEach(tr => {
          columnas.forEach(idx => {
            const td = tr.cells && tr.cells[idx];
            if (!td) return;
            const fecha = obtenerFechaActaDesdeCelda(td);
            if (fecha) td.textContent = fecha;
          });
        });
      }

      function normalizarFechaRegistro(valor) {
        if (!valor) return null;
        if (valor instanceof Date) {
          return isNaN(valor.getTime()) ? null : valor;
        }
        if (typeof valor === "number") {
          const fecha = new Date(valor);
          return isNaN(fecha.getTime()) ? null : fecha;
        }
        if (typeof valor === "string") {
          const texto = valor.trim();
          if (!texto) return null;
          if (texto.includes("/")) {
            const fecha = parseFecha(texto);
            return isNaN(fecha.getTime()) ? null : fecha;
          }
          const fecha = new Date(texto);
          return isNaN(fecha.getTime()) ? null : fecha;
        }
        return null;
      }

      function formatearTiempoRestante(desde, hasta) {
        const hoyBase = (desde instanceof Date && !isNaN(desde)) ? desde : new Date();
        if (!(hasta instanceof Date) || isNaN(hasta)) return "-";

        const inicio = new Date(hoyBase.getFullYear(), hoyBase.getMonth(), hoyBase.getDate());
        const fin = new Date(hasta.getFullYear(), hasta.getMonth(), hasta.getDate());

        if (inicio > fin) return "0 días";

        let years = fin.getFullYear() - inicio.getFullYear();
        let months = fin.getMonth() - inicio.getMonth();
        let days = fin.getDate() - inicio.getDate();

        if (days < 0) {
          months -= 1;
          const prevMonthDays = new Date(fin.getFullYear(), fin.getMonth(), 0).getDate();
          days += prevMonthDays;
        }
        if (months < 0) {
          years -= 1;
          months += 12;
        }

        const partes = [];
        if (years > 0) partes.push(`${years} año${years !== 1 ? "s" : ""}`);
        if (months > 0) partes.push(`${months} mes${months !== 1 ? "es" : ""}`);
        partes.push(`${days} día${days !== 1 ? "s" : ""}`);

        return partes.join(" ");
      }

            function obtenerColorSemaforoDias(diasValor) {
        if (!Number.isFinite(diasValor)) {
          return { clase: "", hex: "" };
        }
        if (diasValor >= 0) {
          return { clase: "verde", hex: "#1e8a37" };
        }
        const diasAtraso = Math.abs(diasValor);
        if (diasAtraso <= 30) {
          return { clase: "amarillo", hex: "#BB8E23" };
        }
        return { clase: "rojo", hex: "#b91c1c" };
      }

// Obtiene fecha fin y d�as restantes/pasados para una competencia
      function obtenerDatosFechaCompetencia(competenciaTexto) {
        const compKey = normalizeCompetencia(competenciaTexto || "");
        const info = mapaFechasFinPorComp[compKey];
        if (!compKey || !info) {
          return {
            fechaTexto: "-",
            fechaInicioTexto: "-",
            diasTexto: "-",
            diasHtml: "-",
            diasValor: null,
            diasColor: "",
            fechaInicio: null,
            fecha: null
          };
        }

        const fechaInicioTexto = info.inicioTexto || "-";
        const fechaInicio = (info.inicio instanceof Date && !isNaN(info.inicio)) ? info.inicio : null;
        const fecha = info.fecha;
        if (!(fecha instanceof Date) || isNaN(fecha)) {
          return {
            fechaTexto: info.texto || "-",
            fechaInicioTexto,
            diasTexto: "-",
            diasHtml: "-",
            diasValor: null,
            diasColor: "",
            fechaInicio,
            fecha: null
          };
        }

        const hoy = new Date();
        const hoyPlano = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
        const objetivo = new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
        const diffMs = objetivo.getTime() - hoyPlano.getTime();
        const diasValor = Math.round(diffMs / (1000 * 60 * 60 * 24));
        const diasNumero = Math.abs(diasValor);
        const fechaTexto = info.texto || formatearFechaCorta(fecha);
        const { clase: diasColor, hex: color } = obtenerColorSemaforoDias(diasValor);
        const diasHtml = (diasNumero || diasNumero === 0)
          ? `<span class="dias-color" data-color="${diasColor}" style="color:${color}; font-weight:600;">${diasNumero}</span>`
          : "-";

        return {
          fechaTexto: fechaTexto || "-",
          fechaInicioTexto,
          fechaInicio,
          diasTexto: (diasNumero || diasNumero === 0) ? diasNumero.toString() : "-",
          diasHtml,
          diasValor,
          diasColor,
          fecha
        };
      }

      function formatearMesCompleto(fecha) {
        if (!(fecha instanceof Date) || isNaN(fecha.getTime())) return "";
        const mesesNombres = [
          "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
          "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];
        return `${mesesNombres[fecha.getMonth()]} ${fecha.getFullYear()}`;
      }

      function obtenerMesesFormacion() {
        if (!Array.isArray(registrosGlobal) || registrosGlobal.length === 0) {
          return [];
        }
        let inicio = null;
        let fin = null;
        registrosGlobal.forEach(reg => {
          const fechaInicio = normalizarFechaRegistro(reg.fechaInicioProg);
          const fechaFin = normalizarFechaRegistro(reg.fechaFinProg);
          if (fechaInicio && (!inicio || fechaInicio < inicio)) {
            inicio = fechaInicio;
          }
          if (fechaFin && (!fin || fechaFin > fin)) {
            fin = fechaFin;
          }
        });
        if (!inicio || !fin) return [];
        const meses = [];
        const limite = new Date(fin.getFullYear(), fin.getMonth(), 1);
        for (let cursor = new Date(inicio.getFullYear(), inicio.getMonth(), 1); cursor <= limite; cursor.setMonth(cursor.getMonth() + 1)) {
          meses.push(new Date(cursor.getFullYear(), cursor.getMonth(), 1));
        }
        return meses;
      }

      function obtenerRangoMes(valorMes) {
        if (!valorMes || valorMes === "ALL") return null;
        const partes = valorMes.split("-");
        if (partes.length !== 2) return null;
        const anio = Number(partes[0]);
        const mes = Number(partes[1]) - 1;
        if (!Number.isFinite(anio) || isNaN(mes)) return null;
        const inicio = new Date(anio, mes, 1);
        const fin = new Date(anio, mes + 1, 0, 23, 59, 59, 999);
        return { inicio, fin };
      }

      function solapaMes(inicio, fin, rango) {
        if (!inicio || !fin || !rango) return false;
        return inicio <= rango.fin && fin >= rango.inicio;
      }

      function ocultarValorCampoMes(celda) {
        if (!celda) return;
        const textoActual = (celda.textContent || "").trim();
        if (textoActual) {
          celda.dataset.valorOriginalMes = textoActual;
        }
        celda.textContent = "";
      }

      function restaurarValorCampoMes(celda) {
        if (!celda) return;
        if (celda.dataset.valorOriginalMes !== undefined) {
          celda.textContent = celda.dataset.valorOriginalMes;
        }
      }

      function aplicarFiltroMesTabla(tbodyId, valorMes, columnasOcultar = []) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        let mostrarTodos = !valorMes || valorMes === "ALL";
        const rango = mostrarTodos ? null : obtenerRangoMes(valorMes);
        if (!rango && !mostrarTodos) {
          mostrarTodos = true;
        }
        const filas = Array.from(tbody.rows);
        filas.forEach(tr => {
          if (!tr || tr.cells.length === 0) return;
          const inicio = tr.dataset.fechaInicio ? new Date(tr.dataset.fechaInicio) : null;
          const fin = tr.dataset.fechaFin ? new Date(tr.dataset.fechaFin) : null;
          const visible = mostrarTodos ? true : solapaMes(inicio, fin, rango);
          tr.style.display = visible ? "" : "none";
          columnasOcultar.forEach(idx => {
            const celda = tr.cells[idx];
            if (!celda) return;
            if (mostrarTodos) {
              restaurarValorCampoMes(celda);
            } else {
              ocultarValorCampoMes(celda);
            }
          });
        });
        renumerarFilasTabla(tbody);
        actualizarTotalHorasReporte3();
      }

      function poblarSelectMeses(selectId, filtroActual) {
        const select = document.getElementById(selectId);
        if (!select) return filtroActual;
        const previo = select.value || filtroActual;
        select.innerHTML = "";
        const optionAll = document.createElement("option");
        optionAll.value = "ALL";
        optionAll.textContent = "Periodo completo";
        select.appendChild(optionAll);
        mesesFormacionDisponibles.forEach(mes => {
          const option = document.createElement("option");
          option.value = `${mes.getFullYear()}-${String(mes.getMonth() + 1).padStart(2, "0")}`;
          option.textContent = formatearMesCompleto(mes);
          select.appendChild(option);
        });
        const tienePrevio = Array.from(select.options).some(opt => opt.value === previo);
        select.value = tienePrevio ? previo : "ALL";
        return select.value;
      }

      function actualizarMesesFormacion() {
        mesesFormacionDisponibles = obtenerMesesFormacion();
        filtroMesReporte2 = poblarSelectMeses("mesSelectReporte2", filtroMesReporte2);
        filtroMesReporte3 = poblarSelectMeses("mesSelectReporte3", filtroMesReporte3);
        aplicarFiltrosReporte2();
        setTimeout(actualizarTotalesReporte2, 0);
        aplicarFiltrosReporte3();
      }

      function renderLineaTiempoFicha() {
        const timelines = [];

        const mini = {
          track: document.getElementById("timelineTrackMini"),
          fill: document.getElementById("timelineFillMini"),
          puntos: {
            inicioLectiva: document.getElementById("pMiniInicioLectiva"),
            finLectiva: document.getElementById("pMiniFinLectiva"),
            inicioProd: document.getElementById("pMiniInicioProd"),
            finProd: document.getElementById("pMiniFinProd"),
            hoy: document.getElementById("pMiniHoy"),
          },
          labels: {
            inicioLectiva: document.getElementById("dMiniInicioLectiva"),
            finLectiva: document.getElementById("dMiniFinLectiva"),
            inicioProd: document.getElementById("dMiniInicioProd"),
            finProd: document.getElementById("dMiniFinProd"),
            hoy: document.getElementById("dMiniHoy"),
          },
          estado: document.getElementById("estadoEtapaMini"),
        };

        if (mini.track) timelines.push(mini);
        if (!timelines.length) return;

        const fechas = {
          inicioLectiva: fechaInicioLectivaGlobal,
          finLectiva: fechaFinLectivaGlobal,
          inicioProd: fechaInicioProductivaGlobal,
          finProd: fechaFinProductivaGlobal,
        };

        const faltaFecha =
          !fechas.inicioLectiva || !fechas.finLectiva || !fechas.inicioProd || !fechas.finProd;

        const hoy = new Date();
        const hoyPlano = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
        const tiempoLectivaEl = document.getElementById("tiempoRestanteLectiva");
        const tiempoProductivaEl = document.getElementById("tiempoRestanteProductiva");

        const inicioRango =
          fechas.inicioLectiva instanceof Date && !isNaN(fechas.inicioLectiva)
            ? fechas.inicioLectiva.getTime()
            : NaN;
        const finRango =
          fechas.finProd instanceof Date && !isNaN(fechas.finProd)
            ? fechas.finProd.getTime()
            : NaN;

        if (isNaN(inicioRango) || isNaN(finRango) || finRango <= inicioRango || faltaFecha) {
          timelines.forEach((t) => {
            if (t.estado) t.estado.textContent = "-";
          });
          if (tiempoLectivaEl) tiempoLectivaEl.textContent = "-";
          if (tiempoProductivaEl) tiempoProductivaEl.textContent = "-";
          return;
        }

        const rango = finRango - inicioRango;
        const clamp = (val) => Math.min(100, Math.max(0, val));
        const posicion = (fecha) => clamp(((fecha.getTime() - inicioRango) / rango) * 100);

        const estadoTexto = (() => {
          const hoyMs = hoyPlano.getTime();
          if (hoyMs < inicioRango) return "Sin iniciar";
          if (fechas.finLectiva && hoyMs <= fechas.finLectiva.getTime()) return "Etapa lectiva en progreso";
          if (fechas.inicioProd && hoyMs < fechas.inicioProd.getTime()) return "Transicion";
          if (fechas.finProd && hoyMs <= fechas.finProd.getTime()) return "Etapa productiva en progreso";
          return "Programa finalizado";
        })();

        const setTiempoRestante = (el, fechaObjetivo, sufijo = "") => {
          if (!el) return;
          const base = formatearTiempoRestante(hoyPlano, fechaObjetivo);
          if (base === "-" || !base) {
            el.textContent = "-";
            return;
          }
          el.textContent = sufijo ? `${base} ${sufijo}` : base;
        };

        const lectivaCard = document.querySelector(".stage-card.lectiva");
        const productivaCard = document.querySelector(".stage-card.productiva");
        const lectivaStatusEl = lectivaCard ? lectivaCard.querySelector(".stage-status") : null;
        const productivaStatusEl = productivaCard ? productivaCard.querySelector(".stage-status") : null;

        const progreso = (inicio, fin, hoy) => {
          if (!(inicio instanceof Date) || isNaN(inicio) || !(fin instanceof Date) || isNaN(fin)) return 0;
          const total = fin.getTime() - inicio.getTime();
          if (total <= 0) return 0;
          return clamp(((hoy.getTime() - inicio.getTime()) / total) * 100);
        };

        // Lectiva: si aún no inicia, mostrar cuenta regresiva al inicio; si está en curso, al fin.
        if (fechas.inicioLectiva instanceof Date && !isNaN(fechas.inicioLectiva) &&
            fechas.finLectiva instanceof Date && !isNaN(fechas.finLectiva)) {

          const hoyMs = hoyPlano.getTime();
          const iL = fechas.inicioLectiva.getTime();
          const fL = fechas.finLectiva.getTime();

          if (hoyMs < iL) {
            if (lectivaStatusEl) {
              lectivaStatusEl.textContent = "Sin iniciar";
              lectivaStatusEl.classList.remove("on");
            }
            setTiempoRestante(tiempoLectivaEl, fechas.inicioLectiva, "para iniciar");
          } else if (hoyMs <= fL) {
            if (lectivaStatusEl) {
              lectivaStatusEl.textContent = "En Curso";
              lectivaStatusEl.classList.add("on");
            }
            setTiempoRestante(tiempoLectivaEl, fechas.finLectiva);
          } else {
            if (lectivaStatusEl) {
              lectivaStatusEl.textContent = "Finalizada";
              lectivaStatusEl.classList.remove("on");
            }
            if (tiempoLectivaEl) tiempoLectivaEl.textContent = "0 días";
          }

          if (lectivaCard) {
            const pL = progreso(fechas.inicioLectiva, fechas.finLectiva, hoyPlano);
            lectivaCard.style.setProperty("--progress", `${pL}%`);
            const barL = lectivaCard.querySelector(".stage-progress-bar");
            if (barL) barL.setAttribute("aria-valuenow", String(Math.round(pL)));
          }
        }

        // Productiva: si está pendiente, mostrar cuenta regresiva al inicio; si está en curso, al fin.
        if (fechas.inicioProd instanceof Date && !isNaN(fechas.inicioProd) &&
            fechas.finProd instanceof Date && !isNaN(fechas.finProd)) {

          const hoyMs = hoyPlano.getTime();
          const iP = fechas.inicioProd.getTime();
          const fP = fechas.finProd.getTime();

          if (hoyMs < iP) {
            if (productivaStatusEl) {
              productivaStatusEl.textContent = "Pendiente";
              productivaStatusEl.classList.remove("on");
            }
            setTiempoRestante(tiempoProductivaEl, fechas.inicioProd, "para iniciar");
          } else if (hoyMs <= fP) {
            if (productivaStatusEl) {
              productivaStatusEl.textContent = "En Curso";
              productivaStatusEl.classList.add("on");
            }
            setTiempoRestante(tiempoProductivaEl, fechas.finProd);
          } else {
            if (productivaStatusEl) {
              productivaStatusEl.textContent = "Finalizada";
              productivaStatusEl.classList.remove("on");
            }
            if (tiempoProductivaEl) tiempoProductivaEl.textContent = "0 días";
          }

          if (productivaCard) {
            const pP = progreso(fechas.inicioProd, fechas.finProd, hoyPlano);
            productivaCard.style.setProperty("--progress", `${pP}%`);
            const barP = productivaCard.querySelector(".stage-progress-bar");
            if (barP) barP.setAttribute("aria-valuenow", String(Math.round(pP)));
          }
        }
timelines.forEach((t) => {
          if (t.estado) t.estado.textContent = estadoTexto;

          const aplicarPunto = (clave, fecha) => {
            const punto = t.puntos[clave];
            const label = t.labels[clave];
            if (!punto || !(fecha instanceof Date) || isNaN(fecha)) return;

            const pos = posicion(fecha);
            punto.style.left = `${pos}%`;
            punto.classList.remove("past", "future", "today");

            if (clave === "hoy") {
              punto.classList.add("today");
            } else if (fecha.getTime() <= hoyPlano.getTime()) {
              punto.classList.add("past");
            } else {
              punto.classList.add("future");
            }

            if (label) label.textContent = formatearFechaCorta(fecha);
          };

          aplicarPunto("inicioLectiva", fechas.inicioLectiva);
          aplicarPunto("finLectiva", fechas.finLectiva);
          aplicarPunto("inicioProd", fechas.inicioProd);
          aplicarPunto("finProd", fechas.finProd);
          aplicarPunto("hoy", hoyPlano);

          const posHoy = posicion(hoyPlano);
          if (t.puntos.hoy) {
            t.puntos.hoy.style.left = `${posHoy}%`;
          }
          if (t.fill) {
            t.fill.style.width = `${posHoy}%`;
          }
        });
      }


      // Normaliza un documento/identificación dejando solo dígitos
      function normalizarDocumento(valor) {
        if (valor === undefined || valor === null) return "";
        return String(valor).replace(/\D/g, "");
      }

      // Color por estado (para tabla y gráfica)
      function getColorEstado(estado) {
        const e = (estado || "").toUpperCase().trim();

        if (e === "EN FORMACION" || e === "EN FORMACIÓN") {
          return "#166534"; // verde oscuro
        }
        if (e === "CONDICIONADO") {
          return "#eab308"; // amarillo
        }
        if (e === "CANCELADO" || e === "CANCELADOS") {
          return "#6b7280"; // gris
        }
        if (e === "RETIRO VOLUNTARIO") {
          return "#b91c1c"; // rojo oscuro
        }
        // Otros estados: azul
        return "#2563eb";
      }


      // =========================
      // Variables globales
      // =========================
      let codigoFichaPrimero = "";
      // NUEVO: Variable para guardar el nivel de formación
      let nivelFormacionGlobal = "";
      // NUEVO: mapa de horas diseño del archivo 3 (para validar competencias en actas)
      let horasDisenoMapGlobal = {};
      let competenciasDisenoNormSetGlobal = new Set();
      let codigoProgramaGlobal = "";
      let totalCompetenciasPrograma = 0; // total de competencias del programa (archivo 3)
      let modalidadFormacionGlobal = "";   // NUEVO: Modalidad de Formación desde C10
      let competenciasMap = {};
      let competenciasSet = new Set();
      let competenciasSetNormalizado = new Set();
      function normalizeTexto(texto) {
        return (texto || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase()
          .trim()
          .replace(/\s+/g, " ");
      }


      let registrosGlobal = [];
      let registrosJuicios = [];
      let gruposProgramadas = {};
      let gruposPendientes = {};
      let chartHorasInstructores = null;   // Gráfico de horas por instructor
      let chartCompetenciasHoras = null;   // Gráfico 100% Total vs Diseño
      let chartFallasReporte7 = null;      // Gráfico de fallas por aprendiz (reporte 7)
      let estadoChart = null;              // Gráfico Distribución de Estados
      let mesesFormacionDisponibles = [];
      let filtroMesReporte2 = "ALL";
      let filtroMesReporte3 = "ALL";


      // Gerente de Proyecto / Instructor con más horas
      // Variables para Gerente de Proyecto / Instructor con más horas cargadas
      let gerenteProyectoSeleccionado = "";
      let instructorMasHorasGlobal = "";
      let listaInstructoresGlobal = [];
      // Aprendiz vocero del grupo
      let aprendizVoceroSeleccionado = "";
      let pazSalvoMap = {};
      let aprendicesListosProductivaParaExportar = [];
      let aprendicesPorEvaluarMayor1ParaExportar = [];
      let aprendicesNovedadesProductivaParaExportar = [];
      // Total de RAPs cargados (para validaciones como Paz y Salvo)
  let totalRapsGlobal = 0;
  let totalRapsPendientesVistoGlobal = 0;

      // Datos usados para el resumen de la ficha
      let datosGeneralFicha = [];   // Información general de aprendices (estado)
      let datosHorario = [];   // Programación de instructores (horas, competencias)



      // Mapa: documento del aprendiz (solo dígitos) -> número de fallas (inasistencias)
      let mapaFallasPorDocumento = {};

      // Mapa: competencia normalizada -> fecha de terminaci¢n programada
      let mapaFechasFinPorComp = {};

      // Filtro por color de d�as (verde/rojo) por tabla
      const filtroColorTabla = {
        tablaProgramadas: { verde: false, rojo: false, pendiente: false },
          tablaReporte1: { verde: false, rojo: false },
        tablaReporte6: { verde: false, rojo: false, pendiente: false, "no-aprobado": false },
        tablaPendientesInstructorReporte8: { verde: false, rojo: false },
        tablaInstructoresHoras: { verde: false, rojo: false },
        tablaReporte2: { verde: false, rojo: false, pendiente: false },
        tablaReporte4: { verde: false, rojo: false, pendiente: false },
        tablaReporte8Visible: { verde: false, rojo: false }
      };

      function obtenerColoresActivos(tableId) {
        const estado = filtroColorTabla[tableId];
        if (!estado) return [];
        return Object.entries(estado)
          .filter(([, activo]) => !!activo)
          .map(([color]) => color.toLowerCase());
      }

      // Variables globales para fechas
      let fechaInicioLectivaGlobal = null;
      let fechaFinLectivaGlobal = null;
      let fechaInicioProductivaGlobal = null;
      let fechaFinProductivaGlobal = null;


      // =========================
      // Procesar Primer Archivo (Instructores)
      // =========================
      document.getElementById('btnProcesar1').addEventListener('click', function () {
        const file = document.getElementById('excelFile1').files[0];
        const mensaje1 = document.getElementById('mensajeArchivo1');

        if (botonArchivo2) {
          botonArchivo2.disabled = true;
        }

        if (!file) {
          alert("Por favor, selecciona un Archivo de Instructores.");
          return;
        }

        const reader = new FileReader();

        // Inicio: 0 %
        if (mensaje1) {
          mensaje1.textContent = "Cargando archivo 1... 0%";
        }

        // Progreso de lectura
        reader.onprogress = function (e) {
          if (!mensaje1) return;

          if (e.lengthComputable) {
            const porcentaje = Math.round((e.loaded / e.total) * 100);
            mensaje1.textContent = `Cargando archivo 1... ${porcentaje}%`;
          } else {
            // Si el navegador no reporta tamaño total
            mensaje1.textContent = "Cargando archivo 1...";
          }
        };

        // Lectura finalizada
        reader.onload = function (event) {
          const data = new Uint8Array(event.target.result);

          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[sheetName];
          if (!validarEstructuraArchivoInstructores(ws)) {
            if (mensaje1) {
              mensaje1.style.display = "flex";
              mensaje1.textContent = "No es el archivo solicitado; favor subir el Archivo de Instructores.";
            }
            if (sectionArchivo2) {
              sectionArchivo2.style.display = "none";
            }
            if (botonArchivo2) {
              botonArchivo2.disabled = true;
            }
            return;
          }
          const cantidad1 = procesarPrimerArchivo(ws);

          if (mensaje1) {
            mensaje1.textContent = `Archivo 1: ${cantidad1} registros cargados (100%)`;
          }

          // Mostrar SOLO el paso 2 (como flex para respetar el layout)
          if (sectionArchivo2) {
            sectionArchivo2.style.display = "flex";
          }
          if (botonArchivo2) {
            botonArchivo2.disabled = false;
          }
          // NO mostramos aún headerInfo ni reportes
        };

        reader.readAsArrayBuffer(file);
      });


      // =========================
      // Procesar Segundo Archivo (Juicios Evaluativos)
      // =========================
      document.getElementById('btnProcesar2').addEventListener('click', function () {
        const file = document.getElementById('excelFile2').files[0];
        const mensaje2 = document.getElementById('mensajeArchivo2');

        if (!file) {
          alert("Por favor, selecciona un Archivo de Juicios Evaluativos.");
          return;
        }

        const reader = new FileReader();

        // Inicio: 0 %
        if (mensaje2) {
          mensaje2.textContent = "Cargando archivo 2... 0%";
        }

        // Progreso de lectura
        reader.onprogress = function (e) {
          if (!mensaje2) return;

          if (e.lengthComputable) {
            const porcentaje = Math.round((e.loaded / e.total) * 100);
            mensaje2.textContent = `Cargando archivo 2... ${porcentaje}%`;
          } else {
            mensaje2.textContent = "Cargando archivo 2...";
          }
        };

        // Lectura finalizada
        reader.onload = function (event) {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[sheetName];
          if (!validarEstructuraArchivoJuicios(ws)) {
            if (mensaje2) {
              mensaje2.style.display = "flex";
              mensaje2.textContent = "No es el archivo solicitado; favor subir el Archivo de Juicios Evaluativos.";
            }
            if (sectionArchivo3) {
              sectionArchivo3.style.display = "none";
            }
            if (botonArchivo3) {
              botonArchivo3.disabled = true;
            }
            return;
          }
          const cantidad2 = procesarSegundoArchivo(ws);

          actualizarResumenFicha();


          if (typeof cantidad2 === "number") {
            if (mensaje2) {
              mensaje2.textContent = `Archivo 2: ${cantidad2} registros cargados (100%)`;
            }
            // Mostrar paso 3 (como flex)
            if (sectionArchivo3) {
              sectionArchivo3.style.display = "flex";
            }
            if (botonArchivo3) {
              botonArchivo3.disabled = false;
            }
          }
          // Si procesarSegundoArchivo devuelve error (no número),
          // tu lógica actual de error puede seguir igual (alert, etc.)
        };

        reader.readAsArrayBuffer(file);
      });

      // =========================
      // Procesar Tercer Archivo (Horas Diseño)
      // =========================
      document.getElementById('btnCargarDiseno').addEventListener('click', function () {
        const file = document.getElementById('archivoDiseno').files[0];
        const mensaje3 = document.getElementById('mensajeArchivo3');

        if (!file) {
          alert("Por favor, selecciona un archivo de diseño con horas.");
          return;
        }

        const reader = new FileReader();

        // Inicio: 0 %
        if (mensaje3) {
          mensaje3.textContent = "Cargando archivo 3... 0%";
        }

        // Progreso de lectura
        reader.onprogress = function (e) {
          if (!mensaje3) return;

          if (e.lengthComputable) {
            const porcentaje = Math.round((e.loaded / e.total) * 100);
            mensaje3.textContent = `Cargando archivo 3... ${porcentaje}%`;
          } else {
            mensaje3.textContent = "Cargando archivo 3...";
          }
        };

        reader.onload = function (event) {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const ws = workbook.Sheets[sheetName];

          // 1. Procesar el diseño (Archivo 3)
          const cantidad3 = procesarTercerArchivo(ws);
          actualizarResumenFicha();
          if (validarRolesActivos) {
            mostrarModalGerenteProyecto();
          } else {
            actualizarGerenteEnHeader("-");
            actualizarAprendizVoceroHeader("-");
          }



          // 2. Mostrar Información General y reportes
          const headerInfo = document.getElementById("headerInfo");
          const reportes = document.getElementById("reportes");
          const exportSection = document.getElementById("export-section");

          if (headerInfo) headerInfo.style.display = "block";
          if (reportes) reportes.style.display = "block";
          if (exportSection) exportSection.style.display = "block";

          // Actualizar Coordinador Académico en el encabezado (si se seleccionó)
          const coordHeader = document.getElementById("coordinadorAcademicoHeader");
          if (coordHeader && coordinadorAcademicoSeleccionado) {
            coordHeader.textContent = coordinadorAcademicoSeleccionado;
          }


          // 3. Mensaje de confirmación del Archivo 3
          if (mensaje3) {
            mensaje3.textContent = `Archivo 3: ${cantidad3} registros cargados (100%)`;
          }

          // 4. Redibujar la gráfica de Estados ya con el contenedor visible
          if (estadoChart) {
            setTimeout(function () {
              estadoChart.render();
            }, 100);
          }
        };
        // 5. Contraer el acordeón de "Cargue de Archivos" al finalizar el último archivo
        const accordionBody = document.getElementById("accordionCargueBody");
        const accordionIcon = document.getElementById("accordionCargueIcon");
        if (accordionBody) {
          accordionBody.style.display = "none";
        }
        if (accordionIcon) {
          accordionIcon.textContent = "▸";
        }
        reader.readAsArrayBuffer(file);
      });
      // Permite explotar/contraer una porción del pie al hacer clic en la leyenda
      function explodePieEstado(e) {
        const dp = e.dataSeries.dataPoints[e.dataPointIndex];

        if (typeof dp.exploded === "undefined" || !dp.exploded) {
          dp.exploded = true;
        } else {
          dp.exploded = false;
        }

        e.chart.render();
      }


      // =========================
      // Procesar archivo de inasistencias (Fallas)
      // A2:B2 -> FICHA (combinado)
      // C2    -> INSTRUCTOR
      // D2    -> IDENTIFICACIÓN APRENDIZ
      // E2    -> APRENDIZ
      // F2    -> FECHA INICIO
      // G2    -> FECHA FIN
      // H2    -> CANT. HORAS
      // I2    -> JUSTIFICACION


      // =========================
      // Datos desde fila 3
      // =========================
      function procesarArchivoFallas(ws) {
        // mapa de documento -> número de fallas
        mapaFallasPorDocumento = {};
        // mapa de documento -> arreglo de fechas de inasistencia
        mapaFechasFallasPorDocumento = {};
        if (!ws) return 0;

        // Ficha del archivo 1 (solo dígitos)
        const fichaGlobal = normalizarDocumento(codigoFichaPrimero);

        let fila = 3;
        let totalRegistrosFicha = 0;
        let fichaActual = "";

        while (true) {
          // FICHA está en A:B combinadas; el valor real queda en A (y, por seguridad, miramos también B)
          const celdaFichaA = ws["A" + fila];
          const celdaFichaB = ws["B" + fila];

          // Identificación del aprendiz está en D
          const celdaIdent = ws["D" + fila];
          // Fecha de la falla está en F
          const celdaFecha = ws["F" + fila];

          // Si no hay ficha (ni en A ni en B) NI identificación, asumimos fin de datos
          if (!celdaFichaA && !celdaFichaB && !celdaIdent) {
            break;
          }

          // Texto completo de la ficha, por ejemplo: "2824796 - GESTION CONTABLE."
          let valorFichaBruto = "";
          if (celdaFichaA && celdaFichaA.v !== undefined && celdaFichaA.v !== null && celdaFichaA.v !== "") {
            valorFichaBruto = celdaFichaA.v;
          } else if (celdaFichaB && celdaFichaB.v !== undefined && celdaFichaB.v !== null && celdaFichaB.v !== "") {
            valorFichaBruto = celdaFichaB.v;
          }

          // Extraer solo el número de ficha (antes del guion)
          if (valorFichaBruto !== "") {
            const textoFicha = String(valorFichaBruto);
            const partes = textoFicha.split("-");    // "2824796 " | " GESTION CONTABLE."
            const soloFicha = partes[0];                // "2824796 "
            fichaActual = normalizarDocumento(soloFicha);  // "2824796"
          }

          // Si tenemos ficha del archivo 1, filtramos solo esas filas
          if (fichaGlobal && fichaActual && fichaActual !== fichaGlobal) {
            fila++;
            continue;
          }

          // Identificación del aprendiz, ej: "CC - 1110586616"
          const valorIdent = celdaIdent ? celdaIdent.v : "";
          const docNormalizado = normalizarDocumento(valorIdent); // "1110586616"

          // Fecha de la falla (columna F)
          let textoFecha = "";
          if (celdaFecha) {
            const valorCrudo = celdaFecha.w || celdaFecha.v;
            if (valorCrudo !== undefined && valorCrudo !== null && valorCrudo !== "") {
              textoFecha = String(valorCrudo).trim();
            }
          }

          if (docNormalizado) {
            if (!mapaFallasPorDocumento[docNormalizado]) {
              mapaFallasPorDocumento[docNormalizado] = 0;
              mapaFechasFallasPorDocumento[docNormalizado] = [];
            }
            // Suma una falla
            mapaFallasPorDocumento[docNormalizado]++;

            // Guarda la fecha en el arreglo de detalles (si viene algo)
            if (textoFecha) {
              mapaFechasFallasPorDocumento[docNormalizado].push(textoFecha);
            }

            totalRegistrosFicha++;
          }

          fila++;
        }

        return totalRegistrosFicha;
      }


      // =========================
      // Procesar Archivo de Fallas (Consolidado de Inasistencias)
      // =========================
      const btnProcesarFallas = document.getElementById('btnProcesarFallas');
      if (btnProcesarFallas) {
        btnProcesarFallas.addEventListener('click', function () {
          const file = document.getElementById('excelFallas').files[0];
          if (!file) {
            alert("Por favor, selecciona el archivo de consolidado de inasistencias.");
            return;
          }

          const reader = new FileReader();
          reader.onload = function (event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const ws = workbook.Sheets[sheetName];

            const totalFallas = procesarArchivoFallas(ws);

            const mensajeFallas = document.getElementById("mensajeFallas");
            if (mensajeFallas) {
              mensajeFallas.style.display = "flex";
              mensajeFallas.textContent = `Archivo de inasistencias cargado. Registros de fallas para la ficha: ${totalFallas}`;
            }

            // Regenerar el reporte de % Avance por Aprendiz ya con la columna Fallas
            generarPivotTableAvancePorAprendiz();
          };
          reader.readAsArrayBuffer(file);
        });
      }

      // =========================
      // Validación del Archivo 1
      // =========================
      function normalizarEncabezadoArchivo(texto) {
        return (texto || "")
          .toString()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/\s+/g, " ")
          .toUpperCase();
      }

      function normalizarFicha(texto) {
        if (texto === undefined || texto === null) return "";
        return texto.toString().trim();
      }

      function validarEstructuraArchivoInstructores(ws) {
        if (!ws) return false;

        const filaEncabezado = 11;
        const columnas = [
          { col: "A", label: "Nombre Instructor" },
          { col: "B", label: "Apellido Instructor" },
          { col: "C", label: "Estado Instructor" },
          { col: "D", label: "Competencia" },
          { col: "E", label: "Fecha Inicio Programación" },
          { col: "F", label: "Fecha Fin Programación" },
          { col: "G", label: "Horas Programadas" }
        ];

        return columnas.every(({ col, label }) => {
          const celda = ws[col + filaEncabezado];
          const valor = celda && celda.v ? normalizarEncabezadoArchivo(celda.v) : "";
          const esperado = normalizarEncabezadoArchivo(label);
          return valor === esperado;
        });
      }

      function validarEstructuraArchivoJuicios(ws) {
        if (!ws) return false;

        const filaEncabezado = 13;
        const etiquetasEsperadas = [
          "Tipo de Documento",
          "Número de Documento",
          "Nombre",
          "Apellidos",
          "Estado",
          "Competencia",
          "Resultado de Aprendizaje",
          "Juicio de Evaluación",
          "Fecha y Hora del Juicio Evaluativo",
          "Funcionario que registro el juicio evaluativo"
        ].map(normalizarEncabezadoArchivo);

        const encabezadosEncontrados = [];
        for (let code = 65; code <= 90; code++) {
          const celda = ws[String.fromCharCode(code) + filaEncabezado];
          if (!celda) continue;
          const valor = celda.w || celda.v;
          if (valor === undefined || valor === null) continue;
          encabezadosEncontrados.push(normalizarEncabezadoArchivo(valor));
        }

        return etiquetasEsperadas.every(esperado =>
          encabezadosEncontrados.includes(esperado)
        );
      }

      // =========================
      // Procesar Primer Archivo (Instructores)
      // =========================
      function procesarPrimerArchivo(ws) {
        const nombrePrograma = (ws["B3"] && ws["B3"].v) || "";
        const codigoFicha = normalizarFicha((ws["B2"] && ws["B2"].v) || "");
        const fechaInicioLectivaStr = (ws["D2"] && ws["D2"].v) || "";
        const fechaFinLectivaStr = (ws["F2"] && ws["F2"].v) || "";
        const municipioTexto = (ws["B5"] && ws["B5"].v) || "";
        municipioFicha = municipioTexto.toString().trim();
        const municipioElemento = document.getElementById("municipioFicha");
        if (municipioElemento) {
          municipioElemento.textContent = municipioFicha || "-";
        }

        // >>> NUEVO: guardar la ficha del archivo 1
        codigoFichaPrimero = codigoFicha;

        document.getElementById("nombrePrograma").textContent = nombrePrograma;
        document.getElementById("codigoFicha").textContent = codigoFicha;

        if (fechaInicioLectivaStr) {
          const fInicio = parseFecha(fechaInicioLectivaStr);
          document.getElementById("fechaInicioLectiva").textContent = formatearFechaLarga(fInicio);
          fechaInicioLectivaGlobal = fInicio;
        } else {
          document.getElementById("fechaInicioLectiva").textContent = "";
          fechaInicioLectivaGlobal = null;
        }

        if (fechaFinLectivaStr) {
          // Fin lectiva calculado a partir de la fecha fin global del programa
          const fFinLectiva = calcularFechaFinLectiva(fechaFinLectivaStr);
          document.getElementById("fechaFinLectiva").textContent = formatearFechaLarga(fFinLectiva);
          fechaFinLectivaGlobal = fFinLectiva;
        } else {
          document.getElementById("fechaFinLectiva").textContent = "";
          fechaFinLectivaGlobal = null;
        }

        codigoFichaPrimero = codigoFicha;

        if (fechaFinLectivaStr) {
          const fechaInicioProd = calcularFechaInicioProductiva(fechaFinLectivaStr);
          const fechaFinProd = calcularFechaFinProductiva(fechaFinLectivaStr);
          document.getElementById("fechaInicioProductiva").textContent = formatearFechaLarga(fechaInicioProd);
          document.getElementById("fechaFinProductiva").textContent = formatearFechaLarga(fechaFinProd);
          // Guardar globalmente
          fechaInicioProductivaGlobal = fechaInicioProd;
          fechaFinProductivaGlobal = fechaFinProd;
        } else {
          document.getElementById("fechaInicioProductiva").textContent = "";
          document.getElementById("fechaFinProductiva").textContent = "";
          fechaInicioProductivaGlobal = null;
          fechaFinProductivaGlobal = null;
        }

        renderLineaTiempoFicha();

        let fila = 12;
        const registros = [];
        mapaFechasFinPorComp = {};
        while (true) {
          let celdaA = ws["A" + fila];
          if (!celdaA) break;
          let nombreInstructor = celdaA.v || "";
          let apellidoInstructor = (ws["B" + fila] && ws["B" + fila].v) || "";
          let estadoInstructor = (ws["C" + fila] && ws["C" + fila].v) || "";
          let competencia = ((ws["D" + fila] && ws["D" + fila].v) || "").trim();
          let fechaInicioProg = (ws["E" + fila] && ws["E" + fila].v) || "";
          let fechaFinProg = (ws["F" + fila] && ws["F" + fila].v) || "";
          let horasProg = parseFloat((ws["G" + fila] && ws["G" + fila].v) || 0);

          const compKeyFecha = normalizeCompetencia(competencia);
          if (compKeyFecha) {
            const registroGuardado = mapaFechasFinPorComp[compKeyFecha] || {};
            const fechaFinTexto = fechaFinProg ? fechaFinProg.toString() : "";
            if (fechaFinTexto) {
              const fechaObj = parseFecha(fechaFinTexto);
              if (fechaObj instanceof Date && !isNaN(fechaObj)) {
                const textoMostrar = fechaFinTexto.includes("/") ? fechaFinTexto : formatearFechaCorta(fechaObj);
                if (!registroGuardado.fecha || fechaObj > registroGuardado.fecha) {
                  registroGuardado.fecha = fechaObj;
                  registroGuardado.texto = textoMostrar;
                }
              }
            }
            const inicioTexto = fechaInicioProg ? fechaInicioProg.toString() : "";
            const fechaInicioObj = normalizarFechaRegistro(fechaInicioProg);
            if (fechaInicioObj) {
              const textoInicioMostrar = inicioTexto.includes("/") ? inicioTexto : formatearFechaCorta(fechaInicioObj);
              if (!registroGuardado.inicio || fechaInicioObj < registroGuardado.inicio) {
                registroGuardado.inicio = fechaInicioObj;
                registroGuardado.inicioTexto = textoInicioMostrar;
              }
            }
            if (registroGuardado.fecha || registroGuardado.inicio) {
              mapaFechasFinPorComp[compKeyFecha] = registroGuardado;
            }
          }

          registros.push({
            nombreInstructor,
            apellidoInstructor,
            estadoInstructor,
            competencia,
            horasProg,
            fechaInicioProg,
            fechaFinProg
          });
          fila++;
        }
        // <<< AÑADIR ESTO >>>
        datosHorario = registros.map(r => ({
          "Nombre Instructor": ((r.nombreInstructor || "") + " " + (r.apellidoInstructor || "")).trim(),
          "Horas Programadas": r.horasProg,
          "Nombre Competencia": r.competencia
        }));


        registrosGlobal = registros;

        // Inicializar Reporte 1 aplicando filtros actuales
        aplicarFiltrosYGenerarReporte1();

        competenciasMap = {};
        registros.forEach(r => {
          if (!competenciasMap[r.competencia]) {
            competenciasMap[r.competencia] = 0;
          }
          competenciasMap[r.competencia] += r.horasProg;
        });


        let arrComp = Object.entries(competenciasMap);

        const tbody2 = document.getElementById("tbodyReporte2");
        tbody2.innerHTML = "";
        let cont2 = 1;
        competenciasSet.clear();
        competenciasSetNormalizado.clear();

        // Agrupamos las competencias por categoría
        const categoriasRep2 = {
          "Práctica": [],
          "Transversales": [],
          "Inglés": [],
          "Técnicas": []
        };

        arrComp.forEach(([comp, total]) => {
          const cat = getCategoria(comp);
          if (!categoriasRep2[cat]) {
            categoriasRep2[cat] = [];
          }
          categoriasRep2[cat].push([comp, total]);
        });

        const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];

        ordenCategorias.forEach(cat => {
          const lista = categoriasRep2[cat];
          if (!lista || lista.length === 0) return;

          lista.forEach(([comp, total]) => {
            // Guardamos en los sets para otros reportes
            competenciasSet.add(comp);
            competenciasSetNormalizado.add(normalizeCompetencia(comp));

            const tr = document.createElement("tr");
            const compNormalized = comp.trim().replace(/\s+/g, ' ').toUpperCase();
            const totalHoras = typeof total === "number" ? total : parseFloat(total);

            // Regla especial de validación
            if (
              compNormalized.startsWith("APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL") &&
              (totalHoras < 40 || Math.abs(totalHoras - 23.93) < 0.0001)
            ) {
              tr.classList.add("rojo");
            }
            const tipo = obtenerEtiquetaTipoCompetencia(comp);
            const infoFecha = obtenerDatosFechaCompetencia(comp);
            if (infoFecha.fechaInicio instanceof Date) {
              tr.dataset.fechaInicio = infoFecha.fechaInicio.toISOString();
            }
            if (infoFecha.fecha instanceof Date) {
              tr.dataset.fechaFin = infoFecha.fecha.toISOString();
            }
            const fechaInicioTexto = infoFecha.fechaInicioTexto || "-";
            const fechaFinTexto = infoFecha.fechaTexto || "-";
            const fechaInicioSort = infoFecha.fechaInicio ? infoFecha.fechaInicio.getTime() : "";
            const fechaFinSort = infoFecha.fecha ? infoFecha.fecha.getTime() : "";
            const diasColor = infoFecha.diasColor || (infoFecha.fecha ? "" : "pendiente");
            const diasHtml = infoFecha.diasHtml || "-";
            tr.innerHTML = `
            <td>${cont2++}</td>
            <td>${comp}</td>
            <td>${tipo}</td>
            <td data-sort-value="${fechaInicioSort}">${fechaInicioTexto}</td>
            <td data-sort-value="${fechaFinSort}">${fechaFinTexto}</td>
            <td class="col-dias" data-color="${diasColor}">${diasHtml}</td>
            <td>${totalHoras.toFixed(2)}</td>
            <td></td> <!-- Horas Diseño, se llenan luego -->
            <td></td> <!-- % -->
          `;
            tbody2.appendChild(tr);
          });
        });

        actualizarTotalesReporte2();

        // El tfoot2 que ya tienes se mantiene como está
        aplicarFiltrosReporte2();

        generarGanttChart();
        generarReporte3Instructores();
        actualizarMesesFormacion();
        // NUEVO: devolver cantidad de registros cargados
        return registros.length;
      }

      // =========================
      // Generar Reporte 1: Listado de Instructores y Competencias agrupado por categoría
      // =========================
      function generarReporte1(registros) {
        const tbody1 = document.getElementById("tbodyReporte1");
        tbody1.innerHTML = "";
        const categorias = {
          "Práctica": [],
          "Transversales": [],
          "Inglés": [],
          "Técnicas": []
        };
        const hoyPlano = new Date();
        hoyPlano.setHours(0, 0, 0, 0);
        registros.forEach((r) => {
          const cat = getCategoria(r.competencia);
          categorias[cat].push(r);
        });
        let contador = 1;
        const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];
        ordenCategorias.forEach(cat => {
          if (categorias[cat].length > 0) {
            categorias[cat].forEach(r => {
              const tr = document.createElement("tr");
              if (r.estadoInstructor.toLowerCase() === "inactivo") {
                tr.classList.add("inactivo");
              }
              const tipo = obtenerEtiquetaTipoCompetencia(r.competencia);
              const fechaInicioObj = normalizarFechaRegistro(r.fechaInicioProg);
              const fechaFinObj = normalizarFechaRegistro(r.fechaFinProg);
              const fechaInicioTexto = fechaInicioObj ? formatearFechaCorta(fechaInicioObj) : "-";
              const fechaFinTexto = fechaFinObj ? formatearFechaCorta(fechaFinObj) : "-";
              const fechaInicioSort = fechaInicioObj ? fechaInicioObj.getTime() : "";
              const fechaFinSort = fechaFinObj ? fechaFinObj.getTime() : "";
              let diasCelda = `<td class="col-dias" data-color="">-</td>`;
              if (fechaFinObj) {
                const objetivo = new Date(fechaFinObj.getFullYear(), fechaFinObj.getMonth(), fechaFinObj.getDate());
                const diffMs = objetivo.getTime() - hoyPlano.getTime();
                const diasValor = Math.round(diffMs / (1000 * 60 * 60 * 24));
                const diasNumero = Math.abs(diasValor);
                const { clase: colorClass, hex: colorHex } = obtenerColorSemaforoDias(diasValor);
                diasCelda = `<td class="col-dias" data-color="${colorClass}"><span class="dias-color" data-color="${colorClass}" style="color:${colorHex}; font-weight:600;">${diasNumero}</span></td>`;
              }
              tr.innerHTML = `
              <td>${contador++}</td>
              <td>${r.nombreInstructor}</td>
              <td>${r.apellidoInstructor}</td>
              <td data-sort-value="${fechaInicioSort}">${fechaInicioTexto}</td>
              <td data-sort-value="${fechaFinSort}">${fechaFinTexto}</td>
              ${diasCelda}
              <td>${r.competencia}</td>
              <td>${tipo}</td>
              <td>${r.horasProg.toFixed(2)}</td>
            `;
              tbody1.appendChild(tr);
            });
          }
        });
      }

      // =========================
      // =========================
      // Generar Cronograma Gantt del Reporte 2 (NUEVO DISEÑO)
      // =========================
      let registrosGanttCache = [];
      const filtrosGantt = {
        texto: "",
        categorias: {
          transversales: true,
          tecnicas: true,
          ingles: true,
          practica: true
        }
      };
      const filtrosGanttPendientes = {
        texto: "",
        categorias: {
          transversales: true,
          tecnicas: true,
          ingles: true,
          practica: true
        }
      };
      let arrComp2CachePendientes = [];

      function generarGanttChart(registrosBase) {
        const registros = Array.isArray(registrosBase)
          ? registrosBase
          : (Array.isArray(registrosGlobal) ? registrosGlobal : []);
        registrosGanttCache = registros;
        dibujarGanttDetalle();
      }

      function normalizarCategoriaGantt(tipo) {
        if (!tipo) return "otros";
        const t = tipo.toLowerCase();
        if (t.includes("transversal")) return "transversales";
        if (t.includes("técnica") || t.includes("tecnica")) return "tecnicas";
        if (t.includes("inglés") || t.includes("ingles")) return "ingles";
        if (t.includes("práctica") || t.includes("practica")) return "practica";
        return "otros";
      }

      function obtenerColorParaTipo(tipo) {
        // normalizarCategoriaGantt(tipo) ya existe en el proyecto
        // y devuelve algo como: "tecnicas", "ingles", "transversales", "practica"
        const normalizada = normalizarCategoriaGantt(tipo);

        const mapa = {
          tecnicas: "#22c55e",      // Verde
          ingles: "#2563eb",        // Azul
          transversales: "#eab308", // Amarillo
          practica: "#a855f7"       // Morado
        };

        // Valor por defecto: usa verde si no se reconoce el tipo
        return mapa[normalizada] || "#22c55e";
      }

      function dibujarGanttDetalle(registros = registrosGanttCache) {
        const contenedor = document.getElementById("anychartGanttContainer");
        if (!contenedor) return;

        contenedor.innerHTML = "";

        let overallStart = null;
        let overallEnd = null;
        const registrosValidos = [];

        // Helper para escapar HTML
        const escapeHtml = (text) => {
          if (!text) return "";
          return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        };

        // 1. Procesar datos
        registros.forEach(r => {
          if (!r.fechaInicioProg || !r.fechaFinProg) return;
          const start = parseFecha(r.fechaInicioProg);
          const end = parseFecha(r.fechaFinProg);

          if (!(start instanceof Date) || isNaN(start.getTime()) ||
            !(end instanceof Date) || isNaN(end.getTime())) return;

          registrosValidos.push({
            competencia: r.competencia,
            tipo: getCategoria(r.competencia), // Usa función global existente
            instructor: (r.nombreInstructor || "") + " " + (r.apellidoInstructor || ""),
            inicio: start,
            fin: end
          });

          if (!overallStart || start < overallStart) overallStart = start;
          if (!overallEnd || end > overallEnd) overallEnd = end;
        });

        if (!overallStart || !overallEnd || registrosValidos.length === 0) {
          contenedor.innerHTML = "<div style='padding:20px; text-align:center;'>No hay datos para mostrar.</div>";
          return;
        }

        // 2. Meses
        const meses = [];
        const startMonth = new Date(overallStart.getFullYear(), overallStart.getMonth(), 1);
        const endMonth = new Date(overallEnd.getFullYear(), overallEnd.getMonth(), 1);

        for (let d = new Date(startMonth); d <= endMonth; d.setMonth(d.getMonth() + 1)) {
          meses.push(new Date(d.getFullYear(), d.getMonth(), 1));
        }

        // 3. Filtrar
        const textoBusqueda = (filtrosGantt.texto || "").trim().toLowerCase();

        const datosFiltrados = registrosValidos.filter(fila => {
          const catKey = normalizarCategoriaGantt(fila.tipo);
          if (!filtrosGantt.categorias[catKey]) return false;

          if (!textoBusqueda) return true;
          const comp = (fila.competencia || "").toLowerCase();
          const inst = (fila.instructor || "").toLowerCase();
          return comp.includes(textoBusqueda) || inst.includes(textoBusqueda);
        });

          datosFiltrados.sort((a, b) => {
            if (a.inicio && b.inicio) {
              const diff = a.inicio.getTime() - b.inicio.getTime();
              if (diff !== 0) return diff;
            }
            return a.competencia.localeCompare(b.competencia);
          });

        // 4. HTML
        const colgroupMonths = meses.map(() => '<col style="min-width:80px; width:auto;">').join("");
        const mesesAbrev = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        let html = "<table class='tabla-gantt-detalle'>";
        html += `<colgroup>
        <col style="width:40px;">   <!-- # -->
        <col style="width:220px;">  <!-- Competencia -->
        <col style="width:120px;">  <!-- Tipo -->
        <col style="width:180px;">  <!-- Instructor -->
        <col style="width:80px;">   <!-- Inicio -->
        <col style="width:80px;">   <!-- Fin -->
        ${colgroupMonths}
      </colgroup>`;

        html += "<thead class='encabezado-verde'><tr>";
        // Header actualizado con Inicio y Fin
        html += "<th>#</th><th>Competencia</th><th>Tipo</th><th>Instructor</th><th>Inicio</th><th>Fin</th>";
        meses.forEach(m => {
          const label = mesesAbrev[m.getMonth()] + "<br>" + m.getFullYear().toString().slice(-2);
          html += `<th>${label}</th>`;
        });
        html += "</tr></thead><tbody>";

        let contador = 1;
        datosFiltrados.forEach(fila => {
          // Truncar nombre competencia
          const nombreCompleto = (fila.competencia || "").trim();
          let nombreMostrado = nombreCompleto;
          if (nombreMostrado.length > 20) {
            nombreMostrado = nombreMostrado.slice(0, 20) + "…";
          }

          // Formatear fechas dd/mm/yyyy
          const fInicio = fila.inicio ? fila.inicio.toLocaleDateString("es-CO") : "";
          const fFin = fila.fin ? fila.fin.toLocaleDateString("es-CO") : "";

          html += "<tr>";
          html += `<td style='text-align:center;'>${contador++}</td>`;
          // Competencia con title
          html += `<td class="gantt-col-competencia" title="${escapeHtml(nombreCompleto)}">${escapeHtml(nombreMostrado)}</td>`;
          const tipoMostrado = obtenerEtiquetaTipoCompetencia(fila.competencia);
          html += `<td>${tipoMostrado}</td>`;
          html += `<td>${fila.instructor}</td>`;
          // Nuevas columnas de fecha
          html += `<td style='text-align:center;'>${fInicio}</td>`;
          html += `<td style='text-align:center;'>${fFin}</td>`;

          // Obtenemos el color dinámico según el tipo
          const colorBarra = obtenerColorParaTipo(fila.tipo);

          meses.forEach(m => {
            const mY = m.getFullYear();
            const mM = m.getMonth();
            const sY = fila.inicio.getFullYear();
            const sM = fila.inicio.getMonth();
            const eY = fila.fin.getFullYear();
            const eM = fila.fin.getMonth();

            // Lógica de solapamiento de meses (inclusiva)
            const inRange = (
              (mY > sY || (mY === sY && mM >= sM)) &&
              (mY < eY || (mY === eY && mM <= eM))
            );

            if (inRange) {
              // Barra con esquinas redondeadas dentro de celda
              html += `<td class='gantt-month-cell'><span class='gantt-month-bar' style='background-color:${colorBarra};'></span></td>`;
            } else {
              html += "<td class='gantt-month-cell'></td>";
            }
          });
          html += "</tr>";
        });
        html += "</tbody></table>";

        contenedor.innerHTML = html;

        // ACTIVAR ORDENAMIENTO EN EL GANTT DETALLADO
        const tablaGantt = contenedor.querySelector(".tabla-gantt-detalle");
        if (tablaGantt) {
          setupTablaOrdenable(tablaGantt, ["number", "text", "text", "text", "date", "date"]); // Meses se asumen 'text' o sin orden
        }
      }

      // Event Listeners (para controles Gantt)
      document.addEventListener("DOMContentLoaded", function () {
        const inputBusquedaGantt = document.getElementById("ganttSearchInput");
        if (inputBusquedaGantt) {
          inputBusquedaGantt.addEventListener("input", function () {
            filtrosGantt.texto = this.value || "";
            dibujarGanttDetalle();
          });
        }

        const botonesFiltrosGantt = document.querySelectorAll(".gantt-filter-button[data-target=\"detalle\"]");
        botonesFiltrosGantt.forEach(btn => {
          const categoria = btn.getAttribute("data-cat");
          if (!categoria) return;
          btn.addEventListener("click", function () {
            filtrosGantt.categorias[categoria] = !filtrosGantt.categorias[categoria];
            btn.classList.toggle("active", filtrosGantt.categorias[categoria]);
            dibujarGanttDetalle();
          });
        });
        const inputBusquedaGanttPendientes = document.getElementById("ganttPendientesSearchInput");
        if (inputBusquedaGanttPendientes) {
          inputBusquedaGanttPendientes.addEventListener("input", function () {
            filtrosGanttPendientes.texto = this.value || "";
            generarGanttPendientes(arrComp2CachePendientes);
          });
        }
        const botonesPendientes = document.querySelectorAll(".gantt-filter-button[data-target=\"pendientes\"]");
        botonesPendientes.forEach(btn => {
          const categoria = btn.getAttribute("data-cat");
          if (!categoria) return;
          btn.addEventListener("click", function () {
            filtrosGanttPendientes.categorias[categoria] = !filtrosGanttPendientes.categorias[categoria];
            btn.classList.toggle("active", filtrosGanttPendientes.categorias[categoria]);
            generarGanttPendientes(arrComp2CachePendientes);
          });
        });
      });

      // Gráfico % Competencias con Horas (Total vs Diseño)
      // Gráfico % Competencias con Horas (Total vs Diseño)
      // Gráfico % Competencias con Horas (Total vs Diseño)




      // =========================
      // Generar Reporte 3: Instructores con total de horas (mayor a menor)
      // + Gráfico de barras CanvasJS
      // =========================
      function generarReporte3Instructores() {
      const mapHorasPorInstructor = {};

      registrosGlobal.forEach(r => {
        const nombre = (r.nombreInstructor || "").trim();
        const apellido = (r.apellidoInstructor || "").trim();
        const categoria = getCategoria(r.competencia) || "Sin tipo";
        const clave = (nombre + "|" + apellido + "|" + categoria).toLowerCase();

        if (!mapHorasPorInstructor[clave]) {
          mapHorasPorInstructor[clave] = {
            nombre,
            apellido,
            horas: 0,
            tipo: categoria,
            fechaInicio: null,
            fechaFin: null
          };
        }
        const instructor = mapHorasPorInstructor[clave];
        const horas = Number(r.horasProg);
        instructor.horas += Number.isFinite(horas) ? horas : 0;

        const fechaInicio = normalizarFechaRegistro(r.fechaInicioProg);
        if (fechaInicio && (!instructor.fechaInicio || fechaInicio < instructor.fechaInicio)) {
          instructor.fechaInicio = fechaInicio;
        }

        const fechaFin = normalizarFechaRegistro(r.fechaFinProg);
        if (fechaFin && (!instructor.fechaFin || fechaFin > instructor.fechaFin)) {
          instructor.fechaFin = fechaFin;
        }
      });

      let arrInstructores = Object.values(mapHorasPorInstructor);
      arrInstructores.sort((a, b) => b.horas - a.horas);

      const tbody3 = document.getElementById("tbodyReporte3");
      if (!tbody3) return;

      tbody3.innerHTML = "";
      arrInstructores.forEach((inst, i) => {
        const tipoTexto = inst.tipo || "-";
        const tipoKey = normalizarCategoriaGantt(tipoTexto || "");

        const fechaInicioTexto = inst.fechaInicio ? formatearFechaCorta(inst.fechaInicio) : "-";
        const fechaFinTexto = inst.fechaFin ? formatearFechaCorta(inst.fechaFin) : "-";
        const fechaInicioSort = inst.fechaInicio ? inst.fechaInicio.getTime() : "";
        const fechaFinSort = inst.fechaFin ? inst.fechaFin.getTime() : "";

        let diasCelda = `<td class="col-dias" data-color="">-</td>`;
        if (inst.fechaFin) {
          const hoyPlano = new Date();
          hoyPlano.setHours(0, 0, 0, 0);
          const objetivo = new Date(inst.fechaFin.getFullYear(), inst.fechaFin.getMonth(), inst.fechaFin.getDate());
          const diffMs = objetivo.getTime() - hoyPlano.getTime();
          const diasValor = Math.round(diffMs / (1000 * 60 * 60 * 24));
          const diasNumero = Math.abs(diasValor);
          const colorClass = diasValor >= 0 ? "verde" : "rojo";
          const colorHex = diasValor >= 0 ? "#1e8a37" : "#b91c1c";
          if (Number.isFinite(diasNumero)) {
            diasCelda = `<td class="col-dias" data-color="${colorClass}"><span class="dias-color" data-color="${colorClass}" style="color:${colorHex}; font-weight:600;">${diasNumero}</span></td>`;
          }
        }

        const tr = document.createElement("tr");
        if (tipoKey) {
          tr.dataset.tipo = tipoKey;
        }
        if (inst.fechaInicio) {
          tr.dataset.fechaInicio = inst.fechaInicio.toISOString();
        }
        if (inst.fechaFin) {
          tr.dataset.fechaFin = inst.fechaFin.toISOString();
        }
        tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${inst.nombre}</td>
      <td>${inst.apellido}</td>
      <td>${tipoTexto}</td>
      <td data-sort-value="${fechaInicioSort}">${fechaInicioTexto}</td>
      <td data-sort-value="${fechaFinSort}">${fechaFinTexto}</td>
      ${diasCelda}
      <td>${inst.horas.toFixed(2)}</td>
    `;
        tbody3.appendChild(tr);
      });

      const tfoot3 = document.getElementById("tfootReporte3");
      if (tfoot3) {
        const totalHoras = arrInstructores.reduce((acc, inst) => acc + (Number.isFinite(inst.horas) ? inst.horas : 0), 0);
        tfoot3.innerHTML = `<tr>
      <td colspan="7" style="text-align:right; font-weight:bold;">Total Horas Programadas:</td>
      <td>${totalHoras.toFixed(2)}</td>
    </tr>`;
      }

      aplicarFiltrosReporte3();

        // 4) Construir gráfico de barras de horas por instructor (CanvasJS)
        const contGrafico = document.getElementById("chartInstructoresHorasContainer");
        if (!contGrafico) return; // por seguridad

        // Limpiar contenedor por si se vuelve a generar
        contGrafico.innerHTML = "";

        // Paleta de tonos verdes para las barras
        const coloresVerdes = ["#22c55e", "#16a34a", "#15803d", "#4ade80", "#86efac"];

        const dataPointsHoras = arrInstructores.map((inst, index) => ({
          y: parseFloat(inst.horas.toFixed(2)),
          label: `${inst.nombre} ${inst.apellido}`,
          color: coloresVerdes[index % coloresVerdes.length]
        }));

        if (dataPointsHoras.length === 0) return;

        // Altura dinámica: 35 px por instructor + 120 px para títulos y márgenes
        const alturaPorBarra = 35;
        const margenExtra = 120;
        const alturaGrafico = margenExtra + alturaPorBarra * dataPointsHoras.length;

        // Ajustar el alto del contenedor del gráfico
        contGrafico.style.height = alturaGrafico + "px";

        // Crear el gráfico y guardarlo en la variable global
        chartHorasInstructores = new CanvasJS.Chart("chartInstructoresHorasContainer", {
          animationEnabled: true,
          exportEnabled: true,
          height: alturaGrafico,

          axisX: {
            interval: 1,
            labelFontSize: 10
          },
          axisY2: {
            interlacedColor: "rgba(1,77,101,0.2)",
            gridColor: "rgba(1,77,101,0.1)",
            labelFontSize: 10
          },
          data: [{
            type: "bar",
            axisYType: "secondary",
            dataPoints: dataPointsHoras
          }]
        });

        // Primer render
        chartHorasInstructores.render();
      }


      // =========================
      // Procesar Segundo Archivo (Juicios Evaluativos)
      // =========================
      function procesarSegundoArchivo(ws) {
        if (mensajeErrorFicha) {
          mensajeErrorFicha.textContent = "";
          mensajeErrorFicha.style.display = "none";
        }
        const c3Value = normalizarFicha((ws["C3"] && ws["C3"].v) || "");
        const codigoPrograma = (ws["C4"] && ws["C4"].v) || "";
        codigoProgramaGlobal = codigoPrograma;
        document.getElementById("codigoPrograma").textContent = codigoPrograma;

        // Capturar Modalidad de Formación desde C10
        const modalidadFormacion = (ws["C10"] && ws["C10"].v) || "";
        modalidadFormacionGlobal = modalidadFormacion;
        document.getElementById("modalidadFormacion").textContent = modalidadFormacion || "N/A";

        if (c3Value !== codigoFichaPrimero) {
          if (mensajeErrorFicha) {
            mensajeErrorFicha.textContent =
              `❌ El reporte de juicios que intenta cargar (${c3Value}) pertenece a otra ficha. Favor subir el reporte de la ficha ${codigoFichaPrimero}.`;
            mensajeErrorFicha.style.display = "flex";
          }
          if (sectionArchivo3) {
            sectionArchivo3.style.display = "none";
          }
          if (botonArchivo3) {
            botonArchivo3.disabled = true;
          }
          return;
        }
        let fila = 14;
        registrosJuicios = [];
        while (true) {
          let celdaA = ws["A" + fila];
          if (!celdaA) break;
          let tipoDoc = celdaA.v || "";
          let numDoc = (ws["B" + fila] && ws["B" + fila].v) || "";
          let nombre = (ws["C" + fila] && ws["C" + fila].v) || "";
          let apellidos = (ws["D" + fila] && ws["D" + fila].v) || "";
          let estado = (ws["E" + fila] && ws["E" + fila].v) || "";
          let compOrig = (ws["F" + fila] && ws["F" + fila].v) || "";
          let competencia = compOrig ? compOrig.trim().replace(/^[0-9]+\s*-\s*/, '').trim() : "";
          let resAprendizaje = (ws["G" + fila] && ws["G" + fila].v) || "";
          let juicioEval = (ws["H" + fila] && ws["H" + fila].v) || "";
          let fechaHora = (ws["I" + fila] && ws["I" + fila].v) || "";
          let funcionario = (ws["K" + fila] && ws["K" + fila].v) || "";




          registrosJuicios.push({
            tipoDoc,
            numDoc,
            nombre,
            apellidos,
            estado,
            competencia,
            resAprendizaje,
            juicioEval,
            fechaHora,
            funcionario
          });
          fila++;
        }
        // <<< AÑADIR ESTO >>>
        datosGeneralFicha = registrosJuicios.map(r => ({
          "Estado Aprendiz": r.estado,
          "Nombre Aprendiz": (r.nombre + " " + r.apellidos).trim(),
          "Documento": r.numDoc
        }));
        // En este punto ya tenemos los registros de aprendices.
        // IMPORTANTE: NO mostramos headerInfo aquí.
        // Se mostrará solo después de cargar el Archivo 3.

        // Generar tabla de estados
        const estadosMap = {};


        const totalAprendicesSet = new Set();

        registrosJuicios.forEach(r => {
          let estado = (r.estado || "").trim();
          let nombreCompleto = (r.nombre + " " + r.apellidos).trim();

          totalAprendicesSet.add(nombreCompleto);

          if (!estadosMap[estado]) {
            estadosMap[estado] = new Set();
          }
          estadosMap[estado].add(nombreCompleto);
        });

        const totalAprendices = totalAprendicesSet.size;
        const tbodyEstado = document.getElementById("tbodyEstado");
        tbodyEstado.innerHTML = "";

        // Mostrar total en el encabezado de la tarjeta
        const totalSpan = document.getElementById("totalAprendicesEstado");
        if (totalSpan) {
          totalSpan.textContent = totalAprendices;
        }
        const totalMatricHeader = document.getElementById("numMatriculadosHeader");
        if (totalMatricHeader) {
          totalMatricHeader.textContent = totalAprendices;
        }
        const totalInlineSpan = document.getElementById("numAprendicesTotalInline");
        if (totalInlineSpan) {
          totalInlineSpan.textContent = `/ ${totalAprendices}`;
        }

        // ORDEN DESEADO DE LOS ESTADOS
        const ordenPreferido = [
          "EN FORMACION",
          "EN FORMACIÓN",
          "CONDICIONADO",
          "CANCELADO",
          "CANCELADOS",
          "RETIRO VOLUNTARIO"
        ];

        // Construir arreglo de estados en el orden deseado
        const estadosOrdenados = [];

        // Primero los estados en el orden definido
        ordenPreferido.forEach(estadoRef => {
          Object.keys(estadosMap).forEach(estadoClave => {
            const normClave = estadoClave.toUpperCase().trim();
            if (normClave === estadoRef && !estadosOrdenados.includes(estadoClave)) {
              estadosOrdenados.push(estadoClave);
            }
          });
        });

        // Luego cualquier otro estado que exista
        Object.keys(estadosMap).forEach(estadoClave => {
          if (!estadosOrdenados.includes(estadoClave)) {
            estadosOrdenados.push(estadoClave);
          }
        });

        // Pintar filas de la tabla en el orden calculado
        estadosOrdenados.forEach(estado => {
          let nombresArray = Array.from(estadosMap[estado]).sort();
          let cantidad = nombresArray.length;
          const tr = document.createElement("tr");

          // Normalizar estado para asignar clase de color
          const estadoNorm = (estado || "").toUpperCase().trim();
          let claseEstado = "estado-otro";

          if (estadoNorm === "EN FORMACION" || estadoNorm === "EN FORMACIÓN") {
            claseEstado = "estado-en-formacion";
          } else if (estadoNorm === "CONDICIONADO") {
            claseEstado = "estado-condicionado";
          } else if (estadoNorm === "CANCELADO" || estadoNorm === "CANCELADOS") {
            claseEstado = "estado-cancelado";
          } else if (estadoNorm === "RETIRO VOLUNTARIO") {
            claseEstado = "estado-retiro";
          }

          tr.classList.add("fila-estado", claseEstado);

          tr.innerHTML = `
    <td><span class="badge-estado">${estado}</span></td>
    <td>${nombresArray.join(", ")}</td>
    <td class="col-cantidad">${cantidad}</td>
    <td class="col-porcentaje">${totalAprendices ? ((cantidad / totalAprendices) * 100).toFixed(2) : "0.00"
            }%</td>
  `;
          tbodyEstado.appendChild(tr);
        });


        // === Datos para la gráfica (mismo orden que la tabla) ===
        const estados = estadosOrdenados;
        const cantidades = estados.map(estado => estadosMap[estado].size);
        const porcentajes = cantidades.map(cantidad =>
          totalAprendices ? Number(((cantidad / totalAprendices) * 100).toFixed(2)) : 0
        );

        // Construir dataPoints para CanvasJS
        // Colores SOLO para la gráfica (no afecta la tabla)
        const coloresGraficoEstados = {
          "EN FORMACION": "#16A34A",        // azul
          "EN FORMACIÓN": "#16A34A",        // con tilde
          "CONDICIONADO": "#FACC15",        // amarillo/naranja
          "CANCELADO": "#ADB3BF",           // gris
          "CANCELADOS": "#ADB3BF",
          "RETIRO VOLUNTARIO": "#F97373"    // rojo
        };

        const dataPointsEstados = estados.map((estado, index) => {
          const clave = (estado || "").toUpperCase().trim();
          return {
            y: porcentajes[index],
            name: estado,
            color: coloresGraficoEstados[clave] || "#22c55e", // color de respaldo
            exploded: index === 0
          };
        });


        // Limpiar el contenedor antes de redibujar


        const chartContainer = document.getElementById("estadoChartContainer");
        if (chartContainer) {
          chartContainer.innerHTML = "";
        }

        estadoChart = new CanvasJS.Chart("estadoChartContainer", {
          animationEnabled: true,
          exportEnabled: true,
          legend: {
            cursor: "pointer",
            itemclick: explodePieEstado
          },
          data: [{
            type: "pie",
            showInLegend: true,
            toolTipContent: "{name}: <strong>{y}%</strong>",
            indexLabel: "{name} - {y}%",
            yValueFormatString: "#,##0.00",
            dataPoints: dataPointsEstados
          }]
        });

        estadoChart.render();

        // Generar tabla del Reporte 4
        const tbody4 = document.getElementById("tbodyReporte4");
        tbody4.innerHTML = "";

        // 1) Construir arrComp2 (misma lógica que antes)
        const comp2Set = new Set();
        registrosJuicios.forEach(r => {
          comp2Set.add(r.competencia);
        });



        // Nesteamos arrComp2 para que se sepa si están programadas o no
        // y manejamos el caso especial de la competencia ambiental con 1/2
        let arrComp2 = Array.from(comp2Set).map(comp => {
          const compNorm = normalizeCompetencia(comp);

          // Por defecto, según el set normalizado (solo entra si tiene horas > 0)
          let programada = competenciasSetNormalizado.has(compNorm) ? "Sí" : "No";
          let tooltip = "";

          // Regla especial: APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL...
          if (compNorm.includes("APLICAR PRACTICAS DE PROTECCION AMBIENTAL")) {
            let horas = 0;

            // Tomamos las horas totales tal como se usan en % Competencias con Horas
            for (const [compRaw, total] of Object.entries(competenciasMap || {})) {
              if (normalizeCompetencia(compRaw) === compNorm) {
                horas = typeof total === "number" ? total : parseFloat(total) || 0;
                break;
              }
            }

            // Clasificación:
            //  - 0 horas      -> "No"
            //  - 0 < horas <= 24 -> "1/2"  (falta programar la 1/2)
            //  - horas  > 24  -> "Sí"
            if (horas <= 0.0001) {
              programada = "No";
            } else if (horas <= 24) {
              programada = "1/2";
              tooltip = "Falta programar la 1/2 mitad de la competencia";
            } else {
              programada = "Sí";
            }
          }

          return { comp, programada, tooltip };
        });


        // === NUEVO: actualizar Reporte 2 con TODAS las competencias del programa ===
        (function actualizarReporte2ConTodasLasCompetencias() {
          const tbody2 = document.getElementById("tbodyReporte2");
          if (!tbody2) return;

          // Mapa: competencia normalizada -> horas totales programadas (archivo 1)
          const horasPorCompNorm = {};
          Object.entries(competenciasMap || {}).forEach(([compTexto, horas]) => {
            const compNorm = normalizeCompetencia(compTexto);
            if (!compNorm) return;

            const valorHoras = typeof horas === "number" ? horas : parseFloat(horas) || 0;
            if (!horasPorCompNorm[compNorm]) {
              horasPorCompNorm[compNorm] = 0;
            }
            horasPorCompNorm[compNorm] += valorHoras;
          });

          // Arreglo para Reporte 2 usando TODAS las competencias del programa (arrComp2)
          const arrCompRep2 = arrComp2.map(obj => {
            const compTexto = obj.comp || "";
            const compNorm = normalizeCompetencia(compTexto);
            const horasProg = compNorm && horasPorCompNorm[compNorm]
              ? horasPorCompNorm[compNorm]
              : 0; // si no está programada, 0 horas
            return [compTexto, horasProg];
          });

          // Reconstruir completamente la tabla del Reporte 2
          tbody2.innerHTML = "";
          competenciasSet.clear();
          competenciasSetNormalizado.clear();

          const categoriasRep2 = {
            "Práctica": [],
            "Transversales": [],
            "Inglés": [],
            "Técnicas": []
          };

          arrCompRep2.forEach(([comp, horas]) => {
            const cat = getCategoria(comp);
            if (!categoriasRep2[cat]) {
              categoriasRep2[cat] = [];
            }
            categoriasRep2[cat].push([comp, horas]);
          });

          const ordenCategorias2 = ["Práctica", "Transversales", "Inglés", "Técnicas"];
          let cont2 = 1;

          ordenCategorias2.forEach(cat => {
            const lista = categoriasRep2[cat];
            if (!lista || lista.length === 0) return;

            lista.forEach(([comp, total]) => {
          const tr = document.createElement('tr');
          const compNormalized = comp.trim().replace(/\s+/g, ' ').toUpperCase();
          const totalHoras = typeof total === 'number' ? total : parseFloat(total) || 0;

              // Solo se consideran 'programadas' (para otros reportes) las que tienen horas > 0
              if (totalHoras > 0) {
                competenciasSet.add(comp);
                competenciasSetNormalizado.add(normalizeCompetencia(comp));
              }
              // Resaltar en rojo claro las competencias con 0 horas programadas
              if (totalHoras === 0) {
                tr.classList.add('no-programada');
              }

              // APLICAR PRACTICAS DE PROTECCION AMBIENTAL en rojo si no cumple las horas
              if (
                compNormalized.startsWith('APLICAR PRACTICAS DE PROTECCION AMBIENTAL') ||
                compNormalized.startsWith('APLICAR PRÁCTICAS DE PROTECCIÓN AMBIENTAL')
              ) {
                if (totalHoras < 40 && Math.abs(totalHoras - 23.93) > 0.0001) {
                  tr.classList.add('rojo');
                }
              }
              const tipo = obtenerEtiquetaTipoCompetencia(comp);
              const infoFecha = obtenerDatosFechaCompetencia(comp);
              if (infoFecha.fechaInicio instanceof Date) {
                tr.dataset.fechaInicio = infoFecha.fechaInicio.toISOString();
              }
              if (infoFecha.fecha instanceof Date) {
                tr.dataset.fechaFin = infoFecha.fecha.toISOString();
              }
              const fechaInicioTexto = infoFecha?.fechaInicioTexto || '-';
              const fechaFinTexto = infoFecha?.fechaTexto || '-';
              const fechaInicioSort = infoFecha?.fechaInicio ? infoFecha.fechaInicio.getTime() : '';
              const fechaFinSort = infoFecha?.fecha ? infoFecha.fecha.getTime() : '';
              const diasColor = infoFecha?.diasColor || (infoFecha?.fecha ? '' : 'pendiente');
              const diasHtml = infoFecha?.diasHtml || '-';

              tr.innerHTML = `
                <td>${cont2++}</td>
                <td>${comp}</td>
                <td>${tipo}</td>
                <td data-sort-value='${fechaInicioSort}'>${fechaInicioTexto}</td>
                <td data-sort-value='${fechaFinSort}'>${fechaFinTexto}</td>
                <td class='col-dias' data-color='${diasColor}'>${diasHtml}</td>
                <td>${totalHoras.toFixed(2)}</td>
                <td></td> <!-- Horas Diseño, se llenan luego -->
                <td></td> <!-- % -->
              `;
              tbody2.appendChild(tr);
            });
          });

          // Actualizar pie de tabla (Total Horas Programadas)
          const tfoot2 = document.getElementById('tfootReporte2');
          if (tfoot2) {
            const totalHorasProg = arrCompRep2.reduce((acc, [, horas]) => {
              const valor = typeof horas === 'number' ? horas : parseFloat(horas) || 0;
              return acc + valor;
            }, 0);

          tfoot2.innerHTML = `
      <tr>
        <td colspan='6' style='text-align:right; font-weight:bold;'>Total Horas Programadas:</td>
        <td>${totalHorasProg.toFixed(2)}</td>
        <td></td>
        <td></td>
      </tr>
    `;
            actualizarTotalesReporte2();
  }
        })();


        // 2) Agrupar por categoría usando getCategoria (Reporte 4, igual que antes)
        const categoriasRep4 = {
          "Práctica": [],
          "Transversales": [],
          "Inglés": [],
          "Técnicas": []
        };


        arrComp2.forEach(obj => {
          const cat = getCategoria(obj.comp);
          if (!categoriasRep4[cat]) {
            categoriasRep4[cat] = [];
          }
          categoriasRep4[cat].push(obj);
        });



        // 3) Pintar tabla ordenada por categoría
        let cont4 = 1;
        const ordenCategorias4 = ["Práctica", "Transversales", "Inglés", "Técnicas"];

        ordenCategorias4.forEach(cat => {
          const lista = categoriasRep4[cat];
          if (!lista || lista.length === 0) return;

          // Filas de competencias
          lista.forEach(obj => {
            const tr = document.createElement("tr");

            if (obj.alertaInstructorDiferente) {
              tr.classList.add("fila-instructor-diferente");
            }

            // Resaltar en rojo claro las que estén "No" o "1/2"
            if (obj.programada === "No" || obj.programada === "1/2") {
              tr.classList.add("no-programada");
            }

            // Tooltip solo para el caso 1/2 de la competencia ambiental
            const tooltipAttr = obj.tooltip ? ` title="${obj.tooltip}"` : "";
            const tipo = obtenerEtiquetaTipoCompetencia(obj.comp);
            const infoFecha = obtenerDatosFechaCompetencia(obj.comp);
            const fechaInicioTexto = infoFecha.fechaInicioTexto || "-";
            const fechaFinTexto = infoFecha.fechaTexto || "-";
            const fechaInicioSort =
              infoFecha.fechaInicio instanceof Date && !isNaN(infoFecha.fechaInicio.getTime())
                ? infoFecha.fechaInicio.getTime()
                : "";
            const fechaFinSort =
              infoFecha.fecha instanceof Date && !isNaN(infoFecha.fecha.getTime())
                ? infoFecha.fecha.getTime()
                : "";
            const diasColor = infoFecha.diasColor || (infoFecha.fecha ? "" : "pendiente");
            const diasHtml = infoFecha.diasHtml || "-";

            tr.innerHTML = `
      <td>${cont4++}</td>
      <td>${obj.comp}</td>
      <td>${tipo}</td>
      <td data-sort-value="${fechaInicioSort}">${fechaInicioTexto}</td>
      <td data-sort-value="${fechaFinSort}">${fechaFinTexto}</td>
      <td class="col-dias" data-color="${diasColor}">${diasHtml}</td>
      <td${tooltipAttr}>${obj.programada}</td>
    `;
            tbody4.appendChild(tr);
          });
        });

        // 4) Gantt pendientes con el mismo arreglo
        generarGanttPendientes(arrComp2);
        aplicarFiltrosReporte4();

        gruposProgramadas = {};
        gruposPendientes = {};

        registrosJuicios.forEach(r => {
          const estadoU = (r.estado || "").toUpperCase();
          if ((estadoU === "EN FORMACION" || estadoU === "CONDICIONADO") &&
            (r.juicioEval || "").toUpperCase() === "POR EVALUAR") {

            const key = r.competencia + '|' + r.resAprendizaje;
            const compNorm = normalizeCompetencia(r.competencia);

            if (competenciasSetNormalizado.has(compNorm)) {
              if (!gruposProgramadas[key]) {
                gruposProgramadas[key] = { competencia: r.competencia, rap: r.resAprendizaje, nombres: new Set() };
              }
              gruposProgramadas[key].nombres.add((r.nombre + " " + r.apellidos).trim());
            } else {
              if (!gruposPendientes[key]) {
                gruposPendientes[key] = { competencia: r.competencia, rap: r.resAprendizaje, nombres: new Set() };
              }
              gruposPendientes[key].nombres.add((r.nombre + " " + r.apellidos).trim());
            }
          }
        });

        generarReporte5();

        generarPivotTableAvancePorAprendiz();
        generarPivotTableReporte6();
        generarReporte8PendientesPorAprendizInstructor();
        actualizarMesesFormacion();
        // NUEVO: devolver cantidad de registros de juicios
        return registrosJuicios.length;
      }

      // =========================
      // Procesar Tercer Archivo (Horas Diseño)
      // =========================



      function procesarTercerArchivo(ws) {
        const horasDisenoMap = {};
        nivelFormacionGlobal = ""; // Limpiar valor previo
        let fila = 2;
        let filasCargadas = 0;

        while (true) {
          const celdaCodigoPrograma = ws["A" + fila];
          const celdaComp = ws["B" + fila];
          const celdaHoras = ws["C" + fila];
          const celdaNivelFormacion = ws["E" + fila]; // Columna E para Nivel de Formación

          if (!celdaCodigoPrograma && !celdaComp && !celdaHoras) break;

          if (!celdaCodigoPrograma || !celdaComp || !celdaHoras) {
            fila++;
            continue;
          }

          const codProg = celdaCodigoPrograma.v.toString().trim();
          const comp = celdaComp.v.toString().trim().toUpperCase();
          const horas = parseFloat(celdaHoras.v) || 0;
          const nivelFormacion = (celdaNivelFormacion && celdaNivelFormacion.v) ? celdaNivelFormacion.v.toString().trim() : "";

          if (codProg === codigoProgramaGlobal.trim()) {
            horasDisenoMap[comp] = horas;
            filasCargadas++;

            // Guardar el primer nivel de formación que encontremos para este programa
            if (nivelFormacion && !nivelFormacionGlobal) {
              nivelFormacionGlobal = nivelFormacion;
            }
          }

          fila++;
        }

        // Guardar total de competencias del programa (archivo 3)
        totalCompetenciasPrograma = Object.keys(horasDisenoMap).length;

        // NUEVO: guardar mapa de diseño para uso global (ej. Acta de comité)
        horasDisenoMapGlobal = horasDisenoMap;
        try {
          competenciasDisenoNormSetGlobal = new Set(Object.keys(horasDisenoMapGlobal || {}).map(k => normalizeCompetencia(k)));
        } catch (e) {
          competenciasDisenoNormSetGlobal = new Set();
        }

        // Actualizar tabla en Reporte 2
        const tbody = document.getElementById("tbodyReporte2");
        const filas = tbody ? tbody.getElementsByTagName("tr") : [];

        // Acumuladores
        let totalHorasProgramadas = 0;
        let totalHorasDisenoDesdeArchivo = 0;

        // Sumar horas programadas (columna Total de Horas)
        const filasReporte2 = document.querySelectorAll("#tbodyReporte2 tr");
        filasReporte2.forEach(filaHtml => {
          const horasProg = parseFloat(filaHtml.cells[6]?.textContent) || 0;
          totalHorasProgramadas += horasProg;
        });

        // Sumar horas de diseño desde el archivo
        for (const horas of Object.values(horasDisenoMap)) {
          totalHorasDisenoDesdeArchivo += horas;
        }

        // Mostrar totales en el pie de tabla
        const tfoot = document.getElementById("tfootReporte2");
        if (tfoot) {
          tfoot.innerHTML = `
      <tr>
        <td colspan="6" style="text-align:right; font-weight:bold;">Totales:</td>
        <td style="font-weight:bold;">${totalHorasProgramadas.toFixed(2)}</td>
        <td style="font-weight:bold;">${totalHorasDisenoDesdeArchivo.toFixed(2)}</td>
        <td style="font-weight:bold;">${totalHorasDisenoDesdeArchivo > 0
              ? ((totalHorasProgramadas / totalHorasDisenoDesdeArchivo) * 100).toFixed(2) + '%'
              : '0.00%'
            }</td>
      </tr>
    `;
        }

        // Actualizar Horas Diseño y % fila a fila
        const dataPointsProgramadas = [];
        const dataPointsDiseno = [];

        let haySuperadas = false;
        let numeroCompetenciasSobrecargadas = 0;  // NUEVO
        for (let i = 0; i < filas.length; i++) {
          const filaHtml = filas[i];
          const celdas = filaHtml.getElementsByTagName("td");

          if (celdas.length >= 7) {
            const comp = celdas[1].textContent.trim().toUpperCase();
            const horasProgramadas = parseFloat(celdas[6].textContent) || 0;
            const horasDiseno = horasDisenoMap[comp] || 0;

            let porcentajeNumero = 0;
            let porcentajeTexto = "—";

            if (horasDiseno > 0) {
              porcentajeNumero = (horasProgramadas / horasDiseno) * 100;
              porcentajeTexto = porcentajeNumero.toFixed(2) + "%";
            }

            celdas[7].textContent = horasDiseno.toFixed(2);
            celdas[8].textContent = porcentajeTexto;

            // Resaltar en rojo claro las filas que superen el 100 %
            if (porcentajeNumero > 100) {
              filaHtml.classList.add("textoRojo");
              haySuperadas = true;
              numeroCompetenciasSobrecargadas++;   // NUEVO
            } else {
              filaHtml.classList.remove("textoRojo");
            }

          }
        }
        // Actualizar Nº competencias sobrecargadas en el encabezado
        const spanCompSobrecargadas = document.getElementById("numCompetenciasSobrecargadasHeader");
        if (spanCompSobrecargadas) {
          spanCompSobrecargadas.textContent = numeroCompetenciasSobrecargadas.toString();
        }

        // Mostrar / ocultar la nota debajo del título del gráfico
        const nota = document.getElementById("notaCompetenciasHoras");
        if (nota) {
          if (haySuperadas) {
            nota.style.display = "block";
            nota.textContent =
              "Las competencias resaltadas en rojo es porque superaron la cantidad " +
              "de horas establecidas en el diseño curricular, favor no programar más.";
          } else {
            nota.style.display = "none";
            nota.textContent = "";
          }
        }

        // Actualizar el nombre del programa para incluir el nivel de formación
        const nombreProgramaEl = document.getElementById("nombrePrograma");
        if (nombreProgramaEl && nivelFormacionGlobal) {
          const nombreActual = nombreProgramaEl.textContent;
          nombreProgramaEl.textContent = `${nivelFormacionGlobal} - ${nombreActual}`;
        }


        // Dibujar gráfico % Competencias con Horas (Total vs Diseño)
        dibujarGraficoCompetenciasHoras();

        return filasCargadas;
      }

      // =========================
      // Función para dibujar el gráfico % Competencias con Horas
      // =========================
      // =========================
      // Función para dibujar el gráfico % Competencias con Horas (Total vs Diseño)
      // =========================
      function dibujarGraficoCompetenciasHoras() {
        const contenedor = document.getElementById("chartCompetenciasHorasContainer");
        if (!contenedor) return;

        // Tomamos los datos desde la tabla #tbodyReporte2
        const filas = document.querySelectorAll("#tbodyReporte2 tr");
        if (!filas || filas.length === 0) {
          contenedor.innerHTML = "";
          chartCompetenciasHoras = null;
          return;
        }

        const dataTotal = []; // % cubierto (Total / Diseño)
        const dataRestante = []; // % restante hasta el 100 %

        filas.forEach(fila => {
          const celdas = fila.getElementsByTagName("td");
          if (celdas.length < 9) return;

          const competenciaTexto = celdas[1].textContent.trim();
          const categoria = getCategoria(competenciaTexto);
          // Indices: 0:#, 1:Comp, 2:Tipo, 3:Total, 4:Diseño, 5:%
          const totalHoras = parseFloat(celdas[6].textContent) || 0;
          const horasDiseno = parseFloat(celdas[7].textContent) || 0;

          // Si ambas son cero, no tiene sentido mostrarla
          if (totalHoras === 0 && horasDiseno === 0) return;

          const competenciaCorta = competenciaTexto.length > 40 ? competenciaTexto.substring(0, 40) + "…" : competenciaTexto;

          // Cálculo de Porcentajes
          let porcentajeReal = 0;
          if (horasDiseno > 0) {
            porcentajeReal = (totalHoras / horasDiseno) * 100;
          }
          // Para stacked 100%, la suma de las partes debe ser 100 (o proporcional). 
          // Aquí dividimos en "Ejecutado" y "Faltante".
          // Si ejecutado > 100%, clamp a 100 para la visual (y barra roja).
          let porcentajeVisual = porcentajeReal > 100 ? 100 : porcentajeReal;

          const colorPrincipal = getColorCategoriaGrafico(categoria);
          const colorBarra = (porcentajeReal > 100) ? "#ef4444" : colorPrincipal;

          dataTotal.push({
            label: competenciaCorta,
            fullLabel: competenciaTexto,
            categoria: categoria,
            y: porcentajeVisual,
            porcentajeReal: porcentajeReal,
            color: colorBarra,
            horasTotal: totalHoras,
            horasDiseno: horasDiseno
          });

          dataRestante.push({
            label: competenciaCorta,
            fullLabel: competenciaTexto,
            categoria: categoria,
            y: 100 - porcentajeVisual,
            color: "#d1d5db",
            horasTotal: totalHoras,
            horasDiseno: horasDiseno
          });
        });

        // Altura dinámica
        const alturaMinima = 300;
        const alturaPorBarra = 30;
        let alturaGrafico = alturaPorBarra * dataTotal.length + 60;
        if (alturaGrafico < alturaMinima) alturaGrafico = alturaMinima;
        contenedor.style.height = alturaGrafico + "px";

        chartCompetenciasHoras = new CanvasJS.Chart("chartCompetenciasHorasContainer", {
          animationEnabled: true,
          exportEnabled: true,
          height: alturaGrafico,
          axisX: {
            labelFontSize: 11,
            labelMaxWidth: 350,
            labelWrap: true,
            interval: 1,
            gridThickness: 0,
            tickLength: 0
          },
          axisY: {
            minimum: 0,
            maximum: 100,
            suffix: "%",
            interval: 20,
            gridThickness: 1
          },
          legend: {
            verticalAlign: "top",
            horizontalAlign: "left",
            dockInsidePlotArea: true,
            fontSize: 12
          },
          toolTip: {
            shared: true,
            content: function (e) {
              // Buscamos el dataPoint de la serie principal (dataTotal)
              let dp = null;
              for (let i = 0; i < e.entries.length; i++) {
                if (e.entries[i].dataSeries.name === "Total de Horas vs Diseño") {
                  dp = e.entries[i].dataPoint;
                  break;
                }
              }
              if (!dp) dp = e.entries[0].dataPoint;

              const nom = dp.fullLabel || dp.label;
              const cat = dp.categoria || "";
              const real = (typeof dp.porcentajeReal === "number") ? dp.porcentajeReal : dp.y;

              return "<strong>" + nom + "</strong><br/>" +
                "Categoría: " + cat + "<br/>" +
                "Total Horas: " + dp.horasTotal.toFixed(2) + "<br/>" +
                "Horas Diseño: " + dp.horasDiseno.toFixed(2) + "<br/>" +
                "Cumplimiento: " + real.toFixed(2) + "%";
            }
          },
          data: [
            {
              type: "stackedBar100",
              name: "Total de Horas vs Diseño",
              showInLegend: true,
              yValueFormatString: "##0.0\"%\"",
              indexLabel: "{y}%",
              indexLabelPlacement: "inside",
              indexLabelFontColor: "#ffffff",
              indexLabelFontSize: 11,
              indexLabelFontWeight: "bold",
              dataPoints: dataTotal
            },
            {
              type: "stackedBar100",
              name: "Horas restantes",
              showInLegend: true,
              yValueFormatString: "##0.0\"%\"",
              dataPoints: dataRestante
            }
          ]
        });

        chartCompetenciasHoras.render();
      }




      // =========================
      // Función para generar el Cronograma Gantt de Competencias Pendientes en Reporte 4
      // =========================
      function generarGanttPendientes(arrComp2) {
        const contenedor = document.getElementById("ganttContainerPendientes");
        if (!contenedor) return;
        arrComp2CachePendientes = Array.isArray(arrComp2) ? arrComp2 : [];
        const pendientesOrden = arrComp2CachePendientes.filter(obj => obj.programada === "No");
        if (!pendientesOrden.length) {
          contenedor.innerHTML =
            "<div style='padding:16px; text-align:center; color:#4b5563;'>No hay competencias pendientes definidas.</div>";
          return;
        }

        let ultimaFechaProg = null;
        registrosGlobal.forEach(r => {
          if (r.fechaFinProg) {
            const f = parseFecha(r.fechaFinProg);
            if (!ultimaFechaProg || f > ultimaFechaProg) {
              ultimaFechaProg = f;
            }
          }
        });
        if (!ultimaFechaProg) {
          contenedor.innerHTML =
            "<div style='padding:16px; text-align:center; color:#4b5563;'>No se encontraron fechas programadas.</div>";
          return;
        }

        const inicioPendientes = new Date(ultimaFechaProg.getFullYear(), ultimaFechaProg.getMonth(), 1);
        inicioPendientes.setMonth(inicioPendientes.getMonth() + 1);

        const limitePendientes = new Date(
          fechaInicioProductivaGlobal.getFullYear(),
          fechaInicioProductivaGlobal.getMonth(),
          1
        );

        const crearEntrada = (nombre, tipoTexto) => ({
          nombre,
          tipo: tipoTexto,
          categoria: normalizarCategoriaGantt(tipoTexto)
        });

        let pendientesTransversales = [];
        let pendientesTecnicas = [];
        let pendientePractica = null;

        pendientesOrden.forEach(obj => {
          if (obj.comp.toUpperCase().includes("ETAPA PRACTICA")) {
            pendientePractica = crearEntrada("RESULTADOS DE APRENDIZAJE ETAPA PRACTICA", "Práctica");
          } else {
            const cat = getCategoria(obj.comp);
            if (cat === "Transversales") {
              pendientesTransversales.push(crearEntrada(obj.comp, "Transversales"));
            } else {
              pendientesTecnicas.push(crearEntrada(obj.comp, "Técnicas"));
            }
          }
        });

        let pointerTransversal = new Date(inicioPendientes);
        let countInMonthTransversal = 0;
        pendientesTransversales.forEach(entry => {
          if (pointerTransversal > limitePendientes) {
            entry.inicio = new Date(limitePendientes);
            entry.fin = new Date(limitePendientes);
          } else {
            entry.inicio = new Date(pointerTransversal);
            entry.fin = new Date(pointerTransversal);
            countInMonthTransversal++;
            if (countInMonthTransversal === 3) {
              pointerTransversal.setMonth(pointerTransversal.getMonth() + 1);
              countInMonthTransversal = 0;
            }
            if (pointerTransversal > limitePendientes) {
              pointerTransversal = new Date(limitePendientes);
            }
          }
        });

        let pointerTecnica = new Date(inicioPendientes);
        pendientesTecnicas.forEach(entry => {
          const mesesDisponibles =
            (limitePendientes.getFullYear() - pointerTecnica.getFullYear()) * 12 +
            (limitePendientes.getMonth() - pointerTecnica.getMonth()) + 1;
          let duracion = 3;
          if (mesesDisponibles < 3) {
            duracion = mesesDisponibles;
          }
          if (pointerTecnica > limitePendientes) {
            entry.inicio = new Date(limitePendientes);
            entry.fin = new Date(limitePendientes);
          } else {
            entry.inicio = new Date(pointerTecnica);
            entry.fin = new Date(
              pointerTecnica.getFullYear(),
              pointerTecnica.getMonth() + (duracion - 1),
              1
            );
            pointerTecnica.setMonth(pointerTecnica.getMonth() + duracion);
            if (pointerTecnica > limitePendientes) {
              pointerTecnica = new Date(limitePendientes);
            }
          }
        });

        if (pendientePractica) {
          pendientePractica.inicio = fechaInicioProductivaGlobal;
          pendientePractica.fin = new Date(
            fechaInicioProductivaGlobal.getFullYear(),
            fechaInicioProductivaGlobal.getMonth() + 7 - 1,
            1
          );
        }

        let programacionPendientes = [].concat(pendientesTransversales, pendientesTecnicas);
        if (pendientePractica) {
          programacionPendientes.push(pendientePractica);
        }

        const textoFiltro = (filtrosGanttPendientes.texto || "").trim().toLowerCase();
        const categoriasActivas = filtrosGanttPendientes.categorias;
        const programacionFiltrada = programacionPendientes.filter(entry => {
          const catKey = entry.categoria || "";
          if (catKey && Object.prototype.hasOwnProperty.call(categoriasActivas, catKey) && !categoriasActivas[catKey]) {
            return false;
          }
          if (textoFiltro && !(entry.nombre || "").toLowerCase().includes(textoFiltro)) {
            return false;
          }
          return true;
        });

        const mesesAbrev = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
        let etiquetasMeses = [];
        let cursor = new Date(inicioPendientes.getFullYear(), inicioPendientes.getMonth(), 1);
        const finMes = new Date(limitePendientes.getFullYear(), limitePendientes.getMonth(), 1);
        while (cursor <= finMes) {
          etiquetasMeses.push(new Date(cursor));
          cursor.setMonth(cursor.getMonth() + 1);
        }

        const totalColumns = 2 + etiquetasMeses.length;
        let html = "<table class='tabla-gantt-detalle'>";
        html += "<thead><tr>";
        html += "<th>#</th>";
        html += "<th>Competencia</th>";
        etiquetasMeses.forEach(m => {
          const label = mesesAbrev[m.getMonth()] + "-" + m.getFullYear();
          html += `<th>${label}</th>`;
        });
        html += "</tr></thead><tbody>";

        if (!programacionFiltrada.length) {
          html += `<tr><td colspan="${totalColumns}" style="text-align:center; padding:18px;">` +
            "No hay competencias pendientes que coincidan con los filtros." +
            "</td></tr>";
        } else {
          let index = 1;
          programacionFiltrada.forEach(entry => {
            html += "<tr>";
            html += `<td style='text-align:center;'>${index++}</td>`;
            html += `<td>${entry.nombre}</td>`;
            const colorBarra = obtenerColorParaTipo(entry.tipo);
            etiquetasMeses.forEach(m => {
              const year = m.getFullYear();
              const month = m.getMonth();
              const startYear = entry.inicio.getFullYear();
              const startMonth = entry.inicio.getMonth();
              const endYear = entry.fin.getFullYear();
              const endMonth = entry.fin.getMonth();
              const inRange =
                (year > startYear || (year === startYear && month >= startMonth)) &&
                (year < endYear || (year === endYear && month <= endMonth));
              if (inRange) {
                html += `<td class='gantt-month-cell'><span class='gantt-month-bar' style='background-color:${colorBarra};'></span></td>`;
              } else {
                html += "<td class='gantt-month-cell'></td>";
              }
            });
            html += "</tr>";
          });
        }

        html += "</tbody></table>";

        contenedor.innerHTML = html;
      }

      // =========================
      // Generar Reporte 5: Competencias Pendientes por Evaluar agrupado por categoría
      // =========================
      function generarReporte5() {
        const categoriasProg = { "Práctica": [], "Transversales": [], "Inglés": [], "Técnicas": [] };
        Object.values(gruposProgramadas).forEach(grupo => {
          const cat = getCategoria(grupo.competencia);
          if (!categoriasProg[cat]) categoriasProg[cat] = [];
          categoriasProg[cat].push({ grupo, tipo: "programada" });
        });

        const categoriasPend = { "Práctica": [], "Transversales": [], "Inglés": [], "Técnicas": [] };
        Object.values(gruposPendientes).forEach(grupo => {
          const cat = getCategoria(grupo.competencia);
          if (!categoriasPend[cat]) categoriasPend[cat] = [];
          categoriasPend[cat].push({ grupo, tipo: "pendiente" });
        });

        const tbodyProg = document.getElementById("tbodyProgramadas");
        if (!tbodyProg) return;
        tbodyProg.innerHTML = "";
        const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];
        let contador = 1;

        ordenCategorias.forEach(cat => {
          const filasCategoria = [];
          if (categoriasProg[cat]) filasCategoria.push(...categoriasProg[cat]);
          if (categoriasPend[cat]) filasCategoria.push(...categoriasPend[cat]);
          if (!filasCategoria.length) return;

            filasCategoria.forEach(item => {
              const { grupo, tipo } = item;
              const nombresArray = Array.from(grupo.nombres).sort();
              const cantidad = nombresArray.length;
              const tr = document.createElement("tr");
              const infoFecha = obtenerDatosFechaCompetencia(grupo.competencia) || {};
              let tipoTexto = obtenerEtiquetaTipoCompetencia(grupo.competencia) || "-";
              let fechaInicioTexto = infoFecha.fechaInicioTexto || "-";
              let fechaFinTexto = infoFecha.fechaTexto || "-";
              let diasHtml = infoFecha.diasHtml || "-";
              let diasColor = infoFecha.diasColor || "";
              let fechaInicioSort =
                infoFecha.fechaInicio instanceof Date && !isNaN(infoFecha.fechaInicio.getTime())
                  ? infoFecha.fechaInicio.getTime()
                  : "";
              let fechaFinSort =
                infoFecha.fecha instanceof Date && !isNaN(infoFecha.fecha.getTime())
                  ? infoFecha.fecha.getTime()
                  : "";
              const competenciaTexto = (grupo.competencia || "").trim();
              const competenciaSort = competenciaTexto.toLowerCase();
              if (tipo === "pendiente") {
                tr.classList.add("fila-pendiente");
                fechaFinTexto = "-";
                fechaFinSort = "";
                fechaInicioTexto = "-";
                fechaInicioSort = "";
                diasHtml = "-";
                diasColor = "pendiente";
              }
              tr.innerHTML = `
                  <td>${contador++}</td>
                  <td data-sort-value="${competenciaSort}">${grupo.competencia}</td>
                  <td>${tipoTexto}</td>
                  <td data-sort-value="${fechaInicioSort}">${fechaInicioTexto}</td>
                  <td data-sort-value="${fechaFinSort}">${fechaFinTexto}</td>
                  <td class="col-dias" data-color="${diasColor}">${diasHtml}</td>
                  <td>${grupo.rap}</td>
                  <td>${nombresArray.join(", ")}</td>
                  <td>${cantidad}</td>
                `;
              tbodyProg.appendChild(tr);
            });
        });

        aplicarFiltrosReporte5();
      }

      // =========================
      // Reporte 8: resumen + una tabla por aprendiz
      // =========================
      function generarReporte8PendientesPorAprendizInstructor() {
        // Normaliza texto: mayúsculas, sin tildes, sin espacios extra
        const normalizarTexto = (texto) => {
          return (texto || "")
            .toString()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase()
            .trim()
            .replace(/\s+/g, " ");
        };
        // Obtiene TODOS los nombres de funcionario(s) que evaluaron (sin cédula ni prefijos)
        const obtenerNombresDesdeFuncionario = (funcionario) => {
          if (!funcionario) return [];
          const texto = funcionario.toString();
          const nombres = [];

          // Separa por coma cada funcionario
          texto.split(",").forEach(fragmento => {
            // De cada fragmento toma lo que va después del último "-"
            const nombreParte = fragmento.split("-").pop();
            const nombreNormalizado = normalizarTexto(nombreParte);
            if (nombreNormalizado) {
              nombres.push(nombreNormalizado);
            }
          });

          return nombres;
        };


        // Competencia objetivo del resumen
        const claveResultadosPractica = normalizeCompetencia("RESULTADOS DE APRENDIZAJE ETAPA PRACTICA");

        const totalRapsHeader = Number(document.getElementById("numResultadosHeader")?.textContent || "0");
        const totalRaps =
          typeof totalRapsGlobal === "number" && totalRapsGlobal > 0 ? totalRapsGlobal : totalRapsHeader;

        const conteoJuiciosPorAprendiz = {};
        if (Array.isArray(registrosJuicios)) {
          registrosJuicios.forEach(r => {
            const numDoc = (r.numDoc || "").toString().trim();
            const nombreCompleto = ((r.nombre || "") + " " + (r.apellidos || "")).trim();
            const claveAprendiz = numDoc + "|" + nombreCompleto;
            if (!claveAprendiz.trim()) return;

            if (!conteoJuiciosPorAprendiz[claveAprendiz]) {
              conteoJuiciosPorAprendiz[claveAprendiz] = {
                nombreCompleto,
                aprobado: 0,
                porEvaluar: 0,
                noAprobado: 0
              };
            }

            const juicioN = normalizarTexto(r.juicioEval);
            if (juicioN === "APROBADO") {
              conteoJuiciosPorAprendiz[claveAprendiz].aprobado++;
            } else if (juicioN === "POR EVALUAR") {
              conteoJuiciosPorAprendiz[claveAprendiz].porEvaluar++;
            } else if (juicioN === "NO APROBADO") {
              conteoJuiciosPorAprendiz[claveAprendiz].noAprobado++;
            }
          });
        }

        // Determina si una competencia está programada (misma lógica que Reporte 4)
        const esCompetenciaProgramada = (compTexto) => {
          if (!compTexto) return false;

          const compNorm = normalizeCompetencia(compTexto);
          let programada = competenciasSetNormalizado.has(compNorm) ? "Sí" : "No";

          // Regla especial de protección ambiental
          if (compNorm.includes("APLICAR PRACTICAS DE PROTECCION AMBIENTAL")) {
            let horas = 0;
            for (const [compRaw, total] of Object.entries(competenciasMap)) {
              if (normalizeCompetencia(compRaw) === compNorm) {
                horas = total;
                break;
              }
            }
            if (horas < 40) {
              programada = "No";
            }
          }
          return programada === "Sí";
        };

        // 1) Filtrar juicios: solo EN FORMACION o CONDICIONADO y POR EVALUAR
        const filtrados = registrosJuicios.filter(r => {
          const estadoN = normalizarTexto(r.estado);
          const juicioN = normalizarTexto(r.juicioEval);

          return (
            (estadoN === "EN FORMACION" || estadoN === "CONDICIONADO") &&
            juicioN === "POR EVALUAR"
          );
        });

        const nombresSoloPractica = [...new Set(
          Object.values(pazSalvoMap)
            .map(ap => (ap.nombreCompleto || "").trim())
            .filter(Boolean)
        )].sort((a, b) =>
          a.toUpperCase().localeCompare(b.toUpperCase())
        );

        // 2) Mapa Competencia -> Instructores (desde el primer archivo)
        const mapaInstructoresPorComp = {};
        (registrosGlobal || []).forEach(reg => {
          const compKey = normalizeCompetencia(reg.competencia || "");
          if (!compKey) return;

          if (!mapaInstructoresPorComp[compKey]) {
            mapaInstructoresPorComp[compKey] = new Set();
          }

          const nombreInst = (
            (reg.nombreInstructor || "") + " " + (reg.apellidoInstructor || "")
          ).trim();

          if (nombreInst) {
            mapaInstructoresPorComp[compKey].add(nombreInst);
          }
        });

        // 2A) Mapa Competencia -> Funcionarios que han evaluado (desde el archivo de juicios)
        // 2A) Mapa Competencia -> Funcionarios que han evaluado (desde el archivo de juicios)
        const mapaFuncionariosPorComp = {};
        (registrosJuicios || []).forEach(reg => {
          const compKeyJ = normalizeCompetencia(reg.competencia || "");
          if (!compKeyJ) return;

          // Ahora puede haber varios funcionarios en la misma celda
          const nombresNorm = obtenerNombresDesdeFuncionario(reg.funcionario || "");
          if (nombresNorm.length === 0) return;

          if (!mapaFuncionariosPorComp[compKeyJ]) {
            mapaFuncionariosPorComp[compKeyJ] = new Set();
          }

          nombresNorm.forEach(nombre => {
            mapaFuncionariosPorComp[compKeyJ].add(nombre);
          });
        });


        // 2B) Competencias donde existe al menos un funcionario
        //     diferente a los instructores programados
        const mapaCompConFuncionarioNoProgramado = {};
        Object.keys(mapaFuncionariosPorComp).forEach(compKeyJ => {
          const funcionariosSet = mapaFuncionariosPorComp[compKeyJ];
          const progSet = mapaInstructoresPorComp[compKeyJ] || new Set();

          // Normalizamos nombres de instructores programados
          const progNormSet = new Set();
          progSet.forEach(nombreInst => {
            progNormSet.add(normalizarTexto(nombreInst));
          });

          for (const funcNorm of funcionariosSet) {
            // Si el funcionario que evaluó NO está entre los programados,
            // marcamos esta competencia como "alerta"
            if (!progNormSet.has(funcNorm)) {
              mapaCompConFuncionarioNoProgramado[compKeyJ] = true;
              break;
            }
          }
        });

        // 3) Pivot por aprendiz, guardando SOLO competencias PROGRAMADAS
      const pivot = {};
      filtrados.forEach(r => {
        const numDoc = r.numDoc || "";
        const nombreCompleto = ((r.nombre || "") + " " + (r.apellidos || "")).trim();
        const claveAprendiz = numDoc + "|" + nombreCompleto;

        const compTexto = (r.competencia || "").trim();
        if (!compTexto) return;

        // --- INICIO CORRECCIÓN ---
        const compKey = normalizeCompetencia(compTexto);
        
        // Verificar si es Etapa Práctica (para permitirla aunque no esté programada)
        const esPractica = compKey.includes("ETAPA PRACTICA");

        // --- FIN CORRECCIÓN ---

        if (!compKey) return;

        if (!pivot[claveAprendiz]) {
          pivot[claveAprendiz] = {
            numDoc,
            nombreCompleto,
            competencias: {} // compKey -> { texto }
          };
        }

        // Guardar competencia solo una vez por aprendiz en el detalle
        if (!pivot[claveAprendiz].competencias[compKey]) {
          pivot[claveAprendiz].competencias[compKey] = {
            texto: compTexto
          };
        }
      });

        // 4) Ordenar aprendices por nombre para el detalle
        const filasAprendices = Object.values(pivot).sort((a, b) =>
          a.nombreCompleto.toUpperCase().localeCompare(b.nombreCompleto.toUpperCase())
        );

        // Referencias DOM
        const contVisible = document.getElementById("contenedorTablasReporte8");
        const contResumen = document.getElementById("contenedorResumenPracticaReporte8");
        const tbodyExport = document.getElementById("tbodyReporte8");

        // NUEVO: tabla resumen por instructor / competencia
        const tbodyPendInstr = document.getElementById("tbodyPendientesInstructorReporte8");
        const tablaPendInstr = document.getElementById("tablaPendientesInstructorReporte8");
        const tituloPendInstr = document.getElementById("tituloListadoPendientesR8");

        if (!contVisible || !contResumen || !tbodyExport) return;

        contVisible.innerHTML = "";
        contResumen.innerHTML = "";
        tbodyExport.innerHTML = "";

        if (tbodyPendInstr) tbodyPendInstr.innerHTML = "";
        if (tablaPendInstr) tablaPendInstr.style.display = "none";
        if (tituloPendInstr) tituloPendInstr.style.display = "none";


        let contador = 1;

        // ========================
        // 4A. Tabla RESUMEN (solo quienes tienen
        // RESULTADOS DE APRENDIZAJE ETAPA PRACTICA pendiente)
        // ========================


        // nombresSoloPractica ya viene calculado arriba en procesarReporte8
        const aprendicesSoloPractica = filasAprendices.filter(a =>
          nombresSoloPractica.includes(a.nombreCompleto)
        );
        const cantidadSoloPractica = aprendicesSoloPractica.length;

        const spanListosProductiva = document.getElementById("numAprendicesListosProductivaHeader");
        const spanNoListosProductiva = document.getElementById("numAprendicesNoListosProductivaHeader");
        if (spanListosProductiva) {
          spanListosProductiva.textContent = cantidadSoloPractica.toString();
        }
        if (spanNoListosProductiva) {
          const aprendicesActivos = filasAprendices.length;
          spanNoListosProductiva.textContent = Math.max(0, aprendicesActivos - cantidadSoloPractica).toString();
        }
        if (cantidadSoloPractica > 0) {

          // Tomamos de filasAprendices la info de documento + nombre
          // Texto de resumen
          const textoResumen = document.createElement("p");
          textoResumen.className = "texto-resumen-practica";
          textoResumen.textContent =
            `Los siguientes ${cantidadSoloPractica} aprendices tienen exactamente un RAP marcado como "Por evaluar" ` +
            `en el reporte "% Avance por Aprendiz", por lo que están catalogados como aptos para generar el Paz y Salvo.`;
          contResumen.appendChild(textoResumen);

          // Tabla tipo lista con checkboxes
          const tablaResumen = document.createElement("table");
          tablaResumen.className = "tabla-resumen-practica";

          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");

          const thChk = document.createElement("th");
          const chkTodos = document.createElement("input");
          chkTodos.type = "checkbox";
          chkTodos.id = "chkResumenPracticaTodos";
          thChk.appendChild(chkTodos);

          const thNombre = document.createElement("th");
          thNombre.textContent = "Nombre del Aprendiz";

          trHead.appendChild(thChk);
          trHead.appendChild(thNombre);
          thead.appendChild(trHead);
          tablaResumen.appendChild(thead);

          const tbody = document.createElement("tbody");

          aprendicesSoloPractica.forEach((ap, idx) => {
            const tr = document.createElement("tr");
            tr.className = "fila-resumen-practica";
            tr.dataset.index = String(idx);

            const tdChk = document.createElement("td");
            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.className = "chk-resumen-practica";
            chk.checked = true;
            tdChk.appendChild(chk);

            const tdNombre = document.createElement("td");
            tdNombre.textContent = ap.nombreCompleto;
            tdNombre.className = "col-nombre-resumen";

            tr.appendChild(tdChk);
            tr.appendChild(tdNombre);
            tbody.appendChild(tr);
          });

          tablaResumen.appendChild(tbody);
          contResumen.appendChild(tablaResumen);

          // Seleccionar / deseleccionar todos
          chkTodos.addEventListener("change", () => {
            const checks = tablaResumen.querySelectorAll(".chk-resumen-practica");
            checks.forEach(chk => {
              chk.checked = chkTodos.checked;
            });
          });

          // Contenedor del botón
          const contBoton = document.createElement("div");
          contBoton.style.marginTop = "12px";
          contBoton.style.textAlign = "right";

          const btnPaz = document.createElement("button");
          btnPaz.id = "btnDescargarPazYSalvo";
          btnPaz.textContent = "Descargar paz y salvo";
          btnPaz.className = "btnEstilo"; // reutiliza el estilo de botones que ya tienes

          contBoton.appendChild(btnPaz);
          contResumen.appendChild(contBoton);

          // Click en "Descargar paz y salvo"
          btnPaz.addEventListener("click", () => {
            const seleccionados = [];
            const filasTabla = tablaResumen.querySelectorAll("tbody tr.fila-resumen-practica");

            filasTabla.forEach(fila => {
              const chk = fila.querySelector(".chk-resumen-practica");
              const indexStr = fila.dataset.index;
              const index = indexStr ? parseInt(indexStr, 10) : NaN;

              if (chk && chk.checked && !Number.isNaN(index) && aprendicesSoloPractica[index]) {
                seleccionados.push({
                  nombreCompleto: aprendicesSoloPractica[index].nombreCompleto,
                  numDoc: aprendicesSoloPractica[index].numDoc
                });
              }
            });

            // Si no se marcó ninguno, se usan todos los de la lista
            const listaFinal = seleccionados.length > 0
              ? seleccionados
              : aprendicesSoloPractica.map(ap => ({
                nombreCompleto: ap.nombreCompleto,
                numDoc: ap.numDoc
              }));

            if (!listaFinal.length) {
              alert("No hay aprendices seleccionados para generar el paz y salvo.");
              return;
            }

            generarPazYSalvoPDF(listaFinal);
          });

        } else {
          const textoSinDatos = document.createElement("p");
          textoSinDatos.className = "texto-resumen-practica";
          textoSinDatos.textContent =
            "No hay aprendices que tengan únicamente la competencia de etapa práctica pendiente.";
          contResumen.appendChild(textoSinDatos);
        }

        // ========================
        // 4B. Tabla ÚNICA (visible) + detalle para exportar
        //      - Una sola tabla
        //      - Sin encabezados repetidos
        //      - Nombre y documento NO combinados (se repiten por fila)
        // ========================

        // Crear una sola tabla visible
        const tablaUnica = document.createElement("table");
        tablaUnica.className = "tabla-aprendiz-reporte8";
        tablaUnica.id = "tablaReporte8Visible";

        const theadUnico = document.createElement("thead");
        theadUnico.innerHTML = `
        <tr>
          <th>#</th>
          <th>Documento</th>
          <th>Nombre del Aprendiz</th>
          <th>Tipo</th>
          <th>Competencias Pendientes por Evaluar</th>
          <th>Fecha de inicio</th>
          <th>Fecha Terminacion</th>
          <th>Dias</th>
          <th>Instructor que impartió la competencia</th>
        </tr>
      `;
        tablaUnica.appendChild(theadUnico);

        const tbodyUnico = document.createElement("tbody");

        // Recorremos todos los aprendices y TODAS sus competencias pendientes
        filasAprendices.forEach(aprendiz => {
          const competenciasArray = Object.entries(aprendiz.competencias); // [ [compKey, {texto}], ... ]
          if (competenciasArray.length === 0) return;

          competenciasArray.forEach(([compKey, compObj]) => {
            const instSet = mapaInstructoresPorComp[compKey];
            const instructoresStr = instSet ? Array.from(instSet).join(", ") : "";
            const infoFecha = obtenerDatosFechaCompetencia(compObj.texto);

            // --------- Fila VISIBLE en la tabla única ---------
            const tr = document.createElement("tr");

            const tipoTexto = getCategoria(compObj.texto);
            const tipoKey = normalizarCategoriaGantt(tipoTexto || compObj.texto);
            tr.dataset.tipo = tipoKey;

            const tdNum = document.createElement("td");
            tdNum.textContent = contador;

            const tdDoc = document.createElement("td");
            tdDoc.textContent = aprendiz.numDoc;

            const tdNom = document.createElement("td");
            tdNom.textContent = aprendiz.nombreCompleto;

            const tdTipo = document.createElement("td");
            tdTipo.textContent = tipoTexto || "";

            const tdComp = document.createElement("td");
            tdComp.textContent = compObj.texto;

            const tdInicio = document.createElement("td");
            tdInicio.textContent = infoFecha.fechaInicioTexto;
            if (infoFecha.fechaInicio instanceof Date && !isNaN(infoFecha.fechaInicio.getTime())) {
              tdInicio.setAttribute("data-sort-value", String(infoFecha.fechaInicio.getTime()));
            }

            const tdFecha = document.createElement("td");
            tdFecha.textContent = infoFecha.fechaTexto;
            if (infoFecha.fecha instanceof Date && !isNaN(infoFecha.fecha.getTime())) {
              tdFecha.setAttribute("data-sort-value", String(infoFecha.fecha.getTime()));
            }

            const tdDias = document.createElement("td");
            tdDias.innerHTML = infoFecha.diasHtml || "-";
            tdDias.classList.add("col-dias");
            if (infoFecha.diasColor) {
              tdDias.dataset.color = infoFecha.diasColor;
            }

            const tdInst = document.createElement("td");
            tdInst.textContent = instructoresStr;

            tr.appendChild(tdNum);
            tr.appendChild(tdDoc);
            tr.appendChild(tdNom);
            tr.appendChild(tdTipo);
            tr.appendChild(tdComp);
            tr.appendChild(tdInicio);
            tr.appendChild(tdFecha);
            tr.appendChild(tdDias);
            tr.appendChild(tdInst);

            tbodyUnico.appendChild(tr);

            // --------- Fila OCULTA para EXPORTAR (misma estructura, sin celdas vacías) ---------
            const trExp = document.createElement("tr");
            trExp.innerHTML = `
            <td>${contador}</td>
            <td>${aprendiz.numDoc}</td>
            <td>${aprendiz.nombreCompleto}</td>
            <td>${tipoTexto || ""}</td>
            <td>${compObj.texto}</td>
            <td>${infoFecha.fechaInicioTexto}</td>
            <td>${infoFecha.fechaTexto}</td>
            <td>${infoFecha.diasTexto || "-"}</td>
            <td>${instructoresStr}</td>
          `;
            tbodyExport.appendChild(trExp);

            // El consecutivo ahora es por fila, no por aprendiz
            contador++;
          });
        });

        tablaUnica.appendChild(tbodyUnico);
        contVisible.appendChild(tablaUnica);
        actualizarCantidadFilasVisibles("contenedorTablasReporte8", "totalRegistrosReporte8");

        // Habilitar ordenamiento (˄ ˅) en la tabla visible
        setupTablaOrdenable(
          tablaUnica,
          ["number", "text", "text", "text", "text", "date", "date", "number", "text"]
        );


        // ========================
        // 4C. Resumen por Instructor / Competencia (agrupado y por categorías)
        // ========================
        if (tbodyPendInstr && filasAprendices.length > 0) {
          // Mapa: (instructor(es) normalizado, competenciaKey) -> conjunto de aprendices
          const mapaPorInstructor = {};
          // key: "INSTRUCTOR_NORMALIZADO||compKey"

          filasAprendices.forEach(aprendiz => {
            const nombreAprendiz = aprendiz.nombreCompleto || "";

            Object.entries(aprendiz.competencias).forEach(([compKey, compObj]) => {
              const instSet = mapaInstructoresPorComp[compKey];
              const instructoresStr = instSet && instSet.size > 0
                ? Array.from(instSet).join(", ")
                : "Sin instructor asignado";

              const competenciaTexto = compObj.texto || "";

              // Clave de agrupación normalizada para evitar duplicados visualmente iguales
              const claveGrupo = `${normalizarTexto(instructoresStr)}||${compKey}`;

              if (!mapaPorInstructor[claveGrupo]) {
                mapaPorInstructor[claveGrupo] = {
                  instructores: instructoresStr,
                  competencia: competenciaTexto,
                  competenciaKey: compKey,
                  aprendices: new Set()
                };
              } else {
                // Si no teníamos texto "bonito" de competencia, lo actualizamos
                if (!mapaPorInstructor[claveGrupo].competencia && competenciaTexto) {
                  mapaPorInstructor[claveGrupo].competencia = competenciaTexto;
                }
              }

              if (nombreAprendiz) {
                mapaPorInstructor[claveGrupo].aprendices.add(nombreAprendiz);
              }
            });
          });

          const filasResumenInstructor = Object.values(mapaPorInstructor);
          if (filasResumenInstructor.length === 0) {
            if (tablaPendInstr) tablaPendInstr.style.display = "none";
            if (tituloPendInstr) tituloPendInstr.style.display = "none";
            return;
          }

          // Agrupamos ahora por categoría (Práctica, Transversales, Inglés, Técnicas)
          const categorias = {
            "Práctica": [],
            "Transversales": [],
            "Inglés": [],
            "Técnicas": []
          };

          filasResumenInstructor.forEach(item => {
            const textoComp = item.competencia || item.competenciaKey || "";

            // Obtenemos la clave de competencia que se usa en los mapas
            const compKeyItem = item.competenciaKey || normalizeCompetencia(textoComp);

            // Marcamos si para esta competencia hay evaluaciones hechas por
            // un funcionario NO programado como instructor
            item.alertaInstructorDiferente = !!mapaCompConFuncionarioNoProgramado[compKeyItem];

            const categoria = getCategoria(textoComp);
            if (!categorias[categoria]) {
              categorias[categoria] = [];
            }
            categorias[categoria].push(item);
          });


          // Limpiamos tbody por si acaso y construimos por secciones
          const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];
          const filasOrdenadas = [];

          ordenCategorias.forEach(cat => {
            const lista = categorias[cat] || [];
            if (!lista.length) return;
            lista.sort((a, b) => {
              const instA = (a.instructores || "").toUpperCase();
              const instB = (b.instructores || "").toUpperCase();
              if (instA < instB) return -1;
              if (instA > instB) return 1;
              const compA = (a.competencia || "").toUpperCase();
              const compB = (b.competencia || "").toUpperCase();
              return compA.localeCompare(compB);
            });
            lista.forEach(item => filasOrdenadas.push(item));
          });

          if (!filasOrdenadas.length) {
            if (tablaPendInstr) tablaPendInstr.style.display = "none";
            if (tituloPendInstr) tituloPendInstr.style.display = "none";
            return;
          }

          tbodyPendInstr.innerHTML = "";
          let contadorInstr = 1;

          filasOrdenadas.forEach(item => {
            const listaAprendices = Array.from(item.aprendices)
              .sort((a, b) => a.toUpperCase().localeCompare(b.toUpperCase()))
              .join(" - ");

            const tipoTexto = getCategoria(item.competencia);
            const tipoKey = normalizarCategoriaGantt(tipoTexto || item.competencia);

            const tr = document.createElement("tr");
            if (tipoKey) {
              tr.dataset.tipo = tipoKey;
            }

            const infoFecha = obtenerDatosFechaCompetencia(item.competencia);
            const diasHtml = infoFecha.diasHtml || "-";
            const fechaInicioTexto = infoFecha.fechaInicioTexto || "-";
            const fechaFinTexto = infoFecha.fechaTexto || "-";
            const fechaInicioSort = (infoFecha.fechaInicio instanceof Date && !isNaN(infoFecha.fechaInicio.getTime()))
              ? infoFecha.fechaInicio.getTime()
              : "";
            const fechaFinSort = (infoFecha.fecha instanceof Date && !isNaN(infoFecha.fecha.getTime()))
              ? infoFecha.fecha.getTime()
              : "";

            tr.innerHTML = `
              <td>${contadorInstr}</td>
              <td>${item.instructores}</td>
              <td>${item.competencia}</td>
              <td>${tipoTexto || ""}</td>
              <td data-sort-value="${fechaInicioSort}">${fechaInicioTexto}</td>
              <td data-sort-value="${fechaFinSort}">${fechaFinTexto}</td>
              <td class="col-dias" data-color="${infoFecha.diasColor || ""}">${diasHtml}</td>
              <td>${listaAprendices || "-"}</td>
              <td>${item.aprendices.size}</td>
            `;
            tbodyPendInstr.appendChild(tr);
            contadorInstr++;
          });

          const tieneDatos = filasOrdenadas.length > 0;
          if (tablaPendInstr) {
            tablaPendInstr.style.display = tieneDatos ? "table" : "none";
          }
          if (tituloPendInstr) {
            tituloPendInstr.style.display = tieneDatos ? "block" : "none";
          }
          actualizarTotalAprendicesReporte8();
        } // cierra if (tbodyPendInstr && filasAprendices.length > 0)

      } // cierra function generarReporte8PendientesPorAprendizInstructor

      // =========================
      // Generar Pivot Table para Reporte 6: Análisis de Competencias y Raps
      // =========================
      // =========================
      // Generar Pivot Table para Reporte 6: Análisis de Competencias y Raps
      // =========================

      // =========================
      // Filtrado Genérico / Control de UI
      // =========================

      // Variables de estado para filtros
        let filtrosReporte1 = {
          texto: "",
          categorias: { "Práctica": true, "Transversales": true, "Inglés": true, "Técnicas": true }
        };

        let filtrosReporte2 = {
          texto: "",
          categorias: { "Práctica": true, "Transversales": true, "Inglés": true, "Técnicas": true }
        };

        let filtrosReporte4 = {
          texto: "",
          categorias: { "Práctica": true, "Transversales": true, "Inglés": true, "Técnicas": true }
        };

        let filtrosReporte3Categorias = {
          transversales: true,
          tecnicas: true,
        ingles: true,
        practica: true
      };

      let filtrosReporte6 = {
        texto: "",
        categorias: { transversales: true, tecnicas: true, ingles: true, practica: true },
        soloRapsOtro: false,
        soloRapsNoProgramados: false
      };

      let filtrosReporte8Categorias = {
        transversales: true,
        tecnicas: true,
        ingles: true,
        practica: true
      };

      let filtrosPendientesInstructorCategorias = {
        transversales: true,
        tecnicas: true,
        ingles: true,
        practica: true
      };

      let datosReporte6Global = [];

      // Función: Aplicar filtros a tabla agrupada O plana
      // opts: { colCompetencia: number, colTipo: number, agrupado: boolean }
      function aplicarFiltrosCompetenciasConTipo(tbodyId, filtros, opts) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;

        // Configuración por defecto (para Reporte 2)
        const cfg = Object.assign({
          colCompetencia: 1,
          colTipo: 2,
          agrupado: true
        }, opts || {});

        const texto = (filtros.texto || "").toLowerCase();
        const cats = filtros.categorias;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let contadorVisibles = 1;
        let cabeceraActual = null;
        let catActual = "";

        filas.forEach(tr => {
          const celdas = tr.getElementsByTagName("td");

          // Lógica para tablas agrupadas (headers con colspan)
          if (cfg.agrupado) {
            if (celdas.length && celdas[0].hasAttribute("colspan")) {
              cabeceraActual = tr;
              catActual = tr.textContent.trim();
              tr.style.display = "none";
              return;
            }
          }

          if (celdas.length < 2) return;

          let visible = true;

          // Obtener valores según configuración de columnas
          const compTexto = (celdas[cfg.colCompetencia]?.textContent || "").toLowerCase();
          const tipoTexto = (celdas[cfg.colTipo]?.textContent || "").trim(); // Tipo exacto para el mapa

          // Filtro Texto: busca en TODO el contenido de la fila
          if (texto && !tr.textContent.toLowerCase().includes(texto)) {
            visible = false;
          }

          // Filtros Reporte 6 (Filas coloreadas)
          if (visible && filtros.soloRapsOtro) {
            visible = tr.classList.contains("fila-instructor-diferente");
          }
          if (visible && filtros.soloRapsNoProgramados) {
            visible = tr.classList.contains("fila-rap-no-programado");
          }

          // Filtro Categoría
          // Si es agrupado, usa la cabeceraActual. Si no, usa la columna Tipo.
          if (visible) {
            let categoriaKey = "";
            if (cfg.agrupado) {
              categoriaKey = catActual;
            } else {
              // Si no está agrupado, usamos la columna Tipo
              // Pero en Rep 6 (plano o pseudo-plano) a veces no hay col tipo explícita con texto perfecto
              // Intentamos normalizar.
              categoriaKey = tipoTexto || getCategoria(compTexto);
            }

            // Verificación difusa para coincidir con las llaves del filtro
            // Las llaves son: "Práctica", "Transversales", "Inglés", "Técnicas"
            let match = false;
            for (const key in cats) {
              // key: "Práctica", "Transversales", ...
              // categoriaKey puede ser "TÉCNICA", "Transversal", etc.
              if (normalizarCategoriaGantt(categoriaKey) === normalizarCategoriaGantt(key)) {
                if (!cats[key]) visible = false;
                match = true;
                break;
              }
            }
            // Si no hizo match y tenemos categoría, asumimos visible o revisamos lógica?
            // Si categoriaKey es "Técnica" y key es "Técnicas", el includes funciona.
          }

          tr.style.display = visible ? "" : "none";

          if (visible) {
            celdas[0].textContent = contadorVisibles++;
            if (cfg.agrupado && cabeceraActual) cabeceraActual.style.display = "";
          }
        });
      }

      // Wrapper específico para Reporte 1 (Instructores y Competencias)
      function aplicarFiltrosInstructores() {
        const tbody = document.getElementById("tbodyReporte1");
        if (!tbody) return;

        aplicarFiltrosCompetenciasConTipo("tbodyReporte1", filtrosReporte1, {
          colCompetencia: 6,
          colTipo: 7,
          agrupado: false
        });

        const coloresActivos = obtenerColoresActivos("tablaReporte1");
        if (coloresActivos.length > 0) {
          Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
            if (tr.style.display === "none") return;
            const diasTd = tr.querySelector("td.col-dias");
            const color = (diasTd?.getAttribute("data-color") || "").toLowerCase();
            if (!coloresActivos.includes(color)) {
              tr.style.display = "none";
            }
          });
        }

        renumerarFilasTabla(tbody);
        actualizarTotalHorasProgramadasReporte1();
      }

      function actualizarTotalHorasProgramadasReporte1() {
        const tbody = document.getElementById("tbodyReporte1");
        const spanTotal = document.getElementById("totalHorasProgramadasReporte1");
        if (!tbody || !spanTotal) return;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let total = 0;
        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const cell = tr.cells[8];
          if (!cell) return;
          const valor = Number(cell.textContent?.replace(/,/g, ".") || 0) || 0;
          total += valor;
        });

        const totalRedondeado = Math.round(total);
        establecerValorAnimado(spanTotal, totalRedondeado.toString());
        actualizarCantidadFilasVisibles("tablaPendientesInstructorReporte8", "totalRegistrosPendientesReporte8");
        actualizarCantidadFilasVisibles("tablaReporte1", "totalRegistrosReporte1");
      }

      // Wrapper específico para Reporte 6
      function aplicarFiltrosReporte6() {
        // Rep 6 no es agrupado por colspan en la implementación actual (ver generated HTML),
        // es una lista plana generada en `generarPivotTableReporte6`.
        // Columnas estimadas: 0=#, 1=Comp, 2=RAP, 3=Funcionarios, 4=Evaluados, 5=PorEval, 6=NoAprob ...
        // NO tiene columna explicita de TIPO en la tabla visible (se deduce de la competencia).
        // Usamos colCompetencia=1, colTipo=-1 (para forzar deducción por getCategoria)

        aplicarFiltrosCompetenciasConTipo("tbodyReporte6", filtrosReporte6, {
          colCompetencia: 1,
          colTipo: -1,
          agrupado: false
        });
      }

      // Listeners DOM
      document.addEventListener("DOMContentLoaded", function () {

        // --- Reporte 1 ---
        const inputBusqueda1 = document.getElementById("busquedaReporte1");
        if (inputBusqueda1) {
          inputBusqueda1.addEventListener("input", function () {
            filtrosReporte1.texto = this.value;
            aplicarFiltrosInstructores();
          });
        }
        document.querySelectorAll(".chk-cat-reporte1").forEach(chk => {
          chk.addEventListener("change", function () {
            const cat = this.getAttribute("data-cat");
            if (cat) {
              filtrosReporte1.categorias[cat] = this.checked;
              aplicarFiltrosInstructores();
            }
          });
        });

          // --- Reporte 2 ---
          const inputBusqueda2 = document.getElementById("busquedaReporte2");
          if (inputBusqueda2) {
            inputBusqueda2.addEventListener("input", function () {
            filtrosReporte2.texto = this.value;
            aplicarFiltrosReporte2();
          });
        }
        document.querySelectorAll(".chk-cat-reporte2").forEach(chk => {
          chk.addEventListener("change", function () {
            const cat = this.getAttribute("data-cat");
            if (cat) {
              filtrosReporte2.categorias[cat] = this.checked;
              aplicarFiltrosReporte2();
            }
            });
          });

          // --- Reporte 4 ---
          const inputBusqueda4 = document.getElementById("busquedaReporte4");
          if (inputBusqueda4) {
            inputBusqueda4.addEventListener("input", function () {
              filtrosReporte4.texto = this.value || "";
              aplicarFiltrosReporte4();
            });
          }
          document.querySelectorAll(".chk-cat-reporte4").forEach(chk => {
            chk.addEventListener("change", function () {
              const cat = this.getAttribute("data-cat");
              if (!cat) return;
              filtrosReporte4.categorias[cat] = this.checked;
              const label = this.closest(".chip-reporte1");
              if (label) {
                label.classList.toggle("chip-inactivo", !this.checked);
              }
              aplicarFiltrosReporte4();
            });
          });

          // --- Reporte 6 ---
          const inputBusqueda6 = document.getElementById("busquedaReporte6");
        if (inputBusqueda6) {
          inputBusqueda6.addEventListener("input", function () {
            filtrosReporte6.texto = this.value;
            aplicarFiltrosReporte6();
          });
        }
        document.querySelectorAll(".chk-cat-reporte6").forEach(chk => {
          chk.addEventListener("change", function () {
            const catRaw = this.getAttribute("data-cat");
            const catKey = normalizarCategoriaGantt(catRaw || "");
            if (catKey) {
              filtrosReporte6.categorias[catKey] = this.checked;
              aplicarFiltrosReporte6();
            }
          });
        });
        document.querySelectorAll(".chip-reporte6.chip-tipo").forEach(chip => {
          chip.addEventListener("click", function () {
            const tipo = this.getAttribute("data-tipo");
            const tipoKey = normalizarCategoriaGantt(tipo || "");
            if (tipoKey) {
              const activo = !filtrosReporte6.categorias[tipoKey];
              filtrosReporte6.categorias[tipoKey] = activo;
              // Visual toggle
              if (!activo) this.classList.add("chip-inactivo");
              else this.classList.remove("chip-inactivo");
              aplicarFiltrosReporte6();
            }
          });
        });

        const chkSoloRapsOtro = document.getElementById("chkSoloRapsOtro");
        if (chkSoloRapsOtro) {
          chkSoloRapsOtro.addEventListener("change", function () {
            filtrosReporte6.soloRapsOtro = this.checked;
            aplicarFiltrosReporte6();
          });
        }

        const chkSoloRapsNoProgramados = document.getElementById("chkSoloRapsNoProgramados");
        if (chkSoloRapsNoProgramados) {
          chkSoloRapsNoProgramados.addEventListener("change", function () {
            filtrosReporte6.soloRapsNoProgramados = this.checked;
            aplicarFiltrosReporte6();
          });
        }

        document.querySelectorAll(".chk-cat-reporte8").forEach(chk => {
          chk.addEventListener("change", function () {
            const cat = this.getAttribute("data-cat");
            if (!cat) return;
            const key = normalizarCategoriaGantt(cat);
            if (!key) return;
            filtrosReporte8Categorias[key] = this.checked;
            const label = this.closest(".chip-reporte1");
            if (label) {
              label.classList.toggle("chip-inactivo", !this.checked);
            }
            const texto = document.getElementById("busquedaPendientesAprendiz")?.value || "";
            filtrarTablasReporte8PorTexto(texto);
          });
        });

        document.querySelectorAll(".chk-cat-pendientes-juicio").forEach(chk => {
          chk.addEventListener("change", function () {
            const cat = this.getAttribute("data-cat");
            if (!cat) return;
            const key = normalizarCategoriaGantt(cat);
            if (!key) return;
            filtrosPendientesInstructorCategorias[key] = this.checked;
            const label = this.closest(".chip-reporte1");
            if (label) {
              label.classList.toggle("chip-inactivo", !this.checked);
            }
            const texto = document.getElementById("busquedaPendientesJuicio")?.value || "";
            filtrarTablaSimplePorTexto("tbodyPendientesInstructorReporte8", texto);
          });
        });
      });


      function aplicarFiltrosReporte6() {
        const tbody = document.getElementById("tbodyReporte6");
        if (!tbody) return;

        const texto = (filtrosReporte6.texto || "").toLowerCase();
        const cats = filtrosReporte6.categorias;
        const soloOtro = filtrosReporte6.soloRapsOtro;
        const soloNoProg = filtrosReporte6.soloRapsNoProgramados;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let contadorVisibles = 1;
        let cabeceraActual = null;
        let catActual = "";

        filas.forEach(tr => {
          const celdas = tr.getElementsByTagName("td");
          // Fila de encabezado
          if (celdas[0] && celdas[0].colSpan > 1) {
            cabeceraActual = tr;
            catActual = tr.textContent.trim();
            tr.style.display = "none"; // Se muestra solo si tiene hijos visibles
            return;
          }

          if (!celdas.length) return;

          let visible = true;

          // 1. Filtro Texto
          if (visible && texto) {
            const contenido = tr.textContent.toLowerCase();
            if (!contenido.includes(texto)) visible = false;
          }

          // 2. Filtro Categoría
          if (visible && catActual && cats.hasOwnProperty(catActual)) {
            if (!cats[catActual]) visible = false;
          }

          // 3. Filtros Toggle
          if (visible && soloOtro) {
            if (!tr.classList.contains("fila-instructor-diferente")) visible = false;
          }
          if (visible && soloNoProg) {
            if (!tr.classList.contains("fila-rap-no-programado")) visible = false;
          }

          // Aplicar visibilidad
          tr.style.display = visible ? "" : "none";

          if (visible) {
            // Renumerar
            if (celdas[0]) celdas[0].textContent = contadorVisibles++;
            // Mostrar cabecera si es necesario
            if (cabeceraActual) {
              cabeceraActual.style.display = "";
            }
          }
        });
      }


      function generarPivotTableReporte6() {

        // Normaliza texto: mayúsculas, sin tildes, sin espacios extra
        const normalizarTexto = (texto) => {
          return (texto || "")
            .toString()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase()
            .trim()
            .replace(/\s+/g, " ");
        };

        // Obtiene TODOS los nombres de funcionario(s) que evaluaron (sin cédula ni prefijos)
        const obtenerNombresDesdeFuncionario = (funcionario) => {
          if (!funcionario) return [];
          const texto = funcionario.toString();
          const nombres = [];

          texto.split(",").forEach(fragmento => {
            const nombreParte = fragmento.split("-").pop();
            const nombreNorm = normalizarTexto(nombreParte);
            if (nombreNorm) {
              nombres.push(nombreNorm);
            }
          });

          return nombres;
        };

        // Mapa: competencia normalizada -> set de nombres normalizados de instructores programados
        const mapaProgNormPorComp = {};
        (registrosGlobal || []).forEach(reg => {
          const compKey = normalizeCompetencia(reg.competencia || "");
          if (!compKey) return;

          if (!mapaProgNormPorComp[compKey]) {
            mapaProgNormPorComp[compKey] = new Set();
          }

          const nombreInst = (
            (reg.nombreInstructor || "") + " " + (reg.apellidoInstructor || "")
          ).trim();

          if (nombreInst) {
            mapaProgNormPorComp[compKey].add(normalizarTexto(nombreInst));
          }
        });

        // Filtramos juicios: solo EN FORMACIÓN o CONDICIONADO
        const aprendicesNoAprobadosSet = new Set();
          const filtrados = registrosJuicios.filter(r => {
            const estadoU = (r.estado || "").toUpperCase();
            return (estadoU === "EN FORMACION" || estadoU === "CONDICIONADO");
          });

          const grupos = {};
          filtrados.forEach(r => {
            const key = r.competencia + "|" + r.resAprendizaje;
            const infoFecha = obtenerDatosFechaCompetencia(r.competencia);
            const diasColor = (infoFecha?.diasColor || "").toLowerCase();
            if (!grupos[key]) {
              grupos[key] = {
                competencia: r.competencia,
                rap: r.resAprendizaje,
                funcionarios: new Set(),        // textos originales (con CC, etc.)
                funcionariosNombres: new Set(), // nombres normalizados
                aprobado: 0,
                porEvaluar: 0,
                noAprobado: 0
              };
              grupos[key].diasColor = diasColor;
            }
            if (!grupos[key].diasColor && diasColor) {
              grupos[key].diasColor = diasColor;
            }

            const juicio = (r.juicioEval || "").toUpperCase();
          if (juicio === "APROBADO") {
            grupos[key].aprobado++;
          } else if (juicio === "POR EVALUAR") {
            grupos[key].porEvaluar++;
          } else if (juicio === "NO APROBADO") {
            grupos[key].noAprobado++;
            const nombreCompleto = ((r.nombre || "") + " " + (r.apellidos || "")).trim();
            const doc = (r.numDoc || "").toString().trim();
            const claveAprendiz = `${doc}|${nombreCompleto}`.trim();
            if (claveAprendiz) {
              aprendicesNoAprobadosSet.add(claveAprendiz);
            }
          }

          const nombreFunc = String(r.funcionario || "").trim();
          if (nombreFunc !== "") {
            // Guardamos el texto tal cual para mostrarlo en la tabla
            grupos[key].funcionarios.add(nombreFunc);

            // Y extraemos todos los nombres que hay en ese texto
            const nombresNorm = obtenerNombresDesdeFuncionario(nombreFunc);
            nombresNorm.forEach(n => grupos[key].funcionariosNombres.add(n));
          }
        });

        const arrGrupos = Object.values(grupos);
        const competenciasNoAprobadasSet = new Set();
        const resultadosNoAprobadosSet = new Set();
        arrGrupos.forEach(grupo => {
          if (grupo.noAprobado > 0) {
            competenciasNoAprobadasSet.add(normalizeCompetencia(grupo.competencia || ""));
            resultadosNoAprobadosSet.add(`${normalizeCompetencia(grupo.competencia || "")}|${normalizeTexto(grupo.rap || "")}`);
          }
        });
        const totalRapsNoAprobados = arrGrupos.reduce((sum, grupo) => sum + (grupo.noAprobado || 0), 0);
        const spanCompetenciasNoAprob = document.getElementById("numCompetenciasNoAprobadasHeader");
        if (spanCompetenciasNoAprob) {
          spanCompetenciasNoAprob.textContent = competenciasNoAprobadasSet.size.toString();
        }
        const spanResultadosNoAprob = document.getElementById("numResultadosNoAprobadosHeader");
        if (spanResultadosNoAprob) {
          spanResultadosNoAprob.textContent = resultadosNoAprobadosSet.size.toString();
        }
          const spanAprendicesConCompNoAprob = document.getElementById("numAprendicesConCompetenciasNoAprobadasHeader");
          if (spanAprendicesConCompNoAprob) {
            spanAprendicesConCompNoAprob.textContent = aprendicesNoAprobadosSet.size.toString();
          }
          actualizarTotalCantidadAprendicesVistoTablaProgramadas();
        // NUEVO: actualizar KPI de "Resultados de aprendizaje" con el total general
        const totalRaps = arrGrupos.length;
        totalRapsGlobal = totalRaps;
        const numResultadosHeaderEl = document.getElementById("numResultadosHeader");
        if (numResultadosHeaderEl) {
          numResultadosHeaderEl.textContent = totalRaps;
        }

        // --- PRE-CÁLCULO DE FLAGS PARA USO GLOBAL Y EN TABLA ---
        arrGrupos.forEach(grupo => {
          // 1) Clave de competencia para cruzar con los instructores programados
          const compKey = normalizeCompetencia(grupo.competencia || "");
          const progNormSet = mapaProgNormPorComp[compKey] || new Set();

          grupo.esCompetenciaProgramada = !!mapaProgNormPorComp[compKey];
          grupo.alertaInstructorDiferente = false;

          // 2) Revisar si hay AL MENOS un funcionario no programado
          grupo.funcionariosNombres.forEach(funcNorm => {
            if (!progNormSet.has(funcNorm)) {
              grupo.alertaInstructorDiferente = true;
            }
          });
        });

        // Guardamos en variable global para el Acta
        datosReporte6Global = arrGrupos;

        const categoriasPivot = { "Práctica": [], "Transversales": [], "Inglés": [], "Técnicas": [] };
        arrGrupos.forEach(grupo => {
          const cat = getCategoria(grupo.competencia);
          if (categoriasPivot[cat]) {
            categoriasPivot[cat].push(grupo);
          } else {
            // Fallback for unexpected categories
            if (!categoriasPivot["Técnicas"]) categoriasPivot["Técnicas"] = [];
            categoriasPivot["Técnicas"].push(grupo);
          }
        });

        const tbody6 = document.getElementById("tbodyReporte6");
        tbody6.innerHTML = "";
        let contador = 1;
        const ordenCategorias = ["Práctica", "Transversales", "Inglés", "Técnicas"];

        ordenCategorias.forEach(cat => {
          if (categoriasPivot[cat] && categoriasPivot[cat].length > 0) {
            categoriasPivot[cat].forEach(grupo => {
              const total = grupo.aprobado + grupo.porEvaluar + grupo.noAprobado;
              const funcionariosUnicos = Array.from(grupo.funcionarios).join(", ");

              const tr = document.createElement("tr");

              // Amarillo si hay instructor que evaluó y NO estaba programado
              // REQUERIMIENTO: La competencia sí está programada en el diseño
              if (grupo.alertaInstructorDiferente && grupo.esCompetenciaProgramada) {
                tr.classList.add("fila-instructor-diferente");
              }

              // Naranja: competencias NO programadas pero evaluadas (al menos 1 aprobado)
              if (grupo.aprobado > 0 && !grupo.esCompetenciaProgramada) {
                tr.classList.add("fila-rap-no-programado");
              }

              // (Opcional) rojo si todos los juicios están POR EVALUAR
              if (grupo.porEvaluar === total && total > 0) {
                tr.classList.add("rojo");
              }

              const tipo = obtenerEtiquetaTipoCompetencia(grupo.competencia);
              const infoFecha = obtenerDatosFechaCompetencia(grupo.competencia);
              const fechaInicioTexto = infoFecha.fechaInicioTexto || "-";
              const fechaFinTexto = infoFecha.fechaTexto || "-";
              const diasHtml = infoFecha.diasHtml || "-";
              const diasColor = infoFecha.diasColor || (fechaFinTexto === "-" ? "pendiente" : "");

              tr.innerHTML = `
          <td>${contador++}</td>
          <td>${grupo.competencia}</td>
          <td>${tipo}</td>
          <td>${fechaInicioTexto}</td>
          <td>${fechaFinTexto}</td>
          <td class="col-dias" data-color="${diasColor}">${diasHtml}</td>
          <td>${grupo.rap}</td>
          <td>${funcionariosUnicos}</td>
          <td>${grupo.aprobado}</td>
          <td>${grupo.porEvaluar}</td>
          <td>${grupo.noAprobado}</td>
        `;
              tbody6.appendChild(tr);
            });
          }
        });

        // Aplicar filtros iniciales
        aplicarFiltrosReporte6();
      }


      // =========================
      // Generar Pivot Table para Reporte 7: % Avance por Aprendiz
      // =========================
      function generarPivotTableAvancePorAprendiz() {
        // Filtramos juicios solo de aprendices EN FORMACION o CONDICIONADO
        const filtrados = registrosJuicios.filter(r => {
          const estadoU = (r.estado || "").toUpperCase();
          return (estadoU === "EN FORMACION" || estadoU === "CONDICIONADO");
        });

        // Pivot por aprendiz
        const pivot = {};
        filtrados.forEach(r => {
          const key = r.numDoc + "|" + (r.nombre + " " + r.apellidos);
          if (!pivot[key]) {
            pivot[key] = {
              numDoc: r.numDoc,
              nombreCompleto: r.nombre + " " + r.apellidos,
              aprobadoSet: new Set(),
              porEvaluarSet: new Set(),
              noAprobadoSet: new Set()
            };
          }

          const juicioEval = (r.juicioEval || "").toLowerCase();
          const rapKey = `${normalizeCompetencia(r.competencia || "")}|${normalizeTexto(r.resAprendizaje || "")}`;

          if (!rapKey.trim()) return;

          if (juicioEval === "aprobado") {
            pivot[key].aprobadoSet.add(rapKey);
          } else if (juicioEval === "por evaluar") {
            pivot[key].porEvaluarSet.add(rapKey);
          } else if (juicioEval === "no aprobado") {
            pivot[key].noAprobadoSet.add(rapKey);
          }
        });

        let pivotRows = Object.values(pivot);
        pivotRows.forEach(row => {
          row.aprobado = row.aprobadoSet?.size || 0;
          row.porEvaluar = row.porEvaluarSet?.size || 0;
          row.noAprobado = row.noAprobadoSet?.size || 0;
        });
        pivotRows.sort((a, b) => a.nombreCompleto.localeCompare(b.nombreCompleto));

        pazSalvoMap = {};
        pivotRows.forEach(row => {
          if (row.porEvaluar === 1) {
            const clave = `${row.numDoc || ""}|${row.nombreCompleto || ""}`;
            pazSalvoMap[clave] = {
              nombreCompleto: row.nombreCompleto || "",
              numDoc: row.numDoc || ""
            };
          }
        });

        const tbody7 = document.getElementById("pivotAvanceContainer");
        if (!tbody7) return;

        tbody7.innerHTML = "";
        let cont7 = 1;

        // Acumuladores para el resumen de la ficha
        let sumaAvance = 0;
        let cantidadConAvance = 0;
        let aprendicesRiesgo = 0;
        const datosFallasUI = [];

        pivotRows.forEach(row => {
          const total = row.aprobado + row.porEvaluar;
          const avanceNum = total > 0 ? (row.aprobado / total) * 100 : 0;
          const avanceTexto = avanceNum.toFixed(2);

          // Fallas tomadas del archivo de inasistencias
          const docNormalizado = normalizarDocumento(row.numDoc);
          const fallas = mapaFallasPorDocumento[docNormalizado] || 0;

          // Fechas de fallas para la columna "Detalles" (ordenadas)
          let detallesFallas = "";
          if (typeof mapaFechasFallasPorDocumento !== "undefined" &&
            Array.isArray(mapaFechasFallasPorDocumento[docNormalizado]) &&
            mapaFechasFallasPorDocumento[docNormalizado].length > 0) {

            const fechasOrdenadas = mapaFechasFallasPorDocumento[docNormalizado]
              .slice()
              .sort((a, b) => {
                const da = parseFecha(a);
                const db = parseFecha(b);
                return da - db; // más antigua primero
              });

            detallesFallas = fechasOrdenadas.join(", ");
          }

          let clase = "";
          if (total > 0 && avanceNum < 75) {
            clase = "textoRojo";
          }
          if (row.porEvaluar === total) {
            clase = "rojo";
          }

          // === Cálculos para el resumen ===
          if (total > 0) {
            sumaAvance += avanceNum;
            cantidadConAvance++;
          }

          // Criterio de riesgo:
          // - Avance < 75%  OR
          // - Muchas fallas (aquí uso >= 3, ajústalo si lo necesitas)
          const esRiesgoPorAvance = (total > 0 && avanceNum < 75);
          const esRiesgoPorFallas = (fallas >= 3);
          if (esRiesgoPorAvance || esRiesgoPorFallas) {
            aprendicesRiesgo++;
          }
          // ===============================

          const tr = document.createElement("tr");
          tr.className = clase;
          tr.innerHTML = `
      <td>${cont7++}</td>
      <td>${row.numDoc}</td>
      <td>${row.nombreCompleto}</td>
      <td>${fallas}</td>
      <td>${detallesFallas}</td>
      <td>${row.aprobado}</td>
      <td>${row.porEvaluar}</td>
      <td>${avanceTexto}%</td>
    `;
          tbody7.appendChild(tr);
        });

        if (typeof generarReporte8PendientesPorAprendizInstructor === "function") {
          generarReporte8PendientesPorAprendizInstructor();
        }

        actualizarTotalesAvanceAprendiz();



        // Actualizar % avance promedio del grupo + barra
        const spanAvancePromedio = document.getElementById("avancePromedioGrupoHeader");
        const circularAvance = document.getElementById("avancePromedioCircular");

        if (spanAvancePromedio) {
          const promedio = (cantidadConAvance > 0) ? (sumaAvance / cantidadConAvance) : 0;
          const texto = promedio.toFixed(1) + " %";
          spanAvancePromedio.textContent = texto;

          // Actualizar círculo
          const valorBarra = Math.max(0, Math.min(100, promedio));
          if (circularAvance) {
            circularAvance.style.setProperty("--avance", valorBarra.toFixed(1));
          }
        }

        // Actualizar Nº aprendices con riesgo
          const spanAprendicesRiesgo = document.getElementById("numAprendicesRiesgoHeader");
          if (spanAprendicesRiesgo) {
            spanAprendicesRiesgo.textContent = aprendicesRiesgo.toString();
          }
          const spanAprendicesConCompetenciasPorEvaluar = document.getElementById("numAprendicesConCompetenciasPorEvaluarHeader");
          if (spanAprendicesConCompetenciasPorEvaluar) {
            const aprendicesConPorEvaluar = pivotRows.filter(row => (row.porEvaluar || 0) > 0).length;
            spanAprendicesConCompetenciasPorEvaluar.textContent = aprendicesConPorEvaluar.toString();
          }

        // Renderizar gráfica de fallas en el reporte (CanvasJS, solo si hay fallas)
        const contGraficoFallas = document.getElementById("graficoFallasReporte7Container");
        const datosGraf = pivotRows
          .map(r => {
            const doc = (r.numDoc || "").toString();
            const fallas = mapaFallasPorDocumento[normalizarDocumento(doc)] || 0;
            return {
              label: (r.nombreCompleto || "").trim(),
              fallas
            };
          })
          .filter(r => r.fallas > 0);
        renderGraficoFallasReporte7(datosGraf);

      }



      
      // =========================
      // Exportar a PDF (misma vista del panel)
      // =========================

      function serializarNodoParaImpresion(origen, preprocesarClone) {
        if (!origen) return "";

        const clone = origen.cloneNode(true);

        if (typeof preprocesarClone === "function") {
          try { preprocesarClone(clone); } catch (e) { /* noop */ }
        }

        // Copiar contenido de <canvas> como imagen (CanvasJS u otros) para que se vea en impresión
        const canvasesOrigen = origen.querySelectorAll("canvas");
        const canvasesClone = clone.querySelectorAll("canvas");
        canvasesClone.forEach((cClone, idx) => {
          const cOrigen = canvasesOrigen[idx];
          if (!cOrigen) return;
          try {
            const img = document.createElement("img");
            img.src = cOrigen.toDataURL("image/png");
            img.style.maxWidth = "100%";
            img.style.height = "auto";
            cClone.replaceWith(img);
          } catch (e) {
            // Si falla (por CORS u otro motivo), se deja el canvas tal cual
          }
        });

        // Si el origen está oculto (por ejemplo, acordeón cerrado), forzamos visibilidad en el clon
        try {
          const displayOrigen = window.getComputedStyle(origen).display;
          if (displayOrigen === "none") clone.style.display = "block";
        } catch (e) { /* noop */ }

        return clone.outerHTML;
      }

      // Limpieza para exportación PDF: solo texto, tablas y gráficas (sin controles)
      function limpiarControlesParaPDF(clone) {
        if (!clone) return;

        // Remover UI de filtros/carga/controles interactivos
        clone.querySelectorAll("button, input, select, textarea, label").forEach(el => el.remove());

        // Remover contenedores típicos de filtros y navegación
        clone.querySelectorAll(
          "#export-section, #reportes, .tabs, .acordeon-header, .acordeon-icon, " +
          ".filtros-colores-dias, .filtros-raps-botones, .btn-menu-reporte, " +
          ".chip-reporte1, .chip-reporte2"
        ).forEach(el => el.remove());

        // Remover cualquier elemento cuyo id/clase indique filtro (backup)
        clone.querySelectorAll('[id*="filtro"], [class*="filtro"], [id*="filter"], [class*="filter"]').forEach(el => el.remove());

        // Remover secciones de carga de archivos si quedaron contenedores sueltos
        clone.querySelectorAll('input[type="file"]').forEach(inp => {
          const wrap = inp.closest("div");
          if (wrap) wrap.remove();
        });
      }

      function quitarIdsDelNodo(nodo) {
        if (!nodo) return;
        if (nodo.id) nodo.removeAttribute("id");
        nodo.querySelectorAll("[id]").forEach(el => el.removeAttribute("id"));
      }

      function removerFiltrosVisuales(clone) {
        if (!clone) return;
        clone.querySelectorAll(
          ".filtros-reporte1, .filtros-reporte2, .filtros-reporte4, .filtros-reporte5, .filtros-reporte6, " +
          ".filtros-reporte8, .filtros-colores-dias, .filtros-raps-botones, .detalle-gantt-controls, " +
          ".detalle-gantt-search, .detalle-gantt-filtros, .gantt-filter-button, .filtro-busqueda-reporte1"
        ).forEach(el => el.remove());
      }

      function crearSeccionPDFConTabla(titulo, descripcion, tabla) {
        if (!tabla) return null;
        const contenedor = document.createElement("div");
        contenedor.className = "pdf-reporte-section";
        const h2 = document.createElement("h2");
        h2.textContent = titulo;
        contenedor.appendChild(h2);
        if (descripcion) {
          const p = document.createElement("p");
          p.className = "descripcion-reporte";
          p.innerHTML = descripcion;
          contenedor.appendChild(p);
        }
        contenedor.appendChild(tabla);
        return contenedor;
      }

      function construirTablaAprendicesListosProductivaParaPDF() {
        let tabla = null;

        if (Array.isArray(aprendicesListosProductivaParaExportar) && aprendicesListosProductivaParaExportar.length) {
          tabla = document.createElement("table");
          tabla.className = "tabla-avance-aprendices tabla-aprendices-listos";
          tabla.style.width = "85%";
          tabla.style.borderCollapse = "collapse";
          tabla.style.tableLayout = "fixed";
          tabla.style.marginTop = "4px";
          tabla.style.marginLeft = "auto";
          tabla.style.marginRight = "auto";

          const colgroup = document.createElement("colgroup");
          ["12%", "28%", "60%"].forEach(width => {
            const col = document.createElement("col");
            col.style.width = width;
            colgroup.appendChild(col);
          });
          tabla.appendChild(colgroup);

          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");
          ["#", "Documento", "Nombre del Aprendiz"].forEach(texto => {
            const th = document.createElement("th");
            th.textContent = texto;
            th.style.backgroundColor = "#e5e7eb";
            th.style.fontWeight = "bold";
            th.style.textAlign = "center";
            th.style.border = "1px solid #000000";
            th.style.padding = "4px 6px";
            th.style.fontSize = "8.5pt";
            trHead.appendChild(th);
          });
          thead.appendChild(trHead);
          tabla.appendChild(thead);

          const tbody = document.createElement("tbody");
          aprendicesListosProductivaParaExportar.forEach((ap, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td style="border:1px solid #000000; padding:4px 6px;">${idx + 1}</td>
              <td style="border:1px solid #000000; padding:4px 6px;">${ap.documento || ""}</td>
              <td style="border:1px solid #000000; padding:4px 6px;">${ap.nombre || ""}</td>
            `;
            tr.querySelectorAll("td").forEach(td => {
              td.style.fontSize = "8.5pt";
              td.style.textAlign = "center";
              td.style.verticalAlign = "top";
            });
            tbody.appendChild(tr);
          });
          tabla.appendChild(tbody);
        }

        if (!tabla && typeof tablaListosProductivaHTML === "string" && tablaListosProductivaHTML.trim()) {
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = tablaListosProductivaHTML;
          const tablaTemp = tempDiv.querySelector("table");
          if (tablaTemp) {
            tabla = tablaTemp.cloneNode(true);
            tabla.style.width = "85%";
            tabla.style.borderCollapse = "collapse";
            tabla.style.tableLayout = "fixed";
            tabla.style.marginTop = "4px";
            tabla.style.marginLeft = "auto";
            tabla.style.marginRight = "auto";
            tabla.querySelectorAll("th, td").forEach(celda => {
              celda.style.border = "1px solid #000";
              celda.style.padding = "4px";
              celda.style.fontSize = "8.5pt";
            });
          }
        }

        return tabla;
      }

function construirTablaSimpleAprendicesParaPDF(lista, opciones = {}) {
  if (!Array.isArray(lista) || !lista.length) return null;

  const cols = opciones.cols || ["#", "Documento", "Nombre del Aprendiz"];
  const incluirCompetencia = !!opciones.incluirCompetencia;

  const tabla = document.createElement("table");
  tabla.className = opciones.className || "tabla-avance-aprendices";
  tabla.style.width = "85%";
  tabla.style.borderCollapse = "collapse";
  tabla.style.tableLayout = "fixed";
  tabla.style.marginTop = "6px";
  tabla.style.marginLeft = "auto";
  tabla.style.marginRight = "auto";

  const thead = document.createElement("thead");
  const trH = document.createElement("tr");
  cols.forEach(t => {
    const th = document.createElement("th");
    th.textContent = t;
    th.style.border = "1px solid #000";
    th.style.padding = "4px";
    th.style.fontSize = "8.5pt";
    th.style.fontWeight = "bold";
    trH.appendChild(th);
  });
  thead.appendChild(trH);
  tabla.appendChild(thead);

  const tbody = document.createElement("tbody");
  lista.forEach((ap, idx) => {
    const tr = document.createElement("tr");

    const tdNum = document.createElement("td");
    tdNum.textContent = String(idx + 1);

    const tdDoc = document.createElement("td");
    tdDoc.textContent = ap.documento || "";

    const tdNom = document.createElement("td");
    tdNom.textContent = ap.nombre || "";

    [tdNum, tdDoc, tdNom].forEach(td => {
      td.style.border = "1px solid #000";
      td.style.padding = "4px";
      td.style.fontSize = "8.5pt";
      td.style.verticalAlign = "top";
    });

    tr.appendChild(tdNum);
    tr.appendChild(tdDoc);
    tr.appendChild(tdNom);

    if (incluirCompetencia) {
      const tdComp = document.createElement("td");
      tdComp.textContent = ap.competencia || "";
      tdComp.style.border = "1px solid #000";
      tdComp.style.padding = "4px";
      tdComp.style.fontSize = "8.5pt";
      tdComp.style.verticalAlign = "top";
      tr.appendChild(tdComp);
    }

    tbody.appendChild(tr);
  });
  tabla.appendChild(tbody);

  return tabla;
}

function construirTablaAprendicesPorEvaluarMayor1ParaPDF() {
  return construirTablaSimpleAprendicesParaPDF(
    aprendicesPorEvaluarMayor1ParaExportar || [],
    { className: "tabla-avance-aprendices tabla-por-evaluar-mas1" }
  );
}

function construirTablaAprendicesNovedadesProductivaParaPDF() {
  return construirTablaSimpleAprendicesParaPDF(
    aprendicesNovedadesProductivaParaExportar || [],
    { className: "tabla-avance-aprendices tabla-novedades-productiva", incluirCompetencia: true, cols: ["#", "Documento", "Nombre del Aprendiz", "Competencia"] }
  );
}



function construirSeccionAprendicesListosProductivaPDF() {
  prepararDatosListosParaProductiva();

  const contenedor = document.createElement("div");
  contenedor.className = "pdf-reporte-section";

  const h2 = document.createElement("h2");
  h2.textContent = "Aprendices listos para ir a etapa productiva";
  contenedor.appendChild(h2);

  const p = document.createElement("p");
  p.className = "descripcion-reporte";
  p.innerHTML = "Aprendices que tienen pendiente únicamente la competencia <strong>RESULTADOS DE APRENDIZAJE ETAPA PRACTICA</strong> (según el reporte de pendientes) y listas derivadas del reporte <strong>% Avance por Aprendiz</strong>.";
  contenedor.appendChild(p);

  const tablaListos = construirTablaAprendicesListosProductivaParaPDF();
  if (tablaListos) {
    contenedor.appendChild(tablaListos);
  } else {
    const em = document.createElement("em");
    em.textContent = "Por el momento no hay ningún aprendiz.";
    contenedor.appendChild(em);
  }

  const tablaMas = construirTablaAprendicesPorEvaluarMayor1ParaPDF();
  if (tablaMas) {
    const h3 = document.createElement("h3");
    h3.style.marginTop = "10px";
    h3.textContent = "Aprendices con novedades para ir a etapa productiva";
    contenedor.appendChild(h3);
    contenedor.appendChild(tablaMas);
  }

  return contenedor;
}


      function construirTablaCompetenciasSobreEjecutadasParaPDF() {
        const tablaOriginal = document.getElementById("tablaReporte2");
        if (!tablaOriginal) return null;
        const filas = Array.from(tablaOriginal.querySelectorAll("#tbodyReporte2 tr"));
        const filtradas = filas.filter(tr => {
          if (tr.querySelector("td[colspan]")) return false;
          return tr.classList.contains("textoRojo");
        });
        if (!filtradas.length) return null;

        const tabla = document.createElement("table");
        tabla.className = "tabla-competencias-sobre-ejecutadas";
        tabla.style.width = "85%";
        tabla.style.borderCollapse = "collapse";
        tabla.style.tableLayout = "fixed";
        tabla.style.marginTop = "4px";
        tabla.style.marginLeft = "auto";
        tabla.style.marginRight = "auto";

        const colgroup = document.createElement("colgroup");
        ["6%", "46%", "16%", "16%", "16%"].forEach(width => {
          const col = document.createElement("col");
          col.style.width = width;
          colgroup.appendChild(col);
        });
        tabla.appendChild(colgroup);

        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>#</th><th>Competencia</th><th>Total de Horas</th><th>Horas Diseño</th><th>%</th></tr>";
        tabla.appendChild(thead);

        const tbody = document.createElement("tbody");
        filtradas.forEach((tr, idx) => {
          const cells = tr.getElementsByTagName("td");
          const nuevaFila = document.createElement("tr");
          if (tr.className) nuevaFila.className = tr.className;
          const totalHoras = cells[6]?.innerHTML || "";
          const horasDiseno = cells[7]?.innerHTML || "";
          const porcentaje = cells[8]?.innerHTML || "";
          nuevaFila.innerHTML = `<td>${idx + 1}</td><td>${cells[1]?.innerHTML || ""}</td>` +
            `<td>${totalHoras}</td><td>${horasDiseno}</td><td>${porcentaje}</td>`;
          tbody.appendChild(nuevaFila);
        });
        tabla.appendChild(tbody);
        return tabla;
      }

      function construirSeccionCompetenciasSobreEjecutadasPDF() {
        const tabla = construirTablaCompetenciasSobreEjecutadasParaPDF();
        return crearSeccionPDFConTabla(
          "Competencias sobre ejecutadas",
          "Se listan únicamente las competencias cuyo porcentaje de ejecución supera el <strong>100 %</strong> frente a las horas definidas en el diseño curricular (filas resaltadas en rojo en el reporte % Competencias con Horas).",
          tabla
        );
      }

      function construirTablaCompetenciasPendientesParaPDF() {
        const tablaOriginal = document.getElementById("tablaReporte4");
        if (!tablaOriginal) return null;
        const filas = Array.from(tablaOriginal.querySelectorAll("#tbodyReporte4 tr"));
        const filtradas = filas.filter(tr => {
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return false;
          if (celdas[0]?.colSpan > 1) return false;
          const diasTd = tr.querySelector("td.col-dias");
          const colorDias = (diasTd?.getAttribute("data-color") || "").toLowerCase();
          if (colorDias !== "pendiente") return false;
          const valorProg = (celdas[6]?.textContent || "").trim().toUpperCase();
          return valorProg === "NO" || valorProg === "1/2";
        });
        if (!filtradas.length) return null;

        const tabla = document.createElement("table");
        tabla.className = "tabla-competencias-pendientes";
        tabla.style.width = "85%";
        tabla.style.borderCollapse = "collapse";
        tabla.style.tableLayout = "fixed";
        tabla.style.marginTop = "4px";
        tabla.style.marginLeft = "auto";
        tabla.style.marginRight = "auto";

        const colgroup = document.createElement("colgroup");
        ["8%", "72%", "20%"].forEach(width => {
          const col = document.createElement("col");
          col.style.width = width;
          colgroup.appendChild(col);
        });
        tabla.appendChild(colgroup);

        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>#</th><th>Competencia</th><th>Programada</th></tr>";
        tabla.appendChild(thead);

        const tbody = document.createElement("tbody");
        filtradas.forEach((tr, idx) => {
          const cells = tr.getElementsByTagName("td");
          const nuevaFila = document.createElement("tr");
          if (tr.className) nuevaFila.className = tr.className;
          const competencia = cells[1]?.innerHTML || "";
          const programada = cells[6]?.innerHTML || "";
          nuevaFila.innerHTML = `<td>${idx + 1}</td><td>${competencia}</td><td>${programada}</td>`;
          tbody.appendChild(nuevaFila);
        });
        tabla.appendChild(tbody);
        return tabla;
      }

      function construirSeccionCompetenciasPendientesPDF() {
        const tabla = construirTablaCompetenciasPendientesParaPDF();
        return crearSeccionPDFConTabla(
          "Competencias pendientes",
          "De acuerdo con el reporte \"Competencias del Programa (Programada: Sí/No)\", se relacionan las competencias sin programación (<strong>No</strong>) o parcialmente programadas (<strong>1/2</strong>).",
          tabla
        );
      }

      function construirTablaRapsFiltradosParaPDF(claseFiltro) {
        const tablaOriginal = document.getElementById("tablaReporte6");
        if (!tablaOriginal) return null;
        const clone = tablaOriginal.cloneNode(true);
        quitarIdsDelNodo(clone);
        removerFiltrosVisuales(clone);
        const tbody = clone.querySelector("tbody");
        if (!tbody) return null;
        let tieneFilas = false;
        Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
          if (!tr.classList.contains(claseFiltro)) {
            tr.remove();
          } else {
            tieneFilas = true;
          }
        });
        return tieneFilas ? clone : null;
      }

      function construirSeccionCompetenciasEvaluadasSinProgramarPDF() {
        const tabla = construirTablaRapsFiltradosParaPDF("fila-rap-no-programado");
        return crearSeccionPDFConTabla(
          "Competencias Evaluadas sin estar programadas",
          "De acuerdo con el reporte \"RAPs Aprobados - Por evaluar y No aprobados\", se listan las competencias que presentan resultados de aprendizaje aprobados sin que dichas competencias estén programadas en el diseño curricular.",
          tabla
        );
      }

      function construirSeccionCompetenciasRapsInstructorNoProgramadoPDF() {
        const tabla = construirTablaRapsFiltradosParaPDF("fila-instructor-diferente");
        return crearSeccionPDFConTabla(
          "Competencias y RAPs evaluados por instructor no programado",
          "De acuerdo con el reporte \"RAPs Aprobados - Por evaluar y No aprobados\", se relacionan los resultados de aprendizaje evaluados por instructores que no fueron los programados originalmente.",
          tabla
        );
      }

      function construirSeccionRapsPorEvaluarPDF() {
        const tablaOriginal = document.getElementById("tablaProgramadas");
        if (!tablaOriginal) return null;
        const clone = tablaOriginal.cloneNode(true);
        quitarIdsDelNodo(clone);
        removerFiltrosVisuales(clone);
        const tbody = clone.querySelector("#tbodyProgramadas");
        if (tbody) tbody.removeAttribute("id");
        clone.style.width = "85%";
        clone.style.borderCollapse = "collapse";
        clone.style.tableLayout = "fixed";
        clone.style.marginTop = "4px";
        clone.style.marginLeft = "auto";
        clone.style.marginRight = "auto";
        clone.querySelectorAll("th, td").forEach(cell => {
          cell.style.border = "1px solid #000";
          cell.style.padding = "4px";
          cell.style.fontSize = "9pt";
          cell.style.verticalAlign = "top";
        });
        return crearSeccionPDFConTabla(
          "Raps por evaluar",
          "Se incluyen los resultados de aprendizaje que actualmente están pendientes de juicio evaluativo, con fechas de programación, tipo, instructores y aprendices afectados.",
          clone
        );
      }

      function construirSeccionCompetenciasAvancePDF() {
        const reporte2 = document.getElementById("reporte2");
        if (!reporte2) return null;
        const clone = reporte2.cloneNode(true);
        quitarIdsDelNodo(clone);
        removerFiltrosVisuales(clone);
        clone.querySelectorAll(".detalle-gantt-card").forEach(el => el.remove());
        return { origen: clone };
      }

      function construirSeccionCronogramaGanttPDF() {
        const ganttCard = document.querySelector("#reporte2 .detalle-gantt-card");
        if (!ganttCard) return null;
        const clone = ganttCard.cloneNode(true);
        quitarIdsDelNodo(clone);
        removerFiltrosVisuales(clone);
        clone.style.width = "100%";
        clone.style.maxWidth = "100%";
        clone.style.margin = "0 auto 16px";
        clone.querySelectorAll(".detalle-gantt-container").forEach(el => {
          el.style.maxWidth = "100%";
          el.style.overflowX = "auto";
        });
        clone.querySelectorAll("table.tabla-gantt-detalle").forEach(tbl => {
          tbl.style.tableLayout = "fixed";
          tbl.style.width = "100%";
          tbl.style.fontSize = "6pt";
          Array.from(tbl.querySelectorAll("col")).forEach((col, idx) => {
            if (idx === 0) {
              col.style.width = "4%";
            } else if (idx === 1) {
              col.style.width = "24%";
            } else if (idx === 2) {
              col.style.width = "8%";
            } else if (idx === 3) {
              col.style.width = "10%";
            } else {
              col.style.width = "6%";
            }
          });
        });
        return { origen: clone };
      }

      function construirContenidoPDF(seccionesSeleccionadas) {
        const partes = [];

        // Encabezado superior institucional (logo y títulos)
        const encabezado = document.querySelector("header");
        if (encabezado) partes.push(serializarNodoParaImpresion(encabezado));

        // Encabezado del panel (tarjetas, timeline, KPIs, análisis, detalle de aprendices, etc.)
        const headerInfo = document.getElementById("headerInfo");
        if (headerInfo) {
          partes.push(serializarNodoParaImpresion(headerInfo, (clone) => {
            // No imprimir el Centro de Reportes (Generación de Reportes / Acciones de Exportación)
            const exportUI = clone.querySelector("#export-section");
            if (exportUI) exportUI.remove();

            
            // Dejar el PDF hasta la gráfica: remover Detalle de Aprendices (tabla)
            const detalleAprendices = clone.querySelector(".detalle-aprendices-card");
            if (detalleAprendices) detalleAprendices.remove();

            // Quitar el acordeón "📊 Reportes de la formacion" (UI de pestañas/accordion)
            const acordeonReportes = clone.querySelector("#reportes");
            if (acordeonReportes) acordeonReportes.remove();
// No imprimir botón del acordeón; imprimir solo el contenido
            const btn = clone.querySelector(".acordeon-header");
            if (btn) btn.remove();

            const cuerpo = clone.querySelector(".acordeon-body");
            if (cuerpo) cuerpo.style.display = "block";
          }));
        } else {
          const info = document.getElementById("accordionInfoBody");
          if (info) partes.push(serializarNodoParaImpresion(info));
        }

        // Reportes seleccionados (si existen)
        if (Array.isArray(seccionesSeleccionadas) && seccionesSeleccionadas.length > 0) {
          seccionesSeleccionadas.forEach(sec => {
            const nodo = sec && sec.origen ? sec.origen : sec;
            if (!nodo) return;
            const preprocesar = sec && sec.preprocesar ? sec.preprocesar : limpiarControlesParaPDF;
            partes.push('<div class="page-break"></div>');
            partes.push(serializarNodoParaImpresion(nodo, preprocesar));
          });
        }

        return partes.join("");
      }

      function obtenerNombreArchivoActaComite() {
        const obtenerCodigoFicha = () => {
          return (document.getElementById("codigoFicha")?.textContent || "")
            .toString()
            .trim()
            .replace(/[^0-9]/g, "") || "SENA";
        };
        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, "0");
        const mes = String(ahora.getMonth() + 1).padStart(2, "0");
        const anio = ahora.getFullYear();
        return `Acta de Comite - ${obtenerCodigoFicha()}-${dia}-${mes}-${anio}`;
      }

      function abrirVentanaParaImprimirPDF(htmlContenido) {
        const ventana = window.open("", "_blank");
        if (!ventana) {
          alert("No fue posible abrir la ventana de impresión. Verifique el bloqueador de ventanas emergentes.");
          return;
        }

        // Copiar todos los <style> y <link rel="stylesheet"> de la página original
        const estilosOriginales = Array
          .from(document.querySelectorAll("style, link[rel='stylesheet']"))
          .map(el => el.outerHTML)
          .join("");

          const nombreArchivo = obtenerNombreArchivoActaComite();
          ventana.document.write(`<html><head><meta charset='UTF-8'><title>${nombreArchivo}</title>`);
          ventana.document.write(estilosOriginales);

        // Estilos específicos para impresión
        ventana.document.write(`
          <style>
            body { background: #ffffff !important; margin: 0; padding: 16px; }
            #export-section, .export-section, .reportes-main { display: none !important; }
            .page-break { break-before: page; page-break-before: always; height: 0; }
            @media print {
              body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

              /* Solo texto, tablas y gráficas (sin UI) */
              #export-section, #reportes, .tabs, .acordeon-header, .acordeon-icon,
              button, input, select, textarea, label,
              .filtros-colores-dias, .filtros-raps-botones, .btn-menu-reporte,
              .chip-reporte1, .chip-reporte2,
              .detalle-aprendices-card,
              [id*="filtro"], [class*="filtro"], [id*="filter"], [class*="filter"] { display: none !important; }
            }
          </style>
        `);

        ventana.document.write("</head><body>");
        ventana.document.write(htmlContenido);
        ventana.document.write("</body></html>");
        ventana.document.close();

          ventana.document.title = nombreArchivo;
          setTimeout(() => ventana.print(), 700);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const botonPDF = document.getElementById("btnExportarPDF");
        if (!botonPDF) {
          console.warn("❗ No se encontró el botón con id 'btnExportarPDF'");
          return;
        }

        botonPDF.addEventListener("click", function () {
          const seleccionados = obtenerReportesSeleccionadosCentro();
          const secciones = obtenerSeccionesSeleccionadasParaPDF(seleccionados);

          // Si no hay reportes seleccionados, se imprime únicamente el encabezado del panel
          const html = construirContenidoPDF(secciones);

          abrirVentanaParaImprimirPDF(html);
        });
      });

// Bloque reutilizable para el encabezado de exportación (PDF y Word)
      // Bloque reutilizable para el encabezado de exportación (PDF y Word)


      function construirBloqueEncabezadoExport(conSeparador = true) {
        const getText = (id) =>
          (document.getElementById(id)?.textContent || "").trim();

        const senaLogoUrl = "https://i.ibb.co/VpwBHTrw/Logosimbolo-SENA-PRINCIPAL-1.png";

        // Información general de la ficha
        const codigoFicha = getText("codigoFicha");
        const nombrePrograma = getText("nombrePrograma");
        const codigoPrograma = getText("codigoPrograma");

        const fechaInicioLectiva = getText("fechaInicioLectiva");
        const fechaFinLectiva = getText("fechaFinLectiva");
        const fechaInicioProd = getText("fechaInicioProductiva");
        const fechaFinProd = getText("fechaFinProductiva");

        const numAprendices = getText("numAprendicesHeader");
        const numInstructores = getText("numInstructoresHeader");
        const numCompetencias = getText("numCompetenciasHeader");
        const numResultados = getText("numResultadosHeader"); // NUEVO

        const instructorGerente = getText("instructorMasHorasHeader");
        const coordinadorAcademico = getText("coordinadorAcademicoHeader");

        // Análisis de rendimiento
        const avancePromedio = getText("avancePromedioGrupoHeader");
        const compSobrecargadas = getText("numCompetenciasSobrecargadasHeader");
        const aprendicesRiesgo = getText("numAprendicesRiesgoHeader");

        // Detalle de aprendices
        const totalAprendicesEstado = getText("totalAprendicesEstado");
        const tablaEstadoHTML =
          document.getElementById("tablaEstado")?.outerHTML || "";

        return `
    <!-- Encabezado institucional -->
    <div style="display:flex; align-items:center; margin-bottom:8px;">
      <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png"
           style="max-width:60px; margin-right:10px;">
      <div>
        <div style="font-weight:bold; font-size:12pt;">
          Servicio Nacional de Aprendizaje - SENA Regional Tolima
        </div>
        <div style="font-size:10pt;">
          Centro de Comercio y Servicios
        </div>
        <div style="font-size:9pt; margin-top:2px;">
          SENA 360 – Panel Integral de Seguimiento a la FPI
        </div>
      </div>
    </div>

    <!-- Información general de la ficha -->
    <div style="margin-bottom:8px;">
      <table style="width:100%; border-collapse:collapse;">
        <tr>
          <td><strong>CÓDIGO FICHA:</strong> ${codigoFicha}</td>
          <td><strong>NOMBRE DEL PROGRAMA:</strong> ${nombrePrograma}</td>
        </tr>
        <tr>
          <td colspan="2"><strong>CÓDIGO DEL PROGRAMA:</strong> ${codigoPrograma}</td>
        </tr>
        <tr>
          <td colspan="2" style="padding-top:4px;"><strong>PERÍODOS</strong></td>
        </tr>
        <tr>
          <td><strong>Etapa Lectiva:</strong> ${fechaInicioLectiva} - ${fechaFinLectiva}</td>
          <td><strong>Etapa Productiva:</strong> ${fechaInicioProd} - ${fechaFinProd}</td>
        </tr>
        <tr>
          <td><strong>Cantidad de APRENDICES:</strong> ${numAprendices}</td>
          <td><strong>Cantidad de INSTRUCTORES:</strong> ${numInstructores}</td>
        </tr>
        <tr>
         <td><strong>Cantidad de COMPETENCIAS:</strong> ${numCompetencias}</td>
  <td><strong>Cantidad de RESULTADOS DE APRENDIZAJE:</strong> ${numResultados}</td>
          <td></td>
        </tr>
        <tr>
          <td><strong>Aprendiz Vocero:</strong> ${aprendizVoceroSeleccionado}</td>
<td><strong>Instructor Gerente de Proyecto:</strong> ${instructorGerente}</td>
          <td><strong>Coordinador Académico:</strong> ${coordinadorAcademico}</td>
        </tr>
      </table>
    </div>

    <!-- Análisis de rendimiento -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>ANÁLISIS DE RENDIMIENTO</strong>
      <ul style="margin:4px 0 0 16px; padding:0;">
        <li>Avance promedio del grupo: ${avancePromedio}</li>
        <li>Competencias sobrecargadas: ${compSobrecargadas}</li>
        <li>Aprendices con avance &lt; 75%: ${aprendicesRiesgo}</li>
      </ul>
    </div>

    <!-- Detalle de aprendices -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>DETALLE DE APRENDICES</strong>
      <div style="margin-top:2px; font-size:12pt;">Total Aprendices Matriculados: ${totalAprendicesEstado}</div>
      ${tablaEstadoHTML}
    </div>

    ${conSeparador ? '<hr style="margin:10px 0;">' : ''}
  `;
      }

      // Versión del encabezado para Word (sin logo)
      function construirBloqueEncabezadoExportWord() {
        const getText = (id) =>
          (document.getElementById(id)?.textContent || "").trim();

        // Información general de la ficha
        const codigoFicha = getText("codigoFicha");
        const nombrePrograma = getText("nombrePrograma");
        const codigoPrograma = getText("codigoPrograma");

        const fechaInicioLectiva = getText("fechaInicioLectiva");
        const fechaFinLectiva = getText("fechaFinLectiva");
        const fechaInicioProd = getText("fechaInicioProductiva");
        const fechaFinProd = getText("fechaFinProductiva");

        const numAprendices = getText("numAprendicesHeader");
        const numInstructores = getText("numInstructoresHeader");
        const numCompetencias = getText("numCompetenciasHeader");
        const numResultados = getText("numResultadosHeader"); // NUEVO


        const instructorGerente = getText("instructorMasHorasHeader");
        const coordinadorAcademico = getText("coordinadorAcademicoHeader");

        // Análisis de rendimiento
        const avancePromedio = getText("avancePromedioGrupoHeader");
        const compSobrecargadas = getText("numCompetenciasSobrecargadasHeader");
        const aprendicesRiesgo = getText("numAprendicesRiesgoHeader");

        // Detalle de aprendices
        const totalAprendicesEstado = getText("totalAprendicesEstado");
        const tablaEstadoHTML =
          document.getElementById("tablaEstado")?.outerHTML || "";

        return `
    <!-- Encabezado institucional (sin logo para Word) -->
    <div style="margin-bottom:8px;">
      <div style="font-weight:bold; font-size:12pt;">
        Servicio Nacional de Aprendizaje - SENA Regional Tolima
      </div>
      <div style="font-size:10pt;">
        Centro de Comercio y Servicios
      </div>
      <div style="font-size:9pt; margin-top:2px;">
        SENA 360 – Panel Integral de Seguimiento a la FPI
      </div>
    </div>

    <!-- Información general de la ficha -->
    <div style="margin-bottom:8px;">
      <table style="width:100%; border-collapse:collapse;">
        <tr>
          <td><strong>CÓDIGO FICHA:</strong> ${codigoFicha}</td>
          <td><strong>NOMBRE DEL PROGRAMA:</strong> ${nombrePrograma}</td>
        </tr>
        <tr>
          <td colspan="2"><strong>CÓDIGO DEL PROGRAMA:</strong> ${codigoPrograma}</td>
        </tr>
        <tr>
          <td colspan="2" style="padding-top:4px;"><strong>PERÍODOS</strong></td>
        </tr>
        <tr>
          <td><strong>Etapa Lectiva:</strong> ${fechaInicioLectiva} - ${fechaFinLectiva}</td>
          <td><strong>Etapa Productiva:</strong> ${fechaInicioProd} - ${fechaFinProd}</td>
        </tr>
     <tr>
  <td><strong>Cantidad de APRENDICES:</strong> ${numAprendices}</td>
  <td><strong>Cantidad de INSTRUCTORES:</strong> ${numInstructores}</td>
</tr>
<tr>
  <td><strong>Cantidad de COMPETENCIAS:</strong> ${numCompetencias}</td>
  <td><strong>Cantidad de RESULTADOS DE APRENDIZAJE:</strong> ${numResultados}</td>
</tr>

        <tr>
<td><strong>Aprendiz Vocero:</strong> ${aprendizVoceroSeleccionado}</td>
          <td><strong>Instructor Gerente de Proyecto:</strong> ${instructorGerente}</td>
          <td><strong>Coordinador Académico:</strong> ${coordinadorAcademico}</td>
        </tr>
      </table>
    </div>

    <!-- Análisis de rendimiento -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>ANÁLISIS DE RENDIMIENTO</strong>
      <ul style="margin:4px 0 0 16px; padding:0;">
        <li>Avance promedio del grupo: ${avancePromedio}</li>
        <li>Competencias sobrecargadas: ${compSobrecargadas}</li>
        <li>Aprendices con avance &lt; 75%: ${aprendicesRiesgo}</li>
      </ul>
    </div>

    <!-- Detalle de aprendices -->
    <div style="font-size:10pt; margin-bottom:8px;">
      <strong>DETALLE DE APRENDICES</strong>
      <div style="margin-top:2px;">Total Aprendices que iniciaron: ${totalAprendicesEstado}</div>
      ${tablaEstadoHTML}
    </div>

    <hr style="margin:10px 0;">
  `;
      }

      const reportesCentroMetadatos = [
        {
          key: "avance-fallas",
          label: "Porcentaje de avance de aprendices y fallas",
          exportSectionId: "reporte7",
          exportTableSelector: "#pivotAvanceContainer",
          excelName: "Porcentaje de avance de aprendices y fallas"
        },
        {
          key: "competencias-pendientes-aprendiz",
          label: "Competencias pendientes por evaluar por cada aprendiz",
          exportSectionId: "reporte8",
          exportTableSelector: "#tbodyReporte8",
          excelName: "Competencias pendientes por aprendiz"
        },
    {
  key: "aprendices-listos-productiva",
  label: "Aprendices listos para ir a etapa productiva",
  exportSectionId: null,
  pdfBuilder: construirSeccionAprendicesListosProductivaPDF,
  excelName: "Aprendices listos etapa productiva",
  excelIncludeBuilderTables: true
},
        {
          key: "listado-instructores-pendientes-juicio",
          label: "Listado de instructores con aprendices pendientes por emitir juicio",
          exportSectionId: "listado-instructores-pendientes-juicio",
          exportTableSelector: "#tablaPendientesInstructorReporte8",
          excelName: "Listado de instructores con aprendices pendientes"
        },
        {
          key: "competencias-avance-diseno",
          label: "Competencias y % de avance vs diseño",
          exportSectionId: "reporte2",
          pdfBuilder: construirSeccionCompetenciasAvancePDF,
          exportTableSelector: "#tablaReporte2",
          excelName: "Competencias y % de avance vs diseño"
        },
        {
          key: "cronograma-gantt",
          label: "Cronograma de programación de competencias (Gantt)",
          exportSectionId: "reporte3",
          pdfBuilder: construirSeccionCronogramaGanttPDF,
          excelName: "Cronograma de programación (Gantt)",
          excelIncludeBuilderTables: true
        },
        {
          key: "competencias-sobre-ejecutadas",
          label: "Competencias sobre ejecutadas",
          exportSectionId: "reporte2",
          pdfBuilder: construirSeccionCompetenciasSobreEjecutadasPDF,
          excelName: "Competencias sobre ejecutadas",
          excelIncludeBuilderTables: true
        },
        {
          key: "competencias-pendientes",
          label: "Competencias pendientes",
          exportSectionId: "reporte4",
          pdfBuilder: construirSeccionCompetenciasPendientesPDF,
          exportTableSelector: "#tablaProgramadas",
          excelName: "Competencias pendientes",
          excelIncludeBuilderTables: true
        },
        {
          key: "competencias-evaluadas-sin-programar",
          label: "Competencias Evaluadas sin estar programadas",
          exportSectionId: "reporte5",
          pdfBuilder: construirSeccionCompetenciasEvaluadasSinProgramarPDF,
          excelName: "Competencias evaluadas sin estar programadas",
          excelIncludeBuilderTables: true
        },
        {
          key: "competencias-raps-instructor-no-programado",
          label: "Competencias y RAPs evaluados por instructor no programado",
          exportSectionId: "reporte6",
          pdfBuilder: construirSeccionCompetenciasRapsInstructorNoProgramadoPDF,
          excelName: "Competencias y RAPs por instructor no programado",
          excelIncludeBuilderTables: true
        },
        {
          key: "raps-por-evaluar",
          label: "Raps por evaluar",
          pdfBuilder: construirSeccionRapsPorEvaluarPDF,
          exportTableSelector: "#tablaProgramadas",
          excelName: "Raps por evaluar"
        }
      ];

      const reportesCentroMap = reportesCentroMetadatos.reduce((acc, meta) => {
        acc[meta.key] = meta;
        return acc;
      }, {});

      function obtenerSeccionesSeleccionadasParaPDF(seleccionados) {
        if (!Array.isArray(seleccionados) || seleccionados.length === 0) return [];
        return seleccionados
          .map(key => {
            const meta = reportesCentroMap[key];
            if (!meta) return null;
            if (typeof meta.pdfBuilder === "function") {
              const resultado = meta.pdfBuilder();
              if (!resultado) return null;
              if (resultado instanceof Element) return resultado;
              if (resultado.origen) return resultado;
              return null;
            }
            const id = meta.exportSectionId || key;
            return id ? document.getElementById(id) : null;
          })
          .filter(Boolean);
      }

      function obtenerReportesSeleccionadosCentro() {
        const checkboxes = document.querySelectorAll(".reporte-checkbox:checked");
        return Array.from(checkboxes).map(cb => cb.dataset.reporteKey || cb.value);
      }



      // Función nueva para calcular los aprendices listos para etapa productiva
// y actualizar la variable global que usan los reportes

// =====================
// Helpers – Etapa productiva (Listos / Por evaluar>1 / Novedades)
// =====================
function normalizarTextoClaveExport(texto) {
  return (texto || "")
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toUpperCase()
    .trim()
    .replace(/\s+/g, " ");
}

function obtenerMapaDocumentoPorAprendizDesdeAvance() {
  const mapa = {};
  const tbody = document.getElementById("pivotAvanceContainer");
  if (!tbody) return mapa;

  tbody.querySelectorAll("tr").forEach(tr => {
    const tds = tr.querySelectorAll("td");
    if (!tds || tds.length < 3) return;
    const doc = (tds[1].textContent || "").trim();
    const nom = (tds[2].textContent || "").trim();
    const clave = normalizarTextoClaveExport(nom);
    if (clave && doc && !mapa[clave]) mapa[clave] = doc;
  });

  return mapa;
}

function obtenerAprendicesPorEvaluarMayorA1DesdeAvance() {
  const tbody = document.getElementById("pivotAvanceContainer");
  if (!tbody) return [];
  const lista = [];

  tbody.querySelectorAll("tr").forEach(tr => {
    const tds = tr.querySelectorAll("td");
    if (!tds || tds.length < 8) return;

    const doc = (tds[1].textContent || "").trim();
    const nom = (tds[2].textContent || "").trim();
    const porEvalTxt = (tds[6].textContent || "").trim();
    const match = porEvalTxt.match(/\d+/);
    const porEval = match ? parseInt(match[0], 10) : 0;

    if (porEval > 1) {
      lista.push({ documento: doc, nombre: nom, porEvaluar: porEval });
    }
  });

  lista.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
  return lista;
}

function obtenerAprendicesNovedadesProductivaDesdePendientesJuicio(excluirNombresSet) {
  const tabla = document.getElementById("tablaPendientesInstructorReporte8");
  if (!tabla) return [];

  const mapaDoc = obtenerMapaDocumentoPorAprendizDesdeAvance();
  const lista = [];
  const vistos = new Set();

  const tbody = tabla.querySelector("#tbodyPendientesInstructorReporte8");
  if (!tbody) return [];

  tbody.querySelectorAll("tr").forEach(tr => {
    const tds = tr.querySelectorAll("td");
    if (!tds || tds.length < 8) return;

    const competencia = (tds[2].textContent || "").trim();
    if (!competencia) return;

    // Excluir la competencia de etapa práctica
    if (normalizarTextoClaveExport(competencia) === "RESULTADOS DE APRENDIZAJE ETAPA PRACTICA") return;

    const nombres = (tds[7].textContent || "")
      .split(/\n|,|;/g)
      .map(x => x.trim())
      .filter(Boolean);

    nombres.forEach(nom => {
      const clave = normalizarTextoClaveExport(nom);
      if (!clave) return;

      if (excluirNombresSet && excluirNombresSet.has(clave)) return;

      const key = `${clave}||${normalizarTextoClaveExport(competencia)}`;
      if (vistos.has(key)) return;
      vistos.add(key);

      lista.push({
        documento: mapaDoc[clave] || "",
        nombre: nom,
        competencia: competencia
      });
    });
  });

  // Ordenar por nombre
  lista.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
  return lista;
}


function prepararDatosListosParaProductiva() {
    aprendicesListosProductivaParaExportar = [];
    aprendicesPorEvaluarMayor1ParaExportar = [];
    aprendicesNovedadesProductivaParaExportar = [];

    const contResumen = document.getElementById("contenedorResumenPracticaReporte8");
    const contTablas = document.getElementById("contenedorTablasReporte8");

    if (!contResumen || !contTablas) return null;

    const tablaResumen = contResumen.querySelector("table.tabla-resumen-practica");
    const tablaPendientes = contTablas.querySelector("table.tabla-aprendiz-reporte8");

    if (!tablaResumen || !tablaPendientes) return null;

    // 1. Obtener nombres del resumen (los que solo deben práctica)
    const nombresSoloPractica = new Set();

    tablaResumen.querySelectorAll("tbody tr").forEach((tr) => {
        const celdas = tr.querySelectorAll("td");
        if (celdas.length >= 2) {
            const nombre = celdas[1].textContent || "";
            const clave = normalizarTextoClaveExport(nombre);
            if (clave) nombresSoloPractica.add(clave);
        }
    });

    if (nombresSoloPractica.size === 0) return null;

    // 2. Cruzar con la tabla de pendientes para obtener documento y nombre exacto
    const mapaAprendices = {};
    tablaPendientes.querySelectorAll("tbody tr").forEach((tr) => {
        const celdas = tr.querySelectorAll("td");
        if (celdas.length >= 3) {
            const doc = (celdas[1].textContent || "").trim();
            const nom = (celdas[2].textContent || "").trim();
            const clave = normalizarTextoClaveExport(nom);
            if (nombresSoloPractica.has(clave) && !mapaAprendices[clave]) {
                mapaAprendices[clave] = { documento: doc, nombre: nom };
            }
        }
    });

    // 3. Guardar en la variable global
    const listaAprendices = Object.values(mapaAprendices).sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
    aprendicesListosProductivaParaExportar = listaAprendices;

    // 4. Adicionales requeridos: (a) Por evaluar > 1, (b) Novedades (competencia != etapa práctica)
    aprendicesPorEvaluarMayor1ParaExportar = obtenerAprendicesPorEvaluarMayorA1DesdeAvance();

    const excluir = new Set();
    listaAprendices.forEach(ap => excluir.add(normalizarTextoClaveExport(ap.nombre)));
    aprendicesPorEvaluarMayor1ParaExportar.forEach(ap => excluir.add(normalizarTextoClaveExport(ap.nombre)));

    aprendicesNovedadesProductivaParaExportar = obtenerAprendicesNovedadesProductivaDesdePendientesJuicio(excluir);

    // 5. Construir tabla única (Excel) con secciones apiladas
    const hayAlguna = (listaAprendices.length > 0) ||
                      (aprendicesPorEvaluarMayor1ParaExportar.length > 0) ||
                      (aprendicesNovedadesProductivaParaExportar.length > 0);

    if (!hayAlguna) return null;

    const wrapper = document.createElement("div");
    const tabla = document.createElement("table");
    tabla.style.borderCollapse = "collapse";
    tabla.style.fontSize = "10px";
    tabla.style.width = "100%";

    const addFilaTitulo = (texto, colSpan) => {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.textContent = texto;
      td.colSpan = colSpan;
      td.style.fontWeight = "bold";
      td.style.padding = "6px 4px";
      td.style.border = "1px solid #000";
      tr.appendChild(td);
      return tr;
    };

    const addCabecera = (cols) => {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        th.style.fontWeight = "bold";
        th.style.border = "1px solid #000";
        th.style.padding = "4px";
        tr.appendChild(th);
      });
      return tr;
    };

    const addFilaVacia = (colSpan) => {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = colSpan;
      td.innerHTML = "&nbsp;";
      td.style.border = "1px solid #000";
      tr.appendChild(td);
      return tr;
    };

    const tbody = document.createElement("tbody");

    // Sección 1: Listos
    tbody.appendChild(addFilaTitulo("Aprendices listos para ir a etapa productiva", 4));
    tbody.appendChild(addCabecera(["#", "Documento", "Nombre del Aprendiz", ""]));
    if (listaAprendices.length) {
      listaAprendices.forEach((ap, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="border:1px solid #000; padding:4px;">${idx + 1}</td>
          <td style="border:1px solid #000; padding:4px;">${ap.documento || ""}</td>
          <td style="border:1px solid #000; padding:4px;">${ap.nombre || ""}</td>
          <td style="border:1px solid #000; padding:4px;"></td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="border:1px solid #000; padding:4px;"><em>Sin registros.</em></td>`;
      tbody.appendChild(tr);
    }

    tbody.appendChild(addFilaVacia(4));

    // Sección 2: Por evaluar > 1
    tbody.appendChild(addFilaTitulo("Aprendices con más de un RAP por evaluar", 4));
    tbody.appendChild(addCabecera(["#", "Documento", "Nombre del Aprendiz", ""]));
    if (aprendicesPorEvaluarMayor1ParaExportar.length) {
      aprendicesPorEvaluarMayor1ParaExportar.forEach((ap, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="border:1px solid #000; padding:4px;">${idx + 1}</td>
          <td style="border:1px solid #000; padding:4px;">${ap.documento || ""}</td>
          <td style="border:1px solid #000; padding:4px;">${ap.nombre || ""}</td>
          <td style="border:1px solid #000; padding:4px;"></td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="border:1px solid #000; padding:4px;"><em>Sin registros.</em></td>`;
      tbody.appendChild(tr);
    }

    tbody.appendChild(addFilaVacia(4));
    tabla.appendChild(tbody);
    wrapper.appendChild(tabla);
    return wrapper.children.length ? wrapper : null;
}


      // =========================
      // Exportar Acta de Comité a Word
      // =========================
      function exportarActaComiteWord() {
        // Inicializar variables para tablas nuevas
        let tablaRapsNoProgramadosHTML = "";
        let tablaDetalleAlternativaHTML = "";
        let tablaCursosComplementariosAprendizHTML = "";


        // Logo institucional para encabezado Word
        const senaLogoUrl = "https://i.ibb.co/VpwBHTrw/Logosimbolo-SENA-PRINCIPAL-1.png";
        const getText = (id) =>
          (document.getElementById(id)?.textContent || "").trim();

        // Helper para imágenes de gráficos en el acta (ancho 10in)
        const generarImagenGraficoActa = (dataUrl, titulo, fallback) => {
          if (!dataUrl) return fallback;
          return `<div class="tabla-acta-wrap" style="margin:6px auto; text-align:center; width:100%;">
              <div style="width:10in; margin:0 auto;">
                  <img src="${dataUrl}" alt="${titulo}" style="width:10in; height:auto; display:block; margin:0 auto; border:1px solid #d1d5db; object-fit:contain;">
                  ${titulo ? `<div style="font-size:9pt; font-style:italic; margin-top:4px;">${titulo}</div>` : ""}
              </div>
            </div>`;
        };

        const clonarTablaInstructoresPorColor = (color, colWidths = []) => {
          const tablaBase = document.getElementById("tablaInstructoresHoras");
          if (!tablaBase) return "";
          const clone = tablaBase.cloneNode(true);
          clone.removeAttribute("id");
          const tbodyClone = clone.querySelector("tbody");
          if (!tbodyClone) return "";
          const filas = Array.from(tbodyClone.querySelectorAll("tr"));
          let tieneFilas = false;
          filas.forEach(tr => {
            const diasTd = tr.querySelector("td.col-dias");
            const colorFila = (diasTd?.getAttribute("data-color") || "").toLowerCase();
            if (colorFila !== color) {
              tr.remove();
              return;
            }
            tieneFilas = true;
          });
          if (!tieneFilas) return "";
          const tfootClone = clone.querySelector("tfoot");
          if (tfootClone) tfootClone.remove();
          const tbodyId = clone.querySelector("#tbodyReporte3");
          if (tbodyId) tbodyId.removeAttribute("id");
          const tfootId = clone.querySelector("#tfootReporte3");
          if (tfootId) tfootId.removeAttribute("id");
          quitarIconosOrdenTabla(clone);
          estilizarTablaActa(clone, colWidths);
          formatearFechasTablaActa(clone, [4, 5]);
          const filasFiltradas = Array.from(clone.querySelectorAll("tbody tr"));
          filasFiltradas.forEach((tr, index) => {
            const numTd = tr.querySelector("td:first-child");
            if (numTd) numTd.textContent = index + 1;
          });
          return clone.outerHTML;
        };

        function rgbToHex(rgb) {
          const m = String(rgb).match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
          if (!m) return null;
          const r = (+m[1]).toString(16).padStart(2, "0");
          const g = (+m[2]).toString(16).padStart(2, "0");
          const b = (+m[3]).toString(16).padStart(2, "0");
          return `#${r}${g}${b}`;
        }

        function normalizarGanttParaWord(originalTable, clonedTable) {
          if (!originalTable || !clonedTable) return;

          const origRows = originalTable.querySelectorAll("tbody tr");
          const cloneRows = clonedTable.querySelectorAll("tbody tr");

          origRows.forEach((origRow, r) => {
            const cloneRow = cloneRows[r];
            if (!cloneRow) return;

            const origCells = Array.from(origRow.children);
            const cloneCells = Array.from(cloneRow.children);

            origCells.forEach((origCell, c) => {
              const cloneCell = cloneCells[c];
              if (!cloneCell) return;

              const origBar = origCell.querySelector(".gantt-month-bar");
              if (origBar) {
                const barBg = window.getComputedStyle(origBar).backgroundColor;
                if (barBg && barBg !== "transparent" && !barBg.includes("rgba(0, 0, 0, 0)")) {
                  const hex = rgbToHex(barBg);
                  cloneCell.style.backgroundColor = barBg;
                  if (hex) cloneCell.setAttribute("bgcolor", hex);
                  cloneCell.innerHTML = "&nbsp;";
                  cloneCell.style.height = "10px";
                }
                cloneCell.style.color = "#000";
                return;
              }

              const cellBg = window.getComputedStyle(origCell).backgroundColor;
              if (cellBg && cellBg !== "transparent" && !cellBg.includes("rgba(0, 0, 0, 0)")) {
                const hex = rgbToHex(cellBg);
                cloneCell.style.backgroundColor = cellBg;
                if (hex) cloneCell.setAttribute("bgcolor", hex);
                cloneCell.style.color = "#000";
              }
            });
          });
        }

        const obtenerNombresEquipoPorColor = (color) => {
          const tablaBase = document.getElementById("tablaInstructoresHoras");
          if (!tablaBase) return [];
          const nombresSet = new Set();
          const filas = tablaBase.querySelectorAll("tbody tr");
          filas.forEach(tr => {
            const diasTd = tr.querySelector("td.col-dias");
            const colorFila = (diasTd?.getAttribute("data-color") || "").toLowerCase();
            if (colorFila === color) {
              const nombre = (tr.cells[1]?.textContent || "").trim();
              const apellido = (tr.cells[2]?.textContent || "").trim();
              const completo = `${nombre} ${apellido}`.trim();
              if (completo) nombresSet.add(completo);
            }
          });
          return Array.from(nombresSet);
        };

        // Datos existentes de la ficha
        const nombrePrograma = getText("nombrePrograma") || "____________________";
        const codigoFicha = getText("codigoFicha") || "__________";
        const instructorGerente = getText("instructorMasHorasHeader") || "____________________";
        const coordinadorAcademico = getText("coordinadorAcademicoHeader") || "Nombre Coordinador Académico";
        const aprendizVocero = getText("aprendizVoceroHeader") || "Nombre Aprendiz Vocero";
        const nivelFormacionActa = nivelFormacionGlobal ? `${nivelFormacionGlobal} - ` : "";
        const avancePromedioGrupo = getText("avancePromedioGrupoHeader") || "0 %";
        const numCompetencias = getText("numCompetenciasHeader") || "0";
        const numResultados = getText("numResultadosHeader") || "0";
        const fechaInicioLectiva = getText("fechaInicioLectiva") || "N/A";
        const fechaFinLectiva = getText("fechaFinLectiva") || "N/A";
        const fechaInicioProd = getText("fechaInicioProductiva") || "N/A";
        const fechaFinProd = getText("fechaFinProductiva") || "N/A";
        const tiempoRestanteLectiva = getText("tiempoRestanteLectiva") || "-";
        const tiempoRestanteProductiva = getText("tiempoRestanteProductiva") || "-";
        const etapaEnProceso = getText("estadoEtapaMini") || "-";
        // 3. Datos de aprendices para el acta
        const totalAprendicesEstado = getText("totalAprendicesEstado") || "0";
        const datosFallasAprendices = [];

        const nombresEquipoFormacion = obtenerNombresEquipoPorColor("verde");
        const equipoFormacionTexto = nombresEquipoFormacion.length
          ? nombresEquipoFormacion.join(", ")
          : "<em>(No se encontraron instructores en formación al momento de generar el acta.)</em>";
        const nombresEquipoVisto = obtenerNombresEquipoPorColor("rojo");
        const equipoVistoTexto = nombresEquipoVisto.length
          ? nombresEquipoVisto.join(", ")
          : "<em>(No se encontraron instructores en el filtro 'Visto' al momento de generar el acta.)</em>";
        const tablaEquipoFormacionHTML = clonarTablaInstructoresPorColor("verde", ["5%", "18%", "18%", "14%", "13%", "13%", "8%", "11%"]);
        const tablaEquipoVistoHTML = clonarTablaInstructoresPorColor("rojo", ["5%", "18%", "18%", "14%", "13%", "13%", "8%", "11%"]);

        // Gráfico circular de estados (CanvasJS) para incrustar en el acta
        if (estadoChart && typeof estadoChart.render === "function") {
          try {
            estadoChart.render();
          } catch (err) {
            console.warn("No se pudo renderizar el grafico de estados antes de exportar el acta", err);
          }
        }
        const graficoEstadosDataURL = capturarGraficoComoImg(".estado-chart-wrapper");
        const graficoEstadoActaHTML = generarImagenGraficoActa(
          graficoEstadosDataURL,
          "Distribución de estados de aprendices",
          "<em>(No se pudo capturar el grafico de estados al momento de generar el acta.)</em>"
        );

        // Gráfico de competencias vs diseño (CanvasJS) para la sección 2.4.1
        if (chartCompetenciasHoras && typeof chartCompetenciasHoras.render === "function") {
          try {
            chartCompetenciasHoras.render();
          } catch (err) {
            console.warn("No se pudo renderizar el grafico de competencias antes de exportar el acta", err);
          }
        }
        const graficoCompetenciasDataURL = capturarGraficoComoImg("#chartCompetenciasHorasContainer");
        const graficoCompetenciasActaHTML = generarImagenGraficoActa(
          graficoCompetenciasDataURL,
          "Avance por competencia (horas vs diseño)",
          "<em>(No se pudo capturar el grafico de competencias al momento de generar el acta.)</em>"
        );

        // Gráfico de Total de Horas Programadas por Instructor (CanvasJS) para el acta
        if (chartHorasInstructores && typeof chartHorasInstructores.render === "function") {
          try {
            chartHorasInstructores.render();
          } catch (err) {
            console.warn("No se pudo renderizar el grafico de horas por instructor antes de exportar el acta", err);
          }
        }
        const graficoHorasInstructoresDataURL = capturarGraficoComoImg("#chartInstructoresHorasContainer");
        const graficoHorasInstructoresActaHTML = generarImagenGraficoActa(
          graficoHorasInstructoresDataURL,
          "Total de horas programadas por instructor",
          "<em>(No se pudo capturar el grafico de horas por instructor al momento de generar el acta.)</em>"
        );

        // 3.1 – Detalle de Aprendices (tabla de estados)
        let tablaDetalleAprendicesHTML = "";
        const tablaEstadoElem = document.getElementById("tablaEstado");
        if (tablaEstadoElem) {
          const cloneEstado = tablaEstadoElem.cloneNode(true);

          // Evitar ids duplicados
          cloneEstado.removeAttribute("id");
          const tbodyEstado = cloneEstado.querySelector("#tbodyEstado");
          if (tbodyEstado) tbodyEstado.removeAttribute("id");

          // Misma lógica de distribución que las tablas de instructores
          cloneEstado.classList.add("tabla-estado-aprendices");
          cloneEstado.style.width = "85%";
          cloneEstado.style.borderCollapse = "collapse";
          cloneEstado.style.tableLayout = "fixed";
          cloneEstado.style.marginTop = "4px";
          cloneEstado.style.marginLeft = "auto";
          cloneEstado.style.marginRight = "auto";

          // Definir anchos de columnas: Estado / Nombres / Cant / %
          const oldCg = cloneEstado.querySelector("colgroup");
          if (oldCg) oldCg.remove();

          const colgroup = document.createElement("colgroup");
          ["18%", "57%", "10%", "15%"].forEach((w) => {
            const col = document.createElement("col");
            col.style.width = w;
            colgroup.appendChild(col);
          });
          cloneEstado.insertBefore(colgroup, cloneEstado.firstElementChild);
          quitarIconosOrdenTabla(cloneEstado);

          tablaDetalleAprendicesHTML = cloneEstado.outerHTML;
        }

        // 3.2 – % Avance por Aprendiz y Fallas
        let tablaAvanceAprendicesHTML = "";
        const pivotBody = document.getElementById("pivotAvanceContainer");
        if (pivotBody && typeof pivotBody.closest === "function") {
          const tablaAvanceElem = pivotBody.closest("table");

          // Recolectar datos de fallas para la gráfica (solo aprendices con fallas > 0)
          const datosFallasParaGrafico = [];
          pivotBody.querySelectorAll("tr").forEach((tr) => {
            const celdas = tr.querySelectorAll("td");
            if (celdas.length >= 4) {
              const fallas = parseFloat((celdas[3].textContent || "").replace(",", ".") || "0");
              if (fallas > 0) {
                datosFallasParaGrafico.push({
                  label: (celdas[2].textContent || "").trim(),
                  fallas
                });
                datosFallasAprendices.push({
                  doc: (celdas[1].textContent || "").trim(),
                  nombre: (celdas[2].textContent || "").trim(),
                  fallas: fallas
                });
              }
            }
          });
          if (tablaAvanceElem) {
            const cloneAvance = tablaAvanceElem.cloneNode(true);

            // Evitar ids duplicados
            cloneAvance.removeAttribute("id");
            const tbodyAvance = cloneAvance.querySelector("#pivotAvanceContainer");
            if (tbodyAvance) tbodyAvance.removeAttribute("id");

            // Misma lógica visual que las otras tablas
            cloneAvance.classList.add("tabla-avance-aprendices");
            cloneAvance.style.width = "85%";
            cloneAvance.style.borderCollapse = "collapse";
            cloneAvance.style.tableLayout = "fixed";
            cloneAvance.style.marginTop = "4px";
            cloneAvance.style.marginLeft = "auto";
            cloneAvance.style.marginRight = "auto";

            // Definir anchos de columnas:
            // # / Doc / Nombre / Fallas / Detalles / Aprobado / Por Evaluar / % Avance
            const oldCg2 = cloneAvance.querySelector("colgroup");
            if (oldCg2) oldCg2.remove();

            const colgroup2 = document.createElement("colgroup");
            const widths2 = ["5%", "17%", "30%", "8%", "16%", "7%", "7%", "10%"];
            widths2.forEach((w) => {
              const col = document.createElement("col");
              col.style.width = w;
              colgroup2.appendChild(col);
            });
            cloneAvance.insertBefore(colgroup2, cloneAvance.firstElementChild);

            quitarIconosOrdenTabla(cloneAvance);
            const ordenarFilasActaAvance = (tbody) => {
              if (!tbody) return;
              const filas = Array.from(tbody.querySelectorAll("tr"));
              const obtenerFallas = (tr) => {
                const celdas = tr.querySelectorAll("td");
                const raw = (celdas[3]?.textContent || "").replace(",", ".") || "0";
                const num = parseFloat(raw);
                return Number.isFinite(num) ? num : 0;
              };
              const obtenerNombre = (tr) => {
                const celdas = tr.querySelectorAll("td");
                return (celdas[2]?.textContent || "").trim();
              };
              filas.sort((a, b) => {
                const fallasA = obtenerFallas(a);
                const fallasB = obtenerFallas(b);
                if (fallasA !== fallasB) return fallasB - fallasA;
                const nombreA = obtenerNombre(a).toUpperCase();
                const nombreB = obtenerNombre(b).toUpperCase();
                return nombreA.localeCompare(nombreB, "es", { sensitivity: "base" });
              });
              tbody.innerHTML = "";
              filas.forEach((tr, index) => {
                const primero = tr.querySelector("td:first-child");
                if (primero) primero.textContent = index + 1;
                tbody.appendChild(tr);
              });
            };
            ordenarFilasActaAvance(cloneAvance.querySelector("tbody"));

            tablaAvanceAprendicesHTML = cloneAvance.outerHTML;
          }

          // Renderizar gráfica de fallas en el reporte (CanvasJS)
          renderGraficoFallasReporte7(datosFallasParaGrafico);
        }

        const graficoFallasAprendicesHTML = (() => {
          // Capturar el CanvasJS del reporte (si existe) para el acta
          if (chartFallasReporte7 && typeof chartFallasReporte7.render === "function") {
            try { chartFallasReporte7.render(); } catch (err) { }
          }
          const dataURL = capturarGraficoComoImg("#graficoFallasReporte7Container");
          if (!dataURL) return "";
          return `<div style="width:100%; text-align:center; margin:8px auto 10px;">
      <img src="${dataURL}" alt="Aprendices con fallas" style="width:9cm; height:auto; display:block; margin:0 auto; border:1px solid #d1d5db; padding:2px; box-sizing:border-box; object-fit:contain;">
    </div>`;
        })();

        // 3.3 – Competencias pendientes por evaluar por cada aprendiz
        // 3.4 – Aprendices listos para ir a etapa productiva
        let tablaPendientesAprendizHTML = "";
        let tablaListosProductivaHTML = "";
        let tablaPorEvaluarMasDe1HTML = "";


        const contTablasReporte8 = document.getElementById("contenedorTablasReporte8");
        const contResumenReporte8 = document.getElementById("contenedorResumenPracticaReporte8");

        if (contTablasReporte8) {
          // Tabla ÚNICA visible del reporte 8
          const tablaPendientesElem = contTablasReporte8.querySelector("table.tabla-aprendiz-reporte8");

          if (tablaPendientesElem) {
            // ===== 3.3 – Competencias pendientes por evaluar por cada aprendiz =====
            const clonePendientes = tablaPendientesElem.cloneNode(true);

            // Evitar ids duplicados en el DOM del Word
            clonePendientes.removeAttribute("id");

            // Quitar la primera columna (#) para que queden solo:
            // Documento | Nombre | Competencias Pendientes | Instructor
            const filas = clonePendientes.querySelectorAll("tr");
            filas.forEach((tr) => {
              if (tr.firstElementChild) {
                tr.removeChild(tr.firstElementChild);
              }
            });

            // Ajuste de estilo como las demás tablas del acta
            clonePendientes.classList.add("tabla-avance-aprendices");
            clonePendientes.style.width = "85%";
            clonePendientes.style.borderCollapse = "collapse";
            clonePendientes.style.tableLayout = "fixed";
            clonePendientes.style.marginTop = "4px";
            clonePendientes.style.marginLeft = "auto";
            clonePendientes.style.marginRight = "auto";

            // Encabezado con fondo gris y bordes (para que Word lo respete)
            const encabezados = clonePendientes.querySelectorAll("thead tr th, thead tr td");
            encabezados.forEach((th) => {
              th.style.backgroundColor = "#e5e7eb";
              th.style.fontWeight = "bold";
              th.style.textAlign = "center";
              th.style.border = "1px solid #000000";
              th.style.padding = "4px 6px";
              th.style.fontSize = "8.5pt";
            });

            // Cuerpo de la tabla (bordes y tamaño de fuente)
            const celdasCuerpo = clonePendientes.querySelectorAll("tbody tr td");
            celdasCuerpo.forEach((td) => {
              td.style.border = "1px solid #000000";
              td.style.padding = "4px 6px";
              td.style.fontSize = "8.5pt";
              td.style.verticalAlign = "top";
            });

            // Anchos de columnas: Documento / Nombre / Competencias / Instructor
            const oldCg3 = clonePendientes.querySelector("colgroup");
            if (oldCg3) oldCg3.remove();

            const colgroup3 = document.createElement("colgroup");
          ["18%", "32%", "30%", "20%"].forEach((w) => {
            const col = document.createElement("col");
            col.style.width = w;
            colgroup3.appendChild(col);
          });
          clonePendientes.insertBefore(colgroup3, clonePendientes.firstElementChild);
          quitarIconosOrdenTabla(clonePendientes);

          tablaPendientesAprendizHTML = clonePendientes.outerHTML;

            // ===== 3.4 - Aprendices listos para ir a etapa productiva =====
            // Solo aplica si existe el resumen de etapa práctica del reporte 8
            aprendicesListosProductivaParaExportar = [];
            if (contResumenReporte8) {
              const tablaResumen = contResumenReporte8.querySelector("table.tabla-resumen-practica");

              // Normaliza texto como en el reporte 8
              const normalizarClave = (texto) =>
                (texto || "")
                  .toString()
                  .normalize("NFD")
                  .replace(/[\u0300-\u036f]/g, "")
                  .toUpperCase()
                  .trim()
                  .replace(/\s+/g, " ");

              if (tablaResumen) {
                // 1) Nombres de aprendices que solo tienen pendiente la etapa práctica
                const nombresSoloPractica = new Set();
                const filasResumen = tablaResumen.querySelectorAll("tbody tr");

                filasResumen.forEach((tr) => {
                  const celdas = tr.querySelectorAll("td");
                  if (celdas.length >= 2) {
                    const nombre = celdas[1].textContent || "";
                    const clave = normalizarClave(nombre);
                    if (clave) nombresSoloPractica.add(clave);
                  }
                });

                if (nombresSoloPractica.size > 0) {
                  // 2) Buscar documento + nombre en la tabla de pendientes
                  const mapaAprendices = {};
                  const filasPend = tablaPendientesElem.querySelectorAll("tbody tr");

                  filasPend.forEach((tr) => {
                    const celdas = tr.querySelectorAll("td");
                    if (celdas.length >= 3) {
                      const doc = (celdas[1].textContent || "").trim();
                      const nom = (celdas[2].textContent || "").trim();
                      const clave = normalizarClave(nom);

                      if (nombresSoloPractica.has(clave) && !mapaAprendices[clave]) {
                        mapaAprendices[clave] = {
                          documento: doc,
                          nombre: nom,
                        };
                      }
                    }
                  });

                  const listaAprendices = Object.values(mapaAprendices).sort((a, b) =>
                    a.nombre.toUpperCase().localeCompare(b.nombre.toUpperCase())
                  );

                  if (listaAprendices.length > 0) {
                    aprendicesListosProductivaParaExportar = listaAprendices.map(ap => ({
                      nombre: ap.nombre,
                      documento: ap.documento
                    }));
                  } else {
                    aprendicesListosProductivaParaExportar = [];
                  }

                  if (listaAprendices.length > 0) {
                    const tablaListos = document.createElement("table");
                    tablaListos.classList.add("tabla-avance-aprendices");
                    tablaListos.style.width = "85%";
                    tablaListos.style.borderCollapse = "collapse";
                    tablaListos.style.tableLayout = "fixed";
                    tablaListos.style.marginTop = "4px";
                    tablaListos.style.marginLeft = "auto";
                    tablaListos.style.marginRight = "auto";

                    // Columnas: # / Documento / Nombre
                    const colgroupL = document.createElement("colgroup");
                    ["12%", "28%", "60%"].forEach((w) => {
                      const col = document.createElement("col");
                      col.style.width = w;
                      colgroupL.appendChild(col);
                    });
                    tablaListos.appendChild(colgroupL);

                    const theadL = document.createElement("thead");
                    const trHeadL = document.createElement("tr");
                    ["#", "Documento", "Nombre del Aprendiz"].forEach((texto) => {
                      const th = document.createElement("th");
                      th.textContent = texto;
                      th.style.backgroundColor = "#e5e7eb";
                      th.style.fontWeight = "bold";
                      th.style.textAlign = "center";
                      th.style.border = "1px solid #000000";
                      th.style.padding = "4px 6px";
                      th.style.fontSize = "8.5pt";
                      trHeadL.appendChild(th);
                    });
                    theadL.appendChild(trHeadL);
                    tablaListos.appendChild(theadL);

                    const tbodyL = document.createElement("tbody");
                    listaAprendices.forEach((ap, index) => {
                      const trL = document.createElement("tr");

                      const tdNum = document.createElement("td");
                      tdNum.textContent = index + 1;

                      const tdDoc = document.createElement("td");
                      tdDoc.textContent = ap.documento || "";

                      const tdNom = document.createElement("td");
                      tdNom.textContent = ap.nombre || "";

                      [tdNum, tdDoc, tdNom].forEach((td) => {
                        td.style.border = "1px solid #000000";
                        td.style.padding = "4px 6px";
                        td.style.fontSize = "8.5pt";
                        td.style.verticalAlign = "top";
                      });

                      trL.appendChild(tdNum);
                      trL.appendChild(tdDoc);
                      trL.appendChild(tdNom);
                      tbodyL.appendChild(trL);
                    });

                    tablaListos.appendChild(tbodyL);
                    tablaListosProductivaHTML = tablaListos.outerHTML;
                    // ===== 3.4.A – Aprendices con novedades para ir a etapa productiva (desde % Avance por Aprendiz) =====
                    const normalizarClaveLocal = (texto) => (texto || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim().replace(/\s+/g, " ");
                    const setListosLocal = new Set();
                    try {
                      tablaListos.querySelectorAll("tbody tr").forEach(trx => {
                        const tdx = trx.querySelectorAll("td");
                        if (tdx && tdx.length >= 3) {
                          setListosLocal.add(normalizarClaveLocal(tdx[2].textContent || ""));
                        }
                      });
                    } catch (e) {}

                    const listaMasDe1 = [];
                    const tbodyAv = document.getElementById("pivotAvanceContainer");
                    if (tbodyAv) {
                      tbodyAv.querySelectorAll("tr").forEach(trx => {
                        const tdsx = trx.querySelectorAll("td");
                        if (!tdsx || tdsx.length < 8) return;

                        const docx = (tdsx[1].textContent || "").trim();
                        const nomx = (tdsx[2].textContent || "").trim();
                        const porEvalTxt = (tdsx[6].textContent || "").trim();
                        const m = porEvalTxt.match(/\d+/);
                        const porEval = m ? parseInt(m[0], 10) : 0;

                        // condición solicitada: por evaluar > 1
                        if (porEval > 1 && !setListosLocal.has(normalizarClaveLocal(nomx))) {
                          listaMasDe1.push({ documento: docx, nombre: nomx });
                        }
                      });
                    }
                    listaMasDe1.sort((a,b) => (a.nombre||"").localeCompare(b.nombre||""));

                    if (listaMasDe1.length) {
                      const tablaMas1 = document.createElement("table");
                      tablaMas1.classList.add("tabla-avance-aprendices", "tabla-competencias-pendientes");
                      tablaMas1.style.width = "100%";
                      tablaMas1.style.borderCollapse = "collapse";

                      const theadM = document.createElement("thead");
                      const trHM = document.createElement("tr");
                      ["#", "Documento", "Nombre del Aprendiz"].forEach(txt => {
                        const th = document.createElement("th");
                        th.textContent = txt;
                        th.style.fontWeight = "bold";
                        th.style.border = "1px solid #000";
                        th.style.padding = "4px 6px";
                        th.style.fontSize = "8.5pt";
                        trHM.appendChild(th);
                      });
                      theadM.appendChild(trHM);
                      tablaMas1.appendChild(theadM);

                      const tbodyM = document.createElement("tbody");
                      listaMasDe1.forEach((ap, i) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                          <td style="border:1px solid #000; padding:4px 6px; font-size:8.5pt;">${i+1}</td>
                          <td style="border:1px solid #000; padding:4px 6px; font-size:8.5pt;">${ap.documento || ""}</td>
                          <td style="border:1px solid #000; padding:4px 6px; font-size:8.5pt;">${ap.nombre || ""}</td>
                        `;
                        tbodyM.appendChild(tr);
                      });
                      tablaMas1.appendChild(tbodyM);

                      tablaPorEvaluarMasDe1HTML = tablaMas1.outerHTML;
                    }

                  }
                }
              }
            }
          }
        }
        // 3.X – Listado de Instructores con aprendices pendientes por emitir Juicio
        let tablaPendientesJuicioHTML = "";
        const tablaPendInstrJuicio = document.getElementById("tablaPendientesInstructorReporte8");

        if (tablaPendInstrJuicio) {
          const clonePendJuicio = tablaPendInstrJuicio.cloneNode(true);

          // Evitar ids duplicados
          clonePendJuicio.removeAttribute("id");
          const tbodyPendJuicio = clonePendJuicio.querySelector("#tbodyPendientesInstructorReporte8");
          if (tbodyPendJuicio) tbodyPendJuicio.removeAttribute("id");

          // Mismo estilo que las demás tablas del acta
          clonePendJuicio.classList.add("tabla-pendientes-juicio");
          clonePendJuicio.style.width = "85%";
          clonePendJuicio.style.borderCollapse = "collapse";
          clonePendJuicio.style.tableLayout = "fixed";
          clonePendJuicio.style.marginTop = "4px";
          clonePendJuicio.style.marginLeft = "auto";
          clonePendJuicio.style.marginRight = "auto";

          // Anchos de columnas: # / Instructor / Competencia / Aprendices / Cantidad
          const oldCgPend = clonePendJuicio.querySelector("colgroup");
          if (oldCgPend) oldCgPend.remove();

          const colgroupPend = document.createElement("colgroup");
          ["6%", "28%", "26%", "25%", "15%"].forEach((w) => {
            const col = document.createElement("col");
            col.style.width = w;
            colgroupPend.appendChild(col);
          });
          clonePendJuicio.insertBefore(colgroupPend, clonePendJuicio.firstElementChild);
          quitarIconosOrdenTabla(clonePendJuicio);

          tablaPendientesJuicioHTML = clonePendJuicio.outerHTML;
            }

        const ciudad = municipioFicha || "Ibagué";

        const ahora = new Date();
        const opcionesFecha = { year: "numeric", month: "2-digit", day: "2-digit" };
        const opcionesHora = { hour: "2-digit", minute: "2-digit", hour12: false };

        const fechaHoy = ahora.toLocaleDateString("es-CO", opcionesFecha);
        const horaInicio = ahora.toLocaleTimeString("es-CO", opcionesHora);

        // =========================
        // 2.2 Instructores: tablas desde registrosGlobal
        // =========================
        let tablaInstructoresCompetenciasHTML = "";
        let tablaCompetenciasHorasHTML = "";
        let tablaCompetenciasSobreEjecutadasHTML = "";
        let tablaCompetenciasProgramadasPendientesHTML = "";   // NUEVO: reporte 4 en el acta
        let tablaRapsPorEvaluarHTML = "";
        let tablaRapsOtroInstructorHTML = "";   // NUEVO: RAPs evaluados por instructor no programado
        let tablaCronogramaGanttHTML = "";   // NUEVO: Cronograma Gantt de Competencias

        const tablaReporte1Elem = document.getElementById("tablaReporte1");
        if (tablaReporte1Elem) {
          const cloneReporte1 = tablaReporte1Elem.cloneNode(true);
          cloneReporte1.removeAttribute("id");
          const tbodyClone1 = cloneReporte1.querySelector("#tbodyReporte1");
          if (tbodyClone1) tbodyClone1.removeAttribute("id");
          const tfootClone1 = cloneReporte1.querySelector("tfoot");
          if (tfootClone1) tfootClone1.removeAttribute("id");
          quitarIconosOrdenTabla(cloneReporte1);
          estilizarTablaActa(cloneReporte1, ["4%", "14%", "14%", "10%", "10%", "8%", "20%", "11%", "9%"]);
          formatearFechasTablaActa(cloneReporte1, [4, 5]);
          tablaInstructoresCompetenciasHTML = `<div class="tabla-acta-wrap" style="margin-top:4px;">${cloneReporte1.outerHTML}</div>`;
        }

        if (Array.isArray(registrosGlobal) && registrosGlobal.length > 0) {
          // 2.4 - Competencias y % de avance (Reporte % Competencias con Horas)
          tablaCompetenciasHorasHTML = "";
          tablaCompetenciasSobreEjecutadasHTML = "";

          const tbodyReporte2 = document.getElementById("tbodyReporte2");

          if (tbodyReporte2 && typeof tbodyReporte2.closest === "function") {
            const tablaCompHoras = tbodyReporte2.closest("table");
            if (tablaCompHoras) {
              // ===== 2.4.1 – Tabla completa % Competencias con Horas =====
              const cloneCompHoras = tablaCompHoras.cloneNode(true);

              // Evitar ids duplicados dentro del documento Word
              cloneCompHoras.removeAttribute("id");
              const tbodyClone = cloneCompHoras.querySelector("#tbodyReporte2");
              if (tbodyClone) tbodyClone.removeAttribute("id");
              const tfootClone = cloneCompHoras.querySelector("#tfootReporte2");
              if (tfootClone) tfootClone.removeAttribute("id");

              // Ajuste visual igual a las demás tablas
              cloneCompHoras.classList.add("tabla-competencias-horas");
              cloneCompHoras.style.width = "85%";
              cloneCompHoras.style.borderCollapse = "collapse";
              cloneCompHoras.style.tableLayout = "fixed";
              cloneCompHoras.style.marginTop = "4px";
              cloneCompHoras.style.marginLeft = "auto";
              cloneCompHoras.style.marginRight = "auto";

              // Definir anchos de columnas: # / Competencia / Total Horas / Horas Diseño / %
              let oldCgCH = cloneCompHoras.querySelector("colgroup");
              if (oldCgCH) oldCgCH.remove();

              let colgroupCH = document.createElement("colgroup");
              const widthsCH = ["6%", "46%", "16%", "16%", "16%"];
              widthsCH.forEach((w) => {
                const col = document.createElement("col");
                col.style.width = w;
                colgroupCH.appendChild(col);
              });
              cloneCompHoras.insertBefore(colgroupCH, cloneCompHoras.firstElementChild);
              quitarIconosOrdenTabla(cloneCompHoras);

              tablaCompetenciasHorasHTML = cloneCompHoras.outerHTML;

              // ===== Cronograma Gantt de Competencias para el acta =====
                tablaCronogramaGanttHTML = "";
                const detalleTabla = document.querySelector("#anychartGanttContainer .tabla-gantt-detalle");
                if (detalleTabla) {
                  const cloneGantt = detalleTabla.cloneNode(true);
                  normalizarGanttParaWord(detalleTabla, cloneGantt);

                  cloneGantt.classList.add("tabla-cronograma-gantt");
                cloneGantt.style.width = "100%";
                cloneGantt.style.maxWidth = "100%";
                cloneGantt.style.tableLayout = "fixed";
                cloneGantt.style.borderCollapse = "collapse";
                cloneGantt.style.margin = "0 auto";
                cloneGantt.style.fontSize = "6pt";

                const headerRow = cloneGantt.querySelector("thead tr");
                const columnasARemover = [];
                if (headerRow) {
                  Array.from(headerRow.children).forEach((th, idx) => {
                    const texto = (th.textContent || "").toLowerCase();
                    if (texto.includes("inicio") || texto.includes("fin")) {
                      columnasARemover.push(idx);
                    }
                  });
                }
                columnasARemover.sort((a, b) => b - a);
                columnasARemover.forEach(colIdx => {
                  cloneGantt.querySelectorAll("tr").forEach(tr => {
                    if (tr.children[colIdx]) {
                      tr.children[colIdx].remove();
                    }
                  });
                });
                const colgroup = cloneGantt.querySelector("colgroup");
                if (colgroup) {
                  const cols = Array.from(colgroup.children);
                  columnasARemover.forEach(colIdx => {
                    if (cols[colIdx]) {
                      cols[colIdx].remove();
                    }
                  });
                }

                const encabezados = cloneGantt.querySelectorAll("th");
                const competenciaIdx = Array.from(encabezados).findIndex(th => (th.textContent || "").toLowerCase().includes("competencia"));
                if (competenciaIdx >= 0) {
                  cloneGantt.querySelectorAll("tbody tr").forEach(row => {
                    const cell = row.children[competenciaIdx];
                    if (cell) {
                      const raw = (cell.textContent || "").trim();
                      cell.textContent = raw.length > 20 ? `${raw.slice(0, 20)}...` : raw;
                    }
                  });
                }

                // Ajustar estilos y quitar íconos en encabezados
                quitarIconosOrdenTabla(cloneGantt);
                cloneGantt.querySelectorAll("th").forEach(th => {
                  th.style.border = "1px solid #000";
                  th.style.fontSize = "6pt";
                  th.style.padding = "2px";
                  th.style.textAlign = "center";
                  th.style.wordWrap = "break-word";
                  th.style.overflow = "hidden";
                });

                // Ajustar celdas de datos para el acta (sin tocar backgroundColor)
                  cloneGantt.querySelectorAll("td").forEach(td => {
                    td.style.border = "1px solid #000";
                    td.style.fontSize = "6pt";
                    td.style.padding = "2px";
                    td.style.textAlign = "center";
                    td.style.wordWrap = "break-word";
                    td.style.overflow = "hidden";
                    // IMPORTANTE: No tocar td.style.backgroundColor
                  });

                tablaCronogramaGanttHTML = `
                  <div style="width:100%; max-width:100%; overflow-x:auto; margin:0 auto;">
                    ${cloneGantt.outerHTML}
                  </div>
                `;
              }

              // 2.4.3 – Competencias programadas y pendientes (Reporte 4: Programada Sí/No)
              tablaCompetenciasProgramadasPendientesHTML = "";
              const tbodyReporte4 = document.getElementById("tbodyReporte4");

              if (tbodyReporte4 && typeof tbodyReporte4.closest === "function") {
                const tablaRep4 = tbodyReporte4.closest("table");
                if (tablaRep4) {
                  const cloneRep4 = tablaRep4.cloneNode(true);

                  // Limpiar ids para que no se dupliquen en el documento Word
                  cloneRep4.removeAttribute("id");
                  const tbodyClone4 = cloneRep4.querySelector("#tbodyReporte4");
                  if (tbodyClone4) {
                    tbodyClone4.removeAttribute("id");

                    // Filtrar: solo mostrar No y 1/2, eliminar las que tienen "Sí"
                    const filas4 = Array.from(tbodyClone4.querySelectorAll("tr"));
                    filas4.forEach(tr => {
                      const celdas = tr.getElementsByTagName("td");
                      if (!celdas.length) return;

                      // Detectar si es fila de cabecera de categoría (tiene colspan)
                      const esFilaCabecera = celdas[0]?.hasAttribute("colspan");
                      if (esFilaCabecera) return; // No procesar cabeceras aún

                      const diasTd = tr.querySelector("td.col-dias");
                      const colorDias = (diasTd?.getAttribute("data-color") || "").toLowerCase();
                      if (colorDias !== "pendiente") {
                        tr.remove();
                        return;
                      }

                      // Columna 3 = "Programada"
                      const valorProg = (celdas[2]?.textContent || "").trim().toUpperCase();
                      if (valorProg === "SÍ" || valorProg === "SI") {
                        tr.remove();  // Eliminar filas con "Sí"
                      } else if (valorProg === "NO" || valorProg === "1/2") {
                        tr.classList.add("textoRojo");   // Resaltar en rojo las No y 1/2
                      }
                    });

                    // Eliminar cabeceras de categoría que quedaron sin competencias
                    const filasRestantes = Array.from(tbodyClone4.querySelectorAll("tr"));
                    filasRestantes.forEach((tr, index) => {
                      const celdas = tr.getElementsByTagName("td");
                      if (!celdas.length) return;

                      const esFilaCabecera = celdas[0]?.hasAttribute("colspan");
                      if (esFilaCabecera) {
                        // Verificar si la siguiente fila es otra cabecera o no existe (categoría vacía)
                        const siguienteFila = filasRestantes[index + 1];
                        if (!siguienteFila) {
                          tr.remove(); // No hay más filas, eliminar cabecera
                        } else {
                          const celdasSig = siguienteFila.getElementsByTagName("td");
                          const sigEsCabecera = celdasSig[0]?.hasAttribute("colspan");
                          if (sigEsCabecera) {
                            tr.remove(); // La siguiente también es cabecera, esta categoría está vacía
                          }
                        }
                      }
                    });

                  }

                  // Estilo de tabla igual a las demás del acta
                  cloneRep4.classList.add("tabla-competencias-pendientes");  // reutiliza la clase de tablas del acta
                  cloneRep4.style.width = "85%";
                  cloneRep4.style.borderCollapse = "collapse";
                  cloneRep4.style.tableLayout = "fixed";
                  cloneRep4.style.marginTop = "4px";
                  cloneRep4.style.marginLeft = "auto";
                  cloneRep4.style.marginRight = "auto";

                  // Columnas: # / Competencia / Programada
                  const oldCg4 = cloneRep4.querySelector("colgroup");
                  if (oldCg4) oldCg4.remove();

                  const colgroup4 = document.createElement("colgroup");
                  ["8%", "72%", "20%"].forEach(w => {
                    const col = document.createElement("col");
                    col.style.width = w;
                    colgroup4.appendChild(col);
                  });
                  cloneRep4.insertBefore(colgroup4, cloneRep4.firstElementChild);
                  quitarIconosOrdenTabla(cloneRep4);
                  const filasRestantes = cloneRep4.querySelectorAll("tbody tr");
                  tablaCompetenciasProgramadasPendientesHTML = filasRestantes.length > 0 ? cloneRep4.outerHTML : "";
                }
              }

              const tablaProgramadasElem = document.getElementById("tablaProgramadas");
              if (tablaProgramadasElem) {
                const cloneProgramadas = tablaProgramadasElem.cloneNode(true);
                cloneProgramadas.removeAttribute("id");
                const tbodyProg = cloneProgramadas.querySelector("#tbodyProgramadas");
                if (tbodyProg) tbodyProg.removeAttribute("id");
                quitarIconosOrdenTabla(cloneProgramadas);
                const oldCgProg = cloneProgramadas.querySelector("colgroup");
                if (oldCgProg) oldCgProg.remove();
                const colgroupProg = document.createElement("colgroup");
                ["5%", "25%", "10%", "10%", "10%", "10%", "15%", "12%", "3%"].forEach(width => {
                  const col = document.createElement("col");
                  col.style.width = width;
                  colgroupProg.appendChild(col);
                });
                cloneProgramadas.insertBefore(colgroupProg, cloneProgramadas.firstElementChild);
                cloneProgramadas.style.width = "85%";
                cloneProgramadas.style.borderCollapse = "collapse";
                cloneProgramadas.style.tableLayout = "fixed";
                cloneProgramadas.style.marginTop = "4px";
                cloneProgramadas.style.marginLeft = "auto";
                cloneProgramadas.style.marginRight = "auto";
                cloneProgramadas.querySelectorAll("th, td").forEach(cell => {
                  cell.style.border = "1px solid #000";
                  cell.style.padding = "4px";
                  cell.style.fontSize = "8pt";
                  cell.style.verticalAlign = "top";
                });
                tablaRapsPorEvaluarHTML = `<div class="tabla-acta-wrap" style="margin-top:4px;">${cloneProgramadas.outerHTML}</div>`;
              }

              // Helper local para generar tablas del reporte 6 con estilos inline para Word
              const generarTablaActaReporte6 = (datos, clase) => {
                if (!datos || !datos.length) return "";
                let html = `<div style="width:100%; overflow:hidden;">
                    <table class="${clase}" style="width:85%; table-layout:fixed; border-collapse:collapse; margin:4px auto; font-size:9pt;">
                      <colgroup>
                        <col style="width:20px;">
                        <col style="width:120px;">
                        <col style="width:120px;">
                        <col style="width:80px;">
                        <col style="width:45px;">
                        <col style="width:45px;">
                        <col style="width:45px;">
                      </colgroup>
                      <thead>
                        <tr>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">#</th>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">Competencia</th>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">RAP</th>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">Funcionario</th>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">APROBADO</th>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">POR EVALUAR</th>
                          <th style="background-color:#e5e7eb; border:1px solid #000; padding:3px; text-align:center;">NO APROBADO</th>
                        </tr>
                      </thead>
                      <tbody>`;

                datos.forEach((g, i) => {
                  const funcs = Array.from(g.funcionarios).join(", ");
                  html += `<tr>
                        <td style="border:1px solid #000; padding:3px; text-align:center;">${i + 1}</td>
                        <td style="border:1px solid #000; padding:3px; word-wrap:break-word;">${g.competencia}</td>
                        <td style="border:1px solid #000; padding:3px; word-wrap:break-word;">${g.rap}</td>
                        <td style="border:1px solid #000; padding:3px; word-wrap:break-word;">${funcs}</td>
                        <td style="border:1px solid #000; padding:3px; text-align:center;">${g.aprobado}</td>
                        <td style="border:1px solid #000; padding:3px; text-align:center;">${g.porEvaluar}</td>
                        <td style="border:1px solid #000; padding:3px; text-align:center;">${g.noAprobado}</td>
                      </tr>`;
                });

                html += `</tbody></table></div>`;
                return html;
              };

              // ===== 2.4.4 – RAPs evaluados por instructor no programado (Amarillas) =====
              // Filtro global: alertaInstructorDiferente && esCompetenciaProgramada
              const datosOtroInstructor = (datosReporte6Global || []).filter(g =>
                g.alertaInstructorDiferente && g.esCompetenciaProgramada
              );
              tablaRapsOtroInstructorHTML = generarTablaActaReporte6(datosOtroInstructor, "tabla-raps-otro-instructor");

              // ===== 2.4.5 – Competencias Evaluadas sin estar programadas (Naranjas) =====
              // Filtro global: !esCompetenciaProgramada && aprobado > 0
              const datosNoProgramados = (datosReporte6Global || []).filter(g =>
                !g.esCompetenciaProgramada && g.aprobado > 0
              );
              tablaRapsNoProgramadosHTML = generarTablaActaReporte6(datosNoProgramados, "tabla-raps-no-programado");

              // ===== 2.4.2 – Solo competencias sobre ejecutadas (> 100 %) =====
              const cloneSobre = tablaCompHoras.cloneNode(true);
              cloneSobre.removeAttribute("id");

              const tbodySobre = cloneSobre.querySelector("#tbodyReporte2");
              if (tbodySobre) tbodySobre.removeAttribute("id");

              const tfootSobre = cloneSobre.querySelector("#tfootReporte2");
              if (tfootSobre) tfootSobre.remove(); // en este listado no necesitamos totales

              const filasSobre = Array.from(tbodySobre.querySelectorAll("tr"));
              let hayFilasSobre = false;

              filasSobre.forEach((tr) => {
                const esCabeceraCategoria = tr.querySelector("td[colspan]") !== null;
                const esRoja = tr.classList.contains("textoRojo");

                // Solo dejamos filas de datos que estén en rojo
                if (!esRoja || esCabeceraCategoria) {
                  tr.remove();
                } else {
                  hayFilasSobre = true;
                }
              });

              if (hayFilasSobre) {
                // Ajuste visual de la tabla filtrada
                cloneSobre.classList.add("tabla-competencias-sobre-ejecutadas");
                cloneSobre.style.width = "85%";
                cloneSobre.style.borderCollapse = "collapse";
                cloneSobre.style.tableLayout = "fixed";
                cloneSobre.style.marginTop = "4px";
                cloneSobre.style.marginLeft = "auto";
                cloneSobre.style.marginRight = "auto";

                // Mismos anchos de columnas
                const oldCgSobre = cloneSobre.querySelector("colgroup");
                if (oldCgSobre) oldCgSobre.remove();

                const colgroupSobre = document.createElement("colgroup");
                widthsCH.forEach((w) => {
                  const col = document.createElement("col");
                  col.style.width = w;
                  colgroupSobre.appendChild(col);
                });
                cloneSobre.insertBefore(colgroupSobre, cloneSobre.firstElementChild);

                tablaCompetenciasSobreEjecutadasHTML = cloneSobre.outerHTML;
              }
            }
          }

          // ===== NUEVA FUNCIÓN: Construir tabla detalle alternativa =====
          function construirTablaDetalleAlternativa() {
            const aprendicesMap = new Map();
            // Filtrar aprendices activos de registrosJuicios
            if (!registrosJuicios) return "";

            registrosJuicios.forEach(r => {
              const estado = (r.estado || "").toUpperCase().trim();
              // Normalizar estados variados
              if (estado === "EN FORMACION" || estado === "EN FORMACIÓN" || estado === "CONDICIONADO") {
                const nombreCompleto = (r.nombre + " " + r.apellidos).trim();
                if (!aprendicesMap.has(nombreCompleto)) {
                  aprendicesMap.set(nombreCompleto, {
                    nombre: nombreCompleto,
                    alternativa: "", // Placeholder
                    empresa: "",     // Placeholder
                    ciudad: "",      // Placeholder
                    jefe: "",        // Placeholder
                    cargo: ""        // Placeholder
                  });
                }
              }
            });

            const lista = Array.from(aprendicesMap.values());
            // Ordenar alfabéticamente por nombre
            lista.sort((a, b) => a.nombre.localeCompare(b.nombre));

            if (!lista.length) return "";

            // HTML de la tabla con estilos inline para Word
            let html = `<h4 style="text-align:center; margin-top:8px; margin-bottom:4px;">
                  Detalle  Alternativa de etapa productiva
                </h4>
                <div class="tabla-acta-wrap" style="margin:4px auto;">
                  <table class="tabla-acta" style="width:90%; border-collapse:collapse; margin:0 auto; table-layout:fixed;">
                    <thead>
                      <tr>
                        <th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Nombre del aprendiz</th>
                        <th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Alternativa</th>
                        <th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Nombre de la empresa</th>
                        <th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Ciudad</th>
                        <th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Nombre del gerente o Jefe inmediato</th>
                        <th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Cargo del Jefe Inmediato</th>
                      </tr>
                    </thead>
                    <tbody>`;

            lista.forEach(item => {
              html += `<tr>
                  <td style="border:1px solid #000; padding:4px; word-wrap:break-word;">${item.nombre}</td>
                  <td style="border:1px solid #000; padding:4px; word-wrap:break-word;">${item.alternativa}</td>
                  <td style="border:1px solid #000; padding:4px; word-wrap:break-word;">${item.empresa}</td>
                  <td style="border:1px solid #000; padding:4px; word-wrap:break-word;">${item.ciudad}</td>
                  <td style="border:1px solid #000; padding:4px; word-wrap:break-word;">${item.jefe}</td>
                  <td style="border:1px solid #000; padding:4px; word-wrap:break-word;">${item.cargo}</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            return html;
          }

          tablaDetalleAlternativaHTML = construirTablaDetalleAlternativa();
          // NUEVO: tabla de cursos complementarios por aprendiz (matriz con checks)
          function construirTablaCursosComplementariosPorAprendiz() {
            const aprendicesMap = new Map();
            if (!Array.isArray(registrosJuicios) || !registrosJuicios.length) return "";

            registrosJuicios.forEach(r => {
              const estado = (r.estado || "").toUpperCase().trim();
              if (estado === "EN FORMACION" || estado === "EN FORMACIÓN" || estado === "CONDICIONADO") {
                const nombreCompleto = (r.nombre + " " + r.apellidos).trim();
                if (nombreCompleto && !aprendicesMap.has(nombreCompleto)) {
                  aprendicesMap.set(nombreCompleto, { nombre: nombreCompleto });
                }
              }
            });

            const lista = Array.from(aprendicesMap.values());
            lista.sort((a, b) => a.nombre.localeCompare(b.nombre));
            if (!lista.length) return "";

            // Competencias específicas que definen check activo
            const compDerechos = "Ejercer derechos fundamentales del trabajo en el marco de la constitución política y los convenios internacionales.";
            const compRazonar = "Razonar cuantitativamente frente a situaciones susceptibles de ser abordadas de manera matemática en contextos laborales, sociales y personales.";

            const chkDerechos = (competenciasDisenoNormSetGlobal instanceof Set) && competenciasDisenoNormSetGlobal.has(normalizeCompetencia(compDerechos));
            const chkRazonamiento = (competenciasDisenoNormSetGlobal instanceof Set) && competenciasDisenoNormSetGlobal.has(normalizeCompetencia(compRazonar));

            // Si el nivel de formación no es TECNÓLOGO, se omiten las columnas del bloque TYT
            const isTecnologo = (nivelFormacionGlobal || "").toUpperCase().trim() === "TECNÓLOGO";

            const columnasPreparatorios = isTecnologo ? [
              { label: "Lectura Crítica", checked: false },
              { label: "Competencias Ciudadanas", checked: false },
              { label: "Razonamiento Cuantitativo", checked: chkRazonamiento }
            ] : [];

            const columnasHabilidades = [
              { label: "Experiencias Seguras en Línea", checked: false },
              { label: "Comunicación y Colaboración", checked: false },
              { label: "Contenido Digital", checked: false },
              { label: "Gestión del Conocimiento", checked: false }
            ];

            const columnasEmprendimiento = [
              { label: "Comportamiento Emprendedor", checked: false },
              { label: "Emprendimiento Digital", checked: false },
              { label: "Derechos Fundamentales para el Trabajo", checked: chkDerechos }
            ];

            const totalColumnas = 1 + columnasPreparatorios.length + columnasHabilidades.length + columnasEmprendimiento.length;
            const anchoColumna = (100 / totalColumnas).toFixed(4);
            const colgroupCols = Array(totalColumnas)
              .fill(`<col style="width:${anchoColumna}%;">`)
              .join("");

            const simbolo = (v) => (v ? "☑" : "☐");

            let html = '';
            html += '<h4 style="text-align:center; margin-top:8px; margin-bottom:4px;">Cursos complementarios por aprendiz</h4>';
            html += '<div style="font-size:8pt; margin:0 0 6px; text-align:justify;">☑ Marque cada celda cuando el aprendiz cumpla con los certificados de cada curso; las evidencias están disponibles en https://certificados.sena.edu.co/. Use la casilla correspondiente de cada aprendiz para registrar observaciones adicionales.</div>';
            html += '<div class="tabla-acta-wrap" style="margin:4px auto;">';
            html += '<table class="tabla-acta" style="width:100%; border-collapse:collapse; margin:0 auto; table-layout:fixed; font-size:8pt;">';
            html += colgroupCols;
            html += '<thead>';

            // Encabezado por grupos
            html += '<tr>';
            html += '<th rowspan="2" style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px;">Nombre del aprendiz</th>';
            if (columnasPreparatorios.length) {
              html += '<th colspan="' + columnasPreparatorios.length + '" style="border:1px solid #000; background-color:#d1d5db; font-weight:bold; text-align:center; padding:4px;">Preparatorios para pruebas saber TYT</th>';
            }
            html += '<th colspan="' + columnasHabilidades.length + '" style="border:1px solid #000; background-color:#bfdbfe; font-weight:bold; text-align:center; padding:4px;">Desarrollo de Habilidades Digitales</th>';
            html += '<th colspan="' + columnasEmprendimiento.length + '" style="border:1px solid #000; background-color:#d1d5db; font-weight:bold; text-align:center; padding:4px;">Emprendimiento y DDHH</th>';
            html += '</tr>';

            // Sub-encabezados
            html += '<tr>';
            columnasPreparatorios.forEach(c => {
              html += '<th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px; font-size:5pt; word-wrap:break-word;">' + c.label + '</th>';
            });
            columnasHabilidades.forEach(c => {
              html += '<th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px; font-size:5pt; word-wrap:break-word;">' + c.label + '</th>';
            });
            columnasEmprendimiento.forEach(c => {
              html += '<th style="border:1px solid #000; background-color:#e5e7eb; font-weight:bold; text-align:center; padding:4px; font-size:5pt; word-wrap:break-word;">' + c.label + '</th>';
            });
            html += '</tr>';

            html += '</thead><tbody>';

            // Filas por aprendiz
            lista.forEach(item => {
              html += '<tr>';
              html += '<td style="border:1px solid #000; padding:4px; word-wrap:break-word;">' + (item.nombre || '') + '</td>';
              columnasPreparatorios.forEach(c => {
                html += '<td style="border:1px solid #000; text-align:center; padding:4px; font-size:8pt;">' + simbolo(!!c.checked) + '</td>';
              });
              columnasHabilidades.forEach(c => {
                html += '<td style="border:1px solid #000; text-align:center; padding:4px; font-size:8pt;">' + simbolo(!!c.checked) + '</td>';
              });
              columnasEmprendimiento.forEach(c => {
                html += '<td style="border:1px solid #000; text-align:center; padding:4px; font-size:8pt;">' + simbolo(!!c.checked) + '</td>';
              });
              html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
          }

          tablaCursosComplementariosAprendizHTML = construirTablaCursosComplementariosPorAprendiz();


          // --- 2.2.2 Instructores y Competencias ---
          const registrosOrdenados = [...registrosGlobal].sort((a, b) => {

            const nomA = ((a.nombreInstructor || "") + " " + (a.apellidoInstructor || "")).toUpperCase();
            const nomB = ((b.nombreInstructor || "") + " " + (b.apellidoInstructor || "")).toUpperCase();
            if (nomA < nomB) return -1;
            if (nomA > nomB) return 1;
            const compA = (a.competencia || "").toUpperCase();
            const compB = (b.competencia || "").toUpperCase();
            if (compA < compB) return -1;
            if (compA > compB) return 1;
            return 0;
          });


          const filasComp = registrosOrdenados.map((r, index) => `
          <tr>
            <td style="border:1px solid #000; padding:2px; text-align:center; font-size:8pt; word-wrap:break-word;">${index + 1}</td>
            <td style="border:1px solid #000; padding:2px; font-size:8pt; word-wrap:break-word;">${(r.nombreInstructor || "").trim()}</td>
            <td style="border:1px solid #000; padding:2px; font-size:8pt; word-wrap:break-word;">${(r.apellidoInstructor || "").trim()}</td>
            <td style="border:1px solid #000; padding:2px; font-size:8pt; word-wrap:break-word;">${r.competencia || ""}</td>
            <td style="border:1px solid #000; padding:2px; text-align:center; font-size:8pt; word-wrap:break-word;">${(Number(r.horasProg) || 0).toFixed(2)}</td>
          </tr>
    `).join("");

          if (!tablaInstructoresCompetenciasHTML) {
            tablaInstructoresCompetenciasHTML = `
  <div style="width:100%; overflow:hidden;">
  <table class="tabla-instructores-competencias" style="width:85%; table-layout:fixed; border-collapse:collapse; margin:4px auto; mso-table-lspace:0pt; mso-table-rspace:0pt;">
    <colgroup>
      <col style="width:20px;">   <!-- # fijo -->
      <col style="width:70px;">  <!-- Nombre Instructor fijo -->
      <col style="width:80px;">  <!-- Apellido Instructor fijo -->
      <col>  <!-- Competencia flexible -->
      <col style="width:50px;">  <!-- Horas Programadas fijo -->
    </colgroup>
    <thead>
      <tr>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">#</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Nombre</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Apellido</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Competencia</th>
        <th style="background-color:#e5e7eb; border:1px solid #000; padding:2px; text-align:center; font-weight:bold; font-size:8pt;">Horas</th>
      </tr>
    </thead>
    <tbody>
      ${filasComp}
    </tbody>
  </table>
  </div>
`;
          }

        }



        const seleccionActa = obtenerReportesSeleccionadosCentro();
        const incluyeActa = (key) => seleccionActa.includes(key);

        const desarrolloCompetenciasPendientesAprendizHTML = incluyeActa("competencias-pendientes-aprendiz")
          ? `
                    <li class="titulo-3">
                      Competencias pendientes por evaluar por cada aprendiz.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          De acuerdo con el reporte "Competencias Pendientes por Aprendiz e Instructor", se relacionan las competencias que los aprendices tienen pendientes por evaluar y el instructor que impartió la competencia.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaPendientesAprendizHTML
            ? tablaPendientesAprendizHTML
            : "<em>(De acuerdo con el reporte \"Competencias Pendientes por Aprendiz e Instructor\", a la fecha no se registran competencias pendientes por evaluar para los aprendices de la ficha.)</em>"
          }
                        </div>
                      </div>
                    </li>
                  `
          : "";

        const desarrolloAprendicesListosHTML = incluyeActa("aprendices-listos-productiva")
          ? `
                    <li class="titulo-3">
                      Aprendices listos para ir a etapa productiva.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          Se listan los aprendices que, de acuerdo con el mismo reporte, ya finalizaron todas las competencias lectivas
                          y solo tienen pendiente la competencia &quot;RESULTADOS DE APRENDIZAJE ETAPA PRACTICA&quot;.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaListosProductivaHTML
            ? tablaListosProductivaHTML
            : "<em>Por el momento no hay ningún aprendiz.</em>"
          }
                        </div>
                        ${tablaPorEvaluarMasDe1HTML
            ? `
                        <div class="tabla-acta-wrap" style="margin-top:12px;">
                          <div style="font-weight:600; margin-bottom:6px;">Aprendices con novedades para ir a etapa productiva</div>
                          ${tablaPorEvaluarMasDe1HTML}
                        </div>
                        `
            : ""
          }
                      </div>
                    </li>
                  `
          : "";

        const desarrolloInstructoresHTML = incluyeActa("listado-instructores-pendientes-juicio")
          ? `
                <li class="titulo-1">
                  Instructores
                    <div style="font-size:10pt; font-weight:bold;">Equipo ejecutor en formación</div>
                    <div class="tabla-acta-wrap" style="margin-top:4px;">
                      ${tablaEquipoFormacionHTML || "<em>(No se encontraron instructores en formación al momento de generar el acta.)</em>"}
                   
                  </div>
                    <div style="font-size:10pt; font-weight:bold;">Equipo ejecutor con el que vieron formación</div>
                    <div class="tabla-acta-wrap" style="margin-top:4px;">
                      ${tablaEquipoVistoHTML || "<em>(No se encontraron registros de instructores que hayan impartido al momento de generar el acta.)</em>"}
                  </div>
                  <span style="font-size:9pt;">Asimismo, se relacionan los instructores con las competencias que tienen asignadas y las horas programadas:</span>
                  <div class="tabla-acta-wrap" style="margin-top:4px;">
                    ${tablaInstructoresCompetenciasHTML || "<em>(No se encontró información del listado de competencias por instructor al momento de generar el acta.)</em>"}
                  </div>
                  <ol class="lista-acta nivel-3" type="i">
                    <li class="titulo-3">
                      Listado de instructores con aprendices pendientes por emitir juicio.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          Se listan los instructores que tienen aprendices con juicios evaluativos pendientes, indicando la competencia, los aprendices asociados y la cantidad de aprendices por competencia.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaPendientesJuicioHTML
            ? tablaPendientesJuicioHTML
            : "<em>(No se encontraron instructores con aprendices pendientes por emitir juicio en los reportes cargados.)</em>"
          }
                        </div>
                      </div>
                    </li>
                  </ol>
                </li>
                `
          : "";

        const desarrolloAnalisisCompetenciasHTML = (() => {
          const desarrolloAnalisisCompetenciasSubItems = [];
          if (incluyeActa("competencias-avance-diseno")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Competencias y % de avance vs diseño.
                      <div class="contenido-item">
                        ${graficoCompetenciasActaHTML}
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaCompetenciasHorasHTML
            ? tablaCompetenciasHorasHTML
            : "<em>(No se encontró información del reporte % Competencias con Horas al momento de generar el acta.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (incluyeActa("cronograma-gantt")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Cronograma de programación de competencias (Gantt).
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          Se presenta el cronograma de programación de competencias con los meses en que cada competencia ha sido programada.
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px; overflow-x:auto;">
                          ${tablaCronogramaGanttHTML
            ? tablaCronogramaGanttHTML
            : "<em>(No se encontró información del cronograma Gantt al momento de generar el acta.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (incluyeActa("competencias-sobre-ejecutadas")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Competencias sobre ejecutadas.
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          Se listan únicamente las competencias cuyo porcentaje de ejecución supera el <strong>100 %</strong> frente a las horas definidas en el diseño curricular (filas resaltadas en rojo en el reporte % Competencias con Horas).
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaCompetenciasSobreEjecutadasHTML
            ? tablaCompetenciasSobreEjecutadasHTML
            : "<em>(No se encontraron competencias que superen el 100% en el reporte % Competencias con Horas.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (incluyeActa("competencias-pendientes")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Competencias pendientes
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          De acuerdo con el reporte "Competencias del Programa (Programada: Sí/No)", se relacionan las competencias sin programación (<strong>No</strong>) o parcialmente programadas (<strong>1/2</strong>).
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaCompetenciasProgramadasPendientesHTML
            ? tablaCompetenciasProgramadasPendientesHTML
            : "<em>(No se encontró información del reporte \"Competencias del Programa (Programada: Sí/No)\" al momento de generar el acta.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (incluyeActa("competencias-evaluadas-sin-programar")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Competencias Evaluadas sin estar programadas
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          De acuerdo con el reporte "RAPs Aprobados - Por evaluar y No aprobados", se listan las competencias que presentan resultados de aprendizaje aprobados sin que dichas competencias están programadas en el dise?o.
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaRapsNoProgramadosHTML
            ? tablaRapsNoProgramadosHTML
            : "<em>(No se encontró información de competencias evaluadas sin estar programadas al momento de generar el acta.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (incluyeActa("competencias-raps-instructor-no-programado")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Competencias y RAPs evaluados por instructor no programado.
                      <div class="contenido-item">
                        <p style="margin:0 0 4px 0; font-size:9pt;">
                          De acuerdo con el reporte "RAPs Aprobados - Por evaluar y No aprobados", se relacionan los resultados de aprendizaje que fueron evaluados por un instructor diferente al programado para esa competencia.
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaRapsOtroInstructorHTML
            ? tablaRapsOtroInstructorHTML
            : "<em>(No se encontraron RAPs evaluados por instructores diferentes al programado.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (incluyeActa("raps-por-evaluar")) {
            desarrolloAnalisisCompetenciasSubItems.push(`
                    <li class="titulo-3">
                      Raps por evaluar.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          De acuerdo con el reporte "Raps por evaluar", se consignan los resultados de aprendizaje que actualmente tienen juicios pendientes y los aprendices vinculados a cada competencia.
                        </span>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaRapsPorEvaluarHTML
            ? tablaRapsPorEvaluarHTML
            : "<em>(No se encontró información del reporte \"Raps por evaluar\" al momento de generar el acta.)</em>"
          }
                        </div>
                      </div>
                    </li>
          `);
          }
          if (!desarrolloAnalisisCompetenciasSubItems.length) return "";
          return `
                <li class="titulo-2">
                  Análisis de competencias y resultados de aprendizaje
                  <ol class="lista-acta nivel-3" type="i">
                    ${desarrolloAnalisisCompetenciasSubItems.join("")}
                  </ol>
                </li>
              `;
        })();

        const desarrolloPorcentajeHTML = incluyeActa("avance-fallas")
          ? `
                    <li class="titulo-3">
                      Porcentaje de avance de aprendices y fallas.
                      <div class="contenido-item">
                        <span style="font-size:9pt;">
                          Se presenta el porcentaje total de avance por aprendiz y el consolidado de fallas del reporte "Avance por Aprendiz", complementado con la tabla del avance general.
                        </span>
                        ${graficoFallasAprendicesHTML}
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          ${tablaAvanceAprendicesHTML
            ? tablaAvanceAprendicesHTML
            : "<em>(No se encontró información del reporte % Avance por Aprendiz al momento de generar el acta.)</em>"
          }
                        </div>
                      </div>
                    </li>
                  `
          : "";

        const agendaDetalleAprendicesItems = [];
        if (incluyeActa("avance-fallas")) {
          agendaDetalleAprendicesItems.push("<li>Porcentaje de avance de aprendices y fallas</li>");
        }
        if (incluyeActa("competencias-pendientes-aprendiz")) {
          agendaDetalleAprendicesItems.push("<li>Competencias pendientes por evaluar por cada aprendiz.</li>");
        }
        if (incluyeActa("aprendices-listos-productiva")) {
          agendaDetalleAprendicesItems.push("<li>Aprendices listos para ir a etapa productiva.</li>");
        }
        const agendaDetalleAprendicesHTML = agendaDetalleAprendicesItems.join("");

        const agendaDetalleInstructoresHTML = incluyeActa("listado-instructores-pendientes-juicio")
          ? `
                <li>Instructores
                  <ol type="i">
                    <li>Listado de instructores con aprendices pendientes por emitir juicio.</li>
                  </ol>
                </li>
                `
          : "";

        const agendaDetalleCompetenciasItems = [];
        if (incluyeActa("competencias-avance-diseno")) {
          agendaDetalleCompetenciasItems.push("<li>Competencias y % de avance vs diseño.</li>");
        }
        if (incluyeActa("cronograma-gantt")) {
          agendaDetalleCompetenciasItems.push("<li>Cronograma de programación de competencias (Gantt).</li>");
        }
        if (incluyeActa("competencias-sobre-ejecutadas")) {
          agendaDetalleCompetenciasItems.push("<li>Competencias sobre ejecutadas.</li>");
        }
        if (incluyeActa("competencias-pendientes")) {
          agendaDetalleCompetenciasItems.push("<li>Competencias pendientes.</li>");
        }
        if (incluyeActa("competencias-evaluadas-sin-programar")) {
          agendaDetalleCompetenciasItems.push("<li>Competencias Evaluadas sin estar programadas.</li>");
        }
        if (incluyeActa("competencias-raps-instructor-no-programado")) {
          agendaDetalleCompetenciasItems.push("<li>Competencias y RAPs evaluados por instructor no programado.</li>");
        }
        if (incluyeActa("raps-por-evaluar")) {
          agendaDetalleCompetenciasItems.push("<li>Raps por evaluar.</li>");
        }
        const agendaDetalleCompetenciasHTML = agendaDetalleCompetenciasItems.length
          ? `
                <li>Análisis de competencias y resultados de aprendizaje
                  <ol type="i">
                    ${agendaDetalleCompetenciasItems.join("")}
                  </ol>
                </li>
                `
          : "";

        // =========================
        // HTML del documento Word
        // =========================
        let contenidoHTML = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
  <head>
    <meta charset="utf-8">
    <title>Acta Comité</title>

    
    <xml>
      <w:WordDocument>
        <w:View>Print</w:View>
        <w:Zoom>100</w:Zoom>
        <w:DoNotOptimizeForBrowser/>
      </w:WordDocument>
    </xml>
    

    <style>
      /* Sección de página para que Word asigne el pie de página */
      @page Section1 {
        margin-top: 20mm;
        margin-right: 15mm;
        margin-bottom: 20mm;
        margin-left: 15mm;

        mso-header: h1;
        mso-header-margin: 10mm;

        mso-footer: f1;
        mso-footer-margin: 10mm;

        mso-title-page: no;
        mso-paper-source: 0;
      }
      div.Section1 { page:Section1; }

      body {
        font-family: Arial, sans-serif;
        font-size: 10pt;
      }
      /* TABLA CON TODOS LOS BORDES */
      table.acta-encabezado {
        width: 100%;
        border-collapse: collapse;
      }
      table.acta-encabezado,
      table.acta-encabezado td {
        border: 1px solid #000000;
      }
      table.acta-encabezado td {
        padding: 6px 8px;
        font-size: 9pt;
        vertical-align: top;
      }

      /* Centrado global de tablas del acta (incluyendo las que van dentro de listas) */
      .Section1 table {
        margin-left: auto;
        margin-right: auto;
      }
      .Section1 ol table,
      .Section1 ul table,
      .Section1 ol div table,
      .Section1 ul div table {
        margin-left: auto !important;
        margin-right: auto !important;
        display: table;
        width: 90%;
        max-width: 100%;
      }
      .tabla-acta-wrap {
        margin: 6px auto;
        text-align: center;
      }
      .tabla-acta-wrap table {
        margin-left: auto;
        margin-right: auto;
        display: table;
        width: 90%;
        max-width: 100%;
      }
      /* Estilos de listas tipo Word */
      .lista-acta {
        margin: 0;
        list-style-position: outside;
        padding-left: 18px;
      }
      .lista-acta.nivel-1 { padding-left: 20px; }
      .lista-acta.nivel-2 { padding-left: 18px; }
      .lista-acta.nivel-3 { padding-left: 16px; }
      .lista-acta.nivel-4 { padding-left: 14px; }

      .titulo-1 {
        display: block;
        font-weight: bold;
        font-size: 12pt;
        margin: 8px 0 4px;
      }
      .titulo-2 {
        display: block;
        font-weight: bold;
        font-size: 11pt;
        margin: 7px 0 4px;
        
      }
      .titulo-3 {
        display: block;
        font-weight: bold;
        font-size: 10pt;
        font-style: italic;
        margin: 7px 0 4px;
        
      }
      .titulo-4 {
        display: block;
        font-weight: bold;
        font-size: 9pt;
        font-style: italic;
        
      }
      .contenido-item {
        font-size: 10pt;
        font-weight: normal;
        font-style: normal;
        margin: 4px 0 8px;
        padding-left: 12pt;
      }
      .acta-titulo {
        text-align: center;
        font-weight: bold;
      }
      /* Estilo del encabezado y pie de página */
      p.MsoHeader, p.MsoFooter {
        text-align: center;
        font-size: 8pt;
        margin: 0;
        font-family: Arial, sans-serif;
      }
     
    
                  .tabla-instructores-horas,
      .tabla-instructores-competencias,
      .tabla-estado-aprendices,
      .tabla-avance-aprendices,
      .tabla-competencias-pendientes,
      .tabla-listos-productiva,
      .tabla-pendientes-juicio,
      .tabla-alternativa-productiva,
      .tabla-competencias-horas,
      .tabla-competencias-sobre-ejecutadas,
      .tabla-raps-otro-instructor,
      .tabla-cronograma-gantt,
      .tabla-cursos-preparatorios,
      .tabla-cursos-habilidades,
      .tabla-cursos-emprendimiento,
      .tabla-alternativas-productiva {

        width: 100%;
        border-collapse: collapse;
        margin-top: 4px;
        margin-left: auto;
        margin-right: auto;
        table-layout: fixed;
        mso-table-lspace:0pt;
        mso-table-rspace:0pt;
      }

      .tabla-instructores-horas th,
      .tabla-instructores-horas td,
      .tabla-instructores-competencias th,
      .tabla-instructores-competencias td,
      .tabla-estado-aprendices th,
      .tabla-estado-aprendices td,
      .tabla-avance-aprendices th,
      .tabla-avance-aprendices td,
      .tabla-competencias-pendientes th,
      .tabla-competencias-pendientes td,
      .tabla-listos-productiva th,
      .tabla-listos-productiva td,
      .tabla-pendientes-juicio th,
      .tabla-pendientes-juicio td,
           .tabla-alternativa-productiva th,
      .tabla-alternativa-productiva td,
      .tabla-competencias-horas th,
      .tabla-competencias-horas td,
      .tabla-competencias-sobre-ejecutadas th,
      .tabla-competencias-sobre-ejecutadas td,
      .tabla-raps-otro-instructor th,
      .tabla-raps-otro-instructor td,
      .tabla-cronograma-gantt th,
      .tabla-cronograma-gantt td,
      .tabla-cursos-preparatorios th,
      .tabla-cursos-preparatorios td,
      .tabla-cursos-habilidades th,
      .tabla-cursos-habilidades td,
      .tabla-cursos-emprendimiento th,
      .tabla-cursos-emprendimiento td,
      .tabla-alternativas-productiva th,
      .tabla-alternativas-productiva td {

        border: 1px solid #000000;
        padding: 4px 6px;
        font-size: 8.5pt;
      }

      .tabla-instructores-horas th,
      .tabla-instructores-competencias th,
      .tabla-estado-aprendices th,
      .tabla-avance-aprendices th,
      .tabla-competencias-pendientes th,
      .tabla-listos-productiva th,
      .tabla-pendientes-juicio th,
            .tabla-alternativa-productiva th,
      .tabla-competencias-horas th,
      .tabla-competencias-sobre-ejecutadas th,
      .tabla-raps-otro-instructor th,
      .tabla-cronograma-gantt th,
      .tabla-cursos-preparatorios th,
      .tabla-cursos-habilidades th,
      .tabla-cursos-emprendimiento th,
      .tabla-alternativas-productiva th {
        background-color: #e5e7eb;
        font-weight: bold;
        text-align: center;
      }

      .tabla-cronograma-gantt th,
      .tabla-cronograma-gantt td {
        font-size: 6pt;
        padding: 3px 4px;
      }

      /* Utilidades de tablas (sin estilos inline) */
      .tabla-alternativa-productiva {
        width: 70% !important;
        max-width: 700px;
        margin: 6px auto;
        table-layout: fixed;
      }

      .tabla-alternativa-productiva th,
      .tabla-alternativa-productiva td {
        word-break: break-word;
        padding: 6px;
      }

      .tabla-alternativa-productiva .col-cantidad {
        text-align: center;
      }

      /* Distribuciones específicas por tamaño */
      .tabla-alternativa-productiva.tabla-ancha {
        width: 70% !important;
        max-width: 700px;
      }

      .tabla-alternativa-productiva.tabla-ancha .col-alternativa {
        width: 60% !important;
      }

      .tabla-alternativa-productiva.tabla-ancha .col-cantidad {
        width: 15% !important;
      }

      .tabla-alternativa-productiva.tabla-ancha .col-nombres {
        width: 25% !important;
      }

      /* Refuerzo de anchos por columna para Word */
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(1),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(1) {
        width: 60% !important;
      }
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(2),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(2) {
        width: 15% !important;
        text-align: center;
      }
      .tabla-alternativa-productiva.tabla-ancha tr > th:nth-child(3),
      .tabla-alternativa-productiva.tabla-ancha tr > td:nth-child(3) {
        width: 25% !important;
      }

      .tabla-alternativa-productiva.tabla-media {
        width: 55%;
        max-width: 420px;
      }

      .tabla-alternativa-productiva.tabla-media .col-nombres {
        width: 70%;
      }

      .tabla-alternativa-productiva.tabla-media .col-cantidad {
        width: 30%;
      }

      .contenedor-tabla {
        width: 100%;
        overflow-x: hidden;
        text-align: center;
      }

      .seccion-acta {
        width: 85%;
        margin: 8px auto;
        font-size: 9pt;
      }

      .seccion-acta p {
        margin: 6px 0;
      }

      .seccion-acta .titulo-seccion {
        margin: 10px 0 2px 0;
        font-weight: 700;
      }

      .seccion-acta .subtitulo-seccion {
        margin: 0 0 4px 0;
      }

      .seccion-acta .nota {
        margin-left: 12px;
        color: #374151;
      }

      .seccion-acta .nota-secundaria {
        margin-left: 18px;
        color: #374151;
      }

      .seccion-acta .espaciado-superior {
        margin-top: 10px;
      }


      .tabla-instructores-horas th,
      .tabla-instructores-horas td,
      .tabla-instructores-competencias th,
      .tabla-instructores-competencias td {
        border: 1px solid #000000;
        padding: 4px 6px;
        font-size: 8.5pt;
      }
      .tabla-instructores-horas th,
      .tabla-instructores-competencias th {
        background-color: #e5e7eb;
        font-weight: bold;
        text-align: center;
      }
      .textoRojo {
        background-color: #fee2e2;
      }

      td,
      th {
        mso-background-source: auto;
        mso-pattern: auto;
      }

    </style>
    </head>
  <body>
    <div class="Section1">



      <!-- ÚNICA TABLA, 4 COLUMNAS, 4 FILAS -->
      <table class="acta-encabezado">
        <!-- Fila 1: ACTA No. -->
        <tr>
          <td class="acta-titulo" colspan="4">ACTA No.</td>
        </tr>

        <!-- Fila 2: Nombre del comité -->
        <tr>
          <td colspan="4">
            <strong>NOMBRE DEL COMITÉ O DE LA REUNIÓN:</strong>
            Comité de evaluación y seguimiento para el Programa de Formación:
            <span style="font-weight:bold; color:#00324D;">${nombrePrograma}</span>, FICHA:
            <span style="font-weight:bold; color:#00324D;">${codigoFicha}</span>,
            Modalidad de Formación:
            <span style="font-weight:bold; color:#00324D;">${modalidadFormacionGlobal || "N/A"}</span>;
            a cargo del instructor
            <strong>Gerente de Proyecto</strong>
            <span style="font-weight:bold; color:#00324D;">${instructorGerente}</span>
          </td>
        </tr>

        <!-- Fila 3: CIUDAD Y FECHA / HORA INICIO / HORA FIN -->
        <tr>
          <td><strong>CIUDAD Y FECHA:</strong></td>
          <td>
            ${ciudad},
            <span style="font-weight:bold; color:#00324D;">${fechaHoy}</span>
          </td>
          <td><strong>HORA INICIO:</strong></td>
          <td>
            <span style="font-weight:bold; color:#00324D;">${horaInicio}</span>
          </td>
        </tr>

        <!-- Fila 4: LUGAR Y/O ENLACE -->
        <tr>
          <td><strong>LUGAR Y/O ENLACE:</strong></td>
          <td></td>
          <td>
            <strong>REGIONAL TOLIMA</strong><br>
            <strong>CENTRO: COMERCIO Y SERVICIOS</strong>
          </td>
          <td></td>
        </tr>
      <!-- Fila 5: AGENDA O PUNTOS PARA DESARROLLAR -->
      <tr>
        <td colspan="4">
                    <strong>AGENDA O PUNTOS PARA DESARROLLAR:</strong>
          <ol style="margin:0; padding-left:20px; list-style-position:outside;">
            <li>Verificación del quorum</li>
            <li>Compromisos del acta anterior (opcional)</li>
            <li>Análisis de Grupo (cuantitativa: reportes de aprendices, concepto general del grupo)
              <ol type="a" style="padding-left:18px;">
                <li>Detalle de aprendices
                  <ol type="i" style="padding-left:16px;">
                    ${agendaDetalleAprendicesHTML}
                    ${incluyeActa("alternativa-etapa-productiva") ? `<li>Alternativa de etapa productiva.</li>` : ""}
                    ${incluyeActa("cursos-complementarios") ? `
                    <li>Cursos Complementarios
                      <ol type="1" style="padding-left:14px;">
                        <li>Cursos Preparatorios para pruebas saber TYT</li>
                        <li>Cursos Habilidades Digitales</li>
                        <li>Cursos Emprendimiento y Derechos Fundamentales</li>
                      </ol>
                    </li>
                    ` : ""}
                    <li>Calificación cualitativa
                      <ol type="1" style="padding-left:14px;">
                        <li>Aspectos comportamentales.</li>
                        <li>Aspectos académicos.</li>
                      </ol>
                    </li>
                  </ol>
                </li>
                ${agendaDetalleInstructoresHTML}
                ${agendaDetalleCompetenciasHTML}
              </ol>
            </li>
            <li>Análisis de casos especiales</li>
            <li>Recomendaciones del comité</li>
            <li>Conclusiones</li>
            <li>Compromisos</li>
            <li>Anexos</li>
          </ol>
        </td>
      </tr>

      <!-- Fila 6: OBJETIVO(S) DE LA REUNIÓN -->
      <tr>
        <td colspan="4">
          <strong>OBJETIVO(S) DE LA REUNIÓN:</strong><br>
          Comité de evaluación y seguimiento para el Programa de Formación
          <span style="font-weight:bold; color:#00324D;">${codigoFicha}</span>
          <span style="font-weight:bold; color:#00324D;">${nombrePrograma}</span>
        </td>
      </tr>
            <!-- Fila 7: Título DESARROLLO DE LA REUNIÓN -->
      <tr>
        <td colspan="4" style="text-align:center; font-weight:bold;">
          DESARROLLO DE LA REUNIÓN
        </td>
      </tr>

      <!-- Fila 8: Desarrollo de la reunión -->
      <tr>
        <td colspan="4">
          <ol class="lista-acta nivel-1">
            <li class="titulo-1">
              Verificación del quorum
              <div class="contenido-item">
                Coordinador Académico:
                <span style="font-weight:bold; color:#00324D;">${coordinadorAcademico}</span><br>
                Instructor Gerente de Proyecto:
                <span style="font-weight:bold; color:#00324D;">${instructorGerente}</span><br>
                Aprendiz Vocero:
                <span style="font-weight:bold; color:#00324D;">${aprendizVocero}</span><br>
                Psicóloga de Bienestar:
              </div>
            </li>
            <li class="titulo-1">
              Compromisos del acta anterior (opcional)
              <div class="contenido-item" style="margin-top:4px; font-size:9pt; font-style:italic;">
                (Breve seguimiento de los compromisos previos y su estado actual para facilitar la trazabilidad.)
              </div>
            </li>
            <li class="titulo-1">
              Análisis de Grupo (cuantitativa: reportes de aprendices, concepto general del grupo)
              <ol class="lista-acta nivel-2" type="a">
                <li class="titulo-2">
                  Detalle de aprendices
                  <div class="contenido-item">
                    <div style="font-size:10pt; margin-top:4px;">
                      <strong>Equipo ejecutor Actual:</strong>
                      ${equipoFormacionTexto}
                    </div>
                    <div style="font-size:10pt; margin-top:2px;">
                      <strong>Equipo ejecutor con el que vieron formación:</strong>
                      ${equipoVistoTexto}
                    </div>
                    <div style="margin-bottom:6px;">
                      <div><strong>Etapa lectiva:</strong> ${fechaInicioLectiva} - ${fechaFinLectiva} (Tiempo restante: <span style="color:#1e8a37; font-weight:600;">${tiempoRestanteLectiva}</span>)</div>
                      <div><strong>Etapa productiva:</strong> ${fechaInicioProd} - ${fechaFinProd} (Tiempo restante: <span style="color:#1e8a37; font-weight:600;">${tiempoRestanteProductiva}</span>)</div>
                      <div><strong>Etapa en proceso:</strong> ${etapaEnProceso}</div>
                    </div>
                    Avance promedio del grupo:
                    <span style="font-weight:bold; color:#00324D;">${avancePromedioGrupo}</span>
                    <span style="font-size:9pt;">
                      Este porcentaje se calcula sobre el total de competencias del programa,
                      que son
                      <span style="font-weight:bold; color:#00324D;">${numCompetencias}</span>,
                      y sobre el total de Resultados de aprendizaje del Diseño Curricular,
                      que son
                      <span style="font-weight:bold; color:#00324D;">${numResultados}</span>.
                    </span><br><br>
                    <span style="font-size:9pt;">
                      Se presenta el consolidado de aprendices por estado académico de la ficha.
                      Total aprendices Matriculados:
                      <span style="font-weight:bold; color:#00324D;">${totalAprendicesEstado}</span>.
                    </span>
                    ${graficoEstadoActaHTML}
                    <div class="tabla-acta-wrap" style="margin-top:4px;">
                      ${tablaDetalleAprendicesHTML
            ? tablaDetalleAprendicesHTML
            : "<em>(No se encontró información del detalle de aprendices al momento de generar el acta.)</em>"
          }
                    </div>
                  </div>
                  <ol class="lista-acta nivel-3" type="i">
                    ${desarrolloPorcentajeHTML}
                    ${desarrolloCompetenciasPendientesAprendizHTML}
                    ${desarrolloAprendicesListosHTML}
                    ${incluyeActa("alternativa-etapa-productiva") ? `
<li class="titulo-3">
                      Alternativa de etapa productiva.
                      <div class="contenido-item">
                        <p class="subtitulo-seccion">
                          Relación de alternativas definidas para el desarrollo de la etapa productiva,
                          indicando la cantidad de aprendices y sus nombres por cada alternativa.
                        </p>
                        <div class="tabla-acta-wrap" style="margin-top:4px;">
                          <table class="tabla-alternativas-productiva">
                            <thead>
                              <tr>
                                <th>Alternativa</th>
                                <th>Cantidad</th>
                                <th>Nombres</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td>CONTRATO DE APRENDIZAJE</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>CONTRATO DE VINCULO FORMATIVO</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>CONTRATO VINCULO LABORAL</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>PROYECTO PRODUCTIVO</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>MONITORIA</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>PRACTICAS EN LA ECONOMIA POPULAR Y/O CAMPESINA</td>
                                <td></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td>NO_REGISTRA</td>
                                <td></td>
                                <td></td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        ${tablaDetalleAlternativaHTML || "<em>(No se encontraron aprendices activos para detallar alternativa.)</em>"}
                      </div>
                    </li>
` : ""}

${incluyeActa("cursos-complementarios") ? `
<li class="titulo-3">
                      Cursos Complementarios
                      <div class="contenido-item" style="padding-left:0;">
                        ${tablaCursosComplementariosAprendizHTML || "<em>(Sin aprendices activos para cursos complementarios.)</em>"}
                      </div>
                      <ol class="lista-acta nivel-4" type="1">
                        <li class="titulo-4">
                          Cursos Preparatorios para pruebas saber TYT
                          <div class="contenido-item" style="padding-left:0;">
                            <div class="tabla-acta-wrap" style="margin-top:4px;">
                              <table class="tabla-cursos-preparatorios">
                                <thead>
                                  <tr>
                                    <th>Curso</th>
                                    <th>Cantidad</th>
                                    <th>Nombres</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Lectura Critica</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Competencias Ciudadanas</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>
                                     * Razonamiento Cuantitativo<br>
                                    </td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>

                            </div>
                            
                          </div>
                           
                        </li>
                
                        <li class="titulo-4">
                          Cursos Habilidades Digitales
                          <div class="contenido-item" style="padding-left:0;">
                            <div class="tabla-acta-wrap" style="margin-top:4px;">
                              <table class="tabla-cursos-habilidades">
                                <thead>
                                  <tr>
                                    <th>Curso</th>
                                    <th>Cantidad</th>
                                    <th>Nombres</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Experiencias Seguras en Línea</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Comunicacion y Colaboracion</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Contenido Digital</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Gestion del Conocimiento</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </li>
                        <li class="titulo-4">
                          Cursos Emprendimiento y Derechos Fundamentales
                          <div class="contenido-item" style="padding-left:0;">
                            <div class="tabla-acta-wrap" style="margin-top:4px;">
                              <table class="tabla-cursos-emprendimiento">
                                <thead>
                                  <tr>
                                    <th>Curso</th>
                                    <th>Cantidad</th>
                                    <th>Nombres</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Comportamiento Emprendedor</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>Emprendimiento Digital</td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                  <tr>
                                    <td>
                                      * Derechos Fundamentales para el Trabajo<br>
                                    </td>
                                    <td></td>
                                    <td></td>
                                  </tr>
                                </tbody>
                              </table>
                                                                    

                            </div>
                          </div>
                        </li>
                      </ol>
                    </li>
` : ""}

<li class="titulo-3">
                      Calificación cualitativa
                      <ol class="lista-acta nivel-4" type="1">
                        <li class="titulo-4">
                          Aspectos comportamentales.
                          <div class="contenido-item" style="font-size:9pt; font-style:italic; margin-top:4px;">
                            (Observaciones sobre convivencia, disciplina, trabajo colaborativo y liderazgo dentro del grupo.)
                          </div>
                        </li>
                        <li class="titulo-4">
                          Aspectos académicos.
                          <div class="contenido-item" style="font-size:9pt; font-style:italic; margin-top:4px;">
                            (Valoración de desempeño en competencias, evidencias entregadas y procesos pedagógicos de apoyo.)
                          </div>
                        </li>
                      </ol>
                    </li>
                  </ol>
                </li>
                ${desarrolloInstructoresHTML}
                ${desarrolloAnalisisCompetenciasHTML}

            <li class="titulo-1">
              Análisis de casos especiales
              <div class="contenido-item" style="font-size:9pt; font-style:italic; margin-top:4px;">
                (Resaltar eventos o situaciones de riesgo que requieren atención prioritaria o acompañamientos específicos.)
              </div>
            </li>
            <li class="titulo-1">
              Recomendaciones del comité
              <div class="contenido-item" style="font-size:9pt; font-style:italic; margin-top:4px;">
                (Registrar las acciones sugeridas por el comité para fortalecer resultados, mitigar riesgos y apoyar la estrategia del programa.)
              </div>
            </li>
          </ol>
        </td>
      </tr>

<!-- Continuación dentro de la misma tabla acta-encabezado: CONCLUSIONES -->
      <tr>
        <td colspan="4" class="acta-titulo" style="text-align:center; font-weight:700; padding:8px; border:1px solid #000;">
          CONCLUSIONES
        </td>
      </tr>

      <tr>
        <td colspan="4" style="height:120px; vertical-align:top; padding:8px; border:1px solid #000;"></td>
      </tr>

      <tr>
  <td colspan="4" style="padding:0; border:none;">
    <!-- Tabla unificada (20 columnas base) -->
    <table class="tabla-maestra" style="width:100%; border-collapse:collapse; table-layout:fixed; border:1px solid #000; margin-top:-1px;">
      <colgroup>
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
  <col style="width:5%;">
      </colgroup>

      <thead>
        <tr>
          <td colspan="20" style="text-align:center; font-weight:700; padding:6px; border:1px solid #000; background:#f3f4f6;">
            ESTABLECIMIENTO Y ACEPTACIÓN DE COMPROMISOS
          </td>
        </tr>
        <tr>
          <td colspan="8" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">ACTIVIDAD / DECISIÓN</td>
          <td colspan="3" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">FECHA</td>
          <td colspan="5" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">RESPONSABLE</td>
          <td colspan="4" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">FIRMA O PARTICIPACIÓN VIRTUAL</td>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td colspan="8" style="height:28px; border:1px solid #000;"></td>
          <td colspan="3" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="8" style="height:28px; border:1px solid #000;"></td>
          <td colspan="3" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="8" style="height:28px; border:1px solid #000;"></td>
          <td colspan="3" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="8" style="height:28px; border:1px solid #000;"></td>
          <td colspan="3" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
      </tbody>

      <thead>
        <tr>
          <td colspan="20" style="text-align:center; font-weight:700; padding:6px; border:1px solid #000; background:#f3f4f6;">
            DE: ASISTENTES Y APROBACIÓN DECISIONES
          </td>
        </tr>
        <tr>
          <td colspan="5" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">NOMBRE</td>
          <td colspan="4" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">DEPENDENCIA/ EMPRESA</td>
          <td colspan="2" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">APRUEBA (SI/NO)</td>
          <td colspan="5" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">OBSERVACIÓN</td>
          <td colspan="4" style="padding:6px; border:1px solid #000; font-weight:700; text-align:center;">FIRMA O PARTICIPACIÓN VIRTUAL</td>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td colspan="5" style="padding:8px; border:1px solid #000; color:#00324D; font-weight:700;">${coordinadorAcademico}</td>
          <td colspan="4" style="border:1px solid #000;"></td>
          <td colspan="2" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="5" style="padding:8px; border:1px solid #000; color:#00324D; font-weight:700;">${instructorGerente}</td>
          <td colspan="4" style="border:1px solid #000;"></td>
          <td colspan="2" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="5" style="padding:8px; border:1px solid #000; color:#00324D; font-weight:700;">${aprendizVocero}</td>
          <td colspan="4" style="border:1px solid #000;"></td>
          <td colspan="2" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="5" style="padding:8px; border:1px solid #000; color:#00324D; font-weight:700;">PSICOLOGA DE BIENESTAR:</td>
          <td colspan="4" style="border:1px solid #000;"></td>
          <td colspan="2" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
        <tr>
          <td colspan="5" style="height:28px; border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
          <td colspan="2" style="border:1px solid #000;"></td>
          <td colspan="5" style="border:1px solid #000;"></td>
          <td colspan="4" style="border:1px solid #000;"></td>
        </tr>
      </tbody>

      <tfoot>
        <tr>
          <td colspan="20" style="border:1px solid #000; padding:8px; text-align:justify; font-size:9pt;">
            De acuerdo con La Ley 1581 de 2012, Protección de Datos Personales, el Servicio Nacional de
            Aprendizaje SENA, se compromete a garantizar la seguridad y protección de los datos personales
            que se encuentran almacenados en este documento, y les dará el tratamiento correspondiente en
            cumplimiento de lo establecido legalmente.
          </td>
        </tr>
        <tr>
          <td colspan="20" style="border:1px solid #000; padding:8px; text-align:center; font-weight:bold; height:80px;">
            ANEXOS
          </td>
        </tr>
      </tfoot>
    </table>
  </td>
  <!-- Encabezado y pie de página Word -->
<div style="mso-element:header" id="h1">
  <p class="MsoHeader">
    <img src="${senaLogoUrl}" alt="Logo SENA" style="height:24px; width:auto; display:block; margin:0 auto;">
  </p>
</div>
<div style="mso-element:footer" id="f1">
  <p class="MsoFooter" style="text-align:center;"><span style="font-size:9pt;">GOR-F-084V02</span></p>
</div>
</tr>
</table>




     
    </div>
    
  </body>
</html>
`;

        // Crear y descargar el archivo .doc
        const blob = new Blob(['\ufeff', contenidoHTML], { type: "application/msword" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `${obtenerNombreArchivoActaComite()}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // =========================
      // Función para exportar los reportes seleccionados a Word
      // =========================
            // Aplica color al encabezado de la tabla (fila de títulos) en la hoja de Excel
      function aplicarEstilosCabeceraTabla(ws) {
        if (!ws["!ref"]) return;

        const range = XLSX.utils.decode_range(ws["!ref"]);
        const headerRow = range.s.r; // primera fila de la tabla (donde está el thead)

        for (let C = range.s.c; C <= range.e.c; ++C) {
          const addr = XLSX.utils.encode_cell({ r: headerRow, c: C });
          const cell = ws[addr];
          if (!cell) continue;

          cell.s = cell.s || {};
          // Verde SENA de tu diseño
          cell.s.fill = {
            patternType: "solid",
            fgColor: { rgb: "FF28A745" }   // #28a745 con alfa FF
          };
          cell.s.font = {
            color: { rgb: "FFFFFFFF" },    // blanco
            bold: true
          };
        }
      }

      // Colorea filas en Excel según las clases HTML de la fila <tr>
      function aplicarColoresFilaSegunClases(tabla, ws) {
        if (!ws["!ref"]) return;

        const range = XLSX.utils.decode_range(ws["!ref"]);
        const headerRow = range.s.r;
        const firstBodyRow = headerRow + 1; // primera fila de datos (después del encabezado)

        const filas = tabla.querySelectorAll("tbody tr");

        filas.forEach((tr, idx) => {
          let bg = null;

          // Misma lógica visual que en HTML/CSS:
          if (tr.classList.contains("fila-instructor-diferente")) {
            // Amarillo suave (#fff7b0)
            bg = "FFFFF7B0";
          } else if (tr.classList.contains("textoRojo")) {
            // Rojo claro (#fee2e2) para % Avance < 75%
            bg = "FFFEE2E2";
          }

          if (bg) {
            const excelRow = firstBodyRow + idx;

            for (let C = range.s.c; C <= range.e.c; ++C) {
              const addr = XLSX.utils.encode_cell({ r: excelRow, c: C });
              const cell = ws[addr];
              if (!cell) continue;

              cell.s = cell.s || {};
              cell.s.fill = {
                patternType: "solid",
                fgColor: { rgb: bg }
              };
            }
          }
        });
      }

      function exportarTodosLosReportesAExcel() {
  const wb = XLSX.utils.book_new();
  const seleccionados = obtenerReportesSeleccionadosCentro();

  // --- Funciones internas de utilidad para la exportación ---
  const MAX_SHEET_NAME_LENGTH = 31;
  const sanitizarNombreHoja = (texto) => {
    if (!texto) return "Reporte";
    // Elimina caracteres prohibidos en Excel: [ ] * / \ ? :
    const valid = texto.replace(/[\[\]\*\/\\\?\:]/g, "").trim();
    return valid || "Reporte";
  };

  const construirNombreHoja = (textoBase, indice) => {
    const suffix = indice === 0 ? "" : ` (${indice + 1})`;
    const maxBaseLength = MAX_SHEET_NAME_LENGTH - suffix.length;
    let base = textoBase;
    if (base.length > maxBaseLength) {
      base = base.slice(0, maxBaseLength);
    }
    return `${base}${suffix}`.trim() || "Reporte";
  };

  const agregarHoja = (tabla, nombreHoja) => {
    if (!tabla) return;
    
    // Clonar para no alterar el DOM original y limpiar iconos de ordenamiento
    const tablaLimpia = tabla.cloneNode(true);
    tablaLimpia.querySelectorAll(".sort-icons").forEach(el => el.remove());

    // Limpieza específica para tablas Gantt (quitar barras visuales)
    if (tablaLimpia.classList.contains("tabla-gantt-detalle") || tablaLimpia.classList.contains("tabla-cronograma-gantt")) {
      tablaLimpia.querySelectorAll("td").forEach(td => {
        if (td.querySelector(".gantt-month-bar")) {
          td.textContent = "X"; // Marca textual para Excel
        }
      });
      tablaLimpia.querySelectorAll(".gantt-month-bar").forEach(bar => bar.remove());
    }

    const ws = XLSX.utils.table_to_sheet(tablaLimpia, { origin: "A4" });
    aplicarEstilosCabeceraTabla(ws);
    aplicarColoresFilaSegunClases(tablaLimpia, ws);

    // Agregar encabezado institucional en las primeras filas
    XLSX.utils.sheet_add_aoa(
      ws,
      [
        ["SENA - Regional Tolima - Centro de Comercio y Servicios"],
        ["Reporte: " + nombreHoja],
        [] // Espacio antes de la tabla
      ],
      { origin: "A1" }
    );
    
    XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
  };

  // Función interna para obtener tablas, AHORA CON EL FIX PARA APRENDICES LISTOS
  const obtenerTablasParaMeta = (meta) => {
    const tablas = [];

    // --- FIX: Generar la tabla de Aprendices Listos si se solicita ---
    if (meta.key === "aprendices-listos-productiva") {
      const tablaGenerada = prepararDatosListosParaProductiva();
      if (tablaGenerada) {
        tablas.push(tablaGenerada);
      }
      return tablas;
    }
    // ---------------------------------------------------------------

    // Búsqueda normal por selector (para reportes que ya existen en el DOM)
    if (meta.exportTableSelector) {
      const tabla = document.querySelector(meta.exportTableSelector)?.closest("table");
      if (tabla) {
        tablas.push(tabla);
      }
    }

    // Búsqueda para reportes construidos dinámicamente (PDF Builders)
    if (meta.excelIncludeBuilderTables && typeof meta.pdfBuilder === "function") {
      const resultado = meta.pdfBuilder();
      const nodo = resultado?.origen || resultado;
      if (nodo instanceof Element) {
        if (nodo.tagName === "TABLE") {
          tablas.push(nodo);
        }
        nodo.querySelectorAll("table").forEach(tbl => tablas.push(tbl));
      }
    }
    return tablas;
  };

  const contadorNombres = new Map();

  // Iterar sobre los metadatos globales de reportes
  if (typeof reportesCentroMetadatos !== "undefined") {
    reportesCentroMetadatos.forEach(meta => {
      if (!seleccionados.includes(meta.key)) return;

      const tablas = obtenerTablasParaMeta(meta);
      if (!tablas.length) return;

      tablas.forEach(tabla => {
        const nombreLimpio = sanitizarNombreHoja(meta.excelName || meta.label || "Reporte");
        const cuenta = contadorNombres.get(nombreLimpio) || 0;
        const nombreHoja = construirNombreHoja(nombreLimpio, cuenta);
        contadorNombres.set(nombreLimpio, cuenta + 1);
        
        agregarHoja(tabla, nombreHoja);
      });
    });
  } else {
    console.warn("La variable global 'reportesCentroMetadatos' no está definida.");
  }

  // Validar si se generó alguna hoja
  if (wb.SheetNames.length === 0) {
    alert("⚠️ Debes seleccionar al menos un reporte válido para exportar o el reporte seleccionado no contiene datos.");
    return;
  }

  // Descargar archivo
  XLSX.writeFile(wb, `${obtenerNombreArchivoActaComite()}.xlsx`);
}

      document.addEventListener("DOMContentLoaded", function () {
        const botonExcel = document.getElementById("btnExportarExcel");
        if (botonExcel) {
          botonExcel.addEventListener("click", exportarTodosLosReportesAExcel);
        } else {
          console.warn("❗ No se encontró el botón con id 'btnExportarExcel'");
        }
        // NUEVO: botón Acta Comité
        const botonActaComite = document.getElementById("btnActaComite");
        if (botonActaComite) {
          botonActaComite.addEventListener("click", exportarActaComiteWord);
        } else {
          console.warn("❗ No se encontró el botón con id 'btnActaComite'");
        }

        // Lógica para pestañas (tabs)
        const tabs = document.querySelectorAll('.tabs a');
        tabs.forEach(tab => {
          tab.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.remove('active');
            });
            document.querySelector(targetId).classList.add('active');
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
          });
        });
      });

      // --- Forzar que el gráfico de horas se ajuste cuando se abre el tab 3 ---
      document.addEventListener("DOMContentLoaded", function () {
        const tabHorasLink = document.querySelector('.tabs a[data-tab="tab3"]');

        if (tabHorasLink) {
          tabHorasLink.addEventListener("click", function () {
            // damos un pequeño tiempo para que el tab se muestre y el contenedor tenga ancho
            setTimeout(function () {
              if (window.chartHoras) {
                chartHoras.render();
              }
            }, 150);
          });
        }
      });
      document.addEventListener("DOMContentLoaded", function () {
        const tab3Link = document.querySelector('.tabs a[href="#tab3"]');
        if (tab3Link) {
          tab3Link.addEventListener("click", function () {
            if (chartHorasInstructores) {
              // Esperamos un instante a que el tab ya esté visible
              setTimeout(function () {
                chartHorasInstructores.render();
              }, 50);
            }
          });
        }
      });
      document.addEventListener("DOMContentLoaded", function () {
        const tab2Link = document.querySelector('.tabs a[href="#tab2"]');
        if (tab2Link) {
          tab2Link.addEventListener("click", function () {
            // pequeña espera para que el tab ya esté visible y tenga ancho
            setTimeout(function () {
              if (chartCompetenciasHoras) {
                chartCompetenciasHoras.render();      // solo reajusta tamaños
              } else {
                // por si el usuario abre tab2 después de cargar los datos
                dibujarGraficoCompetenciasHoras();
              }
              actualizarTotalesReporte2();
            }, 50);
          });
        }
      });

      // Colores específicos por categoría para el gráfico de % competencias
      function getColorCategoriaGrafico(categoria) {
        switch (categoria) {
          case "Transversales":
            return "#166534"; // verde oscuro
          case "Inglés":
            return "#0f766e"; // verde azulado
          case "Práctica":
            return "#022c22"; // verde muy oscuro (casi negro)
          case "Técnicas":
          default:
            return "#16a34a"; // verde actual
        }
      }
      // Actualiza el resumen numérico de la ficha
      // (Nº aprendices, Nº instructores, Nº competencias e instructor con más horas)
      function actualizarResumenFicha() {
        const spanAprendices = document.getElementById("numAprendicesHeader");
        const spanInstructores = document.getElementById("numInstructoresHeader");
        const spanCompetencias = document.getElementById("numCompetenciasHeader");
        const spanInstructorTop = document.getElementById("instructorMasHorasHeader");

        if (!spanAprendices && !spanInstructores && !spanCompetencias && !spanInstructorTop) {
          return;
        }

        const normalizarEstadoResumen = (texto) => {
          return (texto || "")
            .toString()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toUpperCase()
            .trim()
            .replace(/\s+/g, " ");
        };

        // 1) Nº aprendices: desde la tabla de estados
        let totalAprendices = 0;
        const tbodyEstado = document.getElementById("tbodyEstado");

        if (tbodyEstado) {
          const filas = tbodyEstado.querySelectorAll("tr");

          filas.forEach(tr => {
            const badgeEstado = tr.querySelector(".badge-estado");
            const celdaCantidad = tr.querySelector(".col-cantidad");
            if (!badgeEstado || !celdaCantidad) return;

            const estadoNorm = normalizarEstadoResumen(badgeEstado.textContent);

            if (estadoNorm === "EN FORMACION" || estadoNorm === "CONDICIONADO") {
              const cant = parseInt(celdaCantidad.textContent, 10) || 0;
              totalAprendices += cant;
            }
          });
        }

        if (spanAprendices) {
          spanAprendices.textContent = totalAprendices;
        }
        // 2) Nº instructores + instructor con más horas
        let totalInstructores = 0;
        let instructorTopNombre = "";
        let instructorTopHoras = 0;

        if (Array.isArray(datosHorario)) {
          const horasPorInstructor = {};

          datosHorario.forEach(fila => {
            const nombreInstructor = (fila["Nombre Instructor"] || "").toString().trim();
            const horas = Number(fila["Horas Programadas"]) || 0;

            if (!nombreInstructor) return;

            if (!horasPorInstructor[nombreInstructor]) {
              horasPorInstructor[nombreInstructor] = 0;
            }
            horasPorInstructor[nombreInstructor] += horas;
          });

          totalInstructores = Object.keys(horasPorInstructor).length;

          Object.entries(horasPorInstructor).forEach(([nombre, horas]) => {
            if (horas > instructorTopHoras) {
              instructorTopHoras = horas;
              instructorTopNombre = nombre;
            }
          });

          // <<< AÑADIR ESTO >>>
          listaInstructoresGlobal = Object.keys(horasPorInstructor);
          instructorMasHorasGlobal = instructorTopNombre;
        }

        if (spanInstructores) {
          spanInstructores.textContent = totalInstructores;
        }
        if (spanInstructorTop) {
          spanInstructorTop.textContent = instructorTopNombre || "Sin información";
        }

        // 3) Nº competencias
        let totalCompetencias = 0;

        // Preferir el total de competencias del programa (archivo 3)
        if (typeof totalCompetenciasPrograma === "number" && totalCompetenciasPrograma > 0) {
          totalCompetencias = totalCompetenciasPrograma;
        } else if (typeof arrComp2 !== "undefined" && Array.isArray(arrComp2) && arrComp2.length) {
          totalCompetencias = arrComp2.length;
        } else if (Array.isArray(datosHorario)) {
          // Fallback: contar únicas en el horario
          const competenciasSet = new Set();
          datosHorario.forEach(fila => {
            const comp = (fila["Nombre Competencia"] || "").toString().trim();
            if (comp) {
              competenciasSet.add(comp);
            }
          });
          totalCompetencias = competenciasSet.size;
        }

        if (spanCompetencias) {
          spanCompetencias.textContent = totalCompetencias;
        }
      }
      // Actualiza el nombre mostrado en "Instructor con más horas cargadas"
      // y guarda el Gerente de Proyecto seleccionado
      function actualizarGerenteEnHeader(nombre) {
        gerenteProyectoSeleccionado = nombre || "";

        const spanInstructorTop = document.getElementById("instructorMasHorasHeader");
        if (spanInstructorTop) {
          spanInstructorTop.textContent = nombre || "Sin información";
        }
      }

      // Muestra el cuadro para confirmar Gerente de Proyecto
      function mostrarModalGerenteProyecto() {
        const overlay = document.getElementById("gerenteOverlay");
        const nombreSpan = document.getElementById("gerenteInstructorNombre");
        const selectGerente = document.getElementById("selectGerenteProyecto");

        if (!overlay) return;

        const nombreTop = instructorMasHorasGlobal || "";

        if (nombreSpan) {
          nombreSpan.textContent = nombreTop || "No se pudo identificar el instructor con más horas programadas.";
        }

        // Rellenar el combo con todos los instructores
        if (selectGerente) {
          selectGerente.innerHTML = '<option value="">Seleccione un instructor…</option>';

          if (Array.isArray(listaInstructoresGlobal) && listaInstructoresGlobal.length > 0) {
            // Ordenar alfabéticamente de A a Z (insensible a mayúsculas/acentos)
            const listaOrdenada = [...listaInstructoresGlobal].sort((a, b) =>
              a.localeCompare(b, "es", { sensitivity: "base" })
            );

            listaOrdenada.forEach(nombre => {
              const opt = document.createElement("option");
              opt.value = nombre;
              opt.textContent = nombre;
              selectGerente.appendChild(opt);
            });
          }


          // Por defecto, dejar seleccionado el instructor con más horas (si existe)
          if (nombreTop) {
            selectGerente.value = nombreTop;
          }
        }

        overlay.style.display = "flex";
      }


      // =========================
      // Wrapper de compatibilidad para Reporte 1 (Carga inicial)
      // =========================
      function aplicarFiltrosYGenerarReporte1() {
        // 1. Generar la tabla completa (si hay datos)
        if (typeof generarReporte1 === "function" && Array.isArray(registrosGlobal)) {
          generarReporte1(registrosGlobal);
        }
        // 2. Aplicar filtros usando la nueva lógica
        aplicarFiltrosInstructores();
      }

      // =========================
      // Filtros para Gantt de Competencias
      // =========================

      let filtrosGanttCompetencias = {
        texto: "",
        categorias: {
          "Práctica": true,
          "Transversales": true,
          "Inglés": true,
          "Técnicas": true
        }
      };

      function aplicarFiltrosGanttCompetencias() {
        if (!Array.isArray(registrosGlobal) || !registrosGlobal.length) {
          generarGanttChart([]);
          return;
        }

        const texto = (filtrosGanttCompetencias.texto || "").trim().toLowerCase();
        const categoriasActivas = filtrosGanttCompetencias.categorias;

        const registrosFiltrados = registrosGlobal.filter(r => {
          const competencia = (r.competencia || "").toString().trim();
          let categoria = "";

          if (typeof getCategoria === "function") {
            try {
              categoria = getCategoria(competencia);
            } catch (e) {
              categoria = "";
            }
          }

          // Filtro por categoría (chips)
          if (
            categoria &&
            Object.prototype.hasOwnProperty.call(categoriasActivas, categoria) &&
            !categoriasActivas[categoria]
          ) {
            return false;
          }
          // Filtro por texto (busca en todas las columnas)
          if (visible && texto) {
            const textoFila = Array.from(celdas)
              .map(td => (td.textContent || "").toLowerCase())
              .join(" ");

            if (!textoFila.includes(texto)) {
              visible = false;
            }
          }

          // Filtro por color de d?as (verde/rojo) - puede haber ambos activos
          if (visible) {
            const activos = obtenerColoresActivos("tablaProgramadas");
            if (activos.length > 0) {
              const diasColor = (celdas[3]?.getAttribute("data-color") || "").toLowerCase();
              if (!activos.includes(diasColor)) {
                visible = false;
              }
            }
          }

          if (visible && categoria) {
            visiblePorCategoria[categoria] = true;
          }

          filasDatos.push({ tr, categoria, visible });
        });

        // Aplicar visibilidad a filas de datos
        filasDatos.forEach(item => {
          item.tr.style.display = item.visible ? "" : "none";
        });

        // Mostrar u ocultar cabeceras de categoría según haya filas visibles
        filasCabecera.forEach(item => {
          const cat = item.categoria;
          const activa =
            !Object.prototype.hasOwnProperty.call(categoriasActivas, cat) ||
            categoriasActivas[cat];

          if (activa && visiblePorCategoria[cat]) {
            item.tr.style.display = "";
          } else {
            item.tr.style.display = "none";
          }
        });

        // Renumerar solo las filas visibles de datos
        let contadorVisible = 1;
        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;

          // Saltar filas cabecera de categoría
          if (celdas.length === 1 && celdas[0].colSpan >= 5) return;

          celdas[0].textContent = contadorVisible++;
        });
      }

        function aplicarFiltrosReporte2() {
      // Reporte 2: colCompetencia=1, colTipo=2, agrupado=false
      // (Asumiendo indices: 0=#, 1=Comp, 2=Tipo ... en tabla plana)
      aplicarFiltrosCompetenciasConTipo("tbodyReporte2", filtrosReporte2, { colCompetencia: 1, colTipo: 2, agrupado: false });

      const tbody = document.getElementById("tbodyReporte2");
      if (!tbody) return;

      // Filtro por color (días) - AND con filtros anteriores
      const coloresActivos = obtenerColoresActivos("tablaReporte2");
      if (coloresActivos.length > 0) {
        Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
          if (tr.style.display === "none") return;
          const diasTd = tr.querySelector("td.col-dias");
          const color = (diasTd?.getAttribute("data-color") || "").toLowerCase();
          if (!coloresActivos.includes(color)) {
            tr.style.display = "none";
          }
        });
      }

      // Filtro por mes (AND con lo anterior)
      let mostrarTodosMes = !filtroMesReporte2 || filtroMesReporte2 === "ALL";
      let rango = mostrarTodosMes ? null : obtenerRangoMes(filtroMesReporte2);
      if (!rango && !mostrarTodosMes) {
        mostrarTodosMes = true;
      }

      Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
        if (!tr || !tr.cells || tr.cells.length === 0) return;

        // Ocultar/restaurar campos que NO aplican cuando se filtra por mes
        [6, 8].forEach(idx => {
          const celda = tr.cells[idx];
          if (!celda) return;
          if (mostrarTodosMes) restaurarValorCampoMes(celda);
          else ocultarValorCampoMes(celda);
        });

        if (mostrarTodosMes) return;
        if (tr.style.display === "none") return;

        const inicio = tr.dataset.fechaInicio ? new Date(tr.dataset.fechaInicio) : null;
        const fin = tr.dataset.fechaFin ? new Date(tr.dataset.fechaFin) : null;

        if (!solapaMes(inicio, fin, rango)) {
          tr.style.display = "none";
        }
      });

      renumerarFilasTabla(tbody);
      actualizarTotalesReporte2();
      }

      function aplicarFiltrosReporte3() {
        const tbody = document.getElementById("tbodyReporte3");
        if (!tbody) return;

        const texto = (document.getElementById("busquedaInstructoresHoras")?.value || "").trim().toLowerCase();
        const coloresActivos = obtenerColoresActivos("tablaInstructoresHoras");

        let mostrarTodosMes = !filtroMesReporte3 || filtroMesReporte3 === "ALL";
        let rango = mostrarTodosMes ? null : obtenerRangoMes(filtroMesReporte3);
        if (!rango && !mostrarTodosMes) {
          mostrarTodosMes = true;
        }

        const filas = Array.from(tbody.querySelectorAll("tr"));
        filas.forEach(tr => {
          if (!tr || !tr.cells || tr.cells.length === 0) return;

          let visible = true;

          // Mes
          if (!mostrarTodosMes) {
            const inicio = tr.dataset.fechaInicio ? new Date(tr.dataset.fechaInicio) : null;
            const fin = tr.dataset.fechaFin ? new Date(tr.dataset.fechaFin) : null;
            if (!solapaMes(inicio, fin, rango)) visible = false;
          }

          // Categorías (Tipo)
          if (visible && typeof filtrosReporte3Categorias !== "undefined" && filtrosReporte3Categorias) {
            const tiposAttr = (tr.dataset.tipo || "").toLowerCase();
            if (tiposAttr) {
              const tiposFila = tiposAttr.split(/\s+/).filter(Boolean);
              const tieneActivo = tiposFila.some(tipo => !!filtrosReporte3Categorias[tipo]);
              if (!tieneActivo) visible = false;
            } else {
              const algunoActivo = Object.values(filtrosReporte3Categorias).some(v => !!v);
              if (algunoActivo) visible = false;
            }
          }

          // Colores (días)
          if (visible && coloresActivos.length > 0) {
            const diasTd = tr.querySelector("td.col-dias");
            const color = (diasTd?.getAttribute("data-color") || "").toLowerCase();
            if (!coloresActivos.includes(color)) visible = false;
          }

          // Texto
          if (visible && texto) {
            const textoFila = Array.from(tr.cells).map(td => (td.textContent || "").toLowerCase()).join(" ");
            if (!textoFila.includes(texto)) visible = false;
          }

          tr.style.display = visible ? "" : "none";

          // Ocultar/restaurar "Horas Programadas" cuando se filtra por mes
          const celdaHoras = tr.cells[7];
          if (celdaHoras) {
            if (mostrarTodosMes) restaurarValorCampoMes(celdaHoras);
            else ocultarValorCampoMes(celdaHoras);
          }
        });

        renumerarFilasTabla(tbody);
        actualizarTotalHorasReporte3();
      }

      function aplicarFiltrosReporte6() {
        const tbody = document.getElementById("tbodyReporte6");
        if (!tbody) return;

        const texto = (filtrosReporte6.texto || "").toLowerCase();
        const cats = filtrosReporte6.categorias;
        const soloOtro = filtrosReporte6.soloRapsOtro;
        const soloNoProg = filtrosReporte6.soloRapsNoProgramados;
        const coloresActivos = obtenerColoresActivos("tablaReporte6");
        const filtrarNoAprobado = coloresActivos.includes("no-aprobado");
        const coloresDias = coloresActivos.filter(color => color !== "no-aprobado");

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let contadorVisibles = 1;
        let cabeceraActual = null;
        let catActual = "";

        filas.forEach(tr => {
          const celdas = tr.getElementsByTagName("td");
          if (celdas[0] && celdas[0].colSpan > 1) {
            cabeceraActual = tr;
            catActual = tr.textContent.trim();
            tr.style.display = "none";
            return;
          }
          if (!celdas.length) return;

          let visible = true;

          if (texto && !tr.textContent.toLowerCase().includes(texto)) {
            visible = false;
          }

          if (visible && catActual) {
            const categoriaKey = normalizarCategoriaGantt(catActual);
            if (categoriaKey && Object.prototype.hasOwnProperty.call(cats, categoriaKey) && !cats[categoriaKey]) {
              visible = false;
            }
          }

          if (visible && soloOtro) {
            if (!tr.classList.contains("fila-instructor-diferente")) visible = false;
          }
          if (visible && soloNoProg) {
            if (!tr.classList.contains("fila-rap-no-programado")) visible = false;
          }

          if (visible) {
            const tipoTexto = (celdas[2]?.textContent || "").trim();
            const tipoKey = normalizarCategoriaGantt(tipoTexto);
            if (tipoKey && Object.prototype.hasOwnProperty.call(cats, tipoKey) && !cats[tipoKey]) {
              visible = false;
            }
          }

          if (visible && coloresDias.length > 0) {
            const tdDias = tr.querySelector("td.col-dias");
            const diasColor = (tdDias?.getAttribute("data-color") || "").toLowerCase();
            if (!coloresDias.includes(diasColor)) {
              visible = false;
            }
          }

          if (visible && filtrarNoAprobado) {
            const noAprobadoTexto = (celdas[10]?.textContent || "").trim();
            const noAprobadoValor = parseFloat(noAprobadoTexto.replace(/,/g, ".") || "0");
            if (!noAprobadoValor || noAprobadoValor <= 0) {
              visible = false;
            }
          }

          tr.style.display = visible ? "" : "none";

          if (visible) {
            if (celdas[0]) celdas[0].textContent = contadorVisibles++;
            if (cabeceraActual) cabeceraActual.style.display = "";
          }
        });
        actualizarTotalesReporte6();
      }

      // =========================
      // Listeners para filtros
      // =========================

      // (Bloque de listeners duplicados eliminado)



      // Listeners duplicados eliminados
      document.addEventListener("DOMContentLoaded", function () {
        // Bloque vacío o mantenemos solo el de Gantt si es necesario
      });

      // NUEVO: botón "Raps Aprobados por otro Instructor" (solo filas amarillas)
      const chkSoloRapsOtro = document.getElementById("chkSoloRapsOtro");
      if (chkSoloRapsOtro) {
        chkSoloRapsOtro.addEventListener("change", function () {
          filtrosReporte6.soloRapsOtro = this.checked;
          aplicarFiltrosReporte6();
        });
      }

      const chkSoloRapsNoProgramados = document.getElementById("chkSoloRapsNoProgramados");
      if (chkSoloRapsNoProgramados) {
        chkSoloRapsNoProgramados.addEventListener("change", function () {
          filtrosReporte6.soloRapsNoProgramados = this.checked;
          aplicarFiltrosReporte6();
        });
      }


      // Listeners para cajas de búsqueda y checkboxes
      document.addEventListener("DOMContentLoaded", function () {



        // --- Reporte 2 filtros ---
        const inputBusqueda2 = document.getElementById("busquedaReporte2");
        if (inputBusqueda2) {
          inputBusqueda2.addEventListener("input", function () {
            filtrosReporte2.texto = (this.value || "").trim();
            aplicarFiltrosReporte2();
          });
        }
        document.querySelectorAll(".chip-reporte2.chip-tipo").forEach(chip => {
          chip.addEventListener("click", function () {
            const tipo = this.getAttribute("data-tipo");
            if (!tipo) return;
            const activo = !filtrosReporte2.categorias[tipo];
            filtrosReporte2.categorias[tipo] = activo;

            // Visual toggle
            if (!activo) this.classList.add("chip-inactivo");
            else this.classList.remove("chip-inactivo");

            aplicarFiltrosReporte2();
          });
        });

        // --- Reporte 6 filtros ---
        const chkSoloRapsOtro = document.getElementById("chkSoloRapsOtro");
        if (chkSoloRapsOtro) {
          chkSoloRapsOtro.addEventListener("change", function () {
            filtrosReporte6.soloRapsOtro = this.checked;
            aplicarFiltrosReporte6();
          });
        }
        const chkSoloRapsNoProgramados = document.getElementById("chkSoloRapsNoProgramados");
        if (chkSoloRapsNoProgramados) {
          chkSoloRapsNoProgramados.addEventListener("change", function () {
            filtrosReporte6.soloRapsNoProgramados = this.checked;
            aplicarFiltrosReporte6();
          });
        }

        // --- Reporte 5 - Competencias ya programadas ---
          const inputBusquedaProgramadas = document.getElementById("busquedaProgramadas");
          if (inputBusquedaProgramadas) {
            inputBusquedaProgramadas.addEventListener("input", function () {
              filtrosReporte5.texto = this.value || "";
              aplicarFiltrosReporte5();
            });
          }

        function obtenerColorParaTipo(tipo) {
          const normalizada = normalizarCategoriaGantt(tipo || "");
          const mapa = {
            tecnicas: "#22c55e", // Verde
            ingles: "#2563eb", // Azul
            transversales: "#eab308", // Amarillo
            practica: "#a855f7"  // Morado
          };
          return mapa[normalizada] || "#22c55e";
        }

        function dibujarGanttDetalle(registros = registrosGanttCache) {
          const contenedor = document.getElementById("anychartGanttContainer");
          if (!contenedor) return;

          contenedor.innerHTML = "";

          let overallStart = null;
          let overallEnd = null;
          const registrosValidos = [];

          // 1. Procesar datos
          registros.forEach(r => {
            if (!r.fechaInicioProg || !r.fechaFinProg) return;
            const start = parseFecha(r.fechaInicioProg);
            const end = parseFecha(r.fechaFinProg);

            if (!(start instanceof Date) || isNaN(start.getTime()) ||
              !(end instanceof Date) || isNaN(end.getTime())) return;

            registrosValidos.push({
              competencia: r.competencia,
              tipo: getCategoria(r.competencia), // Usa función global existente
              instructor: (r.nombreInstructor || "") + " " + (r.apellidoInstructor || ""),
              inicio: start,
              fin: end
            });

            if (!overallStart || start < overallStart) overallStart = start;
            if (!overallEnd || end > overallEnd) overallEnd = end;
          });

          if (!overallStart || !overallEnd || registrosValidos.length === 0) {
            contenedor.innerHTML = "<div style='padding:20px; text-align:center;'>No hay datos para mostrar.</div>";
            return;
          }

          // 2. Meses
          const meses = [];
          const startMonth = new Date(overallStart.getFullYear(), overallStart.getMonth(), 1);
          const endMonth = new Date(overallEnd.getFullYear(), overallEnd.getMonth(), 1);

          for (let d = new Date(startMonth); d <= endMonth; d.setMonth(d.getMonth() + 1)) {
            meses.push(new Date(d.getFullYear(), d.getMonth(), 1));
          }

          // 3. Filtrar
          const textoBusqueda = (filtrosGantt.texto || "").trim().toLowerCase();

          const datosFiltrados = registrosValidos.filter(fila => {
            const catKey = normalizarCategoriaGantt(fila.tipo);
            if (!filtrosGantt.categorias[catKey]) return false;

            if (!textoBusqueda) return true;
            const comp = (fila.competencia || "").toLowerCase();
            const inst = (fila.instructor || "").toLowerCase();
            return comp.includes(textoBusqueda) || inst.includes(textoBusqueda);
          });

          datosFiltrados.sort((a, b) => {
            if (a.inicio && b.inicio) {
              const diff = a.inicio.getTime() - b.inicio.getTime();
              if (diff !== 0) return diff;
            }
            return a.competencia.localeCompare(b.competencia);
          });

          // 4. HTML
          const colgroupMonths = meses.map(() => '<col style="width:26px;">').join("");
          const mesesAbrev = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];

          let html = "<table class='tabla-gantt-detalle'>";
          html += `<colgroup>
        <col style="width:40px;">
        <col style="width:220px;">
        <col style="width:120px;">
        <col style="width:180px;">
        ${colgroupMonths}
      </colgroup>`;

          html += "<thead><tr>";
          html += "<th>#</th><th>Competencia</th><th>Tipo</th><th>Instructor</th>";
          meses.forEach(m => {
            const label = mesesAbrev[m.getMonth()] + "<br>" + m.getFullYear().toString().slice(-2);
            html += `<th>${label}</th>`;
          });
          html += "</tr></thead><tbody>";

          let contador = 1;
          datosFiltrados.forEach(fila => {
            html += "<tr>";
            html += `<td style='text-align:center;'>${contador++}</td>`;
            html += `<td>${fila.competencia}</td>`;
            html += `<td>${fila.tipo}</td>`;
            html += `<td>${fila.instructor}</td>`;

            meses.forEach(m => {
              const mY = m.getFullYear();
              const mM = m.getMonth();
              const sY = fila.inicio.getFullYear();
              const sM = fila.inicio.getMonth();
              const eY = fila.fin.getFullYear();
              const eM = fila.fin.getMonth();

              // Lógica de solapamiento de meses (inclusiva)
              const inRange = (
                (mY > sY || (mY === sY && mM >= sM)) &&
                (mY < eY || (mY === eY && mM <= eM))
              );

              if (inRange) {
                const colorBarra = obtenerColorParaTipo(fila.tipo);
                html += `<td class='gantt-month-bar' style='background-color:${colorBarra};'></td>`;
              } else {
                html += "<td class='gantt-month-cell'></td>";
              }
            });
            html += "</tr>";
          });
          html += "</tbody></table>";

          contenedor.innerHTML = html;
        }

          const checkboxesCatProgramadas = document.querySelectorAll(".chk-cat-programadas");
          checkboxesCatProgramadas.forEach(chk => {
            chk.addEventListener("change", function () {
              const cat = this.getAttribute("data-cat");
              const catKey = normalizarCategoriaGantt(cat);
              if (!catKey) return;
              filtrosReporte5.tipos[catKey] = this.checked;
              const label = this.closest(".chip-reporte1");
              if (label) {
                label.classList.toggle("chip-inactivo", !this.checked);
              }
              aplicarFiltrosReporte5();
            });
          });
        // --- Reporte 3 - Listado de Instructores (Total de Horas Programadas) ---
        const inputInstructoresHoras = document.getElementById("busquedaInstructoresHoras");
        if (inputInstructoresHoras) {
          inputInstructoresHoras.addEventListener("input", function () {
            aplicarFiltrosReporte3();
          });
        }
        document.querySelectorAll(".chk-cat-reporte3").forEach(chk => {
          chk.addEventListener("change", function () {
            const cat = this.getAttribute("data-cat");
            if (!cat) return;
            const key = normalizarCategoriaGantt(cat);
            if (!key) return;
            filtrosReporte3Categorias[key] = this.checked;
            const label = this.closest(".chip-reporte1");
            if (label) {
              label.classList.toggle("chip-inactivo", !this.checked);
            }
            aplicarFiltrosReporte3();
          });
        });

        // --- Reporte 6 - % Avance por Aprendiz ---
        const inputAvanceAprendiz = document.getElementById("busquedaAvanceAprendiz");
        if (inputAvanceAprendiz) {
          inputAvanceAprendiz.addEventListener("input", function () {
            // Filtra las filas del tbody usado por el reporte 7
            filtrarTablaSimplePorTexto("pivotAvanceContainer", this.value);
          });
        }
        // --- Reporte 7 - Competencias Pendientes por Aprendiz e Instructor ---
        const inputPendientesAprendiz = document.getElementById("busquedaPendientesAprendiz");
        if (inputPendientesAprendiz) {
          inputPendientesAprendiz.addEventListener("input", function () {
            filtrarTablasReporte8PorTexto(this.value);
          });
        }
        // --- Reporte 8 - Listado de Instructores con aprendices pendientes por emitir Juicio ---
        const inputPendientesJuicio = document.getElementById("busquedaPendientesJuicio");
        if (inputPendientesJuicio) {
          inputPendientesJuicio.addEventListener("input", function () {
            filtrarTablaSimplePorTexto("tbodyPendientesInstructorReporte8", this.value);
          });
        }
      });

      // Estado de filtros para Competencias ya programadas (Reporte 5)
      let filtrosReporte5 = {
        texto: "",
        tipos: {
          transversales: true,
          tecnicas: true,
          ingles: true,
          practica: true
        }
      };

      function aplicarFiltrosReporte5() {
        const tbodyProg = document.getElementById("tbodyProgramadas");
        if (!tbodyProg) return;

        const texto = (filtrosReporte5.texto || "").trim().toLowerCase();
        const tiposActivos = filtrosReporte5.tipos;

        const filas = Array.from(tbodyProg.querySelectorAll("tr"));
        if (!filas.length) return;

        let contadorVisible = 1;

        filas.forEach(tr => {
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;

          let visible = true;
          const tipoTexto = (celdas[2]?.textContent || "").trim();
          const tipoKey = normalizarCategoriaGantt(tipoTexto);

          if (
            tipoKey &&
            Object.prototype.hasOwnProperty.call(tiposActivos, tipoKey) &&
            !tiposActivos[tipoKey]
          ) {
            visible = false;
          }

          if (visible && texto) {
            const textoFila = Array.from(celdas)
              .map(td => (td.textContent || "").toLowerCase())
              .join(" ");
            if (!textoFila.includes(texto)) {
              visible = false;
            }
          }

          if (visible) {
            const activos = obtenerColoresActivos("tablaProgramadas");
            if (activos.length > 0) {
              const diasColor = (celdas[5]?.getAttribute("data-color") || "").toLowerCase();
              if (!activos.includes(diasColor)) {
                visible = false;
              }
            }
          }

          if (visible && filtrosReporte6.soloRapsOtro) {
            if (!tr.classList.contains("fila-instructor-diferente")) {
              visible = false;
            }
          }

          if (visible && filtrosReporte6.soloRapsNoProgramados) {
            if (!tr.classList.contains("fila-rap-no-programado")) {
              visible = false;
            }
          }

          tr.style.display = visible ? "" : "none";
          if (visible && celdas.length) {
            celdas[0].textContent = contadorVisible++;
          }
        });
        actualizarTotalCantidadAprendicesVistoTablaProgramadas();
        actualizarTotalCantAprendicesProgramadas();
      }

      function parseNumeroDesdeTexto(texto) {
        if (!texto) return 0;
        const limpio = texto.toString().replace(/\./g, "").replace(/,/g, ".");
        const valor = Number(limpio);
        return Number.isFinite(valor) ? valor : 0;
      }

      function parseNumericParts(texto) {
        if (!texto) return null;
        const trimmed = texto.toString().trim();
        const match = trimmed.match(/^(-?\d+(?:\.\d+)?)/);
        if (!match) return null;
        const number = Number(match[1]);
        const suffix = trimmed.substring(match[1].length);
        const decimals = match[1].includes(".") ? match[1].split(".")[1].length : 0;
        return { number, suffix, decimals };
      }

      function animateValue(element, newText, duration = 300) {
        if (!element) return;
        const parsed = parseNumericParts(newText);
        if (!parsed) {
          element.textContent = newText;
          element.dataset.currentValue = "";
          return;
        }
        const { number: target, suffix, decimals } = parsed;
        const prevValue = parseFloat(element.dataset.currentValue);
        const startValue = Number.isFinite(prevValue) ? prevValue : target;
        if (element.dataset.animationId) {
          cancelAnimationFrame(Number(element.dataset.animationId));
        }
        const startTime = performance.now();
        const step = (now) => {
          const progress = Math.min(1, (now - startTime) / duration);
          const current = startValue + (target - startValue) * progress;
          element.textContent = suffix
            ? `${current.toFixed(decimals)}${suffix}`
            : current.toFixed(decimals);
          if (progress < 1) {
            element.dataset.animationId = requestAnimationFrame(step);
          } else {
            element.dataset.animationId = "";
            element.dataset.currentValue = target.toString();
          }
        };
        element.dataset.currentValue = startValue.toString();
        element.dataset.animationId = requestAnimationFrame(step);
      }

      function establecerValorAnimado(elemento, texto) {
        if (!elemento) return;
        animateValue(elemento, texto);
        elemento.classList.remove("valor-animado");
        void elemento.offsetWidth;
        elemento.classList.add("valor-animado");
      }

      function actualizarCantidadFilasVisibles(containerId, spanId, restar = 0) {
        const contenedor = document.getElementById(containerId);
        const span = document.getElementById(spanId);
        if (!contenedor || !span) return;
        const filas = Array.from(contenedor.querySelectorAll("tr"))
          .filter(tr => tr.style.display !== "none" && tr.querySelectorAll("td").length > 1);
        const cantidad = Math.max(0, filas.length - (restar || 0));
        establecerValorAnimado(span, cantidad.toString());
      }

      function actualizarTotalCantidadAprendicesVistoTablaProgramadas() {
        const span = document.getElementById("numRapsPendientesVistoHeader");
        if (!span) return 0;

        const tabla = document.getElementById("tablaProgramadas");
        if (!tabla) {
          span.textContent = "0";
          totalRapsPendientesVistoGlobal = 0;
          return 0;
        }

        const filas = tabla.querySelectorAll("tbody tr");
        let total = 0;
        filas.forEach(tr => {
          const diasTd = tr.querySelector("td.col-dias");
          const color = (diasTd?.getAttribute("data-color") || "").toLowerCase();
          if (color !== "rojo") return;

          const celdas = tr.getElementsByTagName("td");
          const cantidadTd = celdas[8];
          if (!cantidadTd) return;

          total += parseNumeroDesdeTexto(cantidadTd.textContent);
        });

        totalRapsPendientesVistoGlobal = total;
        span.textContent = total.toString();
        return total;
      }

      function actualizarTotalCantAprendicesProgramadas() {
        const tabla = document.getElementById("tablaProgramadas");
        const span = document.getElementById("totalCantAprendicesProgramadas");
        if (!tabla || !span) return;

        const filas = Array.from(tabla.querySelectorAll("tbody tr"));
        let total = 0;
        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          const valor = parseNumeroDesdeTexto(celdas[8]?.textContent);
          total += valor;
        });

        const totalRedondeado = Math.round(total);
        establecerValorAnimado(span, totalRedondeado.toString());
        actualizarCantidadFilasVisibles("tablaProgramadas", "totalRegistrosProgramadas");
      }

      function actualizarTotalesReporte6() {
        const tbody = document.getElementById("tbodyReporte6");
        const spanAprobado = document.getElementById("totalAprobadoReporte6");
        const spanPorEvaluar = document.getElementById("totalPorEvaluarReporte6");
        const spanNoAprobado = document.getElementById("totalNoAprobadoReporte6");
        if (!tbody || !spanAprobado || !spanPorEvaluar || !spanNoAprobado) return;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let aprobado = 0;
        let porEvaluar = 0;
        let noAprobado = 0;

        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;
          aprobado += parseNumeroDesdeTexto(celdas[8]?.textContent);
          porEvaluar += parseNumeroDesdeTexto(celdas[9]?.textContent);
          noAprobado += parseNumeroDesdeTexto(celdas[10]?.textContent);
        });

        establecerValorAnimado(spanAprobado, Math.round(aprobado).toString());
        establecerValorAnimado(spanPorEvaluar, Math.round(porEvaluar).toString());
        establecerValorAnimado(spanNoAprobado, Math.round(noAprobado).toString());
        actualizarCantidadFilasVisibles("tablaReporte6", "totalRegistrosReporte6");
      }

      function actualizarTotalHorasReporte3() {
        const tbody = document.getElementById("tbodyReporte3");
        const spanTotal = document.getElementById("totalHorasReporte3");
        if (!tbody || !spanTotal) return;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let total = 0;
        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          const valor = parseNumeroDesdeTexto(celdas[7]?.textContent);
          total += valor;
        });

        const totalProcesado = Math.round(total / 100);
        establecerValorAnimado(spanTotal, totalProcesado.toString());
        actualizarCantidadFilasVisibles("tablaInstructoresHoras", "totalRegistrosReporte3", 1);
        const tfoot3 = document.getElementById("tfootReporte3");
        if (tfoot3) {
          tfoot3.innerHTML = `
            <tr>
              <td colspan="7" style="text-align:right; font-weight:bold;">Total Horas Programadas:</td>
              <td>${totalProcesado}</td>
            </tr>
          `;
        }
      }

      function actualizarTotalAprendicesReporte8() {
        const tbody = document.getElementById("tbodyPendientesInstructorReporte8");
        const spanTotal = document.getElementById("totalAprendicesPendientesReporte8");
        if (!tbody || !spanTotal) return;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let total = 0;
        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          const valor = parseNumeroDesdeTexto(celdas[8]?.textContent);
          total += valor;
        });

        const totalRedondeado = Math.round(total);
        establecerValorAnimado(spanTotal, totalRedondeado.toString());
      }

      function actualizarTotalesAvanceAprendiz() {
        const tbody = document.getElementById("pivotAvanceContainer");
        const spanAprobado = document.getElementById("totalAprobadoAvanceAprendiz");
        const spanPorEvaluar = document.getElementById("totalPorEvaluarAvanceAprendiz");
        const spanPromedio = document.getElementById("promedioPorcentajeAvanceAprendiz");
        if (!tbody || !spanAprobado || !spanPorEvaluar || !spanPromedio) return;

        const filas = Array.from(tbody.querySelectorAll("tr"));
        let totalAprobado = 0;
        let totalPorEvaluar = 0;
        let porcentajeSum = 0;
        let cantidadFilas = 0;

        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;
          totalAprobado += parseNumeroDesdeTexto(celdas[5]?.textContent);
          totalPorEvaluar += parseNumeroDesdeTexto(celdas[6]?.textContent);
          const pctTexto = (celdas[7]?.textContent || "").replace("%", "");
          const pctValor = parseNumeroDesdeTexto(pctTexto);
          if (!isNaN(pctValor)) {
            porcentajeSum += pctValor;
            cantidadFilas++;
          }
        });

        establecerValorAnimado(spanAprobado, Math.round(totalAprobado).toString());
        establecerValorAnimado(spanPorEvaluar, Math.round(totalPorEvaluar).toString());
        const promedio = cantidadFilas > 0 ? porcentajeSum / cantidadFilas : 0;
        const valorDividido = promedio / 100;
        establecerValorAnimado(spanPromedio, `${valorDividido.toFixed(2)}%`);
        actualizarCantidadFilasVisibles("pivotAvanceContainer", "totalRegistrosAvanceAprendiz");
      }

      function actualizarTotalesReporte2() {
        const tbody = document.getElementById("tbodyReporte2");
        const totalHoras = document.getElementById("totalHorasReporte2");
        const totalDiseno = document.getElementById("totalHorasDisenoReporte2");
        const totalPorcentaje = document.getElementById("totalPorcentajeReporte2");
        if (!tbody) {
          establecerValorAnimado(totalHoras, "0");
          establecerValorAnimado(totalDiseno, "0");
          establecerValorAnimado(totalPorcentaje, "0");
          return;
        }

        let horas = 0;
        let diseno = 0;
        let porcentaje = 0;
        let porcentajeCount = 0;

        tbody.querySelectorAll("tr").forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;

          horas += parseNumeroDesdeTexto(celdas[6]?.textContent);
          diseno += parseNumeroDesdeTexto(celdas[7]?.textContent);
          porcentaje += parseNumeroDesdeTexto(celdas[8]?.textContent.replace("%", ""));
          porcentajeCount++;
        });

        if (totalHoras) {
          const totalHorasValor = Math.round(horas / 100);
          establecerValorAnimado(totalHoras, totalHorasValor.toString());
        }
        if (totalDiseno) {
          const totalDisenoValor = Math.round(diseno / 100);
          establecerValorAnimado(totalDiseno, totalDisenoValor.toString());
        }
        if (totalPorcentaje) {
          const promedio = porcentajeCount > 0 ? porcentaje / porcentajeCount : 0;
          const valor = promedio / 100;
          establecerValorAnimado(totalPorcentaje, `${valor.toFixed(2)}%`);
        }

        const tfoot2 = document.getElementById("tfootReporte2");
        if (tfoot2) {
          const promedio = porcentajeCount > 0 ? porcentaje / porcentajeCount : 0;
          const valorPorcentaje = (promedio / 100).toFixed(2);
          tfoot2.innerHTML = `
            <tr>
              <td colspan="6" style="text-align:right; font-weight:bold;">Total Horas Programadas:</td>
              <td>${Math.round(horas / 100)}</td>
              <td>${Math.round(diseno / 100)}</td>
              <td>${valorPorcentaje}%</td>
            </tr>
          `;
        }
        actualizarCantidadFilasVisibles("tablaReporte2", "totalRegistrosReporte2", 1);
      }

      // =========================
      // Filtro simple por texto para tablas sin categorías
      // =========================
      function filtrarTablaSimplePorTexto(idTbody, textoBusqueda) {
        const tbody = document.getElementById(idTbody);
        if (!tbody) return;

        const texto = (textoBusqueda || "").trim().toLowerCase();
        const tabla = tbody.closest("table");
        const coloresActivos = tabla && tabla.id ? obtenerColoresActivos(tabla.id) : [];
        const tipoFiltrosPorTabla = {
          tbodyPendientesInstructorReporte8: filtrosPendientesInstructorCategorias,
          tbodyReporte3: filtrosReporte3Categorias
        };
        const categoriasTipoActivas = tipoFiltrosPorTabla[idTbody] || null;
        const filas = Array.from(tbody.querySelectorAll("tr"));
        if (!filas.length) return;

        const tieneCabecerasCategoria = filas.some(tr => {
          const celdas = tr.getElementsByTagName("td");
          return celdas.length === 1 && celdas[0].colSpan >= 5;
        });

        // Caso simple: no hay filas de cabecera por categoría
        if (!tieneCabecerasCategoria) {
          let contadorVisible = 1;

          filas.forEach(tr => {
            const celdas = tr.getElementsByTagName("td");
            if (!celdas.length) return;

            let visible = true;

            if (texto) {
              const textoFila = Array.from(celdas)
                .map(td => (td.textContent || "").toLowerCase())
                .join(" ");
              if (!textoFila.includes(texto)) {
                visible = false;
              }
            }

            if (visible && coloresActivos.length > 0) {
              const tdDias =
                tr.querySelector("td.col-dias") ||
                (celdas.length > 4 ? celdas[4] : null);
              const diasColor = (tdDias?.getAttribute("data-color") || "").toLowerCase();
              if (!coloresActivos.includes(diasColor)) {
                visible = false;
              }
            }

            if (visible && categoriasTipoActivas) {
              const tipoAttr = (tr.dataset.tipo || "").toLowerCase();
              if (tipoAttr) {
                const tiposFila = tipoAttr.split(/\s+/).filter(Boolean);
                const tieneActivo = tiposFila.some(tipo => !!categoriasTipoActivas[tipo]);
                if (!tieneActivo) visible = false;
              }
            }

            tr.style.display = visible ? "" : "none";
          if (visible) {
            celdas[0].textContent = contadorVisible++;
          }
        });
        if (idTbody === "pivotAvanceContainer") {
          actualizarTotalesAvanceAprendiz();
        }
        if (idTbody === "tbodyPendientesInstructorReporte8") {
          actualizarTotalAprendicesReporte8();
        }
        return;
      }

        // Caso con categorías: respetar cabeceras (no renumerarlas)
        const visiblePorCategoria = {};
        const filasCabecera = [];
        const filasDatos = [];
        let categoriaContexto = "";

        filas.forEach(tr => {
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;

          // Cabecera de categoría
          if (celdas.length === 1 && celdas[0].colSpan >= 5) {
            const textoCabecera = (celdas[0].textContent || "").trim();
            categoriaContexto = textoCabecera;
            filasCabecera.push({ tr, categoria: textoCabecera });
            return;
          }

          let visible = true;

          if (texto) {
            const textoFila = Array.from(celdas)
              .map(td => (td.textContent || "").toLowerCase())
              .join(" ");
            if (!textoFila.includes(texto)) {
              visible = false;
            }
          }

          if (visible && coloresActivos.length > 0) {
            const tdDias =
              tr.querySelector("td.col-dias") ||
              (celdas.length > 4 ? celdas[4] : null);
            const diasColor = (tdDias?.getAttribute("data-color") || "").toLowerCase();
            if (!coloresActivos.includes(diasColor)) {
              visible = false;
            }
          }

          if (visible && categoriasTipoActivas) {
            const tipoAttr = (tr.dataset.tipo || "").toLowerCase();
            if (tipoAttr) {
              const tiposFila = tipoAttr.split(/\s+/).filter(Boolean);
              const tieneActivo = tiposFila.some(tipo => !!categoriasTipoActivas[tipo]);
              if (!tieneActivo) visible = false;
            }
          }

          if (visible && categoriaContexto) {
            visiblePorCategoria[categoriaContexto] = true;
          }

          filasDatos.push({ tr, visible });
        });

        filasDatos.forEach(item => {
          item.tr.style.display = item.visible ? "" : "none";
        });
        if (idTbody === "pivotAvanceContainer") {
          actualizarTotalesAvanceAprendiz();
        }
        if (idTbody === "tbodyPendientesInstructorReporte8") {
          actualizarTotalAprendicesReporte8();
        }

        filasCabecera.forEach(item => {
          item.tr.style.display = visiblePorCategoria[item.categoria] ? "" : "none";
        });

        // Renumerar solo filas de datos visibles
        let contadorVisible = 1;
        filas.forEach(tr => {
          if (tr.style.display === "none") return;
          const celdas = tr.getElementsByTagName("td");
          if (!celdas.length) return;
          if (celdas.length === 1 && celdas[0].colSpan >= 5) return;
          celdas[0].textContent = contadorVisible++;
        });
      }

      // =========================
      // Filtro por texto para las tablas del reporte
      // "Competencias Pendientes por Aprendiz e Instructor"
      // (tablas dentro de contenedorTablasReporte8)
      // =========================
      function filtrarTablasReporte8PorTexto(textoBusqueda) {
        const contenedor = document.getElementById("contenedorTablasReporte8");
        if (!contenedor) return;

        const texto = (textoBusqueda || "").trim().toLowerCase();
        const tablas = Array.from(contenedor.querySelectorAll("table"));
        if (!tablas.length) return;

        let contadorVisible = 1;
        const categoriasActivas = filtrosReporte8Categorias;

        tablas.forEach(tabla => {
          const filas = Array.from(tabla.querySelectorAll("tbody tr"));
          let hayFilasVisibles = false;
          const coloresActivos = tabla.id ? obtenerColoresActivos(tabla.id) : [];

          filas.forEach(tr => {
            const celdas = tr.getElementsByTagName("td");
            if (!celdas.length) return;

            // Sin texto: mostrar todo y renumerar
            let visible = true;

            if (texto) {
              const textoFila = Array.from(celdas)
                .map(td => (td.textContent || "").toLowerCase())
                .join(" ");
              if (!textoFila.includes(texto)) {
                visible = false;
              }
            }

            if (visible && categoriasActivas) {
              const tipoKey =
                tr.dataset.tipo ||
                normalizarCategoriaGantt((celdas[3]?.textContent || ""));
              if (tipoKey && Object.prototype.hasOwnProperty.call(categoriasActivas, tipoKey)) {
                if (!categoriasActivas[tipoKey]) visible = false;
              }
            }

            if (visible && coloresActivos.length > 0) {
              const tdDias =
                tr.querySelector("td.col-dias") ||
                (celdas.length > 5 ? celdas[5] : null);
            const diasColor = (tdDias?.getAttribute("data-color") || "").toLowerCase();
              if (!coloresActivos.includes(diasColor)) {
                visible = false;
              }
            }

            tr.style.display = visible ? "" : "none";
            if (visible) {
              celdas[0].textContent = contadorVisible++;
              hayFilasVisibles = true;
            }
          });

          // Mostrar u ocultar cada tabla según tenga filas visibles
          tabla.style.display = hayFilasVisibles ? "" : "none";
        });
        actualizarTotalAprendicesReporte8();
        actualizarCantidadFilasVisibles("contenedorTablasReporte8", "totalRegistrosReporte8");
      }


      // =========================
      // Botones de filtro por color (dνas en verde/rojo)
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        const contenedores = document.querySelectorAll(".filtros-colores-dias");
        contenedores.forEach(cont => {
          const tableId = cont.getAttribute("data-table") || "";
          cont.querySelectorAll(".btn-filtro-dias").forEach(btn => {
            btn.addEventListener("click", function () {
              const color = (this.getAttribute("data-color") || "").toLowerCase();
              if (!tableId || !color) return;

              const estado = filtroColorTabla[tableId] || (filtroColorTabla[tableId] = { verde: false, rojo: false });
              const estabaActivo = !!estado[color];
              ["verde", "rojo", "pendiente", "no-aprobado"].forEach(col => {
                estado[col] = false;
              });
              if (!estabaActivo) estado[color] = true;

        cont.querySelectorAll(".btn-filtro-dias").forEach(b => {
          const c = (b.getAttribute("data-color") || "").toLowerCase();
          b.classList.toggle("active", !!estado[c]);
        });

                if (tableId === "tablaProgramadas") {
                  aplicarFiltrosReporte5();
                } else if (tableId === "tablaReporte2") {
                aplicarFiltrosReporte2();
              } else if (tableId === "tablaInstructoresHoras") {
                aplicarFiltrosReporte3();
              } else if (tableId === "tablaReporte6") {
                aplicarFiltrosReporte6();
              } else if (tableId === "tablaPendientesInstructorReporte8") {
                const texto = document.getElementById("busquedaPendientesJuicio")?.value || "";
                filtrarTablaSimplePorTexto("tbodyPendientesInstructorReporte8", texto);
                } else if (tableId === "tablaReporte1") {
                  aplicarFiltrosInstructores();
                } else if (tableId === "tablaReporte4") {
                  aplicarFiltrosReporte4();
                } else if (tableId === "tablaReporte8Visible") {
                const texto = document.getElementById("busquedaPendientesAprendiz")?.value || "";
                filtrarTablasReporte8PorTexto(texto);
              }
      });

    });
        });
      });

      document.addEventListener("DOMContentLoaded", function () {
        const selectReporte2 = document.getElementById("mesSelectReporte2");
        if (selectReporte2) {
          selectReporte2.addEventListener("change", function () {
            filtroMesReporte2 = this.value || "ALL";
            aplicarFiltrosReporte2();
          });
        }
        const selectReporte3 = document.getElementById("mesSelectReporte3");
        if (selectReporte3) {
          selectReporte3.addEventListener("change", function () {
            filtroMesReporte3 = this.value || "ALL";
            aplicarFiltrosReporte3();
          });
        }
      });

      // =========================
      // Ordenamiento de tablas (˄ ˅)
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        inicializarOrdenamientoTablas();
      });

      function inicializarOrdenamientoTablas() {
        // Reporte 5
          setupTablaOrdenable(
            document.getElementById("tablaProgramadas"),
            ["number", "text", "text", "date", "date", "number", "text", "text", "number"]
          );
        // Reporte 3: Listado de Instructores (Total de Horas Programadas)
        const tablaInstructoresHoras = document.getElementById("tablaInstructoresHoras");
        setupTablaOrdenable(
          tablaInstructoresHoras,
          ["number", "text", "text", "text", "date", "date", "number", "number"]
        );

        // Reporte 3: Instructores con aprendices pendientes por emitir juicio
        setupTablaOrdenable(
          document.getElementById("tablaPendientesInstructorReporte8"),
          ["number", "text", "text", "text", "date", "date", "number", "text", "number"]
        );

        // Reporte 7: % Avance por Aprendiz
        const tablaAvance = document.getElementById("pivotAvanceContainer")?.closest("table") || null;
        setupTablaOrdenable(tablaAvance, ["number", "number", "text", "number", "text", "number", "number", "percent"]);

        // Reporte 8: Competencias Pendientes por Aprendiz e Instructor (tabla visible)
        setupTablaOrdenable(
          document.getElementById("tablaReporte8Visible"),
          ["number", "text", "text", "text", "text", "date", "date", "number", "text"]
        );

        // --- NUEVOS REPORTES INTEGRADOS ---

        // Reporte 1: Instructores y Competencias
        // Columnas: #, Nombre, Apellido, Fecha de inicio, Fecha fin, Días, Competencia, Tipo, Horas Programadas
        const tablaReporte1 = document.getElementById("tablaReporte1");
        setupTablaOrdenable(tablaReporte1, ["number", "text", "text", "date", "date", "number", "text", "text", "number"]);

        // Reporte 2: % Competencias con Horas
        // Columnas: #, Competencia, Tipo, Total Horas, Horas Diseño, %
        const tablaReporte2 = document.getElementById("tablaReporte2");
        setupTablaOrdenable(
          tablaReporte2,
          ["number", "text", "text", "date", "date", "number", "number", "number", "percent"]
        );

        // Reporte 4: Competencias del Programa (Programada: Sí/No)
        // Columnas: #, Competencia, Tipo, Programada
          const tablaReporte4 = document.getElementById("tablaReporte4");
          setupTablaOrdenable(tablaReporte4, ["number", "text", "text", "date", "date", "number", "text"]);

        // Reporte 6: Raps Aprobados - Por evaluar y No aprobados
        // Columnas: #, Competencia, Tipo, RAP, Funcionario, APROBADO, POR EVALUAR, NO APROBADO
        setupTablaOrdenable(
          document.getElementById("tablaReporte6"),
          ["number", "text", "text", "date", "date", "number", "text", "text", "number", "number", "number"]
        );
      }

      function setupTablaOrdenable(tabla, tiposColumna) {
        if (!tabla || !tabla.tHead || !tabla.tHead.rows || !tabla.tHead.rows.length) return;
        const headerRow = tabla.tHead.rows[0];
        const ths = Array.from(headerRow.cells).filter(el => el && el.tagName === "TH");
        if (!ths.length) return;

        ths.forEach((th, idx) => {
          if (!th) return;
          th.classList.add("th-sortable");

          // Guardar tipo de dato por columna
          th.dataset.sortType = (tiposColumna && tiposColumna[idx]) ? tiposColumna[idx] : "text";

          // Inyectar íconos si no existen
          if (!th.querySelector(".sort-icons")) {
            const texto = (th.textContent || "").trim();
            th.textContent = "";

            const inner = document.createElement("span");
            inner.className = "th-inner";

            const label = document.createElement("span");
            label.className = "th-label";
            label.textContent = texto;

            const icons = document.createElement("span");
            icons.className = "sort-icons";
            icons.innerHTML = '<span class="sort-icon up">&#708;</span><span class="sort-icon down">&#709;</span>';

            inner.appendChild(label);
            inner.appendChild(icons);
            th.appendChild(inner);
          }

          // Evitar duplicar listeners
          if (th.dataset.sortWired === "1") return;
          th.dataset.sortWired = "1";
          th.tabIndex = 0;

          th.addEventListener("click", function () {
            ordenarTablaPorHeader(this);
          });

          th.addEventListener("keydown", function (e) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              ordenarTablaPorHeader(this);
            }
          });
        });
      }

      function ordenarTablaPorHeader(th) {
        const tabla = th?.closest?.("table");
        if (!tabla) return;
        const colIndex = typeof th.cellIndex === "number" ? th.cellIndex : 0;
        const tipo = (th.dataset.sortType || "text").toLowerCase();

        // Alternar dirección
        const dirActual = (th.dataset.sortDir || "").toLowerCase();
        const nuevaDir = dirActual === "asc" ? "desc" : "asc";

        // Resetear el estado visual de otros headers
        tabla.querySelectorAll("th.th-sortable").forEach(other => {
          if (other !== th) {
            delete other.dataset.sortDir;
          }
        });

        th.dataset.sortDir = nuevaDir;

        ordenarFilasTabla(tabla, colIndex, tipo, nuevaDir);
      }

      function esFilaCabeceraCategoria(tr) {
        const celdas = tr ? tr.querySelectorAll("td") : [];
        return celdas.length === 1 && celdas[0].colSpan >= 5;
      }

      function ordenarFilasTabla(tabla, colIndex, tipo, dir) {
        const tbody = tabla?.tBodies?.[0];
        if (!tbody) return;

        const filas = Array.from(tbody.rows);
        if (!filas.length) return;

        const tieneCabecerasCategoria = filas.some(esFilaCabeceraCategoria);

        const comparar = (a, b) => {
          const valA = obtenerValorCeldaOrden(a, colIndex, tipo);
          const valB = obtenerValorCeldaOrden(b, colIndex, tipo);
          return compararValoresOrden(valA, valB, tipo, dir);
        };

        if (!tieneCabecerasCategoria) {
          filas.sort(comparar).forEach(tr => tbody.appendChild(tr));
          renumerarFilasTabla(tbody);
          return;
        }

        // Ordenar dentro de cada categoría (sin mezclar cabeceras)
        const grupos = [];
        let grupoActual = { header: null, filas: [] };

        filas.forEach(tr => {
          if (esFilaCabeceraCategoria(tr)) {
            if (grupoActual.header || grupoActual.filas.length) {
              grupos.push(grupoActual);
            }
            grupoActual = { header: tr, filas: [] };
            return;
          }
          grupoActual.filas.push(tr);
        });
        if (grupoActual.header || grupoActual.filas.length) grupos.push(grupoActual);

        const frag = document.createDocumentFragment();
        grupos.forEach(g => {
          if (g.header) frag.appendChild(g.header);
          g.filas.sort(comparar).forEach(tr => frag.appendChild(tr));
        });
        tbody.appendChild(frag);

          renumerarFilasTabla(tbody);
        }

        function aplicarFiltrosReporte4() {
          aplicarFiltrosCompetenciasConTipo("tbodyReporte4", filtrosReporte4, {
            colCompetencia: 1,
            colTipo: 2,
            agrupado: false
          });

          const tbody = document.getElementById("tbodyReporte4");
          if (!tbody) return;

          const coloresActivos = obtenerColoresActivos("tablaReporte4");
          if (coloresActivos.length > 0) {
            Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
              if (tr.style.display === "none") return;
              const diasTd = tr.querySelector("td.col-dias");
              const color = (diasTd?.getAttribute("data-color") || "").toLowerCase();
              if (!coloresActivos.includes(color)) {
                tr.style.display = "none";
              }
            });
          }

          renumerarFilasTabla(tbody);
          actualizarCantidadFilasVisibles("tablaReporte4", "totalRegistrosReporte4");
        }

      function renumerarFilasTabla(tbody) {
        if (!tbody) return;
        let contador = 1;
        Array.from(tbody.rows).forEach(tr => {
          if (tr.style.display === "none") return;
          if (esFilaCabeceraCategoria(tr)) return;
          const c0 = tr.cells && tr.cells.length ? tr.cells[0] : null;
          if (c0) c0.textContent = contador++;
        });
      }

      function normalizarTextoOrden(texto) {
        return (texto || "")
          .toString()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toUpperCase();
      }

      function parseNumeroOrden(texto) {
        const raw = (texto || "").toString().trim();
        if (!raw) return null;
        const sinEspacios = raw.replace(/\s+/g, "");
        const limpio = sinEspacios.replace(/[^0-9.,-]/g, "");
        if (!limpio) return null;

        const lastComma = limpio.lastIndexOf(",");
        const lastDot = limpio.lastIndexOf(".");
        let normal = limpio;

        if (lastComma > lastDot) {
          normal = limpio.replace(/\./g, "").replace(",", ".");
        } else if (lastDot > lastComma) {
          normal = limpio.replace(/,/g, "");
        } else {
          normal = limpio.replace(/,/g, ".");
        }

        const num = parseFloat(normal);
        return Number.isFinite(num) ? num : null;
      }

      function parseFechaOrden(texto) {
        const raw = (texto || "").toString().trim();
        if (!raw) return null;

        const s = raw
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .replace(/\s+/g, " ");

        // yyyy-mm-dd / yyyy/mm/dd
        let m = s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/);
        if (m) {
          const d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
          return isNaN(d) ? null : d;
        }

        // dd/mm/yyyy / dd-mm-yyyy
        m = s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
        if (m) {
          const dia = Number(m[1]);
          const mes = Number(m[2]) - 1;
          const anio = m[3].length === 2 ? Number("20" + m[3]) : Number(m[3]);
          const d = new Date(anio, mes, dia);
          return isNaN(d) ? null : d;
        }

        // dd mes yyyy (mes abreviado en español)
        m = s.match(/^(\d{1,2})\s+([a-z]{3,})\.?\s+(\d{2,4})$/);
        if (m) {
          const dia = Number(m[1]);
          const mesTxt = (m[2] || "").slice(0, 4);
          const anio = m[3].length === 2 ? Number("20" + m[3]) : Number(m[3]);
          const mapMes = {
            ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5,
            jul: 6, ago: 7, sep: 8, sept: 8, oct: 9, nov: 10, dic: 11
          };
          const mes = mapMes[mesTxt] ?? mapMes[mesTxt.slice(0, 3)];
          if (mes !== undefined) {
            const d = new Date(anio, mes, dia);
            return isNaN(d) ? null : d;
          }
        }

        const fallback = new Date(raw);
        return isNaN(fallback) ? null : fallback;
      }

      function obtenerValorCeldaOrden(tr, colIndex, tipo) {
        const celda = tr?.cells?.[colIndex];
        if (!celda) return null;

        const texto = (celda.textContent || "").trim();
        if (tipo === "date") {
          const sortValue = celda.getAttribute("data-sort-value");
          if (sortValue) {
            const timestamp = Number(sortValue);
            if (!Number.isNaN(timestamp)) {
              return timestamp;
            }
          }
          const fecha = parseFechaOrden(texto);
          return fecha ? fecha.getTime() : null;
        }
        if (tipo === "number" || tipo === "percent") return parseNumeroOrden(texto);
        return normalizarTextoOrden(texto);
      }

      function compararValoresOrden(a, b, tipo, dir) {
        const asc = dir === "asc";

        if (a == null && b == null) return 0;
        if (a == null) return 1;
        if (b == null) return -1;

        if (tipo !== "number" && tipo !== "percent" && tipo !== "date") {
          const cmp = String(a).localeCompare(String(b), "es", { numeric: true, sensitivity: "base" });
          return asc ? cmp : -cmp;
        }

        const diff = Number(a) - Number(b);
        if (diff === 0) return 0;
        return asc ? diff : -diff;
      }

      // =========================
      // Acordeón "Cargue de Archivos"
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        const toggle = document.getElementById("accordionCargueToggle");
        const body = document.getElementById("accordionCargueBody");
        const icon = document.getElementById("accordionCargueIcon");

        if (toggle && body) {
          toggle.addEventListener("click", function () {
            const visible = body.style.display !== "none";

            if (visible) {
              body.style.display = "none";
              if (icon) icon.textContent = "▸";
            } else {
              body.style.display = "block";
              if (icon) icon.textContent = "▾";
            }
          });
        }
      });

      // =========================
      // Acordeón "Información General de la Ficha"
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        const toggle = document.getElementById("accordionInfoToggle");
        const body = document.getElementById("accordionInfoBody");
        const icon = document.getElementById("accordionInfoIcon");

        if (!toggle || !body) return;

        // El acordeón inicia ABIERTO porque no forzamos display:none en el body
        toggle.addEventListener("click", function () {
          const visible = body.style.display !== "none"; // "" o "block" = visible

          if (visible) {
            body.style.display = "none";
            if (icon) icon.textContent = "▸";
          } else {
            body.style.display = "block";
            if (icon) icon.textContent = "▾";
          }
        });
      });
      // -------------------------------------------------------------
      // Obtiene la lista de aprendices EN FORMACION desde la tabla
      // de estados (#tbodyEstado)
      // -------------------------------------------------------------
      function obtenerAprendicesEnFormacionDesdeTabla() {
        const lista = [];
        const tbodyEstado = document.getElementById("tbodyEstado");
        if (!tbodyEstado) return lista;

        const filas = tbodyEstado.querySelectorAll("tr");
        filas.forEach(tr => {
          const celdas = tr.querySelectorAll("td");
          if (celdas.length < 2) return;

          // Primera celda: estado
          const estadoTexto = (celdas[0].innerText || celdas[0].textContent || "")
            .toUpperCase()
            .trim();

          // Normalizar variantes EN FORMACION / EN FORMACIÓN
          if (estadoTexto === "EN FORMACION" || estadoTexto === "EN FORMACIÓN") {
            // Segunda celda: nombres (separados por saltos de línea o comas)
            const nombresRaw = celdas[1].innerText || celdas[1].textContent || "";
            nombresRaw
              .split(/\n|,/)           // separa por salto de línea o coma
              .map(n => n.trim())
              .filter(n => n.length > 0)
              .forEach(nombre => {
                lista.push(nombre);
              });
          }
        });

        // Devolver nombres únicos ordenados A-Z
        const unicos = Array.from(new Set(lista));
        unicos.sort((a, b) => a.localeCompare(b, "es"));
        return unicos;
      }

      // Actualiza el encabezado "Aprendiz Vocero" en Información General
      function actualizarAprendizVoceroHeader(nombre) {
        const spanVocero = document.getElementById("aprendizVoceroHeader");
        if (spanVocero) {
          spanVocero.textContent = nombre && nombre.trim() ? nombre : "-";
        }
      }

      // Muestra el modal para seleccionar Aprendiz Vocero
      function mostrarModalVocero() {
        const overlayVocero = document.getElementById("voceroOverlay");
        const selectVocero = document.getElementById("selectAprendizVocero");
        const msgErrorVocero = document.getElementById("voceroMensajeError");

        if (!overlayVocero || !selectVocero) return;

        // Limpiar estado previo
        if (msgErrorVocero) msgErrorVocero.style.display = "none";
        selectVocero.innerHTML = '<option value="">Seleccione un aprendiz…</option>';

        // Cargar lista de aprendices EN FORMACION desde la tabla de estados
        const lista = obtenerAprendicesEnFormacionDesdeTabla();
        lista.forEach(nombre => {
          const opt = document.createElement("option");
          opt.value = nombre;
          opt.textContent = nombre;
          selectVocero.appendChild(opt);
        });

        overlayVocero.style.display = "flex";
      }

      // =========================
      // Acordeón "Reportes"
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        const toggle = document.getElementById("accordionReportesToggle");
        const body = document.getElementById("accordionReportesBody");
        const icon = document.getElementById("accordionReportesIcon");

        if (!toggle || !body) return;

        // El acordeón inicia ABIERTO porque no forzamos display:none en el body
        toggle.addEventListener("click", function () {
          const visible = body.style.display !== "none"; // "" o "block" = visible

          if (visible) {
            body.style.display = "none";
            if (icon) icon.textContent = "▸";
          } else {
            body.style.display = "block";
            if (icon) icon.textContent = "▾";
          }
        });
      });
      // =========================
      // Acordeón "Centro de Reportes"
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        const toggle = document.getElementById("accordionCentroToggle");
        const body = document.getElementById("accordionCentroBody");
        const icon = document.getElementById("accordionCentroIcon");

        if (!toggle || !body) return;

        // El acordeón inicia ABIERTO porque no forzamos display:none en el body
        toggle.addEventListener("click", function () {
          const visible = body.style.display !== "none"; // "" o "block" = visible

          if (visible) {
            body.style.display = "none";
            if (icon) icon.textContent = "▸";
          } else {
            body.style.display = "block";
            if (icon) icon.textContent = "▾";
          }
        });
      });

      // =========================
      // Pantalla inicial / Login Coordinador Acad?mico
      // =========================
      document.addEventListener("DOMContentLoaded", function () {
        // -------- Login Coordinador --------
        const loginOverlay = document.getElementById("loginOverlay");
        const selectCoord = document.getElementById("coordinadorSelect");
        const btnIngresar = document.getElementById("btnIngresar");
        const msgError = document.getElementById("loginMensajeError");
        const loginCard = loginOverlay ? loginOverlay.querySelector(".login-card") : null;
        const chkRoles = document.getElementById("chkValidarRoles");

        if (chkRoles) {
          validarRolesActivos = chkRoles.checked;
          chkRoles.addEventListener("change", function () {
            validarRolesActivos = this.checked;
            if (!validarRolesActivos && msgError) {
              msgError.style.display = "none";
            }
          });
        }

        if (btnIngresar && selectCoord && loginOverlay) {
          btnIngresar.addEventListener("click", function () {
            const debeValidar = validarRolesActivos !== false;
            const valor = (selectCoord.value || "").trim();
            if (debeValidar && !valor) {
              if (msgError) msgError.style.display = "block";
              return;
            }

            coordinadorAcademicoSeleccionado = debeValidar ? valor : "";

            if (msgError) msgError.style.display = "none";

            // Actualizar el encabezado con el Coordinador seleccionado
            const coordHeader = document.getElementById("coordinadorAcademicoHeader");
            if (coordHeader) {
              coordHeader.textContent = debeValidar
                ? (coordinadorAcademicoSeleccionado || "-")
                : "-";
            }

            // Animación de salida del login
            if (loginCard) {
              loginCard.classList.add("login-exit");

              const onAnimationEnd = function () {
                loginCard.removeEventListener("animationend", onAnimationEnd);
                loginOverlay.style.display = "none";
              };

              loginCard.addEventListener("animationend", onAnimationEnd);
            } else {
              // Fallback por si no se encuentra la tarjeta
              loginOverlay.style.display = "none";
            }
          });
        }

        // -------- Modal Gerente de Proyecto --------
        const gerenteOverlay = document.getElementById("gerenteOverlay");
        const btnGerenteSi = document.getElementById("btnGerenteSi");
        const btnGerenteNo = document.getElementById("btnGerenteNo");
        const btnAceptarGerente = document.getElementById("btnAceptarGerente");
        const contSelectorGerente = document.getElementById("contenedorSelectorGerente");
        const selectGerente = document.getElementById("selectGerenteProyecto");
        const msgGerenteError = document.getElementById("gerenteMensajeError");

        // Botón SÍ: el instructor con más horas ES el Gerente de Proyecto
        if (btnGerenteSi) {
          btnGerenteSi.addEventListener("click", function () {
            const nombreTop = instructorMasHorasGlobal || "";
            actualizarGerenteEnHeader(nombreTop);

            if (gerenteOverlay) gerenteOverlay.style.display = "none";

            // Después de confirmar el Gerente, abrir selección de Aprendiz Vocero
            mostrarModalVocero();
          });
        }


        // Botón NO: mostrar lista desplegable con todos los instructores
        if (btnGerenteNo) {
          btnGerenteNo.addEventListener("click", function () {
            if (contSelectorGerente) {
              contSelectorGerente.style.display = "block";
            }
          });
        }

        // Botón Aceptar en la lista de instructores
        if (btnAceptarGerente) {
          btnAceptarGerente.addEventListener("click", function () {
            const nombreSeleccionado = (selectGerente && selectGerente.value || "").trim();

            if (!nombreSeleccionado) {
              if (msgGerenteError) msgGerenteError.style.display = "block";
              return;
            }

            if (msgGerenteError) msgGerenteError.style.display = "none";

            actualizarGerenteEnHeader(nombreSeleccionado);

            if (gerenteOverlay) {
              gerenteOverlay.style.display = "none";
            }

            // Después de seleccionar manualmente el Gerente, abrir selección de Aprendiz Vocero
            mostrarModalVocero();
          });
        }

        // -------- Modal Aprendiz Vocero --------
        const btnAceptarVocero = document.getElementById("btnAceptarVocero");

        if (btnAceptarVocero) {
          btnAceptarVocero.addEventListener("click", function () {
            const selectVocero = document.getElementById("selectAprendizVocero");
            const msgErrorVocero = document.getElementById("voceroMensajeError");
            const overlayVocero = document.getElementById("voceroOverlay");

            if (!selectVocero || !overlayVocero) return;

            const nombre = (selectVocero.value || "").trim();
            if (!nombre) {
              if (msgErrorVocero) msgErrorVocero.style.display = "block";
              return;
            }

            if (msgErrorVocero) msgErrorVocero.style.display = "none";

            // Guardar en variable global y mostrar en el header
            aprendizVoceroSeleccionado = nombre;
            actualizarAprendizVoceroHeader(nombre);

            overlayVocero.style.display = "none";
          });
        }

      });

      const inicializarTogglesReportes = () => {
  const toggles = document.querySelectorAll(".report-card-toggle");
  const allInputs = document.querySelectorAll(".reporte-checkbox");

  // Estado inicial: TODO desmarcado (según tu requerimiento)
  allInputs.forEach(chk => {
    chk.checked = false;
  });
  toggles.forEach(tg => {
    tg.checked = false;
    tg.indeterminate = false;
  });

  // Comportamiento "TODOS" por grupo
  toggles.forEach(toggle => {
    const group = toggle.dataset.group;
    if (!group) return;

    const inputs = Array.from(
      document.querySelectorAll(`.reporte-checkbox[data-report-group="${group}"]`)
    );
    if (!inputs.length) return;

    const actualizar = () => {
      const checkedCount = inputs.filter(i => i.checked).length;

      // Opcional: estado intermedio cuando algunos están activos
      toggle.indeterminate = checkedCount > 0 && checkedCount < inputs.length;
      toggle.checked = checkedCount === inputs.length;
    };

    // Si el usuario activa/desactiva un checkbox interno, actualiza el "TODOS"
    inputs.forEach(input => input.addEventListener("change", actualizar));

    // Si el usuario activa/desactiva "TODOS", aplica al grupo completo
    toggle.addEventListener("change", () => {
      // IMPORTANTE: capturar el estado antes de disparar cambios,
      // para que "actualizar()" no cambie toggle.checked a mitad del ciclo.
      const estado = toggle.checked;

      // Primero setea todos sin disparar eventos
      inputs.forEach(input => {
        input.checked = estado;
      });

      // Luego dispara "change" (si hay otros listeners que dependan de eso)
      inputs.forEach(input => {
        input.dispatchEvent(new Event("change", { bubbles: true }));
      });

      toggle.indeterminate = false;
      toggle.checked = estado;
    });

    actualizar();
  });
};

document.addEventListener("DOMContentLoaded", inicializarTogglesReportes);
    </script>
</body>
</html>
